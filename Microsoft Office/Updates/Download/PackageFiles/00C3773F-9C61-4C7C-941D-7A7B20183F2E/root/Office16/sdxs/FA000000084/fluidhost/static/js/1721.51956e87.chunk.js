"use strict";(self.webpackChunkfluidhost=self.webpackChunkfluidhost||[]).push([[1721],{41721:function(e,t,n){n.d(t,{L:function(){return x},jC:function(){return y},lb:function(){return q}});var r=n(74165),s=n(15861),i=n(15671),a=n(43144),o=n(69163),u=n(27186),h=n(9070),c=n(82486),l=n(1244),d=n(20851),f=n(76692),v=1e4,p=100,k=function(){function e(t,n,r,s,a,u){(0,i.Z)(this,e),this.to=n,this.payloadSize=r,this.logger=s,this.requestCallback=a,this.responseCallback=u,this.results=new Map,this.workingState="working",this.requestsInFlight=0,this.endEvent=new o.B,this.requests=0,this.latestRequested=t,this.nextToDeliver=t,this.knewTo=void 0!==n}return(0,a.Z)(e,[{key:"working",get:function(){return"working"===this.workingState}},{key:"canceled",get:function(){return"canceled"===this.workingState}},{key:"cancel",value:function(){this.working&&(this.workingState="canceled",this.endEvent.resolve())}},{key:"run",value:function(){var e=(0,s.Z)((0,r.Z)().mark((function e(t){var n;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for((0,u.h)(t>0,258),(0,u.h)(this.working,259),n=t;n>0;)n--,this.addRequest();return this.dispatch(),e.abrupt("return",this.endEvent.promise);case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"done",value:function(){(0,u.h)(void 0!==this.to,260),(0,u.h)(this.nextToDeliver>=this.to,261),this.working&&(this.workingState="done",this.endEvent.resolve())}},{key:"fail",value:function(e){this.working&&(this.workingState="done",this.endEvent.reject(e))}},{key:"dispatch",value:function(){for(;this.working;){var e=this.results.get(this.nextToDeliver);if(void 0===e)break;this.results.delete(this.nextToDeliver),(0,u.h)(e.length<=this.payloadSize,473),this.nextToDeliver+=e.length,this.responseCallback(e)}this.working&&(0===this.requestsInFlight?((0,u.h)(0===this.results.size,263),this.done()):void 0!==this.to&&this.nextToDeliver>=this.to&&((0,u.h)(!this.knewTo,264),this.done()))}},{key:"getNextChunk",value:function(){if(this.working){var e=this.latestRequested;if(!(void 0!==this.to&&this.to<=e))return this.latestRequested+=this.payloadSize,void 0!==this.to&&(this.latestRequested=Math.min(this.to,this.latestRequested)),(0,u.h)(e<this.latestRequested,265),{from:e,to:this.latestRequested}}}},{key:"addRequest",value:function(){var e=this.getNextChunk();void 0!==e&&this.addRequestCore(e.from,e.to).catch(this.fail.bind(this))}},{key:"addRequestCore",value:function(){var e=(0,s.Z)((0,r.Z)().mark((function e(t,n){var s,i,a,o,h,c,l,d,f,v,p,k,g;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:(0,u.h)(this.working,266),s=t,i=n,this.requestsInFlight++;case 4:if(!this.working){e.next=41;break}return a=i-s,(0,u.h)(a>0,267),void 0!==this.to&&((0,u.h)(s<this.to,268),(0,u.h)(i<=this.to,269)),this.requests++,o=this.requestCallback(this.requests,s,i,void 0!==this.to,{}),this.dispatch(),e.next=13,o;case 13:if(h=e.sent,c=h.payload,l=h.cancel,d=h.partial,l&&this.cancel(),!(void 0!==this.to&&s>=this.to)){e.next=22;break}return(0,u.h)(!this.knewTo,270),0!==c.length&&this.logger.sendErrorEvent({eventName:"ParallelRequests_GotExtra",from:s,to:i,end:this.to,length:c.length}),e.abrupt("break",41);case 22:if(!this.working){e.next=39;break}if(f=s,v=c.length,p=a<=v,0!==v?(a<v&&this.logger.sendTelemetryEvent({eventName:"ParallelRequests_Over",from:s,to:i,length:v}),k=c.splice(0,a),this.results.set(s,k),s+=k.length):((0,u.h)(!d,271),(0,u.h)(!this.knewTo,272)),d||p){e.next=32;break}if(this.knewTo){e.next=31;break}return(void 0===this.to||this.to>s)&&(this.to=s),e.abrupt("break",41);case 31:this.logger.sendPerformanceEvent({eventName:"ParallelRequests_Partial",from:f,to:i,length:v});case 32:if(i===this.latestRequested&&(0!==c.length&&(this.results.set(s,c),s+=c.length),this.latestRequested=s,p=!0),!p){e.next=39;break}if(void 0!==(g=this.getNextChunk())){e.next=37;break}return e.abrupt("break",41);case 37:s=g.from,i=g.to;case 39:e.next=4;break;case 41:this.requestsInFlight--,this.dispatch();case 43:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()}]),e}(),g=function(){function e(){(0,i.Z)(this,e),this.queue=[],this.done=!1}return(0,a.Z)(e,[{key:"pushValue",value:function(e){this.pushCore(Promise.resolve({done:!1,value:e}))}},{key:"pushError",value:function(e){this.pushCore(Promise.reject(e)),this.done=!0}},{key:"pushDone",value:function(){this.pushCore(Promise.resolve({done:!0})),this.done=!0}},{key:"pushCore",value:function(e){(0,u.h)(!this.done,274),this.deferred?((0,u.h)(0===this.queue.length,275),this.deferred.resolve(e),this.deferred=void 0):this.queue.push(e)}},{key:"read",value:function(){var e=(0,s.Z)((0,r.Z)().mark((function e(){var t;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((0,u.h)(void 0===this.deferred,276),void 0===(t=this.queue.shift())){e.next=4;break}return e.abrupt("return",t);case 4:return(0,u.h)(!this.done,277),this.deferred=new o.B,e.abrupt("return",this.deferred.promise);case 7:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]),e}(),b=function(){var e=(0,s.Z)((0,r.Z)().mark((function e(){var t;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!1!==(null===(t=globalThis.navigator)||void 0===t?void 0:t.onLine)||void 0===globalThis.addEventListener){e.next=2;break}return e.abrupt("return",new Promise((function(e){globalThis.addEventListener("online",(function t(){e(),globalThis.removeEventListener("online",t)}))})));case 2:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();function w(e,t,n,r,s,i){return m.apply(this,arguments)}function m(){return(m=(0,s.Z)((0,r.Z)().mark((function e(t,n,s,i,a,o){var u,k,g,w,m,x,y,q;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:k=0,w=0,m={partial:!1,cancel:!0,payload:[]},x=0,y=(0,r.Z)().mark((function e(){var a,m,y,q,Z,T,R;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return w++,a=Math.min(v,p*Math.pow(2,w)),m=h.S.now(),e.prev=3,e.next=6,t(Object.assign(Object.assign({},n),{retry:w}));case 6:if(y=e.sent,q=y.messages,Z=y.partialResult,0===q.length&&s){e.next=12;break}return null===g||void 0===g||g.end(Object.assign(Object.assign({duration:k},n),{reason:o})),e.abrupt("return",{v:{payload:q,cancel:!1,partial:Z}});case 12:if(void 0!==u){e.next=16;break}u=h.S.now(),e.next=18;break;case 16:if(!(h.S.now()-u>3e4)){e.next=18;break}throw(0,l.jx)("Failed to retrieve ops from storage (Too Many Retries)",{canRetry:!1},Object.assign({retry:w,driverVersion:f.Z},n));case 18:e.next=28;break;case 20:if(e.prev=20,e.t0=e.catch(3),T=(0,l.ms)(e.t0),R=(0,l.ZZ)(e.t0),(0,d.f)(i,Object.assign(Object.assign({eventName:"GetDeltas_Error"},n),{retry:w,duration:h.S.now()-m,retryAfter:R,reason:o}),e.t0),T){e.next=27;break}throw e.t0;case 27:void 0!==R&&(a=R);case 28:return void 0===g&&(x=h.S.now(),g=c.Xr.start(i,{eventName:"GetDeltasWaitTime"})),e.next=31,new Promise((function(e){setTimeout(e,a)}));case 31:return e.next=33,b();case 33:k+=h.S.now()-x;case 34:case"end":return e.stop()}}),e,null,[[3,20]])}));case 5:if(!0===(null===a||void 0===a?void 0:a.aborted)){e.next=12;break}return e.delegateYield(y(),"t0",7);case 7:if("object"!==typeof(q=e.t0)){e.next=10;break}return e.abrupt("return",q.v);case 10:e.next=5;break;case 12:return e.abrupt("return",m);case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function x(e,t,n,i,a,o,h,l){var d,f=0,v=0,p=new g,b={fromTotal:n,toTotal:i},m=c.Xr.start(o,Object.assign(Object.assign({eventName:"GetDeltas"},b),{reason:l})),x=new k(n,i,a,o,function(){var t=(0,s.Z)((0,r.Z)().mark((function t(n,i,a,u,c){return(0,r.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return f++,t.abrupt("return",w(function(){var t=(0,s.Z)((0,r.Z)().mark((function t(n){return(0,r.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",e(i,a,n));case 1:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),Object.assign(Object.assign({request:n,from:i,to:a},b),c),u,o,h,l));case 2:case"end":return t.stop()}}),t)})));return function(e,n,r,s,i){return t.apply(this,arguments)}}(),(function(e){void 0===d?(0,u.h)(e[0].sequenceNumber===n,621):(0,u.h)(e[0].sequenceNumber===d+1,622),d=e[e.length-1].sequenceNumber,(0,u.h)(d-e[0].sequenceNumber+1===e.length,623),v+=e.length,p.pushValue(e)})),y=function(e){x.cancel()};return void 0!==h&&h.addEventListener("abort",y),x.run(t).finally((function(){void 0!==h&&h.removeEventListener("abort",y)})).then((function(){var e={lastFetch:d,length:v,requests:f};x.canceled?m.cancel(Object.assign(Object.assign({},e),{error:"ops request cancelled by client"})):((0,u.h)(void 0===i||void 0!==d&&d>=i-1,624),m.end(e)),p.pushDone()})).catch((function(e){m.cancel({lastFetch:d,length:v,requests:f},e),p.pushError(e)})),p}var y={read:function(){var e=(0,s.Z)((0,r.Z)().mark((function e(){return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",{done:!0});case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()};function q(e,t){return{read:function(){var n=(0,s.Z)((0,r.Z)().mark((function n(){var s;return(0,r.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,e.read();case 2:return s=n.sent,t(s),n.abrupt("return",s);case 5:case"end":return n.stop()}}),n)})));return function(){return n.apply(this,arguments)}}()}}}}]);
//# sourceMappingURL=1721.51956e87.chunk.js.map