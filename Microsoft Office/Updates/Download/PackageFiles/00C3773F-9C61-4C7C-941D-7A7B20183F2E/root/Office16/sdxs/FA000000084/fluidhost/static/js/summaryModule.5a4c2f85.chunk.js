/*! For license information please see summaryModule.5a4c2f85.chunk.js.LICENSE.txt */
"use strict";(self.webpackChunkfluidhost=self.webpackChunkfluidhost||[]).push([[7107],{21654:function(e,t,n){n.r(t),n.d(t,{OdspSummaryUploadManager:function(){return b}});var r=n(74165),a=n(15861),s=n(15671),o=n(43144),c=n(24071),i=n(89591),u=n(27186),h=n(24908),p=n(24713),l=n(15318),d=n(82486),m=n(65675),f=n(66584),y=n(89175),b=function(){function e(t,n,r,a,o,c){(0,s.Z)(this,e),this.snapshotUrl=t,this.getStorageToken=n,this.epochTracker=a,this.forceAccessTokenViaAuthorizationHeader=o,this.relayServiceTenantAndSessionId=c,this.mc=(0,l.rZ)(r)}return(0,o.Z)(e,[{key:"writeSummaryTree",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t,n){var a,s;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0!==this.lastSummaryProposalHandle&&this.lastSummaryProposalHandle!==n.proposalHandle&&this.mc.logger.sendTelemetryEvent({eventName:"LastSummaryProposedHandleMismatch",ackedSummaryProposedHandle:n.proposalHandle,lastSummaryProposalHandle:this.lastSummaryProposalHandle}),e.next=3,this.writeSummaryTreeCore(n.ackHandle,n.referenceSequenceNumber,t);case 3:if(a=e.sent,s=a?a.id:void 0,a&&s){e.next=7;break}throw new Error("Failed to write summary tree");case 7:return this.lastSummaryProposalHandle=s,e.abrupt("return",s);case 9:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"writeSummaryTreeCore",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t,n,s){var o,c,i,u,h,p=this;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=(0,m.F2)(s),e.next=3,this.convertSummaryToSnapshotTree(t,s,".app");case 3:return c=e.sent,i=c.snapshotTree,u=c.blobs,h={entries:i.entries,message:"app",sequenceNumber:n,type:o||void 0===t?"container":"channel"},e.abrupt("return",(0,y.PM)(function(){var e=(0,a.Z)((0,r.Z)().mark((function e(s){var o,c,i,l,m,y;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p.getStorageToken(s,"WriteSummaryTree");case 2:return o=e.sent,c=(0,f.y)("".concat(p.snapshotUrl,"/snapshot"),o,p.forceAccessTokenViaAuthorizationHeader),i=c.url,(l=c.headers)["Content-Type"]="application/json",void 0!==(m=p.relayServiceTenantAndSessionId())&&(l["If-Match"]="fluid:sessionid=".concat(m).concat(t?";containerid=".concat(t):"")),y=JSON.stringify(h),e.abrupt("return",d.Xr.timedExecAsync(p.mc.logger,{eventName:"uploadSummary",attempt:s.refresh?2:1,hasClaims:!!s.claims,hasTenantId:!!s.tenantId,headers:0!==Object.keys(l).length||void 0,blobs:u,size:y.length,referenceSequenceNumber:n,type:h.type},(0,a.Z)((0,r.Z)().mark((function e(){var t;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p.epochTracker.fetchAndParseAsJSON(i,{body:y,headers:l,method:"POST"},"uploadSummary");case 2:return t=e.sent,e.abrupt("return",t.content);case 4:case"end":return e.stop()}}),e)})))));case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 8:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"convertSummaryToSnapshotTree",value:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(t,n,a,s){var o,l,d,m,f,y,b,v,k,S,T,g,w,Z,x,A;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:void 0===s&&(s=null===(o=this.mc.config.getBoolean("Fluid.Driver.Odsp.MarkUnreferencedNodes"))||void 0===o||o),l={type:"tree",entries:[]},d=0,m=Object.keys(n.tree),f=0,y=m;case 5:if(!(f<y.length)){e.next=50;break}b=y[f],v=n.tree[b],k=void 0,S=void 0,T=void 0,e.t0=v.type,e.next=e.t0===p.J.Tree?14:e.t0===p.J.Blob?21:e.t0===p.J.Handle?24:e.t0===p.J.Attachment?31:33;break;case 14:return e.next=16,this.convertSummaryToSnapshotTree(t,v,a);case 16:return g=e.sent,S=g.snapshotTree,T=s?v.unreferenced:void 0,d+=g.blobs,e.abrupt("break",34);case 21:return S="string"===typeof v.content?{type:"blob",content:v.content,encoding:"utf-8"}:{type:"blob",content:(0,c.IN)(v.content,"base64"),encoding:"base64"},d++,e.abrupt("break",34);case 24:if(t){e.next=26;break}throw Error("Parent summary does not exist to reference by handle.");case 26:return(w=v.handle).length>0&&!w.startsWith("/")&&(w="/".concat(w)),Z="".concat(a).concat(w),k="".concat(t,"/").concat(Z),e.abrupt("break",34);case 31:return k=v.id,e.abrupt("break",34);case 33:(0,i.U)(v,"Unknown type: ".concat(v.type));case 34:if(x={path:encodeURIComponent(b),type:(0,h.FE)(v)},A=void 0,!S){e.next=41;break}(0,u.h)(void 0===k,173),A=Object.assign(Object.assign({value:S},x),{unreferenced:T}),e.next=46;break;case 41:if(!k){e.next=45;break}A=Object.assign(Object.assign({},x),{id:k}),e.next=46;break;case 45:throw new Error("Invalid tree entry for ".concat(v.type));case 46:l.entries.push(A);case 47:f++,e.next=5;break;case 50:return e.abrupt("return",{snapshotTree:l,blobs:d});case 51:case"end":return e.stop()}}),e,this)})));return function(t,n,r,a){return e.apply(this,arguments)}}()}]),e}()},24908:function(e,t,n){n.d(t,{FE:function(){return u},Qp:function(){return p},VN:function(){return l},eB:function(){return h},sG:function(){return d}});var r=n(43144),a=n(15671),s=n(37762),o=n(24713),c=n(74847),i=n(89591);function u(e){var t=e.type===o.J.Handle?e.handleType:e.type;switch(t){case o.J.Blob:case o.J.Attachment:return"blob";case o.J.Tree:return"tree";default:(0,i.U)(t,"Unknown type: ".concat(t))}}function h(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Map,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r={},a={id:e.sha,blobs:{},trees:{}};r[""]=a;var o,c=(0,s.Z)(e.tree);try{for(c.s();!(o=c.n()).done;){var i=o.value,u=n?i.path.replace(/^\.app\//,""):i.path,h=u.lastIndexOf("/"),p=u.slice(0,Math.max(0,h)),l=u.slice(h+1),d=r[p];if("tree"===i.type){var m={id:i.sha,blobs:{},commits:{},trees:{}};d.trees[decodeURIComponent(l)]=m,r[u]=m}else{if("blob"!==i.type)throw new Error("Unknown entry type!!");d.blobs[decodeURIComponent(l)]=i.sha,t.set(i.sha,"/".concat(u))}}}catch(f){c.e(f)}finally{c.f()}return a}var p=(0,r.Z)((function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"utf-8";(0,a.Z)(this,e),this.path=t,this.mode=c.m.File,this.type=c.S.Blob,this.value={contents:n,encoding:r}})),l=(0,r.Z)((function e(t,n){(0,a.Z)(this,e),this.path=t,this.value=n,this.mode=c.m.Directory,this.type=c.S.Tree})),d=(0,r.Z)((function e(t,n){(0,a.Z)(this,e),this.path=t,this.id=n,this.mode=c.m.File,this.type=c.S.Attachment,this.value={id:n}}))},74847:function(e,t,n){var r,a;n.d(t,{S:function(){return a},m:function(){return r}}),function(e){e.File="100644",e.Executable="100755",e.Directory="040000",e.Symlink="120000"}(r||(r={})),function(e){e.Blob="Blob",e.Tree="Tree",e.Attachment="Attachment"}(a||(a={}))}}]);
//# sourceMappingURL=summaryModule.5a4c2f85.chunk.js.map