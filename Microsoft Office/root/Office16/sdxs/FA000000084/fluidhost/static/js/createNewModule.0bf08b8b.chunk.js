/*! For license information please see createNewModule.0bf08b8b.chunk.js.LICENSE.txt */
"use strict";(self.webpackChunkfluidhost=self.webpackChunkfluidhost||[]).push([[3119],{30260:function(e,t,n){n.r(t),n.d(t,{createNewContainerOnExistingFile:function(){return D},createNewFluidFile:function(){return P}});var r=n(74165),a=n(4942),o=n(15861),c=n(27186),i=n(1244),s=n(82486),u=n(20427),p=n(76269),l=n(66584),h=n(89175),d=n(72330),f=n(84693),m=n(81543),v=n(92810),y=n(24713),b=n(65675),w=n(24071),k=n(89591),g=n(24908),Z=n(42874);function x(e,t){var n=e.tree[".protocol"],r=(0,b.yK)(n).sequenceNumber,a=new Map,o=T(e,a);return o.id=t,{snapshotTree:o,blobs:a,ops:[],sequenceNumber:r,latestSequenceNumber:r}}function T(e,t){for(var n={blobs:{},trees:{},unreferenced:e.unreferenced},r=0,a=Object.keys(e.tree);r<a.length;r++){var o=a[r],c=e.tree[o];switch(c.type){case y.J.Tree:n.trees[o]=T(c,t);break;case y.J.Blob:var i="string"===typeof c.content?(0,w.k8)(c.content,"utf8"):c.content,s=(0,v.Z)();n.blobs[o]=s,t.set(s,i);break;case y.J.Handle:case y.J.Attachment:throw new Error("No ".concat(c.type," should be present for detached summary!"));default:(0,k.U)(c,"Unknown tree type ".concat(c.type))}}return n}function C(e){var t;if(!(0,b.F2)(e))throw new Error("App and protocol summary required for create new path!!");var n=e.tree[".app"],r=e.tree[".protocol"],a=(0,b.yK)(r),o={type:y.J.Blob,content:JSON.stringify(a)};return r.tree.attributes=o,{entries:null!==(t=I({type:y.J.Tree,tree:{".protocol":r,".app":n}}).entries)&&void 0!==t?t:[],message:"app",sequenceNumber:a.sequenceNumber,type:"container"}}function I(e){for(var t,n={type:"tree",entries:[]},r=0,a=Object.keys(e.tree);r<a.length;r++){var o=a[r],c=e.tree[o],i=void 0,s=void 0;switch(c.type){case y.J.Tree:i=I(c),s=c.unreferenced;break;case y.J.Blob:i={type:"blob",content:"string"===typeof c.content?c.content:(0,w.IN)(c.content,"base64"),encoding:"string"===typeof c.content?"utf-8":"base64"};break;case y.J.Handle:throw new Error("No handle should be present for first summary!!");default:throw new Error("Unknown tree type ".concat(c.type))}var u={path:encodeURIComponent(o),type:(0,g.FE)(c),value:i,unreferenced:s};null===(t=n.entries)||void 0===t||t.push(u)}return n}function S(e){return N.apply(this,arguments)}function N(){return N=(0,o.Z)((0,r.Z)().mark((function e(t){var n,a,c,i,u,p,d,f,m;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.containerSnapshot,a=t.getStorageToken,c=t.logger,i=t.initialUrl,u=t.forceAccessTokenViaAuthorizationHeader,p=t.epochTracker,d=t.telemetryName,f=t.fetchType,m=t.validateResponseCallback,e.abrupt("return",(0,h.PM)(function(){var e=(0,o.Z)((0,r.Z)().mark((function e(t){var y;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a(t,d);case 2:return y=e.sent,e.abrupt("return",s.Xr.timedExecAsync(c,{eventName:d},function(){var e=(0,o.Z)((0,r.Z)().mark((function e(a){var s,b,w,k,g,x,T,C,I;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=JSON.stringify(n),k=!1,g=(0,v.Z)(),x="--".concat(g,"\r\n"),x+="Authorization: Bearer ".concat(y,"\r\n"),x+="X-HTTP-Method-Override: POST\r\n",x+="Content-Type: application/json\r\n",x+="_post: 1\r\n",x+="\r\n".concat(s,"\r\n"),(x+="\r\n--".concat(g,"--")).length<=h.OC?((T=new URL(i)).searchParams.set("ump","1"),b=T.href,w={"Content-Type":"multipart/form-data;boundary=".concat(g)},k=!0):(C=(0,l.y)(i,y,u),b=C.url,w=Object.assign(Object.assign({},C.headers),{"Content-Type":"application/json"}),x=s),e.next=13,(0,Z.k)((0,o.Z)((0,r.Z)().mark((function e(){return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",p.fetchAndParseAsJSON(b,{body:x,headers:w,method:"POST"},f,k));case 1:case"end":return e.stop()}}),e)}))),d,c);case 13:return I=e.sent,null===m||void 0===m||m(I.content),a.end(Object.assign({headers:0!==Object.keys(w).length||void 0,attempts:t.refresh?2:1},I.propsToLog)),e.abrupt("return",I.content);case 17:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 2:case"end":return e.stop()}}),e)}))),N.apply(this,arguments)}var O=n(71520),U=n(73333),A=function(e){return!!e.match(/["*/:<>?\\|]+/g)};function P(e,t,n,r,a,o,c,i,s,u,p){return F.apply(this,arguments)}function F(){return(F=(0,o.Z)((0,r.Z)().mark((function e(t,n,o,s,p,l,f,v,y,b,w){var k,g,Z,T,C,I,S,N;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!A(n.filename)){e.next=2;break}throw new i.V2("Invalid filename for createNew",u.x.invalidFileNameError,{driverVersion:O.Z});case 2:if(g="",void 0!==s){e.next=9;break}return e.next=6,j(t,n,o,p,v);case 6:k=e.sent,e.next=15;break;case 9:return e.next=11,L(t,n,o,s,p,v);case 11:T=e.sent,k=T.itemId,g=T.id,Z=J(n.createLinkType,T,b,w);case 15:return C=(0,d.v)(Object.assign(Object.assign({},n),{itemId:k,dataStorePath:"/"})),I=new m.D,e.next=19,I.resolve({url:C,headers:(0,a.Z)({},U.m.isClpCompliantApp,y)});case 19:if(S=e.sent,l.docId=S.hashedDocumentId,l.resolvedUrl=S,S.shareLinkInfo=Z,void 0===s||!f){e.next=28;break}return(0,c.h)(void 0!==g,515),N=x(s,g),e.next=28,p.put((0,h.db)(S),N);case 28:return e.abrupt("return",S);case 29:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function J(e,t,n,r){if(e){var a;if(n){var o=t.sharing;if(!o)return;a={createLink:{type:e,link:o.sharingLink?Object.assign({scope:o.sharingLink.scope,role:o.sharingLink.type,webUrl:o.sharingLink.webUrl},o.sharingLink):void 0,error:o.error,shareId:o.shareId}}}else if(r){var c=t.sharing,i=t.sharingLink,s=t.sharingLinkErrorReason;if(!i&&!s)return;a={createLink:{type:e,link:i,error:s,shareId:null===c||void 0===c?void 0:c.shareId}}}return a}}function j(e,t,n,r,a){return E.apply(this,arguments)}function E(){return E=(0,o.Z)((0,r.Z)().mark((function e(t,n,a,c,u){var d,m,v;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return d=n.filePath?encodeURIComponent("/".concat(n.filePath)):"",m=encodeURIComponent("".concat(n.filename,".tmp")),v="".concat((0,f.cB)((0,h.P$)(n.siteUrl)),"/drives/").concat(n.driveId,"/items/root:/").concat(d,"/").concat(m,":/content?@name.conflictBehavior=rename&select=id,name,parentReference"),e.abrupt("return",(0,h.PM)(function(){var e=(0,o.Z)((0,r.Z)().mark((function e(n){var h;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t(n,"CreateNewFile");case 2:return h=e.sent,e.abrupt("return",s.Xr.timedExecAsync(a,{eventName:"createNewEmptyFile"},function(){var e=(0,o.Z)((0,r.Z)().mark((function e(t){var n,s,d,f,m;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=(0,l.y)(v,h,u),s=n.url,(d=n.headers)["Content-Type"]="application/json",e.next=4,(0,Z.k)((0,o.Z)((0,r.Z)().mark((function e(){return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",c.fetchAndParseAsJSON(s,{body:void 0,headers:d,method:"PUT"},"createFile"));case 1:case"end":return e.stop()}}),e)}))),"createFile",a);case 4:if(f=e.sent,(m=f.content)&&m.id){e.next=8;break}throw new i.V2("ODSP CreateFile call returned no item ID (for empty file)",p.C.incorrectServerResponse,{driverVersion:O.Z});case 8:return t.end(Object.assign({headers:0!==Object.keys(d).length||void 0},f.propsToLog)),e.abrupt("return",m.id);case 10:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),{end:!0,cancel:"error"}));case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 4:case"end":return e.stop()}}),e)}))),E.apply(this,arguments)}function L(e,t,n,r,a,o){return R.apply(this,arguments)}function R(){return(R=(0,o.Z)((0,r.Z)().mark((function e(t,n,a,o,c,s){var u,l,d,m,v,y;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return u=n.filePath?encodeURIComponent("/".concat(n.filePath)):"",l=encodeURIComponent(n.filename),d="".concat((0,f.cB)((0,h.P$)(n.siteUrl)),"/drives/").concat(n.driveId,"/items/root:")+"".concat(u,"/").concat(l),m=C(o),v=(0,h.Wd)(n.createLinkType),y="".concat(d,":/opStream/snapshots/snapshot").concat(v?"?".concat(v):""),e.abrupt("return",S({containerSnapshot:m,getStorageToken:t,logger:a,initialUrl:y,forceAccessTokenViaAuthorizationHeader:s,epochTracker:c,telemetryName:"CreateNewFile",fetchType:"createFile",validateResponseCallback:function(e){if(!e||!e.itemId)throw new i.V2("ODSP CreateFile call returned no item ID",p.C.incorrectServerResponse,{driverVersion:O.Z})}}));case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var B=n(74033);function D(e,t,n,r,a,o,c,i,s){return V.apply(this,arguments)}function V(){return(V=(0,o.Z)((0,r.Z)().mark((function e(t,n,o,c,i,s,u,p,l){var v,y,b,w,k,g,Z,T,I;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0!==c){e.next=2;break}throw new B.O("createNewSummary must exist to create a new container");case 2:return v="".concat((0,f.cB)((0,h.P$)(n.siteUrl)),"/drives/").concat(n.driveId,"/items/").concat(n.itemId),y=C(c),b="".concat(v,"/opStream/snapshots/snapshot"),e.next=7,S({containerSnapshot:y,getStorageToken:t,logger:o,initialUrl:b,forceAccessTokenViaAuthorizationHeader:p,epochTracker:i,telemetryName:"CreateNewContainerOnExistingFile",fetchType:"uploadSummary"});case 7:return w=e.sent,k=w.id,g=(0,d.v)(Object.assign(Object.assign({},n),{dataStorePath:"/"})),Z=new m.D,e.next=13,Z.resolve({url:g,headers:(0,a.Z)({},U.m.isClpCompliantApp,l)});case 13:if(T=e.sent,s.docId=T.hashedDocumentId,s.resolvedUrl=T,!u){e.next=20;break}return I=x(c,k),e.next=20,i.put((0,h.db)(T),I);case 20:return e.abrupt("return",T);case 21:case"end":return e.stop()}}),e)})))).apply(this,arguments)}},24908:function(e,t,n){n.d(t,{FE:function(){return u},Qp:function(){return l},VN:function(){return h},eB:function(){return p},sG:function(){return d}});var r=n(43144),a=n(15671),o=n(37762),c=n(24713),i=n(74847),s=n(89591);function u(e){var t=e.type===c.J.Handle?e.handleType:e.type;switch(t){case c.J.Blob:case c.J.Attachment:return"blob";case c.J.Tree:return"tree";default:(0,s.U)(t,"Unknown type: ".concat(t))}}function p(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Map,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r={},a={id:e.sha,blobs:{},trees:{}};r[""]=a;var c,i=(0,o.Z)(e.tree);try{for(i.s();!(c=i.n()).done;){var s=c.value,u=n?s.path.replace(/^\.app\//,""):s.path,p=u.lastIndexOf("/"),l=u.slice(0,Math.max(0,p)),h=u.slice(p+1),d=r[l];if("tree"===s.type){var f={id:s.sha,blobs:{},commits:{},trees:{}};d.trees[decodeURIComponent(h)]=f,r[u]=f}else{if("blob"!==s.type)throw new Error("Unknown entry type!!");d.blobs[decodeURIComponent(h)]=s.sha,t.set(s.sha,"/".concat(u))}}}catch(m){i.e(m)}finally{i.f()}return a}var l=(0,r.Z)((function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"utf-8";(0,a.Z)(this,e),this.path=t,this.mode=i.m.File,this.type=i.S.Blob,this.value={contents:n,encoding:r}})),h=(0,r.Z)((function e(t,n){(0,a.Z)(this,e),this.path=t,this.value=n,this.mode=i.m.Directory,this.type=i.S.Tree})),d=(0,r.Z)((function e(t,n){(0,a.Z)(this,e),this.path=t,this.id=n,this.mode=i.m.File,this.type=i.S.Attachment,this.value={id:n}}))},74847:function(e,t,n){var r,a;n.d(t,{S:function(){return a},m:function(){return r}}),function(e){e.File="100644",e.Executable="100755",e.Directory="040000",e.Symlink="120000"}(r||(r={})),function(e){e.Blob="Blob",e.Tree="Tree",e.Attachment="Attachment"}(a||(a={}))}}]);
//# sourceMappingURL=createNewModule.0bf08b8b.chunk.js.map