/*! For license information please see 6732.8ccea83d.chunk.js.LICENSE.txt */
"use strict";(self.webpackChunkfluidhost=self.webpackChunkfluidhost||[]).push([[6732],{96732:function(e,t,r){r.d(t,{n:function(){return ct}});var n,a,o=r(1413),s=r(43144),i=r(15671),c=r(60136),u=r(29388),h=r(74165),l=r(29439),p=r(15861),d=r(82486),f=r(78077),v=r(65675),b=r(74329),g=r(92810),m=r(63658),y=r(34264),k=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:36e5;(0,i.Z)(this,e),this.snapshotExpiryPolicy=t,this.cache=new Map,this.docIdExpirationMap=new Map}return(0,s.Z)(e,[{key:"get",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t){var r;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=(0,y.r)(t),e.abrupt("return",this.cache.get(r));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"put",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t,r){var n;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=(0,y.r)(t),this.cache.set(n,r),this.updateExpirationEntry(t.file.docId);case 3:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"removeEntries",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.removeDocIdEntriesFromCache(t.docId);case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"removeDocIdEntriesFromCache",value:function(e){var t=this;return this.removeExpirationEntry(e),Array.from(this.cache).filter((function(t){if((0,l.Z)(t,1)[0].split("_")[0]===e)return!0})).map((function(e){var r=(0,l.Z)(e,1)[0];t.cache.delete(r)}))}},{key:"removeExpirationEntry",value:function(e){var t=this.docIdExpirationMap.get(e);void 0!==t&&(clearTimeout(t),this.docIdExpirationMap.delete(e))}},{key:"updateExpirationEntry",value:function(e){var t=this;this.removeExpirationEntry(e),this.docIdExpirationMap.set(e,setTimeout((function(){t.removeDocIdEntriesFromCache(e)}),this.snapshotExpiryPolicy))}}]),e}(),S=(0,s.Z)((function e(){(0,i.Z)(this,e),this.sessionJoinCache=new m.t,this.fileUrlCache=new m.t,this.snapshotPrefetchResultCache=new m.t})),Z=r(48102),w=r(27186),x=r(15318),T=r(35935),C=r.n(T),O=r(41721),E=r(89175),N=function(){function e(t,r,n,a){(0,i.Z)(this,e),this.deltaFeedUrl=t,this.getStorageToken=r,this.epochTracker=n,this.logger=a}return(0,s.Z)(e,[{key:"get",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t,r,n,a){var o=this;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,E.PM)(function(){var e=(0,p.Z)((0,h.Z)().mark((function e(s){var i,c;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=o.buildUrl(t,r),e.next=3,o.getStorageToken(s,"DeltaStorage");case 3:return c=e.sent,e.abrupt("return",d.Xr.timedExecAsync(o.logger,Object.assign(Object.assign({eventName:"OpsFetch",attempts:s.refresh?2:1,from:t,to:r},n),{reason:a}),function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t){var r,n,s,u,l,p,d,f;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=(0,g.Z)(),n="--".concat(r,"\r\n"),n+="Authorization: Bearer ".concat(c,"\r\n"),n+="X-HTTP-Method-Override: GET\r\n",n+="_post: 1\r\n",n+="\r\n--".concat(r,"--"),s={"Content-Type":"multipart/form-data;boundary=".concat(r)},u=new(C()),l=setTimeout((function(){return u.abort()}),3e4),e.next=11,o.epochTracker.fetchAndParseAsJSON(i,{headers:s,body:n,method:"POST",signal:u.signal},"ops",!0,a);case 11:return p=e.sent,clearTimeout(l),d=p.content,f=d.value.length>0&&"op"in d.value[0]?d.value.map((function(e){return e.op})):d.value,t.end(Object.assign({headers:0!==Object.keys(s).length||void 0,length:f.length},p.propsToLog)),e.abrupt("return",{messages:f,partialResult:!1});case 17:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)})));return function(t,r,n,a){return e.apply(this,arguments)}}()},{key:"buildUrl",value:function(e,t){var r=encodeURIComponent("sequenceNumber ge ".concat(e," and sequenceNumber le ").concat(t-1)),n="?ump=1&filter=".concat(r);return"".concat(this.deltaFeedUrl).concat(n)}}]),e}(),P=function(){function e(t,r,n,a,o,s,c,u){(0,i.Z)(this,e),this.snapshotOps=t,this.logger=r,this.batchSize=n,this.concurrency=a,this.getFromStorage=o,this.getCached=s,this.requestFromSocket=c,this.opsReceived=u,this.firstCacheMiss=Number.MAX_SAFE_INTEGER}return(0,s.Z)(e,[{key:"fetchMessages",value:function(e,t,r,n,a){var o=this;(0,w.h)(!n||void 0===t,483);var s=0,i=0,c=0,u=function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t,r,u){var l,p,d;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===o.snapshotOps||0===o.snapshotOps.length){e.next=8;break}if(l=o.snapshotOps.filter((function(e){return e.sequenceNumber>=t&&e.sequenceNumber<r})),(0,E.wz)("cached",l,t,o.logger),!(l.length>0&&l[0].sequenceNumber===t)){e.next=7;break}return o.snapshotOps=o.snapshotOps.filter((function(e){return e.sequenceNumber>=r})),s=l.length,e.abrupt("return",{messages:l,partialResult:!0});case 7:o.snapshotOps=void 0;case 8:if(o.requestFromSocket(t,r),!(t<o.firstCacheMiss)){e.next=18;break}return e.next=12,o.getCached(t,r);case 12:if(p=e.sent,(0,E.wz)("cached",p,t,o.logger),0===p.length){e.next=17;break}return i+=p.length,e.abrupt("return",{messages:p,partialResult:!0});case 17:o.firstCacheMiss=Math.min(o.firstCacheMiss,t);case 18:if(!n){e.next=20;break}return e.abrupt("return",{messages:[],partialResult:!1});case 20:return e.next=22,o.getFromStorage(t,r,u,a);case 22:return d=e.sent,(0,E.wz)("storage",d.messages,t,o.logger),c+=d.messages.length,o.opsReceived(d.messages),e.abrupt("return",d);case 27:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}(),l=(0,O.L)(function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t,r,n){var a;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,u(t,r,n);case 2:return a=e.sent,(0,E.wz)("catch all",a.messages,t,o.logger),e.abrupt("return",a);case 5:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}(),this.concurrency,e,t,this.batchSize,this.logger,r,a);return(0,O.lb)(l,(function(e){e.done&&s+i+c!==0&&o.logger.sendPerformanceEvent({eventName:"CacheOpsRetrieved",opsFromSnapshot:s,opsFromCache:i,opsFromStorage:c})}))}}]),e}(),B=r(11752),L=r(61120),I=r(9070),U=r(5927);function R(e,t){for(var r,n,a,o,s,i,c,u,h,l,p=null!==(n=null===(r=I.S.getEntriesByType)||void 0===r?void 0:r.call(I.S,"resource"))&&void 0!==n?n:[],d=p.length-1;d>0;d--){var f=p[d],v=f.name.toString();if(0===f.initiatorType.localeCompare(t)&&v.includes(e)){o=f.redirectEnd-f.redirectStart,l=f.fetchStart,a=f.domainLookupEnd-f.domainLookupStart,s=f.connectEnd-f.connectStart,i=f.secureConnectionStart>0?f.connectEnd-f.secureConnectionStart:0,c=f.responseStart>0?f.responseEnd-f.responseStart:void 0,u=f.fetchStart>0?f.responseEnd-f.fetchStart:void 0,h=f.requestStart>0?f.responseEnd-f.requestStart:void 0;break}}return{dnsLookupTime:a,w3cStartTime:l,redirectTime:o,tcpHandshakeTime:s,secureConnectionTime:i,responseNetworkTime:c,fetchStartToResponseEndTime:u,reqStartToResponseEndTime:h}}function j(e){return M.apply(this,arguments)}function M(){return(M=(0,p.Z)((0,h.Z)().mark((function e(t){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,r){t.forEach((function(t,n){t.then((function(t){return e({index:n,value:t})})).catch(r)}))})));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}!function(e){e[e.NoCaching=0]="NoCaching",e[e.Prefetch=1]="Prefetch"}(n||(n={})),function(e){e.default="default",e.noCache="noCache"}(a||(a={}));var A=r(76269),D=r(40698),F=r(1244),z=r(20427),q=r(37762),_=r(29930),V=r(1467),W=r(65059),H=r(26795),G=r(84556);function J(e){for(var t="",r=0,n=Object.keys(e);r<n.length;r++){var a=n[r];if(void 0!==e[a])t+="".concat(""===t?"?":"&").concat(a,"=").concat(encodeURIComponent(e[a]))}return t}var X=r(66584),Q=r(24071);function K(e){var t={},r={id:e.id,blobs:{},trees:{}};t[""]=r;var n,a=(0,q.Z)(e.entries);try{for(a.s();!(n=a.n()).done;){var o=n.value,s=o.path.lastIndexOf("/"),i=o.path.slice(0,Math.max(0,s)),c=o.path.slice(s+1),u=t[i];if("tree"===o.type){var h={blobs:{},trees:{},unreferenced:o.unreferenced};u.trees[decodeURIComponent(c)]=h,t[o.path]=h}else"blob"===o.type&&(u.blobs[decodeURIComponent(c)]=o.id)}}catch(l){a.e(l)}finally{a.f()}return r}function $(e){var t,r,n=new Map;e.blobs&&e.blobs.forEach((function(e){var t;(0,w.h)("base64"===e.encoding||void 0===e.encoding,164),n.set(e.id,(0,Q.k8)(e.content,null!==(t=e.encoding)&&void 0!==t?t:"utf8"))}));var a=null===e||void 0===e?void 0:e.trees[0].sequenceNumber;return{blobs:n,ops:null!==(r=null===(t=e.ops)||void 0===t?void 0:t.map((function(e){return e.op})))&&void 0!==r?r:[],sequenceNumber:a,snapshotTree:K(e.trees[0]),latestSequenceNumber:e.ops&&e.ops.length>0?e.ops[e.ops.length-1].sequenceNumber:a}}var Y,ee,te,re=function(){function e(t){(0,i.Z)(this,e),this.data=t,this.index=0,Object.freeze(t.buffer)}return(0,s.Z)(e,[{key:"buffer",get:function(){return this.data}},{key:"eof",get:function(){return this.index===this.data.length}},{key:"pos",get:function(){return this.index}},{key:"length",get:function(){return this.data.length}},{key:"slice",value:function(e,t){return this.data.slice(e,t)}},{key:"reset",value:function(){this.index=0}},{key:"read",value:function(){for(var e=0,t=1,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;r>0;)(0,w.h)(!this.eof,547),e+=this.data[this.index]*t,this.index++,t*=256,r--;return e}},{key:"skip",value:function(e){(0,w.h)(e>=0,548),this.index+=e,(0,w.h)(this.index<=this.data.length,988)}}]),e}(),ne=r(4942),ae=r(95576),oe=r(71520);!function(e){e[e.BoolTrue=11]="BoolTrue",e[e.BoolFalse=12]="BoolFalse",e[e.StringEmpty=13]="StringEmpty",e[e.String8Length=14]="String8Length",e[e.String16Length=15]="String16Length",e[e.String32Length=16]="String32Length",e[e.ConstString8Id=17]="ConstString8Id",e[e.ConstString16Id=18]="ConstString16Id",e[e.ConstString32Id=19]="ConstString32Id",e[e.ConstStringDeclare=20]="ConstStringDeclare",e[e.ConstStringDeclareBig=21]="ConstStringDeclareBig",e[e.Int0=1]="Int0",e[e.UInt8=3]="UInt8",e[e.UInt16=5]="UInt16",e[e.UInt32=7]="UInt32",e[e.UInt64=9]="UInt64",e[e.Int8=2]="Int8",e[e.Int16=4]="Int16",e[e.Int32=6]="Int32",e[e.Int64=8]="Int64",e[e.BinaryEmpty=32]="BinaryEmpty",e[e.BinarySingle8=33]="BinarySingle8",e[e.BinarySingle16=34]="BinarySingle16",e[e.BinarySingle32=35]="BinarySingle32",e[e.BinarySingle64=36]="BinarySingle64"}(Y||(Y={})),function(e){e[e.list=49]="list",e[e.set=51]="set"}(ee||(ee={})),function(e){e[e.list=50]="list",e[e.set=52]="set"}(te||(te={}));var se={1:0,2:1,3:1,4:2,5:2,6:4,7:4,8:8,9:8,13:0,14:1,15:2,16:4,17:1,18:2,19:4,20:1,21:4,32:0,33:1,34:2,35:4,36:8};function ie(e,t){var r=e[t];return(0,w.h)(void 0!==r,647),r}function ce(e){var t,r={},n=(0,q.Z)(e.iteratePairs());try{for(n.s();!(t=n.n()).done;){var a=(0,l.Z)(t.value,2),o=a[0],s=a[1];r[fe(o,"keynode should be a string")]=s}}catch(i){n.e(i)}finally{n.f()}return r}var ue=(0,s.Z)((function e(){(0,i.Z)(this,e)})),he=function(e){(0,c.Z)(r,e);var t=(0,u.Z)(r);function r(e){var n;return(0,i.Z)(this,r),(n=t.call(this)).data=e,n}return(0,s.Z)(r,[{key:"buffer",get:function(){return this.data}},{key:"arrayBuffer",get:function(){return(0,ae.H)(this.buffer)}}],[{key:"read",value:function(e,t){for(var n=e.read(t),a=new Uint8Array(n),o=0;o<n;o++)a[o]=e.read();return new r(a)}}]),r}(ue),le=function(e){(0,c.Z)(r,e);var t=(0,u.Z)(r);function r(e,n,a){var o;return(0,i.Z)(this,r),(o=t.call(this)).data=e,o.start=n,o.end=a,o}return(0,s.Z)(r,[{key:"buffer",get:function(){return this.data.subarray(this.start,this.end)}},{key:"arrayBuffer",get:function(){var e=this.data.byteOffset;return this.data.buffer.slice(this.start+e,this.end+e)}}],[{key:"read",value:function(e,t){var n=e.read(t),a=e.pos;return e.skip(n),new r(e.buffer,a,a+n)}}]),r}(ue),pe=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"set";(0,i.Z)(this,t),this.type=e,this.children=[]}return(0,s.Z)(t,[{key:"nodes",get:function(){return this.children}},{key:e,value:function(){return this.children[Symbol.iterator]()}},{key:"iteratePairs",value:function(){return(0,w.h)(this.length%2===0,556),function(e){var t=(0,ne.Z)({next:function(){var t=e.next();if(t.done)return{value:void 0,done:!0};var r=e.next();return(0,w.h)(!0!==r.done,555),{value:[t.value,r.value],done:r.done}}},Symbol.iterator,(function(){return t}));return t}(this[Symbol.iterator]())}},{key:"length",get:function(){return this.children.length}},{key:"get",value:function(e){return this.children[e]}},{key:"getString",value:function(e){return fe(this.children[e],"getString should return string")}},{key:"getMaybeString",value:function(e){return function(e){var t=e;if(t._stringElement)return t.content}(this.children[e])}},{key:"getBlob",value:function(e){var t=this.children[e];return ve(t,"getBlob should return a blob"),t}},{key:"getNode",value:function(e){var t=this.children[e];return be(t,"getNode should return a node"),t}},{key:"getNumber",value:function(e){var t=this.children[e];return ge(t,"getNumber should return a number"),t}},{key:"getBool",value:function(e){var t=this.children[e];return me(t,"getBool should return a boolean"),t}},{key:"addNode",value:function(e){var r=new t(e);return this.children.push(r),r}},{key:"addBlob",value:function(e){this.children.push(new he(e))}},{key:"addDictionaryString",value:function(e){this.children.push({content:e,dictionary:!0,_stringElement:!0})}},{key:"addString",value:function(e){this.children.push({content:e,dictionary:!1,_stringElement:!0})}},{key:"addNumber",value:function(e){(0,w.h)(Number.isInteger(e),561),(0,w.h)(void 0!==e&&e>=0,562),this.children.push(e)}},{key:"addBool",value:function(e){this.children.push(e)}},{key:"load",value:function(e,t){var r=this,n=(0,E.L8)((function(){return r.loadStructure(e,t)})),a=(0,l.Z)(n,2),o=a[0],s=a[1],i=(0,E.L8)((function(){return r.loadStrings(e,o,t)}));return{durationStructure:s,durationStrings:(0,l.Z)(i,2)[1]}}},{key:"loadStructure",value:function(e,r){for(var n=[],a=[],o=[],s=this.children;!e.eof;){var i=e.read();switch(i){case ee.list:case ee.set:var c=new t(i===ee.set?"set":"list");s.push(c),n.push(s),s=c.children;continue;case Y.ConstStringDeclare:case Y.ConstStringDeclareBig:var u=e.read(ie(se,i)),h=t.readString(e,i,!0);a.push(h),o[u]=h;continue;case Y.ConstString8Id:case Y.ConstString16Id:case Y.ConstString32Id:var l=o[e.read(ie(se,i))];(0,w.h)(void 0!==l,990),s.push(l);continue;case Y.StringEmpty:case Y.String8Length:case Y.String16Length:case Y.String32Length:var p=t.readString(e,i,!1);a.push(p),s.push(p);continue;case Y.BinaryEmpty:case Y.BinarySingle8:case Y.BinarySingle16:case Y.BinarySingle32:case Y.BinarySingle64:s.push(le.read(e,ie(se,i)));continue;case Y.Int0:s.push(0);continue;case Y.UInt8:case Y.UInt16:case Y.UInt32:case Y.UInt64:case Y.Int8:case Y.Int16:case Y.Int32:case Y.Int64:s.push(e.read(ie(se,i)));continue;case Y.BoolTrue:s.push(!0);continue;case Y.BoolFalse:s.push(!1);continue;case te.list:case te.set:s=n.pop();continue;default:throw new Error("Invalid code: ".concat(i))}}return(0,w.h)(s===this.children,999),a}},{key:"loadStrings",value:function(e,t,r){var n,a=0,o=(0,q.Z)(t);try{for(o.s();!(n=o.n()).done;){var s=n.value;a+=s.endPos-s.startPos+1}}catch(m){o.e(m)}finally{o.f()}var i=new Uint8Array(a);a=0;var c=e.buffer;(0,w.h)(0===c.byteOffset,1e3);var u,h=(0,q.Z)(t);try{for(h.s();!(u=h.n()).done;){for(var l=u.value,p=l.startPos;p<l.endPos;p++)i[a]=c[p],a++;i[a]=0,a++}}catch(m){h.e(m)}finally{h.f()}(0,w.h)(a===i.length,1048);var d=(0,Q.IN)(i,"utf-8").split(String.fromCharCode(0));if(d.length===t.length+1)for(var f=0;f<t.length;f++)t[f].content=d[f];else{r.sendErrorEvent({eventName:"StringParsingError"});var v,b=(0,q.Z)(t);try{for(b.s();!(v=b.n()).done;){var g=v.value;(0,w.h)(g.content===(0,Q.IN)(c.subarray(g.startPos,g.endPos),"utf-8"),1002)}}catch(m){b.e(m)}finally{b.f()}}}}],[{key:"readString",value:function(e,t,r){var n=ie(se,t),a=e.read(n),o=e.pos;return e.skip(a),{dictionary:r,_stringElement:!0,startPos:o,endPos:e.pos}}}]),t}(Symbol.iterator),de=function(e){(0,c.Z)(r,e);var t=(0,u.Z)(r);function r(){return(0,i.Z)(this,r),t.apply(this,arguments)}return(0,s.Z)(r,null,[{key:"load",value:function(e,t){var n=new r,a=n.load(e,t);return(0,w.h)(e.eof,563),{builder:n,telemetryProps:a}}}]),r}(pe);function fe(e,t){var r=e;if(r._stringElement)return r.content;ye(e,"BlobCore",t)}function ve(e,t){e instanceof ue||ye(e,"BlobCore",t)}function be(e,t){e instanceof pe||ye(e,"NodeCore",t)}function ge(e,t){"number"!==typeof e&&ye(e,"Number",t)}function me(e,t){"boolean"!==typeof e&&ye(e,"Boolean",t)}function ye(e,t,r){throw new F.V2("Buffer parsing exception: ".concat(r),A.C.incorrectServerResponse,{nodeType:ke(e),expectedNodeType:t,driverVersion:oe.Z})}function ke(e){return"number"===typeof e?"Number":e instanceof ue?"BlobCore":e instanceof pe?"NodeCore":"boolean"===typeof e?"Boolean":e._stringElement?"String":"UnknownType"}var Se,Ze="1.0",we="1.0";function xe(e){be(e,"Deltas should be of type NodeCore");var t=[],r=ce(e);ge(r.firstSequenceNumber,"Seq number should be a number"),be(r.deltas,"Deltas should be a Node");for(var n=0;n<r.deltas.length;++n)t.push(JSON.parse(r.deltas.getString(n)));return(0,w.h)(r.firstSequenceNumber.valueOf()===t[0].sequenceNumber,640),t}function Te(e){var t,r=0,n={},a={blobs:{},trees:n},o=(0,q.Z)(e);try{for(o.s();!(t=o.n()).done;){var s=t.value;be(s,"tree nodes should be nodes");var i=s.length;if(i>0&&"name"===s.getMaybeString(0)){if(4===i){var c=s.getMaybeString(2);if("children"===c){var u=Te(s.getNode(3));n[s.getString(1)]=u.snapshotTree,r+=u.slowTreeStructureCount;continue}if("value"===c){a.blobs[s.getString(1)]=s.getString(3);continue}}if(6===i&&"nodeType"===s.getMaybeString(2)&&"value"===s.getMaybeString(4)){a.blobs[s.getString(1)]=s.getString(5);continue}if(6===i&&"unreferenced"===s.getMaybeString(2)&&"children"===s.getMaybeString(4)){var h=Te(s.getNode(5));n[s.getString(1)]=h.snapshotTree,r+=h.slowTreeStructureCount,(0,w.h)(s.getBool(3),987),a.unreferenced=!0;continue}}r+=1;var l=ce(s);void 0!==l.unreferenced&&(me(l.unreferenced,"Unreferenced flag should be bool"),(0,w.h)(l.unreferenced,641),a.unreferenced=!0);var p=fe(l.name,"Path name should be string");if(void 0!==l.value)a.blobs[p]=fe(l.value,"Blob value should be string");else if(void 0!==l.children){be(l.children,"Trees should be of type NodeCore");var d=Te(l.children);n[p]=d.snapshotTree,r+=d.slowTreeStructureCount}else n[p]={blobs:{},trees:{}}}}catch(f){o.e(f)}finally{o.f()}return{snapshotTree:a,slowTreeStructureCount:r}}function Ce(e){be(e,"Snapshot should be of type NodeCore");var t=ce(e);be(t.treeNodes,"TreeNodes should be of type NodeCore"),ge(t.sequenceNumber,"sequenceNumber should be of type number");var r=Te(t.treeNodes),n=r.snapshotTree,a=r.slowTreeStructureCount;return n.id=fe(t.id,"snapshotId should be string"),{sequenceNumber:t.sequenceNumber.valueOf(),snapshotTree:n,slowTreeStructureCount:a}}function Oe(e,t){var r=de.load(new re(e),t),n=r.builder,a=r.telemetryProps;(0,w.h)(1===n.length,537);var o=ce(n.getNode(0)),s=fe(o.mrv,"minReadVersion should be string"),i=fe(o.cv,"createVersion should be string");void 0!==o.lsn&&ge(o.lsn,"lsn should be a number"),(0,w.h)(parseFloat(Ze)>=parseFloat(s),527),(0,w.h)(parseFloat(i)>=parseFloat(Ze),528),(0,w.h)(we===i,706);var c=(0,E.L8)((function(){return Ce(o.snapshot)})),u=(0,l.Z)(c,2),h=u[0],p=u[1],d=(0,E.L8)((function(){return function(e){be(e,"TreeBlobs should be of type NodeCore");var t,r=0,n=new Map,a=(0,q.Z)(e);try{for(a.s();!(t=a.n()).done;){var o=t.value;if(be(o,"blob should be node"),4!==o.length||"id"!==o.getMaybeString(0)||"data"!==o.getMaybeString(2)){r+=1;var s=ce(o);ve(s.data,"data should be of BlobCore type");var i=fe(s.id,"blob id should be string");n.set(i,s.data.arrayBuffer)}else n.set(o.getString(1),o.getBlob(3).arrayBuffer)}}catch(c){a.e(c)}finally{a.f()}return{blobs:n,slowBlobStructureCount:r}}(o.blobs)})),f=(0,l.Z)(d,2),v=f[0],b=f[1];return Object.assign(Object.assign(Object.assign({},h),v),{ops:void 0!==o.deltas?xe(o.deltas):[],latestSequenceNumber:o.lsn,telemetryProps:Object.assign(Object.assign({},a),{durationSnapshotTree:p,durationBlobs:b,slowTreeStructureCount:h.slowTreeStructureCount,slowBlobStructureCount:v.slowBlobStructureCount})})}function Ee(e,t,r,n,a,o,s){return Ne.apply(this,arguments)}function Ne(){return(Ne=(0,p.Z)((0,h.Z)().mark((function e(t,r,n,a,o,s,i){var c,u,l,f,v,b,g;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return c="/trees/".concat(n),u={},a&&(u="latest"!==n?{blobs:2}:{deltas:1,blobs:2}),l=J(u),f=(0,X.y)("".concat(t).concat(c).concat(l),r,o),v=f.url,b=f.headers,e.next=7,d.Xr.timedExecAsync(s,{eventName:"fetchSnapshot",headers:0!==Object.keys(b).length||void 0},(0,p.Z)((0,h.Z)().mark((function e(){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",i(v,{headers:b}));case 1:case"end":return e.stop()}}),e)}))));case 7:return g=e.sent,e.abrupt("return",$(g.content));case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Pe(e,t,r,n,a,o,s,i,c){return Be.apply(this,arguments)}function Be(){return Be=(0,p.Z)((0,h.Z)().mark((function e(t,r,n,a,o,s,i,c,u){var l;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(l=t.sharingLinkToRedeem)&&(t.shareLinkInfo=Object.assign(Object.assign({},t.shareLinkInfo),{sharingLinkToRedeem:l})),e.abrupt("return",Ue(t,r,n,o,s,i,u).catch(function(){var e=(0,p.Z)((0,h.Z)().mark((function e(c){var l;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!u||!qe(t,c)){e.next=8;break}return e.next=3,Le(t,r,o,a);case 3:return l=Object.assign(Object.assign({},t),{shareLinkInfo:Object.assign(Object.assign({},t.shareLinkInfo),{sharingLinkToRedeem:void 0})}),o.sendErrorEvent({eventName:"RedeemFallback",errorType:c.errorType},c),e.abrupt("return",Ue(l,r,n,o,s,i));case 8:throw c;case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch(function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(("object"!==typeof t||null===t||t.errorType!==A.C.authorizationError)&&t.errorType!==A.C.fileNotFoundOrAccessDeniedError){e.next=3;break}return e.next=3,c();case 3:throw t;case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 3:case"end":return e.stop()}}),e)}))),Be.apply(this,arguments)}function Le(e,t,r,n){return Ie.apply(this,arguments)}function Ie(){return Ie=(0,p.Z)((0,h.Z)().mark((function e(t,r,n,a){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",d.Xr.timedExecAsync(n,{eventName:"RedeemShareLink"},(0,p.Z)((0,h.Z)().mark((function e(){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,E.PM)(function(){var e=(0,p.Z)((0,h.Z)().mark((function e(n){var o,s,i,c,u,l,p,d;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(0,w.h)(!!(null===(o=t.shareLinkInfo)||void 0===o?void 0:o.sharingLinkToRedeem),493),e.next=3,r(n,"RedeemShareLink");case 3:return i=e.sent,c=_e(null===(s=t.shareLinkInfo)||void 0===s?void 0:s.sharingLinkToRedeem),u="".concat(t.siteUrl,"/_api/v2.0/shares/").concat(c),l=(0,X.y)(u,i,a),p=l.url,(d=l.headers).prefer="redeemSharingLink",e.abrupt("return",(0,E.tu)(p,{headers:d}));case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)})))));case 1:case"end":return e.stop()}}),e)}))),Ie.apply(this,arguments)}function Ue(e,t,r,n,a,o,s){return Re.apply(this,arguments)}function Re(){return Re=(0,p.Z)((0,h.Z)().mark((function e(t,r,n,a,o,s,i){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,E.PM)(function(){var e=(0,p.Z)((0,h.Z)().mark((function e(c){var u,f,v;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r(c,"TreesLatest",!0);case 2:return f=e.sent,(0,w.h)(null!==f,485),v={eventName:"TreesLatest",attempts:c.refresh?2:1,shareLinkPresent:void 0!==(null===(u=t.shareLinkInfo)||void 0===u?void 0:u.sharingLinkToRedeem),isSummarizer:t.summarizer,redeemFallbackEnabled:i},void 0!==n&&Object.entries(n).forEach((function(e){var t=(0,l.Z)(e,2),r=t[0],n=t[1];void 0!==n&&(v["snapshotOption_".concat(r)]=n)})),e.abrupt("return",d.Xr.timedExecAsync(a,v,function(){var e=(0,p.Z)((0,h.Z)().mark((function e(r){var i,c,u,d,v,b,g,m,y,k,S,Z,x,T,O,N,P,B,L,I,U,j,M,D,z,q,_,J,X,Q,K,Y,ee,te,re,ne,ae,se,ie,ce,ue,he,le,pe,de,fe,ve,be,ge;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0!==(null===n||void 0===n?void 0:n.timeout)&&(k=new(C()),S=setTimeout((function(){return k.abort()}),n.timeout)),e.next=3,(0,E.iw)((0,p.Z)((0,h.Z)().mark((function e(){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",o(t,f,n,k));case 1:case"end":return e.stop()}}),e)})))).finally((function(){void 0!==S&&(clearTimeout(S),S=void 0)}));case 3:Z=e.sent,x=(0,l.Z)(Z,2),T=x[0],O=x[1],N=T.odspResponse,P=N.headers.get("content-type"),B=Object.assign(Object.assign({},N.propsToLog),{contentType:P,accept:T.requestHeaders.accept,driverVersion:oe.Z}),(null===P||void 0===P?void 0:P.includes("application/ms-fluid"))?I="application/ms-fluid":(null===P||void 0===P?void 0:P.includes("application/json"))&&(I="application/json"),e.prev=11,e.t0=I,e.next="application/json"===e.t0?15:"application/ms-fluid"===e.t0?30:49;break;case 15:return e.next=17,(0,E.iw)((0,p.Z)((0,h.Z)().mark((function e(){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",N.content.text());case 1:case"end":return e.stop()}}),e)}))));case 17:return D=e.sent,z=(0,l.Z)(D,2),M=z[0],j=z[1],B.bodySize=M.length,_=(0,E.L8)((function(){return JSON.parse(M)})),J=(0,l.Z)(_,2),q=J[0],U=J[1],Ae(q),X=$(q),L=Object.assign(Object.assign({},N),{content:Object.assign(Object.assign({},X),{telemetryProps:{}})}),e.abrupt("break",50);case 30:return e.next=32,(0,E.iw)((0,p.Z)((0,h.Z)().mark((function e(){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",N.content.arrayBuffer());case 1:case"end":return e.stop()}}),e)}))));case 32:if(K=e.sent,Y=(0,l.Z)(K,2),Q=Y[0],j=Y[1],B.bodySize=Q.byteLength,te=(0,E.L8)((function(){return Oe(new Uint8Array(Q),a)})),re=(0,l.Z)(te,2),ee=re[0],U=re[1],void 0!==ee.snapshotTree.trees&&void 0!==ee.snapshotTree.blobs){e.next=43;break}throw new F.V2("Returned odsp snapshot is malformed. No trees or blobs!",A.C.incorrectServerResponse,B);case 43:return ne=ee.telemetryProps,ae=null!==(i=ne.slowTreeStructureCount)&&void 0!==i?i:0,se=null!==(c=ne.slowBlobStructureCount)&&void 0!==c?c:0,(ae>10||se>10)&&a.sendErrorEvent({eventName:"SlowSnapshotParseCodePaths",slowTreeStructureCount:ae,slowBlobStructureCount:se}),L=Object.assign(Object.assign({},N),{content:ee}),e.abrupt("break",50);case 49:throw new F.V2("Unknown snapshot content type",A.C.incorrectServerResponse,B);case 50:e.next=59;break;case 52:if(e.prev=52,e.t1=e.catch(11),!(0,V.IR)(e.t1)){e.next=57;break}throw e.t1.addTelemetryProperties(B),e.t1;case 57:throw(0,W.Jn)(e.t1,(function(e){return new F.V2("Error parsing snapshot response: ".concat(e),A.C.genericError,B)}));case 59:return(0,w.h)(void 0!==L,786),ie=L.content,ce=Me(ie),ue=ce.trees,he=ce.numBlobs,le=ce.encodedBlobsSize,pe="true"!==N.headers.get("disablebrowsercachingofusercontent"),de=null!==(u=ie.sequenceNumber)&&void 0!==u?u:0,fe=ie.ops&&ie.ops.length>0?ie.ops[0].sequenceNumber-1:void 0,!Number.isInteger(de)||void 0!==fe&&fe!==de?(a.sendErrorEvent({eventName:"fetchSnapshotError",sequenceNumber:de,seqNumberFromOps:fe}),ie.sequenceNumber=void 0):pe&&(ve=N.headers.get("x-fluid-epoch"),(0,w.h)(void 0!==ve,486),be=Object.assign(Object.assign({},ie),{cacheEntryTime:Date.now()}),ge={value:be,fluidEpoch:ve,version:G.N},s(ge)),r.end(Object.assign(Object.assign(Object.assign(Object.assign({trees:ue,blobs:null!==(v=null===(d=ie.blobs)||void 0===d?void 0:d.size)&&void 0!==v?v:0,leafNodes:he,encodedBlobsSize:le,sequenceNumber:de,ops:null!==(g=null===(b=ie.ops)||void 0===b?void 0:b.length)&&void 0!==g?g:0,userOps:null!==(y=null===(m=ie.ops)||void 0===m?void 0:m.filter((function(e){return(0,H.LW)(e)})).length)&&void 0!==y?y:0,headers:0!==Object.keys(T.requestHeaders).length||void 0,fetchTime:O,parseTime:U,receiveContentTime:j},R(T.requestUrl,"fetch")),{sltelemetry:N.headers.get("x-fluid-sltelemetry")}),B),L.content.telemetryProps)),e.abrupt("return",ie);case 68:case"end":return e.stop()}}),e,null,[[11,52]])})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){throw"object"!==typeof e||null===e||e.errorType!==A.C.fetchFailure&&e.errorType!==z.x.fetchTimeout||(e[E.Cx]=!0),e})));case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)}))),Re.apply(this,arguments)}function je(e,t,r,n){var a,o,s=(0,g.Z)(),i=[];return i.push("--".concat(s)),i.push("Authorization: Bearer ".concat(t)),i.push("X-HTTP-Method-Override: GET"),void 0!==r&&Object.entries(r).forEach((function(e){var t=(0,l.Z)(e,2),r=t[0],n=t[1];void 0!==n&&i.push("".concat(r,": ").concat(n))})),void 0!==n&&Object.entries(n).forEach((function(e){var t=(0,l.Z)(e,2),r=t[0],n=t[1];void 0!==n&&i.push("".concat(r,": ").concat(n))})),(null===(a=e.shareLinkInfo)||void 0===a?void 0:a.sharingLinkToRedeem)&&i.push("sl: ".concat(null===(o=e.shareLinkInfo)||void 0===o?void 0:o.sharingLinkToRedeem)),i.push("_post: 1"),i.push("\r\n--".concat(s,"--")),{body:i.join("\r\n"),headers:{"Content-Type":"multipart/form-data;boundary=".concat(s)}}}function Me(e){var t,r=De(e.snapshotTree),n=e.blobs.size,a=0,o=(0,q.Z)(e.blobs);try{for(o.s();!(t=o.n()).done;){var s=(0,l.Z)(t.value,2);s[0];a+=s[1].byteLength}}catch(i){o.e(i)}finally{o.f()}return{trees:r,numBlobs:n,encodedBlobsSize:a}}function Ae(e){(0,w.h)(void 0!==e.trees,512),(0,w.h)(void 0!==e.blobs,513)}function De(e){for(var t=0,r=0,n=Object.entries(e.trees);r<n.length;r++){var a=(0,l.Z)(n[r],2);a[0];t+=1,t+=De(a[1])}return t}function Fe(e,t,r,n,a,o,s,i){return ze.apply(this,arguments)}function ze(){return ze=(0,p.Z)((0,h.Z)().mark((function e(t,r,n,a,o,s,i,c){var u,l,p,d,f,v,b,g,m;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:(l=t.sharingLinkToRedeem)&&(t.shareLinkInfo=Object.assign(Object.assign({},t.shareLinkInfo),{sharingLinkToRedeem:l})),p=t.endpoints.snapshotStorageUrl,d="".concat(p,"/trees/latest?ump=1"),f=je(t,r,a,{prefer:"manualredirect"}),v=f.body,b=f.headers,g={body:v,headers:b,signal:null===s||void 0===s?void 0:s.signal,method:"POST"},e.t0=o,e.next=e.t0===Se.Binary?10:12;break;case 10:return b.accept="application/ms-fluid; v=".concat(we),e.abrupt("break",13);case 12:b.accept="application/json, application/ms-fluid; v=".concat(we);case 13:return e.next=15,null!==(u=null===i||void 0===i?void 0:i.fetch(d,g,"treesLatest",!0,c))&&void 0!==u?u:(0,E.X7)(d,g);case 15:return m=e.sent,e.abrupt("return",{odspResponse:m,requestHeaders:b,requestUrl:d});case 17:case"end":return e.stop()}}),e)}))),ze.apply(this,arguments)}function qe(e,t){var r;return void 0!==(null===(r=e.shareLinkInfo)||void 0===r?void 0:r.sharingLinkToRedeem)&&"object"===typeof t&&null!==t&&(t.errorType===A.C.authorizationError||t.errorType===A.C.fileNotFoundOrAccessDeniedError)}function _e(e){var t=(0,_.d3)(encodeURI(e));return t=t.replace(/=+$/g,"").replace(/\//g,"_").replace(/\+/g,"-"),t="u!".concat(t)}!function(e){e[e.Json=0]="Json",e[e.Binary=1]="Binary",e[e.JsonAndBinary=2]="JsonAndBinary"}(Se||(Se={}));var Ve=function(){function e(){(0,i.Z)(this,e),this.deferBlobCacheClear=!1,this._blobCache=new Map,this.blobsEvicted=new Set,this.blobCacheTimeoutDuration=12e4,this.purgeEnabled=!1}return(0,s.Z)(e,[{key:"value",get:function(){return this._blobCache}},{key:"addBlobs",value:function(e){var t=this;e.forEach((function(e,r){t._blobCache.set(r,e)})),this.scheduleClearBlobsCache()}},{key:"scheduleClearBlobsCache",value:function(){var e=this;if(void 0!==this.blobCacheTimeout)this.deferBlobCacheClear=!0;else if(this.purgeEnabled){this.blobCacheTimeout=setTimeout((function(){e.blobCacheTimeout=void 0,e.deferBlobCacheClear?(e.deferBlobCacheClear=!1,e.scheduleClearBlobsCache()):(e._blobCache.forEach((function(t,r){return e.blobsEvicted.add(r)})),e._blobCache.clear())}),this.blobCacheTimeoutDuration),this.blobCacheTimeoutDuration=1e4}}},{key:"getBlob",value:function(e){return this.scheduleClearBlobsCache(),{blobContent:this._blobCache.get(e),evicted:this.blobsEvicted.has(e)}}},{key:"setBlob",value:function(e,t){if(t.byteLength<262144)return this.scheduleClearBlobsCache(),this._blobCache.set(e,t);this.blobsEvicted.add(e)}}]),e}(),We=function(){function e(t){(0,i.Z)(this,e),this.commitCache=new Map,this.attributesBlobHandles=new Set,this.blobCache=new Ve;var r=t.getBoolean("Fluid.Driver.Odsp.TestOverride.DisableSnapshotCache")?0:432e6;this.policies={caching:n.NoCaching,minBlobSize:2048,maximumCacheDurationMs:r}}return(0,s.Z)(e,[{key:"ops",get:function(){return this._ops},set:function(e){(0,w.h)(void 0===this._ops,165),this._ops=e}},{key:"snapshotSequenceNumber",get:function(){return this._snapshotSequenceNumber}},{key:"repositoryUrl",get:function(){return""}},{key:"readBlobCore",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t){var r,n,a;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.blobCache.getBlob(t),n=r.blobContent,a=r.evicted,e.abrupt("return",null!==n&&void 0!==n?n:this.fetchBlobFromStorage(t,a));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"readBlob",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.readBlobCore(t));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getSnapshotTree",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t,r){var n,a,o,s,i,c;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t&&t.id){e.next=9;break}return e.next=3,this.getVersions(null,1,r);case 3:if((a=e.sent)&&0!==a.length){e.next=6;break}return e.abrupt("return",null);case 6:n=a[0].id,e.next=10;break;case 9:n=t.id;case 10:return e.next=12,this.readTree(n,r);case 12:if(o=e.sent){e.next=15;break}return e.abrupt("return",null);case 15:return o.blobs&&(s=o.blobs.attributes)&&this.attributesBlobHandles.add(s),i=o.trees[".app"],c=o.trees[".protocol"],e.abrupt("return",this.combineProtocolAndAppSnapshotTree(i,c));case 19:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"downloadSummary",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Not implemented yet");case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"setRootTree",value:function(e,t){this.commitCache.set(e,t)}},{key:"initBlobsCache",value:function(e){this.blobCache.addBlobs(e)}},{key:"readTree",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t,r){var n;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.commitCache.get(t)){e.next=5;break}return e.next=4,this.fetchTreeFromSnapshot(t,r);case 4:n=e.sent;case 5:return e.abrupt("return",null!==n&&void 0!==n?n:null);case 6:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"combineProtocolAndAppSnapshotTree",value:function(e,t){return{blobs:Object.assign({},e.blobs),trees:Object.assign(Object.assign({},e.trees),{".protocol":t})}}},{key:"initializeFromSnapshot",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._snapshotSequenceNumber=e.sequenceNumber;var r,n=e.snapshotTree,a=e.blobs,o=e.ops;return n&&(r=n.id,(0,w.h)(void 0!==r,545),this.setRootTree(r,n)),a&&this.initBlobsCache(a),t&&(this.ops=o),r}}]),e}(),He=function(e){(0,c.Z)(n,e);var t=(0,u.Z)(n);function n(e,r,a,o,s,c,u,h,l,p){var d;return(0,i.Z)(this,n),(d=t.call(this,(0,x.rZ)(a).config)).odspResolvedUrl=e,d.getStorageToken=r,d.logger=a,d.fetchFullSnapshot=o,d.cache=s,d.hostPolicy=c,d.epochTracker=u,d.flushCallback=h,d.relayServiceTenantAndSessionId=l,d.snapshotFormatFetchType=p,d.odspSummaryModuleLoaded=!1,d.firstVersionCall=!0,d.maxSnapshotSizeLimit=5e8,d.maxSnapshotFetchTimeout=12e4,d.createBlobRateLimiter=new D.p(1),d.documentId=d.odspResolvedUrl.hashedDocumentId,d.snapshotUrl=d.odspResolvedUrl.endpoints.snapshotStorageUrl,d.attachmentPOSTUrl=d.odspResolvedUrl.endpoints.attachmentPOSTStorageUrl,d.attachmentGETUrl=d.odspResolvedUrl.endpoints.attachmentGETStorageUrl,d}return(0,s.Z)(n,[{key:"createBlob",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t){var r,n=this;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.checkAttachmentPOSTUrl(),e.next=3,(0,E.PM)(function(){var e=(0,p.Z)((0,h.Z)().mark((function e(r){var a,o,s,i,c;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.getStorageToken(r,"CreateBlob");case 2:return o=e.sent,s=(0,X.y)("".concat(n.attachmentPOSTUrl,"/content"),o,!!(null===(a=n.hostPolicy.sessionOptions)||void 0===a?void 0:a.forceAccessTokenViaAuthorizationHeader)),i=s.url,(c=s.headers)["Content-Type"]="application/octet-stream",e.abrupt("return",d.Xr.timedExecAsync(n.logger,{eventName:"createBlob",size:t.byteLength,waitQueueLength:n.createBlobRateLimiter.waitQueueLength},function(){var e=(0,p.Z)((0,h.Z)().mark((function e(r){var a;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.createBlobRateLimiter.schedule((0,p.Z)((0,h.Z)().mark((function e(){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",n.epochTracker.fetchAndParseAsJSON(i,{body:t,headers:c,method:"POST"},"createBlob"));case 1:case"end":return e.stop()}}),e)}))));case 2:return a=e.sent,r.end(Object.assign({blobId:a.content.id},a.propsToLog)),e.abrupt("return",a);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 3:return r=e.sent,e.abrupt("return",r.content);case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchBlobFromStorage",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t,r){var n,a=this;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.checkAttachmentGETUrl(),e.next=3,(0,E.PM)(function(){var e=(0,p.Z)((0,h.Z)().mark((function e(n){var o,s,i,c,u,l;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a.getStorageToken(n,"GetBlob");case 2:return s=e.sent,i="".concat(a.attachmentGETUrl,"/").concat(encodeURIComponent(t),"/content"),c=(0,X.y)(i,s,!!(null===(o=a.hostPolicy.sessionOptions)||void 0===o?void 0:o.forceAccessTokenViaAuthorizationHeader)),u=c.url,l=c.headers,e.abrupt("return",d.Xr.timedExecAsync(a.logger,{eventName:"readDataBlob",blobId:t,evicted:r,headers:0!==Object.keys(l).length||void 0,waitQueueLength:a.epochTracker.rateLimiter.waitQueueLength},function(){var e=(0,p.Z)((0,h.Z)().mark((function e(r){var o,s;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a.epochTracker.fetchArray(u,{headers:l},"blob");case 2:return o=e.sent,r.end(Object.assign(Object.assign({waitQueueLength:a.epochTracker.rateLimiter.waitQueueLength},o.propsToLog),{attempts:n.refresh?2:1})),void 0!==(s=o.headers.get("cache-control"))&&(s.includes("private")||s.includes("public"))||a.logger.sendErrorEvent(Object.assign({eventName:"NonCacheableBlob",cacheControl:s,blobId:t},o.propsToLog)),e.abrupt("return",o.content);case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 3:return n=e.sent,this.blobCache.setBlob(t,n),e.abrupt("return",n);case 6:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"getSnapshotTree",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t,r){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.snapshotUrl){e.next=2;break}return e.abrupt("return",null);case 2:return e.abrupt("return",(0,B.Z)((0,L.Z)(n.prototype),"getSnapshotTree",this).call(this,t,r));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"getVersions",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t,r,n,o){var s,i,c,u=this;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t===this.documentId||!t){e.next=2;break}return e.abrupt("return",[{id:t,treeId:void 0}]);case 2:if(this.snapshotUrl){e.next=4;break}return e.abrupt("return",[]);case 4:if(1!==r||null!==t&&t!==this.documentId){e.next=12;break}return s=this.hostPolicy.snapshotOptions,e.next=8,d.Xr.timedExecAsync(this.logger,{eventName:"ObtainSnapshot",fetchSource:o},function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t){var r,i,c,l,d,f,v,b;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r={},l=I.S.now(),o!==a.noCache){e.next=9;break}return e.next=5,u.fetchSnapshot(s,n);case 5:i=e.sent,c="networkOnly",e.next=39;break;case 9:if(d=u.epochTracker.get((0,E.db)(u.odspResolvedUrl)).then(function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t){var n,a;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===t){e.next=10;break}if(a=Date.now()-(null!==(n=t.cacheEntryTime)&&void 0!==n?n:Date.now()-2592e6),!u.hostPolicy.summarizerClient){e.next=9;break}if(!(a>6e4)){e.next=8;break}return r.cacheSummarizerExpired=!0,e.abrupt("return",void 0);case 8:r.cacheSummarizerExpired=!1;case 9:r.cacheEntryAge=a;case 10:return e.abrupt("return",t);case 11:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),!u.firstVersionCall||!u.hostPolicy.concurrentSnapshotFetch||u.hostPolicy.summarizerClient){e.next=30;break}return f=u.fetchSnapshot(s,n),e.next=14,j([d.catch((function(){})),f.catch((function(){}))]);case 14:if(v=e.sent,i=v.value,c=0===v.index?"cache":"network",void 0!==i){e.next=28;break}if(1!==v.index){e.next=23;break}return e.next=21,d;case 21:i=e.sent,c="cache";case 23:if(void 0!==i){e.next=28;break}return e.next=26,f;case 26:i=e.sent,c="network";case 28:e.next=39;break;case 30:return e.next=32,d;case 32:if(i=e.sent,c=void 0!==i?"cache":"network",void 0!==i){e.next=39;break}return l=I.S.now(),e.next=38,u.fetchSnapshot(s,n);case 38:i=e.sent;case 39:return"network"===c&&(r.cacheEntryAge=void 0),b=i.prefetchStartTime,t.end(Object.assign(Object.assign(Object.assign(Object.assign({},r),{method:c,avoidPrefetchSnapshotCache:u.hostPolicy.avoidPrefetchSnapshotCache}),Me(i)),{prefetchSavedDuration:void 0!==b&&"cache"!==c?l-b:void 0})),e.abrupt("return",i);case 43:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 8:return i=e.sent,c=this.initializeFromSnapshot(i,this.firstVersionCall),this.firstVersionCall=!1,e.abrupt("return",c?[{id:c,treeId:void 0}]:[]);case 12:return e.abrupt("return",(0,E.PM)(function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t){var a,o,s,i,c,l,f;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,u.getStorageToken(t,"GetVersions");case 2:return o=e.sent,s=(0,X.y)("".concat(u.snapshotUrl,"/versions?top=").concat(r),o,!!(null===(a=u.hostPolicy.sessionOptions)||void 0===a?void 0:a.forceAccessTokenViaAuthorizationHeader)),i=s.url,c=s.headers,e.next=6,d.Xr.timedExecAsync(u.logger,{eventName:"getVersions",headers:0!==Object.keys(c).length||void 0},(0,p.Z)((0,h.Z)().mark((function e(){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",u.epochTracker.fetchAndParseAsJSON(i,{headers:c},"versions",void 0,n));case 1:case"end":return e.stop()}}),e)}))));case 6:if(l=e.sent,f=l.content){e.next=10;break}throw new F.V2("No response from /versions endpoint",A.C.genericNetworkError,{driverVersion:oe.Z});case 10:if(Array.isArray(f.value)){e.next=12;break}throw new F.V2("Incorrect response from /versions endpoint, expected an array",A.C.genericNetworkError,{driverVersion:oe.Z});case 12:return e.abrupt("return",f.value.map((function(e){return{id:e.id,treeId:void 0}})));case 13:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 13:case"end":return e.stop()}}),e,this)})));return function(t,r,n,a){return e.apply(this,arguments)}}()},{key:"fetchSnapshot",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t,r){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.fetchSnapshotCore(t,r).catch((function(e){throw"object"===typeof e&&null!==e&&(e.canRetry=!1),e})));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"fetchSnapshotCore",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t,r){var n,a,o,s,i,c,u,l,d,f,v,b,g,m,k=this;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hostPolicy.avoidPrefetchSnapshotCache){e.next=7;break}return i=(0,y.r)((0,E.db)(this.odspResolvedUrl)),e.next=4,null===(a=null===(n=this.cache.snapshotPrefetchResultCache)||void 0===n?void 0:n.get(i))||void 0===a?void 0:a.then(function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,k.epochTracker.validateEpoch(t.fluidEpoch,"treesLatest");case 2:return e.abrupt("return",t);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch(function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return k.logger.sendTelemetryEvent({eventName:"PrefetchSnapshotError",concurrentSnapshotFetch:k.hostPolicy.concurrentSnapshotFetch},t),e.abrupt("return",void 0);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 4:if(void 0===(c=e.sent)){e.next=7;break}return e.abrupt("return",c);case 7:return u=Object.assign(Object.assign({mds:this.maxSnapshotSizeLimit},t),{timeout:(null===t||void 0===t?void 0:t.timeout)?Math.min(t.timeout,this.maxSnapshotFetchTimeout):this.maxSnapshotFetchTimeout}),this.hostPolicy.summarizerClient&&(u.mds=void 0,u.timeout=void 0),l=function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t,n,a,o){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Fe(t,n,k.logger,a,k.snapshotFormatFetchType,o,k.epochTracker,r));case 1:case"end":return e.stop()}}),e)})));return function(t,r,n,a){return e.apply(this,arguments)}}(),d=function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",k.cache.persistedCache.put((0,E.db)(k.odspResolvedUrl),t.value));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),f=function(){var e=(0,p.Z)((0,h.Z)().mark((function e(){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",k.cache.persistedCache.removeEntries());case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),e.prev=12,e.next=15,Pe(this.odspResolvedUrl,this.getStorageToken,u,!!(null===(o=this.hostPolicy.sessionOptions)||void 0===o?void 0:o.forceAccessTokenViaAuthorizationHeader),this.logger,l,d,f,this.hostPolicy.enableRedeemFallback);case 15:return v=e.sent,e.abrupt("return",v);case 19:if(e.prev=19,e.t0=e.catch(12),(b=e.t0.errorType)!==z.x.snapshotTooBig||void 0===(null===t||void 0===t?void 0:t.mds)||!0===this.hostPolicy.summarizerClient){e.next=24;break}throw e.t0;case 24:if(b!==z.x.snapshotTooBig&&b!==z.x.fetchTimeout||!u.blobs){e.next=31;break}return this.logger.sendErrorEvent({eventName:"TreeLatest_SecondCall",errorType:b}),g=Object.assign(Object.assign({},u),{blobs:0,mds:void 0,timeout:void 0}),e.next=29,Pe(this.odspResolvedUrl,this.getStorageToken,g,!!(null===(s=this.hostPolicy.sessionOptions)||void 0===s?void 0:s.forceAccessTokenViaAuthorizationHeader),this.logger,l,d,f,this.hostPolicy.enableRedeemFallback);case 29:return m=e.sent,e.abrupt("return",m);case 31:throw e.t0;case 32:case"end":return e.stop()}}),e,this,[[12,19]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"uploadSummaryWithContext",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t,r){var n,a,o,s,i,c=this;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.checkSnapshotUrl(),void 0===this.summaryModuleP&&(this.summaryModuleP=this.getDelayLoadedSummaryManager()),!(".protocol"in t.tree)||void 0===r.ackHandle){e.next=19;break}a=1;case 4:return e.next=6,this.flushCallback();case 6:if(o=e.sent,!(void 0!==(s=o.lastPersistedSequenceNumber)&&s>=r.referenceSequenceNumber)){e.next=10;break}return e.abrupt("break",19);case 10:if(!(a>3)){e.next=13;break}return this.logger.sendErrorEvent(Object.assign(Object.assign({eventName:"FlushFailure"},o),{retry:a,referenceSequenceNumber:r.referenceSequenceNumber})),e.abrupt("break",19);case 13:return this.logger.sendPerformanceEvent(Object.assign(Object.assign({eventName:"FlushExtraCall"},o),{retry:a,referenceSequenceNumber:r.referenceSequenceNumber})),a++,e.next=17,(0,U.g)(1e3*(null!==(n=o.retryAfter)&&void 0!==n?n:1));case 17:e.next=4;break;case 19:if(this.odspSummaryUploadManager){e.next=23;break}return e.next=22,this.summaryModuleP.then(function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return c.odspSummaryModuleLoaded=!0,e.abrupt("return",t);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){throw c.odspSummaryModuleLoaded=!1,e}));case 22:this.odspSummaryUploadManager=e.sent;case 23:return(0,w.h)(void 0!==this.odspSummaryUploadManager,1390),e.next=26,this.odspSummaryUploadManager.writeSummaryTree(t,r);case 26:return i=e.sent,e.abrupt("return",i);case 28:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"getDelayLoadedSummaryManager",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(){var t,n,a=this;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(0,w.h)(!1===this.odspSummaryModuleLoaded,1391),e.next=3,r.e(7107).then(r.bind(r,21654)).then((function(e){return a.logger.sendTelemetryEvent({eventName:"SummaryModuleLoaded"}),e})).catch((function(e){throw a.logger.sendErrorEvent({eventName:"SummaryModuleLoadFailed"},e),e}));case 3:return n=e.sent,this.odspSummaryUploadManager=new n.OdspSummaryUploadManager(this.odspResolvedUrl.endpoints.snapshotStorageUrl,this.getStorageToken,this.logger,this.epochTracker,!!(null===(t=this.hostPolicy.sessionOptions)||void 0===t?void 0:t.forceAccessTokenViaAuthorizationHeader),this.relayServiceTenantAndSessionId),e.abrupt("return",this.odspSummaryUploadManager);case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"checkSnapshotUrl",value:function(){if(!this.snapshotUrl)throw new F.V2("Method failed because no snapshot url was available",A.C.genericError,{driverVersion:oe.Z})}},{key:"checkAttachmentPOSTUrl",value:function(){if(!this.attachmentPOSTUrl)throw new F.V2("Method failed because no attachment POST url was available",A.C.genericError,{driverVersion:oe.Z})}},{key:"checkAttachmentGETUrl",value:function(){if(!this.attachmentGETUrl)throw new F.V2("Method failed because no attachment GET url was available",A.C.genericError,{driverVersion:oe.Z})}},{key:"fetchTreeFromSnapshot",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t,r){var n=this;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,E.PM)(function(){var e=(0,p.Z)((0,h.Z)().mark((function e(a){var o,s,i,c,u,l;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.getStorageToken(a,"ReadCommit");case 2:return i=e.sent,c=function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t,a){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",n.epochTracker.fetchAndParseAsJSON(t,a,"snapshotTree",void 0,r));case 1:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),e.next=6,Ee(n.snapshotUrl,i,t,n.fetchFullSnapshot,!!(null===(o=n.hostPolicy.sessionOptions)||void 0===o?void 0:o.forceAccessTokenViaAuthorizationHeader),n.logger,c);case 6:return u=e.sent,l="",u.snapshotTree&&((0,w.h)(void 0!==u.snapshotTree.id,546),l=u.snapshotTree.id,n.setRootTree(l,u.snapshotTree)),u.blobs&&n.initBlobsCache(u.blobs),e.abrupt("return",null!==(s=n.commitCache.get(t))&&void 0!==s?s:n.commitCache.get(l));case 11:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}()}]),n}(We),Ge=r(84693),Je=function(){function e(t,r,n,a,o,s){(0,i.Z)(this,e),this.logger=r,this.cache=n,this.batchSize=a,this.timerGranularity=o,this.totalOpsToCache=s,this.batches=new Map;var c=this.batchSize-this.getPositionInBatchArray(t)-1;0!==c&&this.batches.set(this.getBatchNumber(t),{remainingSlots:c,batchData:this.initializeNewBatchDataArray(),dirty:!1})}return(0,s.Z)(e,[{key:"dispose",value:function(){this.batches.clear(),void 0!==this.timer&&(clearTimeout(this.timer),this.timer=void 0)}},{key:"flushOps",value:function(){var e,t=(0,q.Z)(this.batches);try{for(t.s();!(e=t.n()).done;){var r=(0,l.Z)(e.value,2),n=r[0],a=r[1];null!==a&&a.dirty&&(a.dirty=!1,this.write(n,a))}}catch(o){t.e(o)}finally{t.f()}}},{key:"addOps",value:function(e){if(!(this.totalOpsToCache<=0)){var t,r=(0,q.Z)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value,a=this.getBatchNumber(n.sequenceNumber),o=this.getPositionInBatchArray(n.sequenceNumber),s=this.batches.get(a);if(void 0===s)(s={remainingSlots:this.batchSize-1,batchData:this.initializeNewBatchDataArray(),dirty:!0}).batchData[o]=n,this.batches.set(a,s);else{if(null===s||void 0!==s.batchData[o])return;s.batchData[o]=n,s.remainingSlots--,s.dirty=!0}if(0===s.remainingSlots?(this.write(a,s),this.batches.set(a,null)):this.scheduleTimer(),this.totalOpsToCache--,0===this.totalOpsToCache){this.logger.sendPerformanceEvent({eventName:"CacheOpsLimitHit"}),this.cache.remove(),this.dispose();break}}}catch(i){r.e(i)}finally{r.f()}}}},{key:"getCore",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t,r){var n,a,o,s,i,c,u;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=[],a=this.getBatchNumber(t);case 2:return e.next=5,this.cache.read("".concat(this.batchSize,"_").concat(a));case 5:if(void 0!==(o=e.sent)){e.next=8;break}return e.abrupt("return",n);case 8:s=JSON.parse(o),i=(0,q.Z)(s),e.prev=10,i.s();case 12:if((c=i.n()).done){e.next=31;break}if(!(u=c.value)){e.next=27;break}if(!(void 0!==r&&u.sequenceNumber>=r)){e.next=17;break}return e.abrupt("return",n);case 17:if(0!==n.length){e.next=24;break}if(!(u.sequenceNumber>t)){e.next=22;break}return e.abrupt("return",n);case 22:if(!(u.sequenceNumber<t)){e.next=24;break}return e.abrupt("continue",29);case 24:n.push(u),e.next=29;break;case 27:if(0===n.length){e.next=29;break}return e.abrupt("return",n);case 29:e.next=12;break;case 31:e.next=36;break;case 33:e.prev=33,e.t0=e.catch(10),i.e(e.t0);case 36:return e.prev=36,i.f(),e.finish(36);case 39:a++,e.next=2;break;case 42:case"end":return e.stop()}}),e,this,[[10,33,36,39]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"get",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t,r){var n,a,o;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=I.S.now(),e.next=3,this.getCore(t,r);case 3:return a=e.sent,o=I.S.now()-n,(a.length>0||o>1e3)&&this.logger.sendPerformanceEvent({eventName:"CacheOpsUsed",from:t,to:r,length:a.length,duration:o}),e.abrupt("return",a);case 7:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"write",value:function(e,t){var r=this;this.cache.write("".concat(this.batchSize,"_").concat(e),JSON.stringify(t.batchData)).catch((function(){r.totalOpsToCache=0}))}},{key:"scheduleTimer",value:function(){var e=this;!this.timer&&this.timerGranularity>0&&(this.timer=setTimeout((function(){e.timer=void 0,e.flushOps()}),this.timerGranularity))}},{key:"getBatchNumber",value:function(e){return Math.floor(e/this.batchSize)}},{key:"getPositionInBatchArray",value:function(e){return e%this.batchSize}},{key:"initializeNewBatchDataArray",value:function(){var e=[];return e.length=this.batchSize,e}}]),e}(),Xe=r(42874),Qe=function(){function e(t,r){(0,i.Z)(this,e),this.internalStorageService=t,this.logger=r,this._disposed=!1}return(0,s.Z)(e,[{key:"policies",get:function(){return this.internalStorageService.policies}},{key:"disposed",get:function(){return this._disposed}},{key:"dispose",value:function(){this._disposed=!0}},{key:"repositoryUrl",get:function(){return this.internalStorageService.repositoryUrl}},{key:"getSnapshotTree",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t){var r=this;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.runWithRetry((0,p.Z)((0,h.Z)().mark((function e(){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",r.internalStorageService.getSnapshotTree(t));case 1:case"end":return e.stop()}}),e)}))),"storage_getSnapshotTree"));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"readBlob",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t){var r=this;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.runWithRetry((0,p.Z)((0,h.Z)().mark((function e(){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",r.internalStorageService.readBlob(t));case 1:case"end":return e.stop()}}),e)}))),"storage_readBlob"));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getVersions",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t,r,n,a){var o=this;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.runWithRetry((0,p.Z)((0,h.Z)().mark((function e(){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",o.internalStorageService.getVersions(t,r,n,a));case 1:case"end":return e.stop()}}),e)}))),"storage_getVersions"));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r,n,a){return e.apply(this,arguments)}}()},{key:"uploadSummaryWithContext",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t,r){var n=this;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.runWithRetry((0,p.Z)((0,h.Z)().mark((function e(){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",n.internalStorageService.uploadSummaryWithContext(t,r));case 1:case"end":return e.stop()}}),e)}))),"storage_uploadSummaryWithContext"));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"downloadSummary",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t){var r=this;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.runWithRetry((0,p.Z)((0,h.Z)().mark((function e(){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",r.internalStorageService.downloadSummary(t));case 1:case"end":return e.stop()}}),e)}))),"storage_downloadSummary"));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"createBlob",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t){var r=this;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.runWithRetry((0,p.Z)((0,h.Z)().mark((function e(){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",r.internalStorageService.createBlob(t));case 1:case"end":return e.stop()}}),e)}))),"storage_createBlob"));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"checkStorageDisposed",value:function(){if(this._disposed)throw new W.j4("Storage Service is disposed. Cannot retry",{canRetry:!1})}},{key:"runWithRetry",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t,r){var n=this;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,Xe.k)(t,r,this.logger,(function(){return n.checkStorageDisposed()})));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()}]),e}(),Ke=function(){function e(t,r,n,a,o,s,c,u,h){(0,i.Z)(this,e),this.odspResolvedUrl=t,this.getStorageToken=r,this.getWebsocketToken=n,this.cache=o,this.epochTracker=c,this.socketReferenceKeyPrefix=u,this.clientIsSummarizer=h,this.odspSocketModuleLoaded=!1,this._policies={storageOnly:void 0!==t.fileVersion,summarizeProtocolTree:!0},this.mc=(0,x.rZ)(d.G2.create(a,void 0,{all:{odc:(0,Ge.Is)(new URL(this.odspResolvedUrl.endpoints.snapshotStorageUrl).origin)}})),this.hostPolicy=s,this.clientIsSummarizer&&(this.hostPolicy=Object.assign(Object.assign({},this.hostPolicy),{summarizerClient:!0}))}return(0,s.Z)(e,[{key:"resolvedUrl",get:function(){return this.odspResolvedUrl}},{key:"policies",get:function(){return this._policies}},{key:"connectToStorage",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(){var t=this;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.storageManager||(this.storageManager=new He(this.odspResolvedUrl,this.getStorageToken,this.mc.logger,!0,this.cache,this.hostPolicy,this.epochTracker,(0,p.Z)((0,h.Z)().mark((function e(){var r,n;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===(n=null===(r=t.odspDelayLoadedDeltaStream)||void 0===r?void 0:r.currentDeltaConnection)||n.disposed){e.next=3;break}return e.abrupt("return",n.flush());case 3:throw new Error("Disconnected while uploading summary (attempt to perform flush())");case 4:case"end":return e.stop()}}),e)}))),(function(){var e;return null===(e=t.odspDelayLoadedDeltaStream)||void 0===e?void 0:e.relayServiceTenantAndSessionId}),this.mc.config.getNumber("Fluid.Driver.Odsp.snapshotFormatFetchType"))),e.abrupt("return",new Qe(this.storageManager,this.mc.logger));case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"connectToDeltaStorage",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(){var t,r,n,a,o,s,i,c,u=this;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=null!==(r=null===(t=this.storageManager)||void 0===t?void 0:t.ops)&&void 0!==r?r:[],s=new N(this.odspResolvedUrl.endpoints.deltaStorageUrl,this.getStorageToken,this.epochTracker,this.mc.logger),i=null!==(n=this.hostPolicy.opsBatchSize)&&void 0!==n?n:5e3,c=null!==(a=this.hostPolicy.concurrentOpsBatches)&&void 0!==a?a:1,e.abrupt("return",new P(o,this.mc.logger,i,c,function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t,r,n,a){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",s.get(t,r,n,a));case 1:case"end":return e.stop()}}),e)})));return function(t,r,n,a){return e.apply(this,arguments)}}(),function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t,r){var n,a,o;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,null===(n=u.opsCache)||void 0===n?void 0:n.get(t,r);case 2:return o=e.sent,e.abrupt("return",null!==(a=o)&&void 0!==a?a:[]);case 4:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),(function(e,t){var r,n=null===(r=u.odspDelayLoadedDeltaStream)||void 0===r?void 0:r.currentDeltaConnection;void 0===n||n.disposed||n.requestOps(e,t)}),(function(e){return u.opsReceived(e)})));case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"connectToDeltaStream",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t){var r=this;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===this.socketModuleP&&(this.socketModuleP=this.getDelayLoadedDeltaStream()),e.abrupt("return",this.socketModuleP.then(function(){var e=(0,p.Z)((0,h.Z)().mark((function e(n){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r.odspSocketModuleLoaded=!0,e.abrupt("return",n.connectToDeltaStream(t));case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){throw r.socketModuleP=void 0,r.odspSocketModuleLoaded=!1,e})));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getDelayLoadedDeltaStream",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(){var t,n=this;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(0,w.h)(!1===this.odspSocketModuleLoaded,1287),e.next=3,r.e(9339).then(r.bind(r,12966)).then((function(e){return n.mc.logger.sendTelemetryEvent({eventName:"SocketModuleLoaded"}),e})).catch((function(e){throw n.mc.logger.sendErrorEvent({eventName:"SocketModuleLoadFailed"},e),e}));case 3:return t=e.sent,this.odspDelayLoadedDeltaStream=new t.OdspDelayLoadedDeltaStream(this.odspResolvedUrl,this._policies,this.getStorageToken,this.getWebsocketToken,this.mc,this.cache,this.hostPolicy,this.epochTracker,(function(e){return n.opsReceived(e)}),this.socketReferenceKeyPrefix),e.abrupt("return",this.odspDelayLoadedDeltaStream);case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"dispose",value:function(e){var t,r,n;void 0!==e?this.epochTracker.removeEntries().catch((function(){})):null===(t=this._opsCache)||void 0===t||t.flushOps(),null===(r=this._opsCache)||void 0===r||r.dispose(),null===(n=this.odspDelayLoadedDeltaStream)||void 0===n||n.dispose()}},{key:"opsCache",get:function(){var e,t,r,n,a,o,s,i=this;if(this._opsCache)return this._opsCache;var c=null===(e=this.storageManager)||void 0===e?void 0:e.snapshotSequenceNumber,u=null!==(r=null===(t=this.hostPolicy.opsCaching)||void 0===t?void 0:t.batchSize)&&void 0!==r?r:100;if(!(void 0===c||u<1)){var l={type:"ops"};return this._opsCache=new Je(c,this.mc.logger,{write:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t,r){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",i.cache.persistedCache.put(Object.assign(Object.assign({},l),{key:t}),r));case 1:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),read:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",i.cache.persistedCache.get(Object.assign(Object.assign({},l),{key:t})));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),remove:function(){i.cache.persistedCache.removeEntries().catch((function(){}))}},u,null!==(a=null===(n=this.hostPolicy.opsCaching)||void 0===n?void 0:n.timerGranularity)&&void 0!==a?a:5e3,null!==(s=null===(o=this.hostPolicy.opsCaching)||void 0===o?void 0:o.totalOpsToCache)&&void 0!==s?s:5e3),this._opsCache}}},{key:"opsReceived",value:function(e){var t;0===e.length||this.odspResolvedUrl.summarizer||null===(t=this.opsCache)||void 0===t||t.addOps(e)}}],[{key:"create",value:function(){var t=(0,p.Z)((0,h.Z)().mark((function t(r,n,a,o,s,i,c,u,l){return(0,h.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",new e((0,E.r8)(r),n,a,o,s,i,c,u,l));case 1:case"end":return t.stop()}}),t)})));return function(e,r,n,a,o,s,i,c,u){return t.apply(this,arguments)}}()}]),e}(),$e=function(){function e(t,r){var n,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new k,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};(0,i.Z)(this,e),this.getStorageToken=t,this.getWebsocketToken=r,this.persistedCache=a,this.hostPolicy=o,this.nonPersistentCache=new S,!0===this.hostPolicy.isolateSocketCache&&(this.socketReferenceKeyPrefix=(0,g.Z)()),this.hostPolicy.enableRedeemFallback=null===(n=this.hostPolicy.enableRedeemFallback)||void 0===n||n,this.hostPolicy.sessionOptions=Object.assign({forceAccessTokenViaAuthorizationHeader:!0},this.hostPolicy.sessionOptions)}return(0,s.Z)(e,[{key:"snapshotPrefetchResultCache",get:function(){return this.nonPersistentCache.snapshotPrefetchResultCache}},{key:"createContainer",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t,n,a,o){var s,i,c,u,b,g,m,y,k,S,w,x,T,C=this;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((0,f.$)(n),s=(0,E.r8)(n),i={siteUrl:s.siteUrl,driveId:s.driveId,itemId:s.itemId},!s.itemId){e.next=7;break}c={type:"Existing",driveId:s.driveId,siteUrl:s.siteUrl,itemId:s.itemId},e.next=18;break;case 7:if(!s.fileName){e.next=17;break}if(b=s.url.split("?"),g=(0,l.Z)(b,2),m=g[1],y=new URLSearchParams(m),void 0!==(k=y.get("path"))&&null!==k){e.next=13;break}throw new Error("File path should be provided!!");case 13:u=Ye(this.hostPolicy,y),c={type:"New",driveId:s.driveId,siteUrl:s.siteUrl,filePath:k,filename:s.fileName,createLinkType:u},e.next=18;break;case 17:throw new Error("A new or existing file must be specified to create container!");case 18:if(!(0,v.F2)(t)){e.next=22;break}if(0===(null===(S=(0,v.yK)(t.tree[".protocol"]))||void 0===S?void 0:S.sequenceNumber)){e.next=22;break}throw new Error("Seq number in detached ODSP container should be 0");case 22:return w=(0,E.Wt)(a),x={resolvedUrl:s,docId:s.hashedDocumentId},T=(0,Z.TU)(this.persistedCache,this.nonPersistentCache,x,w,o),e.abrupt("return",d.Xr.timedExecAsync(w,{eventName:"CreateNew",isWithSummaryUpload:!0,createShareLinkParam:u?JSON.stringify(u):void 0,enableShareLinkWithCreate:this.hostPolicy.enableShareLinkWithCreate,enableSingleRequestForShareLinkWithCreate:this.hostPolicy.enableSingleRequestForShareLinkWithCreate},function(){var e=(0,p.Z)((0,h.Z)().mark((function e(n){var a,u,l,p,d,f,v;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return d=(0,E.zZ)(w,i,C.getStorageToken,!0),e.next=3,r.e(3119).then(r.bind(r,30260)).then((function(e){return w.sendTelemetryEvent({eventName:"createNewModuleLoaded"}),e})).catch((function(e){throw w.sendErrorEvent({eventName:"createNewModuleLoadFailed"},e),e}));case 3:if(f=e.sent,!(0,E.zs)(c)){e.next=10;break}return e.next=7,f.createNewFluidFile(d,c,w,t,T.epochTracker,x,null===(a=C.hostPolicy.cacheCreateNewSummary)||void 0===a||a,!!(null===(u=C.hostPolicy.sessionOptions)||void 0===u?void 0:u.forceAccessTokenViaAuthorizationHeader),s.isClpCompliantApp,C.hostPolicy.enableSingleRequestForShareLinkWithCreate,C.hostPolicy.enableShareLinkWithCreate);case 7:e.t0=e.sent,e.next=13;break;case 10:return e.next=12,f.createNewContainerOnExistingFile(d,c,w,t,T.epochTracker,x,null===(l=C.hostPolicy.cacheCreateNewSummary)||void 0===l||l,!!(null===(p=C.hostPolicy.sessionOptions)||void 0===p?void 0:p.forceAccessTokenViaAuthorizationHeader),s.isClpCompliantApp);case 12:e.t0=e.sent;case 13:return s=e.t0,v=C.createDocumentServiceCore(s,w,T,o),n.end({docId:s.hashedDocumentId}),e.abrupt("return",v);case 17:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 26:case"end":return e.stop()}}),e,this)})));return function(t,r,n,a){return e.apply(this,arguments)}}()},{key:"createDocumentService",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t,r,n){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.createDocumentServiceCore(t,(0,E.Wt)(r),void 0,n));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"createDocumentServiceCore",value:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t,r,n,a){var o,s,i,c,u,l=this;return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=(0,E.r8)(t),s={siteUrl:o.siteUrl,driveId:o.driveId,itemId:o.itemId},i=null!==n&&void 0!==n?n:(0,Z.TU)(this.persistedCache,this.nonPersistentCache,{resolvedUrl:o,docId:o.hashedDocumentId},r,a),c=(0,E.zZ)(r,s,this.getStorageToken,!0),u=void 0===this.getWebsocketToken?void 0:function(){var e=(0,p.Z)((0,h.Z)().mark((function e(t){return(0,h.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,E.zZ)(r,s,l.getWebsocketToken,!1)(t,"GetWebsocketToken"));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),e.abrupt("return",Ke.create(t,c,u,r,i.cache,this.hostPolicy,i.epochTracker,this.socketReferenceKeyPrefix,a));case 6:case"end":return e.stop()}}),e,this)})));return function(t,r,n,a){return e.apply(this,arguments)}}()}]),e}();function Ye(e,t){var r;if(e.enableSingleRequestForShareLinkWithCreate){var n=t.get("createLinkScope"),a=t.get("createLinkRole");n&&b.h$[n]&&(r=Object.assign({scope:b.h$[n]},a&&b.gh[a]?{role:b.gh[a]}:{}))}else if(e.enableShareLinkWithCreate){var o=t.get("createLinkType");o&&b.SA[o]&&(r=b.SA[o||""])}return r}var et=function(e){(0,c.Z)(r,e);var t=(0,u.Z)(r);function r(e,n,a,o){return(0,i.Z)(this,r),t.call(this,e,n,a,o)}return(0,s.Z)(r)}($e);var tt=r(90704),rt=r(5324);var nt=["https://pushchannel.1drv.ms/pushchannel.readwrite.all"];function at(){return nt}function ot(e,t,r,n,a){var s=(0,o.Z)({},n);return!1!==s.concurrentSnapshotFetch&&(s.concurrentSnapshotFetch=!0),new et(st((function(r){return e.getToken((0,tt.O)(r.siteUrl),(0,rt.c)(r,t))})),e.identityType&&["Consumer","UnauthenticatedGuest"].includes(e.identityType)?void 0:st((function(r){return e.getToken(at(),(0,rt.c)(r,t))})),r,s)}function st(e){return function(){return e.apply(void 0,arguments).then((function(e){return e||null}))}}var it=r(45593);function ct(e,t,r,n,a,o,s){return{documentServiceFactory:ot(e,t,r,n),urlResolver:(0,it.n)(e,t,a,s)}}}}]);
//# sourceMappingURL=6732.8ccea83d.chunk.js.map