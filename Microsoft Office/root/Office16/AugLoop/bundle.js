"use strict";(()=>{var ex=Object.create;var lu=Object.defineProperty;var tx=Object.getOwnPropertyDescriptor;var nx=Object.getOwnPropertyNames;var rx=Object.getPrototypeOf,ox=Object.prototype.hasOwnProperty;var su=(n,o)=>{if(o=Symbol[n])return o;throw Error("Symbol."+n+" is not defined")};var ix=(n,o)=>()=>(n&&(o=n(n=0)),o);var Z=(n,o)=>()=>(o||n((o={exports:{}}).exports,o),o.exports),ax=(n,o)=>{for(var e in o)lu(n,e,{get:o[e],enumerable:!0})},uu=(n,o,e,r)=>{if(o&&typeof o=="object"||typeof o=="function")for(let t of nx(o))!ox.call(n,t)&&t!==e&&lu(n,t,{get:()=>o[t],enumerable:!(r=tx(o,t))||r.enumerable});return n},kn=(n,o,e)=>(uu(n,o,"default"),e&&uu(e,o,"default")),w=(n,o,e)=>(e=n!=null?ex(rx(n)):{},uu(o||!n||!n.__esModule?lu(e,"default",{value:n,enumerable:!0}):e,n));var sx=function(n,o){this[0]=n,this[1]=o};var Ar=n=>{var o=n[su("asyncIterator")],e=!1,r,t={};return o==null?(o=n[su("iterator")](),r=a=>t[a]=s=>o[a](s)):(o=o.call(n),r=a=>t[a]=s=>{if(e){if(e=!1,a==="throw")throw s;return s}return e=!0,{done:!1,value:new sx(new Promise(u=>{var l=o[a](s);if(!(l instanceof Object))throw TypeError("Object expected");u(l)}),1)}}),t[su("iterator")]=()=>t,r("next"),"throw"in o?r("throw"):t.throw=a=>{throw a},"return"in o&&r("return"),t};var Cd=Z((exports,module)=>{g();if(exports.__platformBundles!==void 0)for(platformBundles=exports.__platformBundles.concat(),Reflect.deleteProperty(exports,"__platformBundles"),i=0;i<platformBundles.length;++i)console.log("PB start "+(i+1)+"/"+platformBundles.length),eval(platformBundles[i]),console.log("PB done  "+(i+1)+"/"+platformBundles.length);var platformBundles,i});var global,g=ix(()=>{global=new Function("return this;")();Cd()});var Td=Z((bM,xd)=>{g();xd.exports=OfficePlatformGlobal.ReactNativeReka});var _d=Z((EM,Id)=>{g();Id.exports=OfficePlatformGlobal.Reka});var Md=Z((BM,Ho)=>{g();function fx(n){if(Array.isArray(n))return n}Ho.exports=fx,Ho.exports.__esModule=!0,Ho.exports.default=Ho.exports});var Ed=Z((OM,zo)=>{g();function cx(n,o){var e=n==null?null:typeof Symbol!="undefined"&&n[Symbol.iterator]||n["@@iterator"];if(e!=null){var r,t,a,s,u=[],l=!0,f=!1;try{if(a=(e=e.call(n)).next,o===0){if(Object(e)!==e)return;l=!1}else for(;!(l=(r=a.call(e)).done)&&(u.push(r.value),u.length!==o);l=!0);}catch(c){f=!0,t=c}finally{try{if(!l&&e.return!=null&&(s=e.return(),Object(s)!==s))return}finally{if(f)throw t}}return u}}zo.exports=cx,zo.exports.__esModule=!0,zo.exports.default=zo.exports});var fu=Z((FM,Vo)=>{g();function dx(n,o){(o==null||o>n.length)&&(o=n.length);for(var e=0,r=new Array(o);e<o;e++)r[e]=n[e];return r}Vo.exports=dx,Vo.exports.__esModule=!0,Vo.exports.default=Vo.exports});var cu=Z((GM,Qo)=>{g();var Rd=fu();function px(n,o){if(n){if(typeof n=="string")return Rd(n,o);var e=Object.prototype.toString.call(n).slice(8,-1);if(e==="Object"&&n.constructor&&(e=n.constructor.name),e==="Map"||e==="Set")return Array.from(n);if(e==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e))return Rd(n,o)}}Qo.exports=px,Qo.exports.__esModule=!0,Qo.exports.default=Qo.exports});var Nd=Z((HM,jo)=>{g();function hx(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}jo.exports=hx,jo.exports.__esModule=!0,jo.exports.default=jo.exports});var Ye=Z((VM,Jo)=>{g();var gx=Md(),mx=Ed(),vx=cu(),yx=Nd();function kx(n,o){return gx(n)||mx(n,o)||vx(n,o)||yx()}Jo.exports=kx,Jo.exports.__esModule=!0,Jo.exports.default=Jo.exports});var W=Z((XM,Ko)=>{g();function wx(n,o){if(!(n instanceof o))throw new TypeError("Cannot call a class as a function")}Ko.exports=wx,Ko.exports.__esModule=!0,Ko.exports.default=Ko.exports});var ka=Z((ZM,Wn)=>{g();function du(n){"@babel/helpers - typeof";return Wn.exports=du=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(o){return typeof o}:function(o){return o&&typeof Symbol=="function"&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o},Wn.exports.__esModule=!0,Wn.exports.default=Wn.exports,du(n)}Wn.exports=du,Wn.exports.__esModule=!0,Wn.exports.default=Wn.exports});var Od=Z((tE,$o)=>{g();var Pd=ka().default;function Sx(n,o){if(Pd(n)!=="object"||n===null)return n;var e=n[Symbol.toPrimitive];if(e!==void 0){var r=e.call(n,o||"default");if(Pd(r)!=="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(o==="string"?String:Number)(n)}$o.exports=Sx,$o.exports.__esModule=!0,$o.exports.default=$o.exports});var pu=Z((rE,Xo)=>{g();var Cx=ka().default,xx=Od();function Tx(n){var o=xx(n,"string");return Cx(o)==="symbol"?o:String(o)}Xo.exports=Tx,Xo.exports.__esModule=!0,Xo.exports.default=Xo.exports});var B=Z((iE,Yo)=>{g();var Ix=pu();function Ld(n,o){for(var e=0;e<o.length;e++){var r=o[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(n,Ix(r.key),r)}}function _x(n,o,e){return o&&Ld(n.prototype,o),e&&Ld(n,e),Object.defineProperty(n,"prototype",{writable:!1}),n}Yo.exports=_x,Yo.exports.__esModule=!0,Yo.exports.default=Yo.exports});var Ud=Z((pE,ei)=>{g();var Ax=fu();function bx(n){if(Array.isArray(n))return Ax(n)}ei.exports=bx,ei.exports.__esModule=!0,ei.exports.default=ei.exports});var Hd=Z((gE,ti)=>{g();function Mx(n){if(typeof Symbol!="undefined"&&n[Symbol.iterator]!=null||n["@@iterator"]!=null)return Array.from(n)}ti.exports=Mx,ti.exports.__esModule=!0,ti.exports.default=ti.exports});var zd=Z((vE,ni)=>{g();function Ex(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}ni.exports=Ex,ni.exports.__esModule=!0,ni.exports.default=ni.exports});var Ie=Z((kE,ri)=>{g();var Rx=Ud(),Nx=Hd(),Dx=cu(),Wx=zd();function Bx(n){return Rx(n)||Nx(n)||Dx(n)||Wx()}ri.exports=Bx,ri.exports.__esModule=!0,ri.exports.default=ri.exports});var wa=Z((h0,qn)=>{g();function Bu(n,o){return qn.exports=Bu=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(r,t){return r.__proto__=t,r},qn.exports.__esModule=!0,qn.exports.default=qn.exports,Bu(n,o)}qn.exports=Bu,qn.exports.__esModule=!0,qn.exports.default=qn.exports});var qe=Z((m0,ui)=>{g();var Px=wa();function Ox(n,o){if(typeof o!="function"&&o!==null)throw new TypeError("Super expression must either be null or a function");n.prototype=Object.create(o&&o.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),Object.defineProperty(n,"prototype",{writable:!1}),o&&Px(n,o)}ui.exports=Ox,ui.exports.__esModule=!0,ui.exports.default=ui.exports});var Dr=Z((y0,li)=>{g();function Lx(n){if(n===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return n}li.exports=Lx,li.exports.__esModule=!0,li.exports.default=li.exports});var Ge=Z((w0,fi)=>{g();var Fx=ka().default,qx=Dr();function Gx(n,o){if(o&&(Fx(o)==="object"||typeof o=="function"))return o;if(o!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return qx(n)}fi.exports=Gx,fi.exports.__esModule=!0,fi.exports.default=fi.exports});var De=Z((C0,Gn)=>{g();function Pu(n){return Gn.exports=Pu=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},Gn.exports.__esModule=!0,Gn.exports.default=Gn.exports,Pu(n)}Gn.exports=Pu,Gn.exports.__esModule=!0,Gn.exports.default=Gn.exports});var Kd=Z((T0,ci)=>{g();function Ux(n){return Function.toString.call(n).indexOf("[native code]")!==-1}ci.exports=Ux,ci.exports.__esModule=!0,ci.exports.default=ci.exports});var $d=Z((_0,di)=>{g();function Hx(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}di.exports=Hx,di.exports.__esModule=!0,di.exports.default=di.exports});var Xd=Z((b0,Ut)=>{g();var zx=wa(),Vx=$d();function Sa(n,o,e){return Vx()?(Ut.exports=Sa=Reflect.construct.bind(),Ut.exports.__esModule=!0,Ut.exports.default=Ut.exports):(Ut.exports=Sa=function(t,a,s){var u=[null];u.push.apply(u,a);var l=Function.bind.apply(t,u),f=new l;return s&&zx(f,s.prototype),f},Ut.exports.__esModule=!0,Ut.exports.default=Ut.exports),Sa.apply(null,arguments)}Ut.exports=Sa,Ut.exports.__esModule=!0,Ut.exports.default=Ut.exports});var Lu=Z((E0,Un)=>{g();var Qx=De(),jx=wa(),Jx=Kd(),Kx=Xd();function Ou(n){var o=typeof Map=="function"?new Map:void 0;return Un.exports=Ou=function(r){if(r===null||!Jx(r))return r;if(typeof r!="function")throw new TypeError("Super expression must either be null or a function");if(typeof o!="undefined"){if(o.has(r))return o.get(r);o.set(r,t)}function t(){return Kx(r,arguments,Qx(this).constructor)}return t.prototype=Object.create(r.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),jx(t,r)},Un.exports.__esModule=!0,Un.exports.default=Un.exports,Ou(n)}Un.exports=Ou,Un.exports.__esModule=!0,Un.exports.default=Un.exports});var ol=Z((vN,Lr)=>{g();Lr.exports=global.fetch;Lr.exports.default=global.fetch;Lr.exports.fetch=global.fetch;Lr.exports.Headers=global.Headers;Lr.exports.Request=global.Request;Lr.exports.Response=global.Response});var Xp=Z((EN,$p)=>{g();var To=null;typeof WebSocket!="undefined"?To=WebSocket:typeof MozWebSocket!="undefined"?To=MozWebSocket:typeof global!="undefined"?To=global.WebSocket||global.MozWebSocket:typeof window!="undefined"?To=window.WebSocket||window.MozWebSocket:typeof self!="undefined"&&(To=self.WebSocket||self.MozWebSocket);$p.exports=To});var Ci=Z((NN,Yp)=>{"use strict";g();Yp.exports=function n(o,e){if(o===e)return!0;if(o&&e&&typeof o=="object"&&typeof e=="object"){if(o.constructor!==e.constructor)return!1;var r,t,a;if(Array.isArray(o)){if(r=o.length,r!=e.length)return!1;for(t=r;t--!==0;)if(!n(o[t],e[t]))return!1;return!0}if(o.constructor===RegExp)return o.source===e.source&&o.flags===e.flags;if(o.valueOf!==Object.prototype.valueOf)return o.valueOf()===e.valueOf();if(o.toString!==Object.prototype.toString)return o.toString()===e.toString();if(a=Object.keys(o),r=a.length,r!==Object.keys(e).length)return!1;for(t=r;t--!==0;)if(!Object.prototype.hasOwnProperty.call(e,a[t]))return!1;for(t=r;t--!==0;){var s=a[t];if(!n(o[s],e[s]))return!1}return!0}return o!==o&&e!==e}});var Pa=Z((zN,xi)=>{g();var AT=pu();function bT(n,o,e){return o=AT(o),o in n?Object.defineProperty(n,o,{value:e,enumerable:!0,configurable:!0,writable:!0}):n[o]=e,n}xi.exports=bT,xi.exports.__esModule=!0,xi.exports.default=xi.exports});var Jn=Z((iD,Cl)=>{"use strict";g();var RT=Object.prototype.hasOwnProperty,Rt="~";function Ni(){}Object.create&&(Ni.prototype=Object.create(null),new Ni().__proto__||(Rt=!1));function NT(n,o,e){this.fn=n,this.context=o,this.once=e||!1}function dh(n,o,e,r,t){if(typeof e!="function")throw new TypeError("The listener must be a function");var a=new NT(e,r||n,t),s=Rt?Rt+o:o;return n._events[s]?n._events[s].fn?n._events[s]=[n._events[s],a]:n._events[s].push(a):(n._events[s]=a,n._eventsCount++),n}function La(n,o){--n._eventsCount===0?n._events=new Ni:delete n._events[o]}function St(){this._events=new Ni,this._eventsCount=0}St.prototype.eventNames=function(){var o=[],e,r;if(this._eventsCount===0)return o;for(r in e=this._events)RT.call(e,r)&&o.push(Rt?r.slice(1):r);return Object.getOwnPropertySymbols?o.concat(Object.getOwnPropertySymbols(e)):o};St.prototype.listeners=function(o){var e=Rt?Rt+o:o,r=this._events[e];if(!r)return[];if(r.fn)return[r.fn];for(var t=0,a=r.length,s=new Array(a);t<a;t++)s[t]=r[t].fn;return s};St.prototype.listenerCount=function(o){var e=Rt?Rt+o:o,r=this._events[e];return r?r.fn?1:r.length:0};St.prototype.emit=function(o,e,r,t,a,s){var u=Rt?Rt+o:o;if(!this._events[u])return!1;var l=this._events[u],f=arguments.length,c,d;if(l.fn){switch(l.once&&this.removeListener(o,l.fn,void 0,!0),f){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,e),!0;case 3:return l.fn.call(l.context,e,r),!0;case 4:return l.fn.call(l.context,e,r,t),!0;case 5:return l.fn.call(l.context,e,r,t,a),!0;case 6:return l.fn.call(l.context,e,r,t,a,s),!0}for(d=1,c=new Array(f-1);d<f;d++)c[d-1]=arguments[d];l.fn.apply(l.context,c)}else{var h=l.length,p;for(d=0;d<h;d++)switch(l[d].once&&this.removeListener(o,l[d].fn,void 0,!0),f){case 1:l[d].fn.call(l[d].context);break;case 2:l[d].fn.call(l[d].context,e);break;case 3:l[d].fn.call(l[d].context,e,r);break;case 4:l[d].fn.call(l[d].context,e,r,t);break;default:if(!c)for(p=1,c=new Array(f-1);p<f;p++)c[p-1]=arguments[p];l[d].fn.apply(l[d].context,c)}}return!0};St.prototype.on=function(o,e,r){return dh(this,o,e,r,!1)};St.prototype.once=function(o,e,r){return dh(this,o,e,r,!0)};St.prototype.removeListener=function(o,e,r,t){var a=Rt?Rt+o:o;if(!this._events[a])return this;if(!e)return La(this,a),this;var s=this._events[a];if(s.fn)s.fn===e&&(!t||s.once)&&(!r||s.context===r)&&La(this,a);else{for(var u=0,l=[],f=s.length;u<f;u++)(s[u].fn!==e||t&&!s[u].once||r&&s[u].context!==r)&&l.push(s[u]);l.length?this._events[a]=l.length===1?l[0]:l:La(this,a)}return this};St.prototype.removeAllListeners=function(o){var e;return o?(e=Rt?Rt+o:o,this._events[e]&&La(this,e)):(this._events=new Ni,this._eventsCount=0),this};St.prototype.off=St.prototype.removeListener;St.prototype.addListener=St.prototype.on;St.prefixed=Rt;St.EventEmitter=St;typeof Cl!="undefined"&&(Cl.exports=St)});var mh=Z((sD,gh)=>{"use strict";g();function Ce(n){if(this._capacity=hh(n),this._length=0,this._front=0,ph(n)){for(var o=n.length,e=0;e<o;++e)this[e]=n[e];this._length=o}}Ce.prototype.toArray=function(){for(var o=this._length,e=new Array(o),r=this._front,t=this._capacity,a=0;a<o;++a)e[a]=this[r+a&t-1];return e};Ce.prototype.push=function(o){var e=arguments.length,r=this._length;if(e>1){var t=this._capacity;if(r+e>t){for(var s=0;s<e;++s){this._checkCapacity(r+1);var a=this._front+r&this._capacity-1;this[a]=arguments[s],r++,this._length=r}return r}else{for(var a=this._front,s=0;s<e;++s)this[a+r&t-1]=arguments[s],a++;return this._length=r+e,r+e}}if(e===0)return r;this._checkCapacity(r+1);var s=this._front+r&this._capacity-1;return this[s]=o,this._length=r+1,r+1};Ce.prototype.pop=function(){var o=this._length;if(o!==0){var e=this._front+o-1&this._capacity-1,r=this[e];return this[e]=void 0,this._length=o-1,r}};Ce.prototype.shift=function(){var o=this._length;if(o!==0){var e=this._front,r=this[e];return this[e]=void 0,this._front=e+1&this._capacity-1,this._length=o-1,r}};Ce.prototype.unshift=function(o){var e=this._length,r=arguments.length;if(r>1){var s=this._capacity;if(e+r>s){for(var u=r-1;u>=0;u--){this._checkCapacity(e+1);var s=this._capacity,t=(this._front-1&s-1^s)-s;this[t]=arguments[u],e++,this._length=e,this._front=t}return e}else{for(var a=this._front,u=r-1;u>=0;u--){var t=(a-1&s-1^s)-s;this[t]=arguments[u],a=t}return this._front=a,this._length=e+r,e+r}}if(r===0)return e;this._checkCapacity(e+1);var s=this._capacity,u=(this._front-1&s-1^s)-s;return this[u]=o,this._length=e+1,this._front=u,e+1};Ce.prototype.peekBack=function(){var o=this._length;if(o!==0){var e=this._front+o-1&this._capacity-1;return this[e]}};Ce.prototype.peekFront=function(){if(this._length!==0)return this[this._front]};Ce.prototype.get=function(o){var e=o;if(e===(e|0)){var r=this._length;if(e<0&&(e=e+r),!(e<0||e>=r))return this[this._front+e&this._capacity-1]}};Ce.prototype.isEmpty=function(){return this._length===0};Ce.prototype.clear=function(){for(var o=this._length,e=this._front,r=this._capacity,t=0;t<o;++t)this[e+t&r-1]=void 0;this._length=0,this._front=0};Ce.prototype.toString=function(){return this.toArray().toString()};Ce.prototype.valueOf=Ce.prototype.toString;Ce.prototype.removeFront=Ce.prototype.shift;Ce.prototype.removeBack=Ce.prototype.pop;Ce.prototype.insertFront=Ce.prototype.unshift;Ce.prototype.insertBack=Ce.prototype.push;Ce.prototype.enqueue=Ce.prototype.push;Ce.prototype.dequeue=Ce.prototype.shift;Ce.prototype.toJSON=Ce.prototype.toArray;Object.defineProperty(Ce.prototype,"length",{get:function(){return this._length},set:function(){throw new RangeError("")}});Ce.prototype._checkCapacity=function(o){this._capacity<o&&this._resizeTo(hh(this._capacity*1.5+16))};Ce.prototype._resizeTo=function(o){var e=this._capacity;this._capacity=o;var r=this._front,t=this._length;if(r+t>e){var a=r+t&e-1;DT(this,0,this,e,a)}};var ph=Array.isArray;function DT(n,o,e,r,t){for(var a=0;a<t;++a)e[a+r]=n[a+o],n[a+o]=void 0}function WT(n){return n=n>>>0,n=n-1,n=n|n>>1,n=n|n>>2,n=n|n>>4,n=n|n>>8,n=n|n>>16,n+1}function hh(n){if(typeof n!="number")if(ph(n))n=n.length;else return 16;return WT(Math.min(Math.max(16,n),1073741824))}gh.exports=Ce});var Eh=Z(Mh=>{g();(function(n){"use strict";function o(T,x){var A;return T instanceof Buffer?A=T:A=Buffer.from(T.buffer,T.byteOffset,T.byteLength),A.toString(x)}var e=function(x){return Buffer.from(x)};function r(T){for(var x=0,A=Math.min(65536,T.length+1),b=new Uint16Array(A),E=[],I=0;;){var _=x<T.length;if(!_||I>=A-1){var M=b.subarray(0,I),N=M;if(E.push(String.fromCharCode.apply(null,N)),!_)return E.join("");T=T.subarray(x),x=0,I=0}var R=T[x++];if(!(R&128))b[I++]=R;else if((R&224)===192){var P=T[x++]&63;b[I++]=(R&31)<<6|P}else if((R&240)===224){var P=T[x++]&63,O=T[x++]&63;b[I++]=(R&31)<<12|P<<6|O}else if((R&248)===240){var P=T[x++]&63,O=T[x++]&63,z=T[x++]&63,J=(R&7)<<18|P<<12|O<<6|z;J>65535&&(J-=65536,b[I++]=J>>>10&1023|55296,J=56320|J&1023),b[I++]=J}}}function t(T){for(var x=0,A=T.length,b=0,E=Math.max(32,A+(A>>>1)+7),I=new Uint8Array(E>>>3<<3);x<A;){var _=T.charCodeAt(x++);if(_>=55296&&_<=56319){if(x<A){var M=T.charCodeAt(x);(M&64512)===56320&&(++x,_=((_&1023)<<10)+(M&1023)+65536)}if(_>=55296&&_<=56319)continue}if(b+4>I.length){E+=8,E*=1+x/T.length*2,E=E>>>3<<3;var N=new Uint8Array(E);N.set(I),I=N}if(_&4294967168)if(!(_&4294965248))I[b++]=_>>>6&31|192;else if(!(_&4294901760))I[b++]=_>>>12&15|224,I[b++]=_>>>6&63|128;else if(!(_&4292870144))I[b++]=_>>>18&7|240,I[b++]=_>>>12&63|128,I[b++]=_>>>6&63|128;else continue;else{I[b++]=_;continue}I[b++]=_&63|128}return I.slice?I.slice(0,b):I.subarray(0,b)}var a="Failed to ",s=function(x,A,b){if(x)throw new Error("".concat(a).concat(A,": the '").concat(b,"' option is unsupported."))},u=typeof Buffer=="function"&&Buffer.from,l=u?e:t;function f(){this.encoding="utf-8"}f.prototype.encode=function(T,x){return s(x&&x.stream,"encode","stream"),l(T)};function c(T){var x;try{var A=new Blob([T],{type:"text/plain;charset=UTF-8"});x=URL.createObjectURL(A);var b=new XMLHttpRequest;return b.open("GET",x,!1),b.send(),b.responseText}finally{x&&URL.revokeObjectURL(x)}}var d=!u&&typeof Blob=="function"&&typeof URL=="function"&&typeof URL.createObjectURL=="function",h=["utf-8","utf8","unicode-1-1-utf-8"],p=r;u?p=o:d&&(p=function(x){try{return c(x)}catch(A){return r(x)}});var k="construct 'TextDecoder'",S="".concat(a," ").concat(k,": the ");function C(T,x){s(x&&x.fatal,k,"fatal"),T=T||"utf-8";var A;if(u?A=Buffer.isEncoding(T):A=h.indexOf(T.toLowerCase())!==-1,!A)throw new RangeError("".concat(S," encoding label provided ('").concat(T,"') is invalid."));this.encoding=T,this.fatal=!1,this.ignoreBOM=!1}C.prototype.decode=function(T,x){s(x&&x.stream,"decode","stream");var A;return T instanceof Uint8Array?A=T:T.buffer instanceof ArrayBuffer?A=new Uint8Array(T.buffer):A=new Uint8Array(T),p(A,this.encoding)},n.TextEncoder=n.TextEncoder||f,n.TextDecoder=n.TextDecoder||C})(typeof window!="undefined"?window:typeof global!="undefined"?global:Mh)});var eg=Z((SW,qi)=>{g();var UT=De();function HT(n,o){for(;!Object.prototype.hasOwnProperty.call(n,o)&&(n=UT(n),n!==null););return n}qi.exports=HT,qi.exports.__esModule=!0,qi.exports.default=qi.exports});var Ha=Z((xW,Qt)=>{g();var zT=eg();function Ua(){return typeof Reflect!="undefined"&&Reflect.get?(Qt.exports=Ua=Reflect.get.bind(),Qt.exports.__esModule=!0,Qt.exports.default=Qt.exports):(Qt.exports=Ua=function(o,e,r){var t=zT(o,e);if(t){var a=Object.getOwnPropertyDescriptor(t,e);return a.get?a.get.call(arguments.length<3?o:r):a.value}},Qt.exports.__esModule=!0,Qt.exports.default=Qt.exports),Ua.apply(this,arguments)}Qt.exports=Ua,Qt.exports.__esModule=!0,Qt.exports.default=Qt.exports});var cg=Z((GW,fg)=>{g();fg.exports={$schema:"http://json-schema.org/draft-07/schema#",$id:"http://augloop.office.com/settings.json",definitions:{environments:{type:"array",uniqueItems:!0,minItems:1,items:{type:"string",enum:["dev","test","int","dogfood","prod","fairfax","gcchigh","dod","ag08","ag09","gallatin"]}},regions:{type:"array",uniqueItems:!0,minItems:1,items:{type:"string",enum:["australiaeast","australiasoutheast","brazilsouth","centralindia","centralus","chinaeast3","chinanorth3","eastus","eastus2","eastus2euap","francecentral","japaneast","northeurope","southcentralus","swedencentral","northcentralus","southeastasia","westcentralus","westeurope","westus","westus2","usdodcentral","usdodeast","usgovarizona","usgovtexas","usgovvirginia","usnateast","usnatwest","usseceast","ussecwest"]}},dataBoundaries:{type:"array",uniqueItems:!0,minItems:1,items:{type:"string",enum:["eudb"]}},serviceNames:{type:"array",uniqueItems:!0,minItems:1,items:{type:"string",enum:["gateway","matchmaker","httpproxy","utility","textanalysis","proofing","acronyms","classification","mastermind","excel-ecs-proxy","automatic-clp","fileio","powerpoint-getitems-proxy","tricorder","image-services","natural-language","role-detection","doc-xray","compose","voice","incubation","canvas","excel","ink","extension","observational-assistance","personalization","security","generative-text"]}},IConfigValue:{type:"object",properties:{value:{description:"An untyped setting",type:["array","boolean","integer","null","number","object","string"]},environments:{$ref:"#/definitions/environments"},regions:{$ref:"#/definitions/regions"},dataBoundaries:{$ref:"#/definitions/dataBoundaries"},serviceNames:{$ref:"#/definitions/serviceNames"},lastModifiedBy:{type:"string",format:"email"},lastModifiedTime:{type:"string",format:"date-time"}},required:["value"],additionalProperties:!1},IConfigSetting:{type:"array",minItems:1,items:{$ref:"#/definitions/IConfigValue"}},IStringConfigSetting:{type:"array",minItems:1,items:{allOf:[{type:"object",properties:{value:{description:"A string setting",type:"string"}}},{$ref:"#/definitions/IConfigValue"}]}},INumericConfigSetting:{type:"array",minItems:1,items:{allOf:[{type:"object",properties:{value:{description:"A number setting",type:"number"}}},{$ref:"#/definitions/IConfigValue"}]}},IBooleanConfigSetting:{type:"array",minItems:1,items:{allOf:[{type:"object",properties:{value:{description:"A boolean setting",type:"boolean"}}},{$ref:"#/definitions/IConfigValue"}]}},IObjectConfigSetting:{type:"array",minItems:1,items:{allOf:[{type:"object",properties:{value:{description:"An object setting",type:"object"}}},{$ref:"#/definitions/IConfigValue"}]}},IArrayConfigSetting:{type:"array",minItems:1,items:{allOf:[{type:"object",properties:{value:{description:"An array setting",type:"array"}}},{$ref:"#/definitions/IConfigValue"}]}}},title:"Config",properties:{$schema:!0},additionalProperties:{$ref:"#/definitions/IConfigSetting"}}});var mm=Z((ZP,gm)=>{g();var mI="Expected a function",pm=NaN,vI="[object Symbol]",yI=/^\s+|\s+$/g,kI=/^[-+]0x[0-9a-f]+$/i,wI=/^0b[01]+$/i,SI=/^0o[0-7]+$/i,CI=parseInt,xI=typeof global=="object"&&global&&global.Object===Object&&global,TI=typeof self=="object"&&self&&self.Object===Object&&self,II=xI||TI||Function("return this")(),_I=Object.prototype,AI=_I.toString,bI=Math.max,MI=Math.min,Uf=function(){return II.Date.now()};function EI(n,o,e){var r,t,a,s,u,l,f=0,c=!1,d=!1,h=!0;if(typeof n!="function")throw new TypeError(mI);o=hm(o)||0,Hf(e)&&(c=!!e.leading,d="maxWait"in e,a=d?bI(hm(e.maxWait)||0,o):a,h="trailing"in e?!!e.trailing:h);function p(I){var _=r,M=t;return r=t=void 0,f=I,s=n.apply(M,_),s}function k(I){return f=I,u=setTimeout(T,o),c?p(I):s}function S(I){var _=I-l,M=I-f,N=o-_;return d?MI(N,a-M):N}function C(I){var _=I-l,M=I-f;return l===void 0||_>=o||_<0||d&&M>=a}function T(){var I=Uf();if(C(I))return x(I);u=setTimeout(T,S(I))}function x(I){return u=void 0,h&&r?p(I):(r=t=void 0,s)}function A(){u!==void 0&&clearTimeout(u),f=0,r=l=t=u=void 0}function b(){return u===void 0?s:x(Uf())}function E(){var I=Uf(),_=C(I);if(r=arguments,t=this,l=I,_){if(u===void 0)return k(l);if(d)return u=setTimeout(T,o),p(l)}return u===void 0&&(u=setTimeout(T,o)),s}return E.cancel=A,E.flush=b,E}function Hf(n){var o=typeof n;return!!n&&(o=="object"||o=="function")}function RI(n){return!!n&&typeof n=="object"}function NI(n){return typeof n=="symbol"||RI(n)&&AI.call(n)==vI}function hm(n){if(typeof n=="number")return n;if(NI(n))return pm;if(Hf(n)){var o=typeof n.valueOf=="function"?n.valueOf():n;n=Hf(o)?o+"":o}if(typeof n!="string")return n===0?n:+n;n=n.replace(yI,"");var e=wI.test(n);return e||SI.test(n)?CI(n.slice(2),e?2:8):kI.test(n)?pm:+n}gm.exports=EI});var mn=Z((HO,Ji)=>{g();function Fm(n,o,e,r,t,a,s){try{var u=n[a](s),l=u.value}catch(f){e(f);return}u.done?o(l):Promise.resolve(l).then(r,t)}function UI(n){return function(){var o=this,e=arguments;return new Promise(function(r,t){var a=n.apply(o,e);function s(l){Fm(a,r,t,s,u,"next",l)}function u(l){Fm(a,r,t,s,u,"throw",l)}s(void 0)})}}Ji.exports=UI,Ji.exports.__esModule=!0,Ji.exports.default=Ji.exports});var qw=Z((DH,Fw)=>{g();Fw.exports={version:"2.35.59"}});var mC=Z(Ys=>{"use strict";g();Object.defineProperty(Ys,"__esModule",{value:!0});var Qb;(function(n){n.DesignerSlideSuggestion="Designer.Slides",n.TextToSmartArtSuggestion="Designer.TextToSmartArt",n.PowerPointTextTileChanged="PowerPoint.TextTileChanged",n.SlideContentChange="PowerPoint.SlideContentChange",n.IdeasExecuteAction="Ideas.ExecuteAction"})(Qb=Ys.MessageType||(Ys.MessageType={}))});var vC=Z(Zs=>{"use strict";g();Object.defineProperty(Zs,"__esModule",{value:!0});var jb;(function(n){n[n.Error=0]="Error",n[n.Warn=1]="Warn",n[n.Info=2]="Info",n[n.Debug=3]="Debug"})(jb=Zs.LoggingLevel||(Zs.LoggingLevel={}))});var yC=Z(eu=>{"use strict";g();Object.defineProperty(eu,"__esModule",{value:!0});var Jb;(function(n){n.NotSet="NotSet",n.Timeout="Timeout",n.NetworkError="NetworkError",n.ServiceError="ServiceError",n.ParsingError="ParsingError",n.AuthenticationError="AuthenticationError",n.UnhandledException="UnhandledException"})(Jb=eu.ProviderErrorType||(eu.ProviderErrorType={}))});var kC=Z(tu=>{"use strict";g();Object.defineProperty(tu,"__esModule",{value:!0});var Kb;(function(n){n.Invalid="Invalid",n.Success="Success",n.Error="Error",n.Pending="Pending",n.NoResult="NoResult"})(Kb=tu.ProviderResultStatus||(tu.ProviderResultStatus={}))});var wC=Z(nu=>{"use strict";g();Object.defineProperty(nu,"__esModule",{value:!0});var $b;(function(n){n[n.NotSet=0]="NotSet",n[n.Measure=1]="Measure",n[n.Diagnostics=2]="Diagnostics",n[n.CriticalBusinessImpact=191]="CriticalBusinessImpact",n[n.CriticalCensus=192]="CriticalCensus",n[n.CriticalExperimentation=193]="CriticalExperimentation",n[n.CriticalUsage=194]="CriticalUsage"})($b=nu.SamplingPolicy||(nu.SamplingPolicy={}))});var SC=Z(st=>{"use strict";g();Object.defineProperty(st,"__esModule",{value:!0});var Xb;(function(n){n.DESIGNER_SLIDE_PROVIDER_ID="Provider.Designer.Slide",n.SLIDE_SUGGESTION_ID="EntityGroup.Designer.Slide.Suggestion"})(Xb=st.DesignerSlideProviderIdentifier||(st.DesignerSlideProviderIdentifier={}));var Yb;(function(n){n.MAKE_IT_VISUAL_PROVIDER_ID="Provider.UCI.MakeItVisual",n.MAKE_IT_VISUAL_KEYWORDS_ID="EntityGroup.UCI.MakeItVisual.Keywords"})(Yb=st.MakeItVisualProviderIdentifier||(st.MakeItVisualProviderIdentifier={}));var Zb;(function(n){n.DESIGNER_TEXT_TO_SMARTART_PROVIDER_ID="Provider.Designer.TextToSmartArt",n.TEXT_TO_SMARTART_SUGGESTION_ID="EntityGroup.Designer.TextToSmartArt.Suggestion"})(Zb=st.DesignerTextToSmartArtProviderIdentifier||(st.DesignerTextToSmartArtProviderIdentifier={}));var eM;(function(n){n.HUBBLE_PROVIDER_ID="Provider.Hubble",n.HUBBLE_IMAGES_GROUP_ID="EntityGroup.Hubble.Images"})(eM=st.HubbleProviderIdentifier||(st.HubbleProviderIdentifier={}));var tM;(function(n){n.TAP_SEARCH_QF_PROVIDER_ID="Provider.Tap.Search.QF",n.TAP_SEARCH_QF_AND_OLS_PROVIDER_ID="Provider.Tap.Search.QFAndOLS",n.TAP_SEARCH_OLS_PROVIDER_ID="Provider.Tap.Search.OLS",n.TAP_SEARCH_SP_PROVIDER_ID="Provider.Tap.Search.SP",n.TAP_SEARCH_ZERO_TERM_QF_PROVIDER_ID="Provider.Tap.Search.ZeroTerm.QF",n.TAP_SEARCH_ZERO_TERM_QF_AND_OLS_PROVIDER_ID="Provider.Tap.Search.ZeroTerm.QFAndOLS",n.TAP_SEARCH_ZERO_TERM_OLS_PROVIDER_ID="Provider.Tap.Search.ZeroTerm.OLS",n.TAP_SEARCH_ZERO_TERM_SP_PROVIDER_ID="Provider.Tap.Search.ZeroTerm.SP",n.DOCUMENT_ID="EntityGroup.Tap.Document"})(tM=st.TapProviderIdentifier||(st.TapProviderIdentifier={}));var nM;(function(n){n.DICTIONARY_PROVIDER_ID="Provider.UCI.Dictionary",n.DICTIONARY_WORDS_GROUP_ID="EntityGroup.UCI.Dictionary.Words"})(nM=st.DictionaryProviderIdentifier||(st.DictionaryProviderIdentifier={}));var rM;(function(n){n.IMAGES_PROVIDER_ID="Provider.UCI.Images",n.IMAGES_ID="EntityGroup.UCI.Images.Images"})(rM=st.ImagesProviderIdentifier||(st.ImagesProviderIdentifier={}));var oM;(function(n){n.INSIGHTS_PROVIDER_ID="Provider.UCI.Insights",n.BINGANSWER_COMPUTATION_ID="EntityGroup.UCI.Insights.BingAnswer.Computation",n.BINGANSWER_CURRENCY_ID="EntityGroup.UCI.Insights.BingAnswer.Currency",n.BINGANSWER_FACTS_ID="EntityGroup.UCI.Insights.BingAnswer.Facts",n.BINGANSWER_FINANCE_ID="EntityGroup.UCI.Insights.BingAnswer.Finance",n.BINGANSWER_NEWS_ID="EntityGroup.UCI.Insights.BingAnswer.News",n.BINGANSWER_WEATHER_ID="EntityGroup.UCI.Insights.BingAnswer.Weather",n.DICTIONARY_ID="EntityGroup.UCI.Insights.Dictionary",n.ENTITIES_ID="EntityGroup.UCI.Insights.Entities",n.IMAGES_ID="EntityGroup.UCI.Insights.Images",n.WEBRESULTS_ID="EntityGroup.UCI.Insights.WebResults",n.WIKIPEDIARESULTS_ID="EntityGroup.UCI.Insights.WikipediaResults"})(oM=st.InsightsProviderIdentifier||(st.InsightsProviderIdentifier={}))});var hd=Z(Pt=>{"use strict";g();Object.defineProperty(Pt,"__esModule",{value:!0});var iM=mC();Pt.MessageType=iM.MessageType;var aM=vC();Pt.LoggingLevel=aM.LoggingLevel;var sM=yC();Pt.ProviderErrorType=sM.ProviderErrorType;var uM=kC();Pt.ProviderResultStatus=uM.ProviderResultStatus;var lM=wC();Pt.SamplingPolicy=lM.SamplingPolicy;var Tr=SC();Pt.DesignerSlideProviderIdentifier=Tr.DesignerSlideProviderIdentifier;Pt.MakeItVisualProviderIdentifier=Tr.MakeItVisualProviderIdentifier;Pt.DesignerTextToSmartArtProviderIdentifier=Tr.DesignerTextToSmartArtProviderIdentifier;Pt.HubbleProviderIdentifier=Tr.HubbleProviderIdentifier;Pt.TapProviderIdentifier=Tr.TapProviderIdentifier;Pt.DictionaryProviderIdentifier=Tr.DictionaryProviderIdentifier;Pt.ImagesProviderIdentifier=Tr.ImagesProviderIdentifier;Pt.InsightsProviderIdentifier=Tr.InsightsProviderIdentifier});var CC=Z(gd=>{"use strict";g();Object.defineProperty(gd,"__esModule",{value:!0});var ha=hd(),fM=function(){function n(o,e){this.logger=o,this.configuration=e,this.shouldMatchDocumentTitle=!1,this.shouldMatchDocumentTitle=this.configuration?this.configuration.shouldQueryMatchQfDocumentTitle:n.defaultShouldQueryMatchQfDocumentTitle}return n.prototype.rank=function(o,e){var r=this,t=e.rankedEntityGroups.slice();return t.sort(function(a,s){var u=r.getProviderRank(o,a),l=r.getProviderRank(o,s);return a.providerId==s.providerId&&a.providerId==ha.InsightsProviderIdentifier.INSIGHTS_PROVIDER_ID?a.rank-s.rank:u-l}),e.rankedEntityGroups=t,this.logger.info(595994314,"[SmartLookupRanker] RankedResults",{interactionId:o.interactionId,transactionId:o.transactionId,queryMatchEnabled:this.shouldMatchDocumentTitle,ranking:e.rankedEntityGroups.map(function(a){return a.groupTypeId})}),e},n.prototype.getProviderRank=function(o,e){var r=this;if(e.providerId==ha.TapProviderIdentifier.TAP_SEARCH_QF_PROVIDER_ID&&this.shouldMatchDocumentTitle){var t=e;if(t.groupTypeId==ha.TapProviderIdentifier.DOCUMENT_ID){var a=o,s=a!=null&&a.tapContext!=null?a.tapContext.queryText.toLocaleLowerCase().split(n.separators).filter(function(u){return u}):void 0;if(t.data.find(function(u){return r.isTextContainsSearchWords(u.Title.toLocaleLowerCase(),s)}))this.logger.debug(595973527,"[SmartLookupRanker] Query match with Qf Document succeeded",{interactionId:o.interactionId,transactionId:o.transactionId});else return this.logger.debug(595973526,"[SmartLookupRanker] Query match with Qf Document failed",{interactionId:o.interactionId,transactionId:o.transactionId}),Number.MAX_VALUE}}return n.providerRank[e.providerId]?n.providerRank[e.providerId]:Number.MAX_VALUE},n.prototype.isTextContainsSearchWords=function(o,e){if(e==null||o==null)return!1;var r=o.split(n.separators);return e.every(function(t){return r.find(function(a){return a.indexOf(t)>=0})!=null})},n.providerRank=(ru={},ru[ha.TapProviderIdentifier.TAP_SEARCH_QF_PROVIDER_ID]=1,ru[ha.InsightsProviderIdentifier.INSIGHTS_PROVIDER_ID]=2,ru),n.separators=/[\s]+/,n.defaultShouldQueryMatchQfDocumentTitle=!1,n}();gd.SmartLookupRanker=fM;var ru});var xC=Z(md=>{"use strict";g();Object.defineProperty(md,"__esModule",{value:!0});var cM=CC();md.SmartLookupRanker=cM.SmartLookupRanker});var TC=Z((G4,ga)=>{g();function dM(n){if(n==null)throw new TypeError("Cannot destructure "+n)}ga.exports=dM,ga.exports.__esModule=!0,ga.exports.default=ga.exports});var PC=Z((Y4,BC)=>{g();BC.exports=OfficePlatformGlobal.Telemetry.OTel});var LC=Z((eV,OC)=>{g();OC.exports=OfficePlatformGlobal.Telemetry.OTelSDX});g();var ZC=w(Td());g();var ya=w(_d());g();var Ad=function(n){return n[n.Unknown=0]="Unknown",n[n.LiveId=1]="LiveId",n[n.OrgId=2]="OrgId",n[n.ActiveDirectory=3]="ActiveDirectory",n[n.ADAL=4]="ADAL",n[n.SSPI=5]="SSPI",n[n.OAuth2=6]="OAuth2",n}({}),Dn=function(n){return n[n.Error=0]="Error",n[n.Warning=1]="Warning",n[n.Info=3]="Info",n[n.Metric=4]="Metric",n[n.Verbose=5]="Verbose",n[n.Debug=6]="Debug",n}({});ya.CustomTypeRegistry.registerTypeInfos({"AugLoopData::InputData":{InputSchema:"$string",InputJson:"$string",CorrelationVector:"$string"},"AugLoopData::ResultData":{InputSchema:"$string",InputJson:"$string",OutputSchema:"$string",OutputJson:"$string"},"AugLoopData::ServiceGroups":{OfficeServiceGroup:"$number",ControllerServiceGroup:"$number"},"AugLoopData::HostMetadata":{AppName:"$string",AppPlatform:"$string",AppVersion:"$string",UILanguage:"$string",ClientId:"$string",ReleaseAudienceGroup:"$string",ReleaseChannel:"$string",ReleaseFork:"$string",SessionId:"$string",Flights:"$string",PrivateMode:"$boolean",DisabledServiceGroups:["$array","AugLoopData::ServiceGroups"]},"AugLoopData::ConfigTicket":{Provider:"$number",Policy:"$string",Target:"$string",ResourceId:"$string",AuthorityUrl:"$string"},"AugLoopData::AuthTokenRequest":{Tickets:["$array","AugLoopData::ConfigTicket"],DocId:["opt-field","$string"],DocSessionId:["opt-field","$string"]},"AugLoopData::AuthTokenResponse":{Token:"$string"},"AugLoopData::IdentityWithToken":{IdentityId:"$string",Token:"$string"},"AugLoopData::AuthTokensResponse":{Identites:["$array","AugLoopData::IdentityWithToken"]},"AugLoopData::CreateSessionParameters":{docSessionId:["opt-field","$string"],extensionConfigs:["opt-field",["$array","$string"]],flights:["opt-field","$string"],serviceUrl:["opt-field","$string"]},"AugLoopData::ActivateAnnotationParameters":{annotationType:"$string",token:"$string",config:["opt-field","$string"],docSessionId:["opt-field","$string"]},"AugLoopData::ReleaseAnnotationParameters":{token:"$string",docSessionId:["opt-field","$string"]},"AugLoopData::SubmitOperationsParameters":{operations:["$array","$string"],cv:["opt-field","$string"],docSessionId:["opt-field","$string"]},"AugLoopData::SubmitSeedOperationsParameters":{operations:["$array","$string"],cv:["opt-field","$string"],docSessionId:["opt-field","$string"]},"AugLoopData::SubmitSeedGroupOperationsParameters":{operations:["$array","$string"],groupComplete:["opt-field","$boolean"],cv:["opt-field","$string"],docSessionId:["opt-field","$string"]},"AugLoopData::SubmitCustomMessageParameters":{message:"$string",messageId:"$string",docSessionId:["opt-field","$string"]},"AugLoopData::ForceReconnectParameters":{docSessionId:["opt-field","$string"],extensionConfigs:["opt-field",["$array","$string"]]},"AugLoopData::CloseParameters":{docSessionId:["opt-field","$string"]},"AugLoopData::SetSessionCloseCallbackParameters":{docSessionId:["opt-field","$string"]},"AugLoopData::SetConnectCallbackParameters":{docSessionId:["opt-field","$string"]},"AugLoopData::SetDisconnectCallbackParameters":{docSessionId:["opt-field","$string"]},"AugLoopData::BridgeMessageParameters":{bridgeId:"$string",docSessionId:["opt-field","$string"],bridgeMessage:["opt-field","$string"],binaryMessage:["opt-field",["$array","$number"]]},"AugLoopData::SDXBridgeMessageParameters":{bridgeMessage:"$string"},"AugLoopData::InitAugLoopBridgeManagerParameters":{},"AugLoopData::CreateSessionResult":{errMessage:["opt-field","$string"],docSessionId:["opt-field","$string"]},"AugLoopData::ActivateAnnotationResult":{errMessage:["opt-field","$string"],token:"$string",docSessionId:["opt-field","$string"]},"AugLoopData::AnnotationResult":{operation:"$string",token:"$string",docSessionId:["opt-field","$string"]},"AugLoopData::ReleaseAnnotationResult":{errMessage:["opt-field","$string"],token:"$string",result:["opt-field","$boolean"]},"AugLoopData::SubmitCustomMessageResult":{errMessage:["opt-field","$string"],response:["opt-field","$string"],messageId:"$string",docSessionId:["opt-field","$string"]},"AugLoopData::ForceReconnectResult":{errMessage:["opt-field","$string"],docSessionId:["opt-field","$string"]},"AugLoopData::SessionCloseResult":{sessionCloseMessage:["opt-field","$string"],docSessionId:["opt-field","$string"]},"AugLoopData::ConnectResult":{isSeedingRequired:"$boolean",sessionUrl:"$string",origin:"$string",authToken:"$string",docSessionId:["opt-field","$string"]},"AugLoopData::DisconnectResult":{error:"$string",docSessionId:["opt-field","$string"]}});var ux={NativeService:["AugLoopData::NativeService",{OnResult:["FireAndForgetMethod",["AugLoopData::ResultData"]],OnCreateSessionResult:["FireAndForgetMethod",["AugLoopData::CreateSessionResult"]],OnActivateAnnotationResult:["FireAndForgetMethod",["AugLoopData::ActivateAnnotationResult"]],OnAnnotationResult:["FireAndForgetMethod",["AugLoopData::AnnotationResult"]],OnReleaseAnnotationResult:["FireAndForgetMethod",["AugLoopData::ReleaseAnnotationResult"]],OnSubmitCustomMessageResult:["FireAndForgetMethod",["AugLoopData::SubmitCustomMessageResult"]],OnForceReconnectResult:["FireAndForgetMethod",["AugLoopData::ForceReconnectResult"]],OnSessionCloseResult:["FireAndForgetMethod",["AugLoopData::SessionCloseResult"]],OnConnectResult:["FireAndForgetMethod",["AugLoopData::ConnectResult"]],OnDisconnectResult:["FireAndForgetMethod",["AugLoopData::DisconnectResult"]],OnIngressAugLoopBridgeMessage:["FireAndForgetMethod",["AugLoopData::BridgeMessageParameters"]],OnSDXBridgeMessageResult:["FireAndForgetMethod",["AugLoopData::SDXBridgeMessageParameters"]],RequestAuthToken:["ReturnsPromiseMethod","AugLoopData::AuthTokenResponse",["AugLoopData::AuthTokenRequest"]],RequestAuthTokens:["ReturnsPromiseMethod","AugLoopData::AuthTokensResponse",["AugLoopData::AuthTokenRequest"]],IsFeatureEnabled:["ReturnsPromiseMethod","$boolean",["$string","$string"]],ExecuteLocalLambda:["ReturnsPromiseMethod","$string",["AugLoopData::InputData","$string","$string"]],AreLicenseFeaturesEnabled:["ReturnsPromiseMethod","$boolean",[["$array","$number"]]],SendDiagnosticTrace:["FireAndForgetMethod",["$number","$number","$string"]],OnSetServiceUrl:["Event","$string"],OnSetHostMetadata:["Event","AugLoopData::HostMetadata"],OnSubmit:["Event","AugLoopData::InputData"],OnCreateSession:["Event","AugLoopData::CreateSessionParameters"],OnActivateAnnotation:["Event","AugLoopData::ActivateAnnotationParameters"],OnReleaseAnnotation:["Event","AugLoopData::ReleaseAnnotationParameters"],OnSubmitOperations:["Event","AugLoopData::SubmitOperationsParameters"],OnSubmitSeedOperations:["Event","AugLoopData::SubmitSeedOperationsParameters"],OnSubmitSeedGroupOperations:["Event","AugLoopData::SubmitSeedGroupOperationsParameters"],OnSubmitCustomMessage:["Event","AugLoopData::SubmitCustomMessageParameters"],OnForceReconnect:["Event","AugLoopData::ForceReconnectParameters"],OnClose:["Event","AugLoopData::CloseParameters"],OnSetSessionCloseCallback:["Event","AugLoopData::SetSessionCloseCallbackParameters"],OnSetConnectCallback:["Event","AugLoopData::SetConnectCallbackParameters"],OnSetDisconnectCallback:["Event","AugLoopData::SetDisconnectCallbackParameters"],OnInitAugLoopBridgeManager:["Event","AugLoopData::InitAugLoopBridgeManagerParameters"],OnEgressAugLoopBridgeMessage:["Event","AugLoopData::BridgeMessageParameters"],OnSDXBridgeMessageFromNative:["Event","AugLoopData::SDXBridgeMessageParameters"]}]},bd={NativeService:ya.RekaServiceRegistry.getNativeService(ux.NativeService)};g();var $C=w(Ye());g();var ft;(function(n){n[n.EditorLowPrivilege=0]="EditorLowPrivilege",n[n.AugLoopLowPrivilege=1]="AugLoopLowPrivilege",n[n.Anonymous=2]="Anonymous",n[n.ClientAssertion=3]="ClientAssertion",n[n.ClientAssertionV2=4]="ClientAssertionV2",n[n.AutoClpLowPrivilege=5]="AutoClpLowPrivilege",n[n.AutoClpAppOnlyLowPrivilege=6]="AutoClpAppOnlyLowPrivilege",n[n.Substrate=7]="Substrate",n[n.WacUserInfo=8]="WacUserInfo",n[n.OwaExchange=9]="OwaExchange",n[n.SmartCompose=10]="SmartCompose",n[n.WritingAnalyticsLowPrivilege=11]="WritingAnalyticsLowPrivilege",n[n.DWEngineLowPrivilege=12]="DWEngineLowPrivilege",n[n.SubstrateApp=13]="SubstrateApp",n[n.CortanaAppPop=14]="CortanaAppPop",n[n.OfficeAppsAppOnly=15]="OfficeAppsAppOnly",n[n.PPTFrontdoorAppPop=16]="PPTFrontdoorAppPop",n[n.EditorAppOnlyLowPrivilege=17]="EditorAppOnlyLowPrivilege",n[n.AugLoopApp=18]="AugLoopApp",n[n.MeetingIntelligenceApp=19]="MeetingIntelligenceApp",n[n.GraphApp=20]="GraphApp",n[n.IceServicesApp=21]="IceServicesApp",n[n.AzureMapsApp=22]="AzureMapsApp",n[n.SpoApp=23]="SpoApp",n[n.OneDrive=24]="OneDrive",n[n.GoogleDrive=25]="GoogleDrive",n[n.GettyApp=26]="GettyApp",n[n.Dropbox=27]="Dropbox",n[n.GooglePhotos=28]="GooglePhotos",n[n.EditorApp=29]="EditorApp",n[n.AmazonKindle=30]="AmazonKindle",n[n.ShredderApp=31]="ShredderApp",n[n.FormsLowPrivilege=32]="FormsLowPrivilege",n[n.VivaSalesLowPrivilege=33]="VivaSalesLowPrivilege",n[n.IntentSvcApp=34]="IntentSvcApp",n[n.DcgLowPrivilege=35]="DcgLowPrivilege",n[n.CSALowPrivilege=36]="CSALowPrivilege",n[n.ConsumerSydneyLowPrivilege=37]="ConsumerSydneyLowPrivilege",n[n.CompliantSydneyApp=38]="CompliantSydneyApp",n[n.M365AdminApp=39]="M365AdminApp",n[n.MeetingArtifactsServiceLowPrivilege=40]="MeetingArtifactsServiceLowPrivilege",n[n.AlchemyApp=41]="AlchemyApp",n[n.M365Admin=42]="M365Admin",n[n.ConsumerShellApp=43]="ConsumerShellApp",n[n.PowerQueryLowPrivilege=44]="PowerQueryLowPrivilege",n[n.CIIApp=45]="CIIApp",n[n.ConsumerShell=46]="ConsumerShell",n[n.AssistCopilotLowPrivilege=47]="AssistCopilotLowPrivilege",n[n.Pva=48]="Pva",n[n.TeamsCopilotServiceLowPrivilege=49]="TeamsCopilotServiceLowPrivilege"})(ft||(ft={}));var Dd;(function(n){n[n.Unknown=0]="Unknown",n[n.Consumer=1]="Consumer",n[n.Enterprise=2]="Enterprise"})(Dd||(Dd={}));var Wd;(function(n){n.AuthorizationCode="authorization_code",n.ClientCredentials="client_credentials",n.RefreshToken="refresh_token"})(Wd||(Wd={}));var Bd;(function(n){n[n.LoggedIn=0]="LoggedIn",n[n.LoggedOut=1]="LoggedOut"})(Bd||(Bd={}));g();var ho;(function(n){n[n.Add=1]="Add",n[n.Update=2]="Update",n[n.Delete=3]="Delete"})(ho||(ho={}));g();g();var bt;(function(n){n[n.Undefined=0]="Undefined",n[n.Created=10]="Created",n[n.Sent=20]="Sent",n[n.Duplicated=30]="Duplicated",n[n.Seen=40]="Seen",n[n.Tried=50]="Tried",n[n.Kept=60]="Kept",n[n.Rejected=70]="Rejected"})(bt||(bt={}));g();var ct;(function(n){n[n.None=0]="None",n[n.Added=1]="Added",n[n.Updated=2]="Updated",n[n.Deleted=3]="Deleted"})(ct||(ct={}));var ir;(function(n){n[n.ContentChanged=0]="ContentChanged",n[n.ContentWasEmpty=1]="ContentWasEmpty",n[n.FormattingChanged=2]="FormattingChanged",n[n.ContentWasInsideOfTheTable=3]="ContentWasInsideOfTheTable"})(ir||(ir={}));var Ee;(function(n){n[n.AddOfZeroElements=0]="AddOfZeroElements",n[n.AddOfItemsWithExtraOrMissingIds=1]="AddOfItemsWithExtraOrMissingIds",n[n.AddOfItemWithUndefinedId=2]="AddOfItemWithUndefinedId",n[n.AddOfUndefinedItem=3]="AddOfUndefinedItem",n[n.AddOfItemsWithDuplicateIds=4]="AddOfItemsWithDuplicateIds",n[n.SetHeadToNonExistingItem=5]="SetHeadToNonExistingItem",n[n.DeleteOfNonExistingItem=6]="DeleteOfNonExistingItem",n[n.UpdateOfNonExistentItem=7]="UpdateOfNonExistentItem",n[n.UpdateOfStubbedItem=8]="UpdateOfStubbedItem",n[n.MoveOfNonExistentItem=9]="MoveOfNonExistentItem",n[n.UpdateMetaDataOfNonAnnotationType=10]="UpdateMetaDataOfNonAnnotationType",n[n.SequentialyInvertedUpdate=11]="SequentialyInvertedUpdate",n[n.DeltaOfNonExistingItem=100]="DeltaOfNonExistingItem"})(Ee||(Ee={}));g();var qd=w(B()),Gd=w(W());var Zo;(function(n){n[n.None=0]="None",n[n.HttpsGetDownloadUrl=1]="HttpsGetDownloadUrl",n[n.AlCodedLocation=2]="AlCodedLocation"})(Zo||(Zo={}));var Fd;(function(n){n[n.NewDocument=0]="NewDocument",n[n.EditDocument=1]="EditDocument",n[n.ViewOnlyDocument=2]="ViewOnlyDocument"})(Fd||(Fd={}));var br=(0,qd.default)(function n(){(0,Gd.default)(this,n)});br.lowerIndexBound=1;br.maxNumberOfRows=1048576;br.maxNumberOfColumns=16384;br.firstColumnName="A";br.lastColumnName="XFD";g();var gu=w(W()),mu=w(B());g();var Vd=w(Ie()),Qd=w(W()),jd=w(B()),m=function(){function n(o){(0,Qd.default)(this,n),n.assign(n,this,o)}return(0,jd.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_SchemaObject"}},{key:"getBaseTypes",value:function(){return[]}},{key:"getTypeNameFor",value:function(e){return e&&e.H_?e.H_.T_:void 0}},{key:"getBaseTypesFor",value:function(e){return e&&e.H_&&e.H_.B_?e.H_.B_:[]}},{key:"getAllTypesFor",value:function(e){var r=n.getTypeNameFor(e);return r?[r].concat((0,Vd.default)(n.getBaseTypesFor(e))):[]}},{key:"matchesTypesFor",value:function(e,r){if(!Array.isArray(r)||r.length===0)return!0;var t=n.getTypeNameFor(e),a=n.getBaseTypesFor(e);for(var s of r)if(s===t||a.indexOf(s)>=0)return!0;return!1}},{key:"assign",value:function(e,r,t){if(t)for(var a of Object.keys(t))r[a]=t[a];return r.H_=e.H_,r}}]),n}();m.H_={T_:m.getTypeName(),B_:m.getBaseTypes()};var gt=function(){function n(o){(0,gu.default)(this,n),m.assign(n,this,o)}return(0,mu.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Core_Annotation"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();gt.H_={T_:gt.getTypeName(),B_:gt.getBaseTypes()};var hu=function(){function n(o){(0,gu.default)(this,n),m.assign(n,this,o)}return(0,mu.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Core_BinaryClassificationAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();hu.H_={T_:hu.getTypeName(),B_:hu.getBaseTypes()};g();var yu=w(W()),ku=w(B());var Mr=function(){function n(o){(0,yu.default)(this,n),m.assign(n,this,o)}return(0,ku.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_Event"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Mr.H_={T_:Mr.getTypeName(),B_:Mr.getBaseTypes()};var vu=function(){function n(o){(0,yu.default)(this,n),m.assign(n,this,o)}return(0,ku.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_UserCommand"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Event"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();vu.H_={T_:vu.getTypeName(),B_:vu.getBaseTypes()};g();var mt=w(W()),vt=w(B());var wu=function(){function n(o){(0,mt.default)(this,n),m.assign(n,this,o)}return(0,vt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_ItemDelta"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();wu.H_={T_:wu.getTypeName(),B_:wu.getBaseTypes()};var Bn=function(){function n(o){(0,mt.default)(this,n),m.assign(n,this,o)}return(0,vt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_ItemChangesDelta"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_ItemDelta"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Bn.H_={T_:Bn.getTypeName(),B_:Bn.getBaseTypes()};var ar=function(){function n(o){(0,mt.default)(this,n),m.assign(n,this,o)}return(0,vt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_Operation"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();ar.H_={T_:ar.getTypeName(),B_:ar.getBaseTypes()};var Su=function(){function n(o){(0,mt.default)(this,n),m.assign(n,this,o)}return(0,vt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_OperationWithSiblingContext"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Su.H_={T_:Su.getTypeName(),B_:Su.getBaseTypes()};var we=function(){function n(o){(0,mt.default)(this,n),m.assign(n,this,o)}return(0,vt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_AddOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_OperationWithSiblingContext","AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();we.H_={T_:we.getTypeName(),B_:we.getBaseTypes()};var Er=function(){function n(o){(0,mt.default)(this,n),m.assign(n,this,o)}return(0,vt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_MoveOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_OperationWithSiblingContext","AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Er.H_={T_:Er.getTypeName(),B_:Er.getBaseTypes()};var ot=function(){function n(o){(0,mt.default)(this,n),m.assign(n,this,o)}return(0,vt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_UpdateAnnotationMetaDataOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();ot.H_={T_:ot.getTypeName(),B_:ot.getBaseTypes()};var Ne=function(){function n(o){(0,mt.default)(this,n),m.assign(n,this,o)}return(0,vt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_UpdateOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Ne.H_={T_:Ne.getTypeName(),B_:Ne.getBaseTypes()};var Fe=function(){function n(o){(0,mt.default)(this,n),m.assign(n,this,o)}return(0,vt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_DeleteOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Fe.H_={T_:Fe.getTypeName(),B_:Fe.getBaseTypes()};var go=function(){function n(o){(0,mt.default)(this,n),m.assign(n,this,o)}return(0,vt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_PurgeOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();go.H_={T_:go.getTypeName(),B_:go.getBaseTypes()};var Cu=function(){function n(o){(0,mt.default)(this,n),m.assign(n,this,o)}return(0,vt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_FocusOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Cu.H_={T_:Cu.getTypeName(),B_:Cu.getBaseTypes()};var xu=function(){function n(o){(0,mt.default)(this,n),m.assign(n,this,o)}return(0,vt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_VisibilityOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();xu.H_={T_:xu.getTypeName(),B_:xu.getBaseTypes()};var Ot=function(){function n(o){(0,mt.default)(this,n),m.assign(n,this,o)}return(0,vt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_DeltaUpdateOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Ot.H_={T_:Ot.getTypeName(),B_:Ot.getBaseTypes()};var Tu=function(){function n(o){(0,mt.default)(this,n),m.assign(n,this,o)}return(0,vt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_MicroSyncOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Tu.H_={T_:Tu.getTypeName(),B_:Tu.getBaseTypes()};var Ze=function(){function n(o){(0,mt.default)(this,n),m.assign(n,this,o)}return(0,vt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Signals_SignalOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Ze.H_={T_:Ze.getTypeName(),B_:Ze.getBaseTypes()};g();var Iu=w(W()),_u=w(B());var Gt=function(){function n(o){(0,Iu.default)(this,n),m.assign(n,this,o)}return(0,_u.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Signals_Signal"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Gt.H_={T_:Gt.getTypeName(),B_:Gt.getBaseTypes()};var Rr=function(){function n(o){(0,Iu.default)(this,n),m.assign(n,this,o)}return(0,_u.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_DirtyAreaSignal"}},{key:"getBaseTypes",value:function(){return["AugLoop_Signals_Signal"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Rr.H_={T_:Rr.getTypeName(),B_:Rr.getBaseTypes()};g();var yt=w(W()),kt=w(B());var Au=function(){function n(o){(0,yt.default)(this,n),m.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_Blob"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Au.H_={T_:Au.getTypeName(),B_:Au.getBaseTypes()};var bu=function(){function n(o){(0,yt.default)(this,n),m.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_Binary"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();bu.H_={T_:bu.getTypeName(),B_:bu.getBaseTypes()};var Mu=function(){function n(o){(0,yt.default)(this,n),m.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_TileGroup"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Mu.H_={T_:Mu.getTypeName(),B_:Mu.getBaseTypes()};var Eu=function(){function n(o){(0,yt.default)(this,n),m.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_Session"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_TileGroup"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Eu.H_={T_:Eu.getTypeName(),B_:Eu.getBaseTypes()};var Mt=function(){function n(o){(0,yt.default)(this,n),m.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_Document"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_TileGroup"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Mt.H_={T_:Mt.getTypeName(),B_:Mt.getBaseTypes()};var Pn=function(){function n(o){(0,yt.default)(this,n),m.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_SubDocument"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Pn.H_={T_:Pn.getTypeName(),B_:Pn.getBaseTypes()};var sr=function(){function n(o){(0,yt.default)(this,n),m.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_GridCell"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();sr.H_={T_:sr.getTypeName(),B_:sr.getBaseTypes()};var Ru=function(){function n(o){(0,yt.default)(this,n),m.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_GridNeighborhoodContext"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Ru.H_={T_:Ru.getTypeName(),B_:Ru.getBaseTypes()};var Nu=function(){function n(o){(0,yt.default)(this,n),m.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_ItemFilter"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Nu.H_={T_:Nu.getTypeName(),B_:Nu.getBaseTypes()};var Du=function(){function n(o){(0,yt.default)(this,n),m.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_DynamicContext"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Du.H_={T_:Du.getTypeName(),B_:Du.getBaseTypes()};var oi=function(){function n(o){(0,yt.default)(this,n),m.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_ContextHolder"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();oi.H_={T_:oi.getTypeName(),B_:oi.getBaseTypes()};var ur=function(){function n(o){(0,yt.default)(this,n),m.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_UserContextHolder"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_ContextHolder"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();ur.H_={T_:ur.getTypeName(),B_:ur.getBaseTypes()};var lr=function(){function n(o){(0,yt.default)(this,n),m.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_TenantContextHolder"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_ContextHolder"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();lr.H_={T_:lr.getTypeName(),B_:lr.getBaseTypes()};var Wu=function(){function n(o){(0,yt.default)(this,n),m.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_EventsHolder"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Wu.H_={T_:Wu.getTypeName(),B_:Wu.getBaseTypes()};var ii=function(){function n(o){(0,yt.default)(this,n),m.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_UserCommandsHolder"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_EventsHolder"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();ii.H_={T_:ii.getTypeName(),B_:ii.getBaseTypes()};g();var Jd;(function(n){n[n.MastermindAsyncBoundaryLoader=0]="MastermindAsyncBoundaryLoader",n[n.TruncatedModelIteratingLoader=1]="TruncatedModelIteratingLoader",n[n.ExcelAsyncBoundaryLoader=2]="ExcelAsyncBoundaryLoader"})(Jd||(Jd={}));var Nr;(function(n){n[n.Filtering=0]="Filtering",n[n.ModelIterating=1]="ModelIterating"})(Nr||(Nr={}));g();var On;(function(n){n[n.Unknown=0]="Unknown",n[n.LiveId=1]="LiveId",n[n.OrgId=2]="OrgId",n[n.ActiveDirectory=3]="ActiveDirectory",n[n.ADAL=4]="ADAL",n[n.SSPI=5]="SSPI",n[n.OAuth2=6]="OAuth2",n[n.Badger=7]="Badger"})(On||(On={}));var mo;(function(n){n[n.Augloop=0]="Augloop",n[n.Substrate=1]="Substrate"})(mo||(mo={}));g();var ai;(function(n){var o;(function(e){e[e.Unknown=0]="Unknown",e[e.FullDocument=1]="FullDocument",e[e.PartialDocument=2]="PartialDocument"})(o=n.SensitiveTypeScope||(n.SensitiveTypeScope={}))})(ai||(ai={}));g();var fn;(function(n){n[n.Input=0]="Input",n[n.Exception=1]="Exception",n[n.WaitOn=2]="WaitOn",n[n.StopAndFilterWorkflow=3]="StopAndFilterWorkflow"})(fn||(fn={}));var ye;(function(n){n[n.Unknown=0]="Unknown",n[n.NoOutput=1]="NoOutput",n[n.Authentication=2]="Authentication",n[n.JoinTimedOut=3]="JoinTimedOut",n[n.LambdaThrow=4]="LambdaThrow",n[n.LambdaErrorCallback=5]="LambdaErrorCallback"})(ye||(ye={}));g();var Ln;(function(n){var o;(function(e){e[e.shape=0]="shape",e[e.groupShape=1]="groupShape",e[e.graphicFrame=2]="graphicFrame",e[e.connector=3]="connector",e[e.picture=4]="picture",e[e.ink=5]="ink"})(o=n.DrawingElementType||(n.DrawingElementType={}))})(Ln||(Ln={}));g();var si;(function(n){var o;(function(e){e[e.Undefined=0]="Undefined",e[e.Delete=1]="Delete",e[e.Add=2]="Add",e[e.Change=3]="Change",e[e.Refresh=4]="Refresh"})(o=n.SlideTileEventType||(n.SlideTileEventType={}))})(si||(si={}));g();var Fn;(function(n){var o;(function(u){u[u.Unknown=0]="Unknown",u[u.Text=1]="Text",u[u.Slide=2]="Slide"})(o=n.TileType||(n.TileType={}));var e;(function(u){u[u.Generic=0]="Generic",u[u.Title=1]="Title",u[u.SmartArt=2]="SmartArt",u[u.TableCell=3]="TableCell",u[u.TextBox=4]="TextBox",u[u.Notes=5]="Notes"})(e=n.TextTileType||(n.TextTileType={}));var r;(function(u){u[u.Undefined=0]="Undefined",u[u.Word=1]="Word",u[u.Phrase=2]="Phrase",u[u.Sentence=3]="Sentence",u[u.Paragraph=4]="Paragraph"})(r=n.TextTileElementUnit||(n.TextTileElementUnit={}));var t;(function(u){u[u.Undefined=0]="Undefined",u[u.Bullet=1]="Bullet",u[u.Numbered=2]="Numbered"})(t=n.ListType||(n.ListType={}));var a;(function(u){u[u.Undefined=0]="Undefined",u[u.AlphaLcParenBoth=1]="AlphaLcParenBoth",u[u.AlphaUcParenBoth=2]="AlphaUcParenBoth",u[u.AlphaLcParenR=3]="AlphaLcParenR",u[u.AlphaUcParenR=4]="AlphaUcParenR",u[u.AlphaLcPeriod=5]="AlphaLcPeriod",u[u.AlphaUcPeriod=6]="AlphaUcPeriod",u[u.ArabicParenBoth=7]="ArabicParenBoth",u[u.ArabicParenR=8]="ArabicParenR",u[u.ArabicPeriod=9]="ArabicPeriod",u[u.ArabicPlain=10]="ArabicPlain",u[u.RomanLcParenBoth=11]="RomanLcParenBoth",u[u.RomanUcParenBoth=12]="RomanUcParenBoth",u[u.RomanLcParenR=13]="RomanLcParenR",u[u.RomanUcParenR=14]="RomanUcParenR",u[u.RomanLcPeriod=15]="RomanLcPeriod",u[u.RomanUcPeriod=16]="RomanUcPeriod",u[u.CircleNumDbPlain=17]="CircleNumDbPlain",u[u.CircleNumWdBlackPlain=18]="CircleNumWdBlackPlain",u[u.CircleNumWdWhitePlain=19]="CircleNumWdWhitePlain",u[u.ArabicDbPeriod=20]="ArabicDbPeriod",u[u.ArabicDbPlain=21]="ArabicDbPlain",u[u.Ea1ChsPeriod=22]="Ea1ChsPeriod",u[u.Ea1ChsPlain=23]="Ea1ChsPlain",u[u.Ea1ChtPeriod=24]="Ea1ChtPeriod",u[u.Ea1ChtPlain=25]="Ea1ChtPlain",u[u.Ea1JpnChsDbPeriod=26]="Ea1JpnChsDbPeriod",u[u.Ea1JpnKorPlain=27]="Ea1JpnKorPlain",u[u.Ea1JpnKorPeriod=28]="Ea1JpnKorPeriod",u[u.Arabic1Minus=29]="Arabic1Minus",u[u.Arabic2Minus=30]="Arabic2Minus",u[u.Hebrew2Minus=31]="Hebrew2Minus",u[u.ThaiAlphaPeriod=32]="ThaiAlphaPeriod",u[u.ThaiAlphaParenR=33]="ThaiAlphaParenR",u[u.ThaiAlphaParenBoth=34]="ThaiAlphaParenBoth",u[u.ThaiNumPeriod=35]="ThaiNumPeriod",u[u.ThaiNumParenR=36]="ThaiNumParenR",u[u.ThaiNumParenBoth=37]="ThaiNumParenBoth",u[u.HindiAlphaPeriod=38]="HindiAlphaPeriod",u[u.HindiNumPeriod=39]="HindiNumPeriod",u[u.HindiNumParenR=40]="HindiNumParenR",u[u.HindiAlpha1Period=41]="HindiAlpha1Period"})(a=n.ListNumeration||(n.ListNumeration={}));var s;(function(u){u[u.Undefined=0]="Undefined",u[u.Delete=1]="Delete",u[u.Add=2]="Add",u[u.Change=3]="Change",u[u.Refresh=4]="Refresh"})(s=n.TextTileEventType||(n.TextTileEventType={}))})(Fn||(Fn={}));g();var wn;(function(n){n[n.Undefined=0]="Undefined",n[n.Schema=1]="Schema",n[n.Boolean=2]="Boolean",n[n.Number=3]="Number",n[n.String=4]="String",n[n.Buffer=5]="Buffer",n[n.Function=6]="Function"})(wn||(wn={}));g();var Yd=w(B()),Zd=w(W()),ep=w(qe()),tp=w(Ge()),Fu=w(De()),np=w(Lu());function $x(n){var o=Xx();return function(){var r=(0,Fu.default)(n),t;if(o){var a=(0,Fu.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,tp.default)(this,t)}}function Xx(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var fr;(function(n){n[n.JoinContext=0]="JoinContext",n[n.Session=1]="Session"})(fr||(fr={}));var vo=function(n){(0,ep.default)(e,n);var o=$x(e);function e(){var r,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"ExpectedError";return(0,Zd.default)(this,e),r=o.call(this,t),r.__proto__=e.prototype,r}return(0,Yd.default)(e)}((0,np.default)(Error));g();var ze;(function(n){n[n.error=0]="error",n[n.warn=1]="warn",n[n.info=3]="info",n[n.metric=4]="metric",n[n.verbose=5]="verbose",n[n.debug=6]="debug",n[n.disabled=7]="disabled"})(ze||(ze={}));g();var Et;(function(n){n[n.Active=0]="Active",n[n.Stopped=1]="Stopped",n[n.Paused=2]="Paused"})(Et||(Et={}));g();var pi;(function(n){n[n.ProductServiceUsage=2]="ProductServiceUsage",n[n.ProductServicePerformance=4]="ProductServicePerformance"})(pi||(pi={}));var Ca;(function(n){n[n.BasicEvent=10]="BasicEvent",n[n.FullEvent=100]="FullEvent",n[n.RequiredServiceDataEvent=110]="RequiredServiceDataEvent"})(Ca||(Ca={}));g();var q;(function(n){n[n.SingleItem=0]="SingleItem",n[n.Reduce=1]="Reduce",n[n.Grid=2]="Grid",n[n.DynamicText=3]="DynamicText",n[n.Join=4]="Join",n[n.Generic=5]="Generic"})(q||(q={}));var xa;(function(n){n[n.Default=0]="Default",n[n.Copilot=1]="Copilot"})(xa||(xa={}));var Wr;(function(n){n[n.Default=0]="Default",n[n.LocalOnly=1]="LocalOnly",n[n.Exclusive=2]="Exclusive"})(Wr||(Wr={}));var cn;(function(n){n[n.PreActivate=0]="PreActivate",n[n.Default=1]="Default",n[n.DelayActivate=1]="DelayActivate",n[n.NeverActivate=2]="NeverActivate"})(cn||(cn={}));var cr;(function(n){n[n.Required=-3]="Required",n[n.Optional=-1]="Optional"})(cr||(cr={}));var yo;(function(n){n[n.Never=0]="Never",n[n.Always=1]="Always"})(yo||(yo={}));var Zt;(function(n){n[n.PreSeed=1]="PreSeed",n[n.OnSeed=2]="OnSeed",n[n.PostSeed=4]="PostSeed",n[n.All=5]="All"})(Zt||(Zt={}));var Lt;(function(n){n[n.UpstreamWorkflowsReady=0]="UpstreamWorkflowsReady",n[n.AnnotationMetadataUpdated=1]="AnnotationMetadataUpdated",n[n.DeltaUpdate=2]="DeltaUpdate",n[n.NonExclusiveTriggerSignals=3]="NonExclusiveTriggerSignals"})(Lt||(Lt={}));var Sn;(function(n){n[n.Character=1]="Character",n[n.Paragraph=2]="Paragraph"})(Sn||(Sn={}));var en;(function(n){n.Input="Input",n.Delta="Delta",n.UILanguage="UILanguage",n.MaxInputCount="MaxInputCount"})(en||(en={}));var ko;(function(n){n.SetPredefinedAnnotation="SetPredefinedAnnotation",n.ClearAnnotations="ClearAnnotations"})(ko||(ko={}));g();var Ta;(function(n){n[n.Input=1]="Input",n[n.Output=2]="Output"})(Ta||(Ta={}));var rp;(function(n){n[n.Single=1]="Single",n[n.Any=-1]="Any",n[n.Optional=-2]="Optional",n[n.Some=-3]="Some"})(rp||(rp={}));g();var Hn;(function(n){n[n.WorkflowSession=0]="WorkflowSession",n[n.User=1]="User"})(Hn||(Hn={}));g();var Ia=w(W()),_a=w(B());var qu=function(){function n(o){(0,Ia.default)(this,n),m.assign(n,this,o)}return(0,_a.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Interfaces_AsyncBoundaryRequest"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();qu.H_={T_:qu.getTypeName(),B_:qu.getBaseTypes()};var hi=function(){function n(o){(0,Ia.default)(this,n),m.assign(n,this,o)}return(0,_a.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Interfaces_FilteringAsyncBoundaryRequest"}},{key:"getBaseTypes",value:function(){return["AugLoop_Interfaces_AsyncBoundaryRequest"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();hi.H_={T_:hi.getTypeName(),B_:hi.getBaseTypes()};var gi=function(){function n(o){(0,Ia.default)(this,n),m.assign(n,this,o)}return(0,_a.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Interfaces_ModelIteratingAsyncBoundaryRequest"}},{key:"getBaseTypes",value:function(){return["AugLoop_Interfaces_AsyncBoundaryRequest"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();gi.H_={T_:gi.getTypeName(),B_:gi.getBaseTypes()};g();g();var ap=w(B()),sp=w(W());g();var Aa;(function(n){n.Log="Log"})(Aa||(Aa={}));var Yx=typeof process!="undefined"&&process.env?process.env.SERVICE_NAME:"client",mi="abcdefghijklmnopqrstuvwxyz0123456789",vi={97:0,98:1,99:2,100:3,101:4,102:5,103:6,104:7,105:8,106:9,107:10,108:11,109:12,110:13,111:14,112:15,113:16,114:17,115:18,116:19,117:20,118:21,119:22,120:23,121:24,122:25,48:26,49:27,50:28,51:29,52:30,53:31,54:32,55:33,56:34,57:35},ba=[],Ma=[],Br,up=function(o){return null},lp=function(o){},So=new Map,Gu=new Map,Uu=new Map,Hu=new Map,v;(function(n){n.defineCoreLogCategory=function(o){return{root:"Core",name:o}},n.defineWorkflowLogCategory=function(o){return{root:"Workflow",name:o}},n.clearLoggers=function(){ba=[],Ma=[],Gu.clear(),Uu.clear()},n.clearAggregators=function(){So.clear()},n.addLogger=function(o){ba.indexOf(o)===-1&&(ba.push(o),op(Gu,o))},n.addDecidingLogger=function(o){Ma.indexOf(o)===-1&&(Ma.push(o),op(Uu,o))},n.setCorrelationContextCallback=function(o){Br=o},n.setStartPerformanceEventCallback=function(o){up=o},n.setStopPerformanceEventCallback=function(o){lp=o},n.addAggregator=function(o){o.init(function(e,r){yi(e,r)}),So.has(o.eventName)?So.get(o.eventName).push(o):So.set(o.eventName,[o])},n.flushAggregators=function(o){So.forEach(function(e){e.forEach(function(r){return r.flush(o)})})},n.setTagLevelOverride=function(o,e){var r=oT(o);Hu.set(r,e)},n.resetTagLevelOverrides=function(){Hu.clear()},n.error=function(o,e,r,t,a,s,u,l,f,c){wo(o,e,ze.error,r,t,a,s,u,l,f,c)},n.warn=function(o,e,r,t,a,s,u,l,f,c){wo(o,e,ze.warn,r,t,a,s,u,l,f,c)},n.info=function(o,e,r,t,a,s,u,l,f,c){wo(o,e,ze.info,r,t,a,s,u,l,f,c)},n.verbose=function(o,e,r,t,a,s,u,l,f,c){wo(o,e,ze.verbose,r,t,a,s,u,l,f,c)},n.debug=function(o,e,r,t,a,s,u,l,f,c){wo(o,e,ze.debug,r,t,a,s,u,l,f,c)},n.metric=function(o,e,r,t,a,s,u,l,f,c){wo(o,e,ze.metric,r,t,a,s,u,l,f,c)},n.formatMetric=function(o,e,r,t){var a={};return a[o]={dimensionNames:r,dimensionValues:t,value:e},a},n.dynamic=function(o){yi(o)}})(v||(v={}));var op=function(o,e){var r=e.level;Object.keys(ze).map(function(t){return ze[t]}).filter(function(t){return typeof t!="string"}).filter(function(t){return t<=r}).forEach(function(t){o.has(t)?o.get(t).push(e):o.set(t,[e])})},Zx=function(o,e,r,t,a,s,u,l){if(e===void 0&&(typeof o=="string"||typeof o=="object"))return o;if(e===void 0&&typeof o=="function")return o();var f=[];for(var c of[o,e,r,t,a,s,u,l])c!==void 0&&f.push(typeof c=="function"?c():c);return f},fp=function(o){if(typeof o=="string")return o;for(var e="",r=0;r<o.length;r++){r>0&&(e+=" ");var t=o[r];t instanceof Error?e+=JSON.stringify({message:t.message,name:t.name,stack:t.stack}):typeof t=="object"?e+=JSON.stringify(t):e+=t}return e},cp=[],eT=["Level","Tag"],tT=["Level","Tag","Workflow"],Ea=function(o){return zu(o).length},zu=function(o){return o!==void 0?Gu.get(o)||cp:ba},nT=function(o,e){var r=o!==void 0?Uu.get(o)||[]:Ma;return r.filter(function(t){return t.shouldLog(e)})},wo=function(o,e,r,t,a,s,u,l,f,c,d){r=Hu.get(o)||r;var h=zu(r),p=nT(r,t);if(!(h.length==0&&p.length==0)){var k=up(Aa.Log),S=dp(o),C=Zx(t,a,s,u,l,f,c,d);if(rT(e))ip(C)&&yi({eventName:"Metrics",tagId:S,category:e.root+"."+e.name,traceLevel:r,message:"",getMetrics:function(){return C}},!1,h,p);else if(ip(C)){var T=C;T.tagId=S,T.category=e.root+"."+e.name,T.eventName==="Operation"&&e.root==="Workflow"&&(T.eventName="WorkflowOperation",Br&&(T.joinContextId=Br().joinContextId)),T.traceLevel=r;var x=So.get(T.eventName);if(x)for(var A=0;A<x.length;++A){var b=x[A];if(b&&b.add(T,A===x.length-1))break}else yi(T,!1,h,p)}else{var E=function(){var _;return e.root==="Core"?{TraceEventV2:{dimensionNames:function(){return eT},dimensionValues:[String(r),S],value:1}}:{WorkflowTraceEvent:{dimensionNames:function(){return tT},dimensionValues:[String(r),S,Br?(_=Br())===null||_===void 0?void 0:_.workflow:""],value:1}}};yi({eventName:"Log",tagId:S,category:e.root+"."+e.name,traceLevel:r,message:fp(C),getMetrics:E},!1,h,p)}lp(k)}},yi=function(o){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,r=arguments.length>2?arguments[2]:void 0,t=arguments.length>3?arguments[3]:void 0,a,s,u,l,f;if(r==null&&(r=zu(o.traceLevel)),t=t||cp,r.length>0||t.length>0){if(o.serviceName=Yx,!e&&Br){var c=Br();if(c){o.cv=o.cv?o.cv:c.cv.toString(),o.sessionKey=o.sessionKey?o.sessionKey:c.sessionKey,o.workflow=o.workflow?o.workflow:c.workflow;var d=(a=c.clientMetadata)===null||a===void 0?void 0:a.appName;o.clientAppName=o.clientAppName?o.clientAppName:d;var h=(s=c.clientMetadata)===null||s===void 0?void 0:s.appPlatform;o.clientAppPlatform=o.clientAppPlatform?o.clientAppPlatform:h;var p=(u=c.clientMetadata)===null||u===void 0?void 0:u.releaseAudienceGroup;o.clientReleaseAudienceGroup=o.clientReleaseAudienceGroup?o.clientReleaseAudienceGroup:p;var k=(l=c.clientMetadata)===null||l===void 0?void 0:l.flights;(f=o.clientFlights)!==null&&f!==void 0||(o.clientFlights=k)}}for(var S of r)S.log(o);for(var C of t)C.log(o)}},rT=function(o){return o.name===y.WorkflowMetricsOnly.name&&o.root===y.WorkflowMetricsOnly.root},ip=function(o){return!Array.isArray(o)&&typeof o=="object"},dp=function(o){return mi[o>>24&63]+mi[o>>18&63]+mi[o>>12&63]+mi[o>>6&63]+mi[o>>0&63]},oT=function(o){return o&&o.length===5?vi[o.charCodeAt(0)]<<24|vi[o.charCodeAt(1)]<<18|vi[o.charCodeAt(2)]<<12|vi[o.charCodeAt(3)]<<6|vi[o.charCodeAt(4)]:-1},y=(0,ap.default)(function n(){(0,sp.default)(this,n)});y.CoreDefault=v.defineCoreLogCategory("Default");y.CoreSystem=v.defineCoreLogCategory("System");y.WorkflowDefault=v.defineWorkflowLogCategory("Default");y.WorkflowUnsampled=v.defineWorkflowLogCategory("Unsampled");y.WorkflowMetricsOnly=v.defineWorkflowLogCategory("MetricsOnly");y.PrivacyGuardEvent=v.defineCoreLogCategory("PrivacyGuardEvent");g();var vp=w(W()),yp=w(B()),kp=w(qe()),wp=w(Ge()),Ku=w(De());g();var Vu={util:{},roots:{default:{}}},tR=Vu.util,nR=Vu.roots.default||(Vu.roots.default={}),pp=function(){function n(o){if(o)for(var e in o)o[e]!=null&&(this[e]=o[e])}return n.prototype.count=0,n.prototype.cv="",n.prototype.serviceName="",n.prototype.sessionKey="",n.prototype.durationMs=0,n.prototype.success=!1,n.prototype.resultDescription="",n.prototype.resultJSON="",n.prototype.resultSignature="",n.prototype.operationName="",n.prototype.resourceId="",n.prototype.dimension0="",n.prototype.dimension1="",n.prototype.dimension2="",n.prototype.dimension3="",n.prototype.clientAppName="",n.prototype.clientAppPlatform="",n.prototype.clientRuntimeVersion="",n.prototype.clientAppVersion="",n.prototype.clientReleaseAudienceGroup="",n.prototype.clientReleaseChannel="",n.prototype.clientReleaseFork="",n.prototype.clientSessionId="",n.prototype.clientFlights="",n.prototype.clientIPRange="",n.prototype.clientDocSessionId="",n.prototype.clientDeviceId="",n.prototype.clientUserAgent="",n.prototype.userType="",n.prototype.userId="",n.prototype.userTenantId="",n.prototype.joinContextId="",n.prototype.ariaTenant="",n.prototype.ariaNamespace="",n.prototype.dataFields="",n}();g();var Qu={util:{},roots:{default:{}}},iR=Qu.util,aR=Qu.roots.default||(Qu.roots.default={}),hp=function(){function n(o){if(o)for(var e in o)o[e]!=null&&(this[e]=o[e])}return n.prototype.sessionKey="",n.prototype.annotationType="",n.prototype.annotationState=0,n.prototype.workflowId="",n}();g();var ju={util:{},roots:{default:{}}},lR=ju.util,fR=ju.roots.default||(ju.roots.default={}),gp=function(){function n(o){if(o)for(var e in o)o[e]!=null&&(this[e]=o[e])}return n.prototype.cv="",n.prototype.sessionKey="",n.prototype.healthy=!1,n.prototype.fullLogs=!1,n.prototype.clientAppName="",n.prototype.clientAppPlatform="",n.prototype.clientAppVersion="",n.prototype.clientSessionId="",n.prototype.clientRuntimeVersion="",n.prototype.clientReleaseAudienceGroup="",n.prototype.clientDeviceId="",n.prototype.clientUserAgent="",n.prototype.userType="",n.prototype.userId="",n.prototype.protocolVersion=0,n.prototype.totalDurationMs=0,n.prototype.idleDurationMs=0,n.prototype.closeReason="",n.prototype.firstClientConnectionDurationMs=0,n.prototype.seedMode="",n.prototype.seedSuccess=!1,n.prototype.seedItems=0,n.prototype.seedBatchSize=0,n.prototype.seedGroupSize=0,n.prototype.seedDurationMs=0,n.prototype.sendMessageCount=0,n.prototype.sendMessageErrors=0,n.prototype.sendMessageWarnings=0,n.prototype.sendMessageDurationMsMax=0,n.prototype.processMessageCount=0,n.prototype.processMessageErrors=0,n.prototype.processMessageWarnings=0,n.prototype.processMessageDurationMsMax=0,n.prototype.syncMessageCount=0,n.prototype.syncMessagesOutOfSequence=0,n.prototype.syncMessagesAbandoned=0,n.prototype.syncMessagesIgnored=0,n.prototype.syncMessageQueueLimitReached=!1,n.prototype.modelItemsMax=0,n.prototype.modelConsistencyErrors=0,n.prototype.estimatedSizeMax=0,n.prototype.estimatedSizeCorrect=!1,n.prototype.modelItemsCountBucket="",n.prototype.modelConsistencyErrorsAndWarnings=0,n.prototype.modelConsistencyQuietStateValid=!1,n.prototype.modelConsistencyQuietStateWarnings=0,n.prototype.modelConsistencyQuietStateErrors=0,n.prototype.documentUrlAvailable=!1,n.prototype.workflowsRegistered=0,n.prototype.workflowExecutions=0,n.prototype.workflowExecutionErrors=0,n.prototype.workflowExecutionDurationMsMax=0,n.prototype.workflowExecutionInfraErrors=0,n.prototype.annotationTypesActivated=0,n.prototype.annotationsAdded=0,n.prototype.annotationsUpdated=0,n.prototype.annotationsDeleted=0,n.prototype.augLoopLowPrivilegeTokenExistenceStatus="",n.prototype.augLoopLowPrivilegeTokenFirstArrivalDurationMs=0,n.prototype.wacTokenProvisionTokenExistenceStatus="",n.prototype.wacTokenProvisionTokenFirstArrivalDurationMs=0,n.prototype.seedingWorkflowPerformanceTimesValid=!1,n.prototype.timeFromFirstSeedMessageToFirstWorkflowFinishedMs=0,n.prototype.timeFromFirstSeedMessageToFirstAnnotationMs=0,n.prototype.timeFromFirstSeedMessageToLastAnnotationMs=0,n.prototype.timeFromFirstSeedMessageToLastWorkflowFinishedMs=0,n.prototype.timeFromLastSeedMessageToLastAnnotationMs=0,n.prototype.timeFromLastSeedMessageToLastWorkflowFinishedMs=0,n.prototype.syncMessagesWorkflowPerformanceNotMeasured=0,n.prototype.timeToAllWorkflowsFinishedMsMax=0,n.prototype.timeFromSessionStartToLastWorkflowFinishedMs=0,n.prototype.healthBucket="",n.prototype.coreHealthBucket="",n.prototype.coreHealthReason="",n.prototype.coreHealthBucketWithSuppressions="",n.prototype.coreHealthReasonWithSuppressions="",n.prototype.healthReason="",n.prototype.healthReasonCategory="",n.prototype.healthBucketWithSuppressions="",n.prototype.healthReasonWithSuppressions="",n.prototype.healthReasonCategoryWithSuppressions="",n.prototype.eventAnalysisFindings="",n.prototype.mappedHealthBucketsToReasons="",n}();g();var Ju={util:{},roots:{default:{}}},pR=Ju.util,hR=Ju.roots.default||(Ju.roots.default={}),mp=function(){function n(o){if(o)for(var e in o)o[e]!=null&&(this[e]=o[e])}return n.prototype.cv="",n.prototype.serviceName="",n.prototype.sessionKey="",n.prototype.clientAppName="",n.prototype.clientAppPlatform="",n.prototype.clientRuntimeVersion="",n.prototype.clientAppVersion="",n.prototype.clientReleaseAudienceGroup="",n.prototype.clientReleaseChannel="",n.prototype.clientReleaseFork="",n.prototype.clientSessionId="",n.prototype.clientFlights="",n.prototype.clientIPRange="",n.prototype.clientDocSessionId="",n.prototype.clientDeviceId="",n.prototype.clientUserAgent="",n.prototype.userType="",n.prototype.userId="",n.prototype.sessionHealthEventName="",n.prototype.source="",n.prototype.reason="",n.prototype.reasonDependency="",n.prototype.subReason="",n.prototype.impact="",n.prototype.success=!1,n.prototype.durationMs=0,n.prototype.count=0,n.prototype.message="",n.prototype.affectedWorkflows="",n.prototype.resourceId="",n.prototype.dimension0="",n.prototype.dimension1="",n.prototype.dimension2="",n.prototype.dimension3="",n.prototype.resultDescription="",n.prototype.resultSignature="",n.prototype.joinContextId="",n}();g();var iT=1e3,aT=1e6,Ht=function(){return typeof process!="undefined"&&process.hrtime?function(){var n=process.hrtime();return n[0]*iT+n[1]/aT}:typeof performance!="undefined"&&performance.now?function(){return performance.now()}:function(){return Date.now()}}();function sT(n){var o=uT();return function(){var r=(0,Ku.default)(n),t;if(o){var a=(0,Ku.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,wp.default)(this,t)}}function uT(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var D=function(n){(0,kp.default)(e,n);var o=sT(e);function e(r,t){var a;return(0,vp.default)(this,e),a=o.call(this,r),a.eventName="Operation",a.options=t,a.durationMs=r==null?void 0:r.durationMs,(!r||r.count==null)&&(a.count=1),a}return(0,yp.default)(e,[{key:"setClientMetadata",value:function(t){return t&&(this.clientAppName=t.appName,this.clientAppPlatform=t.appPlatform,this.clientAppVersion=t.appVersion,this.clientFlights=t.flights,this.clientReleaseAudienceGroup=t.releaseAudienceGroup,this.clientReleaseChannel=t.releaseChannel,this.clientReleaseFork=t.releaseFork,this.clientRuntimeVersion=t.runtimeVersion,this.clientSessionId=t.sessionId,this.clientDocSessionId=t.docSessionId,this.clientDeviceId=t.deviceId,this.clientUserAgent=t.userAgent),this}},{key:"setUserContext",value:function(t){return t&&(this.userId=t.puid||t.oid,this.userType=t.userType&&t.userType.toString(),this.userTenantId=t.tid),this}},{key:"setMetricCustomDimensions",value:function(t,a){if(!this.options)throw new Error("Attempting to set custom dimensions "+t+" to operation "+this.operationName+" without activating MetricCount or MetricDuration");this.options.metricCustomDimensions=this.options.metricCustomDimensions||{},this.options.metricCustomDimensions[t]=a}},{key:"setDataField",value:function(t,a){var s=this.dataFields?JSON.parse(this.dataFields):{};s[t]=a,this.dataFields=JSON.stringify(s)}},{key:"setDataFields",value:function(t){this.dataFields?this.dataFields=JSON.stringify(Object.assign(Object.assign({},JSON.parse(this.dataFields)),t)):this.dataFields=JSON.stringify(t)}},{key:"start",value:function(){return this.startTime=Ht(),this}},{key:"stop",value:function(){var t=Ht();return this.durationMs=Math.round(t-this.startTime),this}},{key:"getMetrics",value:function(t){var a,s,u={};if(this.operationName)switch(this.operationName){case"SessionHealthOrphanedEventsWithoutProperSessionKey":case"SessionHealthOrphanedSessions":case"WorkflowActivationState":u[this.operationName+".CountV2"]={dimensionNames:e.getOrphanedSessionHealthDimensionNames.bind(e),dimensionValues:this.getOrphanedSessionHealthDimensionValues(),value:this.count};break;case"MarkUnhealthySession":case"MarkHealthWarningSession":u[this.operationName+".Reason"]={dimensionNames:e.getSessionHealthDimensionNames.bind(e),dimensionValues:this.getSessionHealthDimensionValues(),value:1};break;default:if(this.operationName==="matchmaker_timer"&&(u["Workflow.DurationMs"]={dimensionNames:e.getWorkflowDimensionNames.bind(e),dimensionValues:this.getWorkflowDimensionValues(),value:this.durationMs||0},u["Workflow.Count"]={dimensionNames:e.getWorkflowDimensionNames.bind(e),dimensionValues:this.getWorkflowDimensionValues(),value:1}),this.durationMs!==void 0){var l=this.operationName+".DurationMsV2";(!((a=this.options)===null||a===void 0)&&a.metricDuration||t.indexOf(l)>=0)&&(u[l]={dimensionNames:this.getDimensionNames.bind(this),dimensionValues:this.getDimensionValues(),value:this.durationMs})}{var f=this.operationName+".CountV2";(!((s=this.options)===null||s===void 0)&&s.metricCount||t.indexOf(f)>=0)&&(u[f]={dimensionNames:this.getDimensionNames.bind(this),dimensionValues:this.getDimensionValues(),value:this.count})}}return u}},{key:"getDimensionNames",value:function(){var t,a,s=e.dimensionNames;if(!((t=this.options)===null||t===void 0)&&t.metricCustomDimensions){s=s.slice();for(var u in(a=this.options)===null||a===void 0?void 0:a.metricCustomDimensions)s.push(u)}return s}},{key:"getDimensionValues",value:function(){var t,a,s=[this.success,this.clientAppName,this.clientAppPlatform,this.resourceId,this.dimension0,this.dimension1,this.dimension2,this.dimension3];if(!((t=this.options)===null||t===void 0)&&t.metricCustomDimensions)for(var u in(a=this.options)===null||a===void 0?void 0:a.metricCustomDimensions)s.push(this.options.metricCustomDimensions[u]);return s}},{key:"getOrphanedSessionHealthDimensionValues",value:function(){return[this.success,this.clientAppName,this.clientAppPlatform,this.clientReleaseAudienceGroup,this.resourceId,this.dimension0,this.dimension1,this.dimension2,this.dimension3]}},{key:"getSessionHealthDimensionValues",value:function(){return[this.resultSignature,this.clientAppName,this.clientAppPlatform,this.clientAppVersion,this.dimension0,this.dimension1,this.dimension2,this.dimension3]}},{key:"getWorkflowDimensionValues",value:function(){return[this.resultSignature,this.resourceId,this.resourceId,this.success]}}],[{key:"getOrphanedSessionHealthDimensionNames",value:function(){return this.orphanedSessionHealthDimensionNames}},{key:"getSessionHealthDimensionNames",value:function(){return this.sessionHealthDimensionNames}},{key:"getWorkflowDimensionNames",value:function(){return this.workflowDimensionNames}}]),e}(pp);D.dimensionNames=["Success","ClientAppName","ClientAppPlatform","ResourceId","Dimension0","Dimension1","Dimension2","Dimension3"];D.orphanedSessionHealthDimensionNames=["Success","ClientAppName","ClientAppPlatform","ClientReleaseAudienceGroup","ResourceId","Dimension0","Dimension1","Dimension2","Dimension3"];D.sessionHealthDimensionNames=["Reason","ClientAppName","ClientAppPlatform","ClientAppVersion","Dimension0","Dimension1","Dimension2","Dimension3"];D.workflowDimensionNames=["ResultSignature","WorkflowId","ResourceId","Success"];g();var _p=w(W()),Ap=w(B());g();var xp=w(W()),Tp=w(B()),We=function(){function n(o){(0,xp.default)(this,n),this.childCount=0,this.id=o||lT()}return(0,Tp.default)(n,[{key:"newChild",value:function(){return++this.childCount,new n(this.id+"."+this.childCount.toString())}},{key:"toString",value:function(){return this.id.length>127?this.id.substring(0,127)+"!":this.id}}],[{key:"fromString",value:function(e,r){if(!e)throw new Error("Received invalid correlation vector string");var t;return e.endsWith(".0")?t=new n(e.substring(0,e.length-2)):t=new n(e),r&&(t.childCount=r),t}}]),n}(),Sp=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],Ip=22,Cp=new Array(Ip);function lT(){for(var n=0;n<Ip;n++)Cp[n]=Sp[Math.floor(Math.random()*Sp.length)];return Cp.join("")}g();function $u(n,o){return JSON.stringify}var Pr=function(){function n(o,e,r,t,a,s,u){(0,_p.default)(this,n),this.cv=o,this.sessionDescriptor=e,this.clientMetadata=r,this.workflow=t,this.joinContextId=a,this.performanceEvent=s,this.sessionLogsSampled=u}return(0,Ap.default)(n,[{key:"sessionKey",get:function(){var e;return(e=this.sessionDescriptor)===null||e===void 0?void 0:e.sessionKey}},{key:"toString",value:function(){var e,r;return((e=this.clientMetadata)===null||e===void 0?void 0:e.appName)+";"+((r=this.clientMetadata)===null||r===void 0?void 0:r.appPlatform)+";"+this.sessionKey+";"+this.cv}},{key:"serialize",value:function(){var e,r,t,a,s,u=(e=this.clientMetadata)===null||e===void 0?void 0:e.appName,l=(r=this.clientMetadata)===null||r===void 0?void 0:r.appPlatform,f=(t=this.clientMetadata)===null||t===void 0?void 0:t.releaseAudienceGroup,c=(a=this.clientMetadata)===null||a===void 0?void 0:a.flights;return n.stringify(Object.assign(Object.assign({cv:this.cv.toString()},(s=this.sessionDescriptor)!==null&&s!==void 0?s:{}),{clientAppName:u,clientAppPlatform:l,clientReleaseAudienceGroup:f,clientFlights:c,workflow:this.workflow,joinContextId:this.joinContextId}))}},{key:"newChild",value:function(){return new n(this.cv.newChild(),this.sessionDescriptor,this.clientMetadata,this.workflow,this.joinContextId,void 0,this.sessionLogsSampled)}}],[{key:"deserialize",value:function(e){if(e)try{var r=JSON.parse(e),t={appName:r.clientAppName,appPlatform:r.clientAppPlatform,releaseAudienceGroup:r.clientReleaseAudienceGroup,flights:r.clientFlights};return new n(new We(r.cv),{sessionKey:r.sessionKey,userId:r.userId,mastermindEndpoint:r.mastermindEndpoint},t,r.workflow,r.joinContextId)}catch(a){return new n(new We(e))}}}]),n}();Pr.schema={type:"object",properties:{cv:{type:"string"},clientAppName:{type:"string"},clientAppPlatform:{type:"string"},clientReleaseAudienceGroup:{type:"string"},clientFlights:{type:"string"},sessionKey:{type:"string"},userId:{type:"string"},mastermindEndpoint:{type:"string"},workflow:{type:"string"},joinContextId:{type:"string"}}};Pr.stringify=$u(Pr.schema);g();var Yu=w(B()),Zu=w(W()),bp="|",Mp="b~",fT="b~true",Xu="n~",cT=/\|\~/g,dT="_",pT=(0,Yu.default)(function n(){(0,Zu.default)(this,n),this.count=0,this.measureSums=new Map}),el=(0,Yu.default)(function n(o,e,r,t,a){var s=this;(0,Zu.default)(this,n),this.buckets=new Map,this.init=function(u){s.log=u},this.add=function(u){var l=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;if(!s.condition||!s.condition(u))return l===!0&&s.log(u,!1),!1;var f=[];for(var c of s.dimensions)if(u[c]===void 0||u[c]===null)f.push(null);else{var d="";typeof u[c]=="boolean"?d=Mp:typeof u[c]=="number"&&(d=Xu),f.push(""+d+u[c].toString().replace(cT,dT))}var h=f.join(bp),p=s.buckets.get(h);if(!p){p=new pT,p.traceLevel=u.traceLevel;for(var k of s.avgMeasures)p.measureSums.set(k,0);s.buckets.set(h,p)}p.count++;for(var S of s.avgMeasures)u[S]&&p.measureSums.set(S,p.measureSums.get(S)+u[S]);return!0},this.flush=function(){var u=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;s.buckets.forEach(function(l,f){for(var c={traceLevel:l.traceLevel,eventName:s.eventName,count:l.count},d=f.split(bp),h=0;h<s.dimensions.length;h++){var p=s.dimensions[h],k=d[h];k.indexOf(Mp)===0?c[p]=k===fT:k.indexOf(Xu)===0?c[p]=parseInt(k.slice(Xu.length),10):c[p]=k}for(var S of s.avgMeasures)c[S]=Math.round(l.measureSums.get(S)/l.count);s.log(c,!0)}),s.buckets.clear(),u&&(s.condition=null,clearInterval(s.interval))},this.eventName=o,this.condition=e,this.dimensions=r,this.avgMeasures=t,a>0&&(this.interval=setInterval(this.flush,a*1e3))});g();var Ep=w(B()),Rp=w(W()),Np=w(qe()),Dp=w(Ge()),tl=w(De());function hT(n){var o=gT();return function(){var r=(0,tl.default)(n),t;if(o){var a=(0,tl.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,Dp.default)(this,t)}}function gT(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var ki=function(n){(0,Np.default)(e,n);var o=hT(e);function e(r){var t;return(0,Rp.default)(this,e),t=o.call(this,r),t.eventName="AnnotationMetaDataChange",t}return(0,Ep.default)(e)}(hp);g();var Wp=w(W()),Bp=w(B()),Pp=w(qe()),Op=w(Ge()),nl=w(De());function mT(n){var o=vT();return function(){var r=(0,nl.default)(n),t;if(o){var a=(0,nl.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,Op.default)(this,t)}}function vT(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var pe;(function(n){n[n.Unknown=0]="Unknown",n[n.Core=1]="Core",n[n.Workflow=2]="Workflow",n[n.SessionExtension=3]="SessionExtension",n[n.Client=4]="Client",n[n.ClientRuntime=5]="ClientRuntime"})(pe||(pe={}));var Y;(function(n){n[n.Unknown=0]="Unknown",n[n.Core=1]="Core",n[n.Workflow=2]="Workflow",n[n.SessionExtension=3]="SessionExtension",n[n.Client=4]="Client",n[n.Network=5]="Network",n[n.AugLoopDependency=6]="AugLoopDependency",n[n.WorkflowDependency=7]="WorkflowDependency",n[n.ClientRuntime=8]="ClientRuntime"})(Y||(Y={}));var he;(function(n){n[n.Unknown=0]="Unknown",n[n.None=1]="None",n[n.MissingInput=2]="MissingInput",n[n.MissingOutput=3]="MissingOutput"})(he||(he={}));var _e=function(n){(0,Pp.default)(e,n);var o=mT(e);function e(r,t){var a;(0,Wp.default)(this,e);var s,u;return a=o.call(this,{source:pe[r.source],reason:Y[r.reason],reasonDependency:r.reasonDependency,subReason:r.subReason,sessionHealthEventName:r.sessionHealthEventName,impact:he[r.impact],success:r.success,durationMs:(s=r.durationMs)!==null&&s!==void 0?s:0,count:typeof r.count=="number"?r.count:1,message:r.message,affectedWorkflows:((u=r.affectedWorkflows)!==null&&u!==void 0?u:[]).join(","),resourceId:r.resourceId,dimension0:r.dimension0,dimension1:r.dimension1,dimension2:r.dimension2,dimension3:r.dimension3,cv:r.cv,resultSignature:r.resultSignature,resultDescription:r.resultDescription,joinContextId:r.joinContextId}),a.eventName="SessionHealth",t&&a.setClientMetadata(t),a.metricCount=r.metricCount,a.metricDuration=r.metricDuration,a}return(0,Bp.default)(e,[{key:"getMetrics",value:function(){var t={};return(this.metricCount===void 0||this.metricCount)&&(t[this.sessionHealthEventName+".CountV2"]={dimensionNames:function(){return e.dimensionNames},dimensionValues:this.getDimensionValues(),value:this.count}),(this.metricDuration===void 0||this.metricDuration)&&(t[this.sessionHealthEventName+".DurationMsV2"]={dimensionNames:function(){return e.dimensionNames},dimensionValues:this.getDimensionValues(),value:this.durationMs}),t}},{key:"setClientMetadata",value:function(t){return t&&(this.clientAppName=t.appName,this.clientAppPlatform=t.appPlatform,this.clientAppVersion=t.appVersion,this.clientFlights=t.flights,this.clientReleaseAudienceGroup=t.releaseAudienceGroup,this.clientReleaseChannel=t.releaseChannel,this.clientReleaseFork=t.releaseFork,this.clientRuntimeVersion=t.runtimeVersion,this.clientSessionId=t.sessionId,this.clientDocSessionId=t.docSessionId,this.clientUserAgent=t.userAgent,this.clientDeviceId=t.deviceId),this}},{key:"setReason",value:function(t){return this.reason=Y[t],this}},{key:"setSource",value:function(t){return this.source=pe[t],this}},{key:"setImpact",value:function(t){return this.impact=he[t],this}},{key:"setAffectedWorkflows",value:function(t){return this.affectedWorkflows=(t!=null?t:[]).join(","),this}},{key:"getAffectedWorkflows",value:function(){return this.affectedWorkflows.split(",")}},{key:"start",value:function(){return this.startTime=Ht(),this}},{key:"stop",value:function(){var t=Ht();return this.durationMs=Math.round(t-this.startTime),this}},{key:"getDimensionValues",value:function(){var t;return[this.clientAppName,this.clientAppPlatform,this.clientAppVersion,this.success?"1":"0",this.reason+"_"+this.reasonDependency,this.impact,(t=this.getAffectedWorkflows()[0])!==null&&t!==void 0?t:"",this.resourceId,this.dimension0,this.dimension1,this.dimension2,this.dimension3]}}]),e}(mp);_e.dimensionNames=["ClientAppName","ClientAppPlatform","ClientAppVersion","Success","Reason","Impact","FirstAffectedWorkflow","ResourceId","Dimension0","Dimension1","Dimension2","Dimension3"];g();var it=new Pr(new We),Ra=[];var yT=function(o){Ra.push(it),it=o},kT=function(o){if(it===o){it=Ra.pop();return}var e=Ra.lastIndexOf(o);if(e<0)throw new Error("Context not found");if(e===0)throw new Error("Cannot remove top context");Ra.splice(e,1)};var et=function(){return it};var rl=function(){var o=it&&it.cv&&it.cv.newChild()||void 0,e=it&&it.sessionDescriptor||void 0,r=it&&it.clientMetadata||void 0,t=it&&it.workflow||void 0,a=it&&it.joinContextId||void 0,s=it&&it.sessionLogsSampled||void 0;return new Pr(o||new We,e,r,t,a,void 0,s)},zn=function(o){var e=rl();return Re(function(r){return o(r&&r.cv||void 0)},e)},Na=function(o,e,r,t,a,s){var u=new Pr(e?We.fromString(e):new We,r,t,a,s);return Re(o,u)},Re=function(o,e){yT(e);try{return o(e)}finally{kT(e)}};g();g();var Lp=w(W()),Fp=w(B()),Cn=function(){function n(o){if((0,Lp.default)(this,n),this.cache=new Map,this.options=o||{sweepInterval:100},this.options.idleDurationMs!=null&&this.options.idleDurationMs<=0)throw new Error("Idle duration must be positive");if(this.interval=this.options.sweepInterval||100,this.interval<=0)throw new Error("Sweep interval must be a positive number")}return(0,Fp.default)(n,[{key:"put",value:function(e,r,t,a,s,u,l){if(t==null||t<=0)throw new Error("Cache timeout must be a positive number");(s==null||s<=0)&&(s=this.options.idleDurationMs);var f={value:r,lastUsed:s?Date.now():void 0,expire:t+Date.now(),idleDurationMs:s,expireCallback:a,expiringTriggerTime:u+Date.now(),expiringCallback:l};return this.cache.set(e,f),this.timeout||(this.timeout=setInterval(this.onInterval.bind(this),this.interval),this.timeout.unref&&this.timeout.unref()),r}},{key:"del",value:function(e){if(this.options.delCallback){var r=this.cache.get(e);r&&this.options.delCallback(e,r.value)}var t=this.cache.delete(e);return this.size()===0&&this.clear(),t}},{key:"clear",value:function(){this.timeout&&(clearInterval(this.timeout),this.timeout=void 0),this.cache.clear()}},{key:"get",value:function(e){var r=this.cache.get(e);if(r)return this.options.idleDurationMs&&(r.lastUsed=Date.now()),r.value}},{key:"keys",value:function(){return this.cache.keys()}},{key:"forEach",value:function(e){this.cache.forEach(function(r,t){e(r.value,t)})}},{key:"size",value:function(){return this.cache.size}},{key:"updateExpireTime",value:function(e,r){return this.cache.has(e)&&r>=0?(this.cache.get(e).expire=r+Date.now(),!0):!1}},{key:"onInterval",value:function(){var e=this,r=Date.now();this.cache.forEach(function(t,a){if(t.idleDurationMs&&t.lastUsed<r-t.idleDurationMs){e.del(a),e.options.idleCallback&&e.options.idleCallback(a,t.value);return}t.expire<r&&(e.del(a),t.expireCallback&&t.expireCallback(a,t.value)),t.expiringTriggerTime<r&&t.expiringCallback&&(t.expiringCallback(a,t.value),t.expiringCallback=void 0)})}}]),n}();g();g();var ua=w(Ie()),Xc=w(W()),Yc=w(B());g();var wT={category:wn.Schema,schema:{name:"Exception",path:"message-schema.proto"}},uN={category:wn.Schema,schema:{name:"Filter",path:"message-schema.proto"}},Or=function(o){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(o==null)return"Invalid message passed";if(o.payload==null)return ye[ye.NoOutput]+": Payload is null";if(o.payload.exceptionType==null)return"Payload is not an exception";var r=ye[o.payload.exceptionType];return r+=o.payload.message?": "+o.payload.message:": No description",r+=e&&o.payload.data?`
`+o.payload.data.toString():"",r},qp=function(o){return o==null||o.payload==null||o.payload.exceptionType==null?ye.Unknown:o.payload.exceptionType},Vn=function(o,e){if(o==null)throw new Error("Cannot set exception on null message");o.payload=e,o.payloadSchema=wT,o.messageType=fn.Exception};g();g();var Gp=w(Ye()),Up=w(W()),Hp=w(B());var wi;(function(n){n[n.ExceedingMaxSize=0]="ExceedingMaxSize",n[n.GroupComplete=1]="GroupComplete",n[n.BatchIntervalElapsed=2]="BatchIntervalElapsed"})(wi||(wi={}));var Co=function(){function n(o,e){(0,Up.default)(this,n),this.batchesByGroupingKey=new Map,this.submit=o,this.onSummary=e}return(0,Hp.default)(n,[{key:"addBatchItem",value:function(e,r,t,a,s,u){var l=this,f=r.delayMs,c=r.delayMsMax,d=r.maxInputSize,h=r.estimateSize,p=r.groupingKeyExtractor,k=h(e),S=p(e);if(r.split&&k>d){var C;try{C=r.split(e)}catch(M){var T=new Error("Split error: "+M.message);u?u(T):v.error(573366352,y.CoreDefault,T);return}if(C&&Array.isArray(C.inputs)&&C.inputs.length>1){for(var x,A=[],b=u?function(M,N){if(x=x||M,A.push(N),A.length===C.inputs.length){var R;try{R=C.join(A)}catch(P){u(new Error("Join error: "+P.message));return}u(x,R)}}:void 0,E=0;E<C.inputs.length;E++){var I=C.inputs[E];this.addBatchItem(I,r,t,a,s&&E===C.inputs.length-1,b)}return}}var _=this.batchesByGroupingKey.get(S);_&&_.size+k>d&&(this.executeBatch(S,_,r,wi.ExceedingMaxSize),_=void 0),_||(_={items:[],size:0,hasItemsWithCallbacks:!1,context:t,creationTime:Date.now()},this.batchesByGroupingKey.set(S,_)),_.items.push({input:e,size:k,callback:u}),_.size+=k,_.hasItemsWithCallbacks=_.hasItemsWithCallbacks||!!u,_.cv=a,_.groupComplete=s,_.groupComplete?this.executeBatch(S,_,r,wi.GroupComplete):(Date.now()-_.creationTime+f<c&&(clearTimeout(_.timeout),_.timeout=void 0),_.timeout||(_.timeout=setTimeout(function(){l.executeBatch(S,_,r,wi.BatchIntervalElapsed)},f)))}},{key:"removeAllBatchedItems",value:function(){this.batchesByGroupingKey.forEach(function(e){e.timeout&&clearTimeout(e.timeout)}),this.batchesByGroupingKey.clear()}},{key:"executeBatch",value:function(e,r,t,a){var s=this;clearTimeout(r.timeout),r.timeout=void 0,this.batchesByGroupingKey.delete(e);var u=r.items,l=function(p){return p<0?"Negative":p===0?"0":p===1?"1":"Magnitude "+p.toString().length},f=new D({operationName:"ExecuteBatch",cv:r.cv,resourceId:r.context.name,resultDescription:"batching duration: "+(Date.now()-r.creationTime)+"ms",dimension0:"Count "+l(u.length),dimension1:"Size "+l(r.size),dimension2:a.toString()}).start(),c=function(p,k,S){var C;if(k&&k.exceptionType===ye.NoOutput)f.success=!0,v.info(573366353,y.CoreDefault,f.stop());else{var T=p+" error: "+(k?k.message||k:"Unknown error");C=k||new Error(T),f.success=!1,f.resultDescription="Batch of "+u.length+" items of size "+r.size+" with "+T,f.resultSignature=p+" Error",v.error(573366354,y.CoreDefault,f.stop())}if(r.hasItemsWithCallbacks)for(var x of u)x.callback&&x.callback(C,S)},d;try{d=t.multiplex(u.map(function(h){return h.input}))}catch(h){c("Multiplex",h);return}this.submit(d.input,r,function(h,p){if(h||p&&("exceptionType"in p||p instanceof Error))c("Submit",h||p,p);else if(r.hasItemsWithCallbacks||t.summaryExtractor){var k;if(r.hasItemsWithCallbacks)try{if(k=d.demultiplex(p),k.length!==u.length)throw new Error("Mismatched output length")}catch(b){c("Demultiplex",b);return}var S,C;if(t.summaryExtractor)try{var T=t.summaryExtractor(p),x=(0,Gp.default)(T,2);C=x[0],S=x[1]}catch(b){c("SummaryExtractor",b);return}if(f.success=!0,v.info(573366342,y.CoreDefault,f.stop()),r.hasItemsWithCallbacks)for(var A=0;A<u.length;A++)u[A].callback&&u[A].callback(void 0,k[A]);S&&s.onSummary(C,S,r.context)}else f.success=!0,v.info(573366343,y.CoreDefault,f.stop())})}}]),n}();g();g();var zp=w(Ye()),Vp=w(W()),Qp=w(B()),jp=function(){function n(o,e,r){if((0,Vp.default)(this,n),this.requestInProgress=!1,this.queuedRequests=[],o==null)throw new Error("No request.");this.fetch=o,this.fetchTimeout=e,this.queueTimeout=r}return(0,Qp.default)(n,[{key:"tryProcessNextRequest",value:function(){if(this.requestInProgress=!1,this.queuedRequests.length>0){var e=this.queuedRequests.shift(),r=(0,zp.default)(e,3),t=r[0],a=r[1],s=r[2];clearTimeout(s),this.add(t,a)}}},{key:"add",value:function(e,r){var t=this;if(this.requestInProgress){var a=setTimeout(function(){r(new Error("Timed out waiting in queue"),null),t.queuedRequests.shift()},this.queueTimeout);this.queuedRequests.push([e,r,a])}else{this.requestInProgress=!0;var s=new Promise(function(u,l){var f=!1,c=setTimeout(function(){f=!0,l(new Error("Fetch timed out"))},t.fetchTimeout);t.fetch(e).then(function(d){f||(clearTimeout(c),u(d))}).catch(function(d){f||(clearTimeout(c),l(d))})});s.then(function(u){r(null,u),t.tryProcessNextRequest()}).catch(function(u){r(u,null),t.tryProcessNextRequest()})}}}]),n}();var Da=w(ol()),ST=2e4,CT=12e4;function Si(n,o,e){var r=new Da.Request(n,o);return xT.add(r,e)}var xT=new jp(Da.fetch,ST,CT);g();function dn(){return"xxxxxxxx-xxxx-xxxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var o=Math.random()*16|0,e=n==="x"?o:o&3|8;return e.toString(16)})}g();var Wa=function(o){return TT(o,Number.POSITIVE_INFINITY)};var TT=function(o,e){for(var r=0,t=[],a=[o];a.length>0;){var s=a.pop(),u=typeof s;if(u==="boolean")r+=4;else if(u==="string")r+=2*s.length;else if(u==="number")r+=8;else if(u==="object"&&s&&t.indexOf(s)===-1)if(s instanceof Uint8Array)r+=s.length;else{t.push(s);for(var l in s)a.push(s[l])}if(r>e)return r}return r};g();var Gw=w(W()),Uw=w(B());g();var Jp=w(W()),Kp=w(B());var IT=1e3,Ba=function(o,e,r,t){return new el(o,function(a){return a.success&&r.indexOf(a[e])>=0},[e,"resourceId","success","resultSignature","clientDocSessionId","dimension0","dimension1","dimension2","dimension3"],["durationMs"],t)},xo=function(){function n(o){(0,Jp.default)(this,n),this.level=ze.info,this.hostCallbacks=o}return(0,Kp.default)(n,[{key:"log",value:function(e){var r=this;if(!(this.hostCallbacks==null||this.hostCallbacks.sendTelemetryEvent==null)){var t=function(c,d,h,p,k){var S=d.charAt(0).toUpperCase()+d.slice(1),C={DocSessionId:c.clientDocSessionId,ResourceId:c.resourceId,ResultDescription:c.resultDescription,ResultSignature:c.resultSignature,Dimension0:c.dimension0,Dimension1:c.dimension1,Dimension2:c.dimension2,Dimension3:c.dimension3,JoinContextId:c.joinContextId};h&&(C=Object.assign(Object.assign({},C),JSON.parse(h)));var T=p||n.augLoopAriaTenantToken,x=!k&&T==n.augLoopAriaTenantToken?n.augLoopAriaNamespace:k;S=S||n.operationNamePlaceholder,r.hostCallbacks.sendTelemetryEvent(T,x?x+"_"+S:S,C,"Office.System.Activity",{CV:c.cv,Duration:(c.durationMs||0)*IT,Count:c.count,AggMode:2,Success:c.success},!1,pi.ProductServiceUsage|pi.ProductServicePerformance,Ca.RequiredServiceDataEvent)},a=function(c,d,h){r.hostCallbacks.sendDiagnosticTrace&&r.hostCallbacks.sendDiagnosticTrace(c,d,h)};if(e.category!="Workflow.MetricsOnly")if(e.eventName==="Operation"){var s=e;t(s,s.operationName,s.dataFields)}else if(e.eventName==="SessionHealth"){var u=e;t(u,u.sessionHealthEventName)}else if(e.eventName==="WorkflowOperation"){var l=e;t(l,l.operationName,l.dataFields,l.ariaTenant,l.ariaNamespace)}else e.eventName==="Log"&&a(e.tagId,e.traceLevel,e.message)}}}]),n}();xo.augLoopAriaTenantToken="3de4087d4de34817b1c376e3d1e6e293-983c4292-5ba9-485a-ab10-9797863c788b-6770";xo.augLoopAriaNamespace="Office_AugLoop_Client";xo.operationNamePlaceholder="OperationNameNotProvided";g();var th=w(W()),nh=w(B()),rh=w(Xp());g();var _T=w(Ie()),il=w(W()),al=w(B());var Zp=w(Ci()),ie=function(){function n(){(0,il.default)(this,n)}return(0,al.default)(n,null,[{key:"createHealthCheckRequest",value:function(e){return{payload:{},payloadSchema:{category:wn.Schema,schema:{name:"HealthCheckRequest"}},requestedSchema:{category:wn.Schema,schema:{name:"HealthCheckResponse"}},clientMetadata:e}}},{key:"isFeatureEnabled",value:function(e,r){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:"None";return e&&e.isFeatureEnabled?e.isFeatureEnabled("Microsoft.Office.AugLoop."+r,a).catch(function(){return Promise.resolve(t)}):Promise.resolve(t)}},{key:"convertWebSocketUrlToHttp",value:function(e){return this.convertUrl(e,!1)}},{key:"convertServiceUrlToWebSocket",value:function(e){return this.convertUrl(e,!0)}},{key:"convertUrl",value:function(e,r){if(!e)return e;var t=e.split(":"),a=t[0].toLowerCase();return a.indexOf(r?"http":"ws")==0?(a=r?a.replace("http","ws"):a.replace("ws","http"),t[0]=a,t.join(":")):e}},{key:"deepEquals",value:function(e,r){return(0,Zp.default)(e,r)}},{key:"collectTelemetry",value:function(e,r,t,a,s,u){var l,f,c,d;e.start(),e.resultSignature=a!=null?a:"",e.resultDescription=s!=null?s:"",e.success=t,u?(e.dimension0=(l=u[0])!==null&&l!==void 0?l:"",e.dimension1=(f=u[1])!==null&&f!==void 0?f:"",e.dimension2=(c=u[2])!==null&&c!==void 0?c:"",e.dimension3=(d=u[3])!==null&&d!==void 0?d:""):(e.dimension0="",e.dimension1="",e.dimension2="",e.dimension3=""),r.log(function(){return v.info(508367457,y.CoreDefault,e.stop())})}}]),n}();ie.getCurrentTimeMs=function(){return Date.now?Date.now():new Date().getTime()};var tn=function(){function n(o){(0,il.default)(this,n),this.maxNumberOfLogs=40,this.numberOfLogs=0,this.id=o}return(0,al.default)(n,[{key:"log",value:function(e){if(this.numberOfLogs<this.maxNumberOfLogs&&(this.numberOfLogs++,e(),this.numberOfLogs===this.maxNumberOfLogs)){var r=new D({operationName:"OnLastLog",success:!0,resourceId:this.id,resultDescription:"Limit for number of logs for id: "+this.id+" reached - all next logs will be dropped"});v.warn(572838107,y.CoreDefault,r)}}}]),n}(),ON=[m.getTypeName(),gt.getTypeName(),Gt.getTypeName()];var sl=function(o){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return Number.isFinite(o)?o:e},eh=function(o,e){if(!Array.isArray(e)||e.length===0||Ot.typeGuard(o)||ot.typeGuard(o))return!0;for(var r of o.items)if(!r.body||m.matchesTypesFor(r.body,e))return!0;return!1};var Qn=function(){function n(){(0,th.default)(this,n),this.hasBeenOpened=!1,this.hadEgressError=!1,this.lastEgressTime=0,this.lastPongTime=0,this.remainingPingFailures=3,this.egressMessageCount=0,this.egressByteCount=0,this.isClosing=!1,this.pendingEgress=[]}return(0,nh.default)(n,[{key:"init",value:function(e,r,t,a,s){var u=this;this.ws=new rh.default(e),this.logOp=new D({operationName:n.className,success:!0}).start(),this.egressTimer=Date.now(),this.egressMessageCountOp=new D({operationName:"WSEgressMessageCount",success:!0}),this.egressByteCountOp=new D({operationName:"WSEgressByteOrderOfMagnitude",success:!0}),this.ingressByteCountOp=new D({operationName:"WSIngressByteOrderOfMagnitude",success:!0}),this.improvedWebSocketEnabled=s;var l=function(c){u.logPingLatencyOp&&(u.logPingLatencyOp.success=c,v.info(508843802,y.CoreDefault,u.logPingLatencyOp.stop()),u.logPingLatencyOp=void 0)};this.ws.addEventListener("open",function(f){t(),n.logCountLimiter.log(function(){u.logOp.resourceId="OnOpen",u.logOp.resultDescription="",u.logOp.success=!0,u.logOp.dimension0=u.pendingEgress.length.toString(),v.info(508843801,y.CoreDefault,u.logOp.stop())}),u.improvedWebSocketEnabled||(u.hasBeenOpened=!0,u.pendingEgress.forEach(function(c){u.egress({obj:c})}),u.pendingEgress=[],u.pingInterval=setInterval(function(){u.logPingLatencyOp&&(--u.remainingPingFailures,l(!1)),u.remainingPingFailures>0&&u.hasBeenOpened&&u.lastPongTime<u.lastEgressTime&&(u.logPingLatencyOp=new D({operationName:"Ping",success:!0,dimension0:u.ws.bufferedAmount>=0?u.ws.bufferedAmount.toString().length.toString():void 0}).start(),u.ws.send(n.pingPongMessage,function(c){c&&(--u.remainingPingFailures,l(!1))}))},3e4))}),this.ws.addEventListener("message",function(f){!u.improvedWebSocketEnabled&&u.logPingLatencyOp&&typeof f.data=="string"&&f.data.length===1&&f.data[0]===n.pingPongMessage?(l(!0),u.lastPongTime=Date.now()):(u.logIngressCount(f.data),r(f.data))}),this.ws.addEventListener("error",function(f){u.errorMessage=f.message,n.logCountLimiter.log(function(){u.logOp.resourceId="OnError",u.logOp.resultDescription=u.errorMessage,u.logOp.success=!1,v.info(508843800,y.CoreDefault,u.logOp.stop())}),u.ws.close()}),this.ws.addEventListener("close",function(f){n.logCountLimiter.log(function(){u.logOp.resourceId="OnClose",u.logOp.resultDescription=f?"code: "+f.code+". reason: "+f.reason:"",u.logOp.success=!0,v.info(508843799,y.CoreDefault,u.logOp.stop())}),!u.improvedWebSocketEnabled&&u.pingInterval&&(clearInterval(u.pingInterval),u.pingInterval=void 0),a(u.errorMessage),u.isClosing=!1})}},{key:"egress",value:function(e){var r=this,t=e.obj;this.improvedWebSocketEnabled?this.ws.send(t,function(a){a&&!r.hadEgressError&&(r.hadEgressError=!0,n.logCountLimiter.log(function(){r.logOp.resourceId="OnEgressError",r.logOp.resultDescription=a.message,r.logOp.success=!1,v.info(508843797,y.CoreDefault,r.logOp.stop())}))}):(this.logEgressCount(t instanceof ArrayBuffer?t.byteLength:t.length),this.lastEgressTime=Date.now(),this.hasBeenOpened?this.ws.send(t,function(a){a&&!r.hadEgressError&&(r.hadEgressError=!0,n.logCountLimiter.log(function(){r.logOp.resourceId="OnFirstEgressError",r.logOp.resultDescription=a.message,r.logOp.success=!1,v.info(508843798,y.CoreDefault,r.logOp.stop())}))}):this.pendingEgress.push(t))}},{key:"close",value:function(){this.isClosing||(this.isClosing=!0,!this.improvedWebSocketEnabled&&this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=void 0),this.ws.close())}},{key:"logEgressCount",value:function(e){var r=Date.now(),t=r-this.egressTimer;t>1e3&&(this.egressMessageCount>50&&(this.egressMessageCountOp.start(),this.egressMessageCountOp.resultDescription="Egress message count: "+this.egressMessageCount.toString()+", Buffered amount: "+(this.ws.bufferedAmount>=0?this.ws.bufferedAmount.toString():"-")+", Time elapsed: "+t.toString(),v.info(508843796,y.CoreDefault,this.egressMessageCountOp.stop())),this.egressByteCount>1e5&&(this.egressByteCountOp.start(),this.egressByteCountOp.dimension2=this.egressByteCount.toString().length.toString(),this.egressMessageCountOp.resultDescription="Buffered amount: "+(this.ws.bufferedAmount>=0?this.ws.bufferedAmount.toString():"-")+", Time elapsed: "+t.toString(),v.info(508843795,y.CoreDefault,this.egressByteCountOp.stop())),this.egressTimer=r,this.egressMessageCount=0,this.egressByteCount=0),this.egressMessageCount++,this.egressByteCount+=e!=null?e:0}},{key:"logIngressCount",value:function(e){var r=e.length;r>1e5&&(this.ingressByteCountOp.start(),this.ingressByteCountOp.dimension2=r.toString().length.toString(),v.info(508843794,y.CoreDefault,this.ingressByteCountOp.stop()))}}]),n}();Qn.className="WebSocketWorker";Qn.logCountLimiter=new tn(Qn.className);Qn.pingPongMessage="~";g();var Fi=w(Pa()),Qh=w(W()),jh=w(B()),$n=w(Dr()),Jh=w(qe()),Kh=w(Ge()),El=w(De());g();var uh=w(W()),lh=w(B());g();var se=w(W()),ue=w(B());var ul=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Message"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();ul.H_={T_:ul.getTypeName(),B_:ul.getBaseTypes()};var Be=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Response"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Be.H_={T_:Be.getTypeName(),B_:Be.getBaseTypes()};var X=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_ErrorResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();X.H_={T_:X.getTypeName(),B_:X.getBaseTypes()};var Ti=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_TimeoutErrorResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_ErrorResponse","AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Ti.H_={T_:Ti.getTypeName(),B_:Ti.getBaseTypes()};var dt=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionInitMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();dt.H_={T_:dt.getTypeName(),B_:dt.getBaseTypes()};var dr=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionInitResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();dr.H_={T_:dr.getTypeName(),B_:dr.getBaseTypes()};var Io=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionLongPollMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Io.H_={T_:Io.getTypeName(),B_:Io.getBaseTypes()};var Ii=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionLongPollResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Ii.H_={T_:Ii.getTypeName(),B_:Ii.getBaseTypes()};var ll=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionCloseReason"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();ll.H_={T_:ll.getTypeName(),B_:ll.getBaseTypes()};var fl=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionSwapOnClose"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_SessionCloseReason"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();fl.H_={T_:fl.getTypeName(),B_:fl.getBaseTypes()};var Xe=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionCloseMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Xe.H_={T_:Xe.getTypeName(),B_:Xe.getBaseTypes()};var _i=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_CacheDumpRequestMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();_i.H_={T_:_i.getTypeName(),B_:_i.getBaseTypes()};var cl=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_CacheDumpRequestResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();cl.H_={T_:cl.getTypeName(),B_:cl.getBaseTypes()};var nn=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_AnnotationActivationMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();nn.H_={T_:nn.getTypeName(),B_:nn.getBaseTypes()};var Fr=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_AnnotationActivationResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Fr.H_={T_:Fr.getTypeName(),B_:Fr.getBaseTypes()};var qr=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_AnnotationResultStateMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();qr.H_={T_:qr.getTypeName(),B_:qr.getBaseTypes()};var Gr=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_AnnotationReleaseMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Gr.H_={T_:Gr.getTypeName(),B_:Gr.getBaseTypes()};var Ur=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_AnnotationReleaseResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Ur.H_={T_:Ur.getTypeName(),B_:Ur.getBaseTypes()};var Hr=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_AnnotationConfigUpdateMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Hr.H_={T_:Hr.getTypeName(),B_:Hr.getBaseTypes()};var _o=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_AnnotationConfigUpdateResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();_o.H_={T_:_o.getTypeName(),B_:_o.getBaseTypes()};var Ue=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SyncMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Ue.H_={T_:Ue.getTypeName(),B_:Ue.getBaseTypes()};var jn=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_MicroSyncMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();jn.H_={T_:jn.getTypeName(),B_:jn.getBaseTypes()};var zt=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SyncResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();zt.H_={T_:zt.getTypeName(),B_:zt.getBaseTypes()};var dl=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionDeleteMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();dl.H_={T_:dl.getTypeName(),B_:dl.getBaseTypes()};var wt=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_AnnotationResultsMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_SyncMessage","AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();wt.H_={T_:wt.getTypeName(),B_:wt.getBaseTypes()};var zr=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_TokenProvisionMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();zr.H_={T_:zr.getTypeName(),B_:zr.getBaseTypes()};var pl=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_TokenProvisionResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();pl.H_={T_:pl.getTypeName(),B_:pl.getBaseTypes()};var hl=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_KeepAlive"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();hl.H_={T_:hl.getTypeName(),B_:hl.getBaseTypes()};var Vr=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_WorkflowGraphInitMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Vr.H_={T_:Vr.getTypeName(),B_:Vr.getBaseTypes()};var Ai=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_WorkflowGraphInitResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Ai.H_={T_:Ai.getTypeName(),B_:Ai.getBaseTypes()};var Qr=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_WorkflowExecutionCompleteMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_SyncMessage","AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Qr.H_={T_:Qr.getTypeName(),B_:Qr.getBaseTypes()};var gl=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_OAuth2InitV2Message"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();gl.H_={T_:gl.getTypeName(),B_:gl.getBaseTypes()};var ml=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_OAuth2InitV2Response"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();ml.H_={T_:ml.getTypeName(),B_:ml.getBaseTypes()};var vl=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_OAuth2InitMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();vl.H_={T_:vl.getTypeName(),B_:vl.getBaseTypes()};var yl=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_OAuth2InitResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();yl.H_={T_:yl.getTypeName(),B_:yl.getBaseTypes()};var kl=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_OAuth2CallbackMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();kl.H_={T_:kl.getTypeName(),B_:kl.getBaseTypes()};var pt=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_BridgeMessage"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();pt.H_={T_:pt.getTypeName(),B_:pt.getBaseTypes()};var bi=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionConnectMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();bi.H_={T_:bi.getTypeName(),B_:bi.getBaseTypes()};var Mi=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionDisconnectMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Mi.H_={T_:Mi.getTypeName(),B_:Mi.getBaseTypes()};var Ei=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionReconnectMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Ei.H_={T_:Ei.getTypeName(),B_:Ei.getBaseTypes()};var Ri=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SubmittedCustomMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Ri.H_={T_:Ri.getTypeName(),B_:Ri.getBaseTypes()};var wl=function(){function n(o){(0,se.default)(this,n),m.assign(n,this,o)}return(0,ue.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_ServerAuthenticationStateChangeMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();wl.H_={T_:wl.getTypeName(),B_:wl.getBaseTypes()};var Vt;(function(n){n.ClientDisconnected="Client disconnected.",n.UnsupportedSyncMessage="SyncMessages with seq = -1 are not supported anymore.",n.UnexpectedSeedMessage="Unexpected seed message",n.SyncMessageUnsupportedBatch="SyncMessage with unsupported batching.",n.AnnotationTokenNotFound="Token not found"})(Vt||(Vt={}));var Sl;(function(n){n.ProvisionTokenValidationError="Token provision message didn't pass token validation.",n.ProvisionTokenDecryptAndTransformError="Token provision message didn't pass token decrypt and transform."})(Sl||(Sl={}));function Oa(n){var o=["AugLoop_Excel_Session_Protocol_","AugLoop_Powerpoint_Session_Protocol_","AugLoop_Session_Protocol_"],e;for(var r of o)if(n.indexOf(r)===0){e=r;break}if(!e)return"MalformedMessageName";var t="Message",a=n.indexOf(t,n.length-t.length)===n.length-t.length;return n.slice(e.length,a?-t.length:void 0)}var MT=1e4,ET=3e4,oh=5e3,ih=12e4,ah=15e3,sh=3e5,Ao=function(){function n(o){(0,uh.default)(this,n),this.nextMessageId=1,this.pendingResponseCallbacks=new Cn({sweepInterval:oh}),this.pendingMessageCallbacks=new Cn({sweepInterval:oh}),this.messageCallbacks=new Map,this.messageIdPrefix=o,this.source=o==="c"?pe.ClientRuntime:pe.Core,this.stats={sendMessageCount:0,sendMessageClientDisconnectedErrors:0,sendMessageErrors:0,sendMessageDurationMsMax:0,processMessageCount:0,processMessageProvisionTokenErrors:0,processMessageErrors:0,processMessageDurationMsMax:0}}return(0,lh.default)(n,[{key:"setClientMetadata",value:function(e){this.clientMetadata=e}},{key:"setEgress",value:function(e){this.egress=e}},{key:"ingress",value:function(e,r){var t=m.getBaseTypesFor(e),a=m.getTypeNameFor(e),s=a===Be.getTypeName()||t&&t.indexOf(Be.getTypeName())>=0;s?(this.processResponse(e),r()):this.processMessage(e,r),a===Xe.getTypeName()&&!e.reconnectAllowed&&this.clearAllPendingResponses()}},{key:"sendMessage",value:function(e,r,t){var a=this,s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:0,u=new _e({sessionHealthEventName:"SendMessage",source:this.source,reason:Y.Client,impact:this.source===pe.ClientRuntime?he.MissingInput:he.MissingOutput,success:!0,message:"",affectedWorkflows:["All"],cv:e.cv,resourceId:Oa(m.getTypeNameFor(e)),dimension0:s.toString()}).start(),l=function(){if(u.setClientMetadata(a.clientMetadata),u.success)v.info(572836e3,y.CoreDefault,u.stop());else{var C=u.resultSignature==="ErrorWithoutPendingResponse"||u.resultSignature==="ResponseCallbackException"||u.message!=="We called into done callback";u.message=JSON.stringify({errorNotPropagatedToDoneCallback:C}),v.error(572836001,y.CoreDefault,u.stop())}};e.messageId=""+this.messageIdPrefix+this.nextMessageId++;var f=m.getTypeNameFor(e)===Xe.getTypeName(),c=!t&&!f;if(c){var d=function(C,T){var x;if(C?(u.success=!1,u.resultSignature=C.error,u.resultDescription="Error for "+m.getTypeNameFor(e)+" message "+e.messageId+": "+C.error):u.resultSignature="Success",r)try{u.message="We called into done callback",r(C,T)}catch(A){u.success=!1,u.resultSignature="ResponseCallbackException",u.resultDescription=((x=a.clientMetadata)===null||x===void 0?void 0:x.appPlatform)==="Web"?JSON.stringify({message:A.message,stack:A.stack}):JSON.stringify({message:A.message})}a.pendingMessageCallbacks.del(e.messageId),l(),a.updateSendMessageStats(u.success,u.durationMs,C?new Error(C.error):void 0)},h=function(){d(new Ti({error:"Timeout waiting for response"}),void 0)},p=ET;if(Io.typeGuard(e)){var k=e;k.longPollTimeoutHint>=ah&&k.longPollTimeoutHint<=sh?p=k.longPollTimeoutHint+5e3:p=ih}this.pendingResponseCallbacks.put(e.messageId,d,p,h)}this.egress(e,function(S){var C,T;if(S){var x=a.pendingResponseCallbacks.get(e.messageId);x?(a.pendingResponseCallbacks.del(e.messageId),x(new X({messageId:e.messageId,error:S.message}))):f?(u.success=(T=(C=S.message)===null||C===void 0?void 0:C.endsWith("Client disconnected."))!==null&&T!==void 0?T:!1,u.resultSignature="ErrorSendingSessionCloseMessage",u.resultDescription="Error for "+m.getTypeNameFor(e)+" message "+e.messageId+": "+S.message,l()):(u.success=!1,u.resultSignature="ErrorWithoutPendingResponse",u.resultDescription="Error for "+m.getTypeNameFor(e)+" message "+e.messageId+": "+S.message,l())}})}},{key:"onMessage",value:function(e,r){this.messageCallbacks.set(e,r)}},{key:"getStats",value:function(){return this.stats}},{key:"hasMessageCallback",value:function(e){return this.messageCallbacks.has(e)}},{key:"cancelPendingResponseCallbacks",value:function(){var e=this;this.pendingResponseCallbacks.forEach(function(r,t){r&&(e.pendingResponseCallbacks.del(t),r(new X({messageId:t,error:"Cancelled"})))})}},{key:"clearAllPendingResponses",value:function(){if(this.pendingResponseCallbacks.size()!=0){var e=new D({operationName:"PurgePendingResponses",resultDescription:this.pendingResponseCallbacks.size().toString(),success:!0});v.info(572836002,y.CoreDefault,e),this.pendingResponseCallbacks.clear()}}},{key:"processMessage",value:function(e,r){var t=this,a,s=new _e({sessionHealthEventName:"ProcessMessage",source:this.source,reason:Y.Client,impact:this.source===pe.ClientRuntime?he.MissingOutput:he.MissingInput,success:!0,message:"",affectedWorkflows:["All"],cv:e.cv}).start(),u=function(){if(s.setClientMetadata(t.clientMetadata),s.success)v.info(572836003,y.CoreDefault,s.stop());else{var S=s.resourceId==="UnsupportedMessage"||s.resultSignature==="Timeout"||s.resultSignature==="OnResponseInvokedMoreThanOnce"||s.resultSignature==="MessageCallbackException"||s.message!=="We called into messageCallback";s.message=JSON.stringify({errorHappenedOutsideRegisteredMessageCallback:S}),v.error(572836032,y.CoreDefault,s.stop())}},l=this.messageCallbacks.get(m.getTypeNameFor(e));l?s.resourceId=Oa(m.getTypeNameFor(e)):l=function(S,C){s.resourceId=Oa(m.getTypeNameFor(S)),s.resourceId!=="MalformedMessageName"&&(s.resourceId="UnsupportedMessage"),C(new X({messageId:S.messageId,error:"Message type "+m.getTypeNameFor(S)+" is not supported"}))};var f=function(){s.success=!1,s.resultSignature="Timeout",s.resultDescription="Timeout processing message callback",u(),v.error(572836033,y.CoreDefault,"Timeout processing "+s.resourceId),t.updateProcessMessageStats(!1,s.durationMs,new Error("timeout"))},c=MT;if(Io.typeGuard(e)){var d=e;d.longPollTimeoutHint>=ah&&d.longPollTimeoutHint<=sh?c=d.longPollTimeoutHint+5e3:c=ih}this.pendingMessageCallbacks.put(e.messageId,void 0,c,f);var h=!1,p=function(S,C){t.pendingMessageCallbacks.del(e.messageId),h?(s.success=!1,s.resultSignature="OnResponseInvokedMoreThanOnce",s.resultDescription="Invoked onResponse for "+m.getTypeNameFor(e)+" message "+e.messageId+" more than once"):S?(s.success=!1,s.resultSignature=S.error,s.resultDescription="Error for "+m.getTypeNameFor(e)+" message "+e.messageId+": "+S.error):s.resultSignature="Success",h=!0,u(),S&&!m.matchesTypesFor(S,[X.getTypeName()])&&(S=new X({error:"Internal Server Error"})),t.updateProcessMessageStats(s.success,s.durationMs,S?new Error(S.error):void 0),S?(S.messageId=e.messageId,r(S)):C?(C.messageId=e.messageId,r(void 0,C)):r()};try{s.message="We called into messageCallback",l(e,p)}catch(k){this.pendingMessageCallbacks.del(e.messageId),s.success=!1,s.resultSignature="MessageCallbackException",s.resultDescription=((a=this.clientMetadata)===null||a===void 0?void 0:a.appPlatform)==="Web"?JSON.stringify({message:k.message,stack:k.stack}):JSON.stringify({message:k.message}),u(),this.updateProcessMessageStats(!1,s.durationMs,k),r()}}},{key:"processResponse",value:function(e){var r,t=new D({operationName:"ProcessResponse"});if(t.success=!0,t.setClientMetadata(this.clientMetadata),t.start(),e.messageId){var a=this.pendingResponseCallbacks.get(e.messageId);a?(this.pendingResponseCallbacks.del(e.messageId),m.matchesTypesFor(e,[X.getTypeName()])?a(e):a(void 0,e)):(t.resultSignature="NoPendingMessage",t.resultDescription=""+e.messageId,t.success=!1)}else t.resultSignature="NoMessageIdSetInResponse",X.typeGuard(e)?t.resultDescription=e.error:t.resultDescription="MessageId is not available",t.success=!1;((r=this.clientMetadata)===null||r===void 0?void 0:r.releaseAudienceGroup)!=="Production"&&(t.resourceId=Oa(m.getTypeNameFor(e)),v.info(572836034,y.CoreDefault,t.stop()))}},{key:"updateSendMessageStats",value:function(e,r,t){this.stats.sendMessageCount++,this.stats.sendMessageDurationMsMax=Math.max(r,this.stats.sendMessageDurationMsMax),!e&&!t?v.warn(572836035,y.CoreDefault,"Failed send message did not provide error object."):e&&t&&v.warn(572836036,y.CoreDefault,"Succeeded send message provided error object."),!e&&(t&&t.message===Vt.ClientDisconnected?this.stats.sendMessageClientDisconnectedErrors++:this.stats.sendMessageErrors++)}},{key:"updateProcessMessageStats",value:function(e,r,t){this.stats.processMessageCount++,this.stats.processMessageDurationMsMax=Math.max(r,this.stats.processMessageDurationMsMax),!e&&!t?v.warn(572836037,y.CoreDefault,"Failed process message did not provide error object."):e&&t&&v.warn(572836038,y.CoreDefault,"Succeeded process message provided error object."),!e&&(t&&t.message===Sl.ProvisionTokenValidationError?this.stats.processMessageProvisionTokenErrors++:this.stats.processMessageErrors++)}}]),n}();g();var ch=2,fh;(function(n){n[n.IdentityChange=0]="IdentityChange"})(fh||(fh={}));var rn;(function(n){n[n.Idle=0]="Idle",n[n.Pending=1]="Pending"})(rn||(rn={}));g();var at;(function(n){n[n.NotAuthenticated=0]="NotAuthenticated",n[n.Pending=1]="Pending",n[n.Authenticated=2]="Authenticated",n[n.WacUserInfoAuthenticated=3]="WacUserInfoAuthenticated"})(at||(at={}));var $h=w(Jn());g();var yh=w(W()),kh=w(B());var wh=w(mh());var xn;(function(n){n.ArrivedBeforeReseeding="Message is dropped from queue since it arrived before reseeding is started",n.DroppedAsOldestInQueue="Message is dropped as oldest in full queue",n.DroppedBecauseClientDisconnected="Message is dropped because client is disconnected from server"})(xn||(xn={}));var vh=1e3,Sh=function(){function n(o){(0,yh.default)(this,n),this.logOp=new D({operationName:"MessageQueue",success:!0}),this.messageQueueLogCountLimiter=new tn("MessageQueue"),this.queue=new wh.default(vh),this.callbacks=o}return(0,kh.default)(n,[{key:"clear",value:function(){this.queue.clear()}},{key:"size",value:function(){return this.queue.length}},{key:"push",value:function(e,r,t){var a=this,s=this.queue;if(s.length===vh){this.messageQueueLogCountLimiter.log(function(){a.logOp.resourceId="QueueFull",a.logOp.durationMs=0,v.warn(508843746,y.CoreDefault,a.logOp)});var u=s.shift();u.onResponse&&u.onResponse(new X({error:xn.DroppedAsOldestInQueue}))}s.push({message:e,onResponse:r,timeQueued:ie.getCurrentTimeMs(),attemptNumber:t})}},{key:"sendOnSessionInitialized",value:function(e){var r=this,t=this.queue.length,a=0;if(t>0){for(var s=ie.getCurrentTimeMs()-this.queue.get(0).timeQueued;this.queue.length>0&&this.callbacks.canSendMessage();){var u=this.queue.shift();e&&u.message instanceof Ue&&m.matchesTypesFor(u.message,[Ue.getTypeName()])&&(!this.callbacks.dropOnlySequencedSyncsOnReseed||u.message.seq>=0)?(a++,u.onResponse&&u.onResponse(new X({error:xn.ArrivedBeforeReseeding}))):u.message instanceof Uint8Array?this.callbacks.sendBytes(u.message):this.callbacks.sendMessage(u.message,u.onResponse,u.attemptNumber)}this.messageQueueLogCountLimiter.log(function(){r.logOp.resourceId="SendOnSessionInitialized",r.logOp.resultDescription="Queue size before: "+t+", after: "+r.queue.length+". droppedSyncMessages: "+a,r.logOp.durationMs=s,v.warn(508843745,y.CoreDefault,r.logOp)})}}}]),n}();g();var Di=w(qe()),Ch=w(Ge()),xl=w(De()),bo=w(W()),Mo=w(B());function Fa(n){var o=BT();return function(){var r=(0,xl.default)(n),t;if(o){var a=(0,xl.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,Ch.default)(this,t)}}function BT(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var Ae;(function(n){n[n.Initing=0]="Initing",n[n.Running=1]="Running",n[n.Disconnected=2]="Disconnected",n[n.Closed=3]="Closed"})(Ae||(Ae={}));var Tl=function(o,e,r,t){e&&(e.cv||(e.cv=o.cvParent.newChild().toString()),o.messageEndpoint.sendMessage(e,function(a,s){!a&&m.getTypeNameFor(s)===zt.getTypeName()&&(o.stats.lastSyncMessage=Date.now()),r&&r(a,s)},void 0,t))},xh=function(o,e,r,t){e&&(o.messageQueue.push(e,r,t),o.networkWorkerManager.init(void 0,o.customInitPromise).catch(function(a){var s=new D({operationName:"WorkerManagerInit",success:!1,resultDescription:""+a});v.error(508843789,y.CoreDefault,s)}))},Th=function(o,e){e&&(o.messageQueue.push(e),o.networkWorkerManager.init(void 0,o.customInitPromise).catch(function(r){v.error(508843788,y.CoreDefault,"Init failed: "+r)}))},qa=function(){function n(o){(0,bo.default)(this,n),this.context=o}return(0,Mo.default)(n,[{key:"onEnter",value:function(e){}},{key:"sendMessage",value:function(e,r,t,a){}},{key:"sendBytes",value:function(e){}},{key:"canSendMessage",value:function(){return!1}},{key:"onConnectionClose",value:function(){}}]),n}(),Ih=function(n){(0,Di.default)(e,n);var o=Fa(e);function e(){var r;return(0,bo.default)(this,e),r=o.apply(this,arguments),r.stateName=Ae.Initing,r.possibleNextStates=[Ae.Running,Ae.Disconnected,Ae.Closed],r}return(0,Mo.default)(e,[{key:"sendMessage",value:function(t,a,s){m.matchesTypesFor(t,[dt.getTypeName()])?Tl(this.context,t,a,s):xh(this.context,t,a)}},{key:"sendBytes",value:function(t){Th(this.context,t)}},{key:"onConnectionClose",value:function(){this.context.setState(Ae.Disconnected)}}]),e}(qa),_h=function(n){(0,Di.default)(e,n);var o=Fa(e);function e(){var r;return(0,bo.default)(this,e),r=o.apply(this,arguments),r.stateName=Ae.Running,r.possibleNextStates=[Ae.Disconnected,Ae.Closed],r}return(0,Mo.default)(e,[{key:"onEnter",value:function(t){t&&t.isSessionReseedingStarted&&this.context.resetNextSyncSequenceId(),this.context.messageQueue.sendOnSessionInitialized(t&&t.isSessionReseedingStarted)}},{key:"sendMessage",value:function(t,a,s,u){Tl(this.context,t,a,s)}},{key:"sendBytes",value:function(t){t&&this.context.networkWorkerManager.egressBytes(t)}},{key:"canSendMessage",value:function(){return!0}},{key:"onConnectionClose",value:function(){this.context.setState(Ae.Disconnected)}}]),e}(qa),Ah=function(n){(0,Di.default)(e,n);var o=Fa(e);function e(){var r;return(0,bo.default)(this,e),r=o.apply(this,arguments),r.stateName=Ae.Disconnected,r.possibleNextStates=[Ae.Initing,Ae.Closed],r}return(0,Mo.default)(e,[{key:"onEnter",value:function(t){this.context.messageEndpoint.cancelPendingResponseCallbacks()}},{key:"sendMessage",value:function(t,a,s,u){if(m.matchesTypesFor(t,[dt.getTypeName()]))this.context.setState(Ae.Initing),Tl(this.context,t,a,s);else if(m.matchesTypesFor(t,[Xe.getTypeName()]))this.context.setState(Ae.Closed);else{if(!u){xh(this.context,t,a,s);return}a&&a(new X({messageId:t.messageId,error:xn.DroppedBecauseClientDisconnected}))}}},{key:"sendBytes",value:function(t){Th(this.context,t)}}]),e}(qa),bh=function(n){(0,Di.default)(e,n);var o=Fa(e);function e(){var r;return(0,bo.default)(this,e),r=o.apply(this,arguments),r.stateName=Ae.Closed,r.possibleNextStates=[],r}return(0,Mo.default)(e,[{key:"onEnter",value:function(t){this.context.messageEndpoint.cancelPendingResponseCallbacks()}}]),e}(qa);g();var Hh=w(W()),zh=w(B());g();g();var PT=function(){if(typeof TextEncoder=="undefined"){Eh();var o={AugLoopTextEncoder:TextEncoder,AugLoopTextDecoder:TextDecoder};return TextEncoder=void 0,TextDecoder=void 0,o}else return{AugLoopTextEncoder:TextEncoder,AugLoopTextDecoder:TextDecoder}},Rh=PT(),Il=Rh.AugLoopTextEncoder,_l=Rh.AugLoopTextDecoder;g();var Nh=w(W()),Dh=w(B());var on=function(){function n(){(0,Nh.default)(this,n)}return(0,Dh.default)(n,null,[{key:"deserialize",value:function(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:function(c){return c};if(e[0]!==n.IDENTIFIERBYTE)throw new Error("Invalid Binary: Incorrect Identifier");for(var t=1,a=[],s=new DataView(e.buffer,e.byteOffset,e.byteLength);t<e.byteLength;){if(t+4>e.byteLength)throw new Error("Invalid Binary: Error reading fragment length");var u=s.getUint32(t);if(t+u+4>e.byteLength)throw new Error("Invalid Binary: Fragment out of range");typeof Buffer!="undefined"&&Buffer.from?a.push(Buffer.from(e.buffer,e.byteOffset+t+4,u)):a.push(new Uint8Array(e.buffer,e.byteOffset+t+4,u)),t+=4+u}if(a.length<1)throw new Error("Invalid Binary: No fragments found");var l=n.textDecoder.decode(a[0]),f=function(d,h){if(typeof h=="string"){if(h.substring(0,n.BINARYKEYWORD.length)===n.BINARYKEYWORD){var p=parseInt(h.substring(n.BINARYKEYWORD.length),10);if(typeof p!="number"||p>=a.length-1)throw new Error("Invalid Binary: Binary index out of range");return r(a[p+1])}else if(h.substring(0,n.ESCAPEKEYWORD.length)===n.ESCAPEKEYWORD)return h.substring(n.ESCAPEKEYWORD.length)}return h};return JSON.parse(l,f)}},{key:"serialize",value:function(e){var r=[void 0],t=function(h,p){return ArrayBuffer.isView(p)?(r.push(p),""+n.BINARYKEYWORD+(r.length-2)):p&&p.type==="Buffer"&&Array.isArray(p.data)?(r.push(new Uint8Array(p.data)),""+n.BINARYKEYWORD+(r.length-2)):typeof p=="string"&&p.substring(0,n.ESCAPEKEYWORD.length)===n.ESCAPEKEYWORD?n.ESCAPEKEYWORD+p:p},a=JSON.stringify(e,t);r[0]=n.textEncoder.encode(a);var s=r.reduce(function(d,h){return d+4+h.byteLength},0),u=new Uint8Array(s+1);u[0]=n.IDENTIFIERBYTE;var l=1,f=new DataView(u.buffer,u.byteOffset,u.byteLength);for(var c of r)f.setUint32(l,c.byteLength),u.set(c,l+4),l+=4+c.byteLength;return u}}]),n}();on.IDENTIFIERBYTE=3;on.BINARYKEYWORD=":b";on.ESCAPEKEYWORD=":";on.textDecoder=new _l;on.textEncoder=new Il;g();var qh=w(W()),Gh=w(B());g();g();var Bh=w(W()),Ph=w(B());var OT=3,Wh=3e4,Ga=function(){function n(o,e,r){(0,Bh.default)(this,n),this.logCountLimiter=new tn(n.className),this.lastPingTime=0,this.lastPongTime=0,this.lastEgressTime=0,this.remainingPingFailures=3,this.isPingPongSuccessful=!1,this.pingPongLogOp=new D({operationName:"WebSocketReliabilityManager",success:!0}).start(),this.worker=o,this.closeWorkerOnReliabilityFailure=r,this.rateControllerClose=e}return(0,Ph.default)(n,[{key:"start",value:function(){ie.collectTelemetry(this.pingPongLogOp,this.logCountLimiter,!0,"ping","initial ping"),this.isPingPongSuccessful=!0,this.ping(),this.startInterval()}},{key:"onResponse",value:function(){this.lastPongTime=Date.now()}},{key:"isReliabilityResponse",value:function(e){return e&&e.length===1&&e===n.pingPongMessage}},{key:"close",value:function(){this.lastPingTime=0,this.lastPongTime=0,this.isPingPongSuccessful=!1,this.clearPingInterval(),this.worker=void 0}},{key:"checkConnection",value:function(){return this.isPingPongSuccessful}},{key:"postEgress",value:function(){this.lastEgressTime=Date.now()}},{key:"ping",value:function(){this.lastPingTime=Date.now(),this.worker&&this.worker.egress({obj:n.pingPongMessage})}},{key:"startInterval",value:function(){var e=this;this.pingInterval=setInterval(function(){if(e.isPingPongSuccessful=e.lastPongTime>=e.lastPingTime&&e.lastPongTime-e.lastPingTime<=Wh,!(e.lastPongTime>e.lastEgressTime)){var r=e.lastPongTime-e.lastPingTime;e.isPingPongSuccessful?(e.remainingPingFailures=OT,ie.collectTelemetry(e.pingPongLogOp,e.logCountLimiter,!0,"ping","WebSocket channel active",[""+r,""+e.remainingPingFailures]),e.ping()):e.remainingPingFailures>0?(--e.remainingPingFailures,ie.collectTelemetry(e.pingPongLogOp,e.logCountLimiter,!0,"ping","Pong not received within 30000 ms",[""+r,""+e.remainingPingFailures]),e.ping()):(ie.collectTelemetry(e.pingPongLogOp,e.logCountLimiter,!1,"ping","Pong still not received after all retry attempts",[""+r,""+e.remainingPingFailures]),e.closeWorkerOnReliabilityFailure&&e.worker?e.worker.close():e.rateControllerClose())}},Wh)}},{key:"clearPingInterval",value:function(){this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=void 0)}}]),n}();Ga.pingPongMessage="~";Ga.className="WebSocketReliabilityManager";var Oh=function(o,e,r){return new Ga(o,e,r)};var Lh=50,Fh=1e5,Al=function(){function n(o,e){var r=this;(0,qh.default)(this,n);var t,a,s,u,l;this.logCountLimiter=new tn(n.className),this.emptyMessageId=0,this.egressMessageCount=0,this.egressByteCount=0,this.prevSeq=-1,this.pendingQueue=[],this.egressBytesTotal=0,this.egressRateLogOp=new D({operationName:"NetworkEgressRate",success:!0}),this.egressLogOp=new D({operationName:"NetworkEgressControl",success:!0}).start(),this.egressedCache=new Map,this.rpsThreshold=(t=o==null?void 0:o.rpsThreshold)!==null&&t!==void 0?t:150,this.bpsThreshold=(a=o==null?void 0:o.bpsThreshold)!==null&&a!==void 0?a:5e8,this.pendingMaxSize=(s=o==null?void 0:o.pendingMaxSize)!==null&&s!==void 0?s:1e4,this.egressedMaxSize=(u=o==null?void 0:o.egressedMaxSize)!==null&&u!==void 0?u:1e4,this.egressedBytesMaxSize=(l=o==null?void 0:o.egressedBytesMaxSize)!==null&&l!==void 0?l:1e7,this.closeWorkerOnReliabilityFailureEnabled=e!=null?e:!0,this.initPromise=new Promise(function(f){r.resolveInitPromise=f})}return(0,Gh.default)(n,[{key:"init",value:function(e,r,t,a){var s=this;this.worker=e,this.ingress=r,this.clientMetadata=a,this.egressRateControlTimer=setInterval(function(){return s.flush()},1e3),this.networkMode=t,this.reliabilityManager=Oh(this.worker,this.close.bind(this),this.closeWorkerOnReliabilityFailureEnabled),this.resolveInitPromise()}},{key:"open",value:function(){var e=this;this.initPromise.then(function(){if(!e.reliabilityManager){e.collectTelemetry(!1,"OnOpenFailure","Reliability Manager is undefined");return}e.collectTelemetry(!0,"OnOpen"),e.egressRateControlIntervalStart=Date.now(),e.reliabilityManager.start(),e.flush()}).catch(function(r){e.collectTelemetry(!1,"OnOpenFailure",r)})}},{key:"ingressFromWorker",value:function(e,r){var t=this;if(!this.reliabilityManager){this.collectTelemetry(!1,"ingressFromWorkerFailure","Reliability Manager is undefined");return}this.reliabilityManager.isReliabilityResponse(e)?this.reliabilityManager.onResponse(e):this.ingress(e,function(a){r==null||r(a),t.updateEgressedCache(a)})}},{key:"close",value:function(){var e;this.collectTelemetry(!0,"OnClose"),(e=this.reliabilityManager)===null||e===void 0||e.close(),this.worker=void 0,this.prevSeq=-1,this.clearEgressControlTimeout(),this.reliabilityManager=void 0}},{key:"clearMessageQueues",value:function(){this.pendingQueue=[],this.egressedCache.clear()}},{key:"egress",value:function(e){var r;if(!this.reliabilityManager){this.collectTelemetry(!1,"EgressFailure","Reliability Manager is undefined");return}if((e.obj instanceof ArrayBuffer||e.isHttpSessionInitMessage)&&this.worker){this.worker.egress(e);return}this.validateSyncMessage(e.messageId,e.seqId);var t=this.egressMessageCount>=this.rpsThreshold||this.egressByteCount>=this.bpsThreshold,a=this.egressBytesTotal>this.egressedBytesMaxSize||this.pendingQueue.length>this.pendingMaxSize||this.egressedCache.size>this.egressedMaxSize,s=this.reliabilityManager.checkConnection(),u=this.pendingQueue.length==0;if(!s||t||!u||a){var l="";l+=this.pendingQueue.length>=this.pendingMaxSize?"Pending queue max exceeded. ":u?"":"Pending queue not empty",l+=this.egressedCache.size>=this.egressedMaxSize?"Egressed cache max exceeded. ":"",l+=this.egressBytesTotal>this.egressedBytesMaxSize?"Egressed bytes max exceeded. ":"",l+=this.egressMessageCount>=this.rpsThreshold?"RPS exceeded. ":"",l+=this.egressByteCount>=this.bpsThreshold?"BPS exceeded. ":"",l+=s?"":"Not connected";var f="pendingQueueSize: "+this.pendingQueue.length+" | egressedCacheSize: "+this.egressedCache.size+" | egressedBytesTotal: "+this.egressBytesTotal+" | rpsThreshold: "+this.rpsThreshold+" | bpsThreshold: "+this.bpsThreshold;this.collectTelemetry(!0,l,f);var c=(r=e.messageId)!==null&&r!==void 0?r:"id"+this.emptyMessageId++;this.pendingQueue.push({obj:e.obj,seqId:e==null?void 0:e.seqId,messageId:c,isHttpSessionInitMessage:e==null?void 0:e.isHttpSessionInitMessage});return}this.sendToNetworkWorker(e)}},{key:"sendToNetworkWorker",value:function(e){try{if(!this.worker){this.collectTelemetry(!1,"SendToNetworkWorkerFailure","NetworkWorker is undefined");return}if(!this.reliabilityManager){this.collectTelemetry(!1,"SendToNetworkWorkerFailure","Reliability Manager is undefined");return}this.worker.egress(e),this.reliabilityManager.postEgress();var r=e.obj instanceof ArrayBuffer?e.obj.byteLength:e.obj.length;this.logEgressCount(r),e.messageId&&e.messageId.startsWith("c")&&(this.egressBytesTotal+=r,this.egressedCache.set(e.messageId,r))}catch(t){this.collectTelemetry(!1,"sendToWorker",t?t.message:"")}}},{key:"flush",value:function(){if(!this.reliabilityManager){this.collectTelemetry(!1,"FlushFailure","Reliability Manager is undefined");return}for(;this.pendingQueue.length>0&&this.pendingQueue.length<this.pendingMaxSize&&this.egressedCache.size<this.egressedMaxSize&&this.egressMessageCount<this.rpsThreshold&&this.egressByteCount<this.bpsThreshold&&this.egressBytesTotal<this.egressedBytesMaxSize&&this.reliabilityManager.checkConnection();){var e=this.pendingQueue.shift();this.sendToNetworkWorker(e)}}},{key:"clearEgressControlTimeout",value:function(){this.egressRateControlTimer&&(clearInterval(this.egressRateControlTimer),this.egressRateControlTimer=void 0)}},{key:"validateSyncMessage",value:function(e,r){r===void 0||e===void 0||r<=this.prevSeq||(r&&r!==this.prevSeq+1&&this.collectTelemetry(!0,"abandonedSyncMessage","Gap in sync message",[""+this.prevSeq,""+r,""+(r-this.prevSeq)]),this.prevSeq=r)}},{key:"updateEgressedCache",value:function(e){e.messageId&&this.egressedCache.has(e.messageId)&&(this.egressBytesTotal-=this.egressedCache.get(e.messageId),this.egressedCache.delete(e.messageId))}},{key:"logEgressCount",value:function(e){var r,t=Date.now();t-this.egressRateControlIntervalStart>1e3&&((this.egressMessageCount>Lh||this.egressByteCount>Fh)&&(this.egressRateLogOp.start(),this.egressRateLogOp.resultDescription=this.egressMessageCount>Lh?"rps limit exceeded":"",this.egressRateLogOp.resultDescription=this.egressByteCount>Fh?"bps limit exceeded":"",this.egressRateLogOp.dimension0=(t-this.egressRateControlIntervalStart).toString(),this.egressRateLogOp.dimension1=""+this.egressMessageCount,this.egressRateLogOp.dimension2=""+this.egressByteCount,this.egressRateLogOp.dimension3="networkMode: "+this.networkMode,v.info(508843792,y.CoreDefault,this.egressRateLogOp.stop())),((r=this.clientMetadata)===null||r===void 0?void 0:r.releaseAudienceGroup)!=="Production"&&this.collectTelemetry(!0,"networkMode: "+this.networkMode,"egress",[""+(this.pendingQueue.length===0?"0":this.pendingQueue.length.toString().length),""+(this.egressedCache.size===0?"0":this.egressedCache.size.toString().length),""+(this.egressBytesTotal===0?"0":this.egressBytesTotal.toString().length),this.rpsThreshold+" | "+this.bpsThreshold]),this.egressRateControlIntervalStart=t,this.egressMessageCount=0,this.egressByteCount=0),this.egressMessageCount++,this.egressByteCount+=e!=null?e:0}},{key:"collectTelemetry",value:function(e,r,t,a){var s=new Array(4).fill("");if(a)for(var u=0;u<a.length;u++)s[u]=a[u];s[3]=s[3]?s[3]:"networkMode: "+this.networkMode,ie.collectTelemetry(this.egressLogOp,this.logCountLimiter,e,t,r,s)}}]),n}();Al.className="NetworkRateController";g();var Uh="sessionWorkflowContext",Pe;(function(n){n[n.JSWebSockets=0]="JSWebSockets",n[n.LocalWorkflowsOnly=1]="LocalWorkflowsOnly",n[n.HostWebSockets=2]="HostWebSockets",n[n.HttpFallback=3]="HttpFallback"})(Pe||(Pe={}));g();var an=w(W()),sn=w(B());var jr=function(){function n(o){(0,an.default)(this,n),m.assign(n,this,o)}return(0,sn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Internal_WorkflowRegistrationMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();jr.H_={T_:jr.getTypeName(),B_:jr.getBaseTypes()};var Jr=function(){function n(o){(0,an.default)(this,n),m.assign(n,this,o)}return(0,sn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_WorkflowExecutionRequest"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Jr.H_={T_:Jr.getTypeName(),B_:Jr.getBaseTypes()};var Eo=function(){function n(o){(0,an.default)(this,n),m.assign(n,this,o)}return(0,sn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_WorkflowExecutionResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Eo.H_={T_:Eo.getTypeName(),B_:Eo.getBaseTypes()};var Wi=function(){function n(o){(0,an.default)(this,n),m.assign(n,this,o)}return(0,sn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Internal_RuntimeInitMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Wi.H_={T_:Wi.getTypeName(),B_:Wi.getBaseTypes()};var bl=function(){function n(o){(0,an.default)(this,n),m.assign(n,this,o)}return(0,sn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Internal_DiagnosticTraceMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();bl.H_={T_:bl.getTypeName(),B_:bl.getBaseTypes()};var Bi=function(){function n(o){(0,an.default)(this,n),m.assign(n,this,o)}return(0,sn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Internal_TelemetryMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Bi.H_={T_:Bi.getTypeName(),B_:Bi.getBaseTypes()};var Ml=function(){function n(o){(0,an.default)(this,n),m.assign(n,this,o)}return(0,sn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Internal_TelemetryFlushMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Ml.H_={T_:Ml.getTypeName(),B_:Ml.getBaseTypes()};var Pi=function(){function n(o){(0,an.default)(this,n),m.assign(n,this,o)}return(0,sn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Internal_SessionCloseResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Pi.H_={T_:Pi.getTypeName(),B_:Pi.getBaseTypes()};var Kn=function(){function n(o){(0,an.default)(this,n),m.assign(n,this,o)}return(0,sn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Internal_WorkflowDefinitionOverrideMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Kn.H_={T_:Kn.getTypeName(),B_:Kn.getBaseTypes()};var Kr=function(){function n(o){(0,an.default)(this,n),m.assign(n,this,o)}return(0,sn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Internal_GetAnnotationsRequestMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Kr.H_={T_:Kr.getTypeName(),B_:Kr.getBaseTypes()};var Oi=function(){function n(o){(0,an.default)(this,n),m.assign(n,this,o)}return(0,sn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Internal_GetAnnotationsResponseMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Oi.H_={T_:Oi.getTypeName(),B_:Oi.getBaseTypes()};var Vh=1e3,LT=6e4,FT=function(o,e){var r=0,t=ie.getCurrentTimeMs()?ie.getCurrentTimeMs()-e:0,a=[1e3,2e3,5e3,1e4,6e4];return r=a[Math.max(0,Math.min(a.length-1,o-1))],r=Math.max(r-t,Vh),r},Li=function(){function n(o,e,r,t,a,s,u,l,f,c){var d=this;(0,Hh.default)(this,n),this.logCountLimiter=new tn(n.className),this.isWorkerReady=!1,this.permanentlyClosed=!1,this.currentReconnectAttempt=0,this.lastInitializationAttemptTimeMs=0,this.offlineInterval=void 0,this.alreadyLoggedReconnectAttempt=!1,this.httpTestsLeft=5,this.httpTestsSuccessCount=0,this.wsOpenCount=0,this.testHttpConnection=function(h){var p=ie.convertWebSocketUrlToHttp(d.globalUrl),k=!h,S=h!=null?h:new D({operationName:"HttpsTest",resourceId:p,success:!1,resultDescription:"",resultSignature:"HttpResponse:"}).start(),C={method:"POST",headers:{"content-type":"application/json","X-CorrelationId":S.cv},body:JSON.stringify(ie.createHealthCheckRequest(d.clientMetadata))};Si(p,C,function(T,x){T?(S.dimension1="HttpErr",S.resultDescription+="HttpErr: "+T.message):!x||!x.ok?(S.dimension1="HttpNoResp",S.resultDescription+="HttpStatus: "+(x==null?void 0:x.status)):(S.dimension1="HttpOK",d.leaveOfflineMode(),d.httpTestsSuccessCount++,k&&(S.success=!0)),k&&S.stop(),d.logCountLimiter.log(function(){v.info(508843780,y.CoreDefault,S)})})},this.globalUrl=o,this.clientMetadata=e,this.workerFactory=r,this.sessionInitializer=t,this.ingress=a,this.onConnectionClose=s,this.onDetectedWSBlock=u,this.closeWSBlockedSession=l.closeWSBlockedSessionEnabled,this.sessionOfflineModeEnabled=l.sessionOfflineModeEnabled,this.improvedWebSocketEnabled=l.improvedWebSocketEnabled,this.closeWorkerOnReliabilityFailureEnabled=l.closeWorkerOnReliabilityFailureEnabled,this.networkWorkerLogOp=new D({operationName:"CreateNetworkWorker",success:!0}),this.networkMode=f||Pe.JSWebSockets,this.improvedWebSocketEnabled&&(this.networkRateSettings=c)}return(0,zh.default)(n,[{key:"init",value:function(e,r){var t=this,a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;if(this.permanentlyClosed)return Promise.reject(new Error("permanentlyClosed"));if(this.isWorkerReady||this.pendingInitPromise)return this.pendingInitPromise?this.pendingInitPromise:Promise.resolve();this.extensionConfigs=e||this.extensionConfigs;var s=function(){if(a||!t.alreadyLoggedReconnectAttempt){var l=a?n.initialAttemptTimeout:n.reconnectAttemptTimeout;t.connTimeout=setTimeout(function(){var f=new D({operationName:"ConnectionFailingOrSlow",dimension0:a?"Initial":"Reconnect",dimension1:l.toString(),dimension2:t.currentReconnectAttempt.toString()});v.info(508843787,y.CoreDefault,f),t.alreadyLoggedReconnectAttempt=!a,t.connTimeout=void 0},l)}};return r?this.pendingInitPromise=r().catch(function(u){var l=new D({operationName:"WorkerManagerCustomInit",success:!1,resultDescription:""+u});v.error(508843786,y.CoreDefault,l)}).then(function(){s(),t.initInternal()}):(this.pendingInitPromise=Promise.resolve(),s(),this.initInternal()),this.pendingInitPromise}},{key:"egress",value:function(e){var r=this;return!this.isWorkerReady&&this.pendingInitPromise?this.pendingInitPromise.then(function(){r.egressInternal(e)}):(this.egressInternal(e),Promise.resolve())}},{key:"egressBytes",value:function(e){var r=this;return!this.isWorkerReady&&this.pendingInitPromise?this.pendingInitPromise.then(function(){r.egressBytesInternal(e)}):(this.egressBytesInternal(e),Promise.resolve())}},{key:"getNetworkMode",value:function(){return this.networkMode}},{key:"close",value:function(e){this.isWorkerReady=!1,this.worker&&(this.worker.close(),this.worker=null),this.improvedWebSocketEnabled&&(this.networkRateController&&this.getNetworkRateController().close(),this.networkRateController=null),this.permanentlyClosed=e||this.permanentlyClosed,this.permanentlyClosed&&(this.leaveOfflineMode(),clearTimeout(this.connTimeout))}},{key:"initInternal",value:function(){var e=this;if(this.isWorkerReady=!1,this.permanentlyClosed||this.isOffline()){var r=new D({operationName:"WorkerManagerInitOffline",success:!0,resultSignature:this.permanentlyClosed?"PermanentlyClosed":"Offline"});v.info(508843785,y.CoreDefault,r);return}this.currentReconnectAttempt>0?setTimeout(function(){e.tryToConnectAndInitializeSession()},FT(this.currentReconnectAttempt,this.lastInitializationAttemptTimeMs)):this.tryToConnectAndInitializeSession()}},{key:"egressInternal",value:function(e){if(!this.isWorkerReady&&!m.matchesTypesFor(e,[dt.getTypeName()])){m.matchesTypesFor(e,[Be.getTypeName()])||v.error(508843784,y.CoreDefault,new D({operationName:"UnexpectedEgressCall",resultDescription:"isWorkerReady: "+this.isWorkerReady}));return}var r;if(m.matchesTypesFor(e,[jn.getTypeName()])?(this.castBinaryData(e),r=on.serialize(e)):r=JSON.stringify(e),this.improvedWebSocketEnabled){var t;Ue.typeGuard(e)&&(t=e.seq);var a=dt.typeGuard(e)&&this.getNetworkMode()===Pe.HttpFallback;this.getNetworkRateController().egress({obj:r,isHttpSessionInitMessage:a,messageId:e.messageId,seqId:t})}else this.worker.egress({obj:r})}},{key:"egressBytesInternal",value:function(e){if(!this.isWorkerReady){v.error(508843783,y.CoreDefault,new D({operationName:"UnexpectedEgressBytesCall",resultDescription:"isWorkerReady: "+this.isWorkerReady}));return}this.improvedWebSocketEnabled?this.getNetworkRateController().egress({obj:e}):this.worker.egress({obj:e})}},{key:"tryToConnectAndInitializeSession",value:function(){var e=this;this.currentReconnectAttempt++,this.lastInitializationAttemptTimeMs=ie.getCurrentTimeMs();var r=function a(s){e.permanentlyClosed||e.isOffline()||(e.connect(e.sliceUrl?e.sliceUrl:e.globalUrl),e.sessionInitializer.initSession({isTokenRefresh:!1,isReconnectOnSameSlice:!!e.sliceUrl,extensionConfigs:e.extensionConfigs,onResponse:function(l,f){if(s.success=!l,s.resultDescription=l?"WS Error: "+l.error:"",s.resourceId=f?f.sliceUrl:"",s.dimension0=s.success?"WSOK":"WSFail",l||!e.worker){e.sliceUrl=void 0,e.close(),e.httpTestsLeft>0?(e.httpTestsLeft--,e.testHttpConnection(s.stop())):(e.closeWSBlockedSession&&e.wsOpenCount===0&&e.httpTestsSuccessCount>=5?(e.permanentlyClosed=!0,s.dimension1="WSBlocked",e.onDetectedWSBlock()):e.sessionOfflineModeEnabled&&e.httpTestsSuccessCount===0&&(e.startOfflineMode(),s.dimension1="WSOffline"),e.logCountLimiter.log(function(){v.info(508843782,y.CoreDefault,s.stop())})),e.initInternal();return}else if(e.logCountLimiter.log(function(){v.info(508843781,y.CoreDefault,s.stop())}),f.forceReconnect){e.close();var c=new D({operationName:"ForcedReconnect"}).start();c.resultSignature="globalUrl: "+e.globalUrl+". sliceUrl: "+e.sliceUrl,e.sliceUrl=void 0,setTimeout(function(){a(c)},Vh)}else clearTimeout(e.connTimeout),e.sliceUrl=f.sliceUrl,e.ready();e.resetHttpTestsCounter()}}))},t=new D({operationName:"TryToConnectAndInitializeSession",resultSignature:"Reconnection attempt #"+this.currentReconnectAttempt}).start();r(t)}},{key:"getNetworkRateController",value:function(){return this.networkRateController||(this.networkRateController=new Al(this.networkRateSettings,this.closeWorkerOnReliabilityFailureEnabled)),this.networkRateController}},{key:"connect",value:function(e){var r=this,t=this.getNetworkMode();this.networkWorkerLogOp.start(),this.networkWorkerLogOp.resultDescription="NetworkMode: "+(t===Pe.JSWebSockets)?"WebSocket":"HTTP",this.networkWorkerLogOp.dimension0=t.toString(),this.logCountLimiter.log(function(){return v.info(508372418,y.CoreDefault,r.networkWorkerLogOp.stop())}),this.worker=this.workerFactory(this.getNetworkMode()),this.worker.init(e,this.improvedWebSocketEnabled?this.getNetworkRateController().ingressFromWorker.bind(this.networkRateController):this.ingress,function(){r.wsOpenCount++,r.improvedWebSocketEnabled&&r.getNetworkRateController().open(),r.leaveOfflineMode()},function(a){r.close(),r.onConnectionClose(a)},this.improvedWebSocketEnabled),this.improvedWebSocketEnabled&&this.getNetworkRateController().init(this.worker,this.ingress,t,this.clientMetadata)}},{key:"ready",value:function(){this.isWorkerReady=!0,this.pendingInitPromise=void 0,this.currentReconnectAttempt=0}},{key:"castBinaryData",value:function(e){if(e){if(Array.isArray(e.__binaryMembers__))for(var r of e.__binaryMembers__)ArrayBuffer.isView(e[r])||(e[r]=new Uint8Array(e[r]));for(var t of Object.keys(e))typeof e[t]=="object"&&e[t]!==null&&this.castBinaryData(e[t])}}},{key:"isOffline",value:function(){return!!this.offlineInterval}},{key:"startOfflineMode",value:function(){var e=this;this.offlineInterval=setInterval(function(){e.testHttpConnection()},LT)}},{key:"leaveOfflineMode",value:function(){this.isOffline()&&(clearInterval(this.offlineInterval),this.offlineInterval=void 0,this.resetHttpTestsCounter(),this.tryToConnectAndInitializeSession())}},{key:"resetHttpTestsCounter",value:function(){this.httpTestsLeft=5,this.httpTestsSuccessCount=0}}]),n}();Li.initialAttemptTimeout=1e5;Li.reconnectAttemptTimeout=2e4;Li.className="NetworkWorkerManager";function qT(n){var o=GT();return function(){var r=(0,El.default)(n),t;if(o){var a=(0,El.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,Kh.default)(this,t)}}function GT(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var Rl=function(n){(0,Jh.default)(e,n);var o=qT(e);function e(r,t,a,s,u,l,f,c,d){var h,p;return(0,Qh.default)(this,e),p=o.call(this),p.cvParent=new We,p.logOp=new D({operationName:"SessionState",success:!0}).start(),p.sessionStateChangeLogCountLimiter=new tn("SessionState"),p.stats=t,p.allStates=(h={},(0,Fi.default)(h,Ae.Initing,new Ih((0,$n.default)(p))),(0,Fi.default)(h,Ae.Running,new _h((0,$n.default)(p))),(0,Fi.default)(h,Ae.Disconnected,new Ah((0,$n.default)(p))),(0,Fi.default)(h,Ae.Closed,new bh((0,$n.default)(p))),h),p.setState(Ae.Initing),p.improvedWebSocketEnabled=f.improvedWebSocketEnabled,p.messageEndpoint=new Ao("c"),p.messageEndpoint.setClientMetadata(u),p.messageEndpoint.setEgress(p.egress.bind((0,$n.default)(p))),p.messageEndpoint.onMessage(Xe.getTypeName(),function(k,S){p.onSessionCloseMessage(k,S)}),p.networkWorkerManager=new Li(r,u,a,s,p.ingress.bind((0,$n.default)(p)),p.onConnectionClose.bind((0,$n.default)(p)),function(){p.onSessionClose(void 0,"WSNotSupported")},f,c,d),p.messageQueue=new Sh({sendMessage:function(S,C,T,x){return p.state.sendMessage(S,C,T,x)},sendBytes:p.sendBytes.bind((0,$n.default)(p)),canSendMessage:function(){return p.state.canSendMessage()},dropOnlySequencedSyncsOnReseed:f.dropOnlySequencedSyncsOnReseedEnabled}),s.on("connect",function(k,S,C,T,x,A,b){p.setState(Ae.Running,"",{isSessionReseedingStarted:k&&S}),p.emit("connect",k,C,T,x,A,b)}),s.on("reconnect",function(){return p.emit("reconnect")}),s.on("serverAuthenticationStateChange",function(k){return p.emit("serverAuthenticationStateChange",k)}),p.resetNextSyncSequenceId=function(){return p.emit("resetNextSyncSequenceId")},p.tokenRefreshManager=l,p}return(0,jh.default)(e,[{key:"setState",value:function(t,a,s){var u=this;if(!(this.state&&t===this.state.stateName)){var l=this.state?Ae[this.state.stateName]:"undefined",f=this.state?this.state.possibleNextStates.indexOf(t)>=0:t===Ae.Initing;this.sessionStateChangeLogCountLimiter.log(function(){u.logOp.stop(),u.logOp.resourceId="New state: "+(f?Ae[t]:l),u.logOp.resultDescription="Previous state: "+l,u.logOp.dimension0="Attempted state: "+(Ae[t]||"undefined"),u.logOp.resultSignature=a+(u.state&&!f?"Unexpected state change":""),u.logOp.success=f,v.info(508843791,y.CoreDefault,u.logOp)}),f&&(this.state=this.allStates[t],this.logOp.start(),this.state.onEnter(s))}}},{key:"init",value:function(t,a){return this.extensionConfigs=t,this.customInitPromise=a,this.networkWorkerManager.init(this.extensionConfigs,this.customInitPromise,!0)}},{key:"sendMessage",value:function(t,a,s){this.retrySendMessage(t,a,e.maxRetries,s)}},{key:"sendBytes",value:function(t){this.state.sendBytes(t)}},{key:"onMessage",value:function(t,a){this.messageEndpoint.onMessage(t,a)}},{key:"getCorrelationVector",value:function(){return this.cvParent}},{key:"forceReconnect",value:function(t){var a=this;return this.extensionConfigs=t||this.extensionConfigs,this.networkWorkerManager.close(!1),new Promise(function(s){return setTimeout(function(){s(a.networkWorkerManager.init(a.extensionConfigs))},100)})}},{key:"closeSession",value:function(){this.sendMessage(new Xe),this.networkWorkerManager.close(!0),this.onSessionClose(void 0,"ClientRequested")}},{key:"ingress",value:function(t,a){var s=this,u;try{u=JSON.parse(t)}catch(c){v.error(508843790,y.CoreDefault,new _e({sessionHealthEventName:"ProcessMessage",resourceId:"Unknown",success:!1,resultSignature:"ParseError",resultDescription:c.message,durationMs:0,source:pe.ClientRuntime,reason:Y.Client,impact:he.MissingOutput,affectedWorkflows:["All"],message:""}))}if(u){if(this.improvedWebSocketEnabled&&a&&Be.typeGuard(u)&&a(u),this.networkWorkerManager.getNetworkMode()===Pe.HttpFallback&&Ii.typeGuard(u)){var l=u;if(l.batch)for(var f of l.batch)this.messageEndpoint.ingress(f,function(c,d){return s.egress(c||d,function(){})});return}this.messageEndpoint.ingress(u,function(c,d){return s.egress(c||d,function(){})})}}},{key:"egress",value:function(t,a){t&&this.networkWorkerManager.egress(t).then(function(){return a()}).catch(function(s){return a(s)})}},{key:"onSessionCloseMessage",value:function(t,a){t.reconnectAllowed?this.networkWorkerManager.close():this.onSessionClose(t,"CloseMessageReceived"),a()}},{key:"onSessionClose",value:function(t,a){this.setState(Ae.Closed,a),this.tokenRefreshManager.clearAllTimeouts(),this.onConnectionClose(void 0),t&&this.emit("sessionClose",t)}},{key:"onConnectionClose",value:function(t){this.state.onConnectionClose(),this.stats.lastConnectionClose=ie.getCurrentTimeMs(),this.emit("disconnect",t)}},{key:"retrySendMessage",value:function(t,a,s,u){var l=this,f=e.maxRetries-s;this.state.sendMessage(t,function(c,d){c&&s>0&&l.canBeRetried(t)&&l.isTransientError(c)?l.retrySendMessage(t,a,s-1,u):a&&a(c,d)},f,u)}},{key:"canBeRetried",value:function(t){return!m.matchesTypesFor(t,[dt.getTypeName(),jn.getTypeName()])}},{key:"isTransientError",value:function(t){var a=t.error;return a!==Vt.SyncMessageUnsupportedBatch&&a!==Vt.UnexpectedSeedMessage&&a!==Vt.UnsupportedSyncMessage&&a!==Vt.AnnotationTokenNotFound&&a!==xn.ArrivedBeforeReseeding&&a!==xn.DroppedAsOldestInQueue&&a!==xn.DroppedBecauseClientDisconnected}}]),e}($h.EventEmitter);Rl.maxRetries=2;g();var lo=w(Ie()),kr=w(Ye()),$k=w(W()),Xk=w(B());var Yk=w(ol());g();var Xh=w(W()),Yh=w(B());var Nl=function(){function n(o,e,r){(0,Xh.default)(this,n),this.sendMessage=o,this.annotationType=e,this.options=r,this.token=e+"-"+n.nextActivationResultBatchId++}return(0,Yh.default)(n,[{key:"activate",value:function(e,r){var t=this;return new Promise(function(a,s){t.sendMessage(new nn({annotationType:t.annotationType,token:t.token,config:t.options?t.options.config:void 0,ignoreExistingAnnotations:e,sendStateUpdates:t.options?!!t.options.stateUpdateCallback:void 0}),function(u,l){u?s(new Error(u.error)):a({token:t.token})},r)})}},{key:"release",value:function(){var e=this;return new Promise(function(r,t){e.sendMessage(new Gr({token:e.token}),function(a,s){a?t(new Error(a.error)):r(s.lastRelease)})})}}]),n}();Nl.nextActivationResultBatchId=1;g();var Xn=function(o,e){var r=[];for(var t of o!=null?o:[])if(!(e!==void 0&&e!==t.cardinality))for(var a of t.contextTypes)r.push([a,t.cardinality,t.producerWaitPolicy]);return r},Zh=function(o){var e=[];for(var r of o!=null?o:[])(r.cardinality===cr.Required||r.producerWaitPolicy===yo.Always)&&(e=e.concat(r.contextTypes));return e};g();g();var gn=w(Ie()),im=w(W()),am=w(B()),sm=w(qe()),um=w(Ge()),qf=w(De());g();g();var Bl=w(W()),Pl=w(B());g();var mg=w(W()),vg=w(B());var ge={};ax(ge,{ChangeGate:()=>L,DataListener:()=>$r,Setting:()=>pr,SettingInstance:()=>F,SettingInstanceCollection:()=>JT,SettingPatternInstance:()=>QT,SettingsRegistry:()=>sg,TestSettingsProvider:()=>XT});g();g();g();var Gi=w(Ha()),za=w(W()),Va=w(B()),Qa=w(qe()),rg=w(Ge()),Xr=w(De()),og=w(Ci());g();var tg=w(W()),ng=w(B()),$r=function(){function n(){(0,tg.default)(this,n),this.listeners=new Map,this.lastId=0}return(0,ng.default)(n,[{key:"addListener",value:function(e){if(!e)throw new Error("No callback provided for data listener");return this.listeners.set(this.lastId,e),this.lastId++}},{key:"removeListener",value:function(e){this.listeners.delete(e)}},{key:"notifyListeners",value:function(e){this.listeners.forEach(function(r){r(e)})}}]),n}();function Dl(n){var o=VT();return function(){var r=(0,Xr.default)(n),t;if(o){var a=(0,Xr.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,rg.default)(this,t)}}function VT(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var pr=function(n){(0,Qa.default)(e,n);var o=Dl(e);function e(r){var t;return(0,za.default)(this,e),t=o.call(this),t.name=r,t}return(0,Va.default)(e,[{key:"getName",value:function(){return this.name}},{key:"getValue",value:function(){return this.value}},{key:"updateValue",value:function(t){return(0,og.default)(this.value,t)?!1:(v.info(572837968,y.CoreDefault,"Received new property value for "+this.getName()+":",t),this.value=t,!0)}}],[{key:"getInstance",value:function(t){var a=this.allSettings.get(t);if(!a){a=new e(t);var s=e.tryGetConfigProperty(e.currentConfig,t);s.success&&a.updateValue(s.value),this.allSettings.set(t,a)}return a}},{key:"getPatternInstance",value:function(t){var a=this.allPatternSettings.get(t);if(!a){a={regex:new RegExp(t),setting:new e(t)};var s=e.tryGetConfigPropertyByPattern(e.currentConfig,a.regex);a.setting.updateValue(s),this.allPatternSettings.set(t,a)}return a.setting}},{key:"setNewConfig",value:function(t){e.currentConfig=t,v.info(572837966,y.CoreDefault,"New config: "+JSON.stringify(t)),e.allSettings.forEach(function(a,s){var u=e.tryGetConfigProperty(e.currentConfig,s).value;a.updateValue(u)&&(v.info(572837967,y.CoreDefault,"Setting new value for "+s+": "+(u instanceof Object?JSON.stringify(u):u)),a.notifyListeners(u))}),e.allPatternSettings.forEach(function(a,s){var u=e.tryGetConfigPropertyByPattern(t,a.regex);a.setting.updateValue(u)&&(v.info(508432774,y.CoreDefault,"Setting new value for pattern "+s+": "+JSON.stringify(u)),a.setting.notifyListeners(u))})}},{key:"tryGetConfigProperty",value:function(t,a){return t&&t.hasOwnProperty(a)?{success:!0,value:e.selectApplicableValue(t[a])}:{success:!1,value:void 0}}},{key:"tryGetConfigPropertyByPattern",value:function(t,a){var s=[];if(t){var u=Object.getOwnPropertyNames(t).filter(function(f){return a.test(f)});for(var l of u)s.push({name:l,value:e.selectApplicableValue(t[l])})}return s}},{key:"setGlobalFilter",value:function(t){e.globalFilter=t}},{key:"clear",value:function(){e.currentConfig=void 0,e.allSettings.clear(),e.allPatternSettings.clear()}},{key:"selectApplicableValue",value:function(t){var a;if(t){var s=t.find(function(u){return!e.globalFilter||e.globalFilter(u)});s&&(a=s.value)}return a}}]),e}($r);pr.allSettings=new Map;pr.allPatternSettings=new Map;var F=function(n){(0,Qa.default)(e,n);var o=Dl(e);function e(r,t){var a;return(0,za.default)(this,e),a=o.call(this),a.listenerId=NaN,a.defaultValue=t,a.setting=pr.getInstance(r),a}return(0,Va.default)(e,[{key:"getDefaultValue",value:function(){return this.defaultValue}},{key:"addListener",value:function(t){var a=this;return Number.isNaN(this.listenerId)&&(this.listenerId=this.setting.addListener(function(){a.notifyListeners(a.getValue())})),(0,Gi.default)((0,Xr.default)(e.prototype),"addListener",this).call(this,t)}},{key:"removeListener",value:function(t){(0,Gi.default)((0,Xr.default)(e.prototype),"removeListener",this).call(this,t),this.listeners.size==0&&!Number.isNaN(this.listenerId)&&(this.setting.removeListener(this.listenerId),this.listenerId=NaN)}},{key:"getValue",value:function(){var t=this.setting.getValue();return t===void 0?this.defaultValue:t}}]),e}($r),QT=function(n){(0,Qa.default)(e,n);var o=Dl(e);function e(r){var t;return(0,za.default)(this,e),t=o.call(this),t.listenerId=NaN,t.setting=pr.getPatternInstance(r),t}return(0,Va.default)(e,[{key:"addListener",value:function(t){var a=this;return Number.isNaN(this.listenerId)&&(this.listenerId=this.setting.addListener(function(){a.notifyListeners(a.getValue())})),(0,Gi.default)((0,Xr.default)(e.prototype),"addListener",this).call(this,t)}},{key:"removeListener",value:function(t){(0,Gi.default)((0,Xr.default)(e.prototype),"removeListener",this).call(this,t),this.listeners.size==0&&!Number.isNaN(this.listenerId)&&(this.setting.removeListener(this.listenerId),this.listenerId=NaN)}},{key:"getValue",value:function(){var t=this.setting.getValue();return t===void 0?[]:t}}]),e}($r);var jT=new F("disabledChangeGates",[]),L=function(o,e){var r=jT.getValue().indexOf(o)===-1;if(!e)return r;if(r){for(var t=arguments.length,a=new Array(t>2?t-2:0),s=2;s<t;s++)a[s-2]=arguments[s];return e.apply(void 0,a)}};g();var ig=w(W()),ag=w(B());var sg=function(){function n(){(0,ig.default)(this,n)}return(0,ag.default)(n,null,[{key:"addProvider",value:function(e){var r=e.addListener(function(){v.info(572837969,y.CoreDefault,"Received new settings from "+e.constructor.name),n.currentConfig=n.buildConfig(),pr.setNewConfig(n.currentConfig)});n.providers.push({provider:e,listenerId:r}),n.currentConfig=n.buildConfig(),pr.setNewConfig(n.currentConfig)}},{key:"getCurrentConfig",value:function(){return n.currentConfig}},{key:"clear",value:function(){n.currentConfig=void 0,n.providers.forEach(function(e){e.provider.removeListener(e.listenerId)}),n.providers=[]}},{key:"buildConfig",value:function(){var e={};for(var r of n.providers){var t=r.provider.getSettings()||{};e=Object.assign(e,t)}return e}}]),n}();sg.providers=[];g();var ug=w(W()),lg=w(B());var JT=function(){function n(o,e){(0,ug.default)(this,n),this.prefix=o,this.defaultValue=e,this.settingInstances=new Map}return(0,lg.default)(n,[{key:"getSettingInstance",value:function(e){var r=""+this.prefix+e,t=this.settingInstances.get(r);return t===void 0&&(t=new F(r,this.defaultValue),this.settingInstances.set(r,t)),t}}]),n}();kn(ge,w(cg()));g();var dg=w(W()),pg=w(B()),hg=w(qe()),gg=w(Ge()),Wl=w(De());function KT(n){var o=$T();return function(){var r=(0,Wl.default)(n),t;if(o){var a=(0,Wl.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,gg.default)(this,t)}}function $T(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var XT=function(n){(0,hg.default)(e,n);var o=KT(e);function e(r){var t;return(0,dg.default)(this,e),t=o.call(this),t.currentSettings=r,t}return(0,pg.default)(e,[{key:"setSettings",value:function(t){this.currentSettings=t,this.notifyListeners(t)}},{key:"getSettings",value:function(){return this.currentSettings}}]),e}($r);var YT=new F("performanceEventExpirationTimeMs",1e4),yg=function(){function n(){(0,mg.default)(this,n),this.pendingEvents=[]}return(0,vg.default)(n,[{key:"add",value:function(e){this.pendingEvents.push(e),this.runTimeout()}},{key:"runTimeout",value:function(){var e=this;this.timer||this.pendingEvents.length===0||(this.timer=setTimeout(function(){e.logFinishedEvents(),e.timer=void 0,e.runTimeout()},500),this.timer.unref&&this.timer.unref())}},{key:"calculateSyncDuration",value:function(e){var r,t=0;if(e.sync)t+=(r=e.durationMs)!==null&&r!==void 0?r:0;else for(var a of e.children)t+=this.calculateSyncDuration(a);return t}},{key:"logFinishedEvents",value:function(){for(var e=this,r=Date.now(),t=0,a=[],s=function(){var l=e.pendingEvents[t];if(r-l.lastActivityTimeMs<YT.getValue())return a.push(l),1;Re(function(){var f=new D;f.operationName="PerformanceMeasurement",f.resourceId=l.rootScope.name,f.resultJSON=JSON.stringify(l.toLoggable()),f.success=!0,f.stop(),f.durationMs=Math.round(e.calculateSyncDuration(l.rootScope));var c=et(),d=c.performanceEvent;c.performanceEvent=void 0,v.info(521417348,y.CoreDefault,f),c.performanceEvent=d},l.cc)};t<this.pendingEvents.length;t++)s();this.pendingEvents=a}}],[{key:"getInstance",value:function(){return this.instance||(this.instance=new n),this.instance}}]),n}();var lB=new F("loggedPerformanceEventsPercentage",0);function kg(){v.setStartPerformanceEventCallback(function(n){var o=U();return o.startSync(n)}),v.setStopPerformanceEventCallback(function(n){U().stop(n)})}kg();var ZT=function(){function n(){(0,Bl.default)(this,n)}return(0,Pl.default)(n,[{key:"start",value:function(e,r){return Yr}},{key:"startSync",value:function(e,r){return Yr}},{key:"startAsync",value:function(e,r){return Yr}},{key:"stop",value:function(e){}},{key:"remove",value:function(e){}},{key:"stopCurrentScope",value:function(){}},{key:"stopCurrentEvent",value:function(){}},{key:"resume",value:function(e){}},{key:"startBranch",value:function(e,r,t){return{event:Yr,performanceEvent:ja}}},{key:"switchToScope",value:function(e){}},{key:"switchToParentScope",value:function(){}},{key:"switchToRootScope",value:function(){}},{key:"markForLogging",value:function(){}},{key:"find",value:function(e){return Yr}}]),n}(),Yr={name:"Dummy",startTimeMs:0,activeEventsNumber:0,status:Et.Active},ja=new ZT;ja.rootScope=Yr;ja.currentScope=Yr;var Zr;(function(n){n[n.None=0]="None",n[n.WentDown=1]="WentDown",n[n.WentUp=2]="WentUp"})(Zr||(Zr={}));function U(n){return eI.getCurrent(n)||ja}var eI=function(){function n(){(0,Bl.default)(this,n),this.markedForLogging={value:!1},this.activeSyncEvents=new Set,this.notFoundEventNames=new Set}return(0,Pl.default)(n,[{key:"resume",value:function(e){var r,t;this.lastActivityTimeMs=Date.now();var a;typeof e=="string"?a=(t=(r=this.currentScope)===null||r===void 0?void 0:r.children)===null||t===void 0?void 0:t.find(function(s){return s.name===e}):a=e,a&&this.resumeInternal(a)&&(this.currentScope=a.parent,a.sync&&this.activeSyncEvents.add(a))}},{key:"start",value:function(e,r){return this.startInternal(e,void 0,r)}},{key:"startAsync",value:function(e,r){return this.startInternal(e,!1,r)}},{key:"startSync",value:function(e,r){return this.startInternal(e,!0,r)}},{key:"stop",value:function(e){var r,t,a;this.lastActivityTimeMs=Date.now();var s=Ht(),u;if(typeof e=="string"?((r=this.currentScope)===null||r===void 0?void 0:r.name)===e?u=this.currentScope:u=(t=this.currentScope)===null||t===void 0?void 0:t.children.find(function(f){return f.name===e}):u=e,!!u){if(u.activeEventsNumber?u.stopRequested=!0:(this.pause(u,s),u.status=Et.Stopped,u.parent&&u.parent.stopRequested&&u.parent.activeEventsNumber===0&&(this.stop(u.parent),u.parent.stopRequested=!1)),u.sync&&u.parent.neighbourScopeActiveSyncEvents)for(var l of u.parent.neighbourScopeActiveSyncEvents)l.status===Et.Paused&&(this.resumeInternal(l),l.pausedByNeighbour=!1);this.currentScope=(a=u.initialScope)!==null&&a!==void 0?a:u.parent,u.sync&&this.activeSyncEvents.delete(u)}}},{key:"remove",value:function(e){var r;this.lastActivityTimeMs=Date.now(),(r=e==null?void 0:e.parent)===null||r===void 0||r.children.splice(e.parent.children.indexOf(e),1)}},{key:"stopCurrentScope",value:function(){this.stop(this.currentScope)}},{key:"stopCurrentEvent",value:function(){this.currentScope.children.length>0&&this.stop(this.currentScope.children[this.currentScope.children.length-1])}},{key:"startBranch",value:function(e,r,t){return this.startBranchInternal(e,r,void 0,t)}},{key:"switchToScope",value:function(e){this.currentScope=e}},{key:"switchToParentScope",value:function(){var e;this.currentScope=(e=this.currentScope)===null||e===void 0?void 0:e.parent}},{key:"switchToRootScope",value:function(){this.currentScope=this.rootScope}},{key:"markForLogging",value:function(){this.markedForLogging.value||(this.markedForLogging.value=!0,yg.getInstance().add(this))}},{key:"toLoggable",value:function(){var e={events:{},summary:{syncDurationMs:0,asyncDurationMs:0,eventDurations:{}}};return e.events[this.rootScope.name]=this.mapEventToLoggable(this.rootScope),this.notFoundEventNames.size>0&&(e.summary.notFoundEventNames=Array.from(this.notFoundEventNames)),this.fillSummary(e.summary,this.rootScope),e}},{key:"find",value:function(e){var r=this.findInternal(e);return r||this.notFoundEventNames.add(e),r}},{key:"pauseActiveSyncEvents",value:function(){var e=Ht();for(var r of this.activeSyncEvents)this.pause(r,e)}},{key:"resumeActiveSyncEvents",value:function(){for(var e of this.activeSyncEvents)!e.pausedByNeighbour&&e.status===Et.Paused&&e.performanceEvent===this&&this.resumeInternal(e)}},{key:"resumeInternal",value:function(e,r){if(e&&(e.status!==Et.Active||r)){if(e.parent&&e.parent.activeEventsNumber++,e.startTimeMs=Ht(),e.status=Et.Active,e.sync&&e.parent.neighbourScopeActiveSyncEvents){var t=Ht();for(var a of e.parent.neighbourScopeActiveSyncEvents)a.status===Et.Active&&(this.pause(a,t),a.pausedByNeighbour=!0)}return!0}return!1}},{key:"startInternal",value:function(e,r,t){this.lastActivityTimeMs=Date.now();var a=this.currentScope,s=this.switchScope(r),u=this.findOrCreateEvent(e,r,t);return u.event.performanceEvent=this,this.onEventStarted(u.event,a,u.created,s),u.event}},{key:"startBranchInternal",value:function(e,r,t,a){var s=this.currentScope,u=this.switchScope(t),l=this.createEvent(e,t,a);this.onEventStarted(l,s,!0,u),this.currentScope=l;var f=new n;return f.rootScope=this.rootScope,f.currentScope=this.currentScope,f.cc=r,f.markedForLogging=this.markedForLogging,f.activeSyncEvents=this.activeSyncEvents,f.notFoundEventNames=this.notFoundEventNames,l.performanceEvent=f,r.performanceEvent=f,this.currentScope=s,{event:l,performanceEvent:f}}},{key:"onEventStarted",value:function(e,r,t,a){var s;this.lastActivityTimeMs=Date.now(),a.scopeChange!==Zr.None&&(e.initialScope=r),e.neighbourScopeActiveSyncEvents=a.neighbourScopeActiveSyncEvents,t?(e.parent=this.currentScope,(s=this.currentScope)===null||s===void 0||s.children.push(e)):e.status!==Et.Active&&(e.count=e.count?e.count+1:2,e.startTimeMs=Ht(),e.status=Et.Active),this.resumeInternal(e,!0),e.sync&&this.activeSyncEvents.add(e)}},{key:"pause",value:function(e,r){var t;e.status===Et.Active&&(e.durationMs=((t=e.durationMs)!==null&&t!==void 0?t:0)+(r-e.startTimeMs),e.startTimeMs=void 0,e.parent&&e.parent.activeEventsNumber--,e.status=Et.Paused)}},{key:"findInternal",value:function(e){var r,t;return(t=(r=this.currentScope)===null||r===void 0?void 0:r.children)===null||t===void 0?void 0:t.find(function(a){return a.name===e})}},{key:"switchScope",value:function(e){for(var r,t={scopeChange:Zr.None},a,s=this.currentScope.children.length-1;s>=0;s--){var u=this.currentScope.children[s];if(u.startTimeMs!==void 0&&u.performanceEvent===this){if(e===!0&&u.sync!==!1||e!==!0&&u.sync===void 0)return this.currentScope=u,{scopeChange:Zr.WentDown};a=u}}if(e===!1)for(;!((r=this.currentScope)===null||r===void 0)&&r.sync;)this.currentScope=this.currentScope.parent,t.scopeChange=Zr.WentUp;else if(e===void 0){var l=this.currentScope;for(a!=null&&a.sync&&(t.neighbourScopeActiveSyncEvents=new Set([a]));l.sync!==void 0;)l.sync===!0&&l.startTimeMs!==void 0&&(t.neighbourScopeActiveSyncEvents||(t.neighbourScopeActiveSyncEvents=new Set),t.neighbourScopeActiveSyncEvents.add(l)),l=l.parent,t.scopeChange=Zr.WentUp;this.currentScope=l}return t}},{key:"mergeEvents",value:function(e,r){var t,a,s,u;e.count=((t=e.count)!==null&&t!==void 0?t:1)+((a=r.count)!==null&&a!==void 0?a:1),e.durationMs=((s=e.durationMs)!==null&&s!==void 0?s:0)+((u=r.durationMs)!==null&&u!==void 0?u:0),r.children.length>0&&e.children===void 0&&(e.children={});for(var l of r.children)e.children[l.name]?this.mergeEvents(e.children[l.name],l):e.children[l.name]=this.mapEventToLoggable(l)}},{key:"fillSummary",value:function(e,r){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},a,s,u,l;r.sync&&((a=r.parent)===null||a===void 0?void 0:a.sync)!==!0?e.syncDurationMs+=(s=r.durationMs)!==null&&s!==void 0?s:0:r.sync===!1&&(e.asyncDurationMs+=(u=r.durationMs)!==null&&u!==void 0?u:0),e.eventDurations[r.name]===void 0&&(e.eventDurations[r.name]={sync:r.sync,durationMs:0}),t[r.name]===1&&(e.eventDurations[r.name].durationMs+=(l=r.durationMs)!==null&&l!==void 0?l:0);for(var f of r.children)t[f.name]=t[f.name]?t[f.name]+1:1,this.fillSummary(e,f,t),t[f.name]--}},{key:"mapEventToLoggable",value:function(e){var r=Object.assign({},e);if(r.parent=void 0,r.startTimeMs=void 0,r.initialScope=void 0,r.name=void 0,r.neighbourScopeActiveSyncEvents=void 0,r.perfEvent=void 0,r.pausedByNeighbour=void 0,r.performanceEvent=void 0,r.activeEventsNumber=void 0,r.stopRequested=void 0,r.status=void 0,r.children.length>0){r.children={};var t=0;for(var a of e.children)if(r.children[a.name])this.mergeEvents(r.children[a.name],a);else{var s=this.mapEventToLoggable(a);e.children.length>1&&(s.order=t++),r.children[a.name]=s}}else r.children=void 0;return r}},{key:"createEvent",value:function(e,r,t){var a={name:e,sync:r,startTimeMs:Ht(),children:[],activeEventsNumber:0,status:Et.Active};return t&&(a=Object.assign(a,t)),a}},{key:"findOrCreateEvent",value:function(e,r,t){var a=this.findInternal(e),s=a===void 0||a.startTimeMs!==void 0;return s?a=this.createEvent(e,r,t):t&&Object.assign(a,t),{event:a,created:s}}}],[{key:"getCurrent",value:function(e){var r;return(r=e!=null?e:et())===null||r===void 0?void 0:r.performanceEvent}},{key:"create",value:function(e,r){var t=et(),a=new n;return a.rootScope=a.findOrCreateEvent(e,void 0,r).event,a.currentScope=a.rootScope,a.cc=t,a.lastActivityTimeMs=Date.now(),t.performanceEvent=a,t.performanceEvent}}]),n}();g();var wg=w(W()),Sg=w(B());var pn=function(){function n(o){(0,wg.default)(this,n),m.assign(n,this,o)}return(0,Sg.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Voice_VoiceOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();pn.H_={T_:pn.getTypeName(),B_:pn.getBaseTypes()};var lm=w(Jn());g();var Cg=w(B()),xg=w(W()),Tg=w(qe()),Ig=w(Ge()),Ol=w(De()),_g=w(Lu());function tI(n){var o=nI();return function(){var r=(0,Ol.default)(n),t;if(o){var a=(0,Ol.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,Ig.default)(this,t)}}function nI(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var eo=function(n){(0,Tg.default)(e,n);var o=tI(e);function e(r){var t;return(0,xg.default)(this,e),t=o.call(this,r),t.__proto__=e.prototype,t}return(0,Cg.default)(e)}((0,_g.default)(Error));g();var Ll=w(Ie()),bg=w(Ye()),Mg=w(W()),Eg=w(B());g();var hn;(function(n){n.ApplyOperations="ApplyOperations",n.GetModelSubTreeItems="Model.GetSubTreeItems",n.EmitEvents="EmitEvents",n.InvokeSynchronousEvents="InvokeSynchronousEvents",n.UpdateModelItems="Model.UpdateItems",n.GetModelItemChildren="Model.GetItemChildren"})(hn||(hn={}));g();var jt="\\",rI=100,Ct=function(o,e){return Object.assign(Object.assign({},e),{parentPath:o})},G=function(o){return Array.isArray(o)?o.length===5?""+o[0]+jt+o[1]+jt+o[2]+jt+o[3]+jt+o[4]:o.length===4?""+o[0]+jt+o[1]+jt+o[2]+jt+o[3]:o.length===3?""+o[0]+jt+o[1]+jt+o[2]:o.length===2?""+o[0]+jt+o[1]:o.length===1?o[0]:o.join(jt):"(malformed path)"},Yn=function(o){return o.split(jt)},Ag=function(o){return o&&o.length>0&&o.length<rI&&o.indexOf(jt)<0},Ui=function(o){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return Number.isFinite(o)?o:e},to=function(o,e){if(o.length>e.length)return!1;for(var r=0;r<o.length;r++)if(o[r]!==e[r])return!1;return!0};var Ja=function(){function n(){(0,Mg.default)(this,n),this.singleItemListeners=new Map}return(0,Eg.default)(n,[{key:"onItemChange",value:function(e,r,t,a){var s=this.singleItemListeners.get(e);s||(s=[],this.singleItemListeners.set(e,s)),s.push({itemType:e,inputStage:r,callback:t,synchronousCallbackRequired:a})}},{key:"emitEvents",value:function(e,r){var t=this,a=U(),s=a.startSync(hn.EmitEvents),u=[],l=[],f=new Map,c=function(b){v.debug(572837896,y.CoreDefault,function(){return"Triggering notifications for "+m.getTypeNameFor(b)});var E=function(M){if(!M.body)return 1;var N=function(O){var z=t.singleItemListeners.get(O);for(var J of z||[]){if(r!==void 0&&r<1&&!(J.inputStage&Zt.PreSeed)){v.debug(572837897,y.CoreDefault,function(){return"Suppressing item listener callback for item type "+O+" on "+G([].concat((0,Ll.default)(b.parentPath),[M.id]))+" on a seeded item."});continue}v.debug(572837898,y.CoreDefault,function(){return"Invoking item listener callback for item type "+O+" on "+G([].concat((0,Ll.default)(b.parentPath),[M.id]))});var ce=Object.assign(Object.assign({},b),{items:[M]}),ae=f.get(J);ae||(ae=[],f.set(J,ae)),ae.push(ce)}};for(var R of m.getAllTypesFor(M.body))N(R)};for(var I of b.items)E(I)};for(var d of e)c(d);var h=function(b,E){b.synchronousCallbackRequired?l.push(function(){return b.callback(E)}):u.push(function(){return b.callback(E)})};for(var p of f.entries()){var k=(0,bg.default)(p,2),S=k[0],C=k[1];h(S,C)}var T=function(b){var E=function(M){try{zn(function(){M()})}catch(N){v.error(572837899,y.CoreDefault,"Item listener callback failed: "+N.message)}};for(var I of b)E(I)};if(l.length>0){a.stop(s);var x=a.start(hn.InvokeSynchronousEvents);T(l),a.stop(x),a.resume(s)}u.length>0&&setTimeout(function(){return T(u)},0),a.stop(s)}}]),n}();g();var fe;(function(n){n[n.Add=0]="Add",n[n.Delete=1]="Delete",n[n.Update=2]="Update",n[n.CursorUpdate=3]="CursorUpdate",n[n.FormattingUpdate=4]="FormattingUpdate",n[n.OtherNonContentUpdate=5]="OtherNonContentUpdate"})(fe||(fe={}));var Oe;(function(n){n[n.Chars=0]="Chars",n[n.Word=1]="Word",n[n.PartialSentence=2]="PartialSentence",n[n.Sentence=3]="Sentence",n[n.Paragraph=4]="Paragraph"})(Oe||(Oe={}));g();var Rg;(function(n){n[n.Unspecified=0]="Unspecified",n[n.Inline=1]="Inline",n[n.Floating=2]="Floating"})(Rg||(Rg={}));var Ka;(function(n){n[n.Undefined=0]="Undefined",n[n.Bullet=1]="Bullet",n[n.Numbered=2]="Numbered",n[n.Lim=3]="Lim",n[n.Nil=4]="Nil",n[n.Any=5]="Any",n[n.NoList=6]="NoList",n[n.Invalid=7]="Invalid"})(Ka||(Ka={}));var Ng;(function(n){n[n.DontCare=1]="DontCare",n[n.Thin=2]="Thin",n[n.ExtraLight=3]="ExtraLight",n[n.Light=4]="Light",n[n.Normal=5]="Normal",n[n.Medium=6]="Medium",n[n.SemiBold=7]="SemiBold",n[n.Bold=8]="Bold",n[n.ExtraBold=9]="ExtraBold",n[n.Heavy=10]="Heavy"})(Ng||(Ng={}));var Dg;(function(n){n[n.NoCaps=0]="NoCaps",n[n.SmallCaps=1]="SmallCaps",n[n.AllCaps=2]="AllCaps",n[n.AllPetiteCaps=3]="AllPetiteCaps",n[n.PetiteCaps=4]="PetiteCaps",n[n.Unicase=5]="Unicase",n[n.Titling=6]="Titling",n[n.Other=7]="Other"})(Dg||(Dg={}));var Wg;(function(n){n[n.None=0]="None",n[n.Words=1]="Words",n[n.SingleLine=2]="SingleLine",n[n.DoubleLine=3]="DoubleLine",n[n.HeavyLine=4]="HeavyLine",n[n.DottedLine=5]="DottedLine",n[n.DottedHeavyLine=6]="DottedHeavyLine",n[n.DashLine=7]="DashLine",n[n.DashHeavyLine=8]="DashHeavyLine",n[n.DashLongLine=9]="DashLongLine",n[n.DashLongHeavyLine=10]="DashLongHeavyLine",n[n.DotDashLine=11]="DotDashLine",n[n.DotDashHeavyLine=12]="DotDashHeavyLine",n[n.DotDotDashLine=13]="DotDotDashLine",n[n.DotDotDashHeavyLine=14]="DotDotDashHeavyLine",n[n.WavyLine=15]="WavyLine",n[n.WavyHeavyLine=16]="WavyHeavyLine",n[n.WavyDoubleLine=17]="WavyDoubleLine"})(Wg||(Wg={}));var Bg;(function(n){n[n.Left=0]="Left",n[n.Right=1]="Right",n[n.Center=2]="Center",n[n.Justified=3]="Justified",n[n.Other=4]="Other",n[n.None=5]="None",n[n.JustifyLow=6]="JustifyLow",n[n.Distributed=7]="Distributed",n[n.ThaiDistributed=8]="ThaiDistributed"})(Bg||(Bg={}));var Pg;(function(n){n[n.Image=0]="Image",n[n.TextBox=1]="TextBox",n[n.Chart=2]="Chart",n[n.SmartArt=3]="SmartArt",n[n.Drawing=4]="Drawing",n[n.EquationObject=5]="EquationObject",n[n.Ink=6]="Ink",n[n.InkSpace=7]="InkSpace",n[n.InkEndOfLine=8]="InkEndOfLine",n[n.LineBreak=9]="LineBreak",n[n.PageBreak=10]="PageBreak",n[n.PageNumbers=11]="PageNumbers",n[n.FootnoteEndnote=12]="FootnoteEndnote",n[n.FootnoteEndnoteReferenceMark=13]="FootnoteEndnoteReferenceMark",n[n.Tab=14]="Tab",n[n.UnsupportedObject=15]="UnsupportedObject",n[n.Other=16]="Other",n[n.Person=17]="Person",n[n.Date=18]="Date"})(Pg||(Pg={}));var Og;(function(n){n[n.Initial=0]="Initial",n[n.FirstLine=1]="FirstLine",n[n.Hanging=2]="Hanging"})(Og||(Og={}));g();var xt=w(W()),Tt=w(B());var Fl=function(){function n(o){(0,xt.default)(this,n),m.assign(n,this,o)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_RangeAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Fl.H_={T_:Fl.getTypeName(),B_:Fl.getBaseTypes()};var ql=function(){function n(o){(0,xt.default)(this,n),m.assign(n,this,o)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_MultiTileRangeAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();ql.H_={T_:ql.getTypeName(),B_:ql.getBaseTypes()};var Gl=function(){function n(o){(0,xt.default)(this,n),m.assign(n,this,o)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_LanguageDetectionSummaryAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Gl.H_={T_:Gl.getTypeName(),B_:Gl.getBaseTypes()};var Ul=function(){function n(o){(0,xt.default)(this,n),m.assign(n,this,o)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_LanguageCountAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Ul.H_={T_:Ul.getTypeName(),B_:Ul.getBaseTypes()};var Hl=function(){function n(o){(0,xt.default)(this,n),m.assign(n,this,o)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_LanguageCountAnnotationLocalized"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_LanguageCountAnnotation","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Hl.H_={T_:Hl.getTypeName(),B_:Hl.getBaseTypes()};var zl=function(){function n(o){(0,xt.default)(this,n),m.assign(n,this,o)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_Definition"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_RangeAnnotation","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();zl.H_={T_:zl.getTypeName(),B_:zl.getBaseTypes()};var Vl=function(){function n(o){(0,xt.default)(this,n),m.assign(n,this,o)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_SuggestionsAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_RangeAnnotation","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Vl.H_={T_:Vl.getTypeName(),B_:Vl.getBaseTypes()};var Ql=function(){function n(o){(0,xt.default)(this,n),m.assign(n,this,o)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_Critique"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_SuggestionsAnnotation","AugLoop_Text_RangeAnnotation","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Ql.H_={T_:Ql.getTypeName(),B_:Ql.getBaseTypes()};var jl=function(){function n(o){(0,xt.default)(this,n),m.assign(n,this,o)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_NeuralRewriteCritique"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_Critique","AugLoop_Text_SuggestionsAnnotation","AugLoop_Text_RangeAnnotation","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();jl.H_={T_:jl.getTypeName(),B_:jl.getBaseTypes()};var Jl=function(){function n(o){(0,xt.default)(this,n),m.assign(n,this,o)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_CritiqueCategoryCountAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Jl.H_={T_:Jl.getTypeName(),B_:Jl.getBaseTypes()};var no=function(){function n(o){(0,xt.default)(this,n),m.assign(n,this,o)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_UniqueWordsCountAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();no.H_={T_:no.getTypeName(),B_:no.getBaseTypes()};var Kl=function(){function n(o){(0,xt.default)(this,n),m.assign(n,this,o)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_EmptyDocumentAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Kl.H_={T_:Kl.getTypeName(),B_:Kl.getBaseTypes()};var $l=function(){function n(o){(0,xt.default)(this,n),m.assign(n,this,o)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_IdeasPersonalizationSettingsAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();$l.H_={T_:$l.getTypeName(),B_:$l.getBaseTypes()};var Xl=function(){function n(o){(0,xt.default)(this,n),m.assign(n,this,o)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_TextToSpeechAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Xl.H_={T_:Xl.getTypeName(),B_:Xl.getBaseTypes()};var Yl=function(){function n(o){(0,xt.default)(this,n),m.assign(n,this,o)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_AutoreplaceAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_Critique","AugLoop_Text_SuggestionsAnnotation","AugLoop_Text_RangeAnnotation","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Yl.H_={T_:Yl.getTypeName(),B_:Yl.getBaseTypes()};g();var Zl=w(W()),ef=w(B());var Zn=function(){function n(o){(0,Zl.default)(this,n),m.assign(n,this,o)}return(0,ef.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Text_TextTileDelta"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_ItemDelta"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Zn.H_={T_:Zn.getTypeName(),B_:Zn.getBaseTypes()};var un=function(){function n(o){(0,Zl.default)(this,n),m.assign(n,this,o)}return(0,ef.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Text_FormattedTextTileDelta"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_TextTileDelta","AugLoop_Core_ItemDelta"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();un.H_={T_:un.getTypeName(),B_:un.getBaseTypes()};g();var hr=w(W()),gr=w(B());var Je=function(){function n(o){(0,hr.default)(this,n),m.assign(n,this,o)}return(0,gr.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Text_TextTile"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Je.H_={T_:Je.getTypeName(),B_:Je.getBaseTypes()};var nt=function(){function n(o){(0,hr.default)(this,n),m.assign(n,this,o)}return(0,gr.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Text_FormattedTextTile"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_TextTile"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();nt.H_={T_:nt.getTypeName(),B_:nt.getBaseTypes()};var tf=function(){function n(o){(0,hr.default)(this,n),m.assign(n,this,o)}return(0,gr.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Text_DynamicTextContext"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_DynamicContext"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();tf.H_={T_:tf.getTypeName(),B_:tf.getBaseTypes()};var nf=function(){function n(o){(0,hr.default)(this,n),m.assign(n,this,o)}return(0,gr.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Text_TaskTile"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_FormattedTextTile","AugLoop_Text_TextTile"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();nf.H_={T_:nf.getTypeName(),B_:nf.getBaseTypes()};var rf=function(){function n(o){(0,hr.default)(this,n),m.assign(n,this,o)}return(0,gr.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Text_PersonTile"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_TextTile"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();rf.H_={T_:rf.getTypeName(),B_:rf.getBaseTypes()};var of=function(){function n(o){(0,hr.default)(this,n),m.assign(n,this,o)}return(0,gr.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Text_DateTile"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_TextTile"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();of.H_={T_:of.getTypeName(),B_:of.getBaseTypes()};var af=function(){function n(o){(0,hr.default)(this,n),m.assign(n,this,o)}return(0,gr.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Text_LinkTile"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_TextTile"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();af.H_={T_:af.getTypeName(),B_:af.getBaseTypes()};g();var Lg=w(Ie()),Fg=w(W()),qg=w(B());var Gg=function(){function n(){(0,Fg.default)(this,n)}return(0,qg.default)(n,[{key:"accumulate",value:function(e,r,t,a){var s=this;if(t===0){a(r,t);return}var u=0,l=0,f=Ne.getTypeName(),c=we.getTypeName(),d=function(b){var E=m.getTypeNameFor(b);return E===f||E==c},h=Math.round(performance.now());h-=h%e.messageRateIntervalMs;var p=[];for(var k of r){var S=k.items.length===1&&d(k)&&!k.items[0].deltas,C=S?G([].concat((0,Lg.default)(k.parentPath),[k.items[0].id])):void 0,T=!this.lastUpdatedItem||this.lastUpdatedItem.itemPathKey!==C;if(l+=k.items.length,S){var x=T||this.lastUpdatedItem.intervalStartTime!==h?1:this.lastUpdatedItem.currentRate+1;this.lastUpdatedItem={itemPathKey:C,intervalStartTime:h,currentRate:x},u++}if(!S||T){this.accumulatedUpdate&&(v.info(508368717,y.CoreDefault,"Pushing accumulated item before the timeout due the pattern change. Seq = "+this.accumulatedUpdate.seq),this.accumulatedUpdate.seq===t?p.push(this.accumulatedUpdate.operation):this.accumulatedUpdate.callback([this.accumulatedUpdate.operation],this.accumulatedUpdate.seq),clearTimeout(this.accumulatedUpdate.timeout),this.accumulatedUpdate=void 0),p.push(k);continue}this.accumulatedUpdate===void 0?this.lastUpdatedItem.currentRate>e.maxRate?(v.info(508368716,y.CoreDefault,"Message rate of "+e.maxRate+" messages per "+e.messageRateIntervalMs+"ms is exceeded - starting to accumulate the changes for single-tile update with seq = "+t+"."),this.accumulatedUpdate={callback:a,operation:k,seq:t,timeout:setTimeout(function(){s.accumulatedUpdate.callback([s.accumulatedUpdate.operation],s.accumulatedUpdate.seq),s.accumulatedUpdate=void 0},e.accumulationTimeoutMs)}):p.push(k):(v.info(508368715,y.CoreDefault,"An item from the message with seq = "+t+" will be sent to item listeners with delay as it's currently being accumulated due to exceeded single-tile update max rate"),this.accumulatedUpdate.operation.items=k.items,this.accumulatedUpdate.seq=t,this.accumulatedUpdate.callback=a)}L("SingleItemUpdatesAccumulatorExtraLogging")&&v.info(508347408,y.CoreDefault,"operations.length: "+r.length+", singleTileOperations: "+u+", totalItemsCount: "+l),p.length&&a(p,t)}}]),n}();g();var Pf=w(Ye()),Of=w(W()),Lf=w(B());g();var zi=w(Ie()),sf=w(W()),uf=w(B());g();var zg=w(Pa()),Vg=w(W()),Qg=w(B());g();var Ug=w(W()),Hg=w(B()),Hi=function(){function n(o,e){if((0,Ug.default)(this,n),this.next=void 0,this.previous=void 0,e==null)throw Error("Argument id cannot be undefined or null.");this.item=o,this._id=e}return(0,Hg.default)(n,[{key:"id",get:function(){return this._id}}]),n}();var $a=function(n){function o(e,r){if((0,Vg.default)(this,o),this.fragmentsById=new Map,this.arrayOfFragmentHeads=[],this.checksEnabled=e||function(){return!0},Array.isArray(r))for(var t of r){var a=void 0;for(var s of t){var u=new Hi(s.item,s.id);this.fragmentsById.set(u.id,u),a?(a.next=u,u.previous=a):this.arrayOfFragmentHeads.push(u),a=u}}}return(0,Qg.default)(o,[{key:n,value:function(){return this.makeIterator(!1)}},{key:"iterator",value:function(){var r=this,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;return(0,zg.default)({},Symbol.iterator,function(){return r.makeIterator(t)})}},{key:"hasItems",value:function(){if(this.arrayOfFragmentHeads.length===0)return!1;for(var r of this.fragmentsById.values())if(r.item)return!0;return!1}},{key:"getItemsWithIds",value:function(){var r,t=new Array(this.arrayOfFragmentHeads.length),a=0;for(var s of this.arrayOfFragmentHeads){for(var u=[],l=s,f=s==null?void 0:s.next;l;)u.push({item:l.item,id:l.id}),l=l.next,f=(r=f==null?void 0:f.next)===null||r===void 0?void 0:r.next,l&&l===f&&(v.error(512231009,y.CoreDefault,"FragList getItemsWithIds Cycle Detected"),l=void 0);t[a++]=u}return t}},{key:"getFragmentHeadIds",value:function(r){var t=[];for(var a of this.arrayOfFragmentHeads)r(a.id,a.item)&&t.push(a.id);return t}},{key:"isFragmented",value:function(){return this.arrayOfFragmentHeads.length>1}},{key:"addItem",value:function(r,t,a,s,u){this.addItems([r],[t],a,s,u)}},{key:"addItems",value:function(r,t,a,s,u){if(v.verbose(573871326,y.CoreDefault,function(){return"FragList: Adding "+t.toString()}),r.length===0){a(Ee.AddOfZeroElements,"");return}if(r.length!==t.length)throw Error("Length of object array doesn't match length of id array.");this.checksEnabled()&&this.checkForSequentialInversion(t,a);var l=this.createFragmentList(r,t);this.removeAlreadyExistingStubFragments(l),this.addFragmentsToMap(l),this.innerAddItems(l,s,u),this.checkState()}},{key:"deleteItem",value:function(r,t){v.verbose(573871327,y.CoreDefault,"FragList: Deleting "+r);var a=this.fragmentsById.get(r);return a===void 0?!1:(this.innerDeleteFragment(a),this.checkState(),!0)}},{key:"updateItem",value:function(r,t,a){v.verbose(573871328,y.CoreDefault,"FragList: Updating "+r);var s=this.fragmentsById.get(r);if(s===void 0)throw Error("Item with id '"+(r!=null?r:"undefined")+"' doesn't exist.");s.item===void 0&&a(Ee.UpdateOfStubbedItem,r),s.item=t,this.checkState()}},{key:"moveItem",value:function(r,t,a,s){v.verbose(573871329,y.CoreDefault,"FragList: Moving "+r);var u=this.fragmentsById.get(r);if(u===void 0){s(Ee.MoveOfNonExistentItem,r);return}this.connectFragments(u.previous,u.next),this.innerAddItems([u],t,a),this.checkState()}},{key:"getItem",value:function(r){var t=this.fragmentsById.get(r);if(t)return t.item}},{key:"checkForSequentialInversion",value:function(r,t){var a=new Set(r);for(var s of r){a.delete(s);var u=this.fragmentsById.get(s);if(u){for(var l=u.previous;l;l=l.previous)if(a.has(l.id)){t(Ee.SequentialyInvertedUpdate,l.id);return}}}}},{key:"checkState",value:function(){if(this.checksEnabled()){var r=[];for(var t of this.iterator(!1))t!=null&&r.push(t);var a=[];for(var s of this.fragmentsById.values())s.item!=null&&a.push(s.item);this.checkSizeOfArrayAndMapAreSame(r,a),this.checkArrayAndMapAreIdentical(r,a)}}},{key:"checkSizeOfArrayAndMapAreSame",value:function(r,t){return r.length!=t.length?(v.error(573871330,y.CoreDefault,r.length+" items available, but "+t.length+" items in the map"),!1):!0}},{key:"checkArrayAndMapAreIdentical",value:function(r,t){var a=!0;for(var s of t){var u=r.indexOf(s);u==-1?(v.error(573871331,y.CoreDefault,"Can't reach element "+s),a=!1):r.splice(u,1)}for(var l of r)v.error(573871360,y.CoreDefault,"Element: "+l+" in the sorted array that isn't in the map."),a=!1;return a}},{key:"innerAddItems",value:function(r,t,a){var s=this.getOrCreateFragment(t),u=this.getOrCreateFragment(a);s&&s.next&&this.disconnectFragments(s,s.next),u&&u.previous&&this.disconnectFragments(u.previous,u),this.connectFragments(s,r[0]),this.connectFragments(r[r.length-1],u)}},{key:"makeIterator",value:function(r){var t=this,a=-1,s=void 0,u=void 0;return{next:function(){for(var f;a<t.arrayOfFragmentHeads.length;){for(;s;){var c=s;if(s=s.next,u=(f=u==null?void 0:u.next)===null||f===void 0?void 0:f.next,c&&c===u&&(v.error(512231008,y.CoreDefault,"FragList Iterator Cycle Detected."),s=void 0),c.item||r)return{value:c.item,done:!1}}a++,s=a<t.arrayOfFragmentHeads.length?t.arrayOfFragmentHeads[a]:void 0,u=s}return{value:void 0,done:!0}}}}},{key:"innerDeleteFragment",value:function(r){this.fragmentsById.delete(r.id),this.removeFragmentFromHeadList(r),this.connectFragments(r.previous,r.next)}},{key:"removeFragmentFromHeadList",value:function(r){var t=this.arrayOfFragmentHeads.indexOf(r);t!=-1&&this.arrayOfFragmentHeads.splice(t,1)}},{key:"addFragmentsToMap",value:function(r){for(var t of r)this.fragmentsById.set(t.id,t)}},{key:"createFragmentList",value:function(r,t){var a=new Array(r.length);a[0]=new Hi(r[0],t[0]);for(var s=1;s<r.length;s++)a[s]=new Hi(r[s],t[s]),a[s-1].next=a[s],a[s].previous=a[s-1];return a}},{key:"removeAlreadyExistingStubFragments",value:function(r){for(var t of r){var a=this.fragmentsById.get(t.id);a&&(a.item!=null&&v.info(573871361,y.CoreDefault,"Already Existing Item: "+a.id),this.innerDeleteFragment(a))}}},{key:"getOrCreateFragment",value:function(r){if(r!=null){var t=this.fragmentsById.get(r);return t===void 0&&(t=new Hi(void 0,r),this.fragmentsById.set(r,t)),t}}},{key:"connectFragments",value:function(r,t){if(r&&(r.next=t,r.previous==null)){var a=this.arrayOfFragmentHeads.indexOf(r);a===-1&&this.arrayOfFragmentHeads.push(r)}if(t)if(t.previous=r,r){var s=this.arrayOfFragmentHeads.indexOf(t);s!==-1&&this.arrayOfFragmentHeads.splice(s,1)}else this.arrayOfFragmentHeads.push(t)}},{key:"disconnectFragments",value:function(r,t){!r||!t||(r.next=void 0,t.previous=void 0,this.arrayOfFragmentHeads.push(t))}}]),o}(Symbol.iterator);function oI(){return!1}var iI=function(){function n(o){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;(0,sf.default)(this,n),this.id=o,this.parent=e}return(0,uf.default)(n,[{key:"getPath",value:function(){for(var e=this,r=0;e!==null;)r+=1,e=e.parent;var t=new Array(r);for(e=this;r>0;)r-=1,t[r]=e.id,e=e.parent;return t}},{key:"getParentPath",value:function(){var e,r;return(r=(e=this.parent)===null||e===void 0?void 0:e.getPath())!==null&&r!==void 0?r:[]}}]),n}(),Vi=Symbol("path");function aI(){return this[Vi].getParentPath()}function sI(n){Object.defineProperty(this,"parentPath",{value:n,writable:!0,configurable:!0,enumerable:!0})}function jg(){var n={id:"#root#",parentPath:[]};return L("CompressItemPathsEnabled")&&(n[Vi]=null),n}function uI(n,o){var e=o.parentPath.length===0&&o.id==="#root#"?[]:[].concat((0,zi.default)(o.parentPath),[o.id]),r=n;return r.parentPath=e,r}function Ro(n,o){var e=o[Vi];return e!==void 0?(n[Vi]=new iI(n.id,e),Object.defineProperty(n,"parentPath",{get:aI,set:sI,configurable:!0,enumerable:!0}),n):uI(n,o)}var Jg=function(){function n(o,e){(0,sf.default)(this,n),this.itemWithPath=o.item,o.childNodes&&o.childNodes.length>0?this.childNodes=new $a(e,o.childNodes.map(function(r){return r.map(function(t){return{id:t.id,item:t.item?new n(t.item,e):void 0}})})):L("LeavesHaveNoChildrenOptimizationEnabled")?this.checksEnabled=e:this.childNodes=new $a(e)}return(0,uf.default)(n,[{key:"itemWithPath",get:function(){return this.item},set:function(e){this.item=e}},{key:"serializableForm",value:function(){var e,r,t=(r=(e=this.childNodes)===null||e===void 0?void 0:e.getItemsWithIds())!==null&&r!==void 0?r:[];return{item:this.itemWithPath,childNodes:t.map(function(a){return a.map(function(s){return{id:s.id,item:s.item?s.item.serializableForm():void 0}})})}}},{key:"loggableForm",value:function(){var e,r,t=(r=(e=this.childNodes)===null||e===void 0?void 0:e.getItemsWithIds())!==null&&r!==void 0?r:[];return{id:this.item.id,type:m.getTypeNameFor(this.itemWithPath.body),childNodeIds:t.map(function(a){return a.map(function(s){return s.id})})}}},{key:"normalizeEmptyChildren",value:function(){this.ensureChildNodeList(),this.checksEnabled=void 0}},{key:"visitChildNodesSync",value:function(e){var r;for(var t of(r=this.childNodes)!==null&&r!==void 0?r:[])e(t)}},{key:"visitChildNodesWithFragListStubsSync",value:function(e){var r,t;for(var a of(t=(r=this.childNodes)===null||r===void 0?void 0:r.iterator(!0))!==null&&t!==void 0?t:[])e(a)}},{key:"visitAllLeafDescendantNodesSync",value:function(e){var r;for(var t of(r=this.childNodes)!==null&&r!==void 0?r:[])t.hasChildren()?t.visitAllLeafDescendantNodesSync(e):e(t)}},{key:"visitSubtree",value:function(e){var r;e(this);for(var t of(r=this.childNodes)!==null&&r!==void 0?r:[])t.visitSubtree(e)}},{key:"getNodeInSubtree",value:function(e,r,t){if(e.length===0)return this;t=t||{createInferredNodes:!1};for(var a=this,s=void 0,u=0;u<e.length;u++){var l=e[u];if(s=a.getChildNodeById(l),!s&&t.createInferredNodes&&(this.item[Vi]===void 0?s=r({id:l,parentPath:[].concat((0,zi.default)(this.getPath()),(0,zi.default)(e.slice(0,u)))}):s=r(Ro({id:l},a.item)),a.ensureChildNodeList(),a.childNodes.addItem(s,l,null)),!s)return;a=s}return s}},{key:"addChildItems",value:function(e,r,t,a,s){this.ensureChildNodeList(),this.childNodes.addItems(r,t,e,a,s)}},{key:"updateChildItem",value:function(e,r,t){this.ensureChildNodeList(),this.childNodes.updateItem(e,r,t)}},{key:"deleteChildItem",value:function(e,r){var t;(t=this.childNodes)===null||t===void 0||t.deleteItem(e,r)}},{key:"hasChildren",value:function(){var e,r;return(r=(e=this.childNodes)===null||e===void 0?void 0:e.hasItems())!==null&&r!==void 0?r:!1}},{key:"getChildNodeById",value:function(e){var r;return(r=this.childNodes)===null||r===void 0?void 0:r.getItem(e)}},{key:"getFragmentHeadIds",value:function(e){var r,t;return(t=(r=this.childNodes)===null||r===void 0?void 0:r.getFragmentHeadIds(e))!==null&&t!==void 0?t:[]}},{key:"ensureChildNodeList",value:function(){var e;this.childNodes===void 0&&(this.childNodes=new $a((e=this.checksEnabled)!==null&&e!==void 0?e:oI))}},{key:"getPath",value:function(){return this.item.parentPath.length===0&&this.item.id==="#root#"?[]:[].concat((0,zi.default)(this.item.parentPath),[this.item.id])}}]),n}();g();var be=w(W()),Me=w(B());var lf=function(){function n(o){(0,be.default)(this,n),m.assign(n,this,o)}return(0,Me.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelMetadata"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();lf.H_={T_:lf.getTypeName(),B_:lf.getBaseTypes()};var ro=function(){function n(o){(0,be.default)(this,n),m.assign(n,this,o)}return(0,Me.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_Worksheet"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_TileGroup"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();ro.H_={T_:ro.getTypeName(),B_:ro.getBaseTypes()};var ff=function(){function n(o){(0,be.default)(this,n),m.assign(n,this,o)}return(0,Me.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_WorksheetMetadata"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();ff.H_={T_:ff.getTypeName(),B_:ff.getBaseTypes()};var cf=function(){function n(o){(0,be.default)(this,n),m.assign(n,this,o)}return(0,Me.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelRange"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();cf.H_={T_:cf.getTypeName(),B_:cf.getBaseTypes()};var df=function(){function n(o){(0,be.default)(this,n),m.assign(n,this,o)}return(0,Me.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelRangeWrapper"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();df.H_={T_:df.getTypeName(),B_:df.getBaseTypes()};var pf=function(){function n(o){(0,be.default)(this,n),m.assign(n,this,o)}return(0,Me.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelRangeWrapperAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();pf.H_={T_:pf.getTypeName(),B_:pf.getBaseTypes()};var hf=function(){function n(o){(0,be.default)(this,n),m.assign(n,this,o)}return(0,Me.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_BaseExcelBlock"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_ExcelRangeWrapper"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();hf.H_={T_:hf.getTypeName(),B_:hf.getBaseTypes()};var gf=function(){function n(o){(0,be.default)(this,n),m.assign(n,this,o)}return(0,Me.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelBlock"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_BaseExcelBlock","AugLoop_Excel_ExcelRangeWrapper"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();gf.H_={T_:gf.getTypeName(),B_:gf.getBaseTypes()};var mf=function(){function n(o){(0,be.default)(this,n),m.assign(n,this,o)}return(0,Me.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelExtendedBlock"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_BaseExcelBlock","AugLoop_Excel_ExcelRangeWrapper"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();mf.H_={T_:mf.getTypeName(),B_:mf.getBaseTypes()};var vf=function(){function n(o){(0,be.default)(this,n),m.assign(n,this,o)}return(0,Me.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelMergedCellInfo"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_ExcelRange"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();vf.H_={T_:vf.getTypeName(),B_:vf.getBaseTypes()};var yf=function(){function n(o){(0,be.default)(this,n),m.assign(n,this,o)}return(0,Me.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelRangeFilter"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_ItemFilter"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();yf.H_={T_:yf.getTypeName(),B_:yf.getBaseTypes()};var kf=function(){function n(o){(0,be.default)(this,n),m.assign(n,this,o)}return(0,Me.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelGridSubtreeFilter"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_ItemFilter"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();kf.H_={T_:kf.getTypeName(),B_:kf.getBaseTypes()};var wf=function(){function n(o){(0,be.default)(this,n),m.assign(n,this,o)}return(0,Me.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelRangeSampleFilter"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_ExcelRangeFilter","AugLoop_Core_ItemFilter"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();wf.H_={T_:wf.getTypeName(),B_:wf.getBaseTypes()};var Sf=function(){function n(o){(0,be.default)(this,n),m.assign(n,this,o)}return(0,Me.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelTableColumn"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_ExcelRangeWrapperAnnotation","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Sf.H_={T_:Sf.getTypeName(),B_:Sf.getBaseTypes()};var Cf=function(){function n(o){(0,be.default)(this,n),m.assign(n,this,o)}return(0,Me.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_BaseExcelTable"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_ExcelRangeWrapper"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Cf.H_={T_:Cf.getTypeName(),B_:Cf.getBaseTypes()};var xf=function(){function n(o){(0,be.default)(this,n),m.assign(n,this,o)}return(0,Me.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelTable"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_BaseExcelTable","AugLoop_Excel_ExcelRangeWrapper"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();xf.H_={T_:xf.getTypeName(),B_:xf.getBaseTypes()};var Tf=function(){function n(o){(0,be.default)(this,n),m.assign(n,this,o)}return(0,Me.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelPivotTable"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_BaseExcelTable","AugLoop_Excel_ExcelRangeWrapper"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Tf.H_={T_:Tf.getTypeName(),B_:Tf.getBaseTypes()};var Qi=function(){function n(o){(0,be.default)(this,n),m.assign(n,this,o)}return(0,Me.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelCell"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_GridCell"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Qi.H_={T_:Qi.getTypeName(),B_:Qi.getBaseTypes()};var If=function(){function n(o){(0,be.default)(this,n),m.assign(n,this,o)}return(0,Me.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelMergedCell"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_ExcelRangeWrapper"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();If.H_={T_:If.getTypeName(),B_:If.getBaseTypes()};var _f=function(){function n(o){(0,be.default)(this,n),m.assign(n,this,o)}return(0,Me.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_ExcelTableAi_ExcelRangeAddressNew"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_ExcelRange"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();_f.H_={T_:_f.getTypeName(),B_:_f.getBaseTypes()};var Af=function(){function n(o){(0,be.default)(this,n),m.assign(n,this,o)}return(0,Me.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_ExcelTableAi_ExcelRecognizedTableNew"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_ExcelRangeWrapperAnnotation","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Af.H_={T_:Af.getTypeName(),B_:Af.getBaseTypes()};var bf=function(){function n(o){(0,be.default)(this,n),m.assign(n,this,o)}return(0,Me.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelDetectedTableBoundaryPartNew"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();bf.H_={T_:bf.getTypeName(),B_:bf.getBaseTypes()};var Mf=function(){function n(o){(0,be.default)(this,n),m.assign(n,this,o)}return(0,Me.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_ExcelTableAi_ExcelDetectedTableBoundaryNew"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_ExcelRangeWrapperAnnotation","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Mf.H_={T_:Mf.getTypeName(),B_:Mf.getBaseTypes()};var Ef=function(){function n(o){(0,be.default)(this,n),m.assign(n,this,o)}return(0,Me.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_ExcelTableAi_ExcelTableDataGridPartNew"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Ef.H_={T_:Ef.getTypeName(),B_:Ef.getBaseTypes()};var Rf=function(){function n(o){(0,be.default)(this,n),m.assign(n,this,o)}return(0,Me.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelComparisonAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Rf.H_={T_:Rf.getTypeName(),B_:Rf.getBaseTypes()};var Nf=function(){function n(o){(0,be.default)(this,n),m.assign(n,this,o)}return(0,Me.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelComparisonItem"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Nf.H_={T_:Nf.getTypeName(),B_:Nf.getBaseTypes()};var Df=function(){function n(o){(0,be.default)(this,n),m.assign(n,this,o)}return(0,Me.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_EcsAccessInfo"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Df.H_={T_:Df.getTypeName(),B_:Df.getBaseTypes()};var Wf=function(){function n(o){(0,be.default)(this,n),m.assign(n,this,o)}return(0,Me.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_DirtyRangeSignal"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_DirtyAreaSignal","AugLoop_Signals_Signal"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Wf.H_={T_:Wf.getTypeName(),B_:Wf.getBaseTypes()};g();var Kg=w(W()),$g=w(B()),Xg=function(){function n(){(0,Kg.default)(this,n),this.string2internedString=new Map,this.hitCount=0}return(0,$g.default)(n,[{key:"intern",value:function(e){var r=this.string2internedString.get(e);return r!==void 0?(this.hitCount+=1,r):(this.string2internedString.set(e,e),e)}},{key:"clear",value:function(){this.string2internedString.clear(),this.hitCount=0}},{key:"hits",get:function(){return this.hitCount}},{key:"size",get:function(){return this.string2internedString.size}},{key:"hitRate",value:function(){return this.hits/(this.hits+this.size)}}]),n}();g();var Yg=w(Ie());function Zg(){var n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:void 0,o=new Map,e=function(t){if(t==null){v.error(572837961,y.CoreDefault,"Attempt to call a generic function on undefined or null");return}var a=void 0;for(var s of[m.getTypeNameFor(t)].concat((0,Yg.default)(m.getBaseTypesFor(t)),[void 0])){var u=o.get(s);if(u!==void 0){a=u;break}}if(a===void 0){v.error(572837962,y.CoreDefault,"Cannot find generic implementation for type "+m.getTypeNameFor(t));return}for(var l=arguments.length,f=new Array(l>1?l-1:0),c=1;c<l;c++)f[c-1]=arguments[c];return a.apply(void 0,[t].concat(f))};return e.set=function(r,t){o.set(r,t)},e}g();var Xa=w(Ye()),em=w(W()),tm=w(B());var lI=new F("enableTreeLevelsByItemTypeCaching",!0),Bf=function(){function n(o,e){(0,em.default)(this,n),this.levelsByTypeMap=e!=null?e:new Map,this._isEnabled=o!=null?o:lI.getValue()}return(0,tm.default)(n,[{key:"isEnabled",get:function(){return this._isEnabled}},{key:"size",get:function(){return this.levelsByTypeMap.size}},{key:"add",value:function(e){this._isEnabled&&n.add(this.levelsByTypeMap,e)}},{key:"addNodes",value:function(e){if(this._isEnabled)for(var r of e)n.add(this.levelsByTypeMap,r.itemWithPath)}},{key:"addSubtree",value:function(e){var r=this;this._isEnabled&&e.visitSubtree(function(t){r.add(t.itemWithPath)})}},{key:"remove",value:function(e){var r,t;if(!(!this._isEnabled||!(!((r=e==null?void 0:e.body)===null||r===void 0)&&r.H_))){var a=e.parentPath.length;e.body.H_.T_&&this.removeType(e.body.H_.T_,a);for(var s of(t=e.body.H_.B_)!==null&&t!==void 0?t:[])this.removeType(s,a)}}},{key:"removeSubtree",value:function(e){var r=this;this._isEnabled&&e.visitSubtree(function(t){r.remove(t.itemWithPath)})}},{key:"update",value:function(e,r){if(this._isEnabled){var t=this.getAllTypesSet(e);if(!t){this.add(r);return}var a=this.getAllTypesSet(r);if(!a){this.remove(e);return}var s=r.parentPath.length;for(var u of t)a.has(u)||this.removeType(u,s);for(var l of a)t.has(l)||n.addType(this.levelsByTypeMap,l,s)}}},{key:"getLevels",value:function(e){return this.levelsByTypeMap.get(e)}},{key:"compare",value:function(e){var r,t=void 0;for(var a of e){var s=(0,Xa.default)(a,2),u=s[0],l=s[1];if(!this.levelsByTypeMap.has(u)){t={itemType:u,expected:Array.from(l.entries()),actual:null};break}var f=this.levelsByTypeMap.get(u);for(var c of l){var d=(0,Xa.default)(c,2),h=d[0],p=d[1],k=(r=f.get(h))!==null&&r!==void 0?r:0;if(k!=p){t={itemType:u,expected:Array.from(l.entries()),actual:Array.from(f.entries())};break}}}for(var S of this.levelsByTypeMap){var C=(0,Xa.default)(S,2),T=C[0],x=C[1];if(t)break;if(!e.has(T)){for(var A of x.values())if(A>0){t={itemType:T,expected:null,actual:Array.from(x.entries())};break}}}return t}},{key:"removeType",value:function(e,r){var t=this.levelsByTypeMap.get(e);if(t){var a=t.get(r);t.set(r,a-1)}}},{key:"getAllTypesSet",value:function(e){var r,t,a;if(!((t=(r=e==null?void 0:e.body)===null||r===void 0?void 0:r.H_)===null||t===void 0)&&t.T_){var s=new Set;s.add(e.body.H_.T_);for(var u of(a=e.body.H_.B_)!==null&&a!==void 0?a:[])s.add(u);return s}}}],[{key:"add",value:function(e,r){var t,a;if(!((t=r==null?void 0:r.body)===null||t===void 0)&&t.H_){var s=r.parentPath.length;r.body.H_.T_&&n.addType(e,r.body.H_.T_,s);for(var u of(a=r.body.H_.B_)!==null&&a!==void 0?a:[])n.addType(e,u,s)}}},{key:"addType",value:function(e,r,t){var a,s=e.get(r);if(!s)s=new Map,s.set(t,1),e.set(r,s);else{var u=(a=s.get(t))!==null&&a!==void 0?a:0;s.set(t,u+1)}}}]),n}();var nm=new F("modelLogMinDurationInMs",30),fI=new F("percentageOfGetSubtreeItemsLogs",5),cI=["formulaR1C1Json","numberFormat","numberFormatCategory","fillColor","fontColor"],Ff=Zg(function(n,o){});Ff.set(void 0,function(){});Ff.set(Qi.getTypeName(),function(n,o){if(o!==void 0)for(var e of cI)n[e]!==void 0&&(n[e]=o.intern(n[e]))});var dI=function(){function n(o,e,r){(0,Of.default)(this,n),this._itemIds=[],this._newNodes=[],this._lastPrevId=e,this._createNode=r,o?(this._addItem=this.addItemIfNotDuplicate,this._uniqueIds=new Set):this._addItem=this.addItem}return(0,Lf.default)(n,[{key:"lastPrevId",get:function(){return this._lastPrevId}},{key:"itemIds",get:function(){return this._itemIds}},{key:"newNodes",get:function(){return this._newNodes}},{key:"addItemIfNeeded",value:function(e,r){this._addItem(e,r)}},{key:"reset",value:function(e){this._itemIds=[],this._newNodes=[],this._lastPrevId=e,this._uniqueIds&&(this._uniqueIds=new Set)}},{key:"addItem",value:function(e){this._itemIds.push(e.id);var r=this._createNode(e);this._newNodes.push(r)}},{key:"addItemIfNotDuplicate",value:function(e,r){if(this._uniqueIds.has(e.id))r(Ee.AddOfItemsWithDuplicateIds,e.id);else{this._uniqueIds.add(e.id),this._itemIds.push(e.id);var t=this._createNode(e);this._newNodes.push(t)}}}]),n}(),No=function(){function n(){var o=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1,e=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0;(0,Of.default)(this,n),this._firstSeenSchemaObjectTypes=new Map,this.cellLookup=new Map,this.shouldErrorCheck=function(){return!1},this.root=this.createNode(jg()),this.root.itemWithPath.parentPath=[],this.nextAnnotationId=o,this.maxNodeCount=1,this.nodeCount=1,L("InternExcelCellProperties")&&(this.interner=new Xg),this.levelsByTypeCache=new Bf(e,r)}return(0,Lf.default)(n,[{key:"firstSeenSchemaObjectTypes",get:function(){return this._firstSeenSchemaObjectTypes}},{key:"getNextAnnotationId",value:function(){return"#A"+this.nextAnnotationId++}},{key:"serializableForm",value:function(){return{nextAnnotationId:this.nextAnnotationId}}},{key:"serializeAllNodes",value:function(){var e=new Array(this.nodeCount),r=0;return this.root.visitSubtree(function(t){e[r++]=t.serializableForm()}),e}},{key:"addItems",value:function(e,r,t,a,s){var u=this,l,f;if(t.length!==0){if(L("PreventFragCyclesWithPrevAndNextIds")){var c=this.updatePrevAndNextIdsIfCycles(t,a,s);a=c.prevId,s=c.nextId}var d=this.shouldErrorCheck(),h=new dI(d,a,this.createNode.bind(this)),p=this.root.getNodeInSubtree(r,this.createNode.bind(this),{createInferredNodes:!0}),k=p.itemWithPath;if(d){var S=t.map(function(b){return u.ensureItemId(b),b.id.toString()}).join(", ");v.info(527745699,y.CoreDefault,"Add items with ids: "+S+", parentItemId: "+k.id+", previousItemId: "+a+", nextItemId: "+s+".")}for(var C of t){this.ensureItemId(C),C.body!=null&&(this.addCell(r,C),Ff(C.body,this.interner),this.reportSeenType(C.body));var T=Ro(C,k),x=p.getChildNodeById(T.id);if(x){!((l=x.itemWithPath)===null||l===void 0)&&l.body&&(!((f=T==null?void 0:T.id)===null||f===void 0)&&f.match(/R(\d+)C(\d+)/)||v.info(527745728,y.CoreDefault,"Already Existing Item: "+T.id));var A=x.itemWithPath;x.itemWithPath=T,this.levelsByTypeCache.update(A,T),h.newNodes.length>0&&(p.addChildItems(e,h.newNodes,h.itemIds,h.lastPrevId,C.id),this.levelsByTypeCache.addNodes(h.newNodes),h.reset(T.id))}else h.addItemIfNeeded(T,e)}h.newNodes.length>0&&(p.addChildItems(e,h.newNodes,h.itemIds,h.lastPrevId,s),this.levelsByTypeCache.addNodes(h.newNodes))}}},{key:"updateItems",value:function(e,r,t){if(t.length!==0){var a=U().startSync(hn.UpdateModelItems),s=this.root.getNodeInSubtree(r,this.createNode.bind(this),{createInferredNodes:!1});s||(e(Ee.UpdateOfNonExistentItem,r[r.length-1]),s=this.root.getNodeInSubtree(r,this.createNode.bind(this),{createInferredNodes:!0}));var u=s.itemWithPath;for(var l of t){if(!l.id){e(Ee.UpdateOfNonExistentItem,void 0);continue}var f=Ro(l,u),c=s.getChildNodeById(f.id);if(!c){e(Ee.UpdateOfNonExistentItem,f.id),c=this.createNode(f),s.addChildItems(e,[c],[f.id]),this.levelsByTypeCache.add(f);continue}var d=c.itemWithPath;c.itemWithPath=f,s.updateChildItem(l.id,c,e),this.levelsByTypeCache.update(d,f)}U().stop(a)}}},{key:"deleteItems",value:function(e,r,t){if(t.length!==0){var a=this.root.getNodeInSubtree(r,this.createNode.bind(this),{createInferredNodes:!1});if(!a){e(Ee.DeleteOfNonExistingItem,r[r.length-1]);return}var s=a.itemWithPath;this.shouldErrorCheck()&&v.info(527745729,y.CoreDefault,"Delete items with ids: "+t.map(function(f){return f.id.toString()}).join(", ")+", parentItemId: "+s.id);for(var u of t){var l=a.getChildNodeById(u.id);if(!l){e(Ee.DeleteOfNonExistingItem,u.id);continue}this.levelsByTypeCache.removeSubtree(l),a.deleteChildItem(u.id,e),this.deleteNode(l)}}}},{key:"moveItems",value:function(e,r,t,a,s,u){var l=this;if(a.length!==0){var f=this.root.getNodeInSubtree(r,this.createNode.bind(this),{createInferredNodes:!1});if(!f){e(Ee.MoveOfNonExistentItem,r[r.length-1]);return}if(L("PreventFragCyclesWithPrevAndNextIds")){var c=this.updatePrevAndNextIdsIfCycles(a,s,u);s=c.prevId,u=c.nextId}var d=this.root.getNodeInSubtree(t,this.createNode.bind(this),{createInferredNodes:!0}),h=d.itemWithPath,p=[],k=[],S=function(){var x=f.getChildNodeById(C.id);if(!x)return e(Ee.DeleteOfNonExistingItem,C.id),1;p.push(x),k.push(C.id),l.levelsByTypeCache.removeSubtree(x),x.itemWithPath=Ro(Object.assign({},x.itemWithPath),h);var A=function b(E){E.visitChildNodesSync(function(I){I.itemWithPath=Ro(Object.assign({},I.itemWithPath),E.itemWithPath),b(I)})};A(x),l.levelsByTypeCache.addSubtree(x),f.deleteChildItem(C.id,e)};for(var C of a)S();d.addChildItems(e,p,k,s,u)}}},{key:"getItem",value:function(e){if(e.length===0)throw new Error("Invalid item path");var r=this.root.getNodeInSubtree(e,this.createNode.bind(this));if(r)return r.itemWithPath}},{key:"hasItem",value:function(e){if(e.length===0)return!1;var r=this.root.getNodeInSubtree(e,this.createNode.bind(this));return!!r}},{key:"getCells1D",value:function(e,r,t,a,s){var u=[],l=this.cellLookup.get(e);if(!l)throw new Error("unable to find a worksheet for the requested id");var f=br.lowerIndexBound,c=l.length-1;r=Math.max(r,f),t=Math.min(t,c),a=Math.max(a,f);for(var d=r;d<=t;d++)if(Array.isArray(l[d]))for(var h=l[d].length-1,p=Math.min(s,h),k=a;k<=p;k++)l[d][k]&&u.push(l[d][k]);return u}},{key:"getSubtreeItems",value:function(e,r,t){var a=U().startSync(hn.GetModelSubTreeItems);try{return!this.levelsByTypeCache.isEnabled||!Array.isArray(r)||r.length===0||r.some(function(s){return!s})?this.getSubtreeItemsFullSearch(e,r,t):this.getSubtreeItemsIndexed(e,r,t)}finally{U().stop(a)}}},{key:"getItemChildren",value:function(e,r){var t=U().startSync(hn.GetModelItemChildren);try{var a=[],s=this.root.getNodeInSubtree(e,this.createNode.bind(this));return s?(s.visitChildNodesSync(function(u){(!r||m.matchesTypesFor(u.itemWithPath.body,r))&&a.push(u.itemWithPath)}),a):void 0}finally{U().stop(t)}}},{key:"visitItemPathSync",value:function(e,r){var t=this.root;for(var a of e){if(t=t.getNodeInSubtree([a],this.createNode.bind(this)),!t)throw new Error("Ancestor item not found");if(r(t.itemWithPath))return}}},{key:"getMaxItemCount",value:function(){return this.maxNodeCount}},{key:"analyzeTreeLevelsByItemTypeCacheErrors",value:function(){var e=this,r=new Map,t=new D({operationName:"AnalyzeTreeLevelsByItemTypeCacheConsistency",success:!0}).start(),a=function l(f){Bf.add(r,f.itemWithPath),f.visitChildNodesSync(function(c){return l(c)})};this.root.visitChildNodesSync(function(l){return a(l)});var s=this.levelsByTypeCache.compare(r);t.success=!s,t.stop();var u=function(){return t.resultDescription="maxItemCount: "+e.maxNodeCount.toString()+". diff: "+JSON.stringify(s),t};return t.success===!1||t.durationMs>nm.getValue()?v.info(528589721,y.CoreDefault,u):v.debug(528589722,y.CoreDefault,u),t.success}},{key:"setShouldErrorCheck",value:function(e){this.shouldErrorCheck=e}},{key:"getSubtreeItemsFullSearch",value:function(e,r,t){var a=this,s;Array.isArray(r)&&t?s=function(k){return t(k)&&m.matchesTypesFor(k.body,r)}:Array.isArray(r)&&!t?s=function(k){return m.matchesTypesFor(k.body,r)}:s=r||function(){return!0};var u=new D({operationName:"getSubtreeItemsFullSearch",success:!0}).start(),l=[],f=0,c=function p(k){f++,s(k.itemWithPath)&&l.push(k.itemWithPath),k.visitChildNodesSync(function(S){return p(S)})};if(e.length===0)this.root.visitChildNodesSync(function(p){return c(p)});else{var d=this.root.getNodeInSubtree(e,this.createNode.bind(this));if(!d)throw new Error("Failed to get item for path "+G(e)+" in model");c(d)}u.stop();var h=function(){return u.resultDescription="maxItemCount= "+a.maxNodeCount.toString()+". subtreeSize="+f+". results="+l.length+".",u};return n.shouldLogGetSubtreeItemsMetric(u)?v.info(529056927,y.CoreDefault,h):v.debug(529056928,y.CoreDefault,h),l}},{key:"getSubtreeItemsIndexed",value:function(e,r,t){var a=this,s=new D({operationName:"getSubtreeItemsIndexed",success:!0}).start(),u=this.calculateItemTypesByLevelAndMaxLevel(r),l=(0,Pf.default)(u,2),f=l[0],c=l[1];if(f.size===0)return[];var d;t?d=function(x,A){return t(x)&&m.matchesTypesFor(x.body,A)}:d=function(x,A){return m.matchesTypesFor(x.body,A)};var h=[],p=0,k=function T(x,A,b){p++,b&&d(x.itemWithPath,b)&&h.push(x.itemWithPath),A<c&&x.visitChildNodesSync(function(E){return T(E,A+1,f.get(A+1))})};if(e.length===0)this.root.visitChildNodesSync(function(T){return k(T,0,f.get(0))});else{var S=this.root.getNodeInSubtree(e,this.createNode.bind(this));if(!S)throw new Error("Failed to get item for path "+G(e)+" in model");k(S,e.length-1,f.get(e.length-1))}s.stop();var C=function(){var x={maxInputCount:a.maxNodeCount,visitedNodesCount:p,resultsCount:h.length,cacheSize:a.levelsByTypeCache.size,itemTypes:r.join(", ")};return s.resultDescription=JSON.stringify(x),s};return n.shouldLogGetSubtreeItemsMetric(s)?v.info(572837889,y.CoreDefault,C):v.debug(572837890,y.CoreDefault,C),h}},{key:"calculateItemTypesByLevelAndMaxLevel",value:function(e){var r=this,t=new Map,a=-1,s=function(f){var c=r.levelsByTypeCache.getLevels(f);if(c)for(var d of c){var h=(0,Pf.default)(d,2),p=h[0],k=h[1];if(!(k<=0)){var S=t.get(p);S||(S=[],t.set(p,S),a<p&&(a=p)),S.push(f)}}};for(var u of e)s(u);return[t,a]}},{key:"createNode",value:function(e){Ag(e.id)||v.warn(572837893,y.CoreDefault,"ItemId "+e.id+" does not meet length/charset requirements");var r=new Jg({item:e,childNodes:[]},this.shouldErrorCheck);return this.nodeCount++,this.nodeCount>this.maxNodeCount&&(this.maxNodeCount=this.nodeCount),r}},{key:"deleteNode",value:function(e){e&&e.hasChildren()&&v.error(572837894,y.CoreDefault,"Destroying node which has children. This can result in orphaned children in our map of all nodes."),this.nodeCount--,this.nodeCount<0&&v.error(572837895,y.CoreDefault,"Model is in inconsistent state, total nodes count is less than zero.")}},{key:"addCell",value:function(e,r){if(m.matchesTypesFor(r.body,[sr.getTypeName()])){var t=r.body,a=this.cellLookup.get(e[e.length-1]);a||(a=[]),Array.isArray(a[t.row])||(a[t.row]=[]),a[t.row][t.column]=r,this.cellLookup.set(e[e.length-1],a)}}},{key:"reportSeenType",value:function(e){var r;for(var t of m.getAllTypesFor(e)){var a=this._firstSeenSchemaObjectTypes.get(t);a||(r||(r=Date.now()),this._firstSeenSchemaObjectTypes.set(t,r))}}},{key:"ensureItemId",value:function(e){e.id||(e.id=dn(),v.info(527745730,y.CoreDefault,"Assigning "+e.id+" to child item provided without an id"))}},{key:"updatePrevAndNextIdsIfCycles",value:function(e,r,t){for(var a of e)if(a.id===r||a.id===t)return v.info(512233806,y.CoreDefault,"Incoming operation with prevId or nextId the same as the item.id: "+a.id),{prevId:void 0,nextId:void 0};return{prevId:r,nextId:t}}}],[{key:"fromSerializableForm",value:function(e){return new n(e.nextAnnotationId)}},{key:"shouldLogGetSubtreeItemsMetric",value:function(e){return L("LogPercOfGetSubtreeItems")?100*Math.random()<=fI.getValue():e.durationMs>nm.getValue()}}]),n}();function pI(n){var o=hI();return function(){var r=(0,qf.default)(n),t;if(o){var a=(0,qf.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,um.default)(this,t)}}function hI(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var rm=new F("hotCacheLogMinDurationInMs",30),om=new F("moveOperationEnabled",!1),gI=new F("singleItemUpdatesAccumulatorSettings",{}),fm=function(n){(0,sm.default)(e,n);var o=pI(e);function e(r,t,a){var s;return(0,im.default)(this,e),s=o.call(this),s.itemListeners=new Ja,s.stats={maxItemCount:0,firstSeenSchemaObjectTypes:new Map,documentUrlAvailable:!1},s.deltaHandlers=new Map,s.consistencyErrorLogger=r,s.model=t||new No,s.model.setShouldErrorCheck(function(){return!1}),s.itemUpdatesAccumulator=a!=null?a:new Gg,s}return(0,am.default)(e,[{key:"getSerializedCache",value:function(){return{allNodes:this.model.serializeAllNodes()}}},{key:"applyOperations",value:function(t,a){var s=this,u=U(),l=u.startSync(hn.ApplyOperations),f=0,c=0,d=!1,h=t.length,p=new D({operationName:"HotCacheApplyOperations",success:!0},{metricDuration:!0}).start(),k=[],S=[],C=function(b){var E=m.getTypeNameFor(b),I=function(J,ce){s.consistencyErrorLogger.logModelOperationError(E,b,J,ce),L("mastermindSendOpErrors")&&S.push({path:[].concat((0,gn.default)(b.parentPath),[ce]),errorCode:J})};if(s.model.shouldErrorCheck()){var _=function(){var J=4e3,ce=100,ae=b.items.length>ce,re=ae?b.items.slice(0,ce):b.items,V=re.map(function(ke){return ke.id}).join(", "),me=V.length>J,te=me?V.substring(0,J):V;return"Applying "+E+" to hot cache haveWeOmittedSomeIds="+ae+"; haveWeShortenedLogString="+me+"; ids: "+te};v.info(572837901,y.CoreDefault,_)}var M=E===Fe.getTypeName();if(M){d=!0;var N=s.generateDeepDeleteOperations(b,I);u.stop(l);for(var R of N)s.triggerNotifications([R],a),f++;u.resume(l);for(var P of N)s.updateModel(P,a,I),c++}else if(E===Ot.getTypeName()){var O=s.handleDeltaUpdate(I,b);O&&(s.updateModel(O,a,I),c++,k.push(O))}else s.updateModel(b,a,I),om.getValue()&&E===Er.getTypeName()&&s.generateSubtreeMoveOperations(b).forEach(function(z){return k.push(z)}),c++,E!==go.getTypeName()&&k.push(b)};for(var T of t)C(T);u.stop(l),k.length>0&&(this.triggerNotifications(k,a),f++),p.stop();var x=function(){return p.resultDescription='{"triggerNotificationsCallCount":'+f+',"updateModelCallCount":'+c+',"hadDeleteOps":'+d+',"numberOfOps":'+h+"}",p};return p.durationMs>rm.getValue()?v.info(572837902,y.CoreDefault,x):v.debug(572837903,y.CoreDefault,x),S}},{key:"getItem",value:function(t){var a=this.model.getItem(t);if(!a)throw new eo("Failed to get item for path "+G(t)+" in hot cache");return a}},{key:"hasItem",value:function(t){return this.model.hasItem(t)}},{key:"getItemChildren",value:function(t,a){var s=this.model.getItemChildren(t,a);if(!Array.isArray(s))throw new eo("Path not found "+G(t));return s}},{key:"getSubtreeItems",value:function(t,a,s){return this.model.getSubtreeItems(t,a,s)}},{key:"getFirstAncestorOfType",value:function(t,a){for(var s=t.slice(0),u=!0;s.length>0;){var l=this.model.getItem(s);if(l){if(m.matchesTypesFor(l.body,a))return Ct(s.slice(0,-1),l)}else if(!u)throw new Error("Failed to get ancestor of type(s) ["+a.join(",")+"] on path "+G(s)+" (bad path)");u=!1,s.pop()}}},{key:"onItemChange",value:function(t,a,s,u){this.itemListeners.onItemChange(t,a,s,u)}},{key:"getCells1D",value:function(t,a,s,u,l){return this.model.getCells1D(t,a,s,u,l)}},{key:"getAnnotation",value:function(t){try{return this.model.getItem(t).body}catch(a){v.error(572837904,y.CoreDefault,"Could not find annotation given path: "+t);return}}},{key:"getStats",value:function(){return this.stats.firstSeenSchemaObjectTypes=this.model.firstSeenSchemaObjectTypes,this.stats.documentUrlAvailable=L("CheckIfDocumentUrlIsAvailable")?this.isDocumentUrlAvailable():!1,this.stats}},{key:"registerItemDeltaHandler",value:function(t,a){this.deltaHandlers.set(t,a)}},{key:"getNextAnnotationId",value:function(){return this.model.getNextAnnotationId()}},{key:"dispose",value:function(){}},{key:"updateAnnotationMetadata",value:function(t,a){var s=[];for(var u of a.items){var l=this.model.getItem(a.parentPath.concat([u.id]));if(!l||!l.body)t(Ee.UpdateOfStubbedItem,u.id);else if(!m.matchesTypesFor(l.body,[gt.getTypeName()]))t(Ee.UpdateMetaDataOfNonAnnotationType,u.id);else{var f=l.body;f.M_=Object.assign(Object.assign({},f.M_),a.M_),s.push(l)}}a.items=s,this.model.updateItems(t,a.parentPath,s)}},{key:"handleDeltaUpdate",value:function(t,a){var s=this.model.getItem(a.parentPath);if(!s){L("deltaConsistencyErrors")&&a.items&&a.items.length>0?t(Ee.DeltaOfNonExistingItem,a.items[0].id):v.error(572837908,y.CoreDefault,"Failed to find parent item for delta op, ID: "+a.parentPath);return}var u=a.parentPath.slice(0,-1),l=a.items&&a.items.length>1?a.items.sort(function(S,C){return[fe.Add,fe.Update,fe.Delete].includes(S.body.deltaType)?-1:1}):a.items,f=[],c=et(),d=c.clientMetadata;for(var h of l)try{var p=this.deltaHandlers.get(m.getTypeNameFor(h.body));if(p){v.info(572837909,y.CoreDefault,"Executing delta handler for item type "+m.getTypeNameFor(s.body)+", and ID: "+s.id);var k=p(h.body,s.body,d==null?void 0:d.flights);f.push(h.body),k?s={id:s.id,revId:h.revId,body:k,parentPath:u,delta:f[0],deltas:f,contextId:h.contextId}:v.info(572837910,y.CoreDefault,"Failed to apply delta of type: "+m.getTypeNameFor(h.body)+" on item "+s.id)}else v.warn(572837911,y.CoreDefault,"Received a delta operation with no registered handler, delta type: "+m.getTypeNameFor(h.body))}catch(S){v.error(572837912,y.CoreDefault,"Failed to apply delta, error: "+S)}if(l.length>0)return new Ne({parentPath:u,items:[s]})}},{key:"updateModel",value:function(t,a,s){this.emit("beforeItemChange",t);var u=m.getTypeNameFor(t);if(v.debug(572837905,y.CoreDefault,function(){var c,d;return"Updating model for "+u+" under parent path ["+t.parentPath+"] ("+((c=t.items)===null||c===void 0?void 0:c.length)+" item(s), first item id: "+(((d=t.items)===null||d===void 0?void 0:d.length)>0?t.items[0].id:"(no items)")+")"}),u===we.getTypeName()){var l=t;this.model.addItems(s,l.parentPath,l.items,l.prevId,l.nextId)}else if(u===Ne.getTypeName())this.model.updateItems(s,t.parentPath,t.items);else if(u===Fe.getTypeName())this.model.deleteItems(s,t.parentPath,t.items);else if(u===ot.getTypeName())this.updateAnnotationMetadata(s,t);else if(!(u===pn.getTypeName()||u===Ze.getTypeName()))if(u===go.getTypeName())t.parentPath&&t.items?this.purgeModel(t.parentPath,t.items):v.error(526403013,y.CoreDefault,"invalid arguments for purge operation");else if(om.getValue()&&u==Er.getTypeName()){var f=t;this.model.moveItems(s,f.prevParentPath,f.parentPath,f.items,f.prevId,f.nextId)}else v.warn(572837914,y.CoreDefault,"Unsupported operation type "+u);this.stats.maxItemCount=this.model.getMaxItemCount()}},{key:"purgeModel",value:function(t,a){var s=this;v.info(526403014,y.CoreDefault,"purging the model"),this.emit("purgeModel",a.map(function(c){return[].concat((0,gn.default)(t),[c.id])}));var u=this.model;this.model=new No;var l=new Set(a.map(function(c){return c.id})),f=function c(d){var h=u.getItemChildren(d),p=new Set(h);if(h&&h.length>0){if(d.length===t.length&&d.every(function(C,T){return t[T]===C}))for(var k=0;k<h.length;k++)l.has(h[k].id)&&(v.info(526403015,y.CoreDefault,"PurgeModel: reached the purgable node. Will not unpurge."),p.delete(h[k]));s.updateModel(new we({parentPath:d,items:(0,gn.default)(p)}),0,function(){});for(var S of p)c([].concat((0,gn.default)(d),[S.id]))}};f([])}},{key:"triggerNotifications",value:function(t,a){var s=this,u,l,f,c,d=new D({operationName:"HotCacheTriggerNotifications",success:!0}).start(),h=et(),p=((l=(u=h.clientMetadata)===null||u===void 0?void 0:u.appName)!==null&&l!==void 0?l:"")+"-"+((c=(f=h.clientMetadata)===null||f===void 0?void 0:f.appPlatform)!==null&&c!==void 0?c:""),k=gI.getValue()[p];k&&k.enabled?this.itemUpdatesAccumulator.accumulate(k,t,a,function(C,T){s.itemListeners.emitEvents(C,T)}):this.itemListeners.emitEvents(t,a),d.stop();var S=function(){return d.resultDescription="maxItemCount= "+s.stats.maxItemCount.toString()+". ops.length="+t.length+".",d};d.durationMs>rm.getValue()?v.info(572837958,y.CoreDefault,S):v.debug(572837959,y.CoreDefault,S)}},{key:"generateDeepDeleteOperations",value:function(t,a){var s=this,u=[],l=function c(d){var h=s.model.getItemChildren(d);h&&h.length>0&&(u.push(new Fe({parentPath:d,items:h})),h.forEach(function(p){c([].concat((0,gn.default)(d),[p.id]))}))},f=function(d){var h=s.model.getItem(d);h?(u.push(new Fe({parentPath:d.slice(0,-1),items:[h]})),l(d)):a(Ee.DeleteOfNonExistingItem,d[d.length-1])};return t.items.forEach(function(c){f([].concat((0,gn.default)(t.parentPath),[c.id]))}),u.reverse(),u}},{key:"isDocumentUrlAvailable",value:function(){var t=this.model.getSubtreeItems([],[Mt.getTypeName()]);if(!t||t.length===0)return!1;var a=t[0].body;return!!a.url}},{key:"generateSubtreeMoveOperations",value:function(t){var a=this,s=[],u=function f(c,d){var h=a.model.getItemChildren(c);if(h!=null&&h.length){s.push(new Er({parentPath:c,prevParentPath:d,items:h}));for(var p of h)f([].concat((0,gn.default)(c),[p.id]),[].concat((0,gn.default)(d),[p.id]))}};for(var l of t.items)u([].concat((0,gn.default)(t.parentPath),[l.id]),[].concat((0,gn.default)(t.prevParentPath),[l.id]));return s}}]),e}(lm.EventEmitter);g();var Am=w(W()),bm=w(B());g();g();var cm=w(W()),dm=w(B()),Gf=function(){function n(o){(0,cm.default)(this,n),this.containedAnalyzers=o}return(0,dm.default)(n,[{key:"appliedOperationNotification",value:function(){for(var e of this.containedAnalyzers)e.appliedOperationNotification()}},{key:"scheduleAnalysis",value:function(){for(var e of this.containedAnalyzers)e.scheduleAnalysis()}},{key:"stop",value:function(){for(var e of this.containedAnalyzers)e.stop()}}]),n}();g();var Sm=w(W()),Cm=w(B()),xm=w(qe()),Tm=w(Ge()),Vf=w(De());g();var vm=w(W()),ym=w(B()),zf=w(mm()),Jt;(function(n){n[n.Idle=0]="Idle",n[n.Pending=1]="Pending",n[n.Running=2]="Running",n[n.Stopped=3]="Stopped"})(Jt||(Jt={}));var km=function(){function n(o){(0,vm.default)(this,n),this.state=Jt.Idle,this.hadNewAppliedOperations=!1,this.analysisTimeoutRelaxed=!1,this.args=o,this.debouncedAnalysis=(0,zf.default)(this.analysisToDebounce.bind(this),this.args.normalSessionsDebounceTimeInMs)}return(0,ym.default)(n,[{key:"finishedAnalysisAndInQuietState",get:function(){return this.state===Jt.Idle}},{key:"appliedOperationNotification",value:function(){this.hadNewAppliedOperations=!0}},{key:"stop",value:function(){this.state=Jt.Stopped,this.debouncedAnalysis.cancel();var e=function(){};e.cancel=function(){},this.debouncedAnalysis=e}},{key:"scheduleAnalysis",value:function(){this.state===Jt.Idle&&(this.state=Jt.Pending),this.debouncedAnalysis()}},{key:"analysisToDebounce",value:function(){var e=this;if(!(this.state!==Jt.Pending||!this.canPerformAnalysis())){if(!this.hadNewAppliedOperations){this.state=Jt.Idle;return}this.state=Jt.Running,this.hadNewAppliedOperations=!1,this.performAnalysis(function(){return e.hadNewAppliedOperations},function(r){e.hadNewAppliedOperations&&setTimeout(function(){return e.scheduleAnalysis()},0),r&&(e.args.allowAnalysisOfLargeSessions()?e.analysisTimeoutRelaxed||(e.analysisTimeoutRelaxed=!0,e.debouncedAnalysis.cancel(),e.debouncedAnalysis=(0,zf.default)(e.analysisToDebounce.bind(e),e.args.tooLargeSessionsDebounceTimeInMs),setTimeout(function(){return e.scheduleAnalysis()},0)):e.state=Jt.Stopped),e.state===Jt.Running&&(e.state=Jt.Idle)})}}}]),n}();function DI(n){var o=WI();return function(){var r=(0,Vf.default)(n),t;if(o){var a=(0,Vf.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,Tm.default)(this,t)}}function WI(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var BI=5e4,PI=3e5,OI=new F("treeLevelsByItemTypeCacheAnalysisEnabled",!1),wm=new F("treeLevelsByItemTypeCacheAnalysisOfLargeSessions",!1),LI=new F("treeLevelsByItemTypeCacheLargeSessionThreshold",1e3),Im=function(n){(0,xm.default)(e,n);var o=DI(e);function e(r){var t;return(0,Sm.default)(this,e),t=o.call(this,{allowAnalysisOfLargeSessions:function(){return wm.getValue()},normalSessionsDebounceTimeInMs:BI,tooLargeSessionsDebounceTimeInMs:PI}),t.stopAnlysis=!1,t.fetchInMemoryModel=r,t}return(0,Cm.default)(e,[{key:"canPerformAnalysis",value:function(){return OI.getValue()&&!this.stopAnlysis}},{key:"performAnalysis",value:function(t,a){var s=this.fetchInMemoryModel();if(s){if(s.getMaxItemCount()>LI.getValue()&&!wm.getValue()){this.stopAnlysis=!0,a(!0);return}var u=s.analyzeTreeLevelsByItemTypeCacheErrors();this.stopAnlysis=!u,a(!1)}}}]),e}(km);var FI=new F("percentageOfSessionsForTreeLevelsCacheAnalysis",10),qI=new F("enableTreeLevelsByItemTypeCaching",!0),GI=new F("treeLevelsByItemTypeCacheAnalysisEnabled",!1),_m=function(o){if(GI.getValue()&&qI.getValue()&&100*Math.random()<=FI.getValue()){var e=new Im(o);return new Gf([e])}return new Gf([])};var Mm=function(){function n(o){var e=this;(0,Am.default)(this,n),this.isShuttingDown=!1,this.quietStateAnalyzer=_m(function(){return e.hotCache.model}),this.hotCache=o()}return(0,bm.default)(n,[{key:"on",value:function(e,r){this.hotCache.on(e,r)}},{key:"applyOperations",value:function(e,r){if(this.isShuttingDown)throw new Error("Shutdown is in process, no further messages will be applied.");this.quietStateAnalyzer.appliedOperationNotification();var t=this.hotCache.applyOperations(e,r);return this.quietStateAnalyzer.scheduleAnalysis(),t}},{key:"getItem",value:function(e){return this.hotCache.getItem(e)}},{key:"hasItem",value:function(e){return this.hotCache.hasItem(e)}},{key:"getItemChildren",value:function(e,r){return this.hotCache.getItemChildren(e,r)}},{key:"onItemChange",value:function(e,r,t,a){this.hotCache.onItemChange(e,r,t,a)}},{key:"getSubtreeItems",value:function(e,r,t){return this.hotCache.getSubtreeItems(e,r,t)}},{key:"getFirstAncestorOfType",value:function(e,r){return this.hotCache.getFirstAncestorOfType(e,r)}},{key:"getAnnotation",value:function(e){return this.hotCache.getAnnotation(e)}},{key:"getCells1D",value:function(e,r,t,a,s){return this.hotCache.getCells1D(e,r,t,a,s)}},{key:"getStats",value:function(){return this.hotCache.getStats()}},{key:"getSerializedCache",value:function(){return this.hotCache.getSerializedCache()}},{key:"getNextAnnotationId",value:function(){return this.hotCache.getNextAnnotationId()}},{key:"registerItemDeltaHandler",value:function(e,r){this.hotCache.registerItemDeltaHandler(e,r)}},{key:"dispose",value:function(){this.hotCache.dispose(),this.isShuttingDown=!0,this.quietStateAnalyzer.stop()}}]),n}();g();var Em=w(Ie()),Rm=w(W()),Nm=w(B());var Qf=function(){function n(){(0,Rm.default)(this,n),this.stats={warnings:0,errors:0,quietStateAnalysisDataCorrect:!1,lastRunWarnings:void 0,lastRunErrors:void 0}}return(0,Nm.default)(n,[{key:"getStats",value:function(){return this.stats}},{key:"setClientMetadata",value:function(e){this.clientMetadata=e}},{key:"logModelOperationError",value:function(e,r,t,a){var s=n.shouldLogConsistencyErrorAsInfoTemporarily(t),u;s?(this.stats.warnings++,u="SyncOperationWarning"):(this.stats.errors++,u="SyncOperationError"),v.info(508650700,y.CoreDefault,new _e({sessionHealthEventName:u,source:pe.Core,reason:Y.Client,impact:he.MissingInput,success:!1,message:e+" for item "+G([].concat((0,Em.default)(r.parentPath),[a]))+" has operation error "+Ee[t],subReason:Ee[t]},this.clientMetadata))}}],[{key:"shouldLogConsistencyErrorAsInfoTemporarily",value:function(e){return e===Ee.UpdateOfNonExistentItem||e===Ee.DeleteOfNonExistingItem}}]),n}();g();var Hv=w(Ie()),zv=w(W()),Vv=w(B());g();var Dm=w(W()),Wm=w(B()),Bm=function(){function n(){(0,Dm.default)(this,n),this.prevSequence=-1}return(0,Wm.default)(n,[{key:"generate",value:function(e){if(e)for(var r of e){var t=++this.prevSequence;r.metadata?r.metadata.seq=t:r.metadata={seq:t}}}}]),n}();g();var Pm=w(W()),Om=w(B()),Ya=function(){function n(o){(0,Pm.default)(this,n),this.elements=o}return(0,Om.default)(n,[{key:"getAll",value:function(e){return Promise.resolve(this.elements)}},{key:"map",value:function(e){throw new Error("Not Yet Implemented")}},{key:"filter",value:function(e){throw new Error("Not Yet Implemented")}},{key:"forEach",value:function(e){throw new Error("Not Yet Implemented")}},{key:"reduce",value:function(e,r){throw new Error("Not Yet Implemented")}}]),n}();g();var Za=w(W()),es=w(B());var ji=function(){function n(o){(0,Za.default)(this,n),m.assign(n,this,o)}return(0,es.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Runtime_Workflow_Shared_AsyncAnnotationResult"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();ji.H_={T_:ji.getTypeName(),B_:ji.getBaseTypes()};var jf=function(){function n(o){(0,Za.default)(this,n),m.assign(n,this,o)}return(0,es.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Runtime_Workflow_Shared_ChatStoreSetMessages"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();jf.H_={T_:jf.getTypeName(),B_:jf.getBaseTypes()};var Jf=function(){function n(o){(0,Za.default)(this,n),m.assign(n,this,o)}return(0,es.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Runtime_Workflow_Shared_ChatStoreGetMessages"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Jf.H_={T_:Jf.getTypeName(),B_:Jf.getBaseTypes()};g();var K;(function(n){n[n.WorkflowExecutionFailed=0]="WorkflowExecutionFailed",n[n.WorkflowDisabled=1]="WorkflowDisabled",n[n.WorkflowWrongAnnotationType=2]="WorkflowWrongAnnotationType",n[n.FailedAnnotationApply=3]="FailedAnnotationApply",n[n.ApplyAnnotationsException=4]="ApplyAnnotationsException",n[n.AnnotationsNotArray=5]="AnnotationsNotArray",n[n.UnexpectedOutput=6]="UnexpectedOutput",n[n.OutputIsNotAnnotation=7]="OutputIsNotAnnotation",n[n.MixedOutput=8]="MixedOutput",n[n.UnknownAnnotationParent=9]="UnknownAnnotationParent",n[n.SnapshotStorageNotInitialized=10]="SnapshotStorageNotInitialized",n[n.FailedToRetrieveDataFromSnapshot=11]="FailedToRetrieveDataFromSnapshot",n[n.TooManyItemsToExecuteReduceWorkflow=12]="TooManyItemsToExecuteReduceWorkflow",n[n.NoAcceptableTransportAvailable=13]="NoAcceptableTransportAvailable",n[n.FailedToZipInput=14]="FailedToZipInput",n[n.RequiredTokenNotAvailable=15]="RequiredTokenNotAvailable",n[n.TimedOutSendingRequestToWorkflowProcess=16]="TimedOutSendingRequestToWorkflowProcess",n[n.PubSubProduceError=17]="PubSubProduceError",n[n.WorkflowExecutionCancelled=18]="WorkflowExecutionCancelled",n[n.WorkflowTimeout=19]="WorkflowTimeout",n[n.SequenceOutOfOrder=20]="SequenceOutOfOrder",n[n.WorkflowResultsCancelled=21]="WorkflowResultsCancelled",n[n.WorkflowExecutionThrottled=22]="WorkflowExecutionThrottled",n[n.InvalidInputQuantityForSingleItemWorkflow=23]="InvalidInputQuantityForSingleItemWorkflow"})(K||(K={}));var ts=new Set(Object.keys(K).filter(function(n){return typeof K[n]=="number"})),Kf=function(o){return ts.has(o)?K[o]:o.indexOf("Timeout sending request")!==-1?K.TimedOutSendingRequestToWorkflowProcess:o.indexOf("PubSub.produce Error")!==-1?K.PubSubProduceError:K.WorkflowExecutionFailed},Lm=function(o){switch(o){case K.SnapshotStorageNotInitialized:case K.FailedToRetrieveDataFromSnapshot:case K.TooManyItemsToExecuteReduceWorkflow:case K.NoAcceptableTransportAvailable:case K.FailedToZipInput:case K.TimedOutSendingRequestToWorkflowProcess:case K.PubSubProduceError:case K.WorkflowExecutionCancelled:return!0;case K.WorkflowExecutionFailed:case K.WorkflowDisabled:case K.WorkflowWrongAnnotationType:case K.FailedAnnotationApply:case K.ApplyAnnotationsException:case K.AnnotationsNotArray:case K.UnexpectedOutput:case K.OutputIsNotAnnotation:case K.MixedOutput:case K.UnknownAnnotationParent:case K.WorkflowTimeout:case K.SequenceOutOfOrder:default:return!1}};g();var Do;(function(n){n.JsClient="C",n.Server="S"})(Do||(Do={}));g();var Um=w(Ye()),oo=w(Ie()),Zf=w(W()),ec=w(B());g();var $f=w(mn()),Xf=w(W()),Yf=w(B());var HI=function(){function n(o,e,r,t){(0,Xf.default)(this,n),this.item=o,this.subtreeRootItem=r,this.subtreeRootModelIteratorItem=t,this.createIteratorCallback=e}return(0,Yf.default)(n,[{key:"schema",get:function(){return this.item.schema}},{key:"id",get:function(){return this.item.id}},{key:"operation",get:function(){return this.item.operation}},{key:"delta",get:function(){return this.item.delta}},{key:"deltas",get:function(){return this.item.deltas}},{key:"isContext",get:function(){return this.item.isContext}},{key:"asyncBoundary",get:function(){return this.item.asyncBoundary}},{key:"revId",get:function(){return this.item.revId}},{key:"getModelIterator",value:function(){if(this.asyncBoundary)return this.createIteratorCallback(this);throw new Error("An iterator can be created only for async boundary items")}},{key:"getSourceTimestamp",value:function(){return this.item.getSourceTimestamp()}},{key:"getContextId",value:function(){return this.item.getContextId()}},{key:"getBody",value:function(){return this.item.getBody()}},{key:"getItemReference",value:function(){return this.item.getItemReference()}},{key:"getParentItem",value:function(e){var r=this.item.getParentItem(e);if(r===void 0){if(this.subtreeRootModelIteratorItem!==void 0)return this.subtreeRootModelIteratorItem.getParentItem(e);r=this.subtreeRootItem.getParentItem(e)}return this.createIteratorItem(r)}},{key:"getParentItemBody",value:function(e){var r;return(r=this.getParentItem(e))===null||r===void 0?void 0:r.getBody()}},{key:"getChildItem",value:function(e){var r=this.item.getChildItem(e);return this.createIteratorItem(r)}},{key:"getChildItemBody",value:function(e){return this.item.getChildItemBody(e)}},{key:"getChildItems",value:function(e){var r=this;return this.item.getChildItems(e).map(function(t){return r.createIteratorItem(t)})}},{key:"getChildItemBodies",value:function(e){return this.item.getChildItemBodies(e)}},{key:"getSubtreeItem",value:function(e){var r=this.item.getSubtreeItem(e);return this.createIteratorItem(r)}},{key:"getSubtreeItemBody",value:function(e){return this.item.getSubtreeItemBody(e)}},{key:"getSubtreeItems",value:function(e){var r=this;return this.item.getSubtreeItems(e).map(function(t){return r.createIteratorItem(t)})}},{key:"getSubtreeItemBodies",value:function(e){return this.item.getSubtreeItemBodies(e)}},{key:"getContextItem",value:function(e){var r=this.item.getContextItem(e);return this.createIteratorItem(r)}},{key:"getContextItemBody",value:function(e){return this.item.getContextItemBody(e)}},{key:"getContextItems",value:function(e){var r=this;return this.item.getContextItems(e).map(function(t){return r.createIteratorItem(t)})}},{key:"getContextItemBodies",value:function(e){return this.item.getContextItemBodies(e)}},{key:"addAnnotation",value:function(e,r){var t=this.item.addAnnotation(e,r);return this.createIteratorItem(t)}},{key:"updateAnnotation",value:function(e,r){this.item.updateAnnotation(e,r)}},{key:"deleteAnnotation",value:function(e){return this.item.deleteAnnotation(e)}},{key:"createIteratorItem",value:function(e){return e===void 0?void 0:new n(e,this.createIteratorCallback,this.subtreeRootItem,this.subtreeRootModelIteratorItem)}}]),n}(),qm=function(){function n(o,e,r,t,a,s,u){(0,Xf.default)(this,n);var l;this.subtreeRootItem=o,this.parentModel=e,this.asyncBoundaryLoader=r,this.hasUnreadItems=this.subtreeRootItem.getChildItem()!==void 0,this.subtreeRootModelIteratorItem=s,this.endReached=!1,this.truncationContext=t,this.truncated=((l=t==null?void 0:t.truncatedItemPathKeys)===null||l===void 0?void 0:l.indexOf(this.subtreeRootItem.id))>=0,this.pageSize=a,this.modelUnloadedCallback=u}return(0,Yf.default)(n,[{key:"getNextPage",value:function(){var o=(0,$f.default)(function*(){if(this.endReached)return Promise.resolve([]);if(!this.hasUnreadItems&&this.truncated){var r=yield this.asyncBoundaryLoader.loadSubtree(new gi({pageSize:this.pageSize,rootItemPath:this.subtreeRootItem.getItemReference().referencedPath,lastItemPathKey:this.lastItemPathKey})),t=this.parentModel.createSubModel(this.subtreeRootItem);t.addItems(r.items);for(var a of r.existingAnnotations)t.getItemByReference({referencedPath:a.parentPath}).addAnnotation(a.body);this.lastItemPathKey=r.lastItemPathKey,this.subtreeRootItem=t.scopeItem,this.currentSubModel&&(this.currentSubModel.commitPendingAnnotations(),this.modelUnloadedCallback(this.currentSubModel)),this.currentSubModel=t,this.endReached=r.endReached}for(var s=this.subtreeRootItem.getChildItems(),u=new Array(s.length),l=this.createIterator.bind(this),f=0;f<u.length;f++)u[f]=new HI(s[f],l,this.subtreeRootItem,this.subtreeRootModelIteratorItem);return this.hasUnreadItems=!1,this.truncated||(this.endReached=!0),Promise.resolve(u)});function e(){return o.apply(this,arguments)}return e}()},{key:"forEach",value:function(){var o=(0,$f.default)(function*(r){for(var t=yield this.getNextPage(),a=!1,s=function(){a=!0};t.length>0;){for(var u=0;!a&&u<t.length;u++){var l=r(t[u],s);l instanceof Promise&&(yield l)}if(a)break;t=yield this.getNextPage()}});function e(r){return o.apply(this,arguments)}return e}()},{key:"createIterator",value:function(e){var r;return new n(e.item,(r=this.currentSubModel)!==null&&r!==void 0?r:this.parentModel,this.asyncBoundaryLoader,this.truncationContext,this.pageSize,e,this.modelUnloadedCallback)}}]),n}();var Gm=new F("pullWorkflowModelPageSize",11e3),Hm=Symbol("workflowModel"),Ke=Symbol("workflowModelItem"),mr=function(o){if(!o)return function(e){return e[Ke]!==void 0};if(typeof o=="function")return function(e){return e[Ke]&&o(e[Ke])};if((o.id?1:0)+(o.ids?1:0)+(o.itemType?1:0)+(o.itemTypes?1:0)!=1)throw new Error("Exactly one condition expected on IItemFilter");return o.id?function(e){return e[Ke]&&o.id===e[Ke].internalId}:o.ids?function(e){return e[Ke]&&o.ids.indexOf(e[Ke].internalId)>=0}:o.itemType?function(e){return e[Ke]&&m.matchesTypesFor(e.body,[o.itemType])}:function(e){return e[Ke]&&m.matchesTypesFor(e.body,o.itemTypes)}},zI=function(){function n(o,e,r,t,a,s,u,l){(0,Zf.default)(this,n),this.model=o,this.item=e,this.isNew=a,this.isContext=s,this.operation=e.op,this.delta=e.delta,this.deltas=e.deltas,this.loadSubtreeCallback=r,this.createIteratorCallback=t,this.resolveSchemaItemCallback=u,this.getNextAnnotationId=l}return(0,ec.default)(n,[{key:"id",get:function(){if(this.isNew)throw new Error("Cannot provide id for newly added annotation");return this.internalId}},{key:"internalId",get:function(){return this._id||(this._id=G(this.itemPath)),this._id}},{key:"revId",get:function(){return this.item.revId}},{key:"asyncBoundary",get:function(){var e;return(e=this.schema)===null||e===void 0?void 0:e.asyncBoundary}},{key:"schema",get:function(){var e;return(e=this._schema)!==null&&e!==void 0?e:this._schema=this.resolveSchemaItemCallback?this.resolveSchemaItemCallback(this):void 0}},{key:"workflowModel",get:function(){return this.model[Hm]}},{key:"itemPath",get:function(){return this._itemPath||(this._itemPath=[].concat((0,oo.default)(this.item.parentPath),[this.item.id])),this._itemPath}},{key:"getModelIterator",value:function(){if(this.asyncBoundary)return this.createIteratorCallback(this);throw new Error("An iterator can be created only for async boundary items")}},{key:"getBody",value:function(){return this.item.body}},{key:"getItemReference",value:function(){if(this.isNew)throw new Error("Cannot provide IItemReference for newly added annotation");return{referencedPath:(0,oo.default)(this.itemPath)}}},{key:"getParentItem",value:function(e){var r=mr(e),t=void 0;return this.model.visitItemPathSync(this.item.parentPath,function(a){r(a)&&(t=a[Ke])}),t}},{key:"getParentItemBody",value:function(e){var r;return(r=this.getParentItem(e))===null||r===void 0?void 0:r.getBody()}},{key:"getPrevItem",value:function(e,r){var t=this.getSubtreeItemsForSiblingIteration(e,r),a=t.indexOf(this.item)-1;if(a>=0)return t[a][Ke]}},{key:"getPrevItemBody",value:function(e,r){var t;return(t=this.getPrevItem(e,r))===null||t===void 0?void 0:t.getBody()}},{key:"getNextItem",value:function(e,r){var t=this.getSubtreeItemsForSiblingIteration(e,r),a=t.indexOf(this.item)+1;if(a>0&&a<t.length)return t[a][Ke]}},{key:"getNextItemBody",value:function(e,r){var t;return(t=this.getNextItem(e,r))===null||t===void 0?void 0:t.getBody()}},{key:"getChildItem",value:function(e){var r=mr(e),t=[];return this.accumulateChildWorkflowModelItems(r,this.itemPath,t,!0),t[0]}},{key:"getChildItemBody",value:function(e){var r;return(r=this.getChildItem(e))===null||r===void 0?void 0:r.getBody()}},{key:"getChildItems",value:function(e){var r=mr(e),t=[];return this.accumulateChildWorkflowModelItems(r,this.itemPath,t),t}},{key:"getChildItemBodies",value:function(e){return this.getChildItems(e).map(function(r){return r.getBody()})}},{key:"getSubtreeItem",value:function(e){return this.getSubtreeWorkflowModelItems(mr(e),this.itemPath,!0)[0]}},{key:"getSubtreeItemBody",value:function(e){var r;return(r=this.getSubtreeItem(e))===null||r===void 0?void 0:r.getBody()}},{key:"getSubtreeItems",value:function(e){return this.getSubtreeWorkflowModelItems(mr(e),this.itemPath)}},{key:"getSubtreeItemBodies",value:function(e){return this.getSubtreeItems(e).map(function(r){return r.getBody()})}},{key:"getContextItem",value:function(e){var r;return(r=this.getContextItems(e))===null||r===void 0?void 0:r[0]}},{key:"getContextItemBody",value:function(e){var r;return(r=this.getContextItem(e))===null||r===void 0?void 0:r.getBody()}},{key:"getContextItems",value:function(e){var r=this,t=mr(e),a=function(l){var f=(0,oo.default)(l.getItemReference().referencedPath);return f.splice(-1),to(f,r.itemPath)},s=function(l){return t(l.item)&&a(l)};return this.workflowModel.getItems(s)}},{key:"getContextItemBodies",value:function(e){return this.getContextItems(e).map(function(r){return r.getBody()})}},{key:"addAnnotation",value:function(e,r){if(r!=null&&r.immediate){this.workflowModel.commitImmediateAnnotation(this.item,e);return}var t={id:this.getNextAnnotationId(),body:e,parentPath:this.itemPath};return this.model.addItems(function(){},this.itemPath,[t]),t[Ke]=new n(this.model,t,this.loadSubtreeCallback,void 0,!0,void 0,this.resolveSchemaItemCallback,this.getNextAnnotationId),this.workflowModel.setPendingAnnotationType(this.item,m.getTypeNameFor(e)),t[Ke]}},{key:"updateAnnotation",value:function(e,r){if(m.getTypeNameFor(e)!==m.getTypeNameFor(this.item.body))throw new Error("WorkflowModelItem.update: Must update annotation with another body of the same type");var t=this.getParentItemForAnnotationOperations("update",r);this.item.body=e,this.model.updateItems(function(){},this.item.parentPath,[this.item]),this.workflowModel.setPendingAnnotationType(t,m.getTypeNameFor(this.item.body))}},{key:"deleteAnnotation",value:function(e){var r=this.getParentItemForAnnotationOperations("delete",e);this.model.deleteItems(function(){},this.item.parentPath,[this.item]),this.workflowModel.setPendingAnnotationType(r,m.getTypeNameFor(this.item.body)),this.item.body=void 0}},{key:"loadSubtree",value:function(e){return this.loadSubtreeCallback(this.itemPath,e)}},{key:"getSourceTimestamp",value:function(){return this.item.sourceTimestamp}},{key:"getContextId",value:function(){return this.item.contextId}},{key:"accumulateChildWorkflowModelItems",value:function(e,r,t,a){var s=this.model.getItemChildren(r);for(var u of s)if(u[Ke]){if(e(u)&&(t.push(u[Ke]),a))return!1}else if(L("FixStubsFromStoppingIteratingTheChildren")){if(!this.accumulateChildWorkflowModelItems(e,[].concat((0,oo.default)(u.parentPath),[u.id]),t,a))return!1}else if(this.accumulateChildWorkflowModelItems(e,[].concat((0,oo.default)(u.parentPath),[u.id]),t,a))return!1;return!0}},{key:"getParentItemForAnnotationOperations",value:function(e,r){if(r!=null&&r.immediate)throw new Error("WorkflowModelItem."+e+"Annotation: Unsupported option");var t=this.item.parentPath.length>0?this.model.getItem(this.item.parentPath):void 0;if(!t||t[Ke]===void 0)throw new Error("WorkflowModelItem."+e+"Annotation: Parent must exist in workflow model");return t}},{key:"getSubtreeItemsForSiblingIteration",value:function(e,r){var t=mr(e);if(!t(this.item))throw new Error("Sibling filter must match current item");var a=this.getParentItem(r).itemPath;return this.model.getSubtreeItems(a,t).slice(1)}},{key:"getSubtreeWorkflowModelItems",value:function(e,r,t){var a=this.model.getSubtreeItems(r,e);if(a.length>0&&a[0]===this.item&&(a=a.slice(1)),a.length===0)return[];for(var s=new Array(t?1:a.length),u=0;u<s.length;u++)s[u]=a[u][Ke];return s}}]),n}(),zm=function(){function n(o,e,r,t,a,s,u,l,f){(0,Zf.default)(this,n),this.pendingAnnotationTypesByParentItem=new Map,this.childModels=new Set,this.asyncBoundaryLoader=t,a&&(this.workflowModelItemSchemaResolver=s==null?void 0:s.create(a)),this.workflowModelItemSchemaResolverFactory=s,this.truncationContext=u,this.model=new No,this.model[Hm]=this,this._scopeItem=o,this.modelOptions=f,this.addItemCallback=r,this.getNextAnnotationId=l!=null?l:this.model.getNextAnnotationId.bind(this.model),this.addItems([o]),this.setAnnotations=e}return(0,ec.default)(n,[{key:"scopeItem",get:function(){return this._scopeItem[Ke]}},{key:"rootItem",get:function(){return this.scopeItem}},{key:"addItems",value:function(e,r){var t,a;if((e==null?void 0:e.length)>0){var s=this.loadSubtree.bind(this),u=this.createWorkflowModelIterator.bind(this),l=(a=(t=this.workflowModelItemSchemaResolver)===null||t===void 0?void 0:t.resolve)===null||a===void 0?void 0:a.bind(this.workflowModelItemSchemaResolver);for(var f of e)this.addItemCallback&&this.addItemCallback(f),this.model.addItems(function(){},f.parentPath,[f]),f[Ke]=new zI(this.model,f,s,u,void 0,r,l,this.getNextAnnotationId)}}},{key:"setPendingAnnotationType",value:function(e,r){if(this.immediateAnnotationParentItem)throw new Error("Mixing immediate and non-immediate annotations is not supported");var t=this.pendingAnnotationTypesByParentItem.get(e)||[];t.indexOf(r)<0&&t.push(r),this.pendingAnnotationTypesByParentItem.set(e,t)}},{key:"commitImmediateAnnotation",value:function(e,r){if(this.pendingAnnotationTypesByParentItem.size>0)throw new Error("Mixing immediate and non-immediate annotations is not supported");if(this.immediateAnnotationParentItem&&this.immediateAnnotationParentItem!==e)throw new Error("Adding immediate annotations under different parents is not supported");this.setAnnotations(e,m.getTypeNameFor(r),[r],{immediate:!0}),this.immediateAnnotationParentItem=e}},{key:"commitPendingAnnotations",value:function(){for(var e of this.pendingAnnotationTypesByParentItem){var r=(0,Um.default)(e,2),t=r[0],a=r[1];for(var s of a){var u=this.model.getItemChildren([].concat((0,oo.default)(t.parentPath),[t.id]),[s]);u&&u.length>0&&this.setAnnotations(t,s,u.map(function(f){return f.body}))}}for(var l of this.childModels)l.commitPendingAnnotations()}},{key:"getItem",value:function(e){return this.getItems(e)[0]}},{key:"getItems",value:function(e){return this.model.getSubtreeItems([],mr(e)).map(function(r){return r[Ke]})}},{key:"getItemBody",value:function(e){var r;return(r=this.getItem(e))===null||r===void 0?void 0:r.getBody()}},{key:"getItemBodies",value:function(e){return this.getItems(e).map(function(r){return r.getBody()})}},{key:"getItemByReference",value:function(e){var r;if(((r=e==null?void 0:e.referencedPath)===null||r===void 0?void 0:r.length)>0){var t=this.model.getItem(e.referencedPath);if(t)return t[Ke]}}},{key:"getItemBodyByReference",value:function(e){var r;return(r=this.getItemByReference(e))===null||r===void 0?void 0:r.getBody()}},{key:"createWorkflowModelIterator",value:function(e){var r,t=void 0;if(this.asyncBoundaryLoader?this.asyncBoundaryLoader.kind!==Nr.ModelIterating?t="loadSubtree must be called for the asyncBoundaryLoader of kind 'ModelIterating'. Actual kind is "+this.asyncBoundaryLoader.kind:e.asyncBoundary||(t="An iterator can be created only for the items with asyncBoundary === true"):t="asyncBoundaryLoader is not defined",t)throw v.error(509092948,y.CoreDefault,t),new Error(t);var a;return!((r=this.modelOptions)===null||r===void 0)&&r.maxModelItems?a=Math.min(this.modelOptions.maxModelItems,Gm.getValue()):a=Gm.getValue(),new qm(e,this,this.asyncBoundaryLoader,this.truncationContext,a,void 0,this.onChildModelUnloaded.bind(this))}},{key:"createSubModel",value:function(e){var r=this.model.getItem(Yn(e.id)),t=new n(r,this.setAnnotations,this.addItemCallback,this.asyncBoundaryLoader,[e.schema],this.workflowModelItemSchemaResolverFactory,this.truncationContext,this.getNextAnnotationId,this.modelOptions);return this.childModels.add(t),t}},{key:"onChildModelUnloaded",value:function(e){this.childModels.delete(e)}},{key:"loadSubtree",value:function(e,r){var t=this,a=new D({operationName:"WorkflowModelLoadSubtree",success:!0,resultDescription:e.join("/")},{metricDuration:!0,metricCount:!0}).start(),s=void 0;if(this.asyncBoundaryLoader?this.asyncBoundaryLoader.kind!==Nr.Filtering&&(s="loadSubtree must be called for the asyncBoundaryLoader of kind 'Filtering'. Actual kind is "+this.asyncBoundaryLoader.kind):s="asyncBoundaryLoader is not defined",s)throw a.success=!1,a.resultSignature=""+s,v.error(526952588,y.CoreDefault,a.stop()),new Error(s);var u=this.asyncBoundaryLoader;return u.loadSubtree(new hi({rootItemPath:e,filter:r})).then(function(l){l.forEach(function(f){f.parentPath=e}),t.addItems(l),a.success=!0,a.count=l.length,a.resultSignature="items loaded successfully",v.metric(526952589,y.CoreDefault,a.stop())}).catch(function(l){return a.success=!1,a.resultSignature="items loaded failed",a.resultDescription+=`
`+l,v.error(526952590,y.CoreDefault,a.stop()),Promise.reject(l)})}}]),n}();g();var cc=w(mn()),Fv=w(W()),qv=w(B());g();g();var iv=w(W()),av=w(B()),tc=w(Ie()),nc=w(mn());g();g();var Vm=w(W()),Qm=w(B()),jm=w(Ye()),VI=";",QI=":";function io(n){if(!n)return new ns([],new Set,new Map);var o=n.split(VI),e=new Set,r=new Map;for(var t of o){var a=t.trim();if(a!==""){e.add(ns.normalizeName(a));var s=a.split(QI),u=(0,jm.default)(s,2),l=u[0],f=u[1],c=ns.normalizeName(l);c&&r.set(c,f)}}return new ns(o,e,r)}var ns=function(){function n(o,e,r){(0,Vm.default)(this,n),this.originalFlights=o,this.normalizedFlights=e,this.keyValueFlightsMap=r}return(0,Qm.default)(n,[{key:"hasFlight",value:function(e){var r=n.normalizeName(e),t=this.normalizedFlights.has(r),a=this.keyValueFlightsMap.has(r);return t||a}},{key:"getBooleanValue",value:function(e,r){var t,a=(t=this.getStringValue(e))===null||t===void 0?void 0:t.toLowerCase();switch(a){case"true":return!0;case"false":return!1;default:return r}}},{key:"getIntValue",value:function(e,r){var t=this.getStringValue(e),a=Number.parseInt(t,10);return Number.isNaN(a)?r:a}},{key:"getStringValue",value:function(e,r){var t;return(t=this.keyValueFlightsMap.get(n.normalizeName(e)))!==null&&t!==void 0?t:r}},{key:"getAll",value:function(){return this.originalFlights}},{key:"getAllParsed",value:function(){var e=[];return this.keyValueFlightsMap.forEach(function(r,t){var a=r==null?void 0:r.toLowerCase();switch(a){case"true":e.push({name:t,value:!0});break;case"false":e.push({name:t,value:!1});break;default:{var s=Number.parseInt(a,10);Number.isNaN(s)?e.push({name:t,value:r}):e.push({name:t,value:s})}break}}),e}}],[{key:"normalizeName",value:function(e){return e==null?void 0:e.toLowerCase()}}]),n}();g();var Xm=w(W()),Ym=w(B());g();var Jm=w(W()),Km=w(B());var $m=function(){function n(o,e){(0,Jm.default)(this,n),this.schema=o,this.typeToSchemaItemsMap=e}return(0,Km.default)(n,[{key:"resolve",value:function(e){var r=this,t=m.getAllTypesFor(e.getBody()),a=t.map(function(c){return r.typeToSchemaItemsMap.get(c)}).filter(function(c){return c!==void 0});if(!a)throw v.error(509092953,y.CoreDefault,"Couldn't find a matching schema item. Item types: "+JSON.stringify(t)+", schema: "+JSON.stringify(this.schema)),new Error("Cannot find matching schema item");if(a.length===1&&a[0].length===1)return a[0][0];for(var s={child:void 0,schemaItem:void 0,itemTypes:t},u=void 0,l=e.getParentItem();l;){u=l;var f=s;s={child:f,schemaItem:void 0,itemTypes:m.getAllTypesFor(u.getBody())},l=u.getParentItem()}return this.resolveSchemaItem(s,this.schema)}},{key:"resolveSchemaItem",value:function(e,r){var t=r.find(function(a){return e.itemTypes.indexOf(a.type)!==-1});if(!e.child&&t)return t;if(!t||!t.children)throw v.error(509092952,y.CoreDefault,"Couldn't find a matching schema item. Item types: "+JSON.stringify(e.itemTypes)+", schema: "+JSON.stringify(this.schema)),new Error("Cannot find matching schema item");return this.resolveSchemaItem(e.child,t.children)}}]),n}();var Zm=function(){function n(){(0,Xm.default)(this,n)}return(0,Ym.default)(n,[{key:"create",value:function(e){var r=new Map;return this.buildTypeToSchemaItemsMap(e,r),new $m(e,r)}},{key:"buildTypeToSchemaItemsMap",value:function(e,r){for(var t of e.filter(function(s){return s.role===Ta.Input})){var a=r.get(t.type);a||(a=[],r.set(t.type,a)),a.push(t),t.children&&this.buildTypeToSchemaItemsMap(t.children,r)}}}]),n}();g();var Ki=w(mn()),ev=w(W()),tv=w(B());var nv=function(){function n(o,e){if((0,ev.default)(this,n),!o)throw new Error("workflowMessageHandler is required");if(this.workflowMessageHandler=o,!e)throw new Error("executionContext is required");this.executionContext=e}return(0,tv.default)(n,[{key:"addMessages",value:function(){var o=(0,Ki.default)(function*(r){return this.workflowMessageHandler.onChatStoreMessagesSet({messages:r,options:{operationType:ho.Add}},this.executionContext)});function e(r){return o.apply(this,arguments)}return e}()},{key:"updateMessages",value:function(){var o=(0,Ki.default)(function*(r){return this.workflowMessageHandler.onChatStoreMessagesSet({messages:r,options:{operationType:ho.Update}},this.executionContext)});function e(r){return o.apply(this,arguments)}return e}()},{key:"deleteMessages",value:function(){var o=(0,Ki.default)(function*(r){var t=r.map(function(a){return{id:a,content:""}});return this.workflowMessageHandler.onChatStoreMessagesSet({messages:t,options:{operationType:ho.Delete}},this.executionContext)});function e(r){return o.apply(this,arguments)}return e}()},{key:"getMessages",value:function(){var o=(0,Ki.default)(function*(r){return this.workflowMessageHandler.onChatStoreMessagesGet({options:r},this.executionContext)});function e(r){return o.apply(this,arguments)}return e}()}]),n}();var jI=new F("workflowSequencerEnabled",!0),JI=new F("workflowSequencerDisabledWorkflows",[]),KI=new F("workflowDeactivateTokensDisabledWorkflows",["ChangeSummaries","Copywriter","Voice","WritersUnblock"]),$I=new F("workflowDefaultTimeout",8e3),rv=new Set,ov=new F("getAnnotationsTimeoutMs",8e3),sv=function(o,e,r,t,a,s,u,l,f,c,d){var h,p,k,S,C=et(),T=!1,x=(p=(h=t.scopeItem)===null||h===void 0?void 0:h.contextId)!==null&&p!==void 0?p:(S=(k=t.inputItems)===null||k===void 0?void 0:k[0])===null||S===void 0?void 0:S.contextId;Na(function(){var A=(0,nc.default)(function*(b){var E;v.debug(512336708,y.CoreDefault,function(){return"executeWorkflow id: "+o.id+", inputs count: "+(t.inputItems?t.inputItems.length:-1)});var I=new D({operationName:"ExecuteWorkflowOnService",resourceId:o.resourceId,joinContextId:x!=null?x:""}).start(),_=t.scopeItem||(t.inputItems&&t.inputItems.length>=1?t.inputItems[0]:void 0),M=(l==null?void 0:l.kind)!==Nr.ModelIterating,N=M?new Map:void 0;if(_&&M&&(_.parentPath||v.error(512336707,y.CoreDefault,"Missing scope item parent. Workflow: "+o.id+". Type: "+m.getTypeNameFor(_.body)),N.set(_.body,_)),Array.isArray(t.inputItems)&&M)for(var R of t.inputItems)R&&R.body&&(R.parentPath||v.error(512336706,y.CoreDefault,"Missing parent. Workflow: "+o.id+". Type: "+m.getTypeNameFor(R.body)),N.set(R.body,R));var P=[],O=_?[].concat((0,tc.default)(_.parentPath),[_.id]):void 0,z=function($){Re(function(){var H=new D({operationName:"submitSignalsAction",resourceId:o.id,success:!0});for(var le of $){var oe=m.getTypeNameFor(le);m.matchesTypesFor(le,[Gt.getTypeName()])||(H.resultDescription="Workflow produced an output that is not an signal ("+m.getTypeNameFor(le)+")",v.info(512336705,y.CoreDefault,H)),(!o.outputTypes||o.outputTypes.indexOf(oe)===-1)&&(H.resultDescription="Workflow said it would output one of ["+o.outputTypes+"] but instead output "+oe,v.info(512336704,y.CoreDefault,H)),le.timestamp&&(rv.has(o.id)||(rv.add(o.id),H.resultDescription='Workflow "'+o.id+'" sets signal.timeStamp',v.info(509212802,y.CoreDefault,H)))}var de=$.map(function(At){return{id:dn(),source:o.id,body:At,contextId:x}}),Te=new Ze({parentPath:["session"],items:de}),Xt=new Ue({cv:b.cv.toString(),ops:[Te]}),Yt=JSON.stringify(de.map(function(At){var po,_r;return{id:At.id,type:(_r=(po=At.body)===null||po===void 0?void 0:po.H_)===null||_r===void 0?void 0:_r.T_}}));v.debug(512336675,y.CoreDefault,"Publishing message for triggering signals "+Yt+"."),e.onMessage(Xt,r).then(function(){v.debug(512336674,y.CoreDefault,"Signals "+Yt+" successfully triggered.")}).catch(function(At){v.error(512336673,y.CoreDefault,"Error sending signals "+Yt+": "+At+".")})},b)},J=function($,H,le){Re(function(){var oe;switch(le){case fr.JoinContext:{if(!_.contextId){var de="ContextId is not defined for this scope item.";throw v.error(512336672,y.CoreDefault,de),new Error(de)}oe=_.contextId;break}case fr.Session:{oe=void 0;break}default:{var Te="Defined scope is not supported. "+le;throw v.error(512336671,y.CoreDefault,Te),new Error(Te)}}var Xt=new Kn({definition:H,contextId:oe,sourceWorkflowId:o.id,targetWorkflowId:$});e.onMessage(Xt,r).catch(function(Yt){v.error(512336670,y.CoreDefault,"Error overriding config for workflow: "+$+", contextId: "+_.contextId+": "+Yt+".")})},b)},ce=function($,H,le,oe){Re(function(){if(o.isStateful){var de=u.getAnnotationSequenceGenerator(o,r.sessionKey,r.userId);de==null||de.generate(le)}var Te=me($,H,le,oe);if(oe&&oe.immediate){var Xt=new ji({workflow:o,scopeItemPath:O,scopeItemRevId:_==null?void 0:_.revId,annotationQueue:[Te]});if(e.onAnnotationResult(Xt,r).catch(function(Yt){v.error(512336669,y.CoreDefault,"Error posting annotations: "+Yt)}),rs(o,H))return}P.push(Te)},b)},ae=function($,H,le,oe){var de=et();Re(function(){if(L("setAnnotationsThrowOnInvalidCC")&&(!de||(de==null?void 0:de.sessionKey)!==(b==null?void 0:b.sessionKey)))throw new Error("actions.setAnnotations must be called with a CV matching the session");if(!M)throw new Error("actions.setAnnotations should not be used for the WFs that use model iterating async boundary loader. Use IWorkflowModelItem.addAnnotation instead");var Te=void 0;if(!(oe!=null&&oe.isSessionAnnotation)&&(Te=N.get($),!Te))throw v.error(512336664,y.CoreDefault,"Workflow is trying to annotate an unknown object"),new Error(K[K.UnknownAnnotationParent]);ce(Te,H,le,oe)},b)},re=function($){return new Promise(function(H,le){var oe=setTimeout(function(){le(new Error("Timeout: No response received within "+$.maxDelayMs+" ms"))},$.maxDelayMs?$.maxDelayMs:ov.getValue());V($,$.maxDelayMs?$.maxDelayMs:ov.getValue(),function(de,Te){clearTimeout(oe),de?le(de):H(Te)})})},V=function($,H,le){var oe=new Kr({annotationTypes:$.annotationTypes,transientItems:$.transientItems});e.onMessage(oe,r,H).then(function(de){var Te=de==null?void 0:de.payload;if(!Te)le(new Error("GetAnnotations call didn't return anything"),void 0);else if(m.matchesTypesFor(Te,[X.getTypeName()]))le(new Error(Te.error),void 0);else if(m.matchesTypesFor(Te,[Oi.getTypeName()]))le(void 0,{content:Te.content});else{var Xt="Unexpected response with types: "+m.getBaseTypesFor(Te);v.error(508680269,y.CoreDefault,Xt),le(new Error(Xt),void 0)}}).catch(function(de){v.error(508680268,y.CoreDefault,"Error with getDynamicAnnotations call: "+de.message),le(de,void 0)})},me=function($,H,le,oe){if(!Array.isArray(le))throw v.error(512336668,y.CoreDefault,"Workflow produced an invalid annotation array"),new Error(K[K.AnnotationsNotArray]);if(!o.outputTypes||o.outputTypes.indexOf(H)===-1)throw v.error(512336667,y.CoreDefault,"Workflow said it would output one of ["+o.outputTypes+"] but instead output "+H),new Error(K[K.UnexpectedOutput]);for(var de of le){if(!m.matchesTypesFor(de,[gt.getTypeName()]))throw v.error(512336666,y.CoreDefault,"Workflow produced an output that is not an annotation ("+m.getTypeNameFor(de)+")"),new Error(K[K.OutputIsNotAnnotation]);if(m.getTypeNameFor(de)!==H)throw v.error(512336665,y.CoreDefault,"Workflow produced inconsistent annotation types in setAnnotations call ("+m.getTypeNameFor(de)+" did not match expected "+H+")"),new Error(K[K.MixedOutput])}return oe&&oe.isSessionAnnotation?{path:["session"],contextId:x,ancestorType:oe.ancestorType,annotationType:H,annotations:le,isImmediateAnnotation:oe.immediate}:oe&&oe.ancestorType?{path:$.parentPath,contextId:x,ancestorType:oe.ancestorType,annotationType:H,annotations:le,isImmediateAnnotation:oe.immediate}:{path:[].concat((0,tc.default)($.parentPath),[$.id]),revId:$.revId,contextId:x,annotationType:H,annotations:le,isImmediateAnnotation:oe==null?void 0:oe.immediate}},te;if(L("WorkflowTimeout")){var ke=o.maxExecutionTimeInS*1e3||$I.getValue();te=setTimeout(function(){te=void 0,d(new Error(K[K.WorkflowTimeout]),void 0)},ke)}var He=function($,H){if(T=!0,L("WorkflowTimeout")){if(!te)return;clearTimeout(te)}Re(function(){var le,oe,de,Te;(!$||H!=null&&H.preserveQueuedOnError||!((le=H==null?void 0:H.strategy)===null||le===void 0)&&le.preserveQueued)&&((oe=xe.getModel())===null||oe===void 0||oe.commitPendingAnnotations()),I&&(I.success=!$,$&&$ instanceof vo&&(I.success=!0,I.dimension2="ExpectedFailure"),v.info(512336663,y.CoreDefault,I.stop())),$&&(H!=null&&H.preserveQueuedOnError||!((de=H==null?void 0:H.strategy)===null||de===void 0)&&de.preserveQueued)?(v.info(512336662,y.CoreDefault,"Workflow execution failed and preserving queue, with error: "+$.message+" at "+$.stack),d(void 0,{error:$.message,isExpectedError:$ instanceof vo,annotations:P})):d($,{annotations:H!=null&&H.ignoreExecution?void 0:P,ignoreExecution:(Te=H==null?void 0:H.ignoreExecution)!==null&&Te!==void 0?Te:!1})},b)},rt=f(r.sessionKey),ut=function(){function Se(){(0,iv.default)(this,Se);var $;this.clientMetadata=a,this.userContext=r.userContext,this.blobContext={sessionKey:r.sessionKey,userId:r.userId},this.triggerSignals=t.triggerSignals,this.existingAnnotations=($=t.existingAnnotations)===null||$===void 0?void 0:$.map(function(H){return H.body}),this.annotationActivationConfigs=t.annotationActivationConfigs,this.workflowId=o.id,this.sessionEndpoint={url:rt.sessionUrl,origin:r.origin},this._model=o.modelOptions?this.createModel():void 0}return(0,av.default)(Se,[{key:"model",get:function(){var H;return(H=this._model)!==null&&H!==void 0||(this._model=this.createModel()),this._model}},{key:"flights",get:function(){var H;return(H=this._flights)!==null&&H!==void 0||(this._flights=io(this.clientMetadata.flights)),this._flights}},{key:"workflowStore",get:function(){return!this._workflowStoreManager&&c&&(this._workflowStoreManager=c(r.userId,r.sessionKey,this.workflowId)),this._workflowStoreManager}},{key:"chatStore",get:function(){if(!L("EnableChatStore")){v.warn(508851673,y.CoreDefault,"Calling chat store from context while chat store is turned off");return}return this._chatStore||(this._chatStore=new nv(e,r)),this._chatStore}},{key:"getToken",value:function(H,le){if(T&&(v.error(509141987,y.CoreDefault,"Asking for token "+H+" after workflow is complete. Stack "+Error().stack),L("deactivateTokens")&&KI.getValue().indexOf(o.id)===-1)){le(new Error("Cannot provide token "+H+" after workflow is complete"),void 0);return}if(s){var oe=function(Te,Xt,Yt){le(Te,Xt,{returnedTokenType:Yt})};return s(o,H,oe)}else throw v.error(512336661,y.CoreDefault,"NYI: Workflow service getTokenCallback for workflow "+o.id+" is not available."),new Error("Token callback not available")}},{key:"getModel",value:function(){return this._model}},{key:"createModel",value:function(){var H,le,oe,de,Te,Xt=new Zm,Yt;M&&(Yt=function(Sd){N.set(Sd.body,Sd)});var At=new zm(_,ce,Yt,l,o.modelSchema,Xt,t.truncationContext,void 0,o.modelOptions);if(o.kind!==q.SingleItem)if(t.dynamicContext)if(o.kind===q.DynamicText||o.kind===q.Generic){var po=t.dynamicContext;At.addItems(po.contextAbove,!0),At.addItems(t.inputItems),At.addItems(po.contextBelow,!0)}else throw new Error(o.kind+" workflow does not support dynamic context");else At.addItems(t.inputItems);else(!((H=o.modelOptions)===null||H===void 0)&&H.includeScopeItemParent||!((le=o.modelOptions)===null||le===void 0)&&le.includeRootItemParent)&&((oe=t.inputItems)===null||oe===void 0?void 0:oe.length)===2&&At.addItems([t.inputItems[1]]);return!((de=o.modelOptions)===null||de===void 0)&&de.includeExistingAnnotations&&((Te=t.existingAnnotations)===null||Te===void 0||Te.forEach(function(_r){At.getItemByReference({referencedPath:_r.parentPath}).addAnnotation(_r.body)})),At.addItems(t.requestedContexts),At}}]),Se}(),xe=new ut,lt={setAnnotations:ae,submitSignals:z,overrideWorkflowDefinition:J,getDynamicAnnotations:re,done:He},$e;if(o.isStateful&&($e=u.getState(o,r.sessionKey,r.userId)),!$e)try{$e=o.factory(),o.isStateful&&u.setState(o,r.sessionKey,r.userId,$e)}catch(Se){d(new Error("workflow "+o.id+" instance creation process got error: "+Se.message),void 0);return}var qt=function(){var Se=(0,nc.default)(function*($){try{yield $()}catch(H){v.error(512336660,y.CoreDefault,"workflow "+o.id+" execution error: "+H.message+" at "+H.stack)}});return function(H){return Se.apply(this,arguments)}}(),rr=function(){o.isStateful||$e.dispose()};if(o.kind===q.SingleItem){if(t.inputItems.length!==1&&t.inputItems.length!==2){v.error(508621079,y.CoreDefault,"Single item workflows expect one or two inputs (second item is the parent item if requested)"),He(new Error(K[K.InvalidInputQuantityForSingleItemWorkflow]));return}xe.delta=t.inputItems[0].delta,xe.deltas=t.inputItems[0].deltas;var vn=t.inputItems[0],yn=vn.body;if(yn&&o.id==="VoiceUxo"&&(yn.seq=(E=yn.seq)!==null&&E!==void 0?E:parseInt(vn==null?void 0:vn.id,10)),jI.getValue()&&!JI.getValue().includes(o.id)&&!o.skipWorkflowItemSequencing&&yn.seq!==void 0){o.id!=="Workflows/Voice"&&v.info(512336659,y.CoreDefault,"WorkflowSequencerEnabled workflow has sequencing with id: "+o.id);try{var ln=u.getBufferingSequencer(o,r.sessionKey,r.userId);ln!==void 0?yield ln.sequence(yn.seq):v.error(512336658,y.CoreDefault,"BufferingSequencer does not exist in cache and was not instantiated")}catch(Se){if(v.error(512336657,y.CoreDefault,"Error processing workflow sequence: "+Se),L("SkipWorkflowExecutionOnInvalidSeq")){He(new Error(K[K.SequenceOutOfOrder])),rr();return}}}L("CatchWorkflowExecutionError")?qt(function(){return $e.execute(yn,xe,lt)}):$e.execute(yn,xe,lt)}else if(o.kind===q.DynamicText){if(!Array.isArray(t.inputItems))throw new Error("Dynamic text workflows expect an array of input items");var Ir=new Ya(t.inputItems.map(function(Se){return Se.body}));xe.dynamicTextContext=t.dynamicContext,L("CatchWorkflowExecutionError")?qt(function(){return $e.execute(Ir,xe,lt)}):$e.execute(Ir,xe,lt)}else if(o.kind===q.Reduce){if(!Array.isArray(t.inputItems))throw new Error("Reduce workflows expect an array of input items");var Rn=new Ya(t.inputItems.map(function(Se){return Se.body}));L("CatchWorkflowExecutionError")?qt(function(){return $e.execute(_.body,Rn,xe,lt)}):$e.execute(_.body,Rn,xe,lt)}else if(o.kind===q.Grid){var ht=t.inputContext,Nn=[];t.inputItems.slice(0,ht.numberOfNonEmptyCells).forEach(function(Se){if(Se&&Se.body){var $=Se.body,H=$.row-ht.neighborhoodTopRow,le=$.column-ht.neighborhoodLeftColumn;Nn[H]||(Nn[H]=[]),Nn[H][le]=$}});var au=t.inputItems.slice(ht.numberOfNonEmptyCells),or=new Ya(au.map(function(Se){return Se.body}));v.info(512336656,y.CoreDefault,"sending grid to workflow. inputItems length: "+ht.numberOfNonEmptyCells+"; grid context "+JSON.stringify(ht)),L("CatchWorkflowExecutionError")?qt(function(){return $e.execute(_.body,{targetGridRelativeTopRow:ht.targetGridRelativeTopRow,targetGridRelativeLeftColumn:ht.targetGridRelativeLeftColumn,cells:Nn},or,ht,xe,lt)}):$e.execute(_.body,{targetGridRelativeTopRow:ht.targetGridRelativeTopRow,targetGridRelativeLeftColumn:ht.targetGridRelativeLeftColumn,cells:Nn},or,ht,xe,lt)}else if(o.kind===q.Join){if(!Array.isArray(t.inputItems))throw new Error("Join workflows expect an array of input items");xe.delta=_.delta,xe.deltas=_.deltas;var co=t.inputItems.map(function(Se){return Se.body});L("CatchWorkflowExecutionError")?qt(function(){return $e.execute(_.body,co,xe,lt)}):$e.execute(_.body,co,xe,lt)}else o.kind===q.Generic&&(L("CatchWorkflowExecutionError")?qt(function(){return $e.execute(xe.model,xe,lt)}):$e.execute(xe.model,xe,lt));rr()});return function(b){return A.apply(this,arguments)}}(),C==null?void 0:C.cv.toString(),C==null?void 0:C.sessionDescriptor,C==null?void 0:C.clientMetadata,o.resourceId,x)};var rc=function(o,e,r,t,a,s,u,l,f){return new Promise(function(c,d){sv(o,e,r,t,a,s,u,l,f,void 0,function(h,p){if(h){d(h);return}c(p)})})};g();var cv=w(W()),dv=w(B());g();g();var uv=w(W()),lv=w(B());var Wo=function(){function n(){var o=arguments.length>0&&arguments[0]!==void 0?arguments[0]:500,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;(0,uv.default)(this,n),this.prevSeq=-1,this.bufferingTimeMs=o,this.rejectOutdatedSequenceNumbers=e}return(0,lv.default)(n,[{key:"sequence",value:function(e){var r=this;return new Promise(function(t,a){if(e<r.prevSeq)if(r.rejectOutdatedSequenceNumbers){var s=new Error("BufferingSequencer: Item out of order. Expecting seqId > "+r.prevSeq+". Actual seqId "+e);s.name=n.Rejected,a(s);return}else r.prevSeq=-1;e!=r.prevSeq+1&&v.warn(542712385,y.CoreDefault,"BufferingSequencer: got out of order sequence number. Got "+e+", expected "+(r.prevSeq+1));var u={seq:e,resolve:t};r.insertItem(u),r.runInOrder(u,!0,!1)})}},{key:"insertItem",value:function(e){if(!this.firstQueueItem){this.firstQueueItem=e,this.lastQueueItem=e;return}var r=this.lastQueueItem,t=null;do{if(e.seq>r.seq){e.prev=r,r.next=e,t?t.prev=e:this.lastQueueItem=e;return}t=r,r=r.prev}while(r);t&&(t.prev=e),e.next=t,this.firstQueueItem=e}},{key:"runInOrder",value:function(e,r,t){for(var a=this,s=this.prevSeq,u=!1,l=[];this.firstQueueItem;){var f=this.firstQueueItem;if(s+1!=f.seq&&(!t||f.seq>e.seq))break;s=f.seq,f.timeout&&clearTimeout(f.timeout),l.push(f),e==f&&(u=!0),this.firstQueueItem=this.firstQueueItem.next,this.firstQueueItem&&(this.firstQueueItem.prev=null)}l.length>0&&setTimeout(function(){for(var c of l)c.resolve(c.seq)},0),this.prevSeq=s,!u&&r&&(e.timeout=setTimeout(function(){a.runInOrder(e,!1,!0)},this.bufferingTimeMs))}}]),n}();Wo.Rejected="SequenceItemRejected";var XI=new F("workflowStateCacheSweepInterval",1e3),pv=new F("workflowStateCacheIdleTimeoutMs",3e4),YI=new F("workflowStateCacheIdleTimeoutPerWorkflowMs",{}),ZI=new F("sequencerTimeoutInMs",500),e_=function(o){return o.stateExpiryMs||pv.getValue()},fv=function(o,e,r){if(!o)throw new Error("workflowId is undefined");if(!e)throw new Error("sessionKey is undefined");if(!r)throw new Error("userId is undefined");return o+"-"+e+"-"+r},hv=function(){function n(){(0,cv.default)(this,n),this.cache=new Cn({sweepInterval:XI.getValue(),idleDurationMs:pv.getValue(),idleCallback:this.onStateIdle.bind(this)})}return(0,dv.default)(n,[{key:"setState",value:function(e,r,t,a){if(!e){v.error(526952585,y.CoreDefault,"cannot set state for undefined workflow");return}if(!e.isStateful){v.error(526952586,y.CoreDefault,"WorkflowStateCache: Attempting to set state for the stateless workflow "+e.id);return}var s=fv(e.id,r,t),u=this.cache.get(s);if(u&&u.state.dispose(),a){var l={cc:et(),state:a,annotationSequenceGenerator:new Bm,bufferingSequencer:new Wo(ZI.getValue(),!0)};this.cache.put(s,l,e_(e),this.onStateIdle.bind(this),YI.getValue()[e.id])}else this.cache.del(s)}},{key:"getState",value:function(e,r,t){var a=this.getStateCacheItem(e,r,t);return a==null?void 0:a.state}},{key:"getAnnotationSequenceGenerator",value:function(e,r,t){var a=this.getStateCacheItem(e,r,t);return a==null?void 0:a.annotationSequenceGenerator}},{key:"getBufferingSequencer",value:function(e,r,t){var a=this.getStateCacheItem(e,r,t);return a==null?void 0:a.bufferingSequencer}},{key:"clear",value:function(){this.cache.clear()}},{key:"getStateCacheItem",value:function(e,r,t){if(!e){v.error(526952587,y.CoreDefault,"cannot get state for undefined workflow");return}if(e.isStateful){var a=this.cache.get(fv(e.id,r,t));return a}}},{key:"onStateIdle",value:function(e,r){Re(function(){return r.state.dispose()},r.cc)}}]),n}();g();var wv=w(W()),Sv=w(B());g();var Xi=w(mn()),yv=w(W()),kv=w(B());g();var oc=w(Ha()),gv=w(qe()),mv=w(Ge()),$i=w(De()),ao=w(mn()),ic=w(W()),ac=w(B());function t_(n){var o=n_();return function(){var r=(0,$i.default)(n),t;if(o){var a=(0,$i.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,mv.default)(this,t)}}function n_(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var r_=new F("workflowStoreSweepIntervalMs",1e4),o_=new F("workflowStoreItemExpiryMs",6e5),i_=function(){function n(o,e,r,t,a){if((0,ic.default)(this,n),this.storeType=Hn.WorkflowSession,!e)throw new Error("workflowId is required");if(this.workflowId=e,!r)throw new Error("sessionKey is required");if(this.sessionKey=r,!t)throw new Error("userId is required");if(this.userId=t,!o)throw new Error("instanceId is required");this.instanceId=o,this.cache=new Cn({sweepInterval:r_.getValue()}),this.onWorkflowStoreCleared=a}return(0,ac.default)(n,[{key:"setItem",value:function(){var o=(0,ao.default)(function*(r,t,a,s){var u=this;return new Promise(function(l,f){try{var c=u.getStoreKey(u.workflowId,u.sessionKey,u.userId,r);t?u.cache.put(c,t,s!=null?s:o_.getValue(),u.onItemExpired.bind(u)):u.cache.del(c),l(!0)}catch(d){f(d)}})});function e(r,t,a,s){return o.apply(this,arguments)}return e}()},{key:"getItem",value:function(){var o=(0,ao.default)(function*(r,t){var a=this;return new Promise(function(s,u){var l=a.getStoreKey(a.workflowId,a.sessionKey,a.userId,r),f=a.cache.get(l);s(f)})});function e(r,t){return o.apply(this,arguments)}return e}()},{key:"getStoreKey",value:function(e,r,t,a){return e+"-"+r+"-"+t+"-"+a}},{key:"clear",value:function(){this.cache.clear(),this.onWorkflowStoreCleared&&this.onWorkflowStoreCleared(this.instanceId,this)}},{key:"onItemExpired",value:function(e,r){this.cache.size()===0&&this.clear()}}]),n}(),vv=function(n){(0,gv.default)(e,n);var o=t_(e);function e(r,t,a,s,u){return(0,ic.default)(this,e),o.call(this,r,t,a,s,u)}return(0,ac.default)(e,[{key:"setItem",value:function(){var r=(0,ao.default)(function*(a,s,u,l){var f=this,c=function(){var d=(0,ao.default)(function*(h,p){try{var k=yield(0,oc.default)((0,$i.default)(e.prototype),"setItem",f).call(f,a,s,u,l);if(!k)return p(new Error("Item not set in local cache"));h(k)}catch(S){p(S)}});return function(p,k){return d.apply(this,arguments)}}();return new Promise(c)});function t(a,s,u,l){return r.apply(this,arguments)}return t}()},{key:"getItem",value:function(){var r=(0,ao.default)(function*(a,s){var u=this,l=function(){var f=(0,ao.default)(function*(c,d){try{var h=yield(0,oc.default)((0,$i.default)(e.prototype),"getItem",u).call(u,a,s);if(h)return c(h);c(void 0)}catch(p){d(p)}});return function(d,h){return f.apply(this,arguments)}}();return new Promise(l)});function t(a,s){return r.apply(this,arguments)}return t}()}]),e}(i_);var sc=function(){function n(o){(0,yv.default)(this,n);var e;if(!o.userId)throw new Error("userId is required");this.userId=o.userId,this.workflowId=o.workflowId,this.sessionKey=o.sessionKey,this.workflowStores=(e=o.workflowStores)!==null&&e!==void 0?e:new Map,this.onWorkflowStoreCleared=o.workflowStoreClearedCallback}return(0,kv.default)(n,[{key:"setItem",value:function(){var o=(0,Xi.default)(function*(r,t){var a=this,s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Hn.WorkflowSession,u=arguments.length>3?arguments[3]:void 0,l=function(){var f=(0,Xi.default)(function*(c,d){try{var h=a.getStoreInstance(s),p=yield h.setItem(r,t,s,u);c(p)}catch(k){d(k)}});return function(d,h){return f.apply(this,arguments)}}();return new Promise(l)});function e(r,t){return o.apply(this,arguments)}return e}()},{key:"getItem",value:function(){var o=(0,Xi.default)(function*(r,t){var a=this,s=function(){var u=(0,Xi.default)(function*(l,f){try{var c=a.getStoreInstance(t),d=yield c.getItem(r,t);l(d)}catch(h){f(h)}});return function(f,c){return u.apply(this,arguments)}}();return new Promise(s)});function e(r,t){return o.apply(this,arguments)}return e}()},{key:"getStoreInstance",value:function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Hn.WorkflowSession,r,t=this.userId+"-"+this.sessionKey+"-"+this.workflowId;switch(e){case Hn.WorkflowSession:if(!this.sessionKey||!this.workflowId)throw new Error("sessionKey and workflow not set for this instance");r=this.workflowStores.get(t),r||(r=new vv(t,this.workflowId,this.sessionKey,this.userId,this.workflowStoreClearedCallback.bind(this)),this.workflowStores.set(t,r));break;case Hn.User:throw new Error("Workflow Store for user type is not yet implemented");default:throw new Error("Invalid store type")}return r}},{key:"workflowStoreClearedCallback",value:function(e,r){this.workflowStores.delete(e),this.workflowStores.size===0&&this.onWorkflowStoreCleared&&this.onWorkflowStoreCleared(this.userId,this)}}]),n}();var Cv=function(){function n(){(0,wv.default)(this,n),this.workflowStoreRegistry=new Map}return(0,Sv.default)(n,[{key:"getWorkflowStoreManager",value:function(e,r,t){var a=this.workflowStoreRegistry.get(e);return a||(a=new sc({userId:e}),this.workflowStoreRegistry.set(e,a)),new sc({sessionKey:r,workflowId:t,userId:a.userId,workflowStoreClearedCallback:this.workflowStoreClearedCallback.bind(this),workflowStores:a.workflowStores})}},{key:"workflowStoreClearedCallback",value:function(e,r){this.workflowStoreRegistry.delete(e)}}]),n}();g();var Wv=w(W()),Bv=w(B()),Pv=w(Ha()),Ov=w(qe()),Lv=w(Ge()),us=w(De());g();var Av=w(W()),bv=w(B());g();var lc=w(Ie());var uc=new Map,d1=new F("workflowSynchronizationInterval",10),os=function(o){if(!uc.has(o)){var e="Workflows/",r=o.startsWith(e)?o.substring(e.length):o;return uc.set(o,r),r}return uc.get(o)};var Tv=function(o,e){return!(e&&e.includeExistingAnnotations&&o)},Iv=function(o,e,r){if(!o||e===void 0)return!0;r!=null||(r=[]);for(var t of e)if(!r.includes(t))return!1;return!0},_v=function(o,e){o=o!=null?o:[],e=e!=null?e:[];var r=Array.from(new Set(o)).sort(),t=Array.from(new Set(e)).sort();if(r.length!==t.length)return!1;for(var a=0;a<r.length;a++)if(r[a]!==t[a])return!1;return!0},xv=[m.getTypeName(),gt.getTypeName(),Gt.getTypeName()],is=function(o){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0,r=new Set;for(var t of o)if(typeof t=="string")xv.includes(t)||r.add(t);else{var a=e?[t.getTypeName()].concat((0,lc.default)(t.getBaseTypes())):[t.getTypeName()];for(var s of a)xv.includes(s)||r.add(s)}return(0,lc.default)(r)};var fc=function(o,e,r){if(e!==r){if(e===void 0){o.push(r);return}if(r===void 0){o.splice(o.indexOf(e),1);return}var t=o.indexOf(e);o[t]=r}};var Mv=function(){function n(o,e){(0,Av.default)(this,n);var r,t;this.visibility=Wr.Default,this.id=o,this.resourceId=os(o),e&&(this.requestedContextTypesRules=(r=e.requestedContextTypesRules)!==null&&r!==void 0?r:this.requestedContextTypesRules,this.eventSequenceOptions=(t=e.eventSequenceOptions)!==null&&t!==void 0?t:this.eventSequenceOptions)}return(0,bv.default)(n,[{key:"validateOptions",value:function(){return{isValid:!0}}},{key:"setRequestedContexts",value:function(e){var r;return this.requestedContextTypesRules=((r=this.requestedContextTypesRules)!==null&&r!==void 0?r:this.requestedContextTypesRules=[]).concat(e),this}},{key:"setEventSequenceOptions",value:function(e){return this.eventSequenceOptions=e,this}}]),n}();g();var as=w(B()),ss=w(W());var a_=(0,as.default)(function n(o,e){(0,ss.default)(this,n),this.name=o,this.defaultValue=e}),Ev=(0,as.default)(function n(o,e){(0,ss.default)(this,n),this.type=en.MaxInputCount,typeof o=="number"?this.maxCount=o:o instanceof a_&&(this.setting=o),this.action=e}),Rv=(0,as.default)(function n(o,e){(0,ss.default)(this,n),this.type=en.UILanguage,o instanceof Array?this.languages=o:this.setting=o,this.action=e});function s_(n){var o=u_();return function(){var r=(0,us.default)(n),t;if(o){var a=(0,us.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,Lv.default)(this,t)}}function u_(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var Nv=Symbol("maxInputCountPrefilter"),Dv=Symbol("languagesPrefilter"),ls=function(n){(0,Ov.default)(e,n);var o=s_(e);function e(r,t){var a;(0,Wv.default)(this,e);var s,u,l,f,c,d,h,p,k,S,C,T,x,A,b,E,I,_,M,N,R;return a=o.call(this,r,t),a.kind=q.Reduce,a.priority=0,a.activationConfigs=[{clientAppName:"All",clientAppPlatform:"All",activationTier:cn.Default}],a.inputStage=Zt.All,a.minDelayMs=1e3,a.maxDelayMs=5e3,a.isStateful=!1,a.bypassModel=!1,a.bypassTypes=void 0,a.fetchExistingAnnotations=!1,a.billingDomain=xa.Default,t&&(a.priority=(s=t.priority)!==null&&s!==void 0?s:a.priority,a.inputTypes=(u=t.inputTypes)!==null&&u!==void 0?u:a.inputTypes,a.outputTypes=(l=t.outputTypes)!==null&&l!==void 0?l:a.outputTypes,a.inputStage=(f=t.inputStage)!==null&&f!==void 0?f:a.inputStage,a.isStateful=(c=t.isStateful)!==null&&c!==void 0?c:a.isStateful,a.activationConfigs=(d=t.activationConfigs)!==null&&d!==void 0?d:a.activationConfigs,a.triggerSignals=(h=t.triggerSignals)!==null&&h!==void 0?h:a.triggerSignals,a.requiredTokenTypes=(p=t.requiredTokenTypes)!==null&&p!==void 0?p:a.requiredTokenTypes,a.activationFlightsConfigs=(k=t.activationFlightsConfigs)!==null&&k!==void 0?k:a.activationFlightsConfigs,a.isAppOnlyTokenAllowed=(S=t.isAppOnlyTokenAllowed)!==null&&S!==void 0?S:a.isAppOnlyTokenAllowed,a.triggerConditions=(C=t.triggerConditions)!==null&&C!==void 0?C:a.triggerConditions,a.minDelayMs=(T=t.minDelayMs)!==null&&T!==void 0?T:a.minDelayMs,a.maxDelayMs=(x=t.maxDelayMs)!==null&&x!==void 0?x:a.maxDelayMs,a.maxExecutionTimeInS=(A=t.maxExecutionTimeInS)!==null&&A!==void 0?A:a.maxExecutionTimeInS,a.collectionScopeType=(b=t.collectionScopeType)!==null&&b!==void 0?b:a.collectionScopeType,a.bypassModel=(E=t.bypassModel)!==null&&E!==void 0?E:a.bypassModel,a.bypassTypes=(I=t.bypassTypes)!==null&&I!==void 0?I:a.bypassTypes,a.fetchExistingAnnotations=(_=t.fetchExistingAnnotations)!==null&&_!==void 0?_:a.fetchExistingAnnotations,a.modelOptions=(M=t.modelOptions)!==null&&M!==void 0?M:a.modelOptions,a.definitionOverrideTargetWorkflows=(N=t.definitionOverrideTargetWorkflows)!==null&&N!==void 0?N:a.definitionOverrideTargetWorkflows,a.billingDomain=(R=t.billingDomain)!==null&&R!==void 0?R:a.billingDomain),a}return(0,Bv.default)(e,[{key:"setPriority",value:function(t){return this.priority=t,this}},{key:"setActivationConfigs",value:function(t){return this.activationConfigs=t,this}},{key:"setCollectionScopeType",value:function(t){return this.collectionScopeType=t,this}},{key:"setInputTypes",value:function(t){return this.inputTypes=is(t,!1),this}},{key:"setInputStage",value:function(t){return this.inputStage=t,this}},{key:"setTriggerSignals",value:function(t){return this.triggerSignals=t,this}},{key:"setOutputTypes",value:function(t){return this.outputTypes=is(t),this}},{key:"setTriggerConditions",value:function(t){return this.triggerConditions=t,this}},{key:"setMinDelayTime",value:function(t){return this.minDelayMs=t?Math.max(0,t):void 0,this}},{key:"setMaxDelayTime",value:function(t){return this.maxDelayMs=t?Math.max(0,t):void 0,this}},{key:"setMaxExecutionTime",value:function(t){return this.maxExecutionTimeInS=t,this}},{key:"setStateful",value:function(){return this.isStateful=!0,this}},{key:"setStateExpiryMs",value:function(t){return this.stateExpiryMs=t,this}},{key:"setLambdaType",value:function(t){return this.factory=function(){return new t},this}},{key:"setLambda",value:function(t){return this.factory=function(){return{execute:t,dispose:function(){}}},this}},{key:"setRequiredTokenTypes",value:function(t){return this.requiredTokenTypes=t,this}},{key:"setOptionalTokenTypes",value:function(t){return this.optionalTokenTypes=t,this}},{key:"setActivationFlightsConfigs",value:function(t){return this.activationFlightsConfigs=t,this}},{key:"setIsAppOnlyTokenAllowed",value:function(t){return this.isAppOnlyTokenAllowed=t,this}},{key:"setBypassModel",value:function(t){return this.bypassModel=!0,t&&(this.bypassTypes=is(t)),this}},{key:"setFetchExistingAnnotations",value:function(){return this.fetchExistingAnnotations=!0,this}},{key:"setModelOptions",value:function(t){return this.modelOptions=t,this}},{key:"validateOptions",value:function(){var t=(0,Pv.default)((0,us.default)(e.prototype),"validateOptions",this).call(this);return t.isValid?Tv(this.bypassModel,this.modelOptions)?Iv(this.bypassModel,this.bypassTypes,this.outputTypes)?{isValid:!0}:{isValid:!1,errorMessage:"Types provided to 'setBypassModel' must be set in 'setOutputTypes'."}:{isValid:!1,errorMessage:"Option 'includeExistingAnnotations' can't be enabled if 'bypassModel' is enabled."}:t}},{key:"setDefinitionOverrideTargetWorkflows",value:function(t){return this.definitionOverrideTargetWorkflows=t,this}},{key:"setMaxInputCountPrefilter",value:function(t,a){var s,u=new Ev(t,a);return fc((s=this.prefilters)!==null&&s!==void 0?s:this.prefilters=[],this[Nv],u),this[Nv]=u,this}},{key:"setSupportedLanguagesPrefilter",value:function(t,a){var s,u=new Rv(t,a);return fc((s=this.prefilters)!==null&&s!==void 0?s:this.prefilters=[],this[Dv],u),this[Dv]=u,this}},{key:"setBillingDomain",value:function(t){return this.billingDomain=t,this}}],[{key:"create",value:function(t){return new e(t)}}]),e}(Mv);var l_=new F("workflowsEnabledForFallbackToAugloopToken",[]),f_=function(o,e){switch(o){case ft.AutoClpLowPrivilege:return ft.AutoClpAppOnlyLowPrivilege;case ft.EditorLowPrivilege:return ft.EditorAppOnlyLowPrivilege;case ft.AugLoopLowPrivilege:return l_.getValue().includes(e)?ft.WacUserInfo:void 0}},Tn=function(o){return L("BypassModelPerAnnotationType")?o.bypassModel?o.bypassTypes===void 0?!0:_v(o.bypassTypes,o.outputTypes):!1:o.bypassModel},rs=function(o,e){return L("BypassModelPerAnnotationType")?o.bypassModel&&(o.bypassTypes===void 0||o.bypassTypes.includes(e)):o.bypassModel},Gv=function(){function n(o,e,r,t){(0,Fv.default)(this,n),this.workflowRegistry=new Map,this.workflowMessageHandler=o,this.workflowStateCache=new hv,this.workflowStoreRegistry=new Cv,this.registerWorkflows(e),this.asyncBoundaryLoaderRegistry=r,this.getSessionInfo=t}return(0,qv.default)(n,[{key:"onWorkflowRequest",value:function(){var o=(0,cc.default)(function*(r){var t=this,a,s,u=r.payload?r.payload:r,l=u.workflowId;if(!this.workflowRegistry.has(l))throw v.error(526718720,y.CoreDefault,"executeWorkflow workflow id '"+l+"' not available"),new Error("executeWorkflow workflow id '"+l+"' not available");var f=this.createTokensMap(u.tokens),c=function(I,_,M){var N;if(f){I.id!=l&&v.warn(526718721,y.CoreDefault,"Workflow "+I.id+" is requesting token and we are executing workflow "+l);var R=f.get(_);if(R)M(void 0,R,_);else{var P="Workflow "+I.id+" is requesting token "+ft[_]+" but it is not available";if(I.isAppOnlyTokenAllowed){var O=f_(_,l),z=f.get(O);z?M(void 0,z,O):(P=P+(", try alternate token "+ft[O]+" but it is not available either"),v.warn(526718722,y.CoreDefault,P),M(new Error(P),void 0))}else v.warn(526718723,y.CoreDefault,P),M(new Error(P),void 0)}}else{var J="Workflow "+I.id+" is requesting token "+ft[_]+" but tokensMap is undefined, from "+((N=u==null?void 0:u.tokens)===null||N===void 0?void 0:N.length)+" tokens. ";I.optionalTokenTypes?v.info(526718724,y.CoreDefault,J):v.error(526718725,y.CoreDefault,J),M(new Error(J),void 0)}},d=this.workflowRegistry.get(l);if(L("executeWorkflowCatchErrors")){var h=[],p=function*(I){zn(function(){var _=function(){var M=(0,cc.default)(function*(){var N;try{var R=yield rc(d,t.workflowMessageHandler,u.executionContext,I,u.clientMetadata,c,t.workflowStateCache,t.createAsyncBoundaryLoader(u,(N=d==null?void 0:d.modelOptions)===null||N===void 0?void 0:N.asyncBoundaryLoaderType,I),t.getSessionInfo,t.workflowStoreRegistry.getWorkflowStoreManager.bind(t.workflowStoreRegistry));return R}catch(P){return{error:P.message,isExpectedError:P instanceof vo}}});return function(){return M.apply(this,arguments)}}();h.push(_())})};for(var k of u.batchExecutionInputs)yield*Ar(p(k));var S=yield Promise.all(h);return new Eo({batchExecutionResults:S})}else{var C;L("OfficeVSO:7713714_EnableFetchGetRangeFromEcs")||(C=this.createAsyncBoundaryLoader(u,(a=d==null?void 0:d.modelOptions)===null||a===void 0?void 0:a.asyncBoundaryLoaderType,void 0));var T=[],x=function*(I){var _=L("OfficeVSO:7713714_EnableFetchGetRangeFromEcs")?t.createAsyncBoundaryLoader(u,(s=d==null?void 0:d.modelOptions)===null||s===void 0?void 0:s.asyncBoundaryLoaderType,I):C;zn(function(){T.push(rc(d,t.workflowMessageHandler,u.executionContext,I,u.clientMetadata,c,t.workflowStateCache,_,t.getSessionInfo,t.workflowStoreRegistry.getWorkflowStoreManager.bind(t.workflowStoreRegistry)).catch(function(M){return{error:M.message,isExpectedError:M instanceof vo}}))})};for(var A of u.batchExecutionInputs)yield*Ar(x(A));var b=Promise.all(T).then(function(E){return new Eo({batchExecutionResults:E})});return b.then(function(E){return v.verbose(526718726,y.CoreDefault,"workflow "+l+" execution success."),E}).catch(function(E){v.error(526718727,y.CoreDefault,"workflow "+l+" execution error: "+E.message+" at "+E.stack);var I=new X({messageId:r.messageId,error:E.message});return I})}});function e(r){return o.apply(this,arguments)}return e}()},{key:"registerWorkflow",value:function(e){this.workflowRegistry.set(e.id,e),this.workflowMessageHandler.setWorkflowRequestCallback(e,this.onWorkflowRequest.bind(this))}},{key:"close",value:function(){this.workflowStateCache.clear()}},{key:"getRegisteredWorkflows",value:function(){return Array.from(this.workflowRegistry.values())}},{key:"registerWorkflows",value:function(e){var r=this;e.forEach(function(t){r.registerWorkflow(t)})}},{key:"createTokensMap",value:function(e){if(!(!Array.isArray(e)||e.length===0)){if(e.length%2!==0){v.error(526718728,y.CoreDefault,"token information array contains odd number of items, it should be even for token id/value pairs");return}for(var r=new Map,t=0;t<e.length;t+=2){var a=ft[e[t]];r.set(a,e[t+1])}return r}}},{key:"createAsyncBoundaryLoader",value:function(e,r,t){var a;if(!((a=this.asyncBoundaryLoaderRegistry)===null||a===void 0)&&a.has(r))return this.asyncBoundaryLoaderRegistry.get(r)(e,this.workflowMessageHandler.onWorkflowModelRequest.bind(this.workflowMessageHandler),t)}}]),n}();g();var Uv;(function(n){n.SyncMessageProcessing="SyncMessageProcessing",n.ItemChangesTriggeredWorkflow="ItemChangesTriggeredWorkflow",n.ContextChangesTriggeredWorkflow="ContextChangesTriggeredWorkflow",n.ScheduleWorkflowExecution="ScheduleWorkflowExecution"})(Uv||(Uv={}));var j;(function(n){n.SynchronizeMessage="SynchronizeMessage",n.ApplyNextSequence="ApplyNextSequence",n.InvalidateWorkflow="InvalidateWorkflow",n.EvaulatePrefilters="EvaulatePrefilters",n.AddScopeGroupedParameters="AddScopeGroupedParameters",n.WorkflowExecution="WorkflowExecution",n.SendWorkflowRequest="SendWorkflowRequest",n.SendWorkflowRequestSync="SendWorkflowRequestSync",n.QueueWorkflow="QueueWorkflow",n.WaitingInWorkflowQueue="WaitingInWorkflowQueue",n.ExecutionTrackerInvalidate="ExecutionTracker.Invalidate",n.SetScopeExecutionNotification="SetScopeExecutionNotification",n.WorkflowRegistrationQueueTask="WorkflowRegistration.QueueTask",n.ResolveAndValidateAllRequestedContexts="ResolveAndValidateAllRequestedContexts",n.QueueOrSetScopeExecutionNotification="QueueOrSetScopeExecutionNotification",n.ValidateWorkflowExecution="ValidateWorkflowExecution",n.QueueExecutionNotification="QueueExecutionNotification",n.QueueGridNeighborhoodWorkflow="QueueGridNeighborhoodWorkflow",n.SyncMessageSequencerSendResponse="SyncMessageSequencerSendResponse",n.WaitingInDebounceQueue="WaitingInDebounceQueue",n.WaitingForPendingScopeExecution="WaitingForPendingScopeExecution",n.InvalidateHybridSingleItemWorkflow="InvalidateHybridSingleItemWorkflow",n.ProcessWorkflowResponse="ProcessWorkflowResponse",n.ProcessAnnotationQueue="ProcessAnnotationQueue",n.ProcessAnnotationQueueSync="ProcessAnnotationQueueSync",n.ConsolidateAnnotationQueue="ConsolidateAnnotationQueue",n.PersistAnnotationQueueStateless="PersistAnnotationQueue.Stateless",n.PersistAnnotationQueueStateful="PersistAnnotationQueue.Stateful",n.CommitAnnotations="CommitAnnotations",n.SendAnnotations="SendAnnotations",n.SendAnnotationsSync="SendAnnotationsSync",n.WaitingForInOrderMessage="WaitingForInOrderMessage",n.PrepareSequencedOperations="PrepareSequencedOperations",n.GridSplitterSplit="GridSplitter.Split",n.TableBoundaryGridSplitterSplit="TableBoundaryGridSplitter.Split",n.WaitingInSynchronizationQueue="WaitingInSynchronizationQueue",n.SynchronizeWorkflowTask="SynchronizeWorkflowTask",n.SynchronizeWorkflowTasks="SynchronizeWorkflowTasks",n.PostponeWorkflowTask="PostponeWorkflowTask"})(j||(j={}));var c_=function(o,e){var r=o.map(e);return o.filter(function(t,a){return r.indexOf(r[a])===a})},d_=function(o,e){var r=o.map(e);return o.filter(function(t,a){return r.lastIndexOf(r[a])===a})},fs=function(){function n(o){(0,zv.default)(this,n),this.session=o}return(0,Vv.default)(n,[{key:"processAnnotationQueue",value:function(e,r){if(Array.isArray(r)){var t=U(),a=t.start(j.ProcessAnnotationQueue),s=t.startSync(j.ProcessAnnotationQueueSync),u=new _e({sessionHealthEventName:"ProcessAnnotationQueue",success:!0,source:pe.Core,reason:Y.Core,impact:he.MissingOutput,resourceId:e.resourceId,count:0,message:"",affectedWorkflows:[e.resourceId]}).start();try{for(var l of r)if(Array.isArray(l.annotationQueue)){L("fasterConsolidateAnnotationQueue")?l.annotationQueue=this.consolidateAnnotationQueue(l.annotationQueue):this.consolidateAnnotationQueue(l.annotationQueue);for(var f of l.annotationQueue)if(Array.isArray(f.annotations))for(var c of f.annotations)u.count++,c.ownerId=e.id}t.stop(s),this.persistAnnotationQueue(e,r,u),v.info(529093132,y.CoreDefault,u.stop())}catch(d){t.stop(s),u.success=!1,u.dimension0=K[K.ApplyAnnotationsException],u.resultDescription=d.message,v.error(529093133,y.CoreDefault,u.stop()),v.error(529093134,y.CoreDefault,u.sessionHealthEventName+" "+d.stack)}U().stop(a)}}},{key:"consolidateAnnotationQueue",value:function(e){if(e.length<2)return e;var r=U().startSync(j.ConsolidateAnnotationQueue);if(L("fasterConsolidateAnnotationQueue")){for(var t=!1,a=0;a<e.length;a++)if(e[a].ancestorType){t=!0;break}if(!t){var s;return L("reverseUniqby")?s=d_(e,function(p){return G(p.path)+"-"+p.annotationType}):(e.reverse(),s=c_(e,function(p){return G(p.path)+"-"+p.annotationType}),s.reverse()),U().stop(r),s}}for(var u=new Map,l=0;l<e.length;){var f=e[l],c=G(f.path)+"-"+f.annotationType,d=u.get(c);if(d!==void 0){if(f.ancestorType){var h;(h=e[d].annotations).push.apply(h,(0,Hv.default)(f.annotations))}else e[d]=f;e.splice(l,1)}else u.set(c,l),l++}return U().stop(r),e}},{key:"generateAnnotationAddOps",value:function(e,r,t,a,s){if(a.length>0){var u=new we({parentPath:e,items:a});r&&(u.parentRevId=r),t&&(u.isTriggeredBySyncDelta=t),s.push(u),this.session.stats.annotationsAdded+=a.length}}},{key:"generateAnnotationUpdateOps",value:function(e,r,t,a,s){if(a.length>0){var u=new Ne({parentPath:e,items:a});r&&(u.parentRevId=r),t&&(u.isTriggeredBySyncDelta=t),s.push(u),this.session.stats.annotationsUpdated+=a.length}}},{key:"generateAnnotationDeleteOps",value:function(e,r,t,a,s,u){if(s.length>0){var l=new Array(s.length),f=0,c=function(k){l[f++]={id:k.id,parentPath:r,contextId:k.contextId},v.debug(529093135,y.CoreDefault,function(){return"Deleting annotation "+k.id+" (type: "+m.getTypeNameFor(k.body)+", workflow: "+e.id+")"})};for(var d of s)c(d);var h=new Fe({parentPath:r,items:l});t&&(h.parentRevId=t),a&&(h.isTriggeredBySyncDelta=a),u.push(h),this.session.stats.annotationsDeleted+=l.length}}}]),n}();g();var Qv=w(Ie());var p_=[fe.CursorUpdate,fe.FormattingUpdate,fe.OtherNonContentUpdate];function jv(n,o,e){var r=new D({operationName:"ApplyTextTileDeltaForLocalWorkflows",dimension0:"0",success:!0}).start();try{if(!o){r.success=!1,r.resultDescription="Unable to apply text tile delta, parent tile is undefined",v.info(538798173,y.CoreDefault,r.stop());return}if(m.getTypeNameFor(o)!==Je.getTypeName()){r.success=!1,r.resultDescription="Unable to apply text tile delta, parent tile is not proper type: expected "+Zn.getTypeName()+", received "+m.getTypeNameFor(o),v.info(538798174,y.CoreDefault,r.stop());return}var t=o,a=n,s=t.content,u="";if(a.position===void 0||a.position<0){r.success=!1,r.resultDescription="Unable to apply text tile delta, invalid text tile position",v.info(538798175,y.CoreDefault,r.stop());return}switch(a.deltaType){case fe.Add:a.position<s.length?u=""+s.slice(0,a.position)+a.content+s.slice(a.position,s.length):u=s+a.content;break;case fe.Update:!a.content&&a.unit===Oe.Sentence&&(r.dimension0="1"),u=""+s.slice(0,a.position)+a.content+s.slice(a.position+(a.length||0),s.length);break;case fe.Delete:u=""+s.slice(0,a.position)+s.slice(a.position+(a.length||0),s.length)}return v.info(538837071,y.CoreDefault,r.stop()),new Je({content:u})}catch(l){r.success=!1,r.resultDescription="Error applying text tile delta: "+l,v.info(538798176,y.CoreDefault,r.stop());return}}function Jv(n,o,e){var r,t,a,s,u,l,f,c,d=new D({operationName:"ApplyFormattedTextTileDeltaForLocalWorkflows",dimension0:"0",success:!0}).start();d.clientFlights=e;try{if(!o){d.success=!1,d.resultDescription="Unable to apply formatted text tile delta, parent tile is undefined",v.info(538798177,y.CoreDefault,d.stop());return}if(m.getTypeNameFor(o)!==nt.getTypeName()){d.success=!1,d.resultDescription="Unable to apply formatted text tile delta, parent tile is not proper type: expected "+nt.getTypeName()+", received "+m.getTypeNameFor(o),v.info(538798178,y.CoreDefault,d.stop());return}var h=o,p=n,k=h.content,S="";if((p.position===void 0||p.position<0)&&!dc(p.deltaType)){d.success=!1,d.resultDescription="Unable to apply formatted text tile delta, invalid text tile position",v.info(538798179,y.CoreDefault,d.stop());return}else if(p.content===void 0&&!dc(p.deltaType)){d.success=!1,d.resultDescription="Unable to apply formatted text tile delta, non-delete, non-formatting, non-other-non-content-update and non-cursor-update operation without content defined",v.info(538798208,y.CoreDefault,d.stop());return}if(p.deltaType===fe.Add&&p.length!==0?v.info(538798209,y.CoreDefault,new D({operationName:"ApplyDeltaChecks",resultDescription:"Received formatted text tile delta add operation with delta length, expected length 0",success:!0})):dc(p.deltaType)&&p.content!==void 0&&v.info(538798210,y.CoreDefault,new D({operationName:"ApplyDeltaChecks",resultDescription:"Received formatted text tile delta delete or non-content related operation with content defined, expected undefined",success:!0})),Kv(p.deltaType)){if(p.deltaType===fe.CursorUpdate)return new nt(Object.assign(Object.assign({},h),{ipPosition:(f=p.cursorData)===null||f===void 0?void 0:f.ipPosition,isColdIp:(c=p.cursorData)===null||c===void 0?void 0:c.isColdIp}));if(p.deltaType===fe.FormattingUpdate)return new nt(Object.assign(Object.assign({},h),{formattedRanges:p.formattedRanges}));if(p.deltaType===fe.OtherNonContentUpdate){var I,_={};for(I in p.otherNonContentData)_[I]=p.otherNonContentData[I];return new nt(Object.assign(Object.assign({},h),_))}}else{var C=h_(h.formattedRanges,p.deltaType,p.position),T=h.formattedRanges?(0,Qv.default)(h.formattedRanges):[],x=C?T.indexOf(C):-1;x!==-1&&(p.position+(p.length||0)>C.start+C.length?C.length=p.position+((r=p.content)!==null&&r!==void 0?r:"").length-C.start:C.length+=((t=p.content)!==null&&t!==void 0?t:"").length-(p.length||0),T[x]=C);var A=h.ipPosition;switch(p.deltaType){case fe.Add:p.position<k.length?S=""+k.slice(0,p.position)+p.content+k.slice(p.position,k.length):S=k+p.content,A=p.position+p.length;break;case fe.Update:!p.content&&p.unit===Oe.Sentence&&(d.dimension0="1"),S=""+k.slice(0,p.position)+p.content+k.slice(p.position+((a=p.length)!==null&&a!==void 0?a:0),k.length),A=p.position+p.content.length;break;case fe.Delete:S=""+k.slice(0,p.position)+k.slice(p.position+((s=p.length)!==null&&s!==void 0?s:0),k.length),A=p.position;break}for(var b of T.slice(x+1))b.start<p.position||(p.position+(p.length||0)>b.start?(b.length=b.start+b.length-(p.position+(p.length||0)),b.start=p.position+((u=p.content)!==null&&u!==void 0?u:"").length):b.start+=((l=p.content)!==null&&l!==void 0?l:"").length-(p.length||0));T=T.filter(function(M){return M.length>0});var E=new nt(Object.assign(Object.assign({},h),{ipPosition:A,content:S,formattedRanges:T,queryRange:p.queryRange}));return v.info(538837073,y.CoreDefault,d.stop()),E}return}catch(M){d.success=!1,d.resultDescription="Error applying formatted text tile delta: "+M,v.info(538798211,y.CoreDefault,d.stop());return}}function h_(n,o,e){var r=new D({operationName:"FindRangeForDelta",success:!0});if(r.start(),!n){r.resultDescription="No formatted ranges found within the tile, skipping.",v.info(538798212,y.CoreDefault,r.stop());return}if(o===fe.Add){var t=n.find(function(s){return s.start===e&&s.length===0});if(t)return r.resultDescription="Found a zero-length formatted range for add operation with start "+t.start+".",v.info(538798213,y.CoreDefault,r.stop()),t;e=Math.max(e-1,0)}var a=n.find(function(s){return s.length===0?s.start===e:s.start<=e&&e<s.start+s.length});return a?(r.resultDescription="Updating formatted range for operation with start: "+a.start+" and length: "+a.length,v.info(538798214,y.CoreDefault,r.stop())):(r.resultDescription="Unable to find formatted range for operation at position "+e+", skipping.",v.info(538798215,y.CoreDefault,r.stop())),a}function Kv(n){return p_.indexOf(n)!==-1}function dc(n){return Kv(n)||fe.Delete===n}g();var $v=w(W()),Xv=w(B());g();var In=function(o,e,r){var t=o.get(e);return t||(t=r(),o.set(e,t)),t},Yi=function(o){return{id:o.id,kind:o.kind,visibility:o.visibility,collectionScopeType:o.collectionScopeType,inputTypes:o.inputTypes,outputTypes:o.outputTypes,correlatedSignals:o.correlatedSignals}},vr=function(o){return Array.isArray(o.correlatedSignals)&&o.correlatedSignals.length>0};var Zi=function(o,e){return o==null||e==null?!1:o.length>0&&(o===e||e.indexOf(o)===0&&e.charAt(o.length)===".")},Kt=function(o){return Array.isArray(o.triggerSignals)&&o.triggerSignals.length>0},ea=function(o){var e,r;return(r=(e=o.triggerConditions)===null||e===void 0?void 0:e.includes(Lt.NonExclusiveTriggerSignals))!==null&&r!==void 0?r:!1};var cs=function(){function n(){(0,$v.default)(this,n),this.workflowDefByWorkflowAndContextId=new Map,this.workflowDefByWorkflow=new Map}return(0,Xv.default)(n,[{key:"mergeWorkflowDefinition",value:function(e,r,t){if(t){var a=In(this.workflowDefByWorkflowAndContextId,e.id,function(){return new Map});a.set(t,n.mergeDefinitions(e,a.get(t),r))}else this.workflowDefByWorkflow.set(e.id,n.mergeDefinitions(e,this.workflowDefByWorkflow.get(e.id),r))}},{key:"getWorkflowDefinition",value:function(e,r){var t,a;return r&&(a=(t=this.workflowDefByWorkflowAndContextId.get(e.id))===null||t===void 0?void 0:t.get(r)),a||(a=this.workflowDefByWorkflow.get(e.id)),a||(a=e),a}},{key:"deleteWorkflowDefinition",value:function(e,r){var t=this.workflowDefByWorkflowAndContextId.get(e.id);t&&(t.delete(r),t.size===0&&this.workflowDefByWorkflowAndContextId.delete(e.id))}}],[{key:"mergeDefinitions",value:function(e,r,t){return Object.assign(Object.assign(Object.assign({},e),r),t)}}]),n}();g();var ds=function(o,e){var r;return!(e.maxEventAge&&Date.now()-o.timestamp>e.maxEventAge||e.includedTypes&&!e.includedTypes.includes(o.type)||!((r=e.excludedTypes)===null||r===void 0)&&r.includes(o.type))};g();var so=w(Ye()),uo=w(Ie()),iy=w(W()),ay=w(B());g();g();var Yv=w(W()),Zv=w(B());var ey=function(){function n(){(0,Yv.default)(this,n)}return(0,Zv.default)(n,[{key:"generateDelta",value:function(e,r,t){var a=m.getTypeNameFor(e),s=m.getTypeNameFor(r);if(a!==s)throw new Error("Tile types must be same. NewTile type: '"+m.getTypeNameFor(e)+"', OldTile type '"+m.getTypeNameFor(r)+"'.");var u=new Set(t==null?void 0:t.changes);return(a===Je.getTypeName()||m.getBaseTypesFor(e).includes(Je.getTypeName()))&&this.setChangesForTextTile(e,r,u),(a===nt.getTypeName()||m.getBaseTypesFor(e).includes(nt.getTypeName()))&&this.setChangesForFormattedTextTile(e,r,u),new Bn({changes:Array.from(u)})}},{key:"setChangesForTextTile",value:function(e,r,t){e.content!==r.content&&t.add(ir.ContentChanged),r.content||t.add(ir.ContentWasEmpty)}},{key:"setChangesForFormattedTextTile",value:function(e,r,t){var a=this.areFormattedTextTilesDifferent(e,r);a&&t.add(ir.FormattingChanged),(r.isInsideTable||r.isInsideTOC)&&t.add(ir.ContentWasInsideOfTheTable)}},{key:"areFormattedTextTilesDifferent",value:function(e,r){return e.indentation!==r.indentation||e.rightIndentation!==r.rightIndentation||e.outlineLevel!==r.outlineLevel||e.listType!==r.listType||e.alignment!==r.alignment||e.isInsideTable!==r.isInsideTable||e.isInsideTOC!==r.isInsideTOC||e.spacingBeforeParagraph!==r.spacingBeforeParagraph||e.spacingAfterParagraph!==r.spacingAfterParagraph||e.lineSpacing!==r.lineSpacing||e.listId!==r.listId||e.bulletAndNumberFontSize!==r.bulletAndNumberFontSize||e.bulletAndNumberFontFamily!==r.bulletAndNumberFontFamily||e.specialIndentType!==r.specialIndentType||e.specialIndentBy!==r.specialIndentBy||e.fontKerning!==r.fontKerning||this.areFormattedRangesChanged(e.formattedRanges,r.formattedRanges)}},{key:"areFormattedRangesChanged",value:function(e,r){var t,a,s=(t=e==null?void 0:e.length)!==null&&t!==void 0?t:0,u=(a=r==null?void 0:r.length)!==null&&a!==void 0?a:0;if(s!==u)return!0;for(var l=0;l<s;l++)if(this.areFormattedRangesDifferent(e[l],r[l]))return!0;return!1}},{key:"areFormattedRangesDifferent",value:function(e,r){return!e||!r?!r!=!e:e.isDeleted!==r.isDeleted||e.fontFamily!==r.fontFamily||e.fontWeight!==r.fontWeight||e.fontSize!==r.fontSize||e.italic!==r.italic||e.underline!==r.underline||e.capitalization!==r.capitalization||e.color!==r.color||e.highlightColor!==r.highlightColor||e.styleName!==r.styleName||e.isFollowUp!==r.isFollowUp||e.link!==r.link||e.isReference!==r.isReference||e.languageId!==r.languageId||e.objectType!==r.objectType}}]),n}();var ty=function(){return new Map([[Bn.getTypeName(),new ey]])};g();var ny=w(W()),ry=w(B());var oy=function(){function n(){(0,ny.default)(this,n),this.changesByInputKey=new Map,this.changesByWorkflowExecutionKey=new Map}return(0,ry.default)(n,[{key:"removeInputChanges",value:function(e,r){var t=this.changesByInputKey.get(e);if(t===void 0)throw new Error("InputKey '"+e+"' not found.");t.delete(r),t.size===0&&this.changesByInputKey.delete(e);var a=this.changesByWorkflowExecutionKey.get(r);if(a===void 0)throw new Error("WorkflowExecutionKey '"+r+"' not found.");a.delete(e),a.size===0&&this.changesByWorkflowExecutionKey.delete(r)}},{key:"getInputChanges",value:function(e,r){var t=this.changesByInputKey.get(e),a=t==null?void 0:t.get(r);return a}},{key:"getInputChangesByWorkflowExecutionKey",value:function(e){var r=this.changesByWorkflowExecutionKey.get(e);return r?Array.from(r):void 0}},{key:"getInputChangesByInputKey",value:function(e){var r=this.changesByInputKey.get(e);return r?Array.from(r):void 0}},{key:"setInputChangesByInputKey",value:function(e,r){var t=In(this.changesByInputKey,e,function(){return new Map});for(var a of t.keys())t.set(a,r),In(this.changesByWorkflowExecutionKey,a,function(){return new Map}).set(e,r);return Array.from(t.keys())}},{key:"setInputChanges",value:function(e,r,t){In(this.changesByInputKey,e,function(){return new Map}).set(r,t),In(this.changesByWorkflowExecutionKey,r,function(){return new Map}).set(e,t)}}]),n}();var sy=function(){function n(o,e){(0,iy.default)(this,n),this.sessionCache=o,this.inputChangesTracker=e!=null?e:new oy,this.itemDeltaGenerators=ty()}return(0,ay.default)(n,[{key:"getChanges",value:function(e,r){var t=this,a=G([e].concat((0,uo.default)(r))),s=this.inputChangesTracker.getInputChangesByWorkflowExecutionKey(a);if(s){var u=s.map(function(l){var f=(0,so.default)(l,2),c=f[0],d=f[1],h=Yn(c),p=h.pop();return t.inputChangesTracker.setInputChanges(c,a,Object.assign(Object.assign({},d),{canReset:!0})),{id:p,parentPath:h,delta:d.delta,op:d.op}});return u}}},{key:"applyChanges",value:function(e){var r=this,t=new D({operationName:"InputChangesManagerApplyChanges",success:!0}).start();e.forEach(function(a){var s=m.getTypeNameFor(a);switch(s){case Ne.getTypeName():r.markItemsAsModified(a.items,a.parentPath);break;case Fe.getTypeName():r.markItemsAsDeleted(a.items,a.parentPath);break;default:break}}),t.stop().durationMs>10&&v.info(527523975,y.CoreDefault,t)}},{key:"setWorkflowInputs",value:function(e,r,t){var a=this,s,u=G([r].concat((0,uo.default)(t))),l=(s=this.inputChangesTracker.getInputChangesByWorkflowExecutionKey(u))!==null&&s!==void 0?s:[];l.forEach(function(x){var A=(0,so.default)(x,2),b=A[0],E=A[1];return a.inputChangesTracker.removeInputChanges(b,u)});for(var f=0,c=0;f<e.length||c<l.length;)if(l[c]!==void 0&&e[f]!==void 0){var d=(0,so.default)(l[c],2),h=d[0],p=d[1],k=G(e[f].path);(p==null?void 0:p.op)===ct.Deleted?(this.inputChangesTracker.setInputChanges(h,u,p),c++):h===k?(this.inputChangesTracker.setInputChanges(h,u,p),c++,f++):(this.inputChangesTracker.setInputChanges(k,u,{op:ct.Added,deltaType:e[f].deltaType,canReset:!0}),f++)}else if(l[c]!==void 0){var S=(0,so.default)(l[c],2),C=S[0],T=S[1];this.inputChangesTracker.setInputChanges(C,u,T),c++}else this.inputChangesTracker.setInputChanges(G(e[f].path),u,{op:ct.Added,deltaType:e[f].deltaType,canReset:!0}),f++}},{key:"resetChanges",value:function(e,r){var t=this,a,s=G([e].concat((0,uo.default)(r)));(a=this.inputChangesTracker.getInputChangesByWorkflowExecutionKey(s))===null||a===void 0||a.forEach(function(u){var l=(0,so.default)(u,2),f=l[0],c=l[1];if(c.canReset)switch(c.op){case ct.Deleted:t.inputChangesTracker.removeInputChanges(f,s);break;case ct.Added:case ct.Updated:t.inputChangesTracker.setInputChanges(f,s,{op:ct.None,deltaType:c.deltaType,canReset:!0});break;default:break}})}},{key:"markItemsAsModified",value:function(e,r){var t=this;e.forEach(function(a){var s=G([].concat((0,uo.default)(r),[a.id])),u=t.inputChangesTracker.getInputChangesByInputKey(s),l=t.memoizeGetItem([].concat((0,uo.default)(r),[a.id]));u==null||u.forEach(function(f){var c=(0,so.default)(f,2),d=c[0],h=c[1];if(h.op===ct.None||h.op===ct.Updated){var p=t.itemDeltaGenerators.get(h.deltaType);if(p){var k=l();h.delta=p.generateDelta(a.body,k.body,h.delta)}h.op=ct.Updated}t.inputChangesTracker.setInputChanges(s,d,{op:h.op,deltaType:h.deltaType,delta:h.delta,canReset:!1})})})}},{key:"memoizeGetItem",value:function(e){var r=this,t=void 0,a=!1;return function(){return a||(t=r.sessionCache.getItem(e),a=!0),t}}},{key:"markItemsAsDeleted",value:function(e,r){var t=this;e.forEach(function(a){t.inputChangesTracker.setInputChangesByInputKey(G([].concat((0,uo.default)(r),[a.id])),{op:ct.Deleted,canReset:!1})})}}]),n}();g();var uy=w(W()),ly=w(B());var ta=new Set([we.getTypeName(),Ne.getTypeName(),Ze.getTypeName(),Ot.getTypeName()]),Nt=function(){function n(o,e){(0,uy.default)(this,n),this.nextId=1,this.runtimeKind=o,this.workflowGraph=e}return(0,ly.default)(n,[{key:"applyContextIdOnOperations",value:function(e){for(var r of e){var t=m.getTypeNameFor(r);if(this.isSupportedOperation(t))for(var a of r.items){if(!a.contextId){a.contextId=this.addNewContextId();continue}if(a.source&&this.workflowGraph.getWorkflow(a.source,!1)){a.contextId=this.addNewContextId(a.contextId);continue}this.tryLogMessage(new D({operationName:"ApplyContextIdOnOperations",success:!0}).start(),"Item with a contextId but without a workflow source atribute")}}}},{key:"addNewContextId",value:function(e){var r=""+this.runtimeKind+this.nextId++;return e?e+"."+r:r}},{key:"isSupportedOperation",value:function(e){return ta.has(e)}},{key:"tryLogMessage",value:function(e,r){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;e&&(e.success=t,e.resultDescription=r,v.verbose(527308633,y.CoreDefault,e.stop()))}}],[{key:"isParentContextId",value:function(e,r){return Zi(e,r)}}]),n}(),ve;(function(n){n[n.Idle=1]="Idle",n[n.Pending=2]="Pending",n[n.Running=3]="Running",n[n.Executed=4]="Executed"})(ve||(ve={}));g();var hc=w(qe()),fy=w(Ge()),pc=w(De()),cy=w(Ye()),ps=w(W()),hs=w(B());function dy(n){var o=g_();return function(){var r=(0,pc.default)(n),t;if(o){var a=(0,pc.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,fy.default)(this,t)}}function g_(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var py=function(){function n(o){(0,ps.default)(this,n);var e=this.parseLambda(o),r=(0,cy.default)(e,3),t=r[0],a=r[1],s=r[2],u=s?a:"return "+a;this.prefilterFunction=new Function(t,u)}return(0,hs.default)(n,[{key:"parseLambda",value:function(e){var r=e.indexOf("=>");if(r<0)throw new Error("Prefilter lambda does not contain '=>' operator.");var t=e.substring(0,r).trim();if(t==="")throw new Error("Prefilter lambda input is empty.");t[0]==="("&&t[t.length-1]===")"&&(t=t.substring(1,t.length-1).trim());var a=e.substring(r+2,e.length).trim();if(a==="")throw new Error("Prefilter lambda body is empty.");var s=a[0]==="{";return[t,a,s]}}]),n}(),hy=function(n){(0,hc.default)(e,n);var o=dy(e);function e(r){return(0,ps.default)(this,e),o.call(this,r)}return(0,hs.default)(e,[{key:"evaluate",value:function(t){return this.prefilterFunction(t.scopeItem.body)}}]),e}(py),gy=function(n){(0,hc.default)(e,n);var o=dy(e);function e(r){return(0,ps.default)(this,e),o.call(this,r)}return(0,hs.default)(e,[{key:"evaluate",value:function(t){var a;if(((a=t.scopeItem.deltas)===null||a===void 0?void 0:a.length)>0){for(var s of t.scopeItem.deltas)if(this.prefilterFunction(s))return!0;return!1}else return this.prefilterFunction(t.scopeItem.delta)}}]),e}(py);g();var ms=w(Ie()),mc=w(W()),vc=w(B());var m_=new F("prefiltersEvaluationMinDurationInMs",1),v_=new F("disabledPrefiltersForWorkflows",[]);function gc(n){return{shouldExecuteWorkflow:n}}var gs=Symbol("lambdaEvaluator"),my=Symbol("isDisabled"),vy=function(){function n(o){(0,mc.default)(this,n),this.overwrittenSettingsMap=o}return(0,vc.default)(n,[{key:"getValue",value:function(e,r){var t;return this.settings.has(e)?t=this.settings.get(e):(t=new F(e,r),this.settings.set(e,t)),t.getValue()}},{key:"settings",get:function(){var e;return(e=this.overwrittenSettingsMap)!==null&&e!==void 0?e:n.settingsMap}}]),n}();vy.settingsMap=new Map;var Dt;(function(n){n[n.All=0]="All",n[n.WithActionDefinition=1]="WithActionDefinition",n[n.WithoutActionDefinition=2]="WithoutActionDefinition"})(Dt||(Dt={}));var yy=function(){function n(o){(0,mc.default)(this,n),this.workflowSettings=o!=null?o:new vy}return(0,vc.default)(n,[{key:"evaluateWorkflowPrefilters",value:function(e,r){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Dt.All;if(e.prefilters===void 0||e.prefilters.length===0||v_.getValue().includes(e.id))return gc(!0);var a,s=new D({operationName:"EvaluateWorkflowPrefilters",resourceId:e.id,success:!0}).start();U().startSync(j.EvaulatePrefilters);try{for(a of e.prefilters)if(a!==void 0&&!(t===Dt.WithActionDefinition&&!a.action)&&!(t===Dt.WithoutActionDefinition&&a.action)){var u=this.evaluate(e,a,r);if(!u){var l={shouldExecuteWorkflow:!1,prefilterActionResults:this.createWorkflowResult(a.action,r)};return this.logOperation(s,a),l}}return this.logOperation(s),gc(!0)}catch(f){return this.logOperation(s,a,f),gc(!0)}}},{key:"evaluate",value:function(e,r,t){switch(r.type){case en.Input:case en.Delta:return this.evaluateLambdaPrefilter(e,r,t);case en.MaxInputCount:return this.evaluateMaxCountPrefilter(r,t);case en.UILanguage:return this.evaluateSupportedLanguagesPrefilter(r,t);default:throw Error("Unknown prefilter type "+r.type+".")}}},{key:"evaluateMaxCountPrefilter",value:function(e,r){var t;if(e.maxCount===void 0&&e.setting===void 0)throw new Error("Prefilter "+e.type+" is invalid.");if(e.maxCount!==void 0&&e.setting!==void 0)throw new Error("Prefilter "+e.type+" is invalid.");var a=(t=e.maxCount)!==null&&t!==void 0?t:this.workflowSettings.getValue(e.setting.name,e.setting.defaultValue);return r.inputItems.length<=a}},{key:"evaluateSupportedLanguagesPrefilter",value:function(e,r){var t;if((e.languages===void 0||e.languages.length==0)&&e.setting===void 0)throw new Error("Prefilter "+e.type+" is invalid.");if(e.languages!==void 0&&e.setting!==void 0)throw new Error("Prefilter "+e.type+" is invalid.");var a=(t=e.languages)!==null&&t!==void 0?t:this.workflowSettings.getValue(e.setting.name,e.setting.defaultValue);return a.some(function(s){var u,l;return s.toLowerCase()===((l=(u=r.clientMetadata)===null||u===void 0?void 0:u.uiLanguage)===null||l===void 0?void 0:l.toLowerCase())})}},{key:"evaluateLambdaPrefilter",value:function(e,r,t){try{if(r[my]===!0)return!0;var a=this.getLambdaEvaluator(r,e.kind);return a.evaluate(t)}catch(s){return r[my]=!0,v.error(537781762,y.CoreDefault,function(){return"Workflow "+e.id+" "+r.type+" prefilter error "+s.message+". Lambda: "+r.predicateLambda.substring(0,20)+"...Stack: "+s.stack+"."}),!0}}},{key:"getLambdaEvaluator",value:function(e,r){if(e[gs])return e[gs];this.ensureWorkflowKindIsSupported(r,e.type,[q.SingleItem]);var t=e.predicateLambda;switch(e.type){case en.Input:return e[gs]=new hy(t);case en.Delta:return e[gs]=new gy(t);default:throw Error("Unknown lambda prefilter type "+e.type+".")}}},{key:"createWorkflowResult",value:function(e,r){if(e!==void 0){var t={scopeItemPath:[].concat((0,ms.default)(r.scopeItem.parentPath),[r.scopeItem.id]),scopeItemRevId:r.scopeItem.revId,annotationQueue:void 0};switch(e.type){case ko.SetPredefinedAnnotation:{var a=e,s=this.createPredefinedAnnotationEntry(a,r);t.annotationQueue=[s];break}case ko.ClearAnnotations:{var u=e;t.annotationQueue=this.createClearAnnotationsQueue(u,r);break}default:throw new Error("Prefilter action type "+e.type+" is not supported.")}return[t]}}},{key:"createPredefinedAnnotationEntry",value:function(e,r){return{path:[].concat((0,ms.default)(r.scopeItem.parentPath),[r.scopeItem.id]),revId:r.scopeItem.revId,annotationType:e.annotationType,annotations:[e.annotation]}}},{key:"createClearAnnotationsQueue",value:function(e,r){var t=[];for(var a of e.annotationTypes)t.push({path:[].concat((0,ms.default)(r.scopeItem.parentPath),[r.scopeItem.id]),revId:r.scopeItem.revId,annotationType:a,annotations:[]});return t}},{key:"logOperation",value:function(e,r,t){e.stop(),U().stop(j.EvaulatePrefilters);var a=function(){var u;if(!t&&r){e.success=!0,e.dimension0=(!1).toString(),e.dimension1=(u=r.action)===null||u===void 0?void 0:u.type;var l=r.action?r.action.type+" action":"no action";e.resultDescription=r.type+" prefilter triggered "+l+"."}else!t&&!r?(e.success=!0,e.dimension0=(!0).toString(),e.resultDescription="All prefilters evaluated to true."):t&&r?(e.success=!1,e.dimension0=(!0).toString(),e.resultDescription=r.type+" prefilter error: "+t.message+", stack: "+t.stack+"."):(e.success=!1,e.dimension0=(!0).toString(),e.resultDescription="Error: "+t.message+", stack: "+t.stack+".");return e};!t&&e.durationMs<m_.getValue()?v.debug(525448961,y.CoreDefault,a):v.info(537781763,y.CoreDefault,a)}},{key:"ensureWorkflowKindIsSupported",value:function(e,r,t){if(!t.includes(e))throw new Error(r+" prefilter is not supported for "+q[e]+" workflow.")}}]),n}();g();var Oo=w(Ye()),It=w(Ie()),Nk=w(W()),Dk=w(B()),Qe=w(Dr()),Wk=w(qe()),Bk=w(Ge()),Lc=w(De());var Pk=w(Jn());g();var Iy=w(Ye()),Cc=w(Ie()),_y=w(W()),Ay=w(B()),by=w(qe()),My=w(Ge()),xc=w(De());var Tc=w(Ci());g();var wy=w(Dr()),Sy=w(qe()),Cy=w(Ge()),yc=w(De()),wc=w(W()),Sc=w(B());var xy=w(Jn());function y_(n){var o=k_();return function(){var r=(0,yc.default)(n),t;if(o){var a=(0,yc.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,Cy.default)(this,t)}}function k_(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var w_=new F("sequencerApplyNextSequenceLogMinDurationInMs",30),S_=new F("sequencerTimeoutWhenNotWaitingSeedCompleteInMs",5e3),C_=new F("sequencerTimeoutSeedCompleteInMs",3e5),x_=new F("sequencerTimeoutWhenWaitingOnSeedCompleteInMs",3e4),T_=new F("sequencerTimeoutWhenWaitingOnGroupCompleteInMs",3e4),ky=new F("sequencerMaxQueueLength",1e3),I_=new F("sequencerAcceptedTimeout",100),__=function(){function n(o,e,r){(0,wc.default)(this,n),this.cc=et(),this.done=r,this.syncMessage=o,this.healthEvent=e,L("sequencerTryInlineSyncResponse")?this.timeout=setTimeout(this.onTimeout.bind(this),I_.getValue()):this.onTimeout()}return(0,Sc.default)(n,[{key:"onTimeout",value:function(){this.done(void 0,new zt),this.timeout=void 0}},{key:"onCompleted",value:function(e,r){var t=this;Re(function(){t.timeout?(clearTimeout(t.timeout),t.timeout=void 0,t.done(e,r)):t.healthEvent.dimension0="asynchronous",t.healthEvent.success=!e||e.error===kc,(e==null?void 0:e.error)===kc&&(t.healthEvent.message+="; Message not applied as session is closing."),t.healthEvent.success||(t.healthEvent.setReason(Y.Core),t.healthEvent.message+=" "+e.error),v.info(537002506,y.CoreDefault,t.healthEvent.stop())},this.cc)}}]),n}(),Wt;(function(n){n[n.None=0]="None",n[n.Sequenced=1]="Sequenced",n[n.Reconnect=2]="Reconnect",n[n.Reseeding=3]="Reseeding",n[n.LateReseeding=4]="LateReseeding"})(Wt||(Wt={}));var er;(function(n){n[n.OK=0]="OK",n[n.AbandonSyncMessage=1]="AbandonSyncMessage",n[n.StopPreviousGroup=2]="StopPreviousGroup"})(er||(er={}));var kc="Session is closing.",Ty=function(n){(0,Sy.default)(e,n);var o=y_(e);function e(r,t){var a;return(0,wc.default)(this,e),a=o.call(this),a.prevSeq=-1,a.groupCount=0,a.groupSize=0,a.groupId=void 0,a.seedErrors=0,a.seedInterruptTimeInMs=0,a.fullFileSeedingComplete=!1,a.isAnySequenceApplied=!1,a.cache=new Cn,a.applyMessageCallback=r,a.boundOnTimeout=a.onTimeout.bind((0,wy.default)(a)),a.seedSessionHealthEvent=new _e({sessionHealthEventName:"SessionFullFileSeeding",source:pe.Core,reason:Y.Unknown,impact:he.MissingInput,success:!1,message:"",metricCount:!1}),a.isSeedingTriggeredBySessionCreation()&&a.startSeedingDurationMeasurement(),a.stats={seedMode:t?Wt.Reconnect:Wt.None,seedSuccess:!1,seedItems:0,seedGroupSize:0,seedDurationMs:0,syncMessageCount:0,syncMessagesOutOfSequence:0,syncMessagesAbandoned:0,syncMessagesIgnored:0,syncMessageQueueLimitReached:!1},a}return(0,Sc.default)(e,[{key:"setClientMetadata",value:function(t){this.seedSessionHealthEvent.setClientMetadata(t)}},{key:"onSyncMessage",value:function(t,a){var s=this,u=new _e({sessionHealthEventName:"QueueAndApplySyncMessage",source:pe.Core,reason:Y.Unknown,impact:he.MissingInput,success:!1,message:"seq="+t.seq,resourceId:t.seq<=0?"Seeding":"NonSeeding",dimension0:"synchronous"}).start(),l=a;if(a=function(c,d){var h=U(),p=h.startSync(j.SyncMessageSequencerSendResponse);l(c,d),h.stop(p)},this.updateGroupParameters(t),v.debug(537002498,y.CoreDefault,function(){return"SyncMessageSequencer.onSyncMessage: SyncMessage received. seq "+t.seq+", "+s.groupParametersToString(t)+", operations count = "+t.ops.length}),this.stats.syncMessageCount++,t.seq===-1){a(new X({messageId:t.messageId,error:Vt.UnsupportedSyncMessage}));return}t.seq===0&&this.prevSeq===-1?this.handleSeedMessage(t,u,a):this.handleNonSeedMessage(t,u,a)}},{key:"wasSomethingApplied",value:function(){return this.isAnySequenceApplied}},{key:"getStats",value:function(){return this.stats}},{key:"onClose",value:function(){var t=this;this.seedSessionLogTimeout?this.logSpentTimeForFullFileSeeding():!this.isSeedingTriggeredBySessionCreation()&&!this.isSeedingStarted()&&this.logSpentTimeForFullFileSeeding();var a=function(){var l=t.cache.get(s);Re(function(){l.onCompleted(new X({error:kc}))},l.cc)};for(var s of this.cache.keys())a();this.cache.clear()}},{key:"isSeedingTriggeredBySessionCreation",value:function(){return!(this.seedSessionHealthEvent.clientAppName==="Word"&&(this.seedSessionHealthEvent.clientAppPlatform==="Win32"||this.seedSessionHealthEvent.clientAppPlatform==="Mac"))}},{key:"startSeedingDurationMeasurement",value:function(){var t=this;this.seedSessionHealthEvent.start(),this.seedSessionLogTimeout=setTimeout(function(){t.logSpentTimeForFullFileSeeding(!0)},C_.getValue()),this.seedSessionLogTimeout.unref&&this.seedSessionLogTimeout.unref()}},{key:"isSeedingStarted",value:function(){return!(this.stats.seedMode===Wt.None||this.stats.seedMode===Wt.Reconnect)}},{key:"handleSeedMessage",value:function(t,a,s){var u=this;try{if(this.fullFileSeedingComplete){a.setReason(Y.Client),a.message+=" Received seq=0 after seeding was finished",v.error(537002501,y.CoreDefault,"SyncMessageSequencer.handleSeedMessage: Applying SyncMessage with seq 0 after seeding is already complete"),s(new X({messageId:t.messageId,error:Vt.UnexpectedSeedMessage}));return}!this.isSeedingTriggeredBySessionCreation()&&!this.isSeedingStarted()&&this.startSeedingDurationMeasurement(),this.stats.seedMode===Wt.Reconnect?this.stats.seedMode=Wt.Reseeding:this.stats.seedMode===Wt.None&&(this.stats.seedMode=Wt.Sequenced),this.emit("seedMessageReceived"),(!t.groupId||this.groupCount===this.groupSize)&&this.emit("lastSeedMessageReceived"),L("syncMessageSequencerSeedErrors")||s(void 0,new zt),this.applySyncMessage(t,function(l,f){l?(u.seedSessionHealthEvent.setReason(Y.Core),a.setReason(Y.Core),a.message+=" Applying message failed "+l.error,u.seedErrors++):a.success=!0,L("syncMessageSequencerSeedErrors")&&s(l,f)}),t.groupId?this.updateSeedGroup(t):this.completeSeeding()}catch(l){throw a.setReason(Y.Core),a.success=!1,a.message+=" Unexpected error "+(l==null?void 0:l.stack),l}finally{v.info(537002502,y.CoreDefault,a.stop())}}},{key:"validateSyncMessage",value:function(t,a,s){if(this.cache.size()>=ky.getValue()){this.stats.syncMessageQueueLimitReached=!0;var u="SyncMessageSequencer.handleNonSeedMessage: Number of queued messages reached its limit of "+ky.getValue()+" messages. (ignoring)";return this.abandonMessage(a,s,u,Y.Core,ze.warn),er.AbandonSyncMessage}else if(t.seq!==0&&t.seq<=this.prevSeq){this.stats.syncMessagesIgnored++;var l="SyncMessageSequencer.handleNonSeedMessage: SyncMessage arrived too late or is a duplicate (ignoring).";this.stats.seedMode===Wt.Reconnect&&t.seq===0&&(this.stats.seedMode=Wt.LateReseeding);var f="SyncMessageSequencer.handleNonSeedMessage: SyncMessage arrived too late or is a duplicate (ignoring). SyncMessage.seq "+t.seq+", prevSeq "+this.prevSeq+", "+this.groupParametersToString(t);return this.abandonMessage(a,s,l,Y.Network,ze.info,f),er.AbandonSyncMessage}else if(this.groupId&&t.groupId){var c=Number.parseInt(this.groupId,10),d=Number.parseInt(t.groupId,10);if(d>0&&d>c)return er.StopPreviousGroup;if(this.groupId!==t.groupId){this.stats.syncMessagesIgnored++;var h="SyncMessageSequencer.handleNonSeedMessage: Sequencer groupId "+this.groupId+" != syncMessage groupId "+t.groupId,p=h+" SyncMessage.seq "+t.seq+", "+this.groupParametersToString(t);return this.abandonMessage(a,s,h,Y.SessionExtension,ze.warn,p),er.AbandonSyncMessage}}return er.OK}},{key:"abandonMessage",value:function(t,a,s,u,l){var f=arguments.length>5&&arguments[5]!==void 0?arguments[5]:void 0;t.setReason(u),t.message+=" "+s,v.info(537002503,y.CoreDefault,t.stop()),l==ze.warn?v.warn(537002504,y.CoreDefault,f!=null?f:s):v.info(537002505,y.CoreDefault,f!=null?f:s),this.stats.syncMessageQueueLimitReached=!0,a(void 0,new zt)}},{key:"getTimeoutInMs",value:function(){return this.groupId?T_.getValue():this.prevSeq===-1?x_.getValue():S_.getValue()}},{key:"handleNonSeedMessage",value:function(t,a,s){var u=this.validateSyncMessage(t,a,s);if(u===er.StopPreviousGroup)this.stopPreviousGroup(t);else if(u===er.AbandonSyncMessage)return;var l=new __(t,a,s);this.cache.put(t.seq,l,this.getTimeoutInMs(),this.boundOnTimeout);var f=t.seq===this.prevSeq+1,c=this.groupId&&this.groupSize===this.groupCount,d=c||this.groupId===void 0&&f;v.info(520220801,y.CoreDefault,"SyncMessageSequencer.handleNonSeedMessage: groupComplete "+c+", "+d+", groupId "+t.groupId+", SyncMessage.groupSize "+t.groupSize+", Message Sequence "+t.seq),f||this.stats.syncMessagesOutOfSequence++,d?this.applyNextSequence(l):U().startAsync(j.WaitingForInOrderMessage)}},{key:"tryToApplyNextMessage",value:function(){var t=this.cache.get(this.prevSeq+1);t&&this.applyNextSequence(t)}},{key:"onTimeout",value:function(t,a){v.info(537002514,y.CoreDefault,"SyncMessageSequencer.onTimeout: Performing best-effort sync of next sequence after "+this.prevSeq+", "+this.groupParametersToString(a.syncMessage)),!this.fullFileSeedingComplete&&this.seedInterruptTimeInMs===0&&(this.seedInterruptTimeInMs=this.seedSessionHealthEvent.stop().durationMs),this.applyNextSequence(a),this.resetGroupParameters()}},{key:"stopPreviousGroup",value:function(t){v.info(508839882,y.CoreDefault,"SyncMessageSequencer.stopPreviousGroup: Pervious group ID: "+this.groupId+" new group ID: "+t.groupId),this.cache.clear();var a=Number.parseInt(this.groupId,10);a<=0&&(this.completeSeeding(),this.emit("lastSeedMessageReceived")),this.resetGroupParameters(),this.updateGroupParameters(t)}},{key:"applyNextSequence",value:function(t){var a=this,s,u;Re(function(){s=U(),u=U().startSync(j.ApplyNextSequence)},t.cc);var l=new D({operationName:"SequencerApplyNextSequence",success:!0}).start(),f=[t];for(var c of this.cache.keys())c!==t.syncMessage.seq&&f.push(this.cache.get(c));f.sort(function(E,I){return I.syncMessage.seq-E.syncMessage.seq});for(var d=f.length,h=0,p=function(I){h++,Re(function(){U().stop(j.WaitingForInOrderMessage),s.stop(u),a.applySyncMessage(I.syncMessage,I.onCompleted.bind(I)),s.resume(u),a.prevSeq=I.syncMessage.seq,a.cache.del(I.syncMessage.seq)},I.cc)},k=0,S=void 0,C=f.pop();C&&C.syncMessage.seq<=t.syncMessage.seq;){var T=C.syncMessage.seq-(this.prevSeq+1);T>0&&S===void 0&&(S=this.prevSeq+1),k+=T,p(C),C=f.pop()}if(this.stats.syncMessagesAbandoned+=k,k>0){var x=S===0&&k===1?Y.Client:Y.ClientRuntime,A=new _e({sessionHealthEventName:"AbandonedSyncMessage",source:pe.Core,reason:x,impact:he.MissingInput,success:!1,count:k,message:"seq="+S,resourceId:S===0&&k===1?"Seeding":"NonSeeding"});v.info(537002516,y.CoreDefault,A)}for(;C&&C.syncMessage.seq===this.prevSeq+1;)p(C),C=f.pop();l.stop();var b=function(){return l.resultDescription="processedRecordsCount="+h+". startingUnprocessedRecordsCount="+d,l};l.durationMs>w_.getValue()?v.info(537002517,y.CoreDefault,b):v.debug(537002518,y.CoreDefault,b),this.groupId&&this.resetGroupParameters(),s.stop(u)}},{key:"applySyncMessage",value:function(t,a){var s=this;try{v.verbose(537002519,y.CoreDefault,function(){return"SyncMessageSequencer.applySyncMessage: Applying SyncMessage. seq "+t.seq+", "+s.groupParametersToString(t)+", operations count = "+t.ops.length}),this.emit("applyingSeq",t.seq);var u=U();u.markForLogging(),this.applyMessageCallback(t,a)}catch(l){v.error(537002520,y.CoreDefault,"SyncMessageSequencer.applySyncMessage: Failed to apply operations: "+l.stack),a(new X({messageId:t.messageId,error:l.message}))}this.isAnySequenceApplied=!0}},{key:"updateSeedGroup",value:function(t){this.stats.seedItems+=t.ops.reduce(function(a,s){return a+s.items.length},0),this.groupCount===this.groupSize&&this.completeSeeding()}},{key:"completeSeeding",value:function(){this.fullFileSeedingComplete=!0,this.seedSessionHealthEvent.stop(),this.stats.seedSuccess=this.seedErrors===0,this.stats.seedGroupSize=this.groupSize,this.stats.seedDurationMs=this.seedSessionHealthEvent.durationMs,this.prevSeq=0,this.logSpentTimeForFullFileSeeding(),this.tryToApplyNextMessage(),this.emit("seedCompleted"),this.resetGroupParameters()}},{key:"handleSpecificClients",value:function(){!this.isSeedingTriggeredBySessionCreation()&&!this.isSeedingStarted()&&(this.seedSessionHealthEvent.success=!0,this.seedSessionHealthEvent.durationMs=0,this.seedSessionHealthEvent.dimension0="FFSNotNecessarilyExpected")}},{key:"logSpentTimeForFullFileSeeding",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;clearTimeout(this.seedSessionLogTimeout),this.seedSessionLogTimeout=void 0;var a=this.fullFileSeedingComplete&&this.stats.seedSuccess;a?v.info(537002523,y.CoreDefault,"SyncMessageSequencer: Full file seeding is fully completed with no errors "+this.groupParametersToString(void 0)):(this.fullFileSeedingComplete||this.seedSessionHealthEvent.stop(),v.info(537002522,y.CoreDefault,"SyncMessageSequencer: Full file seeding is not fully completed or encountered errors. Number of received messages: "+this.groupCount+". Number of expected messages: "+(this.groupSize>0?this.groupSize:"unknown")+", timedout: "+t+".")),this.seedSessionHealthEvent.success=a,this.handleSpecificClients(),this.seedSessionHealthEvent.resourceId="Full file seeding completed: "+this.fullFileSeedingComplete+". Seed mode: "+Wt[this.stats.seedMode],this.seedSessionHealthEvent.message="Interrupt time in ms="+this.seedInterruptTimeInMs.toString(),v.info(537002524,y.CoreDefault,this.seedSessionHealthEvent)}},{key:"groupParametersToString",value:function(t){if(this.groupId){var a=t?", groupId "+t.groupId+", syncMessage.groupComplete "+t.groupComplete:"groupId "+this.groupId;return"inGroup true, groupCount "+this.groupCount+", groupSize "+this.groupSize+" "+a}else return"inGroup false"}},{key:"resetGroupParameters",value:function(){this.groupCount=0,this.groupSize=0,this.groupId=void 0}},{key:"updateGroupParameters",value:function(t){var a,s,u;t.groupId=(a=t.groupId)!==null&&a!==void 0?a:t.batchId,t.groupSize=(s=t.groupSize)!==null&&s!==void 0?s:t.batchSize,t.groupComplete=(u=t.groupComplete)!==null&&u!==void 0?u:t.batchComplete,t.groupId!==void 0&&(this.groupId===void 0&&(this.groupId=t.groupId),this.groupId===t.groupId&&(this.groupCount++,t.groupComplete&&(this.groupSize=t.groupSize,this.groupCount!==this.groupSize&&v.info(537002525,y.CoreDefault,"SyncMessageSequencer.updateGroupParameters: GroupComplete message is not last message in group "+t.groupId+". groupCount="+this.groupCount+", groupSize="+this.groupSize+"."))))}}]),e}(xy.EventEmitter);function A_(n){var o=b_();return function(){var r=(0,xc.default)(n),t;if(o){var a=(0,xc.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,My.default)(this,t)}}function b_(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var Ey=function(n){(0,by.default)(e,n);var o=A_(e);function e(r){var t;return(0,_y.default)(this,e),t=o.call(this,r),t.annotationTypeFirstInstanceLogged=new Set,t}return(0,Ay.default)(e,[{key:"persistAnnotationQueue",value:function(t,a,s){var u=this,l,f,c,d=U().startSync(j.PersistAnnotationQueueStateful),h=new Map;for(var p of a){this.synthesizeEmptyAnnotationQueueEntriesIfNecessary(t,p.scopeItemPath,p.scopeItemRevId,p.annotationQueue);var k=function(O,z){if(z&&z.length>0){var J,ce=h.get(O);ce||(ce=[],h.set(O,ce)),(J=ce).push.apply(J,(0,Cc.default)(z))}};if(this.isWorkflowInReduceStyle(t)&&t.outputTypes){var S=this.session.cache.getSubtreeItems(p.scopeItemPath,t.outputTypes,function(P){return P.source===t.id}),C=function(O){var z=S.filter(function(J){return m.getTypeNameFor(J.body)===O});u.processSubtreeAnnotationQueue(t,O,p.annotationQueue.filter(function(J){return J.annotationType===O}),z,k)};for(var T of t.outputTypes)C(T)}else this.processAnnotationQueueInternal(t,p.annotationQueue,k)}if(h.size>0){var x=new Array(h.size),A=0;for(var b of h.keys()){var E=h.get(b),I=0,_=0,M=0;for(var N of E){var R=m.getTypeNameFor(N);R===we.getTypeName()?I+=((l=N.items)===null||l===void 0?void 0:l.length)||0:R===Ne.getTypeName()?_+=((f=N.items)===null||f===void 0?void 0:f.length)||0:R===Fe.getTypeName()&&(M+=((c=N.items)===null||c===void 0?void 0:c.length)||0)}x[A++]={type:b,added:I,updated:_,deleted:M}}s.message="Committing annotation changes: "+JSON.stringify(x),U().stop(d),this.commitAnnotations(t,h)}else U().stop(d),s.message="No annotation changes to commit";s.dimension1="Stateful"}},{key:"synthesizeEmptyAnnotationQueueEntriesIfNecessary",value:function(t,a,s,u){if(t.kind===q.SingleItem){var l=function(d){u.some(function(h){return h.annotationType===d})||u.push({path:a,revId:s,annotationType:d,annotations:[]})};for(var f of t.outputTypes||[])l(f)}}},{key:"processSubtreeAnnotationQueue",value:function(t,a,s,u,l){var f=new Map;for(var c of u){var d=G(c.parentPath),h=f.get(d);h||(h=[],f.set(d,h)),h.push(c)}for(var p of s){var k=G(p.path);f.delete(k)}var S=[];for(var C of f){var T=(0,Iy.default)(C,2),x=T[0],A=T[1];this.generateAnnotationDeleteOps(t,Yn(x),void 0,!1,A,S)}l(a,S),this.processAnnotationQueueInternal(t,s,l)}},{key:"processAnnotationQueueInternal",value:function(t,a,s){for(var u of a)if(u.ancestorType){var l=this.session.cache.getFirstAncestorOfType(u.path,[u.ancestorType]);if(!l)throw new Error("Failed to get ancestor of type "+u.ancestorType+" on path "+G(u.path)+" (no match)");this.applyAnnotations(t,[].concat((0,Cc.default)(l.parentPath),[l.id]),void 0,!1,u,s)}else this.applyAnnotations(t,u.path,u.revId,u.isTriggeredBySyncDelta,u,s)}},{key:"applyAnnotations",value:function(t,a,s,u,l,f){var c=l.annotationType,d=l.annotations,h;try{h=this.session.cache.getItemChildren(a,t.outputTypes)}catch(A){if(A instanceof eo){v.info(529093124,y.CoreDefault,"Annotations ignored because parent "+G(a)+" no longer exists");return}else throw A}var p=h.filter(function(A){return A.source===t.id&&m.getTypeNameFor(A.body)===c}),k=[],S=[];this.compareAnnotationsToExistingChildren(a,t,d,c,l.isImmediateAnnotation,p,k,S);var C=[];L("DeleteOpsBeforeAdds")?(this.generateAnnotationDeleteOps(t,a,s,u,p,C),this.generateAnnotationAddOps(a,s,u,k,C),this.generateAnnotationUpdateOps(a,s,u,S,C)):(this.generateAnnotationAddOps(a,s,u,k,C),this.generateAnnotationUpdateOps(a,s,u,S,C),this.generateAnnotationDeleteOps(t,a,s,u,p,C));for(var T of C)for(var x of T.items)x.contextId=l.contextId;f(c,C)}},{key:"isWorkflowInReduceStyle",value:function(t){return t.kind===q.Reduce||t.kind===q.Generic&&t.dynamicExecutionPreferences===void 0}},{key:"compareAnnotationsToExistingChildren",value:function(t,a,s,u,l,f,c,d){var h=this,p=function(C){C.id||(C.id=dn());var T=C.id;C.id=void 0;var x=C.M_;C.M_=void 0;var A=h.compareAnnotationToExistingChildren(a,C,T,u,f,l),b=A.shouldAddAnnotation,E=A.shouldUpdateAnnotation,I=A.itemId;C.id=T,C.M_=x,b&&(C.M_=Object.assign(Object.assign({},C.M_),{state:bt.Created}),h.logMetaData(bt.Created,u,C.ownerId));var _={id:I,parentPath:t,source:a.id,body:C},M="Not changing";b?(c.push(_),M="Adding"):E&&(d.push(_),M="Updating"),v.debug(529093125,y.CoreDefault,function(){return M+" annotation "+C.id+" (type: "+m.getTypeNameFor(C)+", workflow: "+a.id+")"})};for(var k of s)p(k)}},{key:"compareAnnotationToExistingChildren",value:function(t,a,s,u,l,f){for(var c={shouldAddAnnotation:!0,shouldUpdateAnnotation:!1,itemId:""},d=0;d<l.length;d++){var h=l[d].body,p=h.id;h.id=void 0;var k=h.M_;h.M_=void 0;var S=!1;if(L("ApplyAnnotationOptimization")?(!Kt(t)||ea(t)||f)&&(0,Tc.default)(h,a)?(S=!0,c.shouldAddAnnotation=!1):s===p&&(S=!0,c.shouldUpdateAnnotation=!0,c.shouldAddAnnotation=!1,c.itemId=l[d].id):(!Kt(t)||ea(t))&&(0,Tc.default)(h,a)?(S=!0,c.shouldAddAnnotation=!1):s===p&&(S=!0,c.shouldUpdateAnnotation=!0,c.shouldAddAnnotation=!1,c.itemId=l[d].id),h.id=p,h.M_=k,S){this.logMetaData(bt.Duplicated,u,h.ownerId),l.splice(d,1);break}}return c.shouldAddAnnotation&&(c.itemId=this.session.cache.getNextAnnotationId()),c}},{key:"commitAnnotations",value:function(t,a){var s=this,u=U(),l=u.startSync(j.CommitAnnotations);a.forEach(function(f,c){if(f.length){s.session.contextIdManager.applyContextIdOnOperations(f),s.session.updateWorkflowExecutionStates(f);try{s.session.cache.applyOperations(f,void 0)}catch(h){v.info(529093126,y.CoreDefault,new _e({sessionHealthEventName:"FailedApplyingAnnotationsToCache",source:pe.Core,reason:Y.Core,impact:he.MissingOutput,success:!1,message:"",affectedWorkflows:[t.resourceId]})),v.error(529093127,y.CoreDefault,"Error applying annotation results to cache: "+h.message)}if(Ry.getValue()&&s.session.annotationActivationInfosByType.has(c)){var d=f.map(function(h){var p=new Array(h.items.length),k=0;for(var S of h.items)if(S.body){var C=S.body;s.logMetaData(bt.Sent,c,C.ownerId),p[k++]={id:S.id,body:C,contextId:S.contextId}}return p.length=k,new ot({parentPath:h.parentPath,items:p,M_:{state:bt.Sent}})});try{s.session.cache.applyOperations(d,void 0)}catch(h){v.info(529093128,y.CoreDefault,new _e({sessionHealthEventName:"FailedSettingAnnotationStateToSent",source:pe.Core,reason:Y.Core,impact:he.MissingOutput,success:!1,message:"",affectedWorkflows:[t.resourceId]})),v.error(529093129,y.CoreDefault,"Error setting annotation state to sent")}}u.stop(l),s.session.sendAnnotations(c,f,t),u.resume(l),s.logAnnotationTypeFirstInstance(c)}}),u.stop(l)}},{key:"logMetaData",value:function(t,a,s){s||(s=""),v.info(529093130,y.CoreDefault,new ki({sessionKey:this.session.sessionKey,annotationType:a,annotationState:t,workflowId:os(s)}))}},{key:"logAnnotationTypeFirstInstance",value:function(t){this.session.syncMessageSequencer.getStats().seedMode===Wt.Sequenced&&!this.annotationTypeFirstInstanceLogged.has(t)&&(v.info(529093131,y.CoreDefault,new D({operationName:"FirstAnnotation",resourceId:t,durationMs:Date.now()-this.session.startTime,resultSignature:"SinceSessionStart",success:!0},{metricDuration:!0})),this.annotationTypeFirstInstanceLogged.add(t))}}]),e}(fs);g();var Ny=w(W()),Dy=w(B()),Wy=w(qe()),By=w(Ge()),Ic=w(De());function M_(n){var o=E_();return function(){var r=(0,Ic.default)(n),t;if(o){var a=(0,Ic.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,By.default)(this,t)}}function E_(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var Py=function(n){(0,Wy.default)(e,n);var o=M_(e);function e(r,t){var a;return(0,Ny.default)(this,e),a=o.call(this,r),a.itemListeners=t,a}return(0,Dy.default)(e,[{key:"persistAnnotationQueue",value:function(t,a,s){var u=this,l=U(),f=l.startSync(j.PersistAnnotationQueueStateless),c=new Array(a.length),d=0;for(var h of a){var p=function(C){var T=[],x=C.annotations.map(function(A){return{id:u.session.cache.getNextAnnotationId(),parentPath:C.path,source:t.id,contextId:C.contextId,body:A}});u.generateAnnotationAddOps(C.path,C.revId,C.isTriggeredBySyncDelta,x,T),u.session.contextIdManager.applyContextIdOnOperations(T),u.session.updateWorkflowExecutionStates(T),u.itemListeners.emitEvents(T),l.stop(f),u.session.sendAnnotations(C.annotationType,T,t),l.resume(f),c[d++]={type:C.annotationType,added:T.reduce(function(A,b){var E;return A+(((E=b.items)===null||E===void 0?void 0:E.length)||0)},0),updated:0,deleted:0}};for(var k of h.annotationQueue)p(k)}s.message=c.length>0?"Committing annotation changes: "+JSON.stringify(c):"No annotation changes to commit",s.dimension1="Stateless",l.stop(f)}}]),e}(fs);g();var ne=w(Ie()),Ft=w(Ye()),Qy=w(Dr()),jy=w(qe()),Jy=w(Ge()),Mc=w(De()),ks=w(W()),ws=w(B());g();var vs=w(W()),ys=w(B());var _c=function(){function n(o){(0,vs.default)(this,n),m.assign(n,this,o)}return(0,ys.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Signals_ContentSignal"}},{key:"getBaseTypes",value:function(){return["AugLoop_Signals_Signal"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();_c.H_={T_:_c.getTypeName(),B_:_c.getBaseTypes()};var Ac=function(){function n(o){(0,vs.default)(this,n),m.assign(n,this,o)}return(0,ys.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Signals_BaseSubstrateSignal"}},{key:"getBaseTypes",value:function(){return["AugLoop_Signals_Signal"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Ac.H_={T_:Ac.getTypeName(),B_:Ac.getBaseTypes()};var na=function(){function n(o){(0,vs.default)(this,n),m.assign(n,this,o)}return(0,ys.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Signals_CorrelatedSignal"}},{key:"getBaseTypes",value:function(){return["AugLoop_Signals_Signal"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();na.H_={T_:na.getTypeName(),B_:na.getBaseTypes()};var Ky=w(Jn());g();var R_=new F("fullInvalidationThreshold",.85),bc=new F("enableLoggingUnexpectedItems",!1),Oy=function(o,e,r,t){var a=[];if(t=t!=null?t:R_.getValue(),e.size===0||e.size/r.length>=t){var s=[];for(var u of r)u?s.push(u):bc.getValue()&&v.info(537678304,y.CoreDefault,"Undefined sibling item is detected.");a.push(s)}else{for(var l=new Map,f=0;f<r.length;f++)r[f]?l.set(r[f].id,f):bc.getValue()&&v.info(537678305,y.CoreDefault,"Undefined sibling item is detected.");for(;e.size>0;){var c=[],d=e.keys().next().value,h=d,p=l.get(h);if(p===void 0){v.info(537678306,y.CoreDefault,"SiblingItems doesn't contain invalidated item with id "+h),e.delete(h);continue}c.push(r[p]);for(var k=p+1<r.length?r[p+1].id:void 0;e.has(k);)h=k,p+=1,c.push(r[p]),e.delete(h),k=p+1<r.length?r[p+1].id:void 0;h=d,p=l.get(h);for(var S=p-1>=0?r[p-1].id:void 0;e.has(S);)h=S,p-=1,c.unshift(r[p]),e.delete(h),S=p-1>=0?r[p-1].id:void 0;e.delete(d),a.push(c)}}if(o.workflow.dynamicExecutionPreferences.inputSize===-1)return a;var C=[];for(var T of a)for(var x=0,A=o.workflow.dynamicExecutionPreferences.inputSize;x<T.length;){for(var b=0,E=[];b<A&&x<T.length;){if(T[x]&&T[x].body){var I=T[x].body;if(E.push(T[x]),o.workflow.dynamicExecutionPreferences.inputSizeUnit===Sn.Character)b+=I?I.content.length:0;else if(o.workflow.dynamicExecutionPreferences.inputSizeUnit===Sn.Paragraph)b++;else{v.error(537678307,y.CoreDefault,"Unsupported UnitType: "+o.workflow.dynamicExecutionPreferences.inputSizeUnit);return}}else bc.getValue()&&v.info(537678336,y.CoreDefault,"Undefined sibling item is detected.");x+=1}C.push(E)}return C};g();var Ly=w(Ie()),Fy=w(W()),qy=w(B());var Gy=function(){function n(){(0,Fy.default)(this,n)}return(0,qy.default)(n,[{key:"getBatchesByItemPath",value:function*(e,r,t){if(e.length===0)return[];if(e.length<=r()){yield e;return}var a=e.reduce(function(d,h){var p=t(h),k=G([].concat((0,Ly.default)(p.parentPath),[p.id]));return d.has(k)||d.set(k,[]),d.get(k).push(h),d},new Map),s=[],u=r();for(var l of a.values()){s.length>0&&l.length<=u&&s.length+l.length>u&&(yield s,u=r(),s=[]);for(var f=0;f<l.length;){var c=Math.min(u-s.length,l.length-f);s=s.concat(l.slice(f,f+c)),f+=c,s.length===u&&(yield s,u=r(),s=[])}}s.length>0&&(yield s)}},{key:"getBatches",value:function*(e,r){var t=[],a=r();for(var s of e)t.push(s),t.length===a&&(yield t,a=r(),t=[]);t.length>0&&(yield t)}}]),n}();g();var Uy=w(W()),Hy=w(B());var zy=function(){function n(o){(0,Uy.default)(this,n),this.pendingScopeExecutionNotificationsByWorkflow=new Map,this.workflowExecutionTrackersByName=o}return(0,Hy.default)(n,[{key:"pendingNotifications",get:function(){return this.pendingScopeExecutionNotificationsByWorkflow.size>0}},{key:"get",value:function(e,r){var t;return(t=this.pendingScopeExecutionNotificationsByWorkflow.get(e))===null||t===void 0?void 0:t.get(r)}},{key:"set",value:function(e,r,t){var a=this.pendingScopeExecutionNotificationsByWorkflow.get(e);a||(a=new Map,this.pendingScopeExecutionNotificationsByWorkflow.set(e,a)),a.set(r,t);var s=this.workflowExecutionTrackersByName.get(e);for(var u of t.params||[]){var l=u.item;l.contextId&&s.setExecutionState(l.contextId,ve.Pending)}}},{key:"delete",value:function(e,r){var t,a,s=(t=this.pendingScopeExecutionNotificationsByWorkflow.get(e))===null||t===void 0?void 0:t.get(r),u=this.workflowExecutionTrackersByName.get(e);if(s)for(var l of s.params||[]){var f=l.item;if(f.contextId){var c=u.getExecutionState().get(f.contextId);c===ve.Pending&&u.getExecutionState().delete(f.contextId)}}(a=this.pendingScopeExecutionNotificationsByWorkflow.get(e))===null||a===void 0||a.delete(r),this.pendingScopeExecutionNotificationsByWorkflow.get(e).size===0&&this.pendingScopeExecutionNotificationsByWorkflow.delete(e)}},{key:"entries",value:function(){return this.pendingScopeExecutionNotificationsByWorkflow.entries()}},{key:"cancelPendingNotifications",value:function(){this.pendingScopeExecutionNotificationsByWorkflow=new Map}}]),n}();function N_(n){var o=D_();return function(){var r=(0,Mc.default)(n),t;if(o){var a=(0,Mc.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,Jy.default)(this,t)}}function D_(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var _n;(function(n){n[n.Input=1]="Input",n[n.Context=2]="Context"})(_n||(_n={}));var W_=new F("deltaUpdateMinDelayMs",250),B_=new F("deltaUpdateMaxDelayMs",250),P_=function(){return{minDelayMs:W_.getValue(),maxDelayMs:B_.getValue()}},$y=function(o){return new z_(o)},O_=new F("skipDebounceDeltasEnabled",!0),L_=new F("enableExecutionCountCheck",!1),F_=new F("sweepScopeExecutionNotificationsInterval",200),q_=new F("disableLoggingAncestorNotFoundForWorkflows",["HoneybeeRankingDelta"]),G_=new F("enableDeltaUpdateDelayPerClient",{default:!1}),Vy=new F("enableEarlyJoinCompletion",!1),U_=new Map([[nt.getTypeName(),Bn.getTypeName()]]),H_=function(){function n(){(0,ks.default)(this,n)}return(0,ws.default)(n,[{key:"setClientMetadata",value:function(e){this.clientSettingsKey=e!=null&&e.appName&&(e!=null&&e.appPlatform)?e.appName.toLowerCase()+"-"+e.appPlatform.toLowerCase():void 0}},{key:"getValue",value:function(){var e=G_.getValue();return this.clientSettingsKey&&e.hasOwnProperty(this.clientSettingsKey)?e[this.clientSettingsKey]:e.hasOwnProperty("default")?e.default:!1}}]),n}(),z_=function(n){(0,jy.default)(e,n);var o=N_(e);function e(r){var t;return(0,ks.default)(this,e),t=o.call(this),t.workflowExecutionTrackersByName=new Map,t.pendingScopeExecutionNotificationsByWorkflow=new Map,t.notificationManager=new zy(t.workflowExecutionTrackersByName),t.sweepIntervalMs=F_.getValue(),t.areasIntersect=function(a){return!1},t.supportsAreaIntersection=function(a){return!1},t.sessionCache=r.cache,t.queueWorkflow=r.queueWorkflow,t.queueGridNeighborhoodWorkflow=r.queueGridNeighborhoodWorkflow,t.sessionCache.on("purgeModel",t.onPurgeModel.bind((0,Qy.default)(t))),t.inputChangesManager=r.inputChangesManager,t.getUserNodePath=r.getUserNodePath,t.workflowDefinitionManager=r.workflowDefinitionManager,t.workflowItemStorage=r.workflowItemStorage,t.getTenantNodePath=r.getTenantNodePath,t.getUserCommandsNodePath=r.getUserCommandsNodePath,t.sessionCreationTime=r.sessionCreationTime,t.usesRefactoredDebouncing=r.usesRefactoredDebouncing,t.workflowSynchronizationManager=r.workflowSynchronizationManager,t.workflowPrefilterManager=new yy,t.workflowQueue=r.workflowQueue,t.enableDeltaUpdateDelay=new H_,t.batchSplitter=new Gy,t.executionCompleteCallback=r.executionCompleteCallback,t.attachExecutionTrackerToEachWorkflow(r.workflowRegistrationsByName,r.workflowsByInputAnnotation,r.workflowsByOutputAnnotation,r.workflowsByRequestedContextType),t.workflowBatchSizeMax=r.workflowBatchSizeMax,t.supportsAreaIntersection=r.supportsAreaIntersection,t.areasIntersect=r.areasIntersect,t}return(0,ws.default)(e,[{key:"pendingNotifications",get:function(){return L("NotificationManager")?this.notificationManager.pendingNotifications:this.pendingScopeExecutionNotificationsByWorkflow.size>0}},{key:"getAllDownstreamWorkflowIds",value:function(t){var a=new Set;L("WaitContextProducerToComplete")?this.workflowExecutionTrackersByName.get(t).allDownstreamWorkflowExecutionTrackers.forEach(function(f){f.workflowResultType===_n.Input&&a.add(f)}):a=this.workflowExecutionTrackersByName.get(t).allDownstreamWorkflowExecutionTrackers;var s=new Array(a?a.size:0),u=0;for(var l of a?a.values():[])s[u++]=l.workflowExecutionTracker.workflow.id;return s}},{key:"getAllUpstreamWorkflowIds",value:function(t){var a=new Set;L("WaitContextProducerToComplete")?this.workflowExecutionTrackersByName.get(t).allUpstreamWorkflowExecutionTrackers.forEach(function(f){f.workflowResultType===_n.Input&&a.add(f)}):a=this.workflowExecutionTrackersByName.get(t).allUpstreamWorkflowExecutionTrackers;var s=new Array(a?a.size:0),u=0;for(var l of a?a.values():[])s[u++]=l.workflowExecutionTracker.workflow.id;return s}},{key:"invalidateWorkflow",value:function(t,a){var s=this.workflowExecutionTrackersByName.get(t.workflow.id);try{if(t.workflow.kind===q.SingleItem)this.invalidateSingleItemWorkflow(s,t,a);else if(t.workflow.kind===q.DynamicText)this.invalidateDynamicWorkflow(s,t,a);else if(t.workflow.kind===q.Reduce||t.workflow.kind===q.Grid)for(var u of a)this.invalidateReduceWorkflow(s,t,u);else if(t.workflow.kind===q.Join)for(var l of a)this.invalidateJoinWorkflow(s,t,l);else if(t.workflow.kind===q.Generic)for(var f of a)this.invalidateGenericWorkflow(s,t,f);else v.error(537678240,y.CoreDefault,"Failed to invalidate workflow "+t.workflow.id+": workflow in type "+t.workflow.kind+" is not supported.")}catch(k){v.error(537678241,y.CoreDefault,"Failed to invalidate workflow "+t.workflow.id+": "+k.message)}finally{var c=s.getExecutionState();for(var d of a){var h=d.item;if(h!=null&&h.contextId){var p=c.get(h.contextId);p===ve.Idle&&s.afterWorkflowExecution(h.contextId)}}}}},{key:"getWorkflowsByExecutionState",value:function(){for(var t=new Set,a=arguments.length,s=new Array(a),u=0;u<a;u++)s[u]=arguments[u];for(var l of this.workflowExecutionTrackersByName.values())s.includes(l.getWorkflowExecutionState())&&t.add(l.workflow);return t}},{key:"requestSweep",value:function(){this.ensureSweepTimer()}},{key:"onSessionClose",value:function(){this.cancelSweepTimer(),this.usesRefactoredDebouncing&&this.workflowSynchronizationManager.onSessionClose()}},{key:"evaluatePrefilters",value:function(t,a){var s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Dt.All,u={scopeItem:a.scopeItem,inputItems:a.inputItems,clientMetadata:this.clientMetadata};return this.workflowPrefilterManager.evaluateWorkflowPrefilters(t,u,s)}},{key:"setClientMetadata",value:function(t){this.clientMetadata=t,this.enableDeltaUpdateDelay.setClientMetadata(t)}},{key:"attachExecutionTrackerToWorkflow",value:function(t,a,s,u){if(this.workflowExecutionTrackersByName.has(t.workflow.id))throw new Error("Duplicate workflow "+t.workflow.id);for(var l of this.workflowExecutionTrackersByName.values())l.allDownstreamWorkflowExecutionTrackers=void 0,l.allUpstreamWorkflowExecutionTrackers=void 0;this.attachExecutionTrackerToEachWorkflow(new Map([[t.workflow.id,t]]),a,s,u)}},{key:"increasePendingUpstreamWorkflowsCount",value:function(t,a,s){this.workflowExecutionTrackersByName.get(t).increasePendingUpstreamWorkflowsCount(a,this.sessionCache.getFirstAncestorOfType.bind(this.sessionCache),s)}},{key:"preProcessItemToWorkflow",value:function(t,a){var s=this.workflowExecutionTrackersByName.get(t.id);t.kind===q.Join&&m.matchesTypesFor(a.body,t.inputTypes)&&s.addInputItemToProcess(a.contextId),(t.kind===q.SingleItem&&m.matchesTypesFor(a.body,t.inputTypes)||t.kind===q.Join&&m.matchesTypesFor(a.body,[t.collectionScopeType]))&&s.beforeWorkflowExecution(a.contextId)}},{key:"evaluateSingleItemPrefiltersWithoutAction",value:function(t,a){var s={scopeItem:a,inputItems:[a],clientMetadata:this.clientMetadata},u=this.workflowPrefilterManager.evaluateWorkflowPrefilters(t,s,Dt.WithoutActionDefinition);return u.shouldExecuteWorkflow}},{key:"prefilterAndSplitTasksBeforeQueing",value:function(t,a){var s=[],u=[];for(var l of a){var f=this.evaluatePrefilters(t.workflow,l,Dt.WithActionDefinition);f.shouldExecuteWorkflow?s.push(l):(l.prefilterActionResults=f.prefilterActionResults,u.push(l))}return{workflowTasks:s,prefilteredTasks:u}}},{key:"attachExecutionTrackerToEachWorkflow",value:function(t,a,s,u){for(var l of t){var f=(0,Ft.default)(l,2),c=f[0],d=f[1],h=new V_(d,this.onExecutionStateChange.bind(this),this.onContextIdWorkflowExecutionComplete.bind(this));this.workflowExecutionTrackersByName.set(c,h)}for(var p of this.workflowExecutionTrackersByName.values())this.setDownstreamWorkflowExecutionTrackers(p,a,u),this.setUpstreamWorkflowExecutionTrackers(p,s)}},{key:"setDownstreamWorkflowExecutionTrackers",value:function(t,a,s){var u,l,f;if(t.allDownstreamWorkflowExecutionTrackers===void 0){t.allDownstreamWorkflowExecutionTrackers=new Set;for(var c of(u=t.workflow.outputTypes)!==null&&u!==void 0?u:[]){var d=(l=a.get(c))!==null&&l!==void 0?l:new Set;if(this.setDownstreamWorkflowExecutionTrackersForDependentWorkflows(d,a,s,t,_n.Input),L("WaitContextProducerToComplete")){var h=(f=s.get(c))!==null&&f!==void 0?f:new Set;this.setDownstreamWorkflowExecutionTrackersForDependentWorkflows(h,a,s,t,_n.Context)}}}}},{key:"setDownstreamWorkflowExecutionTrackersForDependentWorkflows",value:function(t,a,s,u,l){var f;for(var c of t){this.setDownstreamWorkflowExecutionTrackers(this.workflowExecutionTrackersByName.get(c.id),a,s),u.allDownstreamWorkflowExecutionTrackers.add({workflowExecutionTracker:this.workflowExecutionTrackersByName.get(c.id),workflowResultType:l});var d=function(k){u.allDownstreamWorkflowExecutionTrackers.forEach(function(S){S.workflowExecutionTracker===k.workflowExecutionTracker&&S.workflowResultType===k.workflowResultType&&u.allDownstreamWorkflowExecutionTrackers.delete(S)}),u.allDownstreamWorkflowExecutionTrackers.add(k)};for(var h of(f=this.workflowExecutionTrackersByName.get(c.id).allDownstreamWorkflowExecutionTrackers)!==null&&f!==void 0?f:[])d(h)}}},{key:"setUpstreamWorkflowExecutionTrackers",value:function(t,a){var s;if(t.allUpstreamWorkflowExecutionTrackers===void 0){t.allUpstreamWorkflowExecutionTrackers=new Set;var u=(s=t.workflow.inputTypes)!==null&&s!==void 0?s:[];this.setUpstreamWorkflowExecutionTrackersForTypes(u,t,a,_n.Input),L("WaitContextProducerToComplete")&&(u=Zh(this.workflowDefinitionManager.getWorkflowDefinition(t.workflow).requestedContextTypesRules),this.setUpstreamWorkflowExecutionTrackersForTypes(u,t,a,_n.Context))}}},{key:"setUpstreamWorkflowExecutionTrackersForTypes",value:function(t,a,s,u){var l,f;for(var c of t)for(var d of(l=s.get(c))!==null&&l!==void 0?l:[]){this.setUpstreamWorkflowExecutionTrackers(this.workflowExecutionTrackersByName.get(d.id),s),a.allUpstreamWorkflowExecutionTrackers.add({workflowExecutionTracker:this.workflowExecutionTrackersByName.get(d.id),workflowResultType:u});var h=function(S){a.allUpstreamWorkflowExecutionTrackers.forEach(function(C){C.workflowExecutionTracker===S.workflowExecutionTracker&&C.workflowResultType===S.workflowResultType&&a.allUpstreamWorkflowExecutionTrackers.delete(C)}),a.allUpstreamWorkflowExecutionTrackers.add(S)};for(var p of(f=this.workflowExecutionTrackersByName.get(d.id).allUpstreamWorkflowExecutionTrackers)!==null&&f!==void 0?f:[])h(p)}}},{key:"invalidateSingleItemWorkflow",value:function(t,a,s){var u=this,l,f,c,d,h,p,k,S=new Map,C=this.isWorkflowRequestingContexts(a.workflow),T=void 0,x=this.isWorkflowWithDelay(a.workflow),A=U(),b=function(V){var me,te,ke,He=A.startSync(j.AddScopeGroupedParameters),rt="";if(C){T||(T=u.getAllDocumentContextHolderPaths((ke=(te=(me=s==null?void 0:s[0])===null||me===void 0?void 0:me.updatedContextScope)===null||te===void 0?void 0:te[0])!==null&&ke!==void 0?ke:"session"));var ut=u.getDeepestDocumentContextHolderPath(T,V.item);ut&&(rt=G(ut))}S.has(rt)||S.set(rt,[]),S.get(rt).push(V),A.stop(He)},E=function(V){return(!a.invalidationFilter||a.invalidationFilter(V)!==!1)&&u.evaluateSingleItemPrefiltersWithoutAction(a.workflow,V)},I=function(V){E(V.item)?b(V):v.verbose(508411922,y.CoreDefault,function(){return"Filtered out single-item invalidation for item with path ["+[].concat((0,ne.default)(V.item.parentPath),[V.item.id])+"]"})},_=!1;if(!s||s.length==1&&(!s[0].item||s[0].updatedContextScope)){_=!(!((l=s==null?void 0:s[0])===null||l===void 0)&&l.updatedContextScope);var M=function(V){if(L("OfficeVSO:8048430_ImplementIntersectionInExecutionManager_2"))I({item:V,opType:(d=s==null?void 0:s[0])===null||d===void 0?void 0:d.opType});else{if(!E(V))return v.verbose(537678242,y.CoreDefault,function(){return"Filtered out single-item invalidation for item with path ["+[].concat((0,ne.default)(V.parentPath),[V.id])+"]"}),1;b({item:V,opType:(h=s==null?void 0:s[0])===null||h===void 0?void 0:h.opType})}};for(var N of this.sessionCache.getSubtreeItems((c=(f=s==null?void 0:s[0])===null||f===void 0?void 0:f.updatedContextScope)!==null&&c!==void 0?c:[],a.workflow.inputTypes))M(N)}else{var R=function(V){if(V.item)if(L("OfficeVSO:8048430_ImplementIntersectionInExecutionManager_2")&&m.matchesTypesFor(V.item.body,[Rr.getTypeName()])){var me=u.getAreaIntersectionFilter(V.item.body),te=u.sessionCache.getSubtreeItems([],a.workflow.inputTypes,me);v.info(508411921,y.CoreDefault,"invalidateSingleItemWorkflow: Using intersection for workflow '"+a.workflow.id+"' , found '"+(te==null?void 0:te.length)+"' items.");for(var ke of te)m.matchesTypesFor(ke.body,[Rr.getTypeName()])?v.warn(508411920,y.CoreDefault,function(){return"Skipping a DirtyAreaSignal received from the model for "+a.workflow.id}):I({item:ke,opType:V.opType})}else if(L("OfficeVSO:8048430_ImplementIntersectionInExecutionManager_2"))I(V);else{if(!E(V.item))return v.verbose(537678243,y.CoreDefault,function(){return"Filtered out single-item invalidation for item with path ["+[].concat((0,ne.default)(V.item.parentPath),[V.item.id])+"]"}),1;b(V)}};for(var P of s)R(P)}if(U().stop(j.InvalidateWorkflow),S.size>0){var O=(k=(p=s==null?void 0:s[0])===null||p===void 0?void 0:p.reInvalidateAfterDebounce)!==null&&k!==void 0?k:!1;for(var z of S.entries()){var J=(0,Ft.default)(z,2),ce=J[0],ae=J[1];if(vr(a.workflow)){this.invalidateHybridSingleItemWorkflow(t,a,ae);continue}this.queueOrSetScopeExecutionNotification(!x,Yn(ce),a,t,_,O,ae)}}}},{key:"invalidateHybridSingleItemWorkflow",value:function(t,a,s){var u,l,f=U(),c=f.startSync(j.InvalidateHybridSingleItemWorkflow),d=a.workflow;for(var h of s)if(h!=null&&h.item){var p=h.item.contextId;if(m.matchesTypesFor(h.item.body,(0,ne.default)(d.inputTypes))){var k=h.item;this.workflowItemStorage.setScopeItem(k,d),f.stop(c),this.queueOrSetScopeExecutionNotification(!1,[].concat((0,ne.default)(k.parentPath),[k.id]),a,t,!0,(u=h.reInvalidateAfterDebounce)!==null&&u!==void 0?u:!1,[{item:k}],h==null?void 0:h.triggerSignals);return}if(!na.typeGuard(h.item.body))continue;var S=h.item.body;if(!d.correlatedSignals.includes(S.id))continue;var C=this.workflowItemStorage.getScopeItem(p,d);if(!C)continue;var T=L("NotificationManager")?this.notificationManager.get(d.id,C.contextId):(l=this.pendingScopeExecutionNotificationsByWorkflow.get(d.id))===null||l===void 0?void 0:l.get(C.contextId);if(!T){v.info(525218563,y.CoreDefault,"Workflow "+d.id+", contextId "+C.contextId+", already executed, skipping new scope execution");continue}this.workflowItemStorage.addItemToWorkflowList(h.item,d),f.stop(c),this.tryToQueueExecutionNotification(T,function(){},L("EnableRequestedContextForJoinWorkflows")?this.resolveAndValidateContextsAndEvents.bind(this):function(x,A){return[!0,!0,[]]},!0)&&(L("NotificationManager")?this.notificationManager.delete(d.id,C.contextId):(this.pendingScopeExecutionNotificationsByWorkflow.get(d.id).delete(C.contextId),this.pendingScopeExecutionNotificationsByWorkflow.get(d.id).size===0&&this.pendingScopeExecutionNotificationsByWorkflow.delete(d.id))),f.resume(c)}f.stop(c)}},{key:"invalidateDynamicWorkflow",value:function(t,a,s){var u,l,f,c,d,h=new Map,p=!1,k=function(M,N){var R;if(!h.has(M))h.set(M,[]);else if(((R=h.get(M))===null||R===void 0?void 0:R.length)===0)return;N!==void 0&&h.get(M).push(N.id)};for(var S of s)if(S.item)k(G(S.item.parentPath),S.item);else if(p=!(!((u=s==null?void 0:s[0])===null||u===void 0)&&u.updatedContextScope),a.workflow.inputTypes){var C=this.sessionCache.getSubtreeItems((f=(l=s==null?void 0:s[0])===null||l===void 0?void 0:l.updatedContextScope)!==null&&f!==void 0?f:[],a.workflow.inputTypes);for(var T of C)k(G(T.parentPath))}U().stop(j.InvalidateWorkflow);var x=(d=(c=s==null?void 0:s[0])===null||c===void 0?void 0:c.reInvalidateAfterDebounce)!==null&&d!==void 0?d:!1;for(var A of h.entries()){var b=(0,Ft.default)(A,2),E=b[0],I=b[1];this.queueOrSetScopeExecutionNotification(!1,Yn(E),a,t,p,x,void 0,void 0,I)}}},{key:"invalidateReduceWorkflow",value:function(t,a,s){var u=this,l,f,c,d,h=this.isWorkflowWithDelay(a.workflow);if(!(L("OfficeVSO:8048430_ImplementIntersectionInExecutionManager")&&this.tryInvalidateReduceWorkflowUsingIntersection(t,a,h,s)))if(s!=null&&s.item){if(a.invalidationFilter&&a.invalidationFilter(s.item)===!1){v.verbose(537678272,y.CoreDefault,function(){return"Filtered out reduce invalidation for item with parent path ["+[].concat((0,ne.default)(s.item.parentPath),[s.item.id])+"]"});return}var p=this.sessionCache.getFirstAncestorOfType([].concat((0,ne.default)(s.item.parentPath),[s.item.id]),[a.workflow.collectionScopeType]);if(p){s.item=p;var k=[].concat((0,ne.default)(p.parentPath),[p.id]);U().stop(j.InvalidateWorkflow),this.queueOrSetScopeExecutionNotification(!1,k,a,t,!1,(l=s.reInvalidateAfterDebounce)!==null&&l!==void 0?l:!1,void 0,s.triggerSignals)}else return}else if(L("OfficeVSO:8048430_ImplementIntersectionInExecutionManager")){var S=this.sessionCache.getSubtreeItems((f=s==null?void 0:s.updatedContextScope)!==null&&f!==void 0?f:[],[a.workflow.collectionScopeType]);this.invalidateReduceWorkflowForMultipleRootItems(S,t,a,h,s)}else{var C=!(!((c=s==null?void 0:s[0])===null||c===void 0)&&c.updatedContextScope),T=this.sessionCache.getSubtreeItems((d=s==null?void 0:s.updatedContextScope)!==null&&d!==void 0?d:[],[a.workflow.collectionScopeType]),x=function(I){if(a.invalidationFilter&&a.invalidationFilter(I)===!1)return v.info(537678273,y.CoreDefault,function(){return"Filtered out reduce invalidation for item with parent path ["+[].concat((0,ne.default)(I.parentPath),[I.id])+"]"}),{v:void 0};U().stop(j.InvalidateWorkflow),u.queueOrSetScopeExecutionNotification(!h&&!u.isWaitingForUpstreamWorkflows(a),[].concat((0,ne.default)(I.parentPath),[I.id]),a,t,C,!1,void 0,s==null?void 0:s.triggerSignals)},A;for(var b of T)if(A=x(b),A)return A.v}}},{key:"tryInvalidateReduceWorkflowUsingIntersection",value:function(t,a,s,u){var l,f,c=void 0,d=!1;if(!u||m.getTypeNameFor((l=u.item)===null||l===void 0?void 0:l.body)==a.workflow.collectionScopeType||(this.supportsAreaIntersection((f=u.item)===null||f===void 0?void 0:f.body)?c=u.item.body:(c=e.getDirtyAreaSingleSignalTrigger(u.triggerSignals),d=!!c),!c))return!1;var h=this.getAreaIntersectionFilter(c),p=this.sessionCache.getSubtreeItems([],[a.workflow.collectionScopeType],h);return v.info(508560338,y.CoreDefault,"tryInvalidateReduceWorkflowUsingIntersection: Using intersection for workflow '"+a.workflow.id+"' , dirty area type: '"+m.getTypeNameFor(c)+"', found '"+(p==null?void 0:p.length)+"' items."),(p==null?void 0:p.length)>0?(this.invalidateReduceWorkflowForMultipleRootItems(p,t,a,s,u),!0):d}},{key:"invalidateReduceWorkflowForMultipleRootItems",value:function(t,a,s,u,l){var f=this,c,d=!(!((c=l==null?void 0:l[0])===null||c===void 0)&&c.updatedContextScope),h=function(C){if(s.invalidationFilter&&s.invalidationFilter(C)===!1)return v.info(508560337,y.CoreDefault,function(){return"Filtered out reduce invalidation for item with parent path ["+[].concat((0,ne.default)(C.parentPath),[C.id])+"]"}),{v:void 0};U().stop(j.InvalidateWorkflow),f.queueOrSetScopeExecutionNotification(!u&&!f.isWaitingForUpstreamWorkflows(s),[].concat((0,ne.default)(C.parentPath),[C.id]),s,a,d,!1,void 0,l==null?void 0:l.triggerSignals)},p;for(var k of t)if(p=h(k),p)return p.v}},{key:"getAreaIntersectionFilter",value:function(t){var a=this;return function(s){return a.supportsAreaIntersection(s.body)&&a.areasIntersect(s.body,t)}}},{key:"isWaitingForUpstreamWorkflows",value:function(t){var a;return(a=t.workflow.triggerConditions)===null||a===void 0?void 0:a.includes(Lt.UpstreamWorkflowsReady)}},{key:"isReadyToEarlyJoin",value:function(t,a){var s=Vy.getValue(),u=function(p){var k,S=Array.from((k=p.states)!==null&&k!==void 0?k:[]).map(function(T){return T[0]+": "+T[1].map(function(x){return x.join()})}).join(";"),C=new D({operationName:"EarlyJoinCompletion",resourceId:t.workflow.id,joinContextId:a,success:!0}).start();C.resultDescription="isReadyToEarlyJoin ("+s+") -> hasProcessedAllInputItems: "+p.hasProcessedAllInputItems+", allUpstreamComplete: "+p.allUpstreamComplete+", states: "+S,v.info(512550801,y.CoreDefault,C.stop())},l=t.countItemsToProcess(a)===0;if(!l)return u({hasProcessedAllInputItems:l}),!1;var f=this.areAllUpstreamWorkflowComplete(t,a),c=f.allUpstreamComplete,d=f.states;return u({hasProcessedAllInputItems:l,allUpstreamComplete:c,states:d}),s?c:!1}},{key:"areAllUpstreamWorkflowComplete",value:function(t,a){var s=new Map;for(var u of t.allUpstreamWorkflowExecutionTrackers){var l=u.workflowExecutionTracker,f=[];for(var c of l.getExecutionState()){var d=(0,Ft.default)(c,2),h=d[0],p=d[1];if(f.push([h,p]),Nt.isParentContextId(a,h))return s.set(l.workflow.id,f),{allUpstreamComplete:!1,states:s}}f.length>0&&s.set(l.workflow.id,f)}return{allUpstreamComplete:!0,states:s}}},{key:"isAnyContextProducerRunning",value:function(t,a){for(var s of a)if(t.contextProducerPendingExecCountByScope.get(G(s))>0)return!0;return!1}},{key:"invalidateJoinWorkflow",value:function(t,a,s){var u=this,l=function(d){var h,p,k=[].concat((0,ne.default)(d.parentPath),[d.id]),S=a.workflow;if(a.invalidationFilter&&a.invalidationFilter(d)===!1){v.info(537678274,y.CoreDefault,function(){return"Filtered out join invalidation for item with parent path ["+k+"]"});return}var C=d.contextId;if(m.matchesTypesFor(d.body,[S.collectionScopeType])){var T=d;u.workflowItemStorage.setScopeItem(T,S),v.info(537678275,y.CoreDefault,function(){return"WEM.invalidateJoinWorkflow :: Scope item: "+d.id+" ("+m.getTypeNameFor(d.body)+"), workflow: "+S.id+", contextId: "+C}),U().stop(j.InvalidateWorkflow),u.queueOrSetScopeExecutionNotification(!1,[].concat((0,ne.default)(T.parentPath),[T.id]),a,t,!0,(h=s.reInvalidateAfterDebounce)!==null&&h!==void 0?h:!1,[{item:T,isDeltaUpdate:s.isDeltaUpdate,opType:s.opType}],s==null?void 0:s.triggerSignals)}else{t.removeProcessedInputItem(C);var x=u.workflowItemStorage.getScopeItem(C,S);if(!x){v.info(537678276,y.CoreDefault,function(){return"There is no scope item stored for workflow: "+S.id+", contextId: "+C});return}v.info(537678277,y.CoreDefault,function(){return"WEM.invalidateJoinWorkflow :: Input item: "+d.id+" ("+m.getTypeNameFor(d.body)+"), workflow: "+S.id+", contextId: "+C}),u.workflowItemStorage.addItemToWorkflowList(d,S);var A=u.isReadyToEarlyJoin(t,x.contextId);if(u.workflowItemStorage.isWorkflowReady(x.contextId,S)||A){var b=L("NotificationManager")?u.notificationManager.get(S.id,x.contextId):(p=u.pendingScopeExecutionNotificationsByWorkflow.get(S.id))===null||p===void 0?void 0:p.get(x.contextId);if(!b){v.info(537678278,y.CoreDefault,"Workflow "+S.id+", contextId "+x.contextId+", already queued, skipping new scope execution");return}U().stop(j.InvalidateWorkflow),u.tryToQueueExecutionNotification(b,function(){},L("EnableRequestedContextForJoinWorkflows")?u.resolveAndValidateContextsAndEvents.bind(u):function(E,I){return[!0,!0,[]]},!1)&&(L("NotificationManager")?u.notificationManager.delete(S.id,x.contextId):(u.pendingScopeExecutionNotificationsByWorkflow.get(S.id).delete(x.contextId),u.pendingScopeExecutionNotificationsByWorkflow.get(S.id).size===0&&u.pendingScopeExecutionNotificationsByWorkflow.delete(S.id)))}}};if(s!=null&&s.item)l(s.item);else if(a.workflow.inputStage===Zt.OnSeed&&s.triggerSignals===void 0)for(var f of this.sessionCache.getSubtreeItems([],[a.workflow.collectionScopeType]))l(f)}},{key:"invalidateGenericWorkflow",value:function(t,a,s){var u,l,f,c=this.isWorkflowWithDelay(a.workflow),d=void 0;if(s!=null&&s.item){var h=void 0;if(a.workflow.dynamicExecutionPreferences)h=s.item.parentPath,d=[s.item.id];else{var p=this.sessionCache.getFirstAncestorOfType([].concat((0,ne.default)(s.item.parentPath),[s.item.id]),[a.workflow.collectionScopeType]);if(p)h=[].concat((0,ne.default)(p.parentPath),[p.id]);else return}U().stop(j.InvalidateWorkflow),this.queueOrSetScopeExecutionNotification(!1,h,a,t,!1,(u=s.reInvalidateAfterDebounce)!==null&&u!==void 0?u:!1,void 0,s==null?void 0:s.triggerSignals,d)}else{var k=!(!((l=s==null?void 0:s[0])===null||l===void 0)&&l.updatedContextScope),S=new Set;if(a.workflow.dynamicExecutionPreferences){var C=this.sessionCache.getSubtreeItems([],a.workflow.inputTypes);for(var T of C)S.add(T.parentPath)}else{var x=this.sessionCache.getSubtreeItems((f=s==null?void 0:s.updatedContextScope)!==null&&f!==void 0?f:[],[a.workflow.collectionScopeType]);for(var A of x||[])S.add([].concat((0,ne.default)(A.parentPath),[A.id]))}U().stop(j.InvalidateWorkflow);for(var b of S||[])this.queueOrSetScopeExecutionNotification(!c&&!this.isWaitingForUpstreamWorkflows(a),b,a,t,k,!1,void 0,s==null?void 0:s.triggerSignals,d)}}},{key:"validateExecution",value:function(t,a){var s,u,l,f=U().startSync(j.ValidateWorkflowExecution);try{var c=t.registration.workflow.triggerConditions;if(((s=t.triggerSignals)===null||s===void 0?void 0:s.length)>0&&!(c!=null&&c.includes(Lt.UpstreamWorkflowsReady)))return!0;if(L("EnableTriggerConditionDeltaUpdate")&&t.minTime&&!t.reInvalidateAfterDebounce&&!this.meetsDelayCondition(t)||!L("EnableTriggerConditionDeltaUpdate")&&t.registration.workflow.minDelayMs!==void 0&&t.registration.workflow.maxDelayMs!==void 0&&!t.reInvalidateAfterDebounce&&!this.meetsDelayCondition(t)||c!=null&&c.includes(Lt.UpstreamWorkflowsReady)&&t.registration.workflow.kind!=q.SingleItem&&!this.meetsUpstreamWorkflowsReadyCondition(t.registration.workflow.id,t.scopePath))return!1;if(t.registration.workflow.kind===q.Join||vr(t.registration.workflow)){var d=Date.now(),h=t.registration.workflow,p=t.params[0].item.contextId,k=this.workflowDefinitionManager.getWorkflowDefinition(h,p).maxDelayMs;return this.workflowItemStorage.isWorkflowReady(p,h)?(v.info(537678279,y.CoreDefault,"Workflow: "+h.id+" queuing by maxAnnotation, contextId: "+p),!0):t.startTime+k<d?(v.info(537678280,y.CoreDefault,"Workflow: "+h.id+" queuing by maxTimeout, contextId: "+p+", timeout: "+k),!0):this.isReadyToEarlyJoin(this.workflowExecutionTrackersByName.get(h.id),p)?(v.info(512557890,y.CoreDefault,"Workflow: "+h.id+" queuing by early completion, contextId: "+p+", timeout: "+k),!0):!1}return!(!a&&(L("NotificationManager")?this.notificationManager.get(t.registration.workflow.id,G(t.scopePath)):!((l=(u=this.pendingScopeExecutionNotificationsByWorkflow)===null||u===void 0?void 0:u.get(t.registration.workflow.id))===null||l===void 0)&&l.get(G(t.scopePath))))}finally{U().stop(f)}}},{key:"meetsDelayCondition",value:function(t){var a=Date.now();return t.minTime===void 0||a>t.minTime}},{key:"meetsUpstreamWorkflowsReadyCondition",value:function(t,a){return this.workflowExecutionTrackersByName.get(t).areUpstreamWorkflowsReadyByScope(a)}},{key:"onExecutionStateChange",value:function(t,a,s){a!==s&&this.emit("executionStateChange",t,a)}},{key:"ensureSweepTimer",value:function(t){this.sweepTimer||(this.sweepTimer=setInterval(this.onSweep.bind(this),this.sweepIntervalMs),this.sweepTimer.unref&&this.sweepTimer.unref(),t&&this.emit("pendingNotificationsChange",!1))}},{key:"onSweep",value:function(){this.emit("sweep"),this.sweepScopeExecutionNotifications()}},{key:"cancelSweepTimer",value:function(){this.sweepTimer&&(clearInterval(this.sweepTimer),this.sweepTimer=void 0)}},{key:"shouldSkipExecutionOnDeletedItem",value:function(t){return t.opType!==pn.getTypeName()&&t.opType!==Ze.getTypeName()&&!this.sessionCache.hasItem([].concat((0,ne.default)(t.item.parentPath),[t.item.id]))}},{key:"removeParamsForExecutionOnDeletedItem",value:function(t,a){var s;if(L("EnableSkippingWorkflowExecutionForMissingItem")&&(t.registration.workflow.kind===q.SingleItem||t.registration.workflow.kind===q.Join)&&!Tn(t.registration.workflow)){var u=(s=t.params)!==null&&s!==void 0?s:[],l=[];for(var f of u)this.shouldSkipExecutionOnDeletedItem(f)?(v.info(512296736,y.CoreDefault,"Invalidate Workflow Param for workflow "+t.registration.workflow.id+" scopeItem is missing or deleted - skipping adding workflow param to execution."),a&&this.workflowExecutionTrackersByName.get(t.registration.workflow.id).onExecutionTaskCompleted([].concat((0,ne.default)(f.item.parentPath),[f.item.id]),this.sessionCache.getFirstAncestorOfType.bind(this.sessionCache))):l.push(f);return t.params=l,l.length===0}return!1}},{key:"sweepScopeExecutionNotifications",value:function(){var t=this,a=!0,s=void 0,u=function(k,S){return t.resolveAndValidateContextsAndEvents(k,S,s)},l=function(k){var S=function(E,I){var _=function(){var N=U(),R=N.find(j.WaitingForPendingScopeExecution);N.stop(R),!s&&t.isWorkflowRequestingContexts(I.registration.workflow)&&(s=t.getAllDocumentContextHolderPaths());var P=t.removeParamsForExecutionOnDeletedItem(I,!0);P||t.tryToQueueExecutionNotification(I,function(){},u,!0)?L("NotificationManager")?t.notificationManager.delete(k,E):(t.pendingScopeExecutionNotificationsByWorkflow.get(k).delete(E),t.pendingScopeExecutionNotificationsByWorkflow.get(k).size===0&&t.pendingScopeExecutionNotificationsByWorkflow.delete(k)):(N.resume(R),a=!1)};L("ResumeCorrelationForSweepScopeExecutionNotifications")?Re(function(){_()},I.cc):_()};for(var C of h.entries()){var T=(0,Ft.default)(C,2),x=T[0],A=T[1];S(x,A)}};for(var f of L("NotificationManager")?this.notificationManager.entries():this.pendingScopeExecutionNotificationsByWorkflow.entries()){var c=(0,Ft.default)(f,2),d=c[0],h=c[1];l(d)}a&&(v.debug(537678281,y.CoreDefault,"No pending scope notifications left, cancelling sweep timer"),this.emit("pendingNotificationsChange",!0),this.cancelSweepTimer())}},{key:"tryToQueueExecutionNotification",value:function(t,a,s,u){var l=this,f,c,d,h=U(),p=h.startSync(j.QueueExecutionNotification);try{if(!this.validateExecution(t,u))return!1;var k=function(J){l.workflowExecutionTrackersByName.get(t.registration.workflow.id).onExecutionTaskCompleted(J,l.sessionCache.getFirstAncestorOfType.bind(l.sessionCache))},S=s(t.registration,t.scopePath),C=(0,Ft.default)(S,3),T=C[0],x=C[1],A=C[2];if(!x){if(u)if(t.registration.workflow.kind===q.SingleItem){var b=(f=t.params)!==null&&f!==void 0?f:[];for(var E of b)k([].concat((0,ne.default)(E.item.parentPath),[E.item.id]))}else k(t.scopePath);return!0}if(!T)return!1;try{if(t.registration.workflow.kind===q.SingleItem){var I=(c=t.params)!==null&&c!==void 0?c:[];for(var _ of I)a([].concat((0,ne.default)(_.item.parentPath),[_.item.id]));this.queueSingleItemWorkflow(t.registration,I,A)}else if(t.registration.workflow.kind===q.Reduce||t.registration.workflow.kind===q.Grid)try{var M=this.sessionCache.getItem(t.scopePath);a(t.scopePath),this.queueReduceWorkflow(t.registration,Ct(t.scopePath.slice(0,-1),M),t.triggerSignals,A,t.isTriggeredByEvents,k,G(t.scopePath))}catch(z){v.debug(537678282,y.CoreDefault,"Subtree no longer exists, skipping queue workflow execution")}else if(t.registration.workflow.kind===q.DynamicText)a(t.scopePath),this.queueDynamicWorkflow(t.registration,t.scopePath,t.dynamicItemIds,A,t.isTriggeredByEvents,k);else if(t.registration.workflow.kind===q.Join){var N=t.params[0].item.contextId,R=this.workflowItemStorage.getScopeItem(N,t.registration.workflow);R?(a([].concat((0,ne.default)(R.parentPath),[R.id])),this.queueJoinWorkflow(t.registration,R,A,k,N)):v.debug(537678283,y.CoreDefault,"ContextId no longer exists, skipping queue workflow execution")}else t.registration.workflow.kind==q.Generic?this.queueGenericWorkflow(t,a,A,k):v.error(537678284,y.CoreDefault,"Workflow in type "+t.registration.workflow.kind+" is not supported")}catch(z){if(u)if(t.registration.workflow.kind===q.SingleItem){var P=(d=t.params)!==null&&d!==void 0?d:[];for(var O of P)k([].concat((0,ne.default)(O.item.parentPath),[O.item.id]))}else k(t.scopePath);v.warn(537678285,y.CoreDefault,"Trying to queue "+t.registration.workflow.id+" caused an exception: "+z)}return!0}finally{h.stop(p)}}},{key:"isDeltaTriggeredWorkflow",value:function(t){var a;return(a=this.workflowDefinitionManager.getWorkflowDefinition(t.workflow).triggerConditions)===null||a===void 0?void 0:a.includes(Lt.DeltaUpdate)}},{key:"calculateWorkflowMinAndMaxStartTime",value:function(t,a){var s=void 0;this.isWorkflowWithDelay(t.workflow)?s={minDelayMs:t.workflow.minDelayMs,maxDelayMs:t.workflow.maxDelayMs}:this.enableDeltaUpdateDelay.getValue()&&!this.isDeltaTriggeredWorkflow(t)&&(a!=null&&a.every(function(c){return c.isDeltaUpdate}))&&(s=P_());var u=Date.now(),l=s!=null&&s.minDelayMs?u+s.minDelayMs:void 0,f=u+Ui(s==null?void 0:s.maxDelayMs,5e3);return{notificationStartTime:u,minTime:l,maxTime:f}}},{key:"queueOrSetScopeExecutionNotification",value:function(t,a,s,u,l,f,c,d,h){var p=this,k,S=U().startSync(j.QueueOrSetScopeExecutionNotification),C,T,x;if(L("EnableTriggerConditionDeltaUpdate")){var A=this.calculateWorkflowMinAndMaxStartTime(s,c);x=A.notificationStartTime,C=A.minTime,T=A.maxTime}else x=Date.now(),C=x+Ui(s.workflow.minDelayMs,1e3),T=x+Ui(s.workflow.maxDelayMs,5e3);var b={registration:s,scopePath:a,params:c,triggerSignals:d!=null?d:[],startTime:x,minTime:L("IgnoreMinTimeWorkflowExecution")&&l?void 0:C,maxTime:T,dynamicItemIds:h?new Set(h):void 0,reInvalidateAfterDebounce:f,isTriggeredByEvents:(k=c==null?void 0:c[0])===null||k===void 0?void 0:k.isInvalidatedByEvents,cc:et()},E=function(M){u.invalidateWorkflow(M,p.sessionCache.getFirstAncestorOfType.bind(p.sessionCache))};U().stop(S);var I=!1;(t||f)&&(I=this.tryToQueueExecutionNotification(b,E,this.resolveAndValidateContextsAndEvents.bind(this),!1)),I||this.setScopeExecutionNotification(a,s,E,b)}},{key:"setScopeExecutionNotification",value:function(t,a,s,u){var l=U().startSync(j.SetScopeExecutionNotification),f=void 0;u.params&&u.params[0].item.contextId&&(f=u.params[0].item.contextId);var c=G(t);f&&(a.workflow.kind===q.Join||vr(a.workflow))&&(c=f),L("NotificationManager")||this.pendingScopeExecutionNotificationsByWorkflow.get(a.workflow.id)||this.pendingScopeExecutionNotificationsByWorkflow.set(a.workflow.id,new Map);var d=L("NotificationManager")?this.notificationManager.get(a.workflow.id,c):this.pendingScopeExecutionNotificationsByWorkflow.get(a.workflow.id).get(c);if(d)(!L("IgnoreMinTimeWorkflowExecution")||d.minTime)&&(d.minTime=u.minTime?Math.min(u.minTime,Ui(d.maxTime,u.maxTime)):void 0),u.reInvalidateAfterDebounce?(d.triggerSignals=u.triggerSignals.concat(d.triggerSignals),d.reInvalidateAfterDebounce=u.reInvalidateAfterDebounce):d.triggerSignals=d.triggerSignals.concat(u.triggerSignals),d.registration.workflow.dynamicExecutionPreferences&&u.dynamicItemIds!==void 0&&u.dynamicItemIds.forEach(function(p){return d.dynamicItemIds.add(p)}),L("ScopeExecutionNotificationUpdateParams")&&d.registration.workflow.kind===q.SingleItem&&this.updateScopeNotificationParams(d,u),a.workflow.kind===q.Join&&v.info(537678288,y.CoreDefault,"Dropping new scope notification for "+a.workflow.id+": "+c+", contextId: "+f);else if(v.info(537678286,y.CoreDefault,function(){return"New pending scope execution for "+a.workflow.id+" at "+c+" "+(a.workflow.kind===q.Join||vr(a.workflow)?", ("+f+")":"")}),L("NotificationManager")?this.notificationManager.set(a.workflow.id,c,u):this.pendingScopeExecutionNotificationsByWorkflow.get(a.workflow.id).set(c,u),a.workflow.kind==q.SingleItem)for(var h of u.params)s([].concat((0,ne.default)(h.item.parentPath),[h.item.id]));else s(t);U().stop(l),d||U().startAsync(j.WaitingForPendingScopeExecution),this.ensureSweepTimer(!0)}},{key:"updateScopeNotificationParams",value:function(t,a){var s,u,l=new D({operationName:"setScopeExecutionNotification_updateParams",resourceId:t.registration.workflow.resourceId,success:!0}).start();try{if(L("DoNotOrderParamsByRevId")){if(a.params)if(a.reInvalidateAfterDebounce)t.params=a.params.concat(t.params);else{var f;(f=t.params).push.apply(f,(0,ne.default)(a.params))}return}if(a.params)for(var c of a.params){var d=!1;if(!((s=c.item)===null||s===void 0)&&s.revId){for(var h of t.params)if(!((u=h.item)===null||u===void 0)&&u.revId&&c.item.id===h.item.id){d=!0,parseInt(c.item.revId,10)>parseInt(h.item.revId,10)&&(h.item=c.item);break}}d||t.params.push(c)}}finally{v.info(537678287,y.CoreDefault,l.stop())}}},{key:"fetchInputChanges",value:function(t,a,s){var u=this,l;if(!((l=t.modelOptions)===null||l===void 0)&&l.includeItemOperations){var f=new D({operationName:"FetchInputChanges",success:!0,resourceId:t.id}).start(),c=[].concat((0,ne.default)(s.parentPath),[s.id]);this.inputChangesManager.setWorkflowInputs(a.map(function(C){var T=m.getTypeNameFor(C.body);return{path:[].concat((0,ne.default)(C.parentPath),[C.id]),deltaType:u.getDeltaType(T,t)}}),t.id,c);for(var d=this.inputChangesManager.getChanges(t.id,c),h=0,p=0;h<a.length&&p<d.length;){var k=Object.assign({},a[h]),S=d[p];if(S.op!==ct.Deleted){if(G([].concat((0,ne.default)(k.parentPath),[k.id]))!==G([].concat((0,ne.default)(S.parentPath),[S.id])))throw new Error("Input changes are not in order with input items.");k.op=S.op,k.delta=S.delta,d[p]=k,h++}p++}return f.stop().durationMs>10&&v.info(537678289,y.CoreDefault,f),d}}},{key:"getDeltaType",value:function(t,a){var s,u,l=(s=a.deltaTypesByInputType)===null||s===void 0?void 0:s[t];return!l&&(!((u=a.modelOptions)===null||u===void 0)&&u.includeDefaultItemDeltas)&&(l=U_.get(t)),l}},{key:"fetchParentItem",value:function(t,a){var s,u;if(!(!(!((s=t.modelOptions)===null||s===void 0)&&s.includeScopeItemParent)&&!(!((u=t.modelOptions)===null||u===void 0)&&u.includeRootItemParent)))try{var l=this.sessionCache.getItem(a.parentPath);return Ct(a.parentPath.slice(0,-1),l)}catch(c){var f="Fetching parent item with path: "+G(a.parentPath)+". Error: "+c;throw v.error(537678290,y.CoreDefault,f),new Error(f)}}},{key:"queueSingleItemWorkflowTask",value:function(t,a){var s=U(),u=s.find(j.QueueExecutionNotification),l=this.workflowSynchronizationManager.notifyBeforeQueueing(a,t);if(l){this.workflowExecutionTrackersByName.get(t.workflow.id).setExecutionState(a.scopeItem.contextId,ve.Running);var f=this.evaluatePrefilters(t.workflow,a,Dt.WithActionDefinition);a.prefilterActionResults=f.prefilterActionResults;var c=!f.shouldExecuteWorkflow;s.stop(u),this.queueWorkflow(t,[a],c),s.resume(u)}}},{key:"queueSingleItemWorkflowTasksWithBatching",value:function(t,a){var s=this,u=U(),l=u.find(j.QueueExecutionNotification),f=this.workflowSynchronizationManager.notifyBeforeBatchedQueuing(a,t);if(f.length>0){f.forEach(function(S){return s.workflowExecutionTrackersByName.get(t.workflow.id).setExecutionState(S.scopeItem.contextId,ve.Running)});var c=this.prefilterAndSplitTasksBeforeQueing(t,f),d=c.workflowTasks,h=c.prefilteredTasks;for(var p of this.batchSplitter.getBatchesByItemPath(d,this.workflowBatchSizeMax,function(S){return S.scopeItem}))u.stop(l),this.queueWorkflow(t,p),u.resume(l);for(var k of this.batchSplitter.getBatches(h,this.workflowBatchSizeMax))u.stop(l),this.queueWorkflow(t,k,!0),u.resume(l)}}},{key:"queueSingleItemWorkflow",value:function(t,a,s){var u=this;if(vr(t.workflow)){this.queueHybridSingleItemWorkflow(t,a,s);return}if(this.usesRefactoredDebouncing){var l=a.map(function(S){return u.createSingleItemWorkflowTask(S,t,s)});l.length===1?this.queueSingleItemWorkflowTask(t,l[0]):this.queueSingleItemWorkflowTasksWithBatching(t,l)}else{var f=U(),c=f.find(j.QueueExecutionNotification),d=[];for(var h of this.batchSplitter.getBatchesByItemPath(a,this.workflowBatchSizeMax,function(S){return S.item})){var p=function(C){var T=[].concat((0,ne.default)(C.item.parentPath),[C.item.id]),x=u.fetchParentItem(t.workflow,C.item);u.workflowExecutionTrackersByName.get(t.workflow.id).setExecutionState(C.item.contextId,ve.Running);var A={scopeItem:C.item,inputItems:x?[C.item,x]:[C.item],requestedContextsAndEvents:s,executionScopeId:u.shouldSkipSynchronization(C)?void 0:G(T),previousAnnotations:e.fetchExistingAnnotations(t.workflow,T,u.sessionCache),onComplete:function(){return u.onExecutionTaskCompleted(t.workflow.id,C.item)},extensibleWorkflowContext:u.getExtensibleWorkflowContext(),isTriggeredByEvents:!1,status:Ve.Pending,opType:C.opType};d.push(A)};for(var k of h)p(k);f.stop(c),this.queueWorkflow(t,d),f.resume(c),d=[]}}}},{key:"createSingleItemWorkflowTask",value:function(t,a,s){var u=this,l=[].concat((0,ne.default)(t.item.parentPath),[t.item.id]),f=this.fetchParentItem(a.workflow,t.item),c={scopeItem:t.item,inputItems:f?[t.item,f]:[t.item],requestedContextsAndEvents:s,executionScopeId:this.shouldSkipSynchronization(t)?void 0:G(l),previousAnnotations:e.fetchExistingAnnotations(a.workflow,l,this.sessionCache),onComplete:function(){return u.onExecutionTaskCompleted(a.workflow.id,t.item)},extensibleWorkflowContext:this.getExtensibleWorkflowContext(),isTriggeredByEvents:!1,status:Ve.Pending,opType:t.opType,maxSynchronizationEndTimeMs:t.maxSynchronizationEndTimeMs};return c}},{key:"getExtensibleWorkflowContext",value:function(){if(L("OfficeVSO:7713714_EnableFetchGetRangeFromEcs")){var t=["session","ext-"+Uh];return this.sessionCache.hasItem(t)?this.sessionCache.getItem(t).body:void 0}}},{key:"queueHybridSingleItemWorkflow",value:function(t,a,s){var u=this,l=function(){var h=c.item,p=u.workflowItemStorage.getItemsToExecute(h.contextId,t.workflow);if(p.length===0)return u.workflowItemStorage.onWorkflowExecuted(h,t.workflow),v.info(525218564,y.CoreDefault,"Failed to retrieve items for workflow: "+t.workflow.id+", contextId: "+h.contextId),{v:void 0};if(u.usesRefactoredDebouncing){var k=[].concat((0,ne.default)(h.parentPath),[h.id]),S={scopeItem:h,inputItems:[h],requestedContextsAndEvents:s,executionScopeId:u.shouldSkipSynchronization(c)?void 0:G(k),previousAnnotations:e.fetchExistingAnnotations(t.workflow,k,u.sessionCache),onComplete:function(){return u.onExecutionHybridSingleItemTaskCompleted(t.workflow,h)},extensibleWorkflowContext:u.getExtensibleWorkflowContext(),isTriggeredByEvents:!1,status:Ve.Pending},C=u.workflowSynchronizationManager.notifyBeforeQueueing(S,t);if(C){v.info(525218565,y.CoreDefault,"WEM.queueHybridSingleItemWorkflow :: "+t.workflow.id+" queued input: "+h.id+", contextId: "+h.contextId+", correlatedSignal: "+p[0].id),u.workflowExecutionTrackersByName.get(t.workflow.id).setExecutionState(h.contextId,ve.Running);var T=u.evaluatePrefilters(t.workflow,S,Dt.WithActionDefinition);S.prefilterActionResults=T.prefilterActionResults;var x=!T.shouldExecuteWorkflow;u.queueWorkflow(t,[S],x)}}else v.info(509747276,y.CoreDefault,"WEM.queueHybridSingleItemWorkflow :: "+t.workflow.id+" queued input: "+h.id+", contextId: "+h.contextId+", correlatedSignal: "+p[0].id),u.workflowExecutionTrackersByName.get(t.workflow.id).setExecutionState(h.contextId,ve.Running),u.queueWorkflow(t,[{scopeItem:h,inputItems:[h],requestedContextsAndEvents:s,executionScopeId:u.shouldSkipSynchronization(c)?void 0:G([].concat((0,ne.default)(c.item.parentPath),[c.item.id])),previousAnnotations:e.fetchExistingAnnotations(t.workflow,[].concat((0,ne.default)(c.item.parentPath),[c.item.id]),u.sessionCache),onComplete:function(){return u.onExecutionHybridSingleItemTaskCompleted(t.workflow,h)},extensibleWorkflowContext:u.getExtensibleWorkflowContext(),isTriggeredByEvents:!1,status:Ve.Pending}])},f;for(var c of a)if(f=l(),f)return f.v}},{key:"getContextHolderPaths",value:function(t){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:void 0,s=L("AddSessionAsContextHolder")?[this.getUserNodePath(),this.getTenantNodePath(),["session"]]:[this.getUserNodePath(),this.getTenantNodePath()],u=[].concat(s),l=[],f=a!=null?a:this.getAllDocumentContextHolderPaths();if(t)for(var c of f)to(c,t)?u.push(c):to(t,c)&&l.push(c);else u=u.concat(f);return[u,l]}},{key:"getAllDocumentContextHolderPaths",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"session",a;return((a=this.sessionCache.getSubtreeItems([t],[Mt.getTypeName(),Pn.getTypeName(),ro.getTypeName()]))!==null&&a!==void 0?a:[]).map(function(s){return[].concat((0,ne.default)(s.parentPath),[s.id])})}},{key:"getAllContexts",value:function(t){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[],s,u=[];for(var l of t){var f=(s=this.sessionCache.getItemChildren(l,a))!==null&&s!==void 0?s:[];if(u.push.apply(u,f),L("ContextHolderAsSelfContext")){var c=this.sessionCache.getItem(l);c!=null&&c.body&&m.matchesTypesFor(c.body,a)&&u.push(Ct(l.slice(0,-1),c))}}return u}},{key:"resolveAndValidateAllRequestedContexts",value:function(t,a){var s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:void 0,u=U().startSync(j.ResolveAndValidateAllRequestedContexts);try{var l=[];if(this.isWorkflowRequestingContexts(t.workflow)){var f=this.getContextHolderPaths(a,s),c=(0,Ft.default)(f,2),d=c[0],h=c[1],p=Xn(this.workflowDefinitionManager.getWorkflowDefinition(t.workflow).requestedContextTypesRules),k=p.map(function(E){var I=(0,Ft.default)(E,2),_=I[0],M=I[1];return _});l=this.getAllContexts(d,k);var S=L("FixRequiredContextBaseTypes")?new Set(l.flatMap(function(E){return m.getAllTypesFor(E.body)})):new Set(l.map(function(E){return m.getTypeNameFor(E.body)}));for(var C of p){var T=(0,Ft.default)(C,3),x=T[0],A=T[1],b=T[2];if(A==cr.Required&&!S.has(x))return[!1,[]];if(b===yo.Always&&this.isAnyContextProducerRunning(this.workflowExecutionTrackersByName.get(t.workflow.id),d))return[!1,[]]}l=l.concat(this.getAllContexts(h,k))}return[!0,l]}finally{U().stop(u)}}},{key:"getRequestedEvents",value:function(t){var a=this.sessionCache.getItemChildren(this.getUserCommandsNodePath(),[Mr.getTypeName()]);return a=a.filter(function(s){return ds(s.body,t)}),a.sort(function(s,u){return s.body.timestamp-u.body.timestamp}),t.maxWindowSize&&(a=a.slice(-t.maxWindowSize)),a}},{key:"resolveAndValidateEvents",value:function(t){var a,s;if(!L("EnableUserCommands"))return[!0,[]];var u=[];if(t.workflow.eventSequenceOptions){var l=t.workflow.eventSequenceOptions;if(Date.now()-this.sessionCreationTime<((a=l.minTimeFrame)!==null&&a!==void 0?a:0))return[!l.required,[]];if(u=this.getRequestedEvents(l),u.length<((s=l.minWindowSize)!==null&&s!==void 0?s:1))return[!l.required,[]]}return[!0,u]}},{key:"resolveAndValidateContextsAndEvents",value:function(t,a){var s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:void 0,u=this.resolveAndValidateAllRequestedContexts(t,a,s),l=(0,Ft.default)(u,2),f=l[0],c=l[1],d=this.resolveAndValidateEvents(t),h=(0,Ft.default)(d,2),p=h[0],k=h[1],S=p&&f;return[f,p,S?c.concat(k):[]]}},{key:"isWorkflowRequestingContexts",value:function(t){var a;return((a=this.workflowDefinitionManager.getWorkflowDefinition(t).requestedContextTypesRules)!==null&&a!==void 0?a:[]).some(function(s){return s.contextTypes.length>0})}},{key:"getDeepestDocumentContextHolderPath",value:function(t,a){var s,u=void 0,l=[].concat((0,ne.default)(a.parentPath),[a.id]);for(var f of t)to(f,l)&&f.length>((s=u==null?void 0:u.length)!==null&&s!==void 0?s:0)&&(u=f);return u}},{key:"isWorkflowWithDelay",value:function(t){return!(t.minDelayMs===void 0&&t.maxDelayMs===void 0)}},{key:"shouldSkipSynchronization",value:function(t){var a;return t.opType===pn.getTypeName()||O_.getValue()&&((a=t.item)===null||a===void 0?void 0:a.delta)!==void 0}},{key:"fetchExistingAnnotationsForItems",value:function(t,a){var s=this,u;if(!(!t.fetchExistingAnnotations&&!(!((u=t.modelOptions)===null||u===void 0)&&u.includeExistingAnnotations))){var l=new D({operationName:"FetchExistingAnnotationsForItems",success:!0,resourceId:t.id}).start(),f=[];return a.forEach(function(c){var d=e.fetchExistingAnnotations(t,[].concat((0,ne.default)(c.parentPath),[c.id]),s.sessionCache);d==null||d.forEach(function(h){f.push(h)})}),l.stop().durationMs>10&&v.info(527524321,y.CoreDefault,l),f.length>0?f:void 0}}},{key:"queueReduceWorkflow",value:function(t,a,s,u,l,f,c){var d=this,h,p,k=[].concat((0,ne.default)(a.parentPath),[a.id]),S=[];if(!L("FixReduceWorkflowWithoutInputs")||((h=t.workflow.inputTypes)===null||h===void 0?void 0:h.length)>0)try{if(L("OfficeVSO:8048430_ImplementIntersectionInExecutionManager")&&this.supportsAreaIntersection(a.body)){var C=this.getAreaIntersectionFilter(a.body),T=this.sessionCache.getSubtreeItems([],t.workflow.inputTypes,C),x=this.sessionCache.getSubtreeItems(k,t.workflow.inputTypes);S=(0,ne.default)(new Set(T.concat(x)));var A=S.length-T.length;v.info(508597976,y.CoreDefault,"queueReduceWorkflow: Using intersection for workflow '"+t.workflow.id+"' , #itemsByRootPath: '"+T.length+"', #itemsByRootPath: '"+A+"'")}else S=this.sessionCache.getSubtreeItems(k,t.workflow.inputTypes)}catch(R){v.error(537678291,y.CoreDefault,"Failed to retrieve subtree items for executing workflow "+t.workflow.id+": "+R.message),f(k);return}if(t.workflow.kind===q.Reduce||t.workflow.kind==q.Generic){var b={scopeItem:a,inputItems:(p=this.fetchInputChanges(t.workflow,S,a))!==null&&p!==void 0?p:S,requestedContextsAndEvents:u,executionScopeId:c,triggerSignals:s,previousAnnotations:this.fetchExistingAnnotationsForItems(t.workflow,[a].concat((0,ne.default)(S))),onComplete:function(){return d.onExecutionTaskCompleted(t.workflow.id,a)},extensibleWorkflowContext:this.getExtensibleWorkflowContext(),isTriggeredByEvents:l,status:Ve.Pending};if(!this.evaluatePrefilters(t.workflow,b,Dt.WithoutActionDefinition).shouldExecuteWorkflow){v.verbose(523351809,y.CoreDefault,function(){return"Filtered out workflow "+t.workflow.id+" invalidation based on prefilter."}),f(k);return}if((!b.inputItems||b.inputItems.length===0)&&v.info(527237130,y.CoreDefault,"Workflow: '"+t.workflow.id+"' queued with no inputs."),this.usesRefactoredDebouncing){var E=this.workflowSynchronizationManager.notifyBeforeQueueing(b,t);if(!E){U().stop(j.QueueExecutionNotification);return}var I=this.evaluatePrefilters(t.workflow,b,Dt.WithActionDefinition);b.prefilterActionResults=I.prefilterActionResults;var _=!I.shouldExecuteWorkflow;this.workflowExecutionTrackersByName.get(t.workflow.id).setExecutionState(a.contextId,ve.Running),U().stop(j.QueueExecutionNotification),this.queueWorkflow(t,[b],_)}else this.workflowExecutionTrackersByName.get(t.workflow.id).setExecutionState(a.contextId,ve.Running),U().stop(j.QueueExecutionNotification),this.queueWorkflow(t,[b])}else{var M=S.filter(function(R){return m.matchesTypesFor(R.body,[sr.getTypeName()])}),N=S.filter(function(R){return!m.matchesTypesFor(R.body,[sr.getTypeName()])});U().stop(j.QueueExecutionNotification),this.queueGridNeighborhoodWorkflow(t,k,a,M,N,u,l,function(){d.onExecutionTaskCompleted(t.workflow.id,a)})}}},{key:"queueDynamicWorkflow",value:function(t,a,s,u,l,f){var c=this,d,h;if(t.workflow.dynamicExecutionPreferences.inputSize<-1||t.workflow.dynamicExecutionPreferences.inputSize===0){v.error(537678292,y.CoreDefault,"Workflow inputSize must be positive integers or -1."),f(a);return}var p=void 0;try{p=this.sessionCache.getItemChildren(a,[Je.getTypeName()])}catch(N){v.info(537678293,y.CoreDefault,"Failed to fetch children on parent item: "+G(a)+": "+N.message),f(a);return}if(!p||p.length===0){v.error(537678294,y.CoreDefault,"There are no children on parent item: "+G(a)),f(a);return}var k=Oy(t,s,p);if(!k){f(a);return}if((t.workflow.dynamicExecutionPreferences.contextAbove!==void 0||t.workflow.dynamicExecutionPreferences.contextBelow!==void 0)&&((d=t.workflow.dynamicExecutionPreferences)===null||d===void 0?void 0:d.contextUnit)===void 0||t.workflow.dynamicExecutionPreferences.contextAbove===void 0&&t.workflow.dynamicExecutionPreferences.contextBelow===void 0&&((h=t.workflow.dynamicExecutionPreferences)===null||h===void 0?void 0:h.contextUnit)!==void 0){v.error(537678295,y.CoreDefault,"Workflow contextUnit and at least one of workflow [contextAbove, contextBelow] must also be specified."),f(a);return}if(t.workflow.dynamicExecutionPreferences.contextAbove!==void 0&&t.workflow.dynamicExecutionPreferences.contextAbove<-1||t.workflow.dynamicExecutionPreferences.contextBelow!==void 0&&t.workflow.dynamicExecutionPreferences.contextBelow<-1){v.error(537678296,y.CoreDefault,"Workflow contextAbove/contextBelow must be integers greater than or equal to -1."),f(a);return}var S=U(),C=S.find(j.QueueExecutionNotification);if(this.usesRefactoredDebouncing){var T=[];for(var x of k){var A=this.createDynamicTextWorkflowTask(a,x,p,t,u,l);A&&T.push(A)}var b=this.workflowSynchronizationManager.notifyBeforeBatchedQueuing(T,t);for(var E of this.batchSplitter.getBatches(b,this.workflowBatchSizeMax))S.stop(C),this.queueWorkflow(t,E),S.resume(C);S.stop(C)}else{var I=[],_=function(){var R=(0,ne.default)(a);M.forEach(function(z){return R.push(z.id)});var P=void 0;if(t.workflow.dynamicExecutionPreferences.contextUnit!==void 0&&(P=c.calculateDynamicTextContent(M,p,t),!P))return 1;var O=Ct(a.slice(0,-1),c.sessionCache.getItem(a));c.workflowExecutionTrackersByName.get(t.workflow.id).setExecutionState(O.contextId,ve.Running),I.push({scopeItem:O,inputItems:M,executionScopeId:G(R),dynamicContextItems:P,requestedContextsAndEvents:u,onComplete:function(){return c.onExecutionTaskCompleted(t.workflow.id,O)},extensibleWorkflowContext:c.getExtensibleWorkflowContext(),isTriggeredByEvents:l,status:Ve.Pending}),S.stop(C),I.length>=c.workflowBatchSizeMax()&&(c.queueWorkflow(t,I),I=[]),S.resume(C)};for(var M of k)_();I.length>0&&this.queueWorkflow(t,I)}}},{key:"createDynamicTextWorkflowTask",value:function(t,a,s,u,l,f){var c=this,d=(0,ne.default)(t);a.forEach(function(k){return d.push(k.id)});var h=void 0;if(!(u.workflow.dynamicExecutionPreferences.contextUnit!==void 0&&(h=this.calculateDynamicTextContent(a,s,u),!h))){var p=Ct(t.slice(0,-1),this.sessionCache.getItem(t));return{scopeItem:p,inputItems:a,executionScopeId:G(d),dynamicContextItems:h,requestedContextsAndEvents:l,onComplete:function(){return c.onExecutionTaskCompleted(u.workflow.id,p)},isTriggeredByEvents:f,status:Ve.Pending}}}},{key:"calculateDynamicTextContent",value:function(t,a,s){var u;try{u=a.indexOf(t[0])}catch(x){v.error(537678297,y.CoreDefault,"Item "+t[0].id+" not present within parent item's children.");return}var l=s.workflow.dynamicExecutionPreferences.contextUnit,f=[],c=u-1;if(s.workflow.dynamicExecutionPreferences.contextAbove!==void 0&&s.workflow.dynamicExecutionPreferences.contextAbove>0)for(var d=s.workflow.dynamicExecutionPreferences.contextAbove,h=0;c>=0&&h<d;){var p=a[c--];l===Sn.Character?(f.unshift(p),h+=p.body?p.body.content.length:0):l===Sn.Paragraph&&(f.unshift(p),h++)}else s.workflow.dynamicExecutionPreferences.contextAbove!==void 0&&s.workflow.dynamicExecutionPreferences.contextAbove===-1&&(f=a.slice(0,u));try{u=a.indexOf(t[t.length-1])}catch(x){v.error(537678298,y.CoreDefault,"Item "+t[t.length-1].id+" not present within parent item's children.");return}c=u+1;var k=[];if(s.workflow.dynamicExecutionPreferences.contextBelow!==void 0&&s.workflow.dynamicExecutionPreferences.contextBelow>0)for(var S=s.workflow.dynamicExecutionPreferences.contextBelow,C=0;c<a.length&&C<S;){var T=a[c++];l===Sn.Character?(k.push(T),C+=T.body?T.body.content.length:0):l===Sn.Paragraph&&(k.push(T),C++)}else s.workflow.dynamicExecutionPreferences.contextBelow!==void 0&&s.workflow.dynamicExecutionPreferences.contextBelow===-1&&(k=a.slice(u+1));return{contextAbove:f,contextBelow:k}}},{key:"queueJoinWorkflow",value:function(t,a,s,u,l){var f=this,c=this.workflowItemStorage.getItemsToExecute(a.contextId,t.workflow);if(c.length===0){this.workflowItemStorage.onWorkflowExecuted(a,t.workflow),v.info(537678299,y.CoreDefault,"Failed to retrieve items for workflow: "+t.workflow.id+", contextId: "+a.contextId),u([].concat((0,ne.default)(a.parentPath),[a.id]));return}if(L("EnableSkippingWorkflowExecutionForMissingItem")&&!Tn(t.workflow)&&!Gt.typeGuard(a.body)&&!this.sessionCache.hasItem([].concat((0,ne.default)(a.parentPath),[a.id]))){this.workflowItemStorage.onWorkflowExecuted(a,t.workflow),v.info(509748545,y.CoreDefault,"Invalidate Workflow Param for workflow "+t.workflow.id+" scopeItem is missing or deleted from model cache - skipping adding workflow param to execution."),u([].concat((0,ne.default)(a.parentPath),[a.id]));return}v.info(537678300,y.CoreDefault,"WEM.queueJoinWorkflow :: "+t.workflow.id+" queued inputs ["+c.map(function(h){return h.id}).join(",")+"], contextId: "+a.contextId),this.workflowExecutionTrackersByName.get(t.workflow.id).setExecutionState(a.contextId,ve.Running),U().stop(j.QueueExecutionNotification);var d=this.usesRefactoredDebouncing?void 0:l;this.queueWorkflow(t,[{scopeItem:a,inputItems:c,requestedContextsAndEvents:s,executionScopeId:d,onComplete:function(){return f.onExecutionJoinTaskCompleted(t.workflow,a)},extensibleWorkflowContext:this.getExtensibleWorkflowContext(),isTriggeredByEvents:!1,status:Ve.Pending}])}},{key:"queueGenericWorkflow",value:function(t,a,s,u){if(t.registration.workflow.dynamicExecutionPreferences)a(t.scopePath),this.queueDynamicWorkflow(t.registration,t.scopePath,t.dynamicItemIds,void 0,t.isTriggeredByEvents,u);else try{var l=this.sessionCache.getItem(t.scopePath);a(t.scopePath),this.queueReduceWorkflow(t.registration,Ct(t.scopePath.slice(0,-1),l),t.triggerSignals,s,t.isTriggeredByEvents,u,G(t.scopePath))}catch(f){u(t.scopePath),v.debug(537678301,y.CoreDefault,"Subtree no longer exists, skipping queue workflow execution")}}},{key:"onExecutionJoinTaskCompleted",value:function(t,a){this.workflowItemStorage.onWorkflowExecuted(a,t),this.workflowDefinitionManager.deleteWorkflowDefinition(t,a.contextId),this.onExecutionTaskCompleted(t.id,a)}},{key:"onExecutionHybridSingleItemTaskCompleted",value:function(t,a){this.workflowItemStorage.onWorkflowExecuted(a,t),this.onExecutionTaskCompleted(t.id,a)}},{key:"onExecutionTaskCompleted",value:function(t,a){var s=this.workflowExecutionTrackersByName.get(t);a.contextId&&s.afterWorkflowExecution(a.contextId);try{var u=[].concat((0,ne.default)(a.parentPath),[a.id]);s.onExecutionTaskCompleted(u,this.sessionCache.getFirstAncestorOfType.bind(this.sessionCache))}catch(l){v.error(537678302,y.CoreDefault,"Failed to process workflow task completion "+t+": "+l.message)}}},{key:"onContextIdWorkflowExecutionComplete",value:function(t,a){var s=this;if(this.executionCompleteCallback&&this.executionCompleteCallback(t,a),Vy.getValue()){var u=function(){for(var f of s.workflowExecutionTrackersByName.values())if(f.workflow.kind===q.Join){for(var c of f.getExecutionState().keys())if(Nt.isParentContextId(c,a))return!0}return!1};u()&&(this.cancelSweepTimer(),this.requestSweep(),this.sweepScopeExecutionNotifications())}}},{key:"onPurgeModel",value:function(t){this.cancelSweepTimer(),this.cancelQueuedWorkflows(t),this.pendingNotifications&&(L("NotificationManager")?this.notificationManager.cancelPendingNotifications():this.pendingScopeExecutionNotificationsByWorkflow=new Map,this.emit("pendingNotificationsChange",!0));for(var a of this.workflowExecutionTrackersByName.values())a.selfPendingExecCount=0,a.upstreamPendingExecCountByScope=new Map}},{key:"cancelQueuedWorkflows",value:function(t){var a=this,s=new D({operationName:"CancelQueuedWorkflowsOnPurge",success:!0}).start(),u=L("NotifySynchronizationManagerOnPurge"),l=[],f=function(k){var S=[].concat((0,ne.default)(k.parentPath),[k.id]);return t.find(function(C){return to(C,S)})!==void 0},c=function(k,S){return L("DoNotCancelNonPurgedItemsExecutions")&&S.kind===q.SingleItem&&!f(k.scopeItem)?(v.info(508395810,y.CoreDefault,"Cancellation was skipped for the workflow "+S.id),!0):!1};for(var d of this.workflowQueue.workersList())if(!Tn(d.data.registration.workflow))for(var h of d.data.tasks)c(h,d.data.registration.workflow)||(h.status=Ve.ResultsCancelled,u&&this.workflowSynchronizationManager.notifyOnCancelled(h,d.data.registration.workflow.id),l.push({resourceId:d.data.registration.workflow.resourceId,contextId:h.scopeItem.contextId}));this.workflowQueue.remove(function(p){if(Tn(p.data.registration.workflow))return!1;var k=!0;for(var S of p.data.tasks){if(c(S,p.data.registration.workflow)){k=!1;continue}S.status=Ve.ResultsCancelled,u&&a.workflowSynchronizationManager.notifyOnCancelled(S,p.data.registration.workflow.id),l.push({resourceId:p.data.registration.workflow.resourceId,contextId:S.scopeItem.contextId})}return k}),s.count=l.length,s.resultJSON=JSON.stringify(l),v.info(512338136,y.CoreDefault,s.stop())}}],[{key:"fetchExistingAnnotations",value:function(t,a,s){var u;if(!(!t.fetchExistingAnnotations&&!(!((u=t.modelOptions)===null||u===void 0)&&u.includeExistingAnnotations))){var l;try{l=s.getItemChildren(a,t.outputTypes)}catch(h){v.info(537678239,y.CoreDefault,function(){return"Fetching existing annotations failed on parent item: "+G(a)+". Error: "+h});return}var f=new Array(l.length),c=0;for(var d of l)d.body&&d.source===t.id&&(f[c++]=Object.assign(Object.assign({},d),{parentPath:a}));return f.length=c,f}}},{key:"getDirtyAreaSingleSignalTrigger",value:function(t){return t&&t.length==1&&m.matchesTypesFor(t[0],[Rr.getTypeName()])?t[0]:void 0}}]),e}(Ky.EventEmitter),V_=function(){function n(o,e,r){(0,ks.default)(this,n),this.selfPendingExecCount=0,this.upstreamPendingExecCountByScope=new Map,this.contextProducerPendingExecCountByScope=new Map,this.itemsContextId=new Set,this.executionState=new Map,this.workflow=o.workflow,this.registration=o,this.executionStateChangedCallback=e,this.onContextIdWorkflowExecutionComplete=r}return(0,ws.default)(n,[{key:"invalidateWorkflow",value:function(e,r){var t=U().startSync(j.ExecutionTrackerInvalidate),a=this.getWorkflowExecutionState();this.selfPendingExecCount++,this.executionStateChangedCallback(this.workflow.id,this.getWorkflowExecutionState(),a),this.updateAllDownstreamWorkflowExecutionTrackers(e,r,!1),U().stop(t)}},{key:"increasePendingUpstreamWorkflowsCount",value:function(e,r,t){var a=this.getWorkflowExecutionState();this.selfPendingExecCount+=t,this.executionStateChangedCallback(this.workflow.id,this.getWorkflowExecutionState(),a),this.updateAllDownstreamWorkflowExecutionTrackers(e,r,!1,t)}},{key:"onExecutionTaskCompleted",value:function(e,r){var t=this.getWorkflowExecutionState();this.selfPendingExecCount--,this.executionStateChangedCallback(this.workflow.id,this.getWorkflowExecutionState(),t),this.updateAllDownstreamWorkflowExecutionTrackers(e,r,!0)}},{key:"getWorkflowExecutionState",value:function(){return this.selfPendingExecCount>0?ve.Running:this.upstreamPendingExecCountByScope.size>0?ve.Pending:ve.Idle}},{key:"areUpstreamWorkflowsReadyByScope",value:function(e){return this.upstreamPendingExecCountByScope.get(G(e))===void 0}},{key:"updateAllDownstreamWorkflowExecutionTrackers",value:function(e,r,t){var a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1;for(var s of this.allDownstreamWorkflowExecutionTrackers)if(s.workflowResultType===_n.Input&&s.workflowExecutionTracker.workflow.kind!==q.SingleItem){var u=void 0;try{u=r(e,[s.workflowExecutionTracker.workflow.collectionScopeType])}catch(f){n.shouldLogAncestorNotFoundError(s.workflowExecutionTracker.workflow.id)&&v.info(537678303,y.CoreDefault,"Failed to retrieve root item for updating workflow "+s.workflowExecutionTracker.workflow.id+" execution tracker: "+f.message);return}if(u!==void 0){var l=G([].concat((0,ne.default)(u.parentPath),[u.id]));t?s.workflowExecutionTracker.decreasePendingExecutionCount(l,!1,a):s.workflowExecutionTracker.increasePendingExecutionCount(l,!1,a)}}else s.workflowResultType===_n.Context&&L("WaitContextProducerToComplete")&&(t?s.workflowExecutionTracker.decreasePendingExecutionCount(G(e),!0,a):s.workflowExecutionTracker.increasePendingExecutionCount(G(e),!0,a))}},{key:"increasePendingExecutionCount",value:function(e,r){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,a=r?this.contextProducerPendingExecCountByScope:this.upstreamPendingExecCountByScope,s=a.get(e);a.set(e,(s!=null?s:0)+t)}},{key:"decreasePendingExecutionCount",value:function(e,r){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,a=r?this.contextProducerPendingExecCountByScope:this.upstreamPendingExecCountByScope,s=a.get(e);L_.getValue()&&(!s||s<t)&&v.info(524153237,y.CoreDefault,"Irregular number of upstream pending executions: current "+s+", decrease value: "+t),a.set(e,(s!=null?s:0)-t),a.get(e)<=0&&a.delete(e)}},{key:"addInputItemToProcess",value:function(e){this.registration.suspendExecution||this.itemsContextId.add(e)}},{key:"removeProcessedInputItem",value:function(e){this.itemsContextId.delete(e)}},{key:"countItemsToProcess",value:function(e){var r=0;for(var t of this.itemsContextId)t.indexOf(e)===0&&(r+=1);return r}},{key:"getExecutionState",value:function(){return this.executionState}},{key:"setExecutionState",value:function(e,r){return e?n.isWorkflowReadyToExecute(this.registration)?(this.executionState.set(e,r),!0):(v.info(508883414,y.CoreDefault,new D({operationName:"WorkflowExecutionTracker",resourceId:this.registration.workflow.id,joinContextId:e,resultDescription:"Trying to set state "+r+" for not active workflow"})),!1):(v.info(520217549,y.CoreDefault,new D({operationName:"WorkflowExecutionTracker",resourceId:this.registration.workflow.id,joinContextId:e,resultDescription:"Trying to set state "+r+" for a undefined contextId (setExecutionState)"})),!1)}},{key:"beforeWorkflowExecution",value:function(e){this.setExecutionState(e,ve.Idle)}},{key:"afterWorkflowExecution",value:function(e){this.setExecutionState(e,ve.Executed)&&this.tryToCompleteWorkflowExecution(e)}},{key:"tryToCompleteWorkflowExecution",value:function(e){var r=this.executionState.get(e);if(r===ve.Executed&&this.canCompleteExecution(e)){this.executionState.delete(e),this.onContextIdWorkflowExecutionComplete&&this.onContextIdWorkflowExecutionComplete(this.workflow.id,e);for(var t of this.allDownstreamWorkflowExecutionTrackers)for(var a of t.workflowExecutionTracker.getExecutionState()){var s=(0,Ft.default)(a,2),u=s[0],l=s[1];l===ve.Executed&&Nt.isParentContextId(e,u)&&t.workflowExecutionTracker.tryToCompleteWorkflowExecution(u)}}}},{key:"canCompleteExecution",value:function(e){for(var r of this.allUpstreamWorkflowExecutionTrackers)for(var t of r.workflowExecutionTracker.getExecutionState().keys())if(Nt.isParentContextId(t,e))return!1;return!0}}],[{key:"isWorkflowReadyToExecute",value:function(e){return e.isActivated&&!e.suspendExecution}},{key:"shouldLogAncestorNotFoundError",value:function(e){return!q_.getValue().includes(e)}}]),n}();g();var Q_=new F("wordFilteredOutSubDocs",["comments","endnotes","footnotes","headerfooters","shapes","textboxes"]),j_=new F("wordAllSubDocWorkflows",["AutoSecurityClassificationTextTileV2","AutoSecurityEditAnnotation"]),Xy=function(o,e){if((o==null?void 0:o.appName)==="Word"){var r=Q_.getValue(),t=j_.getValue();return function(a){if(a.parentPath.length>=2&&a.parentPath[1]==="doc"){if(a.parentPath.length>=3&&a.parentPath[2]==="main")return!0;var s=a.parentPath.length===2&&r.includes(a.id)||a.parentPath.length>=3&&r.includes(a.parentPath[2]);if(s)return t.includes(e)}return!0}}};g();var Yy=w(W()),Zy=w(B());var J_=new F("queueSaturationHandlingStrategyEnabled",!1),ek=function(){function n(o,e){(0,Yy.default)(this,n),this.totalExecutionCount=0,this.suspendExecution=!1,this.isActivated=!1,this.pendingTokenExchangesCount=0,this.eventCountSinceLastTrigger=0,this.tasksInProgress=new Set,this.debounceQueue=new Map,this.workflow=o,this.workflowQueue=e,this.lastTriggerByEventsTime=Date.now()}return(0,Zy.default)(n,[{key:"queueTask",value:function(e){var r=this,t=U(),a=t.currentScope;t.startBranch(j.WorkflowExecution,e.cc),Tn(this.workflow)||J_.getValue()?this.queueWorkflow(e):setTimeout(function(){return r.queueWorkflow(e)},0),t.switchToScope(a)}},{key:"queueTaskOld",value:function(e){var r=this,t,a=U(),s=a.currentScope,u=a.startBranch(j.WorkflowExecution,e.cc),l=u.performanceEvent.startSync(j.WorkflowRegistrationQueueTask),f=[],c=[],d=function(T,x){return{cc:e.cc,queueOp:e.queueOp,registration:e.registration,executionId:e.executionId,tasks:T,containsPrefilteredTasks:x}},h=function(T){var x={shouldExecuteWorkflow:!0};if(T.executionScopeId&&r.tasksInProgress.has(T.executionScopeId)){var A=r.debounceQueue.get(T.executionScopeId),b=[];A&&Re(function(){var E;U().remove(A.childPerformanceEvent),A.debounceOp.success=!1,v.info(537781722,y.CoreDefault,A.debounceOp.stop()),v.info(537781723,y.CoreDefault,"Removing Duplicate Workflow: "+r.workflow.id+", executionId: "+e.executionId+", debounceKey: "+T.executionScopeId);for(var I of A.taskCollection.tasks)b=b.concat(I.triggerSignals),(E=I.onComplete)===null||E===void 0||E.call(I,!0)},A.taskCollection.cc),b.length>0&&(T.triggerSignals=b.concat((t=T.triggerSignals)!==null&&t!==void 0?t:[])),r.debounceQueue.set(T.executionScopeId,{debounceOp:new D({operationName:"DebounceSessionWorkflow",resourceId:r.workflow.resourceId,success:!0,resultSignature:T.executionScopeId}).start(),taskCollection:d([T],!x.shouldExecuteWorkflow),childPerformanceEvent:u.performanceEvent.startAsync(j.WaitingInDebounceQueue)})}else x=r.executionManager.evaluatePrefilters(r.workflow,T,Dt.WithActionDefinition),T.prefilterActionResults=x.prefilterActionResults,x.shouldExecuteWorkflow?f.push(T):c.push(T),T.executionScopeId&&r.tasksInProgress.add(T.executionScopeId)};for(var p of e.tasks)h(p);if(u.performanceEvent.stop(l),f.length>0){var k=d(f,!1);this.pushToWorkflowsQueue(k)}if(c.length>0){var S=d(c,!0);this.pushToWorkflowsQueue(S)}a.switchToScope(s)}},{key:"onTaskCompleted",value:function(e){var r=this,t,a;if((t=e.onComplete)===null||t===void 0||t.call(e,!1),e.executionScopeId){var s=this.debounceQueue.get(e.executionScopeId);s?Re(function(){var u,l=U();l.stop(s.childPerformanceEvent),r.debounceQueue.delete(e.executionScopeId),v.info(537781724,y.CoreDefault,s.debounceOp.stop()),r.tasksInProgress.delete(e.executionScopeId);for(var f of s.taskCollection.tasks)(u=f.onComplete)===null||u===void 0||u.call(f,!0);l.startSync(j.InvalidateWorkflow),r.invalidate(s.taskCollection.tasks.map(function(c){return{item:c.scopeItem,triggerSignals:c.triggerSignals,reInvalidateAfterDebounce:!0}}))},(a=s.taskCollection)===null||a===void 0?void 0:a.cc):this.tasksInProgress.delete(e.executionScopeId)}}},{key:"setExecutionManager",value:function(e){this.executionManager=e}},{key:"invalidate",value:function(e){this.executionManager.invalidateWorkflow(this,e)}},{key:"queueWorkflow",value:function(e){var r=U(e.cc),t=r.startSync(j.QueueWorkflow);this.workflowQueue.push(e,this.workflow.priority),r.stop(t),r.startAsync(j.WaitingInWorkflowQueue)}},{key:"pushToWorkflowsQueue",value:function(e){var r=this,t=e.containsPrefilteredTasks?"prefiltered":"";v.debug(537781726,y.CoreDefault,function(){return"Queueing "+e.tasks.length+" "+t+" "+r.workflow.id+" workflows"}),U(e.cc).startAsync(j.WaitingInWorkflowQueue),Tn(this.workflow)?this.workflowQueue.push(e,this.workflow.priority):setTimeout(function(){return r.workflowQueue.push(e,r.workflow.priority)},0)}}]),n}();g();var tk=w(W()),nk=w(B());var rk=function(){function n(o,e,r){(0,tk.default)(this,n),this.upstreamMessageEndpoint=o,this.sessionKey=e,this.userId=r}return(0,nk.default)(n,[{key:"setClientMetadata",value:function(e){this.clientMetadata=e}},{key:"executeWorkflow",value:function(e,r,t){var a=new Jr({workflowId:e.id,batchExecutionInputs:r,clientMetadata:this.clientMetadata,executionContext:{sessionEndpoint:"",origin:"",sessionKey:this.sessionKey,userId:this.userId}});this.upstreamMessageEndpoint.sendMessage(a,function(s,u){if(s){t(new Error(s.error));return}var l=u;t(void 0,l.batchExecutionResults)})}}]),n}();g();var ok=w(Ye()),ik=w(W()),ak=w(B());var Ss=function(){function n(o){(0,ik.default)(this,n),this.scopeItemsByContextId=new Map,this.itemsByWorkflowAndContextId=new Map,this.workflowDefinitionManager=o}return(0,ak.default)(n,[{key:"setScopeItem",value:function(e,r){var t,a=e.contextId;if(a){if(this.itemsByWorkflowAndContextId.has(r.id)||this.itemsByWorkflowAndContextId.set(r.id,new Map),this.itemsByWorkflowAndContextId.get(r.id).set(a,[]),!this.scopeItemsByContextId.has(a))this.scopeItemsByContextId.set(a,e);else if(!((t=this.itemsByWorkflowAndContextId.get(r.id))===null||t===void 0)&&t.has(a)){var s=new D({resultDescription:"Trying to set new scope item: "+e.id+" with already existing contextId "+a+" for workflow "+r.id,operationName:"WIS.setScopeItem",resourceId:r.id,success:!0}).start();v.verbose(527291288,y.CoreDefault,s.stop())}}}},{key:"getScopeItem",value:function(e,r){var t;for(var a of((t=this.itemsByWorkflowAndContextId.get(r.id))===null||t===void 0?void 0:t.keys())||[])if(Zi(a,e))return this.scopeItemsByContextId.get(a)}},{key:"addItemToWorkflowList",value:function(e,r){var t=e.contextId;if(t){var a=this.itemsByWorkflowAndContextId.get(r.id);if(a)for(var s of a){var u=(0,ok.default)(s,2),l=u[0],f=u[1];if(Zi(l,t)){f.push(e);var c=new D({resultDescription:"Items for contextId "+l+": ["+f.map(function(d){return d.id}).join(",")+"]",operationName:"WIS.addItemOnContextIdList",resourceId:r.id,success:!0}).start();v.info(526403808,y.CoreDefault,c.stop())}}}}},{key:"isWorkflowReady",value:function(e,r){var t=this.workflowDefinitionManager.getWorkflowDefinition(r,e).maxAnnotations;return this.getGeneratedItems(e,r).length>=t}},{key:"getItemsToExecute",value:function(e,r){var t=this.getGeneratedItems(e,r);return this.itemsByWorkflowAndContextId.get(r.id).delete(e),t}},{key:"onWorkflowExecuted",value:function(e,r){var t=e.contextId,a=this.itemsByWorkflowAndContextId.get(r.id);a&&(a.delete(t),a.size===0&&this.itemsByWorkflowAndContextId.delete(r.id)),this.hasWorkflowsAwaitingExecution(t)||this.scopeItemsByContextId.delete(t)}},{key:"getGeneratedItems",value:function(e,r){var t;if(!(!((t=this.itemsByWorkflowAndContextId.get(r.id))===null||t===void 0)&&t.get(e)))return[];var a=this.workflowDefinitionManager.getWorkflowDefinition(r,e).maxAnnotations;return this.itemsByWorkflowAndContextId.get(r.id).get(e).slice(0,a)}},{key:"hasWorkflowsAwaitingExecution",value:function(e){for(var r of this.itemsByWorkflowAndContextId.values())for(var t of r.keys())if(t===e)return!0;return!1}}]),n}();g();var sk=w(Ie()),Ec=w(W()),Rc=w(B());var tr;(function(n){n[n.Local=0]="Local",n[n.External=1]="External"})(tr||(tr={}));var Cs=function(){function n(){(0,Ec.default)(this,n),this.graphNodeByLocationAndWorkflowId=new Map}return(0,Rc.default)(n,[{key:"getWorkflow",value:function(e,r){var t,a=this.getLocation(r);return(t=this.graphNodeByLocationAndWorkflowId.get(a))===null||t===void 0?void 0:t.get(e)}},{key:"addWorkflow",value:function(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(this.getWorkflow(e.id,r)){var t=new D({operationName:"AddWorkflowToGraphFailure",success:!1,resourceId:e.id,resultDescription:"Adding a new with workflow with a duplicated workflowId: "+r}).start();v.error(524300630,y.CoreDefault,t.stop());return}var a=this.getLocation(r),s=new K_(e,a);this.addWorkflowAsDependency(s);var u=this.graphNodeByLocationAndWorkflowId.get(a);u||(u=new Map,this.graphNodeByLocationAndWorkflowId.set(a,u)),u.set(e.id,s)}},{key:"getUpstreamRuntimeVisibleWorkflows",value:function(){var e=[];for(var r of this.graphNodeByLocationAndWorkflowId.values()||[])for(var t of r.values()||[]){var a=this.createWorkflowDefinition(t.workflow);if(t.workflow.visibility===Wr.LocalOnly)this.compressDownstreamWorkflows(a,t);else{var s;(s=a.outputTypes).push.apply(s,(0,sk.default)(t.workflow.outputTypes))}a.inputTypes.length!==0&&e.push(a)}return e}},{key:"removeWorkflows",value:function(e){var r=this.getLocation(e),t=this.graphNodeByLocationAndWorkflowId.get(r),a=Array.from((t==null?void 0:t.values())||[]);for(var s of a){for(var u of s.upstreamWorkflows.values())u.downstreamWorkflows.delete(s);for(var l of s.downstreamWorkflows.values())l.upstreamWorkflows.delete(s);t.delete(s.workflow.id)}}},{key:"getWorkflowsDefinitions",value:function(){var e=[];for(var r of this.graphNodeByLocationAndWorkflowId.values()||[])for(var t of r.values()||[])e.push(t.workflow);return e}},{key:"getWorkflowNodes",value:function(e){var r=[];for(var t of this.graphNodeByLocationAndWorkflowId.values())for(var a of t.values())r.push(a);return r}},{key:"getLocation",value:function(e){return e?tr.External:tr.Local}},{key:"createWorkflowDefinition",value:function(e){return Object.assign(Object.assign({},e),{outputTypes:[]})}},{key:"compressDownstreamWorkflows",value:function(e,r){for(var t of r.downstreamWorkflows){if(t.workflow.visibility===Wr.LocalOnly){this.compressDownstreamWorkflows(e,t);continue}if(!(t.workflow.kind===q.Join&&e.inputTypes.indexOf(t.workflow.collectionScopeType)===-1))for(var a of t.workflow.outputTypes)e.outputTypes.indexOf(a)===-1&&e.outputTypes.push(a)}}},{key:"addWorkflowAsDependency",value:function(e){for(var r of this.graphNodeByLocationAndWorkflowId.values())for(var t of r.values()){for(var a of t.workflow.inputTypes)e.workflow.outputTypes.indexOf(a)!==-1&&this.addWorkflowChain(e,t);for(var s of t.workflow.outputTypes)e.workflow.inputTypes.indexOf(s)!==-1&&this.addWorkflowChain(t,e)}}},{key:"addWorkflowChain",value:function(e,r){e.downstreamWorkflows.add(r),r.upstreamWorkflows.add(e)}}]),n}(),K_=(0,Rc.default)(function n(o,e){(0,Ec.default)(this,n),this.isActivated=!0,this.upstreamWorkflows=new Set,this.downstreamWorkflows=new Set,this.location=e,this.workflow=Object.assign(Object.assign({},o),{inputTypes:Array.isArray(o.inputTypes)?o.inputTypes:[],outputTypes:Array.isArray(o.outputTypes)?o.outputTypes:[]})});g();var xk=w(W()),Tk=w(B());g();g();g();g();function uk(n){return function(){for(var o=arguments.length,e=new Array(o),r=0;r<o;r++)e[r]=arguments[r];var t=e.pop();return n.call(this,e,t)}}g();var $_=typeof queueMicrotask=="function"&&queueMicrotask,X_=typeof setImmediate=="function"&&setImmediate,Y_=typeof process=="object"&&typeof process.nextTick=="function";function Z_(n){setTimeout(n,0)}function eA(n){return function(o){for(var e=arguments.length,r=new Array(e>1?e-1:0),t=1;t<e;t++)r[t-1]=arguments[t];return n(function(){return o.apply(void 0,r)})}}var ra;$_?ra=queueMicrotask:X_?ra=setImmediate:Y_?ra=process.nextTick:ra=Z_;var Bo=eA(ra);function Nc(n){return Dc(n)?function(){for(var o=arguments.length,e=new Array(o),r=0;r<o;r++)e[r]=arguments[r];var t=e.pop(),a=n.apply(this,e);return lk(a,t)}:uk(function(o,e){var r;try{r=n.apply(this,o)}catch(t){return e(t)}if(r&&typeof r.then=="function")return lk(r,e);e(null,r)})}function lk(n,o){return n.then(function(e){fk(o,null,e)},function(e){fk(o,e&&e.message?e:new Error(e))})}function fk(n,o,e){try{n(o,e)}catch(r){Bo(function(t){throw t},r)}}function Dc(n){return n[Symbol.toStringTag]==="AsyncFunction"}function tA(n){if(typeof n!="function")throw new Error("expected a function");return Dc(n)?Nc(n):n}var xs=tA;g();function Wc(n){return function(){if(n===null)throw new Error("Callback was already called.");var o=n;n=null;for(var e=arguments.length,r=new Array(e),t=0;t<e;t++)r[t]=arguments[t];o.apply(this,r)}}g();var tt=w(Pa());g();var dk=w(Ie()),pk=w(W()),hk=w(B()),gk=function(n){function o(){(0,pk.default)(this,o),this.head=this.tail=null,this.length=0}return(0,hk.default)(o,[{key:"removeLink",value:function(r){return r.prev?r.prev.next=r.next:this.head=r.next,r.next?r.next.prev=r.prev:this.tail=r.prev,r.prev=r.next=null,this.length-=1,r}},{key:"empty",value:function(){for(;this.head;)this.shift();return this}},{key:"insertAfter",value:function(r,t){t.prev=r,t.next=r.next,r.next?r.next.prev=t:this.tail=t,r.next=t,this.length+=1}},{key:"insertBefore",value:function(r,t){t.prev=r.prev,t.next=r,r.prev?r.prev.next=t:this.head=t,r.prev=t,this.length+=1}},{key:"unshift",value:function(r){this.head?this.insertBefore(this.head,r):ck(this,r)}},{key:"push",value:function(r){this.tail?this.insertAfter(this.tail,r):ck(this,r)}},{key:"shift",value:function(){return this.head&&this.removeLink(this.head)}},{key:"pop",value:function(){return this.tail&&this.removeLink(this.tail)}},{key:"toArray",value:function(){return(0,dk.default)(this)}},{key:n,value:function*(){for(var r=this.head;r;)yield r.data,r=r.next}},{key:"remove",value:function(r){for(var t=this.head;t;){var a=t,s=a.next;r(t)&&this.removeLink(t),t=s}return this}}]),o}(Symbol.iterator);function ck(n,o){n.length=1,n.head=n.tail=o}function Bc(n,o,e){var r;if(o==null)o=1;else if(o===0)throw new RangeError("Concurrency must not be zero");var t=xs(n),a=0,s=[],u={error:[],drain:[],saturated:[],unsaturated:[],empty:[]};function l(A,b){u[A].push(b)}function f(A,b){var E=function I(){c(A,I),b.apply(void 0,arguments)};u[A].push(E)}function c(A,b){if(!A)return Object.keys(u).forEach(function(E){return u[E]=[]});if(!b)return u[A]=[];u[A]=u[A].filter(function(E){return E!==b})}function d(A){for(var b=arguments.length,E=new Array(b>1?b-1:0),I=1;I<b;I++)E[I-1]=arguments[I];u[A].forEach(function(_){return _.apply(void 0,E)})}var h=!1;function p(A,b,E,I){if(I!=null&&typeof I!="function")throw new Error("task callback must be a function");x.started=!0;var _,M;function N(P){if(P)return E?M(P):_();for(var O=arguments.length,z=new Array(O>1?O-1:0),J=1;J<O;J++)z[J-1]=arguments[J];if(z.length<=1)return _(z[0]);_(z)}var R=x._createTaskItem(A,E?N:I||N);if(b?x._tasks.unshift(R):x._tasks.push(R),h||(h=!0,Bo(function(){h=!1,x.process()})),E||!I)return new Promise(function(P,O){_=P,M=O})}function k(A){return function(b){a-=1;for(var E=arguments.length,I=new Array(E>1?E-1:0),_=1;_<E;_++)I[_-1]=arguments[_];for(var M=0,N=A.length;M<N;M++){var R,P=A[M],O=s.indexOf(P);O===0?s.shift():O>0&&s.splice(O,1),(R=P).callback.apply(R,[b].concat(I)),b!=null&&d("error",b,P.data)}a<=x.concurrency-x.buffer&&d("unsaturated"),x.idle()&&d("drain"),x.process()}}function S(A){return A.length===0&&x.idle()?(Bo(function(){return d("drain")}),!0):!1}var C=function(b){return function(E){if(!E)return new Promise(function(I,_){f(b,function(M,N){if(M)return _(M);I(N)})});c(b),l(b,E)}},T=!1,x=(r={_tasks:new gk,_createTaskItem:function(b,E){return{data:b,callback:E}}},(0,tt.default)(r,Symbol.iterator,function*(){yield*Ar(x._tasks[Symbol.iterator]())}),(0,tt.default)(r,"concurrency",o),(0,tt.default)(r,"payload",e),(0,tt.default)(r,"buffer",o/4),(0,tt.default)(r,"started",!1),(0,tt.default)(r,"paused",!1),(0,tt.default)(r,"push",function(b,E){return Array.isArray(b)?S(b)?void 0:b.map(function(I){return p(I,!1,!1,E)}):p(b,!1,!1,E)}),(0,tt.default)(r,"pushAsync",function(b,E){return Array.isArray(b)?S(b)?void 0:b.map(function(I){return p(I,!1,!0,E)}):p(b,!1,!0,E)}),(0,tt.default)(r,"kill",function(){c(),x._tasks.empty()}),(0,tt.default)(r,"unshift",function(b,E){return Array.isArray(b)?S(b)?void 0:b.map(function(I){return p(I,!0,!1,E)}):p(b,!0,!1,E)}),(0,tt.default)(r,"unshiftAsync",function(b,E){return Array.isArray(b)?S(b)?void 0:b.map(function(I){return p(I,!0,!0,E)}):p(b,!0,!0,E)}),(0,tt.default)(r,"remove",function(b){x._tasks.remove(b)}),(0,tt.default)(r,"process",function(){if(!T){for(T=!0;!x.paused&&a<x.concurrency&&x._tasks.length;){var b=[],E=[],I=x._tasks.length;x.payload&&(I=Math.min(I,x.payload));for(var _=0;_<I;_++){var M=x._tasks.shift();b.push(M),s.push(M),E.push(M.data)}a+=1,x._tasks.length===0&&d("empty"),a===x.concurrency&&d("saturated");var N=Wc(k(b));t(E,N)}T=!1}}),(0,tt.default)(r,"length",function(){return x._tasks.length}),(0,tt.default)(r,"running",function(){return a}),(0,tt.default)(r,"workersList",function(){return s}),(0,tt.default)(r,"idle",function(){return x._tasks.length+a===0}),(0,tt.default)(r,"pause",function(){x.paused=!0}),(0,tt.default)(r,"resume",function(){x.paused!==!1&&(x.paused=!1,Bo(x.process))}),r);return Object.defineProperties(x,{saturated:{writable:!1,value:C("saturated")},unsaturated:{writable:!1,value:C("unsaturated")},empty:{writable:!1,value:C("empty")},drain:{writable:!1,value:C("drain")},error:{writable:!1,value:C("error")}}),x}g();g();function mk(n,o){var e=xs(n);return Bc(function(r,t){e(r[0],t)},o,1)}g();var yk=w(Ie()),kk=w(Ye()),wk=w(W()),Sk=w(B()),Ck=function(n){function o(){(0,wk.default)(this,o),this.heap=[],this.pushCount=Number.MIN_SAFE_INTEGER}return(0,Sk.default)(o,[{key:"length",get:function(){return this.heap.length}},{key:"empty",value:function(){return this.heap=[],this}},{key:"percUp",value:function(r){for(var t;r>0&&Pc(this.heap[r],this.heap[t=vk(r)]);){var a=this.heap[r];this.heap[r]=this.heap[t],this.heap[t]=a,r=t}}},{key:"percDown",value:function(r){for(var t;(t=nA(r))<this.heap.length&&(t+1<this.heap.length&&Pc(this.heap[t+1],this.heap[t])&&(t=t+1),!Pc(this.heap[r],this.heap[t]));){var a=this.heap[r];this.heap[r]=this.heap[t],this.heap[t]=a,r=t}}},{key:"push",value:function(r){r.pushCount=++this.pushCount,this.heap.push(r),this.percUp(this.heap.length-1)}},{key:"unshift",value:function(r){return this.heap.push(r)}},{key:"shift",value:function(){var r=(0,kk.default)(this.heap,1),t=r[0];return this.heap[0]=this.heap[this.heap.length-1],this.heap.pop(),this.percDown(0),t}},{key:"toArray",value:function(){return(0,yk.default)(this)}},{key:n,value:function*(){for(var r=0;r<this.heap.length;r++)yield this.heap[r].data}},{key:"remove",value:function(r){for(var t=0,a=0;a<this.heap.length;a++)r(this.heap[a])||(this.heap[t]=this.heap[a],t++);this.heap.splice(t);for(var s=vk(this.heap.length-1);s>=0;s--)this.percDown(s);return this}}]),o}(Symbol.iterator);function nA(n){return(n<<1)+1}function vk(n){return(n+1>>1)-1}function Pc(n,o){return n.priority!==o.priority?n.priority<o.priority:n.pushCount<o.pushCount}function Ts(n,o){var e=mk(n,o),r=e.push,t=e.pushAsync;e._tasks=new Ck,e._createTaskItem=function(s,u){var l=s.data,f=s.priority;return{data:l,priority:f,callback:u}};function a(s,u){return Array.isArray(s)?s.map(function(l){return{data:l,priority:u}}):{data:s,priority:u}}return e.push=function(s){var u=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,l=arguments.length>2?arguments[2]:void 0;return r(a(s,u),l)},e.pushAsync=function(s){var u=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,l=arguments.length>2?arguments[2]:void 0;return t(a(s,u),l)},delete e.unshift,delete e.unshiftAsync,e}var Ik=function(n){function o(e,r,t){(0,xk.default)(this,o),this.executeTask=e,this.concurrencyLimit=r,this.queue=Ts(this.executeTask,this.concurrencyLimit),this.saturationHandlingStrategy=t,this.onItemAddedCallbacks=[],this.saturationHandlingStrategy&&(this.saturated(this.saturationHandlingStrategy.onSaturated.bind(this.saturationHandlingStrategy,this)),this.unsaturated(this.saturationHandlingStrategy.onUnsaturated.bind(this.saturationHandlingStrategy,this)),this.drained(this.saturationHandlingStrategy.onDrained.bind(this.saturationHandlingStrategy,this)),this.onItemAdded(this.saturationHandlingStrategy.onItemAdded.bind(this.saturationHandlingStrategy,this)))}return(0,Tk.default)(o,[{key:"buffer",get:function(){return this.queue.buffer},set:function(r){this.queue.buffer=r}},{key:"concurrency",get:function(){return this.queue.concurrency},set:function(r){this.queue.concurrency=r}},{key:"onItemAdded",value:function(r){this.onItemAddedCallbacks.push(r)}},{key:"drained",value:function(r){this.queue.drain(r)}},{key:"unsaturated",value:function(r){this.queue.unsaturated(r)}},{key:"saturated",value:function(r){this.queue.saturated(r)}},{key:"idle",value:function(){return this.queue.idle()}},{key:"running",value:function(){return this.queue.running()}},{key:"length",value:function(){return this.queue.length()}},{key:"workersList",value:function(){return this.queue.workersList()}},{key:"push",value:function(r,t){this.queue.push(r,t);for(var a of this.onItemAddedCallbacks)a()}},{key:"kill",value:function(){this.queue.kill()}},{key:"clear",value:function(){this.queue.kill(),this.queue=Ts(this.executeTask,this.concurrencyLimit)}},{key:n,value:function*(){yield*Ar(this.queue[Symbol.iterator]())}},{key:"remove",value:function(r){this.queue.remove(r)}}]),o}(Symbol.iterator);g();var Po=w(Ie()),Ak=w(W()),bk=w(B());var rA=new F("workflowSynchronizationInterval",10),Is=new F("skipDebounceDeltasEnabled",!0),oA=new F("defaultMaxSynchronizationWaitTimeMsForNonDeltaTriggerdWorkflows",-1),iA=new F("defaultMaxSynchronizationWaitTimeMsForDeltaTriggerdWorkflows",0),_k=Symbol("isDuplicate"),Mk=function(){function n(){(0,Ak.default)(this,n),this.tasksInProgress=new Map,this.synchronizationQueue=new Map,this.synchronizationIntervalMs=rA.getValue()}return(0,bk.default)(n,[{key:"notifyBeforeBatchedQueuing",value:function(e,r){var t,a=e.some(function(c){return c.executionScopeId});if(!a)return e;var s=U().startSync(j.SynchronizeWorkflowTasks);this.markDuplicateTasks(e);var u=[],l=0;for(var f of e){if(!f.executionScopeId){u.push(f);continue}if(f[_k]===!0){(t=f.onComplete)===null||t===void 0||t.call(f,!0),l++;continue}this.postponeTaskIfPreviousInProgress(f,r)||(this.getTasksInProgress(r.workflow.id).set(f.executionScopeId,f),u.push(f))}return l>0&&this.logDuplicateTasksRemoval(r,l),U().stop(s),u}},{key:"notifyBeforeQueueing",value:function(e,r){if(!e.executionScopeId)return!0;U().startSync(j.SynchronizeWorkflowTask);var t=this.postponeTaskIfPreviousInProgress(e,r);return t||this.getTasksInProgress(r.workflow.id).set(e.executionScopeId,e),U().stop(j.SynchronizeWorkflowTask),!t}},{key:"notifyOnCancelled",value:function(e,r){this.removeTaskInProgress(e,r,!0)}},{key:"notifyOnCompleted",value:function(e,r){this.removeTaskInProgress(e,r,!1)}},{key:"onSessionClose",value:function(){this.cancelSynchronizationTimer()}},{key:"removeTaskInProgress",value:function(e,r,t){var a;if((a=e.onComplete)===null||a===void 0||a.call(e,!1),!!e.executionScopeId){var s=this.getTasksInProgress(r),u=s.get(e.executionScopeId);if(u===e){s.delete(e.executionScopeId);var l=this.getSynchronizationQueue(r),f=l.get(e.executionScopeId);s.size===0&&this.tasksInProgress.delete(r),f&&this.reInvalidatePostponedWorkflowTask(f,l,t)}else v.info(509137730,y.CoreDefault,"Task in progress do not match the task that completed execution.")}}},{key:"markDuplicateTasks",value:function(e){var r=this;e.reduce(function(t,a){if(a.executionScopeId){var s=t.get(a.executionScopeId);s&&(s[_k]=!0,r.accumulateDataFromPreviousTask(s,a)),t.set(a.executionScopeId,a)}return t},new Map)}},{key:"getTasksInProgress",value:function(e){return In(this.tasksInProgress,e,function(){return new Map})}},{key:"getSynchronizationQueue",value:function(e){return In(this.synchronizationQueue,e,function(){return new Map})}},{key:"getMaxSynchronizationWaitTimeMs",value:function(e){var r;return e.workflow.maxSynchronizationWaitTimeMs===void 0?!((r=e.workflow.triggerConditions)===null||r===void 0)&&r.includes(Lt.DeltaUpdate)?iA.getValue():oA.getValue():e.workflow.maxSynchronizationWaitTimeMs}},{key:"postponeTaskIfPreviousInProgress",value:function(e,r){var t;if(!Is.getValue()){var a=this.getMaxSynchronizationWaitTimeMs(r);if(e.maxSynchronizationEndTimeMs!==void 0&&e.maxSynchronizationEndTimeMs<=Date.now()||a===0)return!1;e.maxSynchronizationEndTimeMs===void 0&&(e.maxSynchronizationEndTimeMs=a>0?Date.now()+a:void 0)}var s=this.getTasksInProgress(r.workflow.id).get(e.executionScopeId);if((s==null?void 0:s.status)===Ve.Pending)return s.status=Ve.ExecutionCancelled,this.accumulateDataFromPreviousTask(s,e),(t=s.onComplete)===null||t===void 0||t.call(s,!0),this.logTaskCancellation(r),!1;if(s){var u=this.getSynchronizationQueue(r.workflow.id).get(e.executionScopeId);return u&&(this.cancelPreviousPostponedTask(u),this.accumulateDataFromPreviousTask(u.task,e)),this.postponeTask(e,r),!0}return!1}},{key:"postponeTask",value:function(e,r){var t=this,a=U();zn(function(s){var u=a.startBranch(j.PostponeWorkflowTask,et()),l=u.performanceEvent.startAsync(j.WaitingInSynchronizationQueue);t.getSynchronizationQueue(r.workflow.id).set(e.executionScopeId,{waitingInSyncQueueOp:new D({operationName:"WaitingInSynchronizationQueue",resourceId:r.workflow.resourceId,success:!0,resultSignature:e.executionScopeId}).start(),waitingInSyncQueuePerfEvent:l,task:e,correlationContext:et(),workflowRegistration:r}),!Is.getValue()&&e.maxSynchronizationEndTimeMs!==void 0&&t.ensureSynchronizationTimer()})}},{key:"cancelPreviousPostponedTask",value:function(e){Re(function(){var r,t;e.waitingInSyncQueueOp.success=!1,v.info(509747279,y.CoreDefault,e.waitingInSyncQueueOp.stop()),(t=(r=e.task).onComplete)===null||t===void 0||t.call(r,!0)},e.correlationContext)}},{key:"accumulateTriggerSignals",value:function(e,r){e.triggerSignals&&(r.triggerSignals?r.triggerSignals=e.triggerSignals.concat(r.triggerSignals):r.triggerSignals=(0,Po.default)(e.triggerSignals))}},{key:"accumulateDeltas",value:function(e,r){var t,a,s,u,l,f;Is.getValue()||(!((a=(t=e.scopeItem)===null||t===void 0?void 0:t.deltas)===null||a===void 0)&&a.length&&(!((u=(s=r.scopeItem)===null||s===void 0?void 0:s.deltas)===null||u===void 0)&&u.length?r.scopeItem.deltas=e.scopeItem.deltas.concat(r.scopeItem.deltas):r.scopeItem&&(r.scopeItem.deltas=(0,Po.default)((l=e.scopeItem)===null||l===void 0?void 0:l.deltas))),!((f=e.inputItems)===null||f===void 0)&&f.length&&e.inputItems.forEach(function(c){var d,h,p,k=G([].concat((0,Po.default)(c.parentPath),[c.id])),S=(d=r.inputItems)===null||d===void 0?void 0:d.find(function(C){return G([].concat((0,Po.default)(C.parentPath),[C.id]))===k});S!=r.scopeItem&&(!((h=c.deltas)===null||h===void 0)&&h.length)&&S&&(!((p=S==null?void 0:S.deltas)===null||p===void 0)&&p.length?S.deltas=c.deltas.concat(S.deltas):S.deltas=(0,Po.default)(c.deltas))}))}},{key:"accumulateDataFromPreviousTask",value:function(e,r){this.accumulateTriggerSignals(e,r),this.accumulateDeltas(e,r)}},{key:"reInvalidateWorkflowTask",value:function(e,r){var t=U();t.startSync(j.InvalidateWorkflow),r.invalidate([{item:e.scopeItem,triggerSignals:e.triggerSignals,reInvalidateAfterDebounce:!0,maxSynchronizationEndTimeMs:e.maxSynchronizationEndTimeMs}])}},{key:"logTaskCancellation",value:function(e){var r=new D({operationName:"CancelPendingWorkflowExecution",resourceId:e.workflow.resourceId,success:!0,resultDescription:"New execution for the same scope item arrived."}).start();v.info(509747278,y.CoreDefault,r.stop())}},{key:"logDuplicateTasksRemoval",value:function(e,r){var t=new D({operationName:"RemoveDuplicateTasksFromBatch",count:r,resourceId:e.workflow.resourceId,success:!0}).start();v.info(509747277,y.CoreDefault,t.stop())}},{key:"ensureSynchronizationTimer",value:function(){!Is.getValue()&&!this.synchronizationTimer&&(this.synchronizationTimer=setInterval(this.onSynchronization.bind(this),this.synchronizationIntervalMs),this.synchronizationTimer.unref&&this.synchronizationTimer.unref())}},{key:"onSynchronization",value:function(){var e=0;if(!this.synchronizationQueue||this.synchronizationQueue.size===0){this.cancelSynchronizationTimer();return}var r=this.synchronizationQueue.keys();for(var t of r){var a=this.getSynchronizationQueue(t);if(!(!a||a.size===0)){var s=a.keys();for(var u of s){var l=a.get(u);!l||l.task.maxSynchronizationEndTimeMs===void 0||(e++,l.task.maxSynchronizationEndTimeMs<=Date.now()&&(this.reInvalidatePostponedWorkflowTask(l,a,!1),e--))}}}e<=0&&this.cancelSynchronizationTimer()}},{key:"cancelSynchronizationTimer",value:function(){this.synchronizationTimer&&(clearInterval(this.synchronizationTimer),this.synchronizationTimer=void 0)}},{key:"reInvalidatePostponedWorkflowTask",value:function(e,r,t){var a=this;Re(function(){var s,u,l=U();l.stop(e.waitingInSyncQueuePerfEvent),r.delete(e.task.executionScopeId),e.waitingInSyncQueueOp.success=!t,v.info(509747283,y.CoreDefault,e.waitingInSyncQueueOp.stop()),(u=(s=e.task).onComplete)===null||u===void 0||u.call(s,!0),t||a.reInvalidateWorkflowTask(e.task,e.workflowRegistration)},e.correlationContext)}}]),n}();function aA(n){var o=sA();return function(){var r=(0,Lc.default)(n),t;if(o){var a=(0,Lc.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,Bk.default)(this,t)}}function sA(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var oa;(function(n){n.SessionInitMessage="SessionInitMessage",n.AnnotationActivatedMessage="AnnotationActivatedMessage",n.SeedCompleted="SeedCompleted",n.TokenProvisionMessage="TokenProvisionMessage"})(oa||(oa={}));var Lo;(function(n){n.AnnotationActivation="annotation activation",n.Auth="auth",n.Flight="flight",n.Seeding="seeding",n.WorkflowDisabled="disabled",n.UserType="user type"})(Lo||(Lo={}));var Ve;(function(n){n[n.Pending=0]="Pending",n[n.Running=1]="Running",n[n.ExecutionCancelled=2]="ExecutionCancelled",n[n.ResultsCancelled=3]="ResultsCancelled"})(Ve||(Ve={}));var yr;(function(n){n[n.Unknown=0]="Unknown",n[n.ClientClose=1]="ClientClose",n[n.IdleTimeout=2]="IdleTimeout",n[n.ExpireTimeout=3]="ExpireTimeout",n[n.MastermindShutdown=4]="MastermindShutdown",n[n.SessionExtensionClose=5]="SessionExtensionClose"})(yr||(yr={}));var Ek;(function(n){n.Failure="Failure",n.Success="Success",n.Partial="Partial"})(Ek||(Ek={}));var uA=new F("workflowConcurrencyLimit",100),Ry=new F("setAnnotationStateToSent",!0),Rk=new F("delayedWorkflowActivationTierThreshold",cn.DelayActivate),lA=new F("workflowMaxTriggerSignalOpsQueueLength",100),fA=new F("sessionLogMinDurationInMs",30),cA=new F("workflowsAllowedToPreactivate",[]),dA=new F("enableRefactoredDebouncing",!0),pA=new F("workflowBatchSizeMax",10),Oc="session-init-message",Ok=function(n){(0,Wk.default)(e,n);var o=aA(e);function e(r,t,a){var s;return(0,Nk.default)(this,e),s=o.call(this),s.annotationActivationInfosByType=new Map,s.workflowRegistrationsByName=new Map,s.workflowsWaitingForActivation=new Set,s.workflowsByOutputAnnotation=new Map,s.workflowsByInputAnnotation=new Map,s.workflowsByRequestedContextType=new Map,s.workflowGraph=new Cs,s.outputAnnotationsRequiredByDownstreamWorkflows=new Set,s.statelessItemListeners=new Ja,s.pendingExecutionStateUpdates=new Map,s.lastSeenAnnotationStateByAnnotation=new Map,s.workflowDefinitionManager=new cs,s.nextAnnotationResultsSequenceId=1,s.nextWorkflowExecutionCompleteSequenceId=1,s.cvParent=new We,s.isSeedingCompleted=!1,s.workflowInputTypes=new Set,s.clientMetadataFlightsSet=new Set,s.enableRemoteExecutionNotification=!1,s.isClosed=!1,s.sessionKey=r,s.stats=a,s.sessionObjectCreationTime=Date.now(),s.startTime=t.initialStartTime?t.initialStartTime:s.sessionObjectCreationTime,s.upstreamMessageEndpoint=t.upstreamMessageEndpoint,s.downstreamMessageEndpoint=t.downstreamMessageEndpoint,s.cache=t.cache,s.workflowClientCoordinator=new rk(s.upstreamMessageEndpoint,s.sessionKey,void 0),s.inputChangesManager=new sy(s.cache),s.annotationProcessor=new Ey((0,Qe.default)(s)),s.statelessAnnotationProcessor=new Py((0,Qe.default)(s),s.statelessItemListeners),s.contextIdManager=new Nt(Do.JsClient,s.workflowGraph),s.workflowItemStorage=new Ss(s.workflowDefinitionManager),s.workflowQueue=new Ik(s.executeWorkflow.bind((0,Qe.default)(s)),uA.getValue()),s.upstreamMessageEndpoint.onMessage(dt.getTypeName(),s.onSessionInitMessage.bind((0,Qe.default)(s))),s.upstreamMessageEndpoint.onMessage(Xe.getTypeName(),s.onSessionCloseMessage.bind((0,Qe.default)(s))),s.upstreamMessageEndpoint.onMessage(zr.getTypeName(),s.onTokenProvisionMessage.bind((0,Qe.default)(s))),s.upstreamMessageEndpoint.onMessage(Vr.getTypeName(),s.onWorkflowGraphInitMessage.bind((0,Qe.default)(s))),s.upstreamMessageEndpoint.onMessage(nn.getTypeName(),s.onAnnotationActivationMessage.bind((0,Qe.default)(s))),s.upstreamMessageEndpoint.onMessage(Hr.getTypeName(),s.onAnnotationConfigUpdateMessage.bind((0,Qe.default)(s))),s.upstreamMessageEndpoint.onMessage(Ue.getTypeName(),s.onSyncMessage.bind((0,Qe.default)(s))),s.upstreamMessageEndpoint.onMessage(jn.getTypeName(),s.onMicroSyncMessage.bind((0,Qe.default)(s))),s.upstreamMessageEndpoint.onMessage(jr.getTypeName(),s.onWorkflowRegistrationMessage.bind((0,Qe.default)(s))),s.upstreamMessageEndpoint.onMessage(Kn.getTypeName(),s.onWorkflowDefinitionOverrideMessage.bind((0,Qe.default)(s))),s.upstreamMessageEndpoint.onMessage(Kr.getTypeName(),s.onGetAnnotationsRequestMessage.bind((0,Qe.default)(s))),s.downstreamMessageEndpoint&&s.downstreamMessageEndpoint.onMessage(wt.getTypeName(),s.onAnnotationResultsMessage.bind((0,Qe.default)(s))),s.syncMessageSequencer=new Ty(s.applySyncMessage.bind((0,Qe.default)(s)),t.isReconnect),s.syncMessageSequencer.on("seedCompleted",s.onSeedCompleted.bind((0,Qe.default)(s))),s.usesRefactoredDebouncing=dA.getValue(),s.workflowSynchronizationManager=s.usesRefactoredDebouncing?new Mk:void 0,s.workflowExecutionManager=$y({cache:s.cache,workflowRegistrationsByName:s.workflowRegistrationsByName,workflowsByInputAnnotation:s.workflowsByInputAnnotation,workflowsByOutputAnnotation:s.workflowsByOutputAnnotation,workflowsByRequestedContextType:s.workflowsByRequestedContextType,queueWorkflow:s.queueWorkflow.bind((0,Qe.default)(s)),queueGridNeighborhoodWorkflow:s.queueGridNeighborhoodWorkflow.bind((0,Qe.default)(s)),inputChangesManager:s.inputChangesManager,getUserNodePath:function(){return s.userNodePath},getTenantNodePath:function(){return s.tenantNodePath},getUserCommandsNodePath:function(){return s.userCommandsNodePath},workflowDefinitionManager:s.workflowDefinitionManager,workflowItemStorage:s.workflowItemStorage,sessionCreationTime:s.startTime,workflowQueue:s.workflowQueue,executionCompleteCallback:s.onWorkflowExecutionComplete.bind((0,Qe.default)(s)),usesRefactoredDebouncing:s.usesRefactoredDebouncing,workflowSynchronizationManager:s.workflowSynchronizationManager,workflowBatchSizeMax:function(){return pA.getValue()},areasIntersect:function(l){return!1},supportsAreaIntersection:function(l){return!1}}),s.workflowExecutionManager.on("executionStateChange",s.onWorkflowExecutionStateChanged.bind((0,Qe.default)(s))),s.workflowExecutionManager.on("sweep",s.onWorkflowExecutionManagerSweep.bind((0,Qe.default)(s))),s.workflowRegistrationsByName.forEach(function(u){return u.setExecutionManager(s.workflowExecutionManager)}),s.cache.on("beforeItemChange",function(u){s.inputChangesManager.applyChanges([u])}),v.info(595720205,y.CoreDefault,"Starting session "+s.sessionKey+". Is reconnect: "+t.isReconnect+"."),s}return(0,Dk.default)(e,[{key:"onClose",value:function(t,a,s){var u=this;Na(function(){var l;v.info(536959044,y.CoreDefault,"Session closing: "+yr[t]+" "+((l=a==null?void 0:a.reason)!==null&&l!==void 0?l:"")),u.workflowQueue.kill(),u.isClosed=!0,u.downstreamMessageEndpoint&&u.downstreamMessageEndpoint.sendMessage(new Xe(a)),t!==yr.ClientClose&&u.upstreamMessageEndpoint.sendMessage(new Xe(a)),u.syncMessageSequencer.onClose(),u.workflowExecutionManager.onSessionClose(),t===yr.MastermindShutdown&&u.cache.dispose(),s()},this.cvParent.toString(),{sessionKey:this.sessionKey},this.clientMetadata)}},{key:"registerWorkflow",value:function(t){if(v.info(537781729,y.CoreDefault,"Session registering "+q[t.kind]+" workflow "+t.id+" at priority "+t.priority),this.workflowRegistrationsByName.has(t.id))throw new Error("A workflow with name "+t.id+" already exists");var a=new ek(t,this.workflowQueue);this.workflowRegistrationsByName.set(a.workflow.id,a),this.addWorkflowToDependencyMaps(t),this.workflowsWaitingForActivation.add(a),this.workflowGraph.addWorkflow(Yi(t)),this.workflowExecutionManager.attachExecutionTrackerToWorkflow(a,this.workflowsByInputAnnotation,this.workflowsByOutputAnnotation,this.workflowsByRequestedContextType),a.setExecutionManager(this.workflowExecutionManager)}},{key:"onWorkflowGraphInitMessage",value:function(t,a){var s=new D({operationName:"WorkflowGraphInit"}).start(),u=new Ai({downstreamRuntimeWorkflows:this.workflowGraph.getUpstreamRuntimeVisibleWorkflows()});s.success=!0,v.info(524850697,y.CoreDefault,s.stop()),a(void 0,u)}},{key:"sendAnnotations",value:function(t,a,s,u){var l=this;this.annotationActivationInfosByType.has(t)&&!this.isClosed&&zn(function(f){var c,d=new _e({sessionHealthEventName:"SendAnnotations",resourceId:s==null?void 0:s.resourceId,source:pe.Core,reason:Y.Core,impact:he.MissingOutput,success:!0,message:"",affectedWorkflows:[(c=s==null?void 0:s.resourceId)!==null&&c!==void 0?c:"All"]}).start(),h=function(k){var S=0;for(var C of a)m.getTypeNameFor(C)===k.getTypeName()&&(S+=C.items.length);return S};v.info(573870239,y.CoreDefault,"Sending annotations to client (type: "+t+", workflow: "+(s?s.id:void 0)+", added: "+h(we)+", updated: "+h(Ne)+", deleted: "+h(Fe)+")"),l.upstreamMessageEndpoint.sendMessage(new wt({cv:f.toString(),seq:l.nextAnnotationResultsSequenceId++,annotationType:t,batchSize:1,batchId:u,batchComplete:!0,ops:a}),function(p){d.success=!p||l.isClosed,d.message=p==null?void 0:p.error,d.success?v.verbose(536959046,y.CoreDefault,d.stop()):v.info(536959045,y.CoreDefault,d.stop())})})}},{key:"processAnnotationQueue",value:function(t,a){if(Tn(t)){this.statelessAnnotationProcessor.processAnnotationQueue(t,a);return}if(!t.bypassModel){this.annotationProcessor.processAnnotationQueue(t,a);return}var s=[],u=[];for(var l of a){if(l.annotationQueue.length===0){u.push(l);continue}var f=[],c=[];for(var d of l.annotationQueue)rs(t,d.annotationType)?f.push(d):c.push(d);if(f.length===0){u.push(l);continue}s.push(Object.assign(Object.assign({},l),{annotationQueue:f})),u.push(Object.assign(Object.assign({},l),{annotationQueue:c}))}this.statelessAnnotationProcessor.processAnnotationQueue(t,s),this.annotationProcessor.processAnnotationQueue(t,u)}},{key:"updateWorkflowExecutionStates",value:function(t){var a=this.workflowRegistrationsByName.values();for(var s of t)if(ta.has(m.getTypeNameFor(s)))for(var u of s.items)for(var l of a||[]){var f=l.workflow;this.workflowExecutionManager.preProcessItemToWorkflow(f,u)}}},{key:"onWorkflowRegistrationMessage",value:function(t,a){var s=t.workflowDefinition,u,l;try{this.registerWorkflow(s),l=new Be}catch(f){u=new X({error:f.message})}finally{a(u,l)}}},{key:"onSessionInitMessage",value:function(t,a){if(v.info(537781730,y.CoreDefault,"SessionInit for "+this.sessionKey),!t.clientMetadata)v.error(537781731,y.CoreDefault,"Client metadata NOT received");else{if(this.clientMetadata=t.clientMetadata,this.clientMetadata.flights){var s=this.clientMetadata.flights.toLowerCase().split(";");this.clientMetadataFlightsSet=new Set;for(var u of s){var l=u.charCodeAt(0),f=u.charCodeAt(u.length-1);l<33||l>126||f<33||f>126?this.clientMetadataFlightsSet.add(u.trim()):this.clientMetadataFlightsSet.add(u)}}this.upstreamMessageEndpoint.setClientMetadata(this.clientMetadata),this.downstreamMessageEndpoint&&this.downstreamMessageEndpoint.setClientMetadata(this.clientMetadata),this.workflowClientCoordinator.setClientMetadata(this.clientMetadata),this.syncMessageSequencer.setClientMetadata(this.clientMetadata),this.workflowExecutionManager.setClientMetadata(this.clientMetadata)}this.enableRemoteExecutionNotification=t.enableRemoteExecutionNotification||!1,this.createUserNodeIfNotExists(),this.createTenantNodeIfNotExists(),this.createUserCommandsNodeIfNotExists(),this.activateWaitingWorkflows(oa.SessionInitMessage);var c=new dr({sessionUrlBase:"",sessionKey:this.sessionKey,origin:"",messageId:t.messageId,workflowInputTypes:t.returnWorkflowInputTypes?Array.from(this.workflowInputTypes):[],anonymousToken:"FakeToken",tokenExpirationSeconds:999999,downstreamRuntimeWorkflows:this.enableRemoteExecutionNotification?this.workflowGraph.getUpstreamRuntimeVisibleWorkflows():[]});a(void 0,c)}},{key:"onSessionCloseMessage",value:function(t,a){v.info(509728132,y.CoreDefault,"SessionClose for "+this.sessionKey),this.onClose(yr.ClientClose,t,function(s){s?a(void 0,new X({messageId:t.messageId,error:s.message})):a(void 0,new Pi({messageId:t.messageId}))})}},{key:"onAnnotationActivationMessage",value:function(t,a){var s=this;this.downstreamMessageEndpoint&&this.downstreamMessageEndpoint.sendMessage(new nn(t));var u=new _e({sessionHealthEventName:"AnnotationActivation",source:pe.Core,reason:Y.Core,impact:he.MissingOutput,success:!0,message:"",affectedWorkflows:["All"],resultDescription:"Activating: "+t.annotationType+" with token "+t.token},this.clientMetadata).start();{var l=a;a=function(E,I){E&&(u.success=!1),v.info(536959047,y.CoreDefault,u.stop()),l(E,I)}}var f=t.annotationType;if(!f){u.setReason(Y.Client),a(new X({error:"No annotation type provided"}));return}var c=t.sendStateUpdates,d=t.config,h=t.token,p=this.annotationActivationInfosByType.get(f),k=!p;k&&(p=[],this.annotationActivationInfosByType.set(f,p)),p.forEach(function(b,E){b.token===t.token&&p.splice(E,1)}),p.push({token:h,sendStateUpdates:c,config:d}),v.verbose(536959048,y.CoreDefault,function(){return"Session.onAnnotationActivationMessage: '"+f+"' annotation was activated"});var S=function(E){t.batchId?(v.info(536959049,y.CoreDefault,"Client supplied batchId param (or ChangeGate was disabled), using legacy behavior"),a(void 0,new Fr({token:h})),Array.isArray(E)&&s.sendAnnotations(f,E,void 0,t.batchId||t.token||"Unknown")):(a(void 0,new Be),Array.isArray(E)&&E.length>0&&s.sendAnnotations(f,E))};if(t.ignoreExistingAnnotations)S();else if(k){var C;try{C=this.cache.getSubtreeItems([],[f])}catch(b){a(new X({error:"Failed to retrieve existing annotations: "+b.message}));return}v.info(536959050,y.CoreDefault,"Sending existing annotations to client (type: "+f+", count: "+C.length+")");var T=C.map(function(b){return new we({parentPath:b.parentPath,items:[b]})});S(T)}if(c){var x=this.workflowExecutionManager.getWorkflowsByExecutionState(ve.Pending,ve.Running);for(var A of this.workflowsByOutputAnnotation.get(t.annotationType)||[])!x.has(A)||this.pendingExecutionStateUpdates.has(A)||this.pendingExecutionStateUpdates.set(A,ve.Pending);this.workflowExecutionManager.requestSweep()}this.unsuspendWorkflows(f),this.emit("annotationActivationMessageReceived"),this.activateWaitingWorkflows(oa.AnnotationActivatedMessage)}},{key:"unsuspendWorkflows",value:function(t){for(var a of(0,It.default)(this.workflowsByOutputAnnotation.get(t)||[]))if(this.workflowRegistrationsByName.get(a.id).suspendExecution){for(var s of this.workflowExecutionManager.getAllUpstreamWorkflowIds(a.id).reverse())this.workflowRegistrationsByName.get(s).suspendExecution&&(this.workflowRegistrationsByName.get(s).suspendExecution=!1,v.info(509155540,y.CoreDefault,"Execution of "+s+" is unsuspended by downstream workflow request."),this.tryScheduleWorkflowExecution(this.workflowRegistrationsByName.get(s)));this.workflowRegistrationsByName.get(a.id).suspendExecution=!1,v.info(509155539,y.CoreDefault,"Execution of "+a.id+" is unsuspended by annotation activation request."),this.tryScheduleWorkflowExecution(this.workflowRegistrationsByName.get(a.id))}}},{key:"onAnnotationReleaseMessage",value:function(t,a){var s=!1,u=!1,l=new _e({sessionHealthEventName:"AnnotationRelease",source:pe.Core,reason:Y.Core,impact:he.None,success:!1,message:"",affectedWorkflows:["All"],resultDescription:"Releasing token: "+t.token},this.clientMetadata).start();for(var f of this.annotationActivationInfosByType){var c=(0,Oo.default)(f,2),d=c[0],h=c[1],p=h.findIndex(function(k){return k.token==t.token});if(p>=0){h.length===1?(this.annotationActivationInfosByType.delete(d),u=!0,this.trySuspendWorkflowByAnnotationRelease(d)):h.splice(p,1),s=!0,l.success=!0,l.resultDescription="Releasing: "+d+" and token "+t.token+", lastRelease: "+u;break}}v.info(536959051,y.CoreDefault,l.stop()),s?a(void 0,new Ur({lastRelease:u})):a(new X({error:Vt.AnnotationTokenNotFound}))}},{key:"trySuspendWorkflowByAnnotationRelease",value:function(t){for(var a of(0,It.default)(this.workflowsByOutputAnnotation.get(t)||[]))if(this.workflowMeetsSuspendConditions(a)){this.workflowRegistrationsByName.get(a.id).suspendExecution=!0,v.info(509155538,y.CoreDefault,"Output annotations fully released, suspending "+a.id+" execution.");for(var s of this.workflowExecutionManager.getAllUpstreamWorkflowIds(a.id))this.trySuspendWorkflowByDownstreamRelease(this.workflowRegistrationsByName.get(s))}}},{key:"workflowMeetsSuspendConditions",value:function(t){var a=this;if(this.workflowsWaitingForActivation.has(this.workflowRegistrationsByName.get(t.id))||(t.outputTypes||[]).some(function(l){return a.annotationActivationInfosByType.has(l)}))return!1;var s=!0;for(var u of this.workflowExecutionManager.getAllDownstreamWorkflowIds(t.id))if(!this.workflowsWaitingForActivation.has(this.workflowRegistrationsByName.get(u))&&!this.workflowRegistrationsByName.get(u).suspendExecution){s=!1;break}return s}},{key:"trySuspendWorkflowByDownstreamRelease",value:function(t){this.workflowMeetsSuspendConditions(t.workflow)&&(t.suspendExecution=!0,v.info(509155537,y.CoreDefault,"Downstream workflows fully released, suspending "+t.workflow.id+" execution."))}},{key:"onWorkflowDefinitionOverrideMessage",value:function(t,a){var s,u,l,f,c=new _e({sessionHealthEventName:"WorkflowDefinitionOverride",source:pe.Core,reason:Y.Core,impact:he.None,success:!1,message:"",affectedWorkflows:["All"],joinContextId:(s=t.contextId)!==null&&s!==void 0?s:""},this.clientMetadata).start(),d=function(S,C){c.setReason(S),c.resultDescription=C,v.error(529093136,y.CoreDefault,c.stop()),a(new X({error:C}))},h=(u=this.workflowRegistrationsByName.get(t.sourceWorkflowId))===null||u===void 0?void 0:u.workflow;if(!h){d(Y.Workflow,"Workflow registration for source workflow '"+t.targetWorkflowId+" was not found.");return}var p=(l=this.workflowRegistrationsByName.get(t.targetWorkflowId))===null||l===void 0?void 0:l.workflow;if(!p){d(Y.Workflow,"Workflow registration for target workflow '"+t.targetWorkflowId+" was not found.");return}if(!p.allowDefinitionOverride){d(Y.Workflow,"Workflow '"+p.id+" does not allow workflow definition override.");return}if(!(!((f=h.definitionOverrideTargetWorkflows)===null||f===void 0)&&f.includes(p.id))){d(Y.Workflow,"Workflow '"+h.id+" does not allow workflow definition for workflow '"+p.id+"'.");return}this.workflowDefinitionManager.mergeWorkflowDefinition(p,t.definition,t.contextId),c.success=!0,c.resourceId=h.id,c.resultDescription="Updated config for workflow: "+t.targetWorkflowId+", context id: "+t.contextId,v.info(529093137,y.CoreDefault,c.stop()),a(void 0,new Be)}},{key:"onGetAnnotationsRequestMessage",value:function(t,a){throw new Error("Not implemented yet")}},{key:"onAnnotationConfigUpdateMessage",value:function(t,a){for(var s of this.annotationActivationInfosByType){var u=(0,Oo.default)(s,2),l=u[0],f=u[1],c=f.findIndex(function(p){return p.token===t.token});if(c>=0){var d=f[c];d.config=t.config,f.splice(c,1),f.push(d);for(var h of(0,It.default)(this.workflowsByOutputAnnotation.get(l)||[]))(!Kt(h)||this.isWorkflowTriggeredByNonExclusiveSignals(h))&&!this.workflowsWaitingForActivation.has(this.workflowRegistrationsByName.get(h.id))&&this.tryScheduleWorkflowExecution(this.workflowRegistrationsByName.get(h.id));v.info(529093138,y.CoreDefault,"Updated: "+l+" config by token "+t.token),a(void 0,new _o({token:t.token,success:!0}));return}}v.error(529093139,y.CoreDefault,"Annotation token: "+t.token+" was not found"),a(void 0,new _o({token:t.token,success:!1}))}},{key:"onMicroSyncMessage",value:function(t,a){var s=new we({items:[t.item],parentPath:t.parentPath||["session"]});this.statelessItemListeners.emitEvents([s]),a(void 0,new Be)}},{key:"onSyncMessage",value:function(t,a){var s=this;if(this.downstreamMessageEndpoint&&this.downstreamMessageEndpoint.sendMessage(new Ue(t)),this.contextIdManager.applyContextIdOnOperations(t.ops),this.updateWorkflowExecutionStates(t.ops),t.ops&&t.ops.length>0&&pn.typeGuard(t.ops[0])){this.applySyncMessage(t,a);return}var u=[];if(t.ops&&t.ops.length>0)for(var l of t.ops)if(m.getTypeNameFor(l)===Ze.getTypeName()){var f=function(h){if(!h.body)return 1;var p=function(C){var T=C.workflow.kind===q.SingleItem&&m.matchesTypesFor(h.body,C.workflow.inputTypes),x=Kt(C.workflow)&&m.matchesTypesFor(h.body,C.workflow.triggerSignals);(T||x)&&(v.verbose(536959052,y.CoreDefault,function(){return"Received trigger signal "+m.getTypeNameFor(h.body)+", adding it to cache for waiting workflow "+C.workflow.resourceId}),Array.isArray(C.triggerSignalOpsQueue)||(C.triggerSignalOpsQueue=[]),C.triggerSignalOpsQueue.push(new Ze({parentPath:l.parentPath,items:[h]})),C.triggerSignalOpsQueue.length>lA.getValue()&&(v.verbose(536959053,y.CoreDefault,function(){return"Exceeded max trigger signal cache size for "+C.workflow.resourceId+", discarding oldest"}),C.triggerSignalOpsQueue.shift()))};for(var k of s.workflowsWaitingForActivation)p(k)};for(var c of l.items)f(c);v.info(529093140,y.CoreDefault,"Dispensing signal operation to listeners"),this.statelessItemListeners.emitEvents([l])}else G(l.parentPath)==G(["session","#userContext#"])&&this.userNodePath&&(l.parentPath=(0,It.default)(this.userNodePath)),G(l.parentPath)==G(["session","#tenantContext#"])&&this.tenantNodePath&&(l.parentPath=(0,It.default)(this.tenantNodePath)),G(l.parentPath)==G(["session","#userCommands#"])&&this.userCommandsNodePath&&(l.parentPath=(0,It.default)(this.userCommandsNodePath)),u.push(l);t.ops=u,t.seq!==void 0?this.syncMessageSequencer.onSyncMessage(t,a):(u.length>0&&v.warn(536959054,y.CoreDefault,"SyncMessage with non signal operations and undefined sequence bypassed"),a(void 0,new zt))}},{key:"onWorkflowExecutionManagerSweep",value:function(){var t=this;if(!(this.pendingExecutionStateUpdates.size===0||this.isClosed)){var a=new Map;for(var s of this.annotationActivationInfosByType){var u=(0,Oo.default)(s,2),l=u[0],f=u[1];if(f.some(function(b){return b.sendStateUpdates})){var c=(0,It.default)(this.workflowsByOutputAnnotation.get(l)||[]).filter(function(b){return t.pendingExecutionStateUpdates.has(b)});if(c.length!==0){var d=!0;for(var h of c)if(this.pendingExecutionStateUpdates.get(h)!==ve.Idle){d=!1;break}d?this.lastSeenAnnotationStateByAnnotation.get(l)===rn.Pending&&a.set(l,rn.Idle):(this.lastSeenAnnotationStateByAnnotation.get(l)||rn.Idle)===rn.Idle&&a.set(l,rn.Pending)}}}var p=new Array(a.size),k=0;for(var S of a){var C=(0,Oo.default)(S,2),T=C[0],x=C[1];this.lastSeenAnnotationStateByAnnotation.set(T,x),p[k++]={annotationType:T,state:x}}if(this.pendingExecutionStateUpdates.clear(),p.length>0&&!this.isClosed){var A=new _e({sessionHealthEventName:"SendAnnotationResultStates",source:pe.Core,reason:Y.Core,impact:he.MissingOutput,success:!0,message:"",affectedWorkflows:["All"]}).start();this.upstreamMessageEndpoint.sendMessage(new qr({updates:p}),function(b){A.success=!b||t.isClosed,A.message=b==null?void 0:b.error,A.success?v.verbose(536959056,y.CoreDefault,A.stop()):v.info(536959055,y.CoreDefault,A.stop())})}}}},{key:"onWorkflowExecutionComplete",value:function(t,a){this.enableRemoteExecutionNotification&&this.upstreamMessageEndpoint.sendMessage(new Qr({seq:this.nextWorkflowExecutionCompleteSequenceId++,workflowId:t,contextId:a,ops:[]}),function(s){if(s){var u=new D({operationName:"WorkflowExecutionCompleteMessageError",resourceId:t,joinContextId:a});u.resultDescription=s==null?void 0:s.error,v.error(512354250,y.CoreDefault,u)}})}},{key:"onWorkflowExecutionStateChanged",value:function(t,a){var s=this,u=this.workflowRegistrationsByName.get(t).workflow,l=(0,It.default)(u.outputTypes||[]).some(function(f){return(0,It.default)(s.annotationActivationInfosByType.get(f)||[]).some(function(c){return c.sendStateUpdates})});l&&(this.pendingExecutionStateUpdates.set(u,a),this.workflowExecutionManager.requestSweep())}},{key:"onSeedCompleted",value:function(){this.isSeedingCompleted=!0,this.activateWaitingWorkflows(oa.SeedCompleted)}},{key:"applySyncMessage",value:function(t,a){var s=new _e({sessionHealthEventName:"ApplySyncMessage",source:pe.Core,reason:Y.Core,impact:he.MissingInput,success:!0,message:"seq="+(t==null?void 0:t.seq),resourceId:(t==null?void 0:t.seq)<=0?"Seeding":"NonSeeding"}).start();if(!t||!Array.isArray(t.ops)||!t.ops.length){a(void 0,new zt);return}try{this.cache.applyOperations(t.ops,t.seq),v.info(536959059,y.CoreDefault,s.stop()),a(void 0,new zt)}catch(u){s.success=!1,v.error(536959057,y.CoreDefault,s.stop()),v.error(536959058,y.CoreDefault,"Cache apply failed: "+u.stack),a(new X({error:"Failed to commit"}));return}}},{key:"activateWorkflowByType",value:function(t){if(t.isActivated=!0,t.workflow.kind===q.SingleItem)this.activateSingleItemWorkflow(t);else if(t.workflow.kind===q.DynamicText)this.activateDynamicTextWorkflow(t);else if(t.workflow.kind===q.Reduce)this.activateReduceWorkflow(t);else if(t.workflow.kind===q.Grid)this.activateGridNeighborhoodWorkflow(t);else if(t.workflow.kind===q.Join)this.activateJoinWorkflow(t);else if(t.workflow.kind===q.Generic)this.activateGenericWorkflow(t);else throw new Error("Unknown workflow type");var a=t.workflow.kind;(a===q.Reduce||a===q.DynamicText||a===q.Generic)&&this.setupEventListener(t),this.setupContextListener(t),this.emit("workflowActivated",t)}},{key:"onAnnotationResultsMessage",value:function(t,a){this.upstreamMessageEndpoint.sendMessage(new wt(t),a);try{this.cache.applyOperations(t.ops,void 0)}catch(s){}}},{key:"shouldTriggerOnAnnotationMetadataUpdated",value:function(t,a){var s;return!!(t!=null&&t.M_&&(!((s=a.triggerConditions)===null||s===void 0)&&s.includes(Lt.AnnotationMetadataUpdated)))}},{key:"shouldInvalidateOnEvent",value:function(t){var a,s,u,l=t.workflow.eventSequenceOptions,f=(s=(a=l.windowIncrement)!==null&&a!==void 0?a:l.minWindowSize)!==null&&s!==void 0?s:1;if(t.eventCountSinceLastTrigger<f)return!1;var c=Date.now()-t.lastTriggerByEventsTime;return!((u=c<l.minTimeIncrement)!==null&&u!==void 0&&u)}},{key:"setupEventListener",value:function(t){var a=this;!t.workflow.eventSequenceOptions||t.workflow.eventSequenceOptions.shouldTriggerWorkflow===!1||this.cache.onItemChange(Mr.getTypeName(),t.workflow.inputStage,function(s){if(!t.suspendExecution){for(var u of s){var l=m.getTypeNameFor(u);for(var f of u.items)l===we.getTypeName()&&ds(f.body,t.workflow.eventSequenceOptions)&&t.eventCountSinceLastTrigger++}a.shouldInvalidateOnEvent(t)&&t.invalidate([{isInvalidatedByEvents:!0}])}})}},{key:"setupContextListener",value:function(t){if(!(!t.workflow.requestedContextTypesRules||Kt(t.workflow)&&!this.isWorkflowTriggeredByNonExclusiveSignals(t.workflow)||t.workflow.kind==q.Join||vr(t.workflow))){for(var a of t.workflow.requestedContextTypesRules)if(a.shouldTriggerOnContextChange)for(var s of a.contextTypes)this.onContextChange(s,t)}}},{key:"onContextChange",value:function(t,a){var s=this,u=function(f,c,d){if(!d)return!1;var h=s.cache.getItem(d);if(!h)return!1;var p=G(d),k=h.body&&m.matchesTypesFor(h.body,[Mt.getTypeName(),Pn.getTypeName(),ro.getTypeName()]),S;return L("AddSessionAsContextHolder")?S=G(s.userNodePath)===p||G(s.tenantNodePath)===p||p==="session":S=G(s.userNodePath)===p||G(s.tenantNodePath)===p,k||S?(f.push({opType:c,updatedContextScope:k?d:[]}),!0):!1};this.cache.onItemChange(t,a.workflow.inputStage,function(l){var f;if(!a.suspendExecution){var c=[];for(var d of l){var h=m.getTypeNameFor(d);if(!(h===ot.getTypeName()&&!s.shouldTriggerOnAnnotationMetadataUpdated(d,a.workflow)&&!s.isAnnotationMetadataRejection(d))){var p=u(c,h,d.parentPath);if(!p&&L("ContextHolderAsSelfContext"))for(var k of(f=d.items)!==null&&f!==void 0?f:[])k!=null&&k.id&&u(c,h,[].concat((0,It.default)(d.parentPath),[k.id]))}}c.length>0&&a.invalidate(c)}})}},{key:"activateSingleItemWorkflow",value:function(t){var a=this;if(t.workflow.inputTypes)for(var s of t.workflow.inputTypes)this.cache.onItemChange(s,t.workflow.inputStage,function(u){if(!t.suspendExecution){var l=[];for(var f of u){var c=m.getTypeNameFor(f);for(var d of f.items)if(c===we.getTypeName()||c===Ne.getTypeName()||c===pn.getTypeName()||c===ot.getTypeName()&&a.shouldTriggerOnAnnotationMetadataUpdated(f,t.workflow)){var h=a.createInvalidationParam(t,c,f.parentPath,d);l.push(h)}}l.length>0&&t.invalidate(l)}}),this.statelessItemListeners.onItemChange(s,t.workflow.inputStage,function(u){if(!t.suspendExecution){var l=[];for(var f of u)for(var c of f.items){var d=a.createInvalidationParam(t,m.getTypeNameFor(f),f.parentPath,c);l.push(d)}l.length>0&&t.invalidate(l)}})}},{key:"activateDynamicTextWorkflow",value:function(t){var a=this;if(t.workflow.inputTypes)for(var s of t.workflow.inputTypes)this.cache.onItemChange(s,t.workflow.inputStage,function(u){if(!t.suspendExecution){var l=[];for(var f of u){var c=m.getTypeNameFor(f);for(var d of f.items)if(c===we.getTypeName()||c===Ne.getTypeName()){var h=a.createInvalidationParam(t,c,f.parentPath,d);l.push(h)}}l.length>0&&t.invalidate(l)}})}},{key:"onTriggerSignalReceived",value:function(t,a,s){var u=m.getTypeNameFor(t);if(u===we.getTypeName()||u===Ze.getTypeName()){var l=a.body;l?this.scheduleWorkflowExecution(s,[l]):v.error(536959060,y.CoreDefault,"Attempted triggering of workflow "+s.workflow.id+" by an object which is not a signal")}}},{key:"isAnnotationMetadataRejection",value:function(t){var a;return((a=t==null?void 0:t.M_)===null||a===void 0?void 0:a.state)===bt.Rejected}},{key:"activateReduceWorkflow",value:function(t){var a=this;if(Kt(t.workflow))for(var s of t.workflow.triggerSignals)this.cache.onItemChange(s,t.workflow.inputStage,function(f){if(!t.suspendExecution)for(var c of f)for(var d of c.items)a.onTriggerSignalReceived(c,d,t)}),this.statelessItemListeners.onItemChange(s,t.workflow.inputStage,function(f){if(!t.suspendExecution)for(var c of f)for(var d of c.items)a.onTriggerSignalReceived(c,d,t)});if(!Kt(t.workflow)||this.isWorkflowTriggeredByNonExclusiveSignals(t.workflow)){var u=new Set(t.workflow.inputTypes);u.add(t.workflow.collectionScopeType);for(var l of u)this.cache.onItemChange(l,t.workflow.inputStage,function(f){if(!t.suspendExecution)for(var c of f){var d=m.getTypeNameFor(c);if(!(d===ot.getTypeName()&&!a.shouldTriggerOnAnnotationMetadataUpdated(c,t.workflow)&&!a.isAnnotationMetadataRejection(c)))for(var h of c.items){var p=a.createInvalidationParam(t,d,c.parentPath,h);t.invalidate([p])}}},!0)}}},{key:"activateJoinWorkflow",value:function(t){var a=this,s=new Set(t.workflow.inputTypes);s.add(t.workflow.collectionScopeType);for(var u of s)this.cache.onItemChange(u,t.workflow.inputStage,function(l){if(!t.suspendExecution)for(var f of l){var c=m.getTypeNameFor(f);if(!(c===ot.getTypeName()&&!a.shouldTriggerOnAnnotationMetadataUpdated(f,t.workflow)&&!a.isAnnotationMetadataRejection(f))&&c!==Fe.getTypeName())for(var d of f.items){var h=a.createInvalidationParam(t,c,f.parentPath,d);t.invalidate([h])}}},!0),this.statelessItemListeners.onItemChange(u,t.workflow.inputStage,function(l){if(!t.suspendExecution){var f=[];for(var c of l){var d=m.getTypeNameFor(c);if(d!==Fe.getTypeName())for(var h of c.items){var p=a.createInvalidationParam(t,d,c.parentPath,h);f.push(p)}}f.length>0&&t.invalidate(f)}})}},{key:"activateGenericWorkflow",value:function(t){var a=this;if(Kt(t.workflow))for(var s of t.workflow.triggerSignals)this.cache.onItemChange(s,t.workflow.inputStage,function(l){if(!t.suspendExecution)for(var f of l)for(var c of f.items)a.onTriggerSignalReceived(f,c,t)}),this.statelessItemListeners.onItemChange(s,t.workflow.inputStage,function(l){if(!t.suspendExecution)for(var f of l)for(var c of f.items)a.onTriggerSignalReceived(f,c,t)});if(!Kt(t.workflow)||this.isWorkflowTriggeredByNonExclusiveSignals(t.workflow))for(var u of t.workflow.invalidationTypes||[])this.cache.onItemChange(u,t.workflow.inputStage,function(l){if(!t.suspendExecution)for(var f of l){var c=m.getTypeNameFor(f);if(!(c===ot.getTypeName()&&!a.shouldTriggerOnAnnotationMetadataUpdated(f,t.workflow)&&!a.isAnnotationMetadataRejection(f)))for(var d of f.items){var h=a.createInvalidationParam(t,c,f.parentPath,d);t.invalidate([h])}}})}},{key:"activateGridNeighborhoodWorkflow",value:function(t){this.activateReduceWorkflow(t)}},{key:"createInvalidationParam",value:function(t,a,s,u){var l=Ct(s,u);return{opType:a,item:l,isDeltaUpdate:!1}}},{key:"queueGridNeighborhoodWorkflow",value:function(t,a,s,u,l,f,c,d){throw new Error("NYI")}},{key:"queueWorkflow",value:function(t,a,s){var u=this;v.debug(537781760,y.CoreDefault,function(){return"Queuing Workflow. Queue Length: "+u.workflowQueue.length()+" Running: "+u.workflowQueue.running()});var l=rl(),f=new _e({sessionHealthEventName:"QueueSessionWorkflow",resourceId:t.workflow.resourceId,success:!0,source:pe.Core,reason:Y.Core,impact:he.MissingOutput,message:"",affectedWorkflows:[t.workflow.resourceId]},this.clientMetadata).start(),c={cc:l,queueOp:f,registration:t,executionId:t.totalExecutionCount++,tasks:a};this.usesRefactoredDebouncing?(c.containsPrefilteredTasks=s,t.queueTask(c)):t.queueTaskOld(c)}},{key:"processPrefilterActionResults",value:function(t,a){var s,u=!1;for(var l of a.tasks)!l.prefilterActionResults||l.status===Ve.ExecutionCancelled||l.status===Ve.ResultsCancelled||(!((s=t.modelOptions)===null||s===void 0)&&s.includeItemOperations&&this.inputChangesManager.resetChanges(t.id,[].concat((0,It.default)(l.scopeItem.parentPath),[l.scopeItem.id])),this.processAnnotationQueue(t,l.prefilterActionResults),u=!0);return u}},{key:"convertTaskToWorkflowInput",value:function(t,a){return{scopeItem:t.scopeItem,inputItems:t.inputItems,inputContext:t.inputContext,triggerSignals:t.triggerSignals,existingAnnotations:t.previousAnnotations,dynamicContext:t.dynamicContextItems,annotationActivationConfigs:this.getAnnotationActivationConfigs(a.outputTypes),requestedContexts:t.requestedContextsAndEvents}}},{key:"filterCancelledWorkflowTasks",value:function(t){if(this.usesRefactoredDebouncing){var a=[];for(var s of t.tasks)s.status!==Ve.ExecutionCancelled&&s.status!==Ve.ResultsCancelled&&(s.status=Ve.Running,a.push(s));return a}return t.tasks}},{key:"executeWorkflow",value:function(t,a){var s=this;Re(function(){var u=t.registration.workflow;if(s.isClosed){v.info(537781761,y.CoreDefault,"Session is closed - skipping execution of workflow "+u.id),a();return}var l=function(){a();for(var x of t.tasks)x.status!==Ve.ResultsCancelled&&x.status!==Ve.ExecutionCancelled&&(s.usesRefactoredDebouncing?s.workflowSynchronizationManager.notifyOnCompleted(x,t.registration.workflow.id):t.registration.onTaskCompleted(x))};if(t.tasks=s.filterCancelledWorkflowTasks(t),t.tasks.length===0){a();return}var f=t.queueOp.stop(),c=function(){v.info(536959061,y.CoreDefault,f)},d=f.durationMs;if(u.maxQueueWaitTimeMs&&d>u.maxQueueWaitTimeMs){v.info(536959062,y.CoreDefault,"Workflow "+u.id+" queue wait time ("+d+") exceeded specified maximum queue wait time ("+u.maxQueueWaitTimeMs+") - skipping workflow execution"),l(),f.success=!1,f.dimension0="WorkflowExecutionCancelled",c();return}if(t.containsPrefilteredTasks){var h=s.processPrefilterActionResults(u,t);l(),f.dimension0=h?"Prefiltered:WithActionResults":"Prefiltered:NoActionResults",c();return}s.stats.workflowExecutions++,c(),t.tasks.some(function(T){return T.isTriggeredByEvents})&&(t.registration.lastTriggerByEventsTime=Date.now(),t.registration.eventCountSinceLastTrigger=0);var p=new _e({sessionHealthEventName:"ExecuteSessionWorkflow",resourceId:u.resourceId,source:pe.Core,reason:Y.Core,impact:he.MissingOutput,success:!0,message:"",affectedWorkflows:[u.resourceId]},s.clientMetadata).start(),k=function(x){p.stop(),x!==void 0&&x>0&&(p.durationMs-=x),p.success||s.stats.workflowExecutionErrors++,s.stats.workflowExecutionDurationMsMax=Math.max(p.durationMs,s.stats.workflowExecutionDurationMsMax),v.info(524339278,y.CoreDefault,p)},S=t.tasks.map(function(T){return s.convertTaskToWorkflowInput(T,u)}),C=function(x,A,b){var E;if(L("AllowResultOperationToPassIsTriggeredBySyncDeltaProp")&&(!((E=x.triggerConditions)===null||E===void 0)&&E.some(function(_){return _===Lt.DeltaUpdate}))&&(A!=null&&A.length)){var I=b==null?void 0:b.some(function(_){var M;return(M=_.deltas)===null||M===void 0?void 0:M.some(function(N){var R=N;return!(R!=null&&R.content)&&(R==null?void 0:R.unit)===Oe.Sentence&&(R==null?void 0:R.deltaType)===fe.Update})});I&&A.forEach(function(_){return _.isTriggeredBySyncDelta=!0})}};s.workflowClientCoordinator.executeWorkflow(u,S,function(T,x){var A,b;if(L("StopWorkflowsOnClose")&&s.isClosed){l(),v.info(524339279,y.CoreDefault,"Session is closed - skipping processing results of workflow "+u.id);return}for(var E=[],I=0;I<S.length;I++){var _=t.tasks[I],M=(x==null?void 0:x.length)>I?x[I]:void 0;if(C(u,M==null?void 0:M.annotations,S[I].inputItems),p.success=!0,p.dimension0="",p.dimension1=String(M==null?void 0:M.ignoreExecution),p.dimension2="",p.joinContextId=(A=_.scopeItem.contextId)!==null&&A!==void 0?A:"",p.message="",p.resultDescription="",p.setReason(Y.Core),p.setSource(pe.Core),p.setImpact(he.MissingOutput),T)v.info(524339280,y.CoreDefault,"Failure during workflow "+u.id+" execution "+T),p.success=!1,p.dimension0=K[Kf(T.message)],p.resultDescription=T.stack,ts.has(T.message)&&Lm(K[T.message])?s.stats.workflowExecutionInfraErrors++:p.setReason(ts.has(T.message)&&K[T.message]===K.RequiredTokenNotAvailable?Y.Client:Y.Workflow);else if((x==null?void 0:x.length)!==S.length)p.success=!1,v.error(524339281,y.CoreDefault,"Workflow Inputs/Outputs length mismatch. Expected "+S.length+", Actual: "+(x==null?void 0:x.length));else if(M.error)v.info(524339282,y.CoreDefault,"Failure during workflow "+u.id+" execution "+M.error),p.success=!1,p.dimension0=K[Kf(M.error)],p.resultDescription=M.error,p.setReason(Y.Workflow),M.isExpectedError&&(p.success=!0,p.dimension2="ExpectedFailure");else if(!M.ignoreExecution&&!M.annotations)v.info(524339283,y.CoreDefault,"Workflow "+u.id+" is disabled - no error, no annotations"),p.dimension0=K[K.WorkflowDisabled];else if(!M.ignoreExecution&&!Array.isArray(M.annotations)){v.error(524339284,y.CoreDefault,"annotationQueue is not an array"),p.success=!1;var N=K.WorkflowWrongAnnotationType;p.dimension0=K[N],p.setReason(Y.Workflow)}if(Array.isArray(M==null?void 0:M.annotations)){var R=_.scopeItem||(_.inputItems&&_.inputItems.length===1?_.inputItems[0]:void 0),P=R?[].concat((0,It.default)(R.parentPath),[R.id]):void 0;E.push({scopeItemPath:P,scopeItemRevId:R==null?void 0:R.revId,annotationQueue:M.annotations})}k(),s.emit("workflowFinished",{success:p.success,hadAnnotations:Array.isArray(M==null?void 0:M.annotations)&&(M==null?void 0:M.annotations.length)>0,queueIdle:s.workflowQueue.idle(),workflowId:t.registration.workflow.id,parentPath:_.scopeItem.parentPath,itemId:_.scopeItem.id}),!((b=u.modelOptions)===null||b===void 0)&&b.includeItemOperations&&!T&&!(M!=null&&M.error)&&!M.ignoreExecution&&s.inputChangesManager.resetChanges(u.id,[].concat((0,It.default)(_.scopeItem.parentPath),[_.scopeItem.id]))}E.length>0&&s.processAnnotationQueue(u,E),l()})},t.cc)}},{key:"getAnnotationActivationConfigs",value:function(t){var a=[];for(var s of t||[]){var u=this.annotationActivationInfosByType.get(s),l=[];for(var f of u||[])f.config&&l.push(f.config);l.length>0&&a.push({annotationType:s,configs:l})}return a.length>0?a:void 0}},{key:"onTokenProvisionMessage",value:function(t,a){var s=new _e({sessionHealthEventName:"TokenProvision",success:!1,source:pe.Core,reason:Y.Client,impact:he.MissingInput,message:"",resourceId:"undefined",affectedWorkflows:["All"]},this.clientMetadata).start();{var u=a;a=function(f,c){s.success=!f&&!!c,(f==null?void 0:f.error)==="Unexpected server error."&&s.setReason(Y.Core),v.info(524027904,y.CoreDefault,s.stop()),u(f,c)}}this.downstreamMessageEndpoint?this.downstreamMessageEndpoint.sendMessage(t,a):a(void 0,new Be)}},{key:"createSessionModelNodeIfNotExists",value:function(t,a,s){try{var u=this.cache.getItem([].concat((0,It.default)(t),[a]));if(u){v.debug(536959063,y.CoreDefault,"Node "+a+" already added in the cache");return}}catch(f){if(f instanceof eo)v.debug(536959064,y.CoreDefault,"Node "+a+" not found in the cache");else throw f}var l=[new we({parentPath:t,items:[s]})];try{this.cache.applyOperations(l,void 0),v.debug(536959066,y.CoreDefault,"Successfully added node "+a+" in the cache")}catch(f){throw v.error(536959065,y.CoreDefault,"Failed to add node "+a+" to the cache."),f}}},{key:"createUserNodeIfNotExists",value:function(){var t="user_userId",a=["session","user"];this.createSessionModelNodeIfNotExists(a,t,{id:t,body:new ur,source:Oc}),this.userNodePath=[].concat(a,[t])}},{key:"createTenantNodeIfNotExists",value:function(){var t="tenant_userId",a=["session","user"];this.createSessionModelNodeIfNotExists(a,t,{id:t,body:new lr,source:Oc}),this.tenantNodePath=[].concat(a,[t])}},{key:"createUserCommandsNodeIfNotExists",value:function(){var t="commands_userId",a=["session","user"];this.createSessionModelNodeIfNotExists(a,t,{id:t,body:new ii,source:Oc}),this.userCommandsNodePath=[].concat(a,[t])}},{key:"workflowMeetsActivationConditions",value:function(t){var a=this,s="",u=!0,l=this.getActivationTierForCurrentSession(t);if(l===cn.NeverActivate)return v.verbose(536959067,y.CoreDefault,function(){return"Workflow "+t.id+" is disabled in "+a.clientMetadata.appName+"/"+a.clientMetadata.appPlatform+"/"+a.clientMetadata.releaseAudienceGroup+"/"+a.clientMetadata.tenantGroup+" session"}),{meetsConditions:!1,waitingReasons:'["'+Lo.WorkflowDisabled+'"]',isEnabledAndActivatedByClient:!1};this.isWorkflowWaitingForAnnotationActivation(t,l)&&(s+='"'+Lo.AnnotationActivation+'"',u=!1),this.isWaitingForFlight(t.activationFlightsConfigs)&&(s+=(s.length===0?"":", ")+'"'+Lo.Flight+'"'),this.isWorkflowWaitingForSeedCompleted(t)&&(s+=(s.length===0?"":", ")+'"'+Lo.Seeding+'"');var f=s.length===0;return s="["+s+"]",{meetsConditions:f,waitingReasons:s,isEnabledAndActivatedByClient:u}}},{key:"isWorkflowWaitingForSeedCompleted",value:function(t){return t.inputStage&Zt.OnSeed&&this.isSeedingCompleted===!1}},{key:"isWorkflowWaitingForAnnotationActivation",value:function(t,a){if(a>=Rk.getValue()&&(!t.outputTypes||t.outputTypes.length===0))return t.activationConfigs.some(function(f){return f.activationTier===cn.PreActivate})||v.warn(536959068,y.CoreDefault,t.id+" with no outputs should be pre-activated."),!0;if(a<Rk.getValue())return!1;var s=!1,u=!1;for(var l of t.outputTypes||[])if(s=this.annotationActivationInfosByType.has(l),s||(u=this.outputAnnotationsRequiredByDownstreamWorkflows.has(l),u))break;return!s&&!u}},{key:"matchesClientAppName",value:function(t){var a,s;if(t.clientAppName==="All")return!0;var u=(s=(a=this.clientMetadata)===null||a===void 0?void 0:a.appName)===null||s===void 0?void 0:s.toLowerCase();return u===void 0?!1:!!(t.clientAppName.toLowerCase()===u||t.clientAppName==="Fluid_*"&&u.startsWith("fluid_"))}},{key:"matchesClientTenantGroup",value:function(t){var a,s;return t==="All"||t===void 0||t.toLowerCase()===((s=(a=this.clientMetadata)===null||a===void 0?void 0:a.tenantGroup)===null||s===void 0?void 0:s.toLowerCase())}},{key:"getActivationTierForCurrentSession",value:function(t){var a,s,u,l,f=cn.Default;for(var c of t.activationConfigs)this.matchesClientAppName(c)&&(c.clientAppPlatform==="All"||c.clientAppPlatform.toLowerCase()===((s=(a=this.clientMetadata)===null||a===void 0?void 0:a.appPlatform)===null||s===void 0?void 0:s.toLowerCase()))&&(c.clientReleaseAudienceGroup==="All"||c.clientReleaseAudienceGroup===void 0||c.clientReleaseAudienceGroup.toLowerCase()===((l=(u=this.clientMetadata)===null||u===void 0?void 0:u.releaseAudienceGroup)===null||l===void 0?void 0:l.toLowerCase()))&&this.matchesClientTenantGroup(c.clientTenantGroup)&&(f=c.activationTier);return f===cn.PreActivate&&!cA.getValue().includes(t.id)&&(v.warn(536959069,y.CoreDefault,"Workflow "+t.id+" is not allowed to preactivate"),f=cn.Default),f}},{key:"isWaitingForFlight",value:function(t){var a=this;if(!t||t.length<=0)return!1;var s=this.clientMetadata.appName.toLowerCase().trim(),u=!1;for(var l of t){var f=l.clientAppName.toLowerCase().trim();if(f==="all"||f===s){if((!Array.isArray(l.requiredFlights)||l.requiredFlights.every(function(c){return a.isClientOnFlight(c)}))&&(!Array.isArray(l.restrictedFlights)||!l.restrictedFlights.some(function(c){return a.isClientOnFlight(c)})))return!1;u=!0}}return u}},{key:"isClientOnFlight",value:function(t){return this.clientMetadataFlightsSet.has(t.toLowerCase().trim())}},{key:"addWorkflowToDependencyMaps",value:function(t){var a,s,u,l,f,c,d;for(var h of(a=t.outputTypes)!==null&&a!==void 0?a:[]){var p=(s=this.workflowsByOutputAnnotation.get(h))!==null&&s!==void 0?s:new Set;p.add(t),this.workflowsByOutputAnnotation.set(h,p)}for(var k of(u=t.inputTypes)!==null&&u!==void 0?u:[]){var S=(l=this.workflowsByInputAnnotation.get(k))!==null&&l!==void 0?l:new Set;S.add(t),this.workflowsByInputAnnotation.set(k,S),this.workflowInputTypes.add(k)}for(var C of(f=t.triggerSignals)!==null&&f!==void 0?f:[])this.workflowInputTypes.add(C);t.collectionScopeType&&this.workflowInputTypes.add(t.collectionScopeType);for(var T of(c=t.requestedContextTypesRules)!==null&&c!==void 0?c:[])for(var x of T.contextTypes){var A=(d=this.workflowsByRequestedContextType.get(x))!==null&&d!==void 0?d:new Set;A.add(t),this.workflowsByRequestedContextType.set(x,A),this.workflowInputTypes.add(x)}}},{key:"getAllUpstreamInputTypesByAnnotationType",value:function(t){var a=this,s,u=new Set([t]);return(s=this.workflowsByOutputAnnotation.get(t))===null||s===void 0||s.forEach(function(l){var f,c,d,h=[].concat((0,It.default)(a.workflowExecutionManager.getAllUpstreamWorkflowIds(l.id)),[l.id]);for(var p of h)(d=(c=(f=a.workflowRegistrationsByName.get(p))===null||f===void 0?void 0:f.workflow)===null||c===void 0?void 0:c.inputTypes)===null||d===void 0||d.forEach(function(k){return u.add(k)})}),u}},{key:"activateWaitingWorkflows",value:function(t){var a=new _e({sessionHealthEventName:"ActivateWaitingWorkflows",resourceId:t,success:!1,source:pe.Core,reason:Y.Core,impact:he.MissingOutput,message:"",affectedWorkflows:["All"]}).start();try{if(this.workflowsWaitingForActivation.size>0){v.info(536959070,y.CoreDefault,"Checking activation conditions for "+this.workflowsWaitingForActivation.size+" waiting workflows");for(var s of this.workflowsWaitingForActivation)this.tryActivateWorkflow(s)}a.success=!0}finally{a.stop();var u=function(){return a};a.durationMs>fA.getValue()||!a.success?v.info(536959071,y.CoreDefault,u):v.debug(536959072,y.CoreDefault,u)}}},{key:"tryActivateWorkflow",value:function(t){var a,s=new _e({sessionHealthEventName:"TryActivateWorkflow",source:pe.Core,reason:Y.Core,impact:he.MissingOutput,success:!0,message:'{"activated":true}',resourceId:t.workflow.resourceId,affectedWorkflows:[t.workflow.resourceId]},this.clientMetadata).start();try{var u=this.workflowMeetsActivationConditions(t.workflow),l=u.meetsConditions,f=u.waitingReasons,c=u.isEnabledAndActivatedByClient;if(!l){c?s.message=JSON.stringify({activated:!1,waitingReasons:f,requiredTokens:t.workflow.requiredTokenTypes}):s=void 0;return}v.info(536959073,y.CoreDefault,"Activating workflow "+t.workflow.id),t.invalidationFilter=Xy(this.clientMetadata,t.workflow.id);var d=[];for(var h of(a=t.workflow.requestedContextTypesRules)!==null&&a!==void 0?a:[])!h.activationConditions||!this.isWaitingForFlight(h.activationConditions)?d.push(h):v.info(536959074,y.CoreDefault,"Condition for contexts '"+JSON.stringify(h.contextTypes)+"' is not fulfilled.");this.workflowDefinitionManager.mergeWorkflowDefinition(t.workflow,{requestedContextTypesRules:d}),this.tryActivateUpstreamWorkflows(t.workflow),t.workflow.inputStage&~Zt.OnSeed&&this.activateWorkflowByType(t),this.tryScheduleWorkflowExecution(t),this.workflowsWaitingForActivation.delete(t)}catch(p){throw s&&(s.success=!1),p}finally{s&&v.info(536959075,y.CoreDefault,s.stop())}}},{key:"tryActivateUpstreamWorkflows",value:function(t){var a,s,u=this.workflowDefinitionManager.getWorkflowDefinition(t),l=u.requestedContextTypesRules,f=Xn(l).map(function(k){var S=(0,Oo.default)(k,2),C=S[0],T=S[1];return C}),c=((a=t.inputTypes)!==null&&a!==void 0?a:[]).concat(f);for(var d of c){this.outputAnnotationsRequiredByDownstreamWorkflows.add(d);for(var h of(s=this.workflowsByOutputAnnotation.get(d))!==null&&s!==void 0?s:[]){var p=this.workflowRegistrationsByName.get(h.id);this.workflowsWaitingForActivation.has(p)&&this.tryActivateWorkflow(p)}}}},{key:"tryScheduleWorkflowExecution",value:function(t){var a,s,u=!1;if(((a=t.triggerSignalOpsQueue)===null||a===void 0?void 0:a.length)>0||Kt(t.workflow)){var l=t.workflow.kind!==q.SingleItem?this.cache.getSubtreeItems([],t.workflow.triggerSignals):void 0,f,c;if((l==null?void 0:l.length)>0?(v.info(536959104,y.CoreDefault,"Found trigger signal(s) in model for workflow: "+t.workflow.id),c=l.map(function(k){return k.body})):(c=[],((s=t.triggerSignalOpsQueue)===null||s===void 0?void 0:s.length)>0&&(v.info(536959105,y.CoreDefault,"Found "+t.triggerSignalOpsQueue.length+" trigger signal(s) (first type: "+m.getTypeNameFor(t.triggerSignalOpsQueue[0].items[0].body)+") in cache for workflow: "+t.workflow.id),f=t.triggerSignalOpsQueue,c=f.map(function(k){return k.items[0].body}),t.triggerSignalOpsQueue=void 0)),t.workflow.kind===q.SingleItem){if((f==null?void 0:f.length)>0){var d=[];for(var h of f){var p=Ct(h.parentPath,h.items[0]);d.push({opType:m.getTypeNameFor(h),item:p})}d.length>0&&(t.invalidate(d),u=!0)}}else(c==null?void 0:c.length)>0&&(this.scheduleWorkflowExecution(t,c),u=!0)}!u&&t.workflow.inputStage&~Zt.PostSeed&&(!Kt(t.workflow)||this.isWorkflowTriggeredByNonExclusiveSignals(t.workflow))&&this.scheduleWorkflowExecution(t)}},{key:"scheduleWorkflowExecution",value:function(t,a){t.invalidate([{triggerSignals:a}])}},{key:"isWorkflowTriggeredByNonExclusiveSignals",value:function(t){return L("EnableNonExclusiveTriggerSignals")&&ea(t)}}]),e}(Pk.EventEmitter);g();var Qk=w(W()),jk=w(B());g();var Hk=w(W()),zk=w(B());g();var Fk=w(Ie());g();function Lk(n,o){var e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,r={firstDiffLeft:0,firstDiffRight:o.length},t,a;return n.length<o.length?(t=n,a=o):(t=o,a=n),a.indexOf(t)===0?(r.firstDiffLeft=t.length,r.firstDiffRight=0):a.endsWith(t)?(r.firstDiffLeft=0,r.firstDiffRight=t.length):(r=gA(n,o,e),r.firstDiffLeft+r.firstDiffRight>t.length&&(r.firstDiffRight=t.length-r.firstDiffLeft)),hA(r,n,o),r}function hA(n,o,e){if(n.firstDiffLeft>0){var r=n.firstDiffLeft<o.length&&As(o,n.firstDiffLeft),t=n.firstDiffLeft<e.length&&As(e,n.firstDiffLeft);(r||t)&&(n.firstDiffLeft-=1)}if(n.firstDiffRight>1){var a=n.firstDiffRight<o.length&&As(o,o.length-n.firstDiffRight),s=n.firstDiffRight<e.length&&As(e,e.length-n.firstDiffRight);(a||s)&&(n.firstDiffRight-=1)}}function gA(n,o){var e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,r={firstDiffLeft:0,firstDiffRight:o.length},t;for(t=0;t<n.length&&t<o.length;t+=1){var a=n.charCodeAt(t),s=o.charCodeAt(t);if(a!==s&&!(_s(a,e)&&_s(s,e)))break}for(r.firstDiffLeft=t,t=0;t<n.length&&t<o.length;t+=1){var u=n.charCodeAt(n.length-t-1),l=o.charCodeAt(o.length-t-1);if(u!==l&&!(_s(u,e)&&_s(l,e)))break}return r.firstDiffRight=t,r}function _s(n){var o=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;switch(n){case 12288:case 8197:case 32:case 11:case 9:case 160:return!0;case 13:case 10:case 65532:return!o}return!1}function As(n,o){return n.charCodeAt(o)>=56320&&n.charCodeAt(o)<=57343}var bs=w(Ci()),Fo=/[ \u00a0\u2000-\u200a\u202f\u205f\u3000\t]/g,ia=/[.!?]/g;function qk(n,o){var e=[],r=Uk(n,o);return r&&e.push(r),e}function Gk(n,o){var e=[],r=Uk(n,o);r&&e.push(r);var t=mA(n,o,r);t&&e.push(t);var a=vA(n,o,r);a&&e.push(a);var s=yA(n,o);return s&&e.push(s),e}function Uk(n,o){var e=n.content,r=o.content,t=Lk(e,r),a=t.firstDiffLeft,s=e.length-t.firstDiffRight,u=r.length-t.firstDiffRight,l=fe.Update,f=void 0;if(e.length!==r.length)s===a?(l=fe.Add,f=e[e.length-1]):u===a&&(l=fe.Delete,f=r[r.length-1]);else if(e===r)return;var c=0,d;switch(l){case fe.Update:c=s-a,d=r.substring(a,u);break;case fe.Add:d=r.substring(a,u);break;case fe.Delete:c=s-a,d=e.substring(a,s);break}var h=wA(d,f);if(h!==void 0)return new un({content:l!==fe.Delete?d:void 0,deltaType:l,unit:h,position:a,length:l!==fe.Add?c:0})}function mA(n,o,e){var r,t,a,s,u,l,f=n,c=o;if(!((f==null?void 0:f.ipPosition)===(c==null?void 0:c.ipPosition)&&(f==null?void 0:f.isColdIp)===(c==null?void 0:c.isColdIp))){if((f==null?void 0:f.isColdIp)===(c==null?void 0:c.isColdIp)&&e){if(e.deltaType===fe.Add){if((c==null?void 0:c.ipPosition)===((r=e.position)!==null&&r!==void 0?r:0)+((t=e.length)!==null&&t!==void 0?t:0))return}else if(e.deltaType===fe.Update){if((c==null?void 0:c.ipPosition)===((a=e.position)!==null&&a!==void 0?a:0)+((u=(s=e.content)===null||s===void 0?void 0:s.length)!==null&&u!==void 0?u:0))return}else if(e.deltaType===fe.Delete&&(c==null?void 0:c.ipPosition)===((l=e.position)!==null&&l!==void 0?l:0))return}return new un({deltaType:fe.CursorUpdate,cursorData:{ipPosition:c==null?void 0:c.ipPosition,isColdIp:c==null?void 0:c.isColdIp}})}}function vA(n,o,e){var r,t,a,s,u,l,f,c=n,d=o;if(((r=d.formattedRanges)===null||r===void 0?void 0:r.length)<=((t=c.formattedRanges)===null||t===void 0?void 0:t.length)){if(e){var h=c.formattedRanges?(0,Fk.default)(c.formattedRanges):[],p=kA(c.formattedRanges,e,e.position),k=p?h.indexOf(p):-1;if(k!==-1&&(e.position+(e.length||0)>p.start+p.length?p.length=e.position+((a=e.content)!==null&&a!==void 0?a:"").length-p.start:p.length+=((s=e.content)!==null&&s!==void 0?s:"").length-(e.length||0),h[k]=p),h.length>0){for(var S of h.slice(k+1))S.start<e.position||(e.position+(e.length||0)>S.start?(S.length=S.start+S.length-(e.position+(e.length||0)),S.start=e.position+((u=e.content)!==null&&u!==void 0?u:"").length):S.start+=((l=e.content)!==null&&l!==void 0?l:"").length-(e.length||0));h=h.filter(function(T){return T.length>0})}var C=(f=d==null?void 0:d.formattedRanges)!==null&&f!==void 0?f:[];if((0,bs.default)(h,C)||h.length===0&&C.length===0)return}else if((0,bs.default)(c==null?void 0:c.formattedRanges,d==null?void 0:d.formattedRanges))return}return new un({deltaType:fe.FormattingUpdate,formattedRanges:d==null?void 0:d.formattedRanges})}function yA(n,o){var e=n,r=o,t,a={},s=!1;for(t in r)["ipPosition","isColdIp","content","formattedRanges"].indexOf(t)===-1&&((0,bs.default)(r[t],e[t])||(s=!0,a[t]=r[t]));if(s)return new un({deltaType:fe.OtherNonContentUpdate,otherNonContentData:a})}function kA(n,o,e){if(n){if(o.deltaType===fe.Add){var r=n.find(function(a){return a.start===e&&a.length===0});if(r)return r;e=Math.max(e-1,0)}var t=n.find(function(a){return a.length===0?a.start===e:a.start<=e&&e<a.start+a.length});return t}}function wA(n,o){var e=Array.from(n.matchAll(Fo));if(Fo.lastIndex=0,e.length===0)return Oe.Chars;if(e.length===1){if(e[0].index===0)return o&&ia.test(o)?Oe.Sentence:o&&!Fo.test(o)?Oe.Word:Oe.Chars;if(e[0].index+1===n.length)return ia.test(n[e[0].index-1])?Oe.Sentence:Fo.test(n[e[0].index-1])?Oe.Chars:Oe.Word;if(n[e[0].index-1]){var r=n[e[0].index-1];if(ia.test(r))return Oe.Sentence;if(Fo.test(r))return Oe.Chars}return Oe.Word}var t=Array.from(n.matchAll(ia));if(ia.lastIndex=0,t.length===0)return Oe.PartialSentence;if(t.length>1)return Oe.Paragraph;if(t[0].index+1<=n.length)return Fo.test(n[t[0].index+1])?Oe.Sentence:Oe.Paragraph}var Vk=function(){function n(){(0,Hk.default)(this,n),this.deltaBuilderHandlers=new Map,this.registerDeltaBuilderHandler(Je.getTypeName(),qk),this.registerDeltaBuilderHandler(nt.getTypeName(),Gk)}return(0,zk.default)(n,[{key:"registerDeltaBuilderHandler",value:function(e,r){this.deltaBuilderHandlers.set(e,r)}},{key:"executeDeltaBuilderHandler",value:function(e,r,t){var a=this.deltaBuilderHandlers.get(e);return a?a(r,t):[]}}]),n}();var Fc=function(o,e){return e?e.join("\\")+"-"+o:o},Jk=function(){function n(){var o=this;(0,Qk.default)(this,n),this.createTextTileDeltasFromItem=function(e,r){var t,a=new D({operationName:"CreateTextTileDeltaFromItem",success:!0}).start();try{if(!e){a.success=!1,a.resultDescription="Unable to create text tile delta, parent item is undefined",v.info(524883085,y.CoreDefault,a.stop());return}if(!e.body){a.success=!1,a.resultDescription="Unable to create text tile delta, parent item has undefined body",v.info(524883086,y.CoreDefault,a.stop());return}var s=e.body;if(!Je.typeGuard(s)){a.success=!1,a.resultDescription="Unable to create text tile delta, parent item body is not proper type: expected "+Je.getTypeName()+", received "+m.getTypeNameFor(s);return}var u=Fc(e.id,r),l=(t=o.lastSeenTileByTileId.get(u))!==null&&t!==void 0?t:new Je({content:""}),f=o.createDeltas(l,s);return!f||f.length===0?(a.dimension0="0",a.resultDescription="No delta differences found"):(a.dimension0=f.length.toString(),o.lastSeenTileByTileId.set(u,s)),v.info(524883087,y.CoreDefault,a.stop()),f}catch(c){a.success=!1,a.resultDescription="Error creating text tile delta: "+c,v.info(524883088,y.CoreDefault,a.stop());return}},this.lastSeenTileByTileId=new Map,this.deltaBuilder=new Vk}return(0,jk.default)(n,[{key:"addItemToLocalMap",value:function(e,r){var t=Fc(e.id,r),a=e.body;Je.typeGuard(a)&&!this.lastSeenTileByTileId.has(t)&&this.lastSeenTileByTileId.set(t,a)}},{key:"deleteItemFromLocalMap",value:function(e,r){var t=Fc(e.id,r);this.lastSeenTileByTileId.has(t)&&this.lastSeenTileByTileId.delete(t)}},{key:"createDeltas",value:function(e,r){return this.deltaBuilder.executeDeltaBuilderHandler(m.getTypeNameFor(r),e,r)}}]),n}();var SA=10,CA=function(o){if(o===ft.Substrate)return mo.Substrate},$t;(function(n){n[n.LocalWorkflow=0]="LocalWorkflow",n[n.ServerWorkflow=1]="ServerWorkflow",n[n.Submitted=2]="Submitted"})($t||($t={}));var wr;(function(n){n[n.Internal=0]="Internal",n[n.External=1]="External"})(wr||(wr={}));var An=function(o,e){e?(o.resultDescription=e,o.success=!1,v.error(509203144,y.CoreDefault,o.stop())):v.info(509203143,y.CoreDefault,o.stop())},Kk=function(o){return!o.items.some(function(e){return e.source&&e.source.indexOf("ThirdParty")===0})},Ms=function(){function n(o){(0,$k.default)(this,n);var e;this.annotationActivationTrackers=new Map,this.annotationCallbacks=new Map,this.annotationResultStates=new Map,this.tokensByAnnotationType=new Map,this.registeredContextTypes=new Set,this.availableContexts=new Map,this.nextSyncSequenceId=1,this.allowSeed=!0,this.allowGroupSeed=!0,this.seedGroupSize=0,this.hasSessionConnected=!1,this.isSessionClosed=!1,this.serverAuthenticationState=at.NotAuthenticated,this.sessionCloseCallbacks=new Map,this.connectCallbacks=new Map,this.reconnectCallbacks=new Map,this.disconnectCallbacks=new Map,this.sessionStateCallbackToken=0,this.workflowGraph=new Cs,this.workflowDefinitionManager=new cs,this.contextIdManager=new Nt(Do.JsClient,this.workflowGraph),this.workflowItemStorage=new Ss(this.workflowDefinitionManager),this.pendingConnectCallbacks=[],this.onAnnotationsSubmittedEnabled=!1,this.hostCallbacks=o.hostCallbacks,this.sessionManager=o.sessionManager,this.operationBatchConfig=o.batchOptions?this.getOperationBatchConfig(o.batchOptions):void 0,this.extensionConfigs=o.extensionConfigs,this.clientMetadata=o.clientMetadata,this.userContext=o.userContext,this.localWorkflowManager=o.localWorkflowManager,this.annotationResultsProcessor=o.annotationResultsProcessor,o.workflowRuntimeFactory&&(this.workflowRuntime=o.workflowRuntimeFactory(this.sessionManager)),this.localRegisteredWorkflows=o.localRegisteredWorkflows||[],this.enableRemoteExecutionNotification=o.enableRemoteExecutionNotification||!1,this.networkMode=o.networkMode,this.egress=o.egress,this.serverAuthenticationStateChangeCallback=[],this.onAnnotationsSubmittedEnabled=o.onAnnotationsSubmittedEnabled||!1,this.sessionManager.on("sessionClose",this.onSessionClose.bind(this)),this.sessionManager.on("reconnect",this.onReconnect.bind(this)),this.sessionManager.on("connect",this.onConnect.bind(this)),this.sessionManager.on("disconnect",this.onDisconnect.bind(this)),this.sessionManager.on("resetNextSyncSequenceId",this.resetNextSyncSequenceId.bind(this)),this.sessionManager.on("serverAuthenticationStateChange",this.onServerAuthenticationStateChange.bind(this)),this.sessionManager.onMessage(wt.getTypeName(),this.workflowRuntime?this.onAnnotationResultsFromLocal.bind(this):this.onAnnotationResultsFromServer.bind(this)),this.sessionManager.onMessage(qr.getTypeName(),this.onAnnotationResultStateMessage.bind(this)),this.sessionManager.onMessage(Qr.getTypeName(),this.onWorkflowExecutionCompleteMessage.bind(this)),o.isDeltaGeneratorEnabled&&(this.enableSyncDeltaSending=!o.disableSyncDeltaSending,this.syncDeltaTimeout=(e=o.syncDeltaTimeout)!==null&&e!==void 0?e:700,this.enableDeltaGenerator()),this.setServerAuthenticationStateChangeCallback(this.updateGraphOnAuthStateChange.bind(this))}return(0,Xk.default)(n,[{key:"tryGetDocSessionId",value:function(){if(!(!this.clientMetadata||!this.clientMetadata.docSessionId))return this.clientMetadata.docSessionId}},{key:"getSessionStateCallbackToken",value:function(e){var r;return e+"-callback-"+((r=this.tryGetDocSessionId())!==null&&r!==void 0?r:"unknown")+"-"+this.sessionStateCallbackToken++}},{key:"updateGraphOnAuthStateChange",value:function(e){this.tryActivateWorkflows()}},{key:"tryActivateWorkflows",value:function(){var e=this;if(this.enableRemoteExecutionNotification){var r=new D({operationName:"GraphServerWorkflowActivation",success:!0}).setClientMetadata(this.clientMetadata).start(),t=[];this.workflowGraph.getWorkflowNodes().filter(function(a){return a.location===tr.External}).forEach(function(a){e.localWorkflowManager.canActivateWorkflow(a,e)?a.isActivated=!0:(e.localWorkflowManager.deactivateServerWorkflow(a,e),t.push(a.workflow.id))}),r.resultDescription="deactivated workflows: ["+t.join()+"]",v.info(508879493,y.CoreDefault,r.stop())}}},{key:"initialize",value:function(){var e=this;return this.localWorkflowManager&&this.localWorkflowManager.addSession(this),this.registerLocalWorkflowsWithoutGraphInit(this.localRegisteredWorkflows),this.sessionManager.init(this.extensionConfigs,this.hostCallbacks.onInitSession?this.hostCallbacks.onInitSession:void 0,this.egress).then(function(){return e.localWorkflowManager&&e.localWorkflowManager.setTokenCallback(e.getAuthToken.bind(e)),e})}},{key:"isLocalWorkflowRegistered",value:function(e){var r=this.getLocalRegisteredWorkflows();return r.some(function(t){return e===t.id})}},{key:"isConnected",get:function(){return!!this.connectParams}},{key:"hasConnected",get:function(){return this.hasSessionConnected}},{key:"isClosed",get:function(){return this.isSessionClosed}},{key:"getServerAuthenticationState",value:function(){return this.serverAuthenticationState}},{key:"getContextIdManager",value:function(){return this.contextIdManager}},{key:"getWorkflowItemStorage",value:function(){return this.workflowItemStorage}},{key:"getWorkflowDefinition",value:function(e,r){return this.workflowDefinitionManager.getWorkflowDefinition(e,r)}},{key:"registerLocalWorkflows",value:function(e){this.registerLocalWorkflowsWithoutGraphInit(e),this.trySendWorkflowGraphInitMessage()}},{key:"registerLocalWorkflowsWithoutGraphInit",value:function(e){if(e.length){if(this.workflowRuntime)for(var r of e)this.workflowRuntime.registerWorkflow(r),this.sendMessageToSession(new jr({workflowDefinition:r}));if(this.localWorkflowManager)for(var t of e)this.localWorkflowManager.registerLocalWorkflow(t,this)}}},{key:"registerLocalWorkflow",value:function(e){this.registerLocalWorkflows([e]);var r=new D({operationName:"SessionRegisterLocalWorkflow",resourceId:e.id,success:!0}).setClientMetadata(this.clientMetadata).start();An(r)}},{key:"activateAnnotation",value:function(e,r){var t,a=new Nl(this.sendMessageToSession.bind(this),e,r);if(r&&r.callback){var s=this.annotationCallbacks.get(e);s||(s=new Map,this.annotationCallbacks.set(e,s)),s.set(a.token,r.callback)}var u=(t=this.tokensByAnnotationType.get(e))!==null&&t!==void 0?t:[];return u.indexOf(a.token)===-1&&u.push(a.token),this.tokensByAnnotationType.set(e,u),this.annotationActivationTrackers.set(a.token,a),this.activateAnnotationForTracker(a,{ignoreExistingAnnotations:!1,sendOnlyIfConnected:!1})}},{key:"activateAnnotationForTracker",value:function(e,r){var t=new D({operationName:"ActivateAnnotation",resourceId:e.annotationType,success:!0}).setClientMetadata(this.clientMetadata).start();return e.activate(r.ignoreExistingAnnotations,r.sendOnlyIfConnected).then(function(a){return t.resultSignature="Ok",t.resultDescription="Activated annotation "+e.annotationType+" with token "+e.token+"; sendOnlyIfConnected: "+r.sendOnlyIfConnected,An(t),a}).catch(function(a){throw An(t,"error on activate annotation type "+e.annotationType+": "+a+"; sendOnlyIfConnected: "+r.sendOnlyIfConnected),a})}},{key:"updateAnnotationConfig",value:function(e,r){var t=new Hr({token:e,config:r});this.sendMessageToSession(t);var a=this.annotationActivationTrackers.get(e);a&&a.options&&(a.options.config=r)}},{key:"releaseAnnotation",value:function(e){var r=this.annotationActivationTrackers.get(e);if(r){this.annotationActivationTrackers.delete(e);var t=this.annotationCallbacks.get(r.annotationType);return t&&(t.delete(e),t.size==0&&this.annotationCallbacks.delete(r.annotationType)),r.release()}return Promise.resolve(!1)}},{key:"setAnnotationState",value:function(e,r,t){var a={state:t};this.submitOperation(new ot({parentPath:e,items:[{id:r}],M_:a}))}},{key:"setAnnotationMetadata",value:function(e,r,t){this.submitOperation(new ot({parentPath:e,items:[{id:r}],M_:t}))}},{key:"submitOperation",value:function(e,r){this.submitOperations([e],r)}},{key:"submitOperations",value:function(e,r){if(this.contextIdManager.applyContextIdOnOperations(e),this.updateWorkflowExecutionStates(e),!this.onAnnotationsSubmittedEnabled){var t=this.partitionAnnotationOperations(e),a=(0,kr.default)(t,2),s=a[0],u=a[1];this.executeCallbacksOnAnnotationSubmitted(s)}var l=e.filter(this.filterOperationsForSession.bind(this)).filter(Kk);if(this.workflowRuntime){if(this.onAnnotationsSubmittedEnabled){var f=this.partitionAnnotationOperations(l),c=(0,kr.default)(f,2),d=c[0],h=c[1];this.onAnnotationsSubmitted(d,r),this.submitOperationsToSession(h,r)}else this.submitOperationsToSession(l,r);return}var p=[];if(this.deltaGenerator){var k=new D({operationName:"ExecuteDeltaGenerator",success:!0}).setClientMetadata(this.clientMetadata).start();for(var S of l)if(Ne.typeGuard(S))p.push.apply(p,(0,lo.default)(this.createDeltasFromUpdateOperation(S)));else{var C=S;for(var T of C.items)we.typeGuard(S)?this.deltaGenerator.addItemToLocalMap(T,C.parentPath):Fe.typeGuard(S)&&this.deltaGenerator.deleteItemFromLocalMap(T,C.parentPath);p.push(S)}An(k)}if(this.onAnnotationsSubmittedEnabled){var x=this.partitionAnnotationOperations(p.length?p:l),A=(0,kr.default)(x,2),b=A[0],E=A[1];this.onAnnotationsSubmitted(b,r),this.submitOperationsToSession(E,r)}else this.submitOperationsToSession(p.length?p:l,r);this.localWorkflowManager&&this.localWorkflowManager.runLocalWorkflows(e,this,!0)}},{key:"submitSeedOperations",value:function(e,r){if(!this.allowSeed)throw new Error("Cannot submit seed operations more than once per session");if(this.networkMode===Pe.LocalWorkflowsOnly&&this.localWorkflowManager){this.localWorkflowManager.runLocalWorkflows(e,this);return}this.allowSeed=!1,this.allowGroupSeed=!1;var t=this.partitionAnnotationOperations(e),a=(0,kr.default)(t,2),s=a[0],u=a[1];this.onAnnotationsSubmittedEnabled?this.onAnnotationsSubmitted(s,r):this.executeCallbacksOnAnnotationSubmitted(s),this.operationBatchConfig?this.sendSeedMessagesViaBatchManager(this.onAnnotationsSubmittedEnabled?u:e,!0,r):this.sendMessageToSession(new Ue({cv:r,seq:0,ops:this.onAnnotationsSubmittedEnabled?u:e}))}},{key:"submitSeedGroupOperations",value:function(e,r,t){if(!this.allowGroupSeed)throw new Error("Seed operations are not allowed for this session");if(this.networkMode===Pe.LocalWorkflowsOnly&&this.localWorkflowManager){this.localWorkflowManager.runLocalWorkflows(e,this);return}r&&(this.allowGroupSeed=!1),this.allowSeed=!1;var a=this.partitionAnnotationOperations(e),s=(0,kr.default)(a,2),u=s[0],l=s[1];this.executeCallbacksOnAnnotationSubmitted(u),this.onAnnotationsSubmittedEnabled?this.onAnnotationsSubmitted(u,t):this.executeCallbacksOnAnnotationSubmitted(u),this.operationBatchConfig?this.sendSeedMessagesViaBatchManager(this.onAnnotationsSubmittedEnabled?l:e,!!r,t):(this.seedGroupSize++,this.sendMessageToSession(new Ue({cv:t,seq:0,ops:this.onAnnotationsSubmittedEnabled?l:e,groupId:"Seed",groupSize:r?this.seedGroupSize:void 0,groupComplete:r||void 0})))}},{key:"submitCustomMessage",value:function(e){var r=this;return new Promise(function(t,a){r.sendMessageToSession(e,function(s,u){s?a(new Error(s.error)):t(u)})})}},{key:"submitLargeBinaryDataMessage",value:function(e){var r=this;return new Promise(function(t,a){r.sendMessageToSessionPostEndpoint(e,function(s,u){s?a(new Error(s.error)):t(u)})})}},{key:"requestBinaryDataForBlob",value:function(e){var r=this;return e.data?Promise.resolve(e.data):!e.dataPointer||e.dataPointer.refType===Zo.None?Promise.reject(new Error("Blob does not have a data pointer")):new Promise(function(t,a){r.requestBinaryDataFromSessionBlobEndpoint(e.dataPointer,function(s,u){s?a(s):t(u)})})}},{key:"requestCacheDump",value:function(e){if(e)throw new Error("NYI");return this.submitCustomMessage(new _i)}},{key:"forceReconnect",value:function(e){return this.extensionConfigs=e,this.sessionManager.forceReconnect(e)}},{key:"close",value:function(){this.isSessionClosed=!0,this.sessionManager.closeSession(),this.workflowRuntime&&this.workflowRuntime.close(),this.localWorkflowManager&&this.localWorkflowManager.closeSession(this),this.graphInitMessageTimer&&(clearTimeout(this.graphInitMessageTimer),this.graphInitMessageTimer=void 0)}},{key:"getClientMetadata",value:function(){return this.clientMetadata}},{key:"getUserContext",value:function(){return this.userContext}},{key:"setSessionCloseCallback",value:function(e){var r=this.getSessionStateCallbackToken("close");return e&&this.sessionCloseCallbacks.set(r,e),r}},{key:"setConnectCallback",value:function(e){var r=this.getSessionStateCallbackToken("connect");return e&&this.connectCallbacks.set(r,e),r}},{key:"setDisconnectCallback",value:function(e){var r=this.getSessionStateCallbackToken("disconnect");return e&&this.disconnectCallbacks.set(r,e),r}},{key:"setReconnectCallback",value:function(e){var r=this.getSessionStateCallbackToken("reconnect");return e&&this.reconnectCallbacks.set(r,e),r}},{key:"removeSessionStateCallback",value:function(e){function r(t){return t.has(e)?(t.delete(e),!0):!1}return r(this.sessionCloseCallbacks)||r(this.reconnectCallbacks)||r(this.disconnectCallbacks)||r(this.connectCallbacks)}},{key:"setServerAuthenticationStateChangeCallback",value:function(e){this.serverAuthenticationStateChangeCallback.push(e),e(this.serverAuthenticationState)}},{key:"onAnnotationResults",value:function(e,r,t){var a=this;v.info(508916486,y.CoreDefault,new D({operationName:"OnAnnotationResultsEgress",dimension0:e==null?void 0:e.annotationType,success:!0})),t(void 0,new Be),r===$t.LocalWorkflow&&this.contextIdManager.applyContextIdOnOperations(e.ops),this.updateWorkflowExecutionStates(e.ops),this.egress&&this.egress(e,function(){}),this.annotationResultsProcessor.process(e,function(s,u){a.applyOperationForContext(s,u,r)},function(s){a.triggerRegisteredAnnotationCallbacks(s,e.annotationType)},function(s){if(r!==$t.ServerWorkflow){var u=s.ops.filter(a.filterOperationsForSession.bind(a)).filter(Kk);a.submitOperationsToSession(u,s.cv)}a.localWorkflowManager&&a.localWorkflowManager.runLocalWorkflows(s.ops,a)})}},{key:"onAnnotationResultStateMessage",value:function(e,r){var t;r(void 0,new Be);for(var a of e.updates){var s=a.annotationType,u=a.state;if(this.tokensByAnnotationType.has(s)){var l=void 0;this.annotationResultStates.has(s)?l=this.annotationResultStates.get(s):u===rn.Idle?l=rn.Pending:l=rn.Idle;for(var f of this.tokensByAnnotationType.get(s)){var c=this.annotationActivationTrackers.get(f);!((t=c.options)===null||t===void 0)&&t.stateUpdateCallback&&c.options.stateUpdateCallback(l,u)}}}}},{key:"submitOperationsToSession",value:function(e,r){var t=this,a=e.filter(function(l){return Ze.typeGuard(l)}),s=e.filter(function(l){return!Ze.typeGuard(l)});if(a.length>0&&this.sendMessageToSession(new Ue({cv:r,ops:a})),s.length>0)if(this.operationBatchConfig){if(!this.batchedOperationsManager){var u=function(f,c,d){t.sendMessageToSession(new Ue({cv:c.cv,seq:t.nextSyncSequenceId++,ops:f}),function(h){d(h?new Error(h.error):void 0)})};this.batchedOperationsManager=new Co(u)}this.batchedOperationsManager.addBatchItem(s,this.operationBatchConfig,{name:"SubmitOperations"},r)}else this.sendMessageToSession(new Ue({cv:r,seq:this.nextSyncSequenceId++,ops:s}))}},{key:"sendMessageToSession",value:function(e,r){this.sessionManager.sendMessage(e,r),Xe.typeGuard(e)&&this.close()}},{key:"sendMessageToSessionPostEndpoint",value:function(e,r){var t=this;if(this.connectParams)this.sendLargeBinaryDataMessage(this.connectParams,e,r);else{var a=function(s){return t.sendLargeBinaryDataMessage(s,e,r)}.bind(this);this.pendingConnectCallbacks.push(a)}}},{key:"requestBinaryDataFromSessionBlobEndpoint",value:function(e,r){var t=this;if(this.connectParams)this.requestBinaryData(this.connectParams,e,r);else{var a=function(s){return t.requestBinaryData(s,e,r)}.bind(this);this.pendingConnectCallbacks.push(a)}}},{key:"registerContextTypes",value:function(e){for(var r of e)this.activateAnnotation(r),this.registeredContextTypes.add(r)}},{key:"applyOperationForContext",value:function(e,r,t){var a=this,s=m.getTypeNameFor(e);if(!(s!=we.getTypeName()&&s!=ar.getTypeName()&&s!=Ne.getTypeName()&&s!=Fe.getTypeName())){s==ar.getTypeName()&&(s=we.getTypeName());var u=Ct(this.resolvePlaceholdersInOperationParentPath(e.parentPath),r),l=G(u.parentPath);if(s==we.getTypeName()||s==Ne.getTypeName()){if(!u.body)return;var f=m.getTypeNameFor(u.body);if(!this.registeredContextTypes.has(f))return;var c=this.availableContexts.get(f);c||(c=new Map,this.availableContexts.set(f,c));var d=c.get(t);if(d||(d=[],c.set(t,d)),!u.id){if(this.workflowRuntime)throw new Error("Expected item to have id already");this.localWorkflowManager&&(u.id=this.localWorkflowManager.getNextClientAnnotationId())}if(s==we.getTypeName())d.filter(function(p){return G(p.parentPath)==l&&p.id==u.id}).length==0?d.push(u):v.info(540848911,y.CoreDefault,"AddOperation for ("+t+", "+u.id+", "+u.source+") can't be applied as the context item with matching path and ID already exists. Use UpdateOperation instead.");else for(var h=0;h<d.length;h++)if(d[h].id==u.id&&G(d[h].parentPath)==l)if(d[h].source==u.source){d[h]=u;break}else v.warn(540848912,y.CoreDefault,"UpdateOperation for ("+t+", "+u.id+", "+u.source+") can't be applied as the context item with provided path and ID has different source: "+d[h].source);else v.warn(540848913,y.CoreDefault,"UpdateOperation for ("+t+", "+u.id+", "+u.source+") can't be applied as the context item with matching path and ID was not found. AddOperation should be used instead")}else if(s==Fe.getTypeName()){if(!u.id)return;this.availableContexts.forEach(function(p,k){var S=p.get(t);S&&(S=S.filter(function(C){return!(G(C.parentPath)==l&&C.id==u.id)}),S.length==0?p.delete(t):p.set(t,S),p.size==0?a.availableContexts.delete(k):a.availableContexts.set(k,p))})}}}},{key:"updateWorkflowExecutionStates",value:function(e){if(this.localWorkflowManager){var r=this.enableRemoteExecutionNotification?this.workflowGraph.getWorkflowNodes().map(function(u){return u.workflow}):this.localWorkflowManager.getAllRegisteredWorkflowsFromSession(this);for(var t of e)if(ta.has(m.getTypeNameFor(t)))for(var a of t.items)for(var s of r||[])this.localWorkflowManager.preProcessItemToWorkflow(s,a,this)}}},{key:"resolveRequestedContexts",value:function(e){var r=[];for(var t of Xn(e.requestedContextTypesRules)){var a=(0,kr.default)(t,3),s=a[0],u=a[1],l=a[2];if(!this.availableContexts.has(s)){if(u==cr.Required)return[!1,[]];continue}var f=Array.from(this.availableContexts.get(s).values()).reduce(function(c,d){return c.concat(d)},[]);if(f.length==0)throw new Error("Assert: availableContexts have the entry for "+s+" which does not contain any context annotation.");r.push.apply(r,(0,lo.default)(f))}return[!0,this.removeDuplicatedContextItems(r)]}},{key:"removeDuplicatedContextItems",value:function(e){return e.filter(function(r,t,a){return a.findIndex(function(s){return ie.deepEquals(s,r)})===t})}},{key:"getContextAnnotations",value:function(e,r,t,a){var s,u,l=t?G(t):void 0;return(u=(s=this.availableContexts.get(e))===null||s===void 0?void 0:s.get(r))===null||u===void 0?void 0:u.filter(function(f){return(!l||G(f.parentPath)==l)&&(!a||f.source==a)})}},{key:"onWorkflowDefinitionOverrideMessage",value:function(e){var r=new D({operationName:"WorkflowDefinitionOverride",success:!0}).setClientMetadata(this.clientMetadata).start(),t=function(f){throw An(r,f),Error("WorkflowDefinitionOverride: "+f)};if(!this.localWorkflowManager){t("Not supported by this local SessionProxy instance.");return}var a=this.localWorkflowManager.getWorkflowDefinitionsByName(this),s=a.get(e.sourceWorkflowId);if(!s){t("Workflow registration for source workflow '"+e.targetWorkflowId+"' was not found.");return}r.resourceId=s.id;var u=a.get(e.targetWorkflowId);if(u){if(!u.allowDefinitionOverride){t("Workflow '"+u.id+"' does not allow workflow definition override.");return}if(!s.definitionOverrideTargetWorkflows||s.definitionOverrideTargetWorkflows.indexOf(u.id)===-1){t("Workflow '"+s.id+"' does not allow workflow definition for workflow '"+u.id+"'.");return}this.workflowDefinitionManager.mergeWorkflowDefinition(u,e.definition,e.contextId),r.resultDescription="Updated config for workflow: "+e.targetWorkflowId+", context id: "+e.contextId,An(r)}}},{key:"applyContextIdOnOperations",value:function(e){this.contextIdManager.applyContextIdOnOperations(e)}},{key:"attachToWorkflowGraph",value:function(e){this.addToWorkflowGraph(e),this.attachExecutionTrackerToEachWorkflow()}},{key:"triggerRegisteredAnnotationCallbacks",value:function(e,r){if(this.callAnnotationCallbacks(e,r),this.hostCallbacks.onAnnotationResult)try{this.hostCallbacks.onAnnotationResult(e)}catch(t){v.error(540301151,y.CoreDefault,"onAnnotationResult error: "+t)}}},{key:"attachExecutionTrackerToEachWorkflow",value:function(){this.localWorkflowManager&&this.localWorkflowManager.attachExecutionTrackerToEachWorkflow(this.workflowGraph,this,this.onWorkflowExecutionComplete.bind(this))}},{key:"onWorkflowExecutionCompleteMessage",value:function(e,r){r(void 0,new Be),this.localWorkflowManager&&this.localWorkflowManager.onExternalWorkflowExecuted(e.contextId,e.workflowId,this)}},{key:"onWorkflowExecutionComplete",value:function(e,r){}},{key:"enableDeltaGenerator",value:function(){var e,r;this.deltaGenerator=(e=this.deltaGenerator)!==null&&e!==void 0?e:new Jk,this.syncDeltaTimers=(r=this.syncDeltaTimers)!==null&&r!==void 0?r:new Map}},{key:"createDeltasFromUpdateOperation",value:function(e){var r,t,a=[];v.info(523776396,y.CoreDefault,"Calling delta create for UpdateOperation under parent path ["+e.parentPath+"] ("+((r=e.items)===null||r===void 0?void 0:r.length)+" item(s), first item id: "+(((t=e.items)===null||t===void 0?void 0:t.length)>0?e.items[0].id:"(no items)")+")");var s=(0,lo.default)(e.parentPath);for(var u of e.items){var l=[],f=this.deltaGenerator.createTextTileDeltasFromItem(u,e.parentPath);if(!(f!=null&&f.length)){v.info(523329632,y.CoreDefault,"Failed to create delta on item "+u.id);continue}for(var c of f){var d=dn();s=[].concat((0,lo.default)(e.parentPath),[u.id]);var h={id:d,revId:u.revId,body:c,contextId:u.contextId,source:u.source};l.push(h)}l.length>0&&(a.push(new Ot({parentPath:s,items:l})),this.enableSyncDeltaSending&&this.setupSyncDeltaAfterDelay(u,s,l))}return a}},{key:"setupSyncDeltaAfterDelay",value:function(e,r,t){var a=this,s,u,l,f=this.syncDeltaTimers.get(e.id);f&&(clearTimeout(f),this.syncDeltaTimers.delete(e.id));var c=t.find(function(T){var x;return((x=T.body)===null||x===void 0?void 0:x.unit)===Oe.Chars});if(c){var d=c.body,h={content:"",deltaType:fe.Update,length:0,position:((s=d==null?void 0:d.position)!==null&&s!==void 0?s:0)+((l=(u=d==null?void 0:d.content)===null||u===void 0?void 0:u.length)!==null&&l!==void 0?l:0),unit:Oe.Sentence},p=nt.typeGuard(e.body)?new un(h):new Zn(h),k={id:dn(),revId:e.revId,body:p,contextId:e.contextId,source:e.source},S=new Ot({parentPath:r,items:[k]}),C=setTimeout(function(T,x){a.submitOperation(T),a.syncDeltaTimers.delete(x)},this.syncDeltaTimeout,S,e.id);this.syncDeltaTimers.set(e.id,C)}}},{key:"addToWorkflowGraph",value:function(e){this.workflowGraph.addWorkflow(Yi(e))}},{key:"getAuthToken",value:function(e,r){var t={Tickets:[]};this.clientMetadata.docSessionId&&(t.DocSessionId=this.clientMetadata.docSessionId);var a=CA(e);a&&(t.TokenType=a),this.hostCallbacks.requestAuthToken(t).then(function(s){var u;if(!s){r(new Error("Missing AuthTokenResponse from requestAuthToken"));return}r(void 0,s.Token,{returnedTokenType:e,timeToLiveSec:(u=s.TokenProperties)===null||u===void 0?void 0:u.timeToLiveSec})}).catch(function(s){return r(s)})}},{key:"resetNextSyncSequenceId",value:function(){this.nextSyncSequenceId=1}},{key:"onReconnect",value:function(){var e=this;if(this.annotationActivationTrackers.forEach(function(r){e.activateAnnotationForTracker(r,{ignoreExistingAnnotations:!0,sendOnlyIfConnected:!0}).catch(function(){})}),this.reconnectCallbacks.forEach(function(r,t){r()}),!this.connectParams)throw new Error("Expected onConnect before onReconnect")}},{key:"onSessionClose",value:function(e){this.isSessionClosed=!0,this.connectParams=void 0,this.sessionCloseCallbacks.forEach(function(r,t){r(e)})}},{key:"onConnect",value:function(e,r,t,a,s,u){this.hasSessionConnected?e&&(this.allowSeed=!0,this.allowGroupSeed=!0,this.seedGroupSize=0,this.seedBatchedOperationsManager&&(this.seedBatchedOperationsManager.removeAllBatchedItems(),this.seedBatchedOperationsManager=void 0),this.batchedOperationsManager&&(this.batchedOperationsManager.removeAllBatchedItems(),this.batchedOperationsManager=void 0)):this.enableRemoteExecutionNotification&&this.addDownstreamWorkflowsIntoClientGraph(u),this.connectParams={isSeedingRequired:e,sessionUrl:r,origin:t,authToken:a},this.hasSessionConnected=!0,this.tryActivateWorkflows();for(var l of this.pendingConnectCallbacks)l(this.connectParams);this.connectCallbacks.forEach(function(f,c){f(e,r,t,a)}),this.serverInputTypes=s}},{key:"onDisconnect",value:function(e){this.connectParams=void 0,this.disconnectCallbacks.forEach(function(r,t){r(e)})}},{key:"onServerAuthenticationStateChange",value:function(e){if(e!=this.serverAuthenticationState){if(this.serverAuthenticationState==at.Authenticated&&e==at.Pending)return;this.serverAuthenticationState=e;for(var r of this.serverAuthenticationStateChangeCallback)r(this.serverAuthenticationState)}}},{key:"callAnnotationCallbacks",value:function(e,r){if(this.annotationCallbacks.size!==0){var t=this.annotationCallbacks.get(r);t&&t.forEach(function(a){a(e)})}}},{key:"getOperationBatchConfig",value:function(e){var r=function(){return"operations"},t=function(u){return{input:u.filter(function(l){return l.length}).reduce(function(l,f){return l.concat(f)},[]),demultiplex:function(){return[[]]}}},a=function(u){if(!(u.length<=1))return{inputs:u.reduce(function(l,f){return l.push([f]),l},[]),join:function(){return[]}}};return{delayMs:e.delayMs,delayMsMax:e.delayMsMax,maxInputSize:e.maxInputSize,estimateSize:Wa,groupingKeyExtractor:r,multiplex:t,split:a}}},{key:"sendSeedMessagesViaBatchManager",value:function(e,r,t){var a=this;if(!this.seedBatchedOperationsManager){var s=function(l,f,c){a.seedGroupSize++,a.sendMessageToSession(new Ue({cv:f.cv,seq:0,ops:l,groupId:"Seed",groupSize:f.groupComplete?a.seedGroupSize:void 0,groupComplete:f.groupComplete?f.groupComplete:void 0}),function(d){c(d?new Error(d.error):void 0)})};this.seedBatchedOperationsManager=new Co(s)}this.seedBatchedOperationsManager.addBatchItem(e,this.operationBatchConfig,{name:"SubmitSeedOperations"},t,r)}},{key:"onAnnotationResultsFromServer",value:function(e,r){this.onAnnotationResults(e,$t.ServerWorkflow,r)}},{key:"onAnnotationResultsFromLocal",value:function(e,r){this.onAnnotationResults(e,$t.LocalWorkflow,r)}},{key:"getLocalRegisteredWorkflows",value:function(){return this.workflowRuntime?this.workflowRuntime.getRegisteredWorkflows():this.localWorkflowManager?this.localWorkflowManager.getAllRegisteredWorkflowsFromSession(this).map(function(e){return Yi(e)}):[]}},{key:"sendWorkflowGraphInitMessage",value:function(){var e=this,r=this.getLocalRegisteredWorkflows(),t=new D({operationName:"WorkflowGraphInit",success:!0}).setClientMetadata(this.clientMetadata).start(),a=new Vr({upstreamRuntimeWorkflows:r});this.sendMessageToSession(a,function(s,u){if(s){An(t,s.error);return}t.resultDescription="local workflows: "+r.map(function(l){return l.id})+", remote workflows: "+u.downstreamRuntimeWorkflows.map(function(l){return l.id}),An(t),e.onWorkflowGraphInitResponse(u)})}},{key:"trySendWorkflowGraphInitMessage",value:function(){var e=this;!this.graphInitMessageTimer&&this.enableRemoteExecutionNotification&&(this.graphInitMessageTimer=setTimeout(function(){e.graphInitMessageTimer=void 0,e.sendWorkflowGraphInitMessage()},SA))}},{key:"onWorkflowGraphInitResponse",value:function(e){this.addDownstreamWorkflowsIntoClientGraph(e.downstreamRuntimeWorkflows),this.tryActivateWorkflows()}},{key:"addDownstreamWorkflowsIntoClientGraph",value:function(e){this.workflowGraph.removeWorkflows(!0);for(var r of e||[])this.workflowGraph.addWorkflow(r,!0);this.workflowRuntime||this.attachExecutionTrackerToEachWorkflow()}},{key:"resolvePlaceholdersInOperationParentPath",value:function(e){var r=e;return r.length==3&&r[0]=="session"&&r[1]=="user"&&r[2].startsWith("user_")&&(v.info(540848914,y.CoreDefault,"Replacing user context placeholder for: "+G(e)+"."),r=["session","#userContext#"]),r.length==3&&r[0]=="session"&&r[1]=="user"&&r[2].startsWith("tenant_")&&(v.info(540848915,y.CoreDefault,"Replacing tenant context placeholder for: "+G(e)+"."),r=["session","#tenantContext#"]),r}},{key:"filterOperationsForSession",value:function(e){return this.workflowRuntime?!0:eh(e,this.serverInputTypes)}},{key:"makeRequestForConnectParams",value:function(e,r){var t=e.authToken,a=e.origin,s=e.sessionUrl,u=r.body,l=r.cv,f=r.method,c=r.requestUrl;return(0,Yk.fetch)(c||s,{method:f,headers:{Authorization:"Bearer "+t,"x-origin":a,"x-correlationid":l},body:u}).then(function(d){if(d.status!==200)throw new Error("Unexpected status code: "+d.status);return d})}},{key:"sendLargeBinaryDataMessage",value:function(e,r,t){var a=new D({operationName:"SendLargeBinaryDataMessage",success:!0,cv:r.cv}).setClientMetadata(this.clientMetadata).start(),s;this.makeRequestForConnectParams(e,{body:on.serialize(r),cv:a.cv,method:"POST"}).then(function(u){return u.json()}).catch(function(u){s=new X({messageId:r.messageId,error:u.message})}).then(function(u){An(a,s?s.error:void 0),t(s,u)})}},{key:"requestBinaryData",value:function(e,r,t){var a=new D({operationName:"RequestBinaryData",success:!0,cv:new We().toString()}).setClientMetadata(this.clientMetadata).start(),s=e.sessionUrl,u;this.makeRequestForConnectParams(e,{cv:a.cv,method:"GET",requestUrl:r.refType===Zo.AlCodedLocation?s+"/blob/"+r.value:r.value}).then(function(l){return l.arrayBuffer()}).then(function(l){return new Uint8Array(l)}).catch(function(l){u=l}).then(function(l){An(a,u?u.message:void 0),t(u,l)})}},{key:"executeCallbacksOnAnnotationSubmitted",value:function(e){var r=this,t=this.getAnnotationOperationsByType(e);t.forEach(function(a,s){Array.from(a).forEach(function(u){return r.triggerRegisteredAnnotationCallbacks(u,s)})})}},{key:"partitionAnnotationOperations",value:function(e){return e.reduce(function(r,t){var a=(0,kr.default)(r,2),s=a[0],u=a[1];return t.items.some(function(l){return l.body&&gt.typeGuard(l.body)})?[[].concat((0,lo.default)(s),[t]),u]:[s,[].concat((0,lo.default)(u),[t])]},[[],[]])}},{key:"onAnnotationsSubmitted",value:function(e,r){var t=this,a=this.getAnnotationOperationsByType(e);a.forEach(function(s,u){var l=Array.from(s);t.onAnnotationResults(new wt({annotationType:u,ops:l,cv:r}),$t.Submitted,function(){})})}},{key:"getAnnotationOperationsByType",value:function(e){var r=new Map;for(var t of e)for(var a of t.items)if(a.body&&gt.typeGuard(a.body)){var s=m.getTypeNameFor(a.body),u=r.get(s)||new Set;u.add(t),r.set(s,u)}return r}}]),n}();g();var Zk=w(B()),ew=w(W()),Es=(0,Zk.default)(function n(){(0,ew.default)(this,n)});g();var rw=w(W()),ow=w(B()),iw=w(qe()),aw=w(Ge()),qc=w(De());g();var tw=w(W()),nw=w(B()),aa;(function(n){n[n.Anonymous=0]="Anonymous",n[n.Host=1]="Host"})(aa||(aa={}));var Sr=function(){function n(){(0,tw.default)(this,n),this.timers=new Map}return(0,nw.default)(n,[{key:"scheduleRefresh",value:function(e,r,t,a){var s=this.timers.get(e);s||(s={numberOfAttempts:0},this.timers.set(e,s)),s.refreshTimeoutId&&(clearTimeout(s.refreshTimeoutId),s.refreshTimeoutId=void 0),s.expiredTimeoutId&&(clearTimeout(s.expiredTimeoutId),s.expiredTimeoutId=void 0);var u=r*1e3-n.tokenRefreshBufferMs,l=r*1e3-n.tokenExpirationBufferMs;u>0?s.numberOfAttempts=0:(++s.numberOfAttempts,u=n.tokenRefreshBackoffIntervalMs,l=n.tokenExpirationBufferMs),s.numberOfAttempts<=n.tokenRefreshMaximumAttempts&&(s.refreshTimeoutId=setTimeout(function(){t()},u)),a&&(s.expiredTimeoutId=setTimeout(function(){a()},l))}},{key:"clearRefreshTimeouts",value:function(){this.clearTimeouts(!1)}},{key:"clearAllTimeouts",value:function(){this.clearTimeouts(!0)}},{key:"clearTimeouts",value:function(e){var r=this;this.timers.forEach(function(t,a){t.refreshTimeoutId&&(clearTimeout(t.refreshTimeoutId),t.refreshTimeoutId=void 0),e&&t.expiredTimeoutId&&(clearTimeout(t.expiredTimeoutId),t.expiredTimeoutId=void 0),t.expiredTimeoutId||r.timers.delete(a)})}}]),n}();Sr.tokenRefreshBufferMs=24e4;Sr.tokenExpirationBufferMs=12e4;Sr.tokenRefreshBackoffIntervalMs=3e4;Sr.tokenRefreshMaximumAttempts=3;var sw=w(Jn());function xA(n){var o=TA();return function(){var r=(0,qc.default)(n),t;if(o){var a=(0,qc.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,aw.default)(this,t)}}function TA(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var Rs=function(n){(0,iw.default)(e,n);var o=xA(e);function e(r,t,a,s,u){var l;return(0,rw.default)(this,e),l=o.call(this),l.getSessionStats=r,l.clientMetadata=t,l.tokenRefreshManager=a,l.sendMessage=s,l.options=u||{},l.options.overrideSessionInitMessage=l.options.overrideSessionInitMessage||function(f){return f},l}return(0,ow.default)(e,[{key:"initSession",value:function(t){var a=this;t.onResponse=t.onResponse||function(){};var s=ie.getCurrentTimeMs(),u=this.getSessionStats().lastConnectionClose&&s-this.getSessionStats().lastConnectionClose,l=this.getSessionStats().lastSyncMessage&&s-this.getSessionStats().lastSyncMessage,f=new D({operationName:"SessionInit"}).start(),c={sessionKey:this.sessionKey,sessionId:this.clientMetadata.sessionId,timeSinceLastConnectionClose:u,timeSinceLastSyncMessage:l,isTokenRefresh:t.isTokenRefresh,enableRemoteExecutionNotification:this.options.enableRemoteExecutionNotification,error:void 0},d=this.options.overrideSessionInitMessage(new dt({protocolVersion:ch,clientMetadata:this.clientMetadata,sessionKey:this.sessionKey,origin:this.origin,authToken:this.anonymousToken,extensionConfigs:t.extensionConfigs,returnWorkflowInputTypes:!0,enableRemoteExecutionNotification:this.options.enableRemoteExecutionNotification}));this.sendMessage(d,function(h,p){if(f.success=!h,f.resultSignature=a.getSessionStats().lastConnectionClose?"Reconnect":"FirstConnect",f.resourceId=p==null?void 0:p.sliceUrl,f.setClientMetadata(a.clientMetadata),p!=null&&p.sessionKey&&c.sessionKey!==p.sessionKey&&(c.sessionKey=p.sessionKey),h&&(c.error=h.error),f.resultDescription=JSON.stringify(c),v.info(508843779,y.CoreDefault,f.stop()),t.onResponse(h,p),h){a.emit("serverAuthenticationStateChange",at.NotAuthenticated);return}if(t.isReconnectOnSameSlice&&p.forceReconnect){a.emit("serverAuthenticationStateChange",at.NotAuthenticated);return}if(!p.anonymousToken||!p.tokenExpirationSeconds){a.emit("serverAuthenticationStateChange",at.NotAuthenticated),v.error(508843778,y.CoreDefault,"AL Anonymous token was not generated for the session");return}a.anonymousToken=p.anonymousToken,a.onSuccessfulSessionInitOnServerSide(p)})}},{key:"onSuccessfulSessionInitOnServerSide",value:function(t){var a=this;this.tokenRefreshManager.scheduleRefresh(aa.Anonymous,t.tokenExpirationSeconds,this.initSession.bind(this,{isTokenRefresh:!0}),function(){a.anonymousToken=void 0}),this.initHostAuthToken();var s=!!this.sessionKey,u=this.sessionKey!==t.sessionKey;this.sessionKey=t.sessionKey,this.origin=t.origin,this.emit("connect",u,s,t.sessionUrlBase+"/"+t.sessionKey,t.origin,this.anonymousToken,t.workflowInputTypes,t.downstreamRuntimeWorkflows),s&&this.emit("reconnect")}},{key:"initHostAuthToken",value:function(){var t=this;if(this.options.getAuthToken){var a=new D({operationName:"RefreshAuthToken",success:!0}).setClientMetadata(this.clientMetadata).start();this.options.getAuthToken().then(function(s){if(!s){t.emit("serverAuthenticationStateChange",at.NotAuthenticated),a.success=!1,a.resultDescription="Host auth token provision failed",v.info(508843777,y.CoreDefault,a.stop());return}v.info(508843776,y.CoreDefault,a.stop()),t.sendTokenProvisionMessage(s)}).catch(function(s){t.emit("serverAuthenticationStateChange",at.NotAuthenticated),a.success=!1,a.resultDescription="Error happened while attempting to fetch host token: "+s,v.error(508843747,y.CoreDefault,a.stop())})}}},{key:"sendTokenProvisionMessage",value:function(t){var a=new zr({authToken:t});this.emit("serverAuthenticationStateChange",at.Pending),this.sendMessage(a,this.onTokenProvisionResponse.bind(this),!0)}},{key:"onTokenProvisionResponse",value:function(t,a){if(t||!a||!a.tokenExpirationSeconds){this.emit("serverAuthenticationStateChange",at.NotAuthenticated);return}var s=a.tokenType&&a.tokenType==ft.WacUserInfo?at.WacUserInfoAuthenticated:at.Authenticated;this.emit("serverAuthenticationStateChange",s),this.tokenRefreshManager.scheduleRefresh(aa.Host,a.tokenExpirationSeconds,this.initHostAuthToken.bind(this))}}]),e}(sw.EventEmitter);g();var Ns=w(Ie()),Cr=w(Ye()),mw=w(W()),vw=w(B());g();var Gc=w(Ie()),Uc=w(W()),Hc=w(B());var IA=function(){function n(o){(0,Uc.default)(this,n),this.item=o,this.operation=o.op,this.delta=o.delta,this.deltas=o.deltas,this.id=G(this.itemPath),this.revId=o.revId}return(0,Hc.default)(n,[{key:"itemPath",get:function(){return[].concat((0,Gc.default)(this.item.parentPath),[this.item.id])}},{key:"getModelIterator",value:function(){throw new Error("Method not implemented.")}},{key:"getBody",value:function(){return this.item.body}},{key:"getItemReference",value:function(){throw new Error("Method not implemented.")}},{key:"getParentItem",value:function(e){throw new Error("Method not implemented.")}},{key:"getParentItemBody",value:function(e){throw new Error("Method not implemented.")}},{key:"getPrevItem",value:function(e,r){throw new Error("Method not implemented.")}},{key:"getPrevItemBody",value:function(e,r){throw new Error("Method not implemented.")}},{key:"getNextItem",value:function(e,r){throw new Error("Method not implemented.")}},{key:"getNextItemBody",value:function(e,r){throw new Error("Method not implemented.")}},{key:"getChildItem",value:function(e){throw new Error("Method not implemented.")}},{key:"getChildItemBody",value:function(e){throw new Error("Method not implemented.")}},{key:"getChildItems",value:function(e){throw new Error("Method not implemented.")}},{key:"getChildItemBodies",value:function(e){throw new Error("Method not implemented.")}},{key:"getSubtreeItem",value:function(e){throw new Error("Method not implemented.")}},{key:"getSubtreeItemBody",value:function(e){throw new Error("Method not implemented.")}},{key:"getSubtreeItems",value:function(e){throw new Error("Method not implemented.")}},{key:"getSubtreeItemBodies",value:function(e){throw new Error("Method not implemented.")}},{key:"getContextItem",value:function(e){throw new Error("Method not implemented.")}},{key:"getContextItemBody",value:function(e){throw new Error("Method not implemented.")}},{key:"getContextItems",value:function(e){throw new Error("Method not implemented.")}},{key:"getContextItemBodies",value:function(e){throw new Error("Method not implemented.")}},{key:"addAnnotation",value:function(e,r){throw new Error("Method not implemented.")}},{key:"updateAnnotation",value:function(e,r){throw new Error("Method not implemented.")}},{key:"deleteAnnotation",value:function(e){throw new Error("Method not implemented.")}},{key:"loadSubtree",value:function(e){throw new Error("Method not implemented.")}},{key:"getSourceTimestamp",value:function(){return this.item.sourceTimestamp}},{key:"getContextId",value:function(){return this.item.contextId}}]),n}(),uw=function(){function n(o){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[];(0,Uc.default)(this,n),this.scopeItem=void 0,this.rootItem=void 0,this.normalizeFilter=function(r){if(!r)return function(t){return t!==void 0};if(typeof r=="function")throw new Error("Not implemented yet");if((r.id?1:0)+(r.ids?1:0)+(r.itemType?1:0)+(r.itemTypes?1:0)!=1)throw new Error("Exactly one condition expected on IItemFilter");if(r.itemType)return function(t){return t&&m.matchesTypesFor(t.body,[r.itemType])};if(r.itemTypes)return function(t){return t&&m.matchesTypesFor(t.body,r.itemTypes)};throw new Error("Not implemented yet")},this.items=[].concat((0,Gc.default)(e),[o]),this.scopeItem=new IA(o)}return(0,Hc.default)(n,[{key:"getItem",value:function(e){throw new Error("Method not implemented.")}},{key:"getItems",value:function(e){throw new Error("Method not implemented.")}},{key:"getItemBody",value:function(e){var r=this.getItemBodies(e);return r[0]}},{key:"getItemBodies",value:function(e){var r=this.normalizeFilter(e);return this.items.filter(r).map(function(t){return t.body})}},{key:"getItemByReference",value:function(e){throw new Error("Method not implemented.")}},{key:"getItemBodyByReference",value:function(e){throw new Error("Method not implemented.")}}]),n}();g();var lw=w(W()),fw=w(B());var zc=function(){function n(o){(0,lw.default)(this,n),this.model=o.model,this.clientMetadata=o.clientMetadata,this.userContext=o.userContext,this.site=o.site,this.getToken=o.getTokenCallback}return(0,fw.default)(n,[{key:"flights",get:function(){var e;return(e=this._flights)!==null&&e!==void 0||(this._flights=io(this.clientMetadata.flights)),this._flights}},{key:"getToken",value:function(e,r){return this.getToken(e,r)}}]),n}();g();var cw=w(Ye()),dw=w(W()),pw=w(B());var hw=function(){function n(o,e,r){(0,dw.default)(this,n),this.itemsContextId=new Set,this.executionState=new Map,this.graphNode=o,this.onContextIdWorkflowExecutionComplete=e,r&&(this.itemsContextId=r.itemsContextId,this.executionState=r.executionState)}return(0,pw.default)(n,[{key:"addInputItemToProcess",value:function(e){this.itemsContextId.add(e)}},{key:"removeProcessedInputItem",value:function(e){this.itemsContextId.delete(e)}},{key:"countItemsToProcess",value:function(e){var r=0;for(var t of this.itemsContextId)t.indexOf(e)===0&&(r+=1);return r}},{key:"getExecutionState",value:function(){return this.executionState}},{key:"setExecutionState",value:function(e,r){return this.graphNode.isActivated?e?(this.executionState.set(e,r),!0):(v.info(520217546,y.CoreDefault,new D({operationName:"WorkflowExecutionTracker",resourceId:this.graphNode.workflow.id,joinContextId:e,resultDescription:"Trying to set state "+r+" for a undefined contextId (setExecutionState)"})),!1):(v.info(508883415,y.CoreDefault,new D({operationName:"WorkflowExecutionTracker",resourceId:this.graphNode.workflow.id,joinContextId:e,resultDescription:"Trying to set state "+r+" for a not activated workflow"})),!1)}},{key:"beforeWorkflowExecution",value:function(e){this.setExecutionState(e,ve.Pending)}},{key:"afterWorkflowExecution",value:function(e){this.setExecutionState(e,ve.Executed)&&this.tryToCompleteWorkflowExecution(e)}},{key:"clearWorkflowExecutions",value:function(){var e=this;this.executionState.forEach(function(r,t){return e.afterWorkflowExecution(t)})}},{key:"tryToCompleteWorkflowExecution",value:function(e){var r=this.executionState.get(e);if(r===ve.Executed&&this.canCompleteExecution(e)){this.executionState.delete(e),this.onContextIdWorkflowExecutionComplete&&this.onContextIdWorkflowExecutionComplete(this.graphNode.workflow.id,e);for(var t of this.downstreamWorkflowExecutionTrackers)for(var a of t.getExecutionState()){var s=(0,cw.default)(a,2),u=s[0],l=s[1];l===ve.Executed&&Nt.isParentContextId(e,u)&&t.tryToCompleteWorkflowExecution(u)}}}},{key:"canCompleteExecution",value:function(e){for(var r of this.upstreamWorkflowExecutionTrackers)for(var t of r.getExecutionState().keys())if(Nt.isParentContextId(t,e))return!1;return!0}}]),n}();var gw=500,bn;(function(n){n.Unknown="",n.InputReceived="input",n.JoinMaxAnnnotation="maxAnnotation",n.JoinMaxTimeout="maxTimeout",n.JoinEarlyCompletion="earlyCompletion"})(bn||(bn={}));var yw=function(){function n(o,e,r){var t=this;(0,mw.default)(this,n),this.executionTrackersByWorkflowNameBySession=new Map,this.workflowsWithSessionAffinity=new Map,this.workflowDefinitionsWithSessionAffinity=[],this.workflowsWithoutSessionAffinity=[],this.pendingScopeExecutionNotificationsByWorkflow=new Map,this.sweepIntervalMs=200,this.sweepTimers=new Map,this.getResourceAsArrayBuffer=function(a,s,u){return t.modelDownloader?t.modelDownloader.getResourceAsArrayBuffer(a,s,u):Promise.reject(new Error("Resource Downloader never created"))},this.getResourceAsURL=function(a,s,u){return t.modelDownloader?t.modelDownloader.getResourceAsURL(a,s,u):Promise.reject(new Error("Resource Downloader never created"))},this.createModel=function(a){return!t.inferenceService&&t.inferenceServiceFactory&&(t.inferenceService=t.inferenceServiceFactory()),t.inferenceService?t.inferenceService.then(function(s){return s.createModel(a)}):Promise.reject(new Error("Inference Service never created"))},this.createModelInputs=function(){if(!t.inferenceService&&t.inferenceServiceFactory&&(t.inferenceService=t.inferenceServiceFactory()),t.inferenceService)return t.inferenceService.then(function(a){return a.createInputs()});throw new Error("Inference Service never created")},this.nextAnnotationId=1,this.nextSignalId=1,this.modelDownloader=o,this.inferenceServiceFactory=e,r.enableDeltas&&(this.deltaHandlers=new Map().set(m.getTypeNameFor(Zn),jv).set(m.getTypeNameFor(un),Jv),this.deltaItems=new Map),this.enableEarlyJoin=r.enableEarlyJoin||!1,this.site={getResourceAsArrayBuffer:this.getResourceAsArrayBuffer,getResourceAsURL:this.getResourceAsURL,createModel:this.createModel,createModelInputs:this.createModelInputs}}return(0,vw.default)(n,[{key:"getNextClientAnnotationId",value:function(){return"#AC"+this.nextAnnotationId++}},{key:"getNextClientSignalId",value:function(){return"#SC"+this.nextSignalId++}},{key:"registerLocalWorkflow",value:function(e,r){var t=this,a=new D({operationName:"WorkflowRegistration",resourceId:e.id}).start();if(e.inputTypes.length===0)throw new Error("Invalid workflow params");r?(this.workflowsWithSessionAffinity.get(r).push(this.createWorkflowImplementation(e,r)),r.registerContextTypes(Xn(e.requestedContextTypesRules).map(function(s){var u=(0,Cr.default)(s,2),l=u[0],f=u[1];return l})),r.attachToWorkflowGraph(e),a.setClientMetadata(r.getClientMetadata())):(e.isStateful?(this.workflowDefinitionsWithSessionAffinity.push(e),this.workflowsWithSessionAffinity.forEach(function(s,u){s.push(t.createWorkflowImplementation(e,u))})):this.workflowsWithoutSessionAffinity.push(this.createWorkflowImplementation(e)),this.workflowsWithSessionAffinity.forEach(function(s,u){u.registerContextTypes(Xn(e.requestedContextTypesRules).map(function(l){var f=(0,Cr.default)(l,2),c=f[0],d=f[1];return c})),u.attachToWorkflowGraph(e)})),a.success=!0,v.info(572838110,y.CoreDefault,a.stop())}},{key:"getAllRegisteredWorkflowsFromSession",value:function(e){var r=[];return r.push.apply(r,(0,Ns.default)(this.workflowsWithoutSessionAffinity||[])),r.push.apply(r,(0,Ns.default)(this.workflowsWithSessionAffinity.get(e)||[])),r.map(function(t){return t.workflow})}},{key:"getWorkflowDefinitionsByName",value:function(e){var r,t=new Map;return(r=this.workflowsWithSessionAffinity.get(e))===null||r===void 0||r.forEach(function(a){return t.set(a.workflow.id,a.workflow)}),t}},{key:"getWorkflowDefinitionsWithSessionAffinity",value:function(){return this.workflowDefinitionsWithSessionAffinity}},{key:"attachExecutionTrackerToEachWorkflow",value:function(e,r,t){var a=this,s=e.getWorkflowNodes(),u=this.executionTrackersByWorkflowNameBySession.get(r),l=function(k,S){if(t&&t(k,S),a.enableEarlyJoin){var C=function(){for(var x of a.executionTrackersByWorkflowNameBySession.get(r).values())if(x.graphNode.workflow.kind===q.Join){for(var A of x.getExecutionState().keys())if(Nt.isParentContextId(A,S))return!0}return!1};C()&&(a.cancelSweepTimer(r),a.ensureSweepTimer(r),a.sweepScopeExecutionNotifications())}};for(var f of s){var c=u.get(f.workflow.id),d=new hw(f,l.bind(this),c);u.set(f.workflow.id,d)}for(var h of u.values())this.setDownstreamWorkflowExecutionTrackers(h,u),this.setUpstreamWorkflowExecutionTrackers(h,u)}},{key:"canActivateWorkflow",value:function(e,r){var t;return e.location===tr.Local?!0:!(!r.hasConnected||((t=e.workflow.requiredTokenTypes)===null||t===void 0?void 0:t.length)>0&&r.getServerAuthenticationState()===at.NotAuthenticated)}},{key:"setDownstreamWorkflowExecutionTrackers",value:function(e,r){if(e.downstreamWorkflowExecutionTrackers===void 0){e.downstreamWorkflowExecutionTrackers=new Set;var t=e.graphNode;for(var a of t.downstreamWorkflows||[]){var s=r.get(a.workflow.id);this.setDownstreamWorkflowExecutionTrackers(s,r),e.downstreamWorkflowExecutionTrackers.add(s)}}}},{key:"setUpstreamWorkflowExecutionTrackers",value:function(e,r){if(e.upstreamWorkflowExecutionTrackers===void 0){e.upstreamWorkflowExecutionTrackers=new Set;var t=e.graphNode;for(var a of t.upstreamWorkflows||[]){var s=r.get(a.workflow.id);this.setUpstreamWorkflowExecutionTrackers(s,r),e.upstreamWorkflowExecutionTrackers.add(s)}}}},{key:"deactivateServerWorkflow",value:function(e,r){var t;e.location!==tr.Local&&((t=this.executionTrackersByWorkflowNameBySession.get(r))===null||t===void 0||t.get(e.workflow.id).clearWorkflowExecutions(),e.isActivated=!1)}},{key:"addSession",value:function(e){this.executionTrackersByWorkflowNameBySession.set(e,new Map);var r=[];for(var t of this.workflowDefinitionsWithSessionAffinity)r.push(this.createWorkflowImplementation(t)),e.attachToWorkflowGraph(t);this.workflowsWithSessionAffinity.set(e,r);for(var a of this.workflowsWithoutSessionAffinity)e.attachToWorkflowGraph(a.workflow)}},{key:"closeSession",value:function(e){this.cancelSweepTimer(e);for(var r of this.workflowsWithSessionAffinity.get(e)||[])r.workflowLambda.dispose();this.workflowsWithSessionAffinity.delete(e)}},{key:"setTokenCallback",value:function(e){this.getAuthTokenCallback=e}},{key:"preProcessItemToWorkflow",value:function(e,r,t){var a=this.executionTrackersByWorkflowNameBySession.get(t).get(e.id);e.kind===q.Join&&m.matchesTypesFor(r.body,e.inputTypes)&&a.addInputItemToProcess(r.contextId),(e.kind===q.SingleItem&&m.matchesTypesFor(r.body,e.inputTypes)||e.kind===q.Join&&m.matchesTypesFor(r.body,[e.collectionScopeType]))&&a.beforeWorkflowExecution(r.contextId)}},{key:"isReadyToEarlyJoin",value:function(e,r,t){var a=this,s=function(h){var p,k=Array.from((p=h.states)!==null&&p!==void 0?p:[]).map(function(C){return C[0]+": "+C[1].map(function(T){return T.join()})}).join(),S=new D({operationName:"EarlyJoinCompletion",resourceId:e.graphNode.workflow.id,joinContextId:r,success:!0}).start();S.setClientMetadata(t),S.resultDescription="isReadyToEarlyJoin ("+a.enableEarlyJoin+") -> hasProcessedAllInputItems: "+h.hasProcessedAllInputItems+", allUpstreamComplete: "+h.allUpstreamComplete+", states: "+k,v.info(512550800,y.CoreDefault,S.stop())},u=e.countItemsToProcess(r)===0;if(!u)return this.enableEarlyJoin||s({hasProcessedAllInputItems:u}),!1;var l=this.areAllUpstreamWorkflowComplete(e,r),f=l.allUpstreamComplete,c=l.states;return this.enableEarlyJoin?f:(s({hasProcessedAllInputItems:u,allUpstreamComplete:f,states:c}),!1)}},{key:"areAllUpstreamWorkflowComplete",value:function(e,r){var t=new Map;for(var a of e.upstreamWorkflowExecutionTrackers){var s=[];for(var u of a.getExecutionState()){var l=(0,Cr.default)(u,2),f=l[0],c=l[1];if(s.push([f,c]),Nt.isParentContextId(r,f))return t.set(a.graphNode.workflow.id,s),{allUpstreamComplete:!1,states:t}}s.length>0&&t.set(a.graphNode.workflow.id,s)}return{allUpstreamComplete:!0,states:t}}},{key:"runLocalWorkflows",value:function(e,r){var t=this,a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,s,u,l,f=function(T,x,A){var b,E,I=r.getWorkflowItemStorage(),_=T.workflow,M=(b=t.executionTrackersByWorkflowNameBySession.get(r))===null||b===void 0?void 0:b.get(_.id),N=_.inputTypes.concat(_.kind===q.Join?_.collectionScopeType:[]),R=new D({operationName:"RunLocalWorkflows",success:!0,resourceId:_.id,joinContextId:x.contextId}).start();if(R.setClientMetadata(r.getClientMetadata()),m.matchesTypesFor(x.body,N)){var P=Ct(A.parentPath,x);if(_.kind===q.Join)if(m.matchesTypesFor(P.body,[_.collectionScopeType])){I.setScopeItem(P,_),R.resultDescription="Scope item: "+x.id+" ("+m.getTypeNameFor(x.body)+")",v.info(524126153,y.CoreDefault,R.stop()),t.setScopeExecutionNotification(r,T,P,wr.Internal);return}else{M.removeProcessedInputItem(P.contextId);var O=I.getScopeItem(P.contextId,_);if(!O){R.resultDescription="Filtered out join invalidation: out of scope type ("+_.collectionScopeType+"), item id: "+P.id,v.info(541173894,y.CoreDefault,R.stop());return}I.addItemToWorkflowList(P,_),R.joinContextId=O.contextId,R.resultDescription="Input item: "+x.id+" ("+m.getTypeNameFor(x.body)+")"}if(m.getBaseTypesFor(P.body).indexOf(oi.getTypeName())>=0){var z=[].concat((0,Ns.default)(P.parentPath),[P.id]),J=!0;for(var ce of(E=_.outputTypes)!==null&&E!==void 0?E:[])if(!r.getContextAnnotations(ce,$t.LocalWorkflow,z,_.id)){J=!1;break}if(J)return}var ae=function re(){var V,me=r.resolveRequestedContexts(_),te=(0,Cr.default)(me,2),ke=te[0],He=te[1];if(!ke){R.resultDescription="Required contexts are not ready for "+_.id+". Retrying execution in "+gw+" milliseconds...",v.info(545837259,y.CoreDefault,R.stop()),setTimeout(re,gw);return}if(_.kind===q.SingleItem)t.queueWorkflow({workflowInfo:T,scopeItem:P,inputItems:[P],requestedContexts:He,session:r,orchestrationMode:wr.Internal,triggerReason:bn.InputReceived,onCompleteCallback:t.onWorkflowExecuted.bind(t,P,_,r)}).then(function(){v.info(509154263,y.WorkflowDefault,R.stop())}).catch(function(rr){R.resultDescription=rr,v.error(572838111,y.CoreDefault,R.stop())});else if(_.kind===q.Join){var rt=x.contextId,ut=I.getScopeItem(rt,T.workflow);if(!ut){R.resultDescription="No scope item for "+_.id+" workflow from contextId "+rt,v.info(526758475,y.CoreDefault,R.stop());return}var xe=t.isReadyToEarlyJoin(M,ut.contextId,r.getClientMetadata()),lt=xe?bn.JoinEarlyCompletion:bn.JoinMaxAnnnotation;if(I.isWorkflowReady(ut.contextId,_)||xe){var $e=(V=t.pendingScopeExecutionNotificationsByWorkflow.get(_.id))===null||V===void 0?void 0:V.get(ut.contextId);if(!$e){R.resultDescription="Workflow "+_.id+", contextId "+ut.contextId+", already queued, skipping new scope execution",v.info(528048977,y.CoreDefault,R.stop());return}var qt=I.getItemsToExecute(ut.contextId,_);t.queueWorkflow({workflowInfo:T,scopeItem:ut,inputItems:qt,requestedContexts:He,session:r,orchestrationMode:wr.Internal,triggerReason:lt,onCompleteCallback:t.onWorkflowExecuted.bind(t,ut,_,r)}).then(function(){v.info(509154262,y.WorkflowDefault,R.stop())}).catch(function(rr){R.resultDescription=rr,v.error(541173895,y.CoreDefault,R.stop())}),t.pendingScopeExecutionNotificationsByWorkflow.get(_.id).delete(ut.contextId),t.pendingScopeExecutionNotificationsByWorkflow.get(_.id).size===0&&t.pendingScopeExecutionNotificationsByWorkflow.delete(_.id)}}};ae()}},c=e;a&&(c=[new we({parentPath:["session"],items:[{id:"#userContext#",body:new ur}]}),new we({parentPath:["session"],items:[{id:"#tenantContext#",body:new lr}]})],r.getContextIdManager().applyContextIdOnOperations(c),c=c.concat(e));for(var d of c){var h=m.getTypeNameFor(d);for(var p of d.items){if(r.applyOperationForContext(d,p,$t.Submitted),h===Fe.getTypeName()){(s=this.deltaItems)===null||s===void 0||s.delete(d.parentPath.concat(p.id).toString());continue}else if(p.body)if(h===Ot.getTypeName()&&this.deltaHandlers&&this.deltaItems){this.handleLocalDeltaUpdate(p,d,r);continue}else(u=this.deltaItems)===null||u===void 0||u.set(d.parentPath.concat(p.id).toString(),p.body);else continue;for(var k of this.workflowsWithoutSessionAffinity)f(k,p,d);for(var S of(l=this.workflowsWithSessionAffinity.get(r))!==null&&l!==void 0?l:[])f(S,p,d)}}}},{key:"handleLocalDeltaUpdate",value:function(e,r,t){var a=new D({operationName:"LocalDeltaUpdate",dimension0:m.getTypeNameFor(e.body),success:!0});a.start();try{var s=this.deltaHandlers.get(m.getTypeNameFor(e.body)),u=this.deltaItems.get(r.parentPath.toString());if(s&&u){var l=r.parentPath.length>0?r.parentPath.slice(0,r.parentPath.length-1):r.parentPath,f=s(e.body,u);if(f){var c={id:e.id,revId:e.revId,body:f,parentPath:l,delta:e.body,contextId:e.contextId},d=new ar({parentPath:c.parentPath,items:[c]});v.info(539637591,y.CoreDefault,a.stop()),this.runLocalWorkflows([d],t)}else a.success=!1,a.resultDescription="Failed because the handler did not produce valid updated item",v.info(539637592,y.CoreDefault,a.stop())}else a.success=!1,a.resultDescription="Failed due to lack of handler or parent item",v.info(539637593,y.CoreDefault,a.stop())}catch(h){a.success=!1,a.resultDescription="Failed to apply delta, error: "+h,v.info(539637594,y.CoreDefault,a.stop())}}},{key:"createWorkflowImplementation",value:function(e,r){var t=e.factory(),a={workflow:e,workflowLambda:t,initPromise:this.initWorkflow(e.kind,t,r)};return a}},{key:"initWorkflow",value:function(e,r,t){var a,s=new zc({model:void 0,clientMetadata:t?t.getClientMetadata():void 0,userContext:t?t.getUserContext():void 0,site:this.site,getTokenCallback:(a=this.getAuthTokenCallback)===null||a===void 0?void 0:a.bind(this)});return e===q.SingleItem?r.init(this.site,s):e===q.Join?r.init(this.site,s):Promise.resolve()}},{key:"queueWorkflow",value:function(e){var r=this,t,a,s=e.session.getClientMetadata(),u=void 0;return s&&((t=s.appName)===null||t===void 0?void 0:t.toLowerCase())=="outlook"&&((a=s.appPlatform)===null||a===void 0?void 0:a.toLowerCase())=="web"&&s.releaseAudienceGroup!="Production"&&(u=new D({operationName:"QueueLocalWorkflows",success:!0,resourceId:e.workflowInfo.workflow.id,joinContextId:e.scopeItem.contextId,dimension0:e.triggerReason}).start().setClientMetadata(s)),u&&v.info(509154261,y.CoreDefault,u.stop()),this.executionTrackersByWorkflowNameBySession.get(e.session).get(e.workflowInfo.workflow.id).setExecutionState(e.scopeItem.contextId,ve.Running),this.executeLocalWorkflow(e.workflowInfo,e.scopeItem,e.inputItems,e.session,e.requestedContexts,e.orchestrationMode,e.triggerReason).then(function(l){r.processAnnotationResults(l,e.session),e.onCompleteCallback()}).catch(function(l){throw e.onCompleteCallback(),l})}},{key:"processAnnotationResults",value:function(e,r){for(var t of e)r.onAnnotationResults(t,$t.LocalWorkflow,function(){})}},{key:"executeLocalWorkflow",value:function(e,r,t,a,s,u,l){var f=this;return new Promise(function(c,d){var h,p,k,S=[],C=e.workflow,T=new D({operationName:"ExecuteWorkflow",resourceId:C.id,joinContextId:(h=r==null?void 0:r.contextId)!==null&&h!==void 0?h:"",resultDescription:l!=null?l:"",success:!0}).setClientMetadata(a.getClientMetadata());T.start();var x=(p=r==null?void 0:r.contextId)!==null&&p!==void 0?p:t[0].contextId,A=(k=r==null?void 0:r.revId)!==null&&k!==void 0?k:t[0].revId,b=function(){var re=new Map;if(r&&(r.parentPath||v.error(525382231,y.CoreDefault,"Missing scope item parent. Workflow: "+C.id+". Type: "+m.getTypeNameFor(r.body)),re.set(r.body,r)),Array.isArray(t))for(var V of t)V&&V.body&&(V.parentPath||v.error(525382232,y.CoreDefault,"Missing parent. Workflow: "+C.id+". Type: "+m.getTypeNameFor(V.body)),re.set(V.body,V));return re},E=b(),I=function(re){var V=arguments.length>1&&arguments[1]!==void 0?arguments[1]:T;if(re)return V.success=!1,V.resultDescription+=typeof re=="string"?re:re.message,V.resultSignature="Exception",v.error(572838112,y.CoreDefault,V.stop()),typeof re=="string"?new Error(re):re;v.info(572838113,y.CoreDefault,V.stop())},_=function(re,V,me,te){var ke,He=new D({operationName:"SetAnnotations",resourceId:V,joinContextId:(ke=r==null?void 0:r.contextId)!==null&&ke!==void 0?ke:"",success:!0}).setClientMetadata(a.getClientMetadata());He.start();var rt=function(vn){v.info(555866112,y.CoreDefault,new ki({annotationType:V,annotationState:vn,workflowId:e.workflow.id}))};for(var ut of me)ut.metadata=Object.assign(Object.assign({},ut.metadata),{state:bt.Created}),rt(bt.Created);var xe=E.get(re),lt=m.getTypeNameFor(xe.body),$e=function(){var vn;if(C.kind===q.SingleItem&&t[0].body!==re){var yn="Expected obj to be "+t[0].body+" but instead it was "+re;I(yn,He),d(I(yn));return}var ln;if(!Array.isArray(me))ln="Workflow produced an invalid annotation array";else if(!C.outputTypes||C.outputTypes.indexOf(V)<0)ln="Workflow said it would output one of ["+C.outputTypes+"] but instead output "+V;else if(!xe)ln="No item provided";else for(var Ir of me)m.matchesTypesFor(Ir,[gt.getTypeName()])?m.getTypeNameFor(Ir)!==V&&(ln="Workflow produced inconsistent annotation types in setAnnotations call ("+m.getTypeNameFor(Ir)+" did not match expected "+V+")"):ln="Workflow produced an output that is not an annotation "+m.getTypeNameFor(Ir);if(ln){I(ln,He),d(I(ln));return}var Rn;if(te&&te.isSessionAnnotation?Rn=["session"]:te&&te.ancestorType?Rn=xe.parentPath:Rn=xe.parentPath.concat(xe.id),u!==wr.External){var ht=[],Nn=[],au=function(){or.metadata=Object.assign(Object.assign({},or.metadata),{state:bt.Sent}),rt(bt.Sent);var $=or.id,H=$?(vn=a.getContextAnnotations(V,$t.LocalWorkflow,Rn,C.id))===null||vn===void 0?void 0:vn.filter(function(le){var oe;return((oe=le.body)===null||oe===void 0?void 0:oe.id)==$}):void 0;(H==null?void 0:H.length)==1?H.length==1?Nn.push({id:H[0].id,source:C.id,revId:A,body:or,contextId:x}):v.error(545837260,y.CoreDefault,"Assert: Multiple existing context annotations with body id "+$+" found for "+V+" and local workflow "+C.id+")."):ht.push({id:f.getNextClientAnnotationId(),source:C.id,revId:A,body:or,contextId:x})};for(var or of me)au();var co=[];return ht.length>0&&co.push(new we({parentPath:Rn,items:ht,parentRevId:A})),Nn.length>0&&co.push(new Ne({parentPath:Rn,items:Nn,parentRevId:A})),new wt({annotationType:V,ops:co})}},qt=$e();if(!qt){v.info(509644823,y.CoreDefault,He.stop());return}te&&te.immediate?a.onAnnotationResults(qt,$t.LocalWorkflow,function(){}):S.push(qt),(lt==ur.getTypeName()||lt==lr.getTypeName()||m.matchesTypesFor(xe.body,[Mt.getTypeName(),Pn.getTypeName()]))&&a.submitOperationsToSession(qt.ops),v.info(509644822,y.CoreDefault,He.stop())},M=function(re){if(u===wr.External){d(I("NYI"));return}var V=new D({operationName:"submitSignalsAction",resourceId:C.id,success:!0}).setClientMetadata(a.getClientMetadata());for(var me of re){var te=m.getTypeNameFor(me);m.matchesTypesFor(me,[Gt.getTypeName()])||(V.resultDescription="Workflow produced an output that is not an signal ("+m.getTypeNameFor(me)+")",v.info(521413954,y.CoreDefault,V)),(!C.outputTypes||C.outputTypes.indexOf(te)===-1)&&(V.resultDescription="Workflow said it would output one of ["+C.outputTypes+"] but instead output "+te,v.info(521413953,y.CoreDefault,V)),me.timestamp&&(n.logTimestampUsageByWorkflowId.has(C.id)||(n.logTimestampUsageByWorkflowId.add(C.id),V.resultDescription='Workflow "'+C.id+'" sets signal.timeStamp',v.info(509212803,y.CoreDefault,V)))}var ke=re.map(function(rt){return{id:f.getNextClientSignalId(),source:C.id,revId:A,body:rt,contextId:x}}),He=new Ze({parentPath:["session"],parentRevId:A,items:ke});a.submitOperations([He])},N=function(re,V,me){var te;switch(me){case fr.JoinContext:{if(!r.contextId){var ke="ContextId is not defined for this scope item.";throw v.error(527472289,y.CoreDefault,ke),new Error(ke)}te=r.contextId;break}case fr.Session:{te=void 0;break}default:{var He="Defined scope is not supported. "+me;throw v.error(527472290,y.CoreDefault,He),new Error(He)}}var rt=new Kn({definition:V,contextId:te,sourceWorkflowId:C.id,targetWorkflowId:re});a.onWorkflowDefinitionOverrideMessage(rt)},R=new zc({model:new uw(t[0],s),clientMetadata:a.getClientMetadata(),userContext:a.getUserContext(),site:f.site,getTokenCallback:f.getAuthTokenCallback.bind(f)}),P=function(re){I(re?re.message:void 0),re?d(re):c(S)},O={setAnnotations:_,submitSignals:M,done:P,overrideWorkflowDefinition:N,getDynamicAnnotations:void 0},z=e.workflowLambda;if(C.kind===q.SingleItem){t.length!==1&&P(new Error("Single item workflows expect a single input")),R.delta=t[0].delta,R.deltas=t[0].deltas;try{var J=z;e.initPromise||(e.initPromise=J.init(f.site,R)),e.initPromise.then(function(){J.execute(t[0].body,R,O)}).catch(function(ae){I(ae)})}catch(ae){I(ae)}}else if(C.kind===q.Join){t.length===0&&P(new Error("Join workflows expect an inputs array")),R.delta=r.delta,R.deltas=r.deltas;try{var ce=z;e.initPromise||(e.initPromise=ce.init(f.site,R)),e.initPromise.then(function(){ce.execute(r.body,t.map(function(ae){return ae.body}),R,O)}).catch(function(ae){I(ae)})}catch(ae){I(ae)}}else I("Workflow kind "+C.kind+" not supported")})}},{key:"ensureSweepTimer",value:function(e){if(!this.sweepTimers.get(e)){var r=setInterval(this.onSweep.bind(this),this.sweepIntervalMs);this.sweepTimers.set(e,r)}}},{key:"cancelSweepTimer",value:function(e){var r=this.sweepTimers.get(e);this.sweepTimers.get(e)&&(clearInterval(r),this.sweepTimers.delete(e))}},{key:"onSweep",value:function(){this.sweepScopeExecutionNotifications()}},{key:"setScopeExecutionNotification",value:function(e,r,t,a){var s,u,l=Date.now(),f=l+sl(r.workflow.minDelayMs,1e3),c=l+sl(r.workflow.maxDelayMs,5e3),d={session:e,workflowImplementation:r,scopeItem:t,startTime:l,minTime:f,maxTime:c,orchestrationMode:a},h=r.workflow.kind===q.Join?t.contextId:d.scopeItem.parentPath.concat(t.id).join("\\");this.pendingScopeExecutionNotificationsByWorkflow.get(r.workflow.id)||this.pendingScopeExecutionNotificationsByWorkflow.set(r.workflow.id,new Map);var p=this.pendingScopeExecutionNotificationsByWorkflow.get(r.workflow.id).get(h);if(p){var S=new D({resultDescription:"Duplicated pending scope execution for "+r.workflow.id+" at "+h,operationName:"LocalScopeExecutionNotification",resourceId:r.workflow.id,joinContextId:(u=t==null?void 0:t.contextId)!==null&&u!==void 0?u:"",success:!0}).setClientMetadata(e.getClientMetadata()).start();v.info(509727899,y.CoreDefault,S.stop())}else{var k=new D({resultDescription:"New pending scope execution for "+r.workflow.id+" at "+h,operationName:"LocalScopeExecutionNotification",resourceId:r.workflow.id,joinContextId:(s=t==null?void 0:t.contextId)!==null&&s!==void 0?s:"",success:!0}).setClientMetadata(e.getClientMetadata()).start();v.info(539883075,y.CoreDefault,k.stop()),this.pendingScopeExecutionNotificationsByWorkflow.get(r.workflow.id).set(h,d)}this.ensureSweepTimer(e)}},{key:"sweepScopeExecutionNotifications",value:function(){var e=this,r,t,a=new Set(Array.from(this.sweepTimers.keys()));for(var s of Array.from(this.pendingScopeExecutionNotificationsByWorkflow.entries())){var u=(0,Cr.default)(s,2),l=u[0],f=u[1],c=function(x){var A=x.session,b=x.workflowImplementation.workflow,E=x.orchestrationMode,I=A.getWorkflowItemStorage(),_=new D({operationName:"LocalScopeExecutionNotification",resourceId:b.id,joinContextId:(t=(r=x.scopeItem)===null||r===void 0?void 0:r.contextId)!==null&&t!==void 0?t:"",success:!0}).setClientMetadata(A.getClientMetadata()).start(),M=function(){if(b.kind===q.Join){var P=Date.now(),O=x.workflowImplementation.workflow,z=x.scopeItem.contextId,J=A.getWorkflowDefinition(O,z).maxDelayMs;return I.isWorkflowReady(z,O)?(_.resultDescription="Join Workflow: "+O.id+" queuing by maxAnnotation, contextId: "+z,v.info(528048978,y.CoreDefault,_.stop()),{isValid:!0,triggerReason:bn.JoinMaxAnnnotation}):x.startTime+J<P?(_.resultDescription="Join Workflow: "+O.id+" queuing by maxTimeout, contextId: "+z,v.info(528048979,y.CoreDefault,_.stop()),{isValid:!0,triggerReason:bn.JoinMaxTimeout}):e.isReadyToEarlyJoin(e.executionTrackersByWorkflowNameBySession.get(A).get(O.id),z,A.getClientMetadata())?(v.info(512550856,y.CoreDefault,"Workflow: "+O.id+" queuing by early completion, contextId: "+z+", timeout: "+J),{isValid:!0,triggerReason:bn.JoinEarlyCompletion}):{isValid:!1,triggerReason:bn.Unknown}}return{isValid:!0,triggerReason:bn.Unknown}},N=function(){var P=M(),O=P.isValid,z=P.triggerReason;if(!O)return!1;var J=A.resolveRequestedContexts(b),ce=(0,Cr.default)(J,2),ae=ce[0],re=ce[1];if(!ae)return!1;try{if(b.kind===q.Join){var V=x.scopeItem.contextId,me=I.getScopeItem(V,b);if(me){var te=I.getItemsToExecute(me.contextId,b);if(te.length===0)return _.resultDescription="Failed to retrieve items for workflow: "+b.id+", contextId: "+V+", skipping execution",v.info(527472291,y.CoreDefault,_.stop()),e.onWorkflowExecuted(me,b,A),!0;e.queueWorkflow({workflowInfo:x.workflowImplementation,scopeItem:me,inputItems:te,requestedContexts:re,session:A,orchestrationMode:E,triggerReason:z,onCompleteCallback:e.onWorkflowExecuted.bind(e,me,b,A)}).catch(function(ke){_.success=!1,_.resultDescription=ke.message,v.error(509092189,y.CoreDefault,_.stop())})}else _.resultDescription="ContextId no longer exists, skipping workflow execution",v.info(539883076,y.CoreDefault,_.stop())}else _.resultDescription="Workflow in type "+b.kind+" is not supported",v.error(539883077,y.CoreDefault,_.stop())}catch(ke){_.resultDescription="Trying to execute "+b.id+" caused an exception: "+ke,v.warn(539883078,y.CoreDefault,_.stop())}return!0};N()?(e.pendingScopeExecutionNotificationsByWorkflow.get(l).delete(p),e.pendingScopeExecutionNotificationsByWorkflow.get(l).size===0&&e.pendingScopeExecutionNotificationsByWorkflow.delete(l)):a.delete(A)};for(var d of Array.from(f.entries())){var h=(0,Cr.default)(d,2),p=h[0],k=h[1];c(k)}}if(a.size!==0)for(var S of Array.from(a)){var C=new D({resultDescription:"No pending scope notifications left, cancelling sweep timer",operationName:"LocalScopeExecutionNotification",success:!0}).start();v.debug(539883079,y.CoreDefault,C.stop()),this.cancelSweepTimer(S)}}},{key:"onExternalWorkflowExecuted",value:function(e,r,t){var a={id:"",parentPath:[],contextId:e},s={id:r};this.onWorkflowExecuted(a,s,t,!1)}},{key:"onWorkflowExecuted",value:function(e,r,t){var a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!0,s;(s=this.executionTrackersByWorkflowNameBySession.get(t).get(r.id))===null||s===void 0||s.afterWorkflowExecution(e.contextId),a&&r.kind===q.Join&&t.getWorkflowItemStorage().onWorkflowExecuted(e,r)}}]),n}();g();var Rw=w(W()),Nw=w(B());g();var Iw=w(W()),_w=w(B());g();var Cw=w(W()),xw=w(B());g();var kw=w(W()),ww=w(B());var Sw=function(){function n(){var o=arguments.length>0&&arguments[0]!==void 0?arguments[0]:500;(0,kw.default)(this,n),this.bufferingTimeMs=500,this.workflowIdToSequencersMap=new Map,this.bufferingTimeMs=o}return(0,ww.default)(n,[{key:"create",value:function(e){if(!e.ownerId)return null;var r=this.workflowIdToSequencersMap.get(e.ownerId);return r||(r=new Wo(this.bufferingTimeMs),this.workflowIdToSequencersMap.set(e.ownerId,r)),r}}]),n}();var _A=function(n,o,e,r){function t(a){return a instanceof e?a:new e(function(s){s(a)})}return new(e||(e=Promise))(function(a,s){function u(c){try{f(r.next(c))}catch(d){s(d)}}function l(c){try{f(r.throw(c))}catch(d){s(d)}}function f(c){c.done?a(c.value):t(c.value).then(u,l)}f((r=r.apply(n,o||[])).next())})},Tw=function(){function n(){var o=arguments.length>0&&arguments[0]!==void 0?arguments[0]:500,e=arguments.length>1?arguments[1]:void 0;(0,Cw.default)(this,n),this.sequencerFactory=e!=null?e:new Sw(o)}return(0,xw.default)(n,[{key:"sequence",value:function(e){var r;return _A(this,void 0,void 0,function*(){var t=(r=e==null?void 0:e.M_)===null||r===void 0?void 0:r.seq;if(t!=null){var a=this.sequencerFactory.create(e);a&&(yield a.sequence(e.M_.seq))}})}}]),n}();var Aw=function(){function n(o){(0,Iw.default)(this,n),this.annotationSequencer=o!=null?o:new Tw}return(0,_w.default)(n,[{key:"process",value:function(e,r,t,a){var s=this,u=[],l=function(d){var h=[];if(d!=null&&d.items){var p=function(C){var T=s.annotationSequencer.sequence(C.body).then(function(){r(d,C)});h.push(T)};for(var k of d.items)p(k)}u.push(Promise.all(h).then(function(){t(d)}))};for(var f of e.ops)l(f);Promise.all(u).then(function(){return a(e)})}}]),n}();g();var bw=w(W()),Mw=w(B()),Ew=function(){function n(){(0,bw.default)(this,n)}return(0,Mw.default)(n,[{key:"process",value:function(e,r,t,a){for(var s of e.ops){if(s!=null&&s.items)for(var u of s.items)r(s,u);t(s)}a(e)}}]),n}();var Dw=function(){function n(o,e,r){(0,Rw.default)(this,n),this.isOrderingEnabled=o,this.orderedAnnotationResultsProcessor=e!=null?e:new Aw,this.unorderedAnnotationResultsProcessor=r!=null?r:new Ew}return(0,Nw.default)(n,[{key:"process",value:function(e,r,t,a){this.isOrderingEnabled()?this.orderedAnnotationResultsProcessor.process(e,r,t,a):this.unorderedAnnotationResultsProcessor.process(e,r,t,a)}}]),n}();g();var Ww=w(W()),Bw=w(B()),Pw=w(qe()),Ow=w(Ge()),Vc=w(De());var Lw=w(Jn());function AA(n){var o=bA();return function(){var r=(0,Vc.default)(n),t;if(o){var a=(0,Vc.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,Ow.default)(this,t)}}function bA(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var sa=function(n){(0,Pw.default)(e,n);var o=AA(e);function e(){return(0,Ww.default)(this,e),o.apply(this,arguments)}return(0,Bw.default)(e,[{key:"init",value:function(){return Promise.resolve()}},{key:"sendMessage",value:function(t,a,s){}},{key:"onMessage",value:function(t,a){}},{key:"forceReconnect",value:function(){return Promise.resolve()}},{key:"closeSession",value:function(){}},{key:"sendBytes",value:function(t){}},{key:"getCorrelationVector",value:function(){return new We}},{key:"setState",value:function(t){}}]),e}(Lw.EventEmitter);var MA=30,Ds=function(){return qw().version},Ws=function(){function n(o,e,r){var t=this;(0,Gw.default)(this,n),this.sessionsByDocSessionId=new Map,this.isDeltaGeneratorEnabled=!1,this.disableSyncDeltaSending=!1,this.hasBeenInitialized=!1,this.settings={dropOnlySequencedSyncsOnReseedEnabled:!0,closeWSBlockedSessionEnabled:!0,sessionOfflineModeEnabled:!0,annotationsOrderingEnabled:!0,deltaOperationsEnabled:!1,checkIdbByFeatures:!1,improvedWebSocketEnabled:!1,defaultBatchingEnabled:!0,batchingWith20msIntervalEnabled:!0,onAnnotationsSubmittedEnabled:!1,httpFallbackEnabled:!1,closeWorkerOnReliabilityFailureEnabled:!0},this.isDownloaderCompatible=function(){if(t.settings.checkIdbByFeatures)return typeof Array!="undefined"&&typeof Array.from!="undefined"&&typeof URL!="undefined"&&typeof URL.createObjectURL!="undefined";if(typeof navigator!="undefined"&&navigator.userAgent){var s=navigator.userAgent;return!(!s.indexOf||s.indexOf("MSIE ")>0||s.indexOf("Trident/")>0)}else return!1},this.workerFactory=o||function(s){return new Qn};var a=this.createDefaultSessionManagerFactory();this.sessionManagerFactory=function(){return(e==null?void 0:e.apply(void 0,arguments))||a.apply(void 0,arguments)},this.sessionFactory=r||function(s){return new Ms(s)}}return(0,Uw.default)(n,[{key:"init",value:function(e,r,t,a){var s=this,u,l,f,c,d,h,p,k,S=new D({operationName:"InitRuntime",resourceId:e,dimension1:this.hasBeenInitialized.toString()});S.start(),this.hasBeenInitialized=!0,this.hostCallbacks=t,this.shouldAddLogger(S)?(v.addLogger(new xo(this.hostCallbacks)),this.addLoggingAggregator(a)):(v.clearLoggers(),v.addLogger(new xo(this.hostCallbacks))),n.haveCalledInit=!0,this.annotationResultsProcessor=new Dw(function(){return s.settings.annotationsOrderingEnabled}),this.inferenceServiceFactory=a.inferenceServiceFactory,this.clientMetadata=r,this.clientMetadata&&(this.clientMetadata.runtimeVersion=Ds()),this.networkRateSettings=a.networkRateSettings,S.dimension2=Ea(ze.info).toString();var C=[];e&&(this.defaultServiceUrl=ie.convertServiceUrlToWebSocket(e),this.serviceProtocol=this.defaultServiceUrl.split(":")[0].toLowerCase()),C.push(this.isFeatureEnabled("CheckIdbByFeatures",!1).then(function(A){s.settings.checkIdbByFeatures=A})),C.push(this.isFeatureEnabled("DropOnlySequencedSyncsOnReseedDisabled").then(function(A){s.settings.dropOnlySequencedSyncsOnReseedEnabled=!A})),C.push(this.isFeatureEnabled("CloseWSBlockedSessionDisabled").then(function(A){s.settings.closeWSBlockedSessionEnabled=!A})),C.push(this.isFeatureEnabled("SessionOfflineModeDisabled").then(function(A){s.settings.sessionOfflineModeEnabled=!A})),C.push(this.isFeatureEnabled("AnnotationsOrderingEnabled",!0).then(function(A){s.settings.annotationsOrderingEnabled=A})),C.push(this.isFeatureEnabled("ImprovedWebsocketEnabled").then(function(A){var b;(b=s.settings).improvedWebSocketEnabled||(b.improvedWebSocketEnabled=A)})),C.push(this.isFeatureEnabled("DefaultBatchingDisabled").then(function(A){var b;(b=s.settings).defaultBatchingEnabled&&(b.defaultBatchingEnabled=!A)})),C.push(this.isFeatureEnabled("HttpFallbackEnabled").then(function(A){var b;(b=s.settings).httpFallbackEnabled||(b.httpFallbackEnabled=A)})),C.push(this.isFeatureEnabled("CloseWorkerOnReliabilityFailureDisabled").then(function(A){var b;(b=s.settings).closeWorkerOnReliabilityFailureEnabled&&(b.closeWorkerOnReliabilityFailureEnabled=!A)})),C.push(this.isFeatureEnabled("BatchingWith20msIntervalDisabled").then(function(A){var b;(b=s.settings).batchingWith20msIntervalEnabled&&(b.batchingWith20msIntervalEnabled=!A)})),C.push(this.isFeatureEnabled("OnAnnotationsSubmittedDisabled").then(function(A){var b;(b=s.settings).onAnnotationsSubmittedEnabled&&(b.onAnnotationsSubmittedEnabled=!A)}));var T={enableDeltas:!1,enableEarlyJoin:!1};C.push(Promise.all([this.isFeatureEnabled("DeltaOperationsEnabled").then(function(A){return T.enableDeltas=A}).catch(function(){return T.enableDeltas=!1}),this.isFeatureEnabled("EarlyJoinCompletionEnabled").then(function(A){return T.enableEarlyJoin=A}).catch(function(){return T.enableEarlyJoin=!1})]).then(function(){s.localWorkflowManager=new yw(a.modelDownloader&&s.isDownloaderCompatible()?a.modelDownloader:void 0,s.inferenceServiceFactory,T)}));var x=io((u=r.flights)!==null&&u!==void 0?u:"");return this.isDeltaGeneratorEnabled=x.getBooleanValue("Microsoft.Office.WordOnline.AugloopDeltas",(l=a.isDeltaGeneratorEnabled)!==null&&l!==void 0?l:!1),this.disableSyncDeltaSending=x.getBooleanValue("Microsoft.Office.WordOnline.DisableSyncDeltaSending",(f=a.disableSyncDeltaSending)!==null&&f!==void 0?f:!1),this.syncDeltaTimeout=x.getIntValue("Microsoft.Office.WordOnline.SyncDeltaTimeout",a.syncDeltaTimeout),(c=this.settings).improvedWebSocketEnabled||(c.improvedWebSocketEnabled=x.getBooleanValue("Microsoft.Office.WordOnline.Augloop.ImprovedWebsocketEnabled",!1)),(d=this.settings).httpFallbackEnabled||(d.httpFallbackEnabled=x.getBooleanValue("Microsoft.Office.WordOnline.Augloop.HttpFallbackEnabled",!1)),(h=this.settings).closeWorkerOnReliabilityFailureEnabled&&(h.closeWorkerOnReliabilityFailureEnabled=!x.getBooleanValue("Microsoft.Office.WordOnline.Augloop.CloseWorkerOnReliabilityFailureDisabled",!1)),(p=this.settings).defaultBatchingEnabled&&(p.defaultBatchingEnabled=!x.getBooleanValue("Microsoft.Office.WordOnline.Augloop.DefaultBatchingDisabled",!1)),(k=this.settings).batchingWith20msIntervalEnabled&&(k.batchingWith20msIntervalEnabled=!x.getBooleanValue("Microsoft.Office.WordOnline.Augloop.BatchingWith20msIntervalDisabled",!1)),a&&a.networkMode&&(a.networkMode===Pe.HttpFallback&&(a.networkMode=this.settings.httpFallbackEnabled&&this.settings.improvedWebSocketEnabled?Pe.HttpFallback:Pe.JSWebSockets),this.networkMode=a.networkMode,a.networkMode===Pe.LocalWorkflowsOnly&&(this.sessionManagerFactory=function(){return new sa})),Promise.all(C).then(function(){s.batchOptions=a.batchOptions,!s.batchOptions&&s.settings.defaultBatchingEnabled&&(s.batchOptions={delayMs:1,maxInputSize:1e6,delayMsMax:50},s.settings.batchingWith20msIntervalEnabled&&(s.batchOptions.delayMs=20)),s.batchOptions&&!s.batchOptions.delayMsMax&&(s.batchOptions.delayMsMax=50),S.dimension0=JSON.stringify(s.batchOptions),s.logOperation(S,!0)}).catch(function(A){s.logOperation(S,!1,"Error",A?A.message:"(no error)")})}},{key:"getServiceProtocol",value:function(){return this.serviceProtocol}},{key:"registerLocalWorkflow",value:function(e){this.localWorkflowManager.registerLocalWorkflow(e)}},{key:"flushTelemetry",value:function(e){v.flushAggregators(e)}},{key:"createSession",value:function(e){var r,t=e&&e.docSessionId?e.docSessionId:dn(),a=this.sessionsByDocSessionId.get(t);if(a&&a.isClosed===!1)throw new Error("docSessionId already exists");var s=e?(r=e.serviceUrl)!==null&&r!==void 0?r:this.defaultServiceUrl:this.defaultServiceUrl;s=ie.convertServiceUrlToWebSocket(s),s||(e=e||{},e.networkMode=Pe.LocalWorkflowsOnly),this.networkMode&&!(e&&e.networkMode)&&(e=e||{},e.networkMode=this.networkMode),e&&e.networkMode===Pe.HttpFallback&&(e.networkMode=this.settings.httpFallbackEnabled&&this.settings.improvedWebSocketEnabled?Pe.HttpFallback:Pe.JSWebSockets);var u=Object.assign({},this.clientMetadata);u.docSessionId=t,e&&e.flights&&(u.flights=u.flights?u.flights+";"+e.flights:e.flights);var l=this.sessionFactory({hostCallbacks:this.hostCallbacks,sessionManager:this.sessionManagerFactory(u,s,e,this.networkRateSettings),batchOptions:this.batchOptions,extensionConfigs:(e==null?void 0:e.extensionConfigs)||[],clientMetadata:u,userContext:e?e.userContext:void 0,localWorkflowManager:e&&e.enableComplexLocalWorkflows?void 0:this.localWorkflowManager,annotationResultsProcessor:this.annotationResultsProcessor,localRegisteredWorkflows:(e==null?void 0:e.localRegisteredWorkflows)||[],enableRemoteExecutionNotification:(e==null?void 0:e.enableRemoteExecutionNotification)||!1,networkMode:e==null?void 0:e.networkMode,egress:e?e.egress:void 0,isDeltaGeneratorEnabled:this.isDeltaGeneratorEnabled,onAnnotationsSubmittedEnabled:this.settings.onAnnotationsSubmittedEnabled,disableSyncDeltaSending:this.disableSyncDeltaSending,syncDeltaTimeout:this.syncDeltaTimeout});return this.sessionsByDocSessionId.set(t,l),e&&e.onSessionConnect&&l.setConnectCallback(e.onSessionConnect),e&&e.onSessionDisconnect&&l.setDisconnectCallback(e.onSessionDisconnect),e&&e.onSessionReconnect&&l.setReconnectCallback(e.onSessionReconnect),e&&e.onSessionClose&&l.setSessionCloseCallback(e.onSessionClose),e&&e.onServerAuthenticationStateChangeCallback&&l.setServerAuthenticationStateChangeCallback(e.onServerAuthenticationStateChangeCallback),l.initialize?l.initialize():Promise.resolve(l)}},{key:"getSessionManagerFactory",value:function(){return this.sessionManagerFactory}},{key:"shouldAddLogger",value:function(e){if(n.haveCalledInit){var r=new Error("Runtime already initialized");return e.dimension3=r.stack,e.dimension2=Ea(ze.info).toString(),this.logOperation(e,!1,"Error",r.message),!1}else return!0}},{key:"createDefaultSessionManagerFactory",value:function(){var e=this;return function(r,t,a){if(a&&a.enableComplexLocalWorkflows)throw new Error("NYI");if(a&&a.networkMode==Pe.LocalWorkflowsOnly)return new sa;var s=new Sr,u=new Es,l=function(){v.error(573321615,y.CoreDefault,"Unexpectedly not set sendMessage")},f=new Rs(function(){return u},r,s,function(d,h,p){l(d,h,p)},{getAuthToken:e.getAuthToken.bind(e,r.docSessionId),overrideSessionInitMessage:e.hostCallbacks.overrideSessionInitMessage,enableRemoteExecutionNotification:(a==null?void 0:a.enableRemoteExecutionNotification)||!1}),c=new Rl(ie.convertServiceUrlToWebSocket(t),u,e.workerFactory,f,r,s,e.settings,a==null?void 0:a.networkMode,e.networkRateSettings);return l=c.sendMessage.bind(c),c.on("disconnect",function(){return s.clearRefreshTimeouts()}),c.on("connect",function(d,h,p,k){d&&e.hostCallbacks.setSessionData&&e.hostCallbacks.setSessionData(h,p,k)}),c}}},{key:"getAuthToken",value:function(e){var r={Tickets:[],TokenType:mo.Augloop};return e&&(r.DocSessionId=e),this.hostCallbacks.requestAuthToken(r).then(function(t){if(t)return t.Token}).catch(function(){})}},{key:"isFeatureEnabled",value:function(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"None";return ie.isFeatureEnabled(this.hostCallbacks,e,r,t)}},{key:"logOperation",value:function(e,r,t,a){e.stop(),e.success=r,e.resultSignature=t,e.resultDescription=a,v.info(573321622,y.CoreDefault,e)}},{key:"addLoggingAggregator",value:function(e){var r,t,a;v.addAggregator(Ba("Operation","operationName",["ExecuteBatch","ProcessResponse","LocalDeltaUpdate","ApplyFormattedTextTileDeltaForLocalWorkflows","ApplyTextTileDeltaForLocalWorkflows","FindRangeForDelta","RunModelForInferencing","GetResource","CreateTextTileDeltaFromItem","NetworkEgressControl","OnAnnotationResultsEgress"],(r=e.telemetryAggregationIntervalSec)!==null&&r!==void 0?r:MA)),v.addAggregator(Ba("Operation","operationName",["ExecuteWorkflow","ExecuteLambda","RunLocalWorkflows","EarlyJoinCompletion"],(t=e.telemetryAggregationIntervalSec)!==null&&t!==void 0?t:60)),v.addAggregator(Ba("SessionHealth","sessionHealthEventName",["SendMessage","ProcessMessage"],(a=e.telemetryAggregationIntervalSec)!==null&&a!==void 0?a:60))}},{key:"uninitialize",value:function(){this.flushTelemetry(!0),this.hostCallbacks=null,this.hasBeenInitialized=!1,n.haveCalledInit=!1,v.clearAggregators(),v.clearLoggers()}}]),n}(),Bs=new Ws;g();var Hw=w(W()),zw=w(B()),Vw=function(){function n(){(0,Hw.default)(this,n),this.cache=new Map}return(0,zw.default)(n,[{key:"setReduceTimer",value:function(e,r,t){var a=this,s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:500,u=arguments.length>4&&arguments[4]!==void 0?arguments[4]:function(){return!1},l=arguments.length>5&&arguments[5]!==void 0?arguments[5]:5e3;this.cache.has(e)||this.cache.set(e,new Map);var f=this.cache.get(e);f.has(r)&&clearTimeout(f.get(r).timer);var c=function(){var h=f.get(r),p=Date.now()-h.start;u()&&p<l?h.timer=setTimeout(h.timerCallback,Math.min(s,l-p)):(f.size>1?f.delete(r):a.cache.delete(e),t())};f.set(r,{start:Date.now(),timerCallback:c,timer:setTimeout(c,s)})}},{key:"clear",value:function(e,r){this.cache.forEach(function(t,a){(!e||e===a)&&t.forEach(function(s,u){(!r||r===u)&&clearTimeout(s.timer)})}),this.cache.clear()}}]),n}();g();g();var Qw=w(B()),jw=w(W());var Ps=function(){function n(){var o=arguments.length>0&&arguments[0]!==void 0?arguments[0]:33e5;(0,jw.default)(this,n),this.tokenCache=new Map,this.requestMap=new Map,this.requestRecordMap=new Map,this.tokenExpirationMs=o}return(0,Qw.default)(n,[{key:"updateAuthToken",value:function(e,r){var t=this,a=JSON.stringify(r),s=this.requestRecordMap.get(a);return(s===void 0||this.isTokenExpired(s))&&(s={requestPromise:e.requestAuthToken(r).then(function(u){if(!u||!u.Token)throw new Error("No token available for request "+a);t.tokenCache.set(a,u.Token)}),requestTime:ie.getCurrentTimeMs()},this.requestRecordMap.set(a,s)),s.requestPromise}},{key:"getAuthTokenEntries",value:function(e,r){var t=this;return Array.from(this.tokenCache.keys()).map(function(a){var s=t.requestMap.get(a);return s===void 0&&(s=JSON.parse(a),t.requestMap.set(a,s)),{requestKey:a,request:s}}).filter(function(a){var s=a.request;return r?s.DocId===r:!0}).map(function(a){var s=a.requestKey,u=a.request;return t.isTokenExpired(t.requestRecordMap.get(s))&&t.updateAuthToken(e,u),{ticket:u.Tickets[0],token:t.tokenCache.get(s)}})}},{key:"isTokenExpired",value:function(e){return ie.getCurrentTimeMs()>e.requestTime+this.tokenExpirationMs}}]),n}();var Os,Qc=function(){Os=new Ps};Qc();var Jw=function n(o,e,r,t,a,s,u,l,f,c){var d={method:"POST",headers:{"content-type":"application/json","X-CorrelationId":a},body:JSON.stringify({payload:e.payload,payloadSchema:r,requestedSchema:t,clientMetadata:s,tokens:Os.getAuthTokenEntries(u,f.docId)})};Si(o,d,function(h,p){h?c(new Error("Fetch error in remote lambda request to "+o+": "+h)):p.status===401?l>0?(v.info(572838109,y.CoreDefault,"Auth token required for remote lambda request"),p.json().then(function(k){return Os.updateAuthToken(u,{Tickets:[k],DocId:f.docId})}).then(function(){n(o,e,r,t,a,s,u,l-1,f,c)}).catch(function(k){c({exceptionType:ye.Authentication,message:k.message})})):c({exceptionType:ye.Authentication,message:"Remote lambda request retry with authentication token failed"}):p.ok?p.json().then(function(k){if(!Array.isArray(k))c(new Error("Did not receive a valid response for remote lambda request"));else if(k.length>0){var S=0;for(var C of k)e.moreResults=++S<k.length,c(null,C)}else c(new Error("No output"))}).catch(function(k){c({exceptionType:ye.LambdaThrow,message:k.message})}):c(new Error("Remote lambda request failed with status "+p.status))})},Kw=function(o,e,r,t,a,s,u,l,f){Array.isArray(l.authTickets)?Os.updateAuthToken(u,{Tickets:l.authTickets,DocId:l.docId}).then(function(){Jw(o,e,r,t,a.id,s,u,1,l,f)}).catch(function(c){f({exceptionType:ye.Authentication,message:c.message})}):Jw(o,e,r,t,a.id,s,u,1,l,f)};g();g();var jc=w(W()),Jc=w(B());var RA=function(){function n(o,e,r,t,a,s){(0,jc.default)(this,n),this.requestId=o,this.correlationId=e,this.schemaName=r,this.data=t,this.callback=a,this.requestTimeoutInMs=s,this.ended=!1,this.startTime=0}return(0,Jc.default)(n,[{key:"startRequest",value:function(){this.startTime=ie.getCurrentTimeMs()}},{key:"getMsUntilTimeout",value:function(){var e=ie.getCurrentTimeMs()-this.startTime;return this.requestTimeoutInMs-e}},{key:"endRequest",value:function(e){this.ended||(this.invokeCallback(null,e,!0),this.ended=!0)}},{key:"addResponseData",value:function(e){this.invokeCallback(e,null,!1)}},{key:"invokeCallback",value:function(e,r,t){var a=this;new Promise(function(){return a.callback(e,r,t)}).catch(function(s){})}}]),n}(),$w=function(){function n(o,e,r){(0,jc.default)(this,n),this.requestCounter=0,this.activeRequests=[],this.pendingRequests=[],this.requestTimeoutInMs=o,this.workerFactory=e,this.maxActiveRequests=r}return(0,Jc.default)(n,[{key:"testConnection",value:function(e,r){var t=this,a=!1,s=new D({cv:new We().toString(),operationName:"WebSocketTest",resourceId:e,success:!0}).start();return new Promise(function(u){var l=ie.createHealthCheckRequest(r);e?t.addRequest(e,l,s.cv,"HealthCheckRequest",function(f,c,d){c&&(s.success=!1,s.resultSignature="Error",s.resultDescription=c.message||c),f&&f.status==="OK"&&(a=!0),d&&(s.success&&!a&&(s.success=!1,s.resultSignature="NoResponseData"),v.info(556617949,y.CoreDefault,s.stop()),u(s.success))}):(s.success=!1,s.resultSignature="EmptyUrl",v.info(557641870,y.CoreDefault,s.stop()),u(s.success))})}},{key:"addRequest",value:function(e,r,t,a,s){var u=(this.requestCounter++).toString(),l=new RA(u,t,a,r,s,this.requestTimeoutInMs);this.getWorker(e),this.pendingRequests.push(l),this.egressPendingRequests()}},{key:"egressPendingRequests",value:function(){for(;this.pendingRequests.length>0&&this.activeRequests.length<this.maxActiveRequests;){var e=this.pendingRequests.shift();if(this.activeRequests.push(e),this.activeRequests.length===1){var r=e.getMsUntilTimeout();setTimeout(this.onTimeout.bind(this),r)}e.startRequest(),this.worker&&this.worker.egress({obj:this.createRequestMessage(e.data,e.requestId,e.correlationId)})}}},{key:"createRequestMessage",value:function(e,r,t){return JSON.stringify({correlationId:t,requestId:r,body:e})}},{key:"onTimeout",value:function(){for(;this.activeRequests.length>0;){var e=this.activeRequests[0],r=e.getMsUntilTimeout();if(r<=0){var t=new Error("Request timed out");e.endRequest(t),this.activeRequests.shift(),this.egressPendingRequests()}else{setTimeout(this.onTimeout.bind(this),r);return}}}},{key:"onMessage",value:function(e){try{for(var r=JSON.parse(e),t=0;t<this.activeRequests.length;t++){var a=this.activeRequests[t];if(a.requestId===r.requestId){r.end?(this.activeRequests.splice(t,1),a.endRequest(r.error),this.egressPendingRequests()):r.body&&a.addResponseData(r.body);break}}}catch(s){v.error(557641871,y.CoreDefault,s)}}},{key:"onClose",value:function(e){var r=new Error("Connection closed: "+e);for(var t of this.activeRequests)t.endRequest(r);this.activeRequests=[];for(var a of this.pendingRequests)a.endRequest(r);this.pendingRequests=[],this.worker=void 0}},{key:"getWorker",value:function(e){return this.worker||(this.worker=this.workerFactory(),this.worker.init(e,this.onMessage.bind(this),function(){},this.onClose.bind(this))),this.worker}}]),n}();var NA=3e4,DA=50,Ls,Kc=function(){Ls=new Ps};Kc();var Yw=new $w(NA,function(){return new Qn},DA),Xw=function n(o,e,r,t,a,s,u,l,f,c){var d={payload:e.payload,payloadSchema:r,requestedSchema:t,clientMetadata:s,tokens:Ls.getAuthTokenEntries(u,f.docId)},h="";t&&t.schema&&(h=t.schema.name);var p=!1;Yw.addRequest(o,d,a,h,function(k,S,C){if(!p)if(p=!0,S!=null)if(S.exceptionType===ye.Authentication)try{var T=JSON.parse(S.data);l>0?(v.info(572838108,y.CoreDefault,"Auth token required for remote lambda WebSocket request"),Ls.updateAuthToken(u,{Tickets:[T],DocId:f.docId}).then(function(){n(o,e,r,t,a,s,u,l-1,f,c)}).catch(function(x){c({exceptionType:ye.Authentication,message:x.message})})):c({exceptionType:ye.Authentication,message:"Remote lambda request retry with authentication token failed"})}catch(x){c({exceptionType:ye.Authentication,message:x.message})}else c(new Error("Error in remote lambda WebSocket request to "+o+": "+S));else e.moreResults=!1,c(null,k)})},Zw=function(o,e,r,t,a,s,u,l,f){Array.isArray(l.authTickets)?Ls.updateAuthToken(u,{Tickets:l.authTickets,DocId:l.docId}).then(function(){Xw(o,e,r,t,a.id,s,u,1,l,f)}).catch(function(c){f({exceptionType:ye.Authentication,message:c.message})}):Xw(o,e,r,t,a.id,s,u,1,l,f)},eS=function(o,e){return Yw.testConnection(o,e)};g();var tS=w(W()),nS=w(B()),rS=function(){function n(){(0,tS.default)(this,n),this.cache=new Map,this.bucketSizes=new Map}return(0,nS.default)(n,[{key:"setBucketSize",value:function(e,r){this.bucketSizes.set(e,r)}},{key:"setResult",value:function(e,r,t){if(r.primary){var a=this.cache.get(e);a||(a=new Map,this.cache.set(e,a));var s=a.get(r.primary);if(s||(s=r.secondary?new Map:[],a.set(r.primary,s)),r.secondary){var u=s;u.set(r.secondary,t)}else{var l=s;l.length==this.getBucketSize(e)&&l.shift(),l.push(t)}}}},{key:"getResults",value:function(e,r){var t=this.cache.get(e);if(t){var a=t.get(r.primary);if(a){if(!r.secondary)return a;var s=Array.from(a.values());if(s.length>0)return s}}return[]}},{key:"clear",value:function(e,r){r?this.cache.forEach(function(t,a){if(!e||e===a)if(r.secondary){var s=t.get(r.primary);s&&s.delete(r.secondary)}else t.delete(r.primary)}):e?this.cache.delete(e):this.cache.clear()}},{key:"getBucketSize",value:function(e){return this.bucketSizes.get(e)||10}}]),n}();g();var Q;(function(n){n[n.Unknown=0]="Unknown",n[n.Local=1]="Local",n[n.Custom=2]="Custom",n[n.Remote=3]="Remote",n[n.BatchedRemote=4]="BatchedRemote"})(Q||(Q={}));g();var oS=w(W()),iS=w(B());var aS=function(){function n(){(0,oS.default)(this,n),this.throttleInfoMap=new Map}return(0,iS.default)(n,[{key:"execute",value:function(e,r,t){var a=this;if(!r.throttleSettings.shouldBeThrottled||!(r.throttleSettings.throttlingInterval>0))t();else{var s=this.getWorkflowThrottleInfo(r.name);if(s.currentTileId==null)s.currentTileId=e,s.timeOfPreviousStartedEvent=ie.getCurrentTimeMs(),t();else if(s.currentTileId===e){var u=ie.getCurrentTimeMs(),l=this.delayTime(s,u,r.throttleSettings.throttlingInterval);l>0?(s.latestCallback=t,s.lastTimeout==null&&(s.lastTimeout=setTimeout(function(){var f=a.getWorkflowThrottleInfo(r.name);f.lastTimeout=void 0,f.timeOfPreviousStartedEvent=ie.getCurrentTimeMs(),f.latestCallback()},l))):(s.timeOfPreviousStartedEvent=u,t())}else s.lastTimeout!=null&&(clearTimeout(s.lastTimeout),s.latestCallback(),s.lastTimeout=void 0),s.currentTileId=e,s.timeOfPreviousStartedEvent=ie.getCurrentTimeMs(),t()}}},{key:"delayTime",value:function(e,r,t){var a=r-e.timeOfPreviousStartedEvent;return Math.max(t-a,0)}},{key:"getWorkflowThrottleInfo",value:function(e){var r=this.throttleInfoMap.get(e);return r||(r={currentTileId:void 0,timeOfPreviousStartedEvent:-1,latestCallback:function(){},lastTimeout:void 0},this.throttleInfoMap.set(e,r)),r}}]),n}();var Mn;(function(n){n[n.Restricted=0]="Restricted",n[n.Unrestricted=1]="Unrestricted",n[n.Suppressed=2]="Suppressed"})(Mn||(Mn={}));var $c=function(){function n(){(0,Xc.default)(this,n),this.canaryTextTileEventSubmittedByDocSessionId=new Set,this.stateByDocSessionId=new Map,this.executionQueueByDocSessionId=new Map,this.executionCountByDocSessionId=new Map}return(0,Yc.default)(n,[{key:"getOutputSchema",value:function(){return this.lambdas[this.lambdas.length-1].outputSchema}},{key:"scheduleExecution",value:function(e,r){var t=this.docSessionIdExtractor?this.docSessionIdExtractor(e):void 0,a=this.getStateForDocSessionId(t);if(a===Mn.Restricted){var s=this.getExecutionQueueForDocSessionId(t);s.push(r),s.length===1&&r()}else a===Mn.Unrestricted?r():Mn.Suppressed}},{key:"onStart",value:function(e){this.incrementExecutionCountForDocSessionId(e)}},{key:"onFinish",value:function(e,r){if(this.decrementExecutionCountForDocSessionId(e),r===ye.Authentication)this.stateByDocSessionId.set(e,Mn.Suppressed),this.executionQueueByDocSessionId.delete(e);else if(this.stateByDocSessionId.get(e)===Mn.Restricted){var t=this.getExecutionQueueForDocSessionId(e);if(t.shift(),r===void 0){this.stateByDocSessionId.set(e,Mn.Unrestricted),this.executionQueueByDocSessionId.delete(e);for(var a of t)a()}else if(t.length>0){var s=t[0];s()}}}},{key:"onRefresh",value:function(e){this.stateByDocSessionId=new Map,this.triggerOnRefresh&&(e?(this.executionQueueByDocSessionId.delete(e),this.executionCountByDocSessionId.delete(e)):(this.executionQueueByDocSessionId=new Map,this.executionCountByDocSessionId=new Map)),this.canaryTextTileEventSubmittedByDocSessionId.delete(e)}},{key:"getStateForDocSessionId",value:function(e){var r=this.stateByDocSessionId.get(e);return r===void 0&&(r=n.executionQueuesEnabled?Mn.Restricted:Mn.Unrestricted,this.stateByDocSessionId.set(e,r)),r}},{key:"getExecutionQueueForDocSessionId",value:function(e){var r=this.executionQueueByDocSessionId.get(e);return r===void 0&&(r=[],this.executionQueueByDocSessionId.set(e,r)),r}},{key:"incrementExecutionCountForDocSessionId",value:function(e){var r=this.executionCountByDocSessionId.get(e)||0;this.executionCountByDocSessionId.set(e,r+1)}},{key:"decrementExecutionCountForDocSessionId",value:function(e){var r=this.executionCountByDocSessionId.get(e)||0;r<=1?this.executionCountByDocSessionId.delete(e):this.executionCountByDocSessionId.set(e,r-1)}}]),n}();$c.executionQueuesEnabled=!0;var xr=function(o){return{category:wn.Schema,schema:{name:o}}},la="Tiling.TextTileEvent",Zc="ClpSlideTile",BA=function(o,e){return o===la&&e&&e.type==Fn.TextTileEventType.Delete||o===Zc&&e&&e.eventType==si.SlideTileEventType.Delete},uS=function(o,e){return o===la&&e&&e.type==Fn.TextTileEventType.Refresh},lS=function(o,e){return o===Zc&&e&&e.eventType==si.SlideTileEventType.Refresh},sS=function(o,e){return uS(o,e)||lS(o,e)},PA=function(o,e){var r,t;return uS(o,e)?(t=(r=e.tile)===null||r===void 0?void 0:r.metadata)===null||t===void 0?void 0:t.seqnoCLPRefresh:(lS(o,e),-1)},Fs=function(o,e){var r,t;if(o===la)return(t=(r=e.tile)===null||r===void 0?void 0:r.metadata)===null||t===void 0?void 0:t.docSessionId;if(o===Zc)return e.docId},OA=function(o){return{type:o.type,tile:{metadata:{docSessionId:o.tile.metadata.docSessionId,docId:o.tile.metadata.docId,seqnoCLPRefresh:o.tile.metadata.seqnoCLPRefresh,tileId:"A56B3127DBDFD0D6"},elements:[{text:"B91153AE828B4E48"}]}}},LA=function(){function n(){(0,Xc.default)(this,n),this.inputSchemasToWorkflows=new Map,this.inputSchemasToReduceWorkflows=new Map,this.reduceWorkflowsGroupingKeyExtractors=new Map,this.defaultWorkflowOptions={canProduceNullResult:!1,shouldSendResultsToHost:!0,enabledByDefault:!1,throttleSettings:{shouldBeThrottled:!1},triggerOnRefresh:!1},this.resultCache=new rS,this.reduceTimerCache=new Vw,this.lookupTableCache=new Map,this.throttling=new aS,this.lastTileRefreshSeq=-1,this.lastTileRefreshSeqByDocSessionId=new Map,this.tileRefreshByDocSessionIdEnabled=!0}return(0,Yc.default)(n,[{key:"init",value:function(e,r,t){var a=this,s=new D({operationName:"InitRuntimeALv1",resourceId:e});s.start(),this.clientMetadata=r,this.clientMetadata&&(this.clientMetadata.runtimeVersion=Ds()),this.hostCallbacks=t;var u=[];return u.push(this.isFeatureEnabled("DisableWebSocket").then(function(l){var f=!l;if(!f)return!1;var c=["Outlook Mac","Outlook Win32","PowerPoint Mac","PowerPoint Web","PowerPoint Win32","Word Mac","Word Win32"];return c.indexOf(r.appName+" "+r.appPlatform)>=0?eS(ie.convertServiceUrlToWebSocket(e),a.clientMetadata):!0}).then(function(l){e&&(a.serviceUrl=l?ie.convertServiceUrlToWebSocket(e):e,a.executeRemoteLambda=l?Zw:Kw,a.clearRemoteLambdaTokenCache=l?Kc:Qc,a.serviceProtocol=a.serviceUrl.split(":")[0].toLowerCase())})),u.push(this.isFeatureEnabled("WorkflowQueuesDisabled").then(function(l){$c.executionQueuesEnabled=!l})),u.push(this.isFeatureEnabled("TileRefreshByDocSessionIdDisabled").then(function(l){a.tileRefreshByDocSessionIdEnabled=!l})),Promise.all(u).then(function(){a.logOperation(s,!0)}).catch(function(l){a.logOperation(s,!1,"Error",l?l.message:"(no error)")})}},{key:"getServiceProtocol",value:function(){return this.serviceProtocol}},{key:"registerSchemas",value:function(e,r){return Promise.resolve()}},{key:"registerSimpleLocalWorkflow",value:function(e,r){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.defaultWorkflowOptions;return r.source=r.source||Q.Custom,this.registerHardcodedWorkflow(e,[r],this.inputSchemasToWorkflows,t)}},{key:"registerSimpleRemoteWorkflow",value:function(e,r,t,a){var s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:this.defaultWorkflowOptions,u=[];return r&&(r.source=Q.Custom,u.push(r)),t.source=t.func?Q.Custom:Q.Remote,u.push(t),a&&(a.source=Q.Custom,u.push(a)),this.registerHardcodedWorkflow(e,u,this.inputSchemasToWorkflows,s)}},{key:"registerMultipleLambdasWorkflow",value:function(e,r){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.defaultWorkflowOptions;return this.registerHardcodedWorkflow(e,r,this.inputSchemasToWorkflows,t)}},{key:"registerReduceWorkflow",value:function(e,r,t){var a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:10,s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:this.defaultWorkflowOptions;return this.reduceWorkflowsGroupingKeyExtractors.set(r.inputSchema,t),this.resultCache.setBucketSize(r.inputSchema,a),r.source=r.source||Q.Custom,this.registerHardcodedWorkflow(e,[r],this.inputSchemasToReduceWorkflows,s)}},{key:"registerMultipleLambdasReduceWorkflow",value:function(e,r,t){var a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:10,s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:this.defaultWorkflowOptions;return this.reduceWorkflowsGroupingKeyExtractors.set(r[0].inputSchema,t),this.resultCache.setBucketSize(r[0].inputSchema,a),this.registerHardcodedWorkflow(e,r,this.inputSchemasToReduceWorkflows,s)}},{key:"submit",value:function(e,r,t){this.submitToWorkflows(e,r,t,this.inputSchemasToWorkflows)}},{key:"getGroupingKey",value:function(e,r,t){var a=this.reduceWorkflowsGroupingKeyExtractors.get(t);if(a==null)throw new Error("Reduce workflow does not have a grouping extractor");return a(r,e)}},{key:"submitToWorkflows",value:function(e,r,t){var a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:this.inputSchemasToWorkflows;if(this.hostCallbacks){var s;t?s=We.fromString(t):s=new We,this.handleTileRefresh(e,r,s);var u=a.get(e)||[];for(var l of u)sS(e,r)&&!l.triggerOnRefresh||(l.useCanaryTextTile&&e===la&&!l.canaryTextTileEventSubmittedByDocSessionId.has(Fs(e,r))&&(this.submitToWorkflow(la,OA(r),s,l,a),l.canaryTextTileEventSubmittedByDocSessionId.add(Fs(e,r))),this.submitToWorkflow(e,r,s,l,a))}}},{key:"submitToWorkflow",value:function(e,r,t,a,s){var u=this,l={messageType:fn.Input,correlationVector:t.newChild(),payload:r,payloadSchema:xr(a.lambdas[0].inputSchema),clientMetadata:this.clientMetadata},f=new D({cv:l.correlationVector.toString(),operationName:"ExecuteWorkflow",resourceId:a.name});f.setClientMetadata(this.clientMetadata),f.start(),a.scheduleExecution(r,function(){try{if(!l.payload||!l.payload.tile||!l.payload.tile.metadata||!l.payload.tile.metadata.tileId)u.executeWorkflow(f,l,r,a,e,s);else{var c=l.payload.tile.metadata.tileId;u.throttling.execute(c,a,function(){return u.executeWorkflow(f,l,r,a,e,s)})}}catch(d){f.success=!1,f.resultSignature="ExecuteException",f.resultDescription=d?d.message:"(no error)",v.error(559290447,y.CoreDefault,f.stop())}})}},{key:"handleTileRefresh",value:function(e,r,t){var a=this;if(sS(e,r)){var s=this.tileRefreshByDocSessionIdEnabled?Fs(e,r):void 0,u=PA(e,r);if(this.tileRefreshByDocSessionIdEnabled){var l=this.lastTileRefreshSeqByDocSessionId.get(s);if(l>=0&&u<=l)return}else if(u<=this.lastTileRefreshSeq)return;var f=new D({cv:t.toString(),operationName:"TileRefresh",resultDescription:"",success:!0});if(f.start(),this.tileRefreshByDocSessionIdEnabled&&!s){f.success=!1,f.resultDescription="NoDocSessionId",v.info(559290448,y.CoreDefault,f.stop());return}this.inputSchemasToReduceWorkflows.forEach(function(h,p){h.some(function(k){return k.triggerOnRefresh})&&(a.tileRefreshByDocSessionIdEnabled?(a.resultCache.clear(p,{primary:s}),a.resultCache.clear(a.getForcedDocLevelSchema(p),{primary:s}),a.reduceTimerCache.clear(p,s)):(a.resultCache.clear(p),a.resultCache.clear(a.getForcedDocLevelSchema(p)),a.reduceTimerCache.clear(p)),h.some(function(k){return!k.triggerOnRefresh})&&(f.resultDescription+="X_"),f.resultDescription+=p+" ")}),this.clearRemoteLambdaTokenCache();var c=[];this.inputSchemasToWorkflows.forEach(function(h){return c.push.apply(c,(0,ua.default)(h))}),this.inputSchemasToReduceWorkflows.forEach(function(h){return c.push.apply(c,(0,ua.default)(h))});for(var d of c)this.tileRefreshByDocSessionIdEnabled?d.onRefresh(s):d.onRefresh();this.tileRefreshByDocSessionIdEnabled?this.lastTileRefreshSeqByDocSessionId.set(s,u):this.lastTileRefreshSeq=u,v.info(559290449,y.CoreDefault,f.stop())}}},{key:"executeWorkflow",value:function(e,r,t,a,s,u){var l=this,f=a.docIdExtractor?a.docIdExtractor(r.payload):void 0,c=a.docSessionIdExtractor(t),d=this.tileRefreshByDocSessionIdEnabled?this.lastTileRefreshSeqByDocSessionId.get(c):this.lastTileRefreshSeq;a.onStart(c);var h=function(k){var S=l.tileRefreshByDocSessionIdEnabled?l.lastTileRefreshSeqByDocSessionId.get(c):l.lastTileRefreshSeq;if(a.triggerOnRefresh&&S!==d){e.success=!0,e.resultSignature="TileRefreshIgnore",v.info(559290450,y.CoreDefault,e.stop());return}var C=k.messageType==fn.Exception&&k.payload.exceptionType==ye.NoOutput,T=C&&a.canProduceNullResult,x=T?a.lambdas[a.lambdas.length-1].outputSchema:k.payloadSchema.schema.name,A=T?null:k.payload;k.messageType===fn.Input||T?(a.shouldSendResultsToHost&&(u===l.inputSchemasToReduceWorkflows?l.hostCallbacks.onResult("Reduce.Input",t,x,A):l.hostCallbacks.onResult(s,t,x,A)),e.success=!0,e.resultSignature=C?"NoOutput":"ValidOutput"):C?(e.success=!0,e.resultSignature="NoOutput"):(e.success=!1,e.resultSignature="Exception",e.resultDescription=Or(k)),u!==l.inputSchemasToReduceWorkflows&&l.updateResultCacheForReduceWorkflows(s,t,x,A,k.correlationVector.toString()),k.moreResults||(e.stop(),v.info(559290451,y.CoreDefault,e),a.onFinish(c,k.payload&&k.payload.exceptionType?qp(k):void 0))};a.preExecutionPromise.then(function(){for(var p={lookupTable:l.lookupTableCache.get(a.name),docId:f,docSessionId:c},k=h,S=a.lambdas.length-1;S>=0;S--)k=l.createLambdaExecutionStep(a.name,a.lambdas[S],p,k,h);k(r)})}},{key:"getForcedDocLevelSchema",value:function(e){return"~"+e}},{key:"updateResultCacheForReduceWorkflows",value:function(e,r,t,a,s){var u=this,l=this.inputSchemasToReduceWorkflows.get(t);if(l){var f;e==="docSessionId"?(f=this.getGroupingKey(e,r,t),this.resultCache.setResult(this.getForcedDocLevelSchema(t),f,a),f.secondary="*"):(f=this.getGroupingKey(e,r,t),BA(e,r)&&f.primary!=null&&f.secondary!=null?this.resultCache.clear(void 0,f):this.resultCache.setResult(t,f,a));var c=l.some(function(k){return k.deferReduceUntilIdle}),d=[];this.inputSchemasToWorkflows.forEach(function(k){return d.push.apply(d,(0,ua.default)(k.filter(function(S){return S.getOutputSchema()===t})))});var h=function(){return c&&d.some(function(S){return S.executionCountByDocSessionId.get(f.primary)>0})},p=l.map(function(k){return k.deferReduceUntilIdleMaxDelayMs||0}).reduce(function(k,S){return Math.max(k,S)});this.reduceTimerCache.setReduceTimer(t,f.primary,function(){var k=u.resultCache.getResults(t,f);if(k.push.apply(k,(0,ua.default)(u.resultCache.getResults(u.getForcedDocLevelSchema(t),{primary:f.primary}))),Array.isArray(k)){var S={id:f.primary,values:k,isReduceInput:!0};u.submitToWorkflows(t,S,s,u.inputSchemasToReduceWorkflows)}else v.error(559290452,y.CoreDefault,'Cached results have unexpected type "'+typeof k+'"')},500,h,p)}}},{key:"isFeatureEnabled",value:function(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"None";return this.hostCallbacks&&this.hostCallbacks.isFeatureEnabled?this.hostCallbacks.isFeatureEnabled("Microsoft.Office.AugLoop."+e,t).catch(function(){return Promise.resolve(r)}):Promise.resolve(r)}},{key:"areLicenseFeaturesEnabled",value:function(e){return this.hostCallbacks&&this.hostCallbacks.areLicenseFeaturesEnabled?this.hostCallbacks.areLicenseFeaturesEnabled(e).catch(function(){return Promise.resolve(!1)}):Promise.resolve(!1)}},{key:"isWorkflowEnabled",value:function(e,r,t,a,s){var u=this,l=r.some(function(c){return c.source===Q.Remote||c.source===Q.BatchedRemote});if(l){if(!this.serviceUrl)return s.resultDescription="Disabled because no service URL available for remote workflow",Promise.resolve(!1);if(this.clientMetadata&&this.clientMetadata.privateMode&&r.some(function(c){return(c.source===Q.Remote||c.source===Q.BatchedRemote)&&!c.canRunInPrivateMode}))return s.resultDescription="Disabled because we are running in private mode",Promise.resolve(!1)}(!this.clientMetadata||this.clientMetadata.appPlatform!=="Mac"&&this.clientMetadata.appPlatform!=="Win32")&&(a=!0,s.resultDescription="Enabled by default due to platform name");var f;return a?f=Promise.resolve(!0):f=this.isFeatureEnabled("WorkflowEnabled."+e),f.then(function(c){return c?u.isFeatureEnabled("WorkflowDisabled."+e).then(function(d){return d?(s.resultDescription="Disabled because explicitly disabled",!1):t?u.areLicenseFeaturesEnabled(t).then(function(h){return h||(s.resultDescription="Disabled because license check failed"),h}):!0}):(s.resultDescription="Disabled because not explicitly enabled",!1)})}},{key:"registerHardcodedWorkflow",value:function(e,r){var t=this,a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.inputSchemasToWorkflows,s=arguments.length>3?arguments[3]:void 0;if(!e||e.length>40)throw new Error("Workflow name has invalid length");if(new RegExp(/^[A-Z][a-zA-Z0-9_]+$/).test(e)===!1)throw new Error("Workflow name has invalid format");a.forEach(function(l){if(l.some(function(f){return f.name===e}))throw new Error("Workflow name already registered.")});var u=new D({operationName:"WorkflowRegistration",resourceId:e,success:!0});return u.setClientMetadata(this.clientMetadata),u.start(),this.isWorkflowEnabled(e,r,s.licenseFeatures,s.enabledByDefault,u).then(function(l){if(u.resultSignature=l?"Enabled":"Disabled",u.stop(),v.info(559290453,y.CoreDefault,u),l){var f=r[0].inputSchema,c=a.get(f);c||(c=[],a.set(f,c));var d=Promise.resolve();s.lookupTableLambda&&(d=new Promise(function(p,k){var S=new We,C={messageType:fn.Input,correlationVector:S,payloadSchema:xr(s.lookupTableLambda.inputSchema),clientMetadata:t.clientMetadata,payload:{}},T=function(b){b.messageType===fn.Input&&b.payload&&t.lookupTableCache.set(e,b.payload),p()},x=t.createLambdaExecutionStep("",s.lookupTableLambda,{},T,T);x(C)}));var h=new $c;h.name=e,h.lambdas=r,h.canProduceNullResult=s.canProduceNullResult,h.shouldSendResultsToHost=s.shouldSendResultsToHost,h.triggerOnRefresh=s.triggerOnRefresh,h.throttleSettings=s.throttleSettings||t.defaultWorkflowOptions.throttleSettings,h.docIdExtractor=s.docIdExtractor,h.docSessionIdExtractor=function(p){return p.isReduceInput?p.id:Fs(f,p)},h.deferReduceUntilIdle=s.deferReduceUntilIdle,h.deferReduceUntilIdleMaxDelayMs=s.deferReduceUntilIdleMaxDelayMs,h.useCanaryTextTile=s.useCanaryTextTile,h.preExecutionPromise=d,c.push(h)}})}},{key:"logOperation",value:function(e,r,t,a){e.stop(),e.success=r,e.resultSignature=t,e.resultDescription=a,v.info(559290454,y.CoreDefault,e)}},{key:"handleLambdaError",value:function(e,r,t,a,s){e.exceptionType!=null?Vn(r,e):e instanceof Error?Vn(r,{exceptionType:a,message:e.message}):Vn(r,{exceptionType:ye.Unknown,message:e?e.toString():void 0}),this.logOperation(t,!1,"Exception",Or(r)),s(r)}},{key:"handleLambdaOutput",value:function(e,r,t,a,s,u){e&&e.exceptionType!==ye.NoOutput?e.exceptionType!=null?this.handleLambdaError(e,r,t,e.exceptionType,u):e instanceof Error?this.handleLambdaError(e,r,t,ye.LambdaErrorCallback,u):(r.payload=e,r.payloadSchema=xr(a),this.logOperation(t,!0),s(r)):(Vn(r,{exceptionType:ye.NoOutput}),this.logOperation(t,!0,"NoOutput"),u(r))}},{key:"executeCustomLambdaStep",value:function(e,r,t,a,s,u){var l=this;if(t.func==null)Vn(e,{exceptionType:ye.LambdaThrow,message:"No lambda function set"}),this.logOperation(r,!1,"Error",Or(e)),u(e);else{var f=function(h){l.handleLambdaOutput(h,e,r,t.outputSchema,s,u)},c=function(h,p){l.handleLambdaOutput(h,e,r,p,u,u)};try{t.func(e.payload,t.config,a,f,c)}catch(d){this.handleLambdaError(d,e,r,ye.LambdaThrow,u)}}}},{key:"executeLocalLambdaStep",value:function(e,r,t,a,s){var u=this;this.hostCallbacks.executeLocalLambda==null?(Vn(e,{exceptionType:ye.LambdaThrow,message:"No local lambda host callback set"}),this.logOperation(r,!1,"Error",Or(e)),s(e)):this.hostCallbacks.executeLocalLambda(t.inputSchema,e.payload,t.outputSchema).then(function(l){u.handleLambdaOutput(l,e,r,t.outputSchema,a,s)}).catch(function(l){u.handleLambdaError(l,e,r,ye.LambdaThrow,s)})}},{key:"executeRemoteLambdaStep",value:function(e,r,t,a,s,u){var l=this;if(this.serviceUrl){r.resourceId+="."+this.serviceProtocol;var f=function(S,C){S?l.handleLambdaError(S,e,r,S.exceptionType||ye.LambdaErrorCallback,u):l.handleLambdaOutput(C,e,r,t.outputSchema,s,u)};if(a.authTickets=t.authTickets,t.source===Q.Remote)this.executeRemoteLambda(this.serviceUrl,e,xr(t.inputSchema),xr(t.outputSchema),e.correlationVector,this.clientMetadata,this.hostCallbacks,a,f);else{this.batchedRemoteLambdaManager||(this.batchedRemoteLambdaManager=new Co(function(k,S,C){var T=S.context,x=T.remoteLambda,A=T.lambdaContext;l.executeRemoteLambda(l.serviceUrl,{messageType:fn.Input,correlationVector:{id:S.cv},payload:k,payloadSchema:xr(x.inputSchema),clientMetadata:l.clientMetadata},xr(x.remoteInputSchema),xr(x.remoteOutputSchema),{id:S.cv},l.clientMetadata,l.hostCallbacks,A,C)},function(k,S,C){var T,x=C.lambdaContext;l.updateResultCacheForReduceWorkflows("docSessionId",(T=x.docSessionId)!==null&&T!==void 0?T:x.docId,k,S)}));var c=t.batchOptions,d=this.normalizeBatchOptions(c),h=d.groupingKeyExtractor;d.groupingKeyExtractor=function(k){return t.name+"-"+h(k)};var p={name:t.name,remoteLambda:t,lambdaContext:a};this.batchedRemoteLambdaManager.addBatchItem(e.payload,d,p,e.correlationVector.id.length>127?e.correlationVector.id.substring(0,127)+"!":e.correlationVector.id,void 0,f)}}else Vn(e,{exceptionType:ye.LambdaThrow,message:"No URL for remote lambda"}),this.logOperation(r,!1,"Error",Or(e)),u(e)}},{key:"createLambdaExecutionStep",value:function(e,r,t,a,s){var u=this;return function(l){var f=new D({cv:l.correlationVector.toString(),operationName:"ExecuteLambda",resourceId:r.name,dimension0:e});f.start(),r.source===Q.Custom?u.executeCustomLambdaStep(l,f,r,t,a,s):r.source===Q.Local?u.executeLocalLambdaStep(l,f,r,a,s):r.source===Q.Remote||r.source===Q.BatchedRemote?u.executeRemoteLambdaStep(l,f,r,t,a,s):(Vn(l,{exceptionType:ye.LambdaThrow,message:"Unknown/No lambda location set"}),u.logOperation(f,!1,"Error",Or(l)),s(l))}}},{key:"normalizeBatchOptions",value:function(e){if(!e)throw new Error("Expected batchConfig");var r=Object.assign({},e);return e.estimateSize||(r.estimateSize=Wa),r}}]),n}(),Le=new LA;g();var _S=w(W()),AS=w(B());g();g();var mS=w(W()),vS=w(B()),yS=w(qe()),kS=w(Ge()),td=w(De()),wS=w(Jn());g();var fS=w(W()),cS=w(B()),dS=w(Dr()),pS=w(qe()),hS=w(Ge()),ed=w(De());function FA(n){var o=qA();return function(){var r=(0,ed.default)(n),t;if(o){var a=(0,ed.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,hS.default)(this,t)}}function qA(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var gS=function(n){(0,pS.default)(e,n);var o=FA(e);function e(r){var t;return(0,fS.default)(this,e),t=o.call(this,"s"),t.session=r,t.setEgress(t.egressToSession.bind((0,dS.default)(t))),t}return(0,cS.default)(e,[{key:"egressToSession",value:function(t,a){var s=this;if(m.getTypeNameFor(t)===nn.getTypeName()){var u=t.annotationType,l=t.config;this.session.activateAnnotation(u,{config:l,callback:function(d){s.ingress(new wt({annotationType:u,ops:[d]}),function(){})}}).then(function(){s.ingress(new Be({messageId:t.messageId}),function(){}),a()}).catch(function(c){a(c)})}else if(m.getTypeNameFor(t)===Xe.getTypeName())this.session.close(),a();else if(m.getTypeNameFor(t)===Ue.getTypeName()){var f=t;f.seq===0?this.session.submitSeedOperations(f.ops):this.session.submitOperations(f.ops),this.ingress(new Be({messageId:t.messageId}),function(){}),a()}}}]),e}(Ao);function GA(n){var o=UA();return function(){var r=(0,td.default)(n),t;if(o){var a=(0,td.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,kS.default)(this,t)}}function UA(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var nd=function(n){(0,yS.default)(e,n);var o=GA(e);function e(r,t,a){var s;return(0,mS.default)(this,e),s=o.call(this),s.messageCallbacksByMessageType=new Map,s.messageIdPrefix="c",s.nextMessageId=1,s.upstreamMessageEndpoint=new Ao(s.messageIdPrefix),s.sessionInitializer=r,s.tokenRefreshManager=t,s.serverSessionFactory=a,s}return(0,vS.default)(e,[{key:"init",value:function(t,a,s){var u=this;return this.serverSessionFactory().then(function(l){u.upstreamMessageEndpoint.setEgress(function(h,p){var k=function(T){p(T?new Error(T.error):void 0)},S=u.messageCallbacksByMessageType.get(m.getTypeNameFor(h));S?S(h,function(C,T){T?(T.messageId=h.messageId,u.upstreamMessageEndpoint.ingress(T,k)):k(C)}):s&&s(h,p)});var f=new Qf,c=new Mm(function(){return new fm(f)}),d=new gp({log:function(){}});u.downstreamMessageEndpoint=new gS(l),u.session=new Ok("FakeSessionKey"+e.nextSessionKey++,{upstreamMessageEndpoint:u.upstreamMessageEndpoint,downstreamMessageEndpoint:u.downstreamMessageEndpoint,cache:c},d),u.sessionInitializer.on("connect",function(h,p,k,S,C,T){u.emit("connect",h,k,S,C,T)}),u.sessionInitializer.initSession({isTokenRefresh:!1,onResponse:function(p,k){s&&(p||k)&&s(p||k,function(){})}})})}},{key:"sendMessage",value:function(t,a,s){m.getTypeNameFor(t)?(t.messageId||(t.messageId=""+this.messageIdPrefix+this.nextMessageId++),this.upstreamMessageEndpoint.ingress(t,a||function(){})):a&&a(new X({messageId:t.messageId,error:"Dropped invalid message"}))}},{key:"sendBytes",value:function(t){throw new Error("NYI")}},{key:"onMessage",value:function(t,a){if(this.messageCallbacksByMessageType.has(t))throw new Error("Cannot register another "+t+" callback");this.messageCallbacksByMessageType.set(t,a)}},{key:"getCorrelationVector",value:function(){return new We}},{key:"forceReconnect",value:function(t){throw new Error("NYI")}},{key:"closeSession",value:function(){this.session&&this.session.onClose(yr.MastermindShutdown,new Xe,function(){}),this.tokenRefreshManager.clearAllTimeouts()}}]),e}(wS.EventEmitter);nd.nextSessionKey=0;g();var SS=w(W()),CS=w(B());var xS=function(){function n(o,e){(0,SS.default)(this,n),this.sessionManager=o,this.egress=e,this.workflowRequestCallbackMap=new Map,this.sessionManager.onMessage(Jr.getTypeName(),this.onWorkflowExecutionRequest.bind(this))}return(0,CS.default)(n,[{key:"setWorkflowRequestCallback",value:function(e,r){if(this.workflowRequestCallbackMap.has(e.id))throw new Error("Duplicate workflow "+e.id+" registered");this.workflowRequestCallbackMap.set(e.id,r)}},{key:"onAnnotationResult",value:function(e,r){return this.sendMessageAsync(e)}},{key:"onChatStoreMessagesSet",value:function(e,r){return this.sendMessageAsync(e)}},{key:"onChatStoreMessagesGet",value:function(e,r){return this.sendMessageAsync(e)}},{key:"onMessage",value:function(e,r){return this.sendMessageAsync(e)}},{key:"onWorkflowModelRequest",value:function(e,r){return this.sendMessageAsync(e)}},{key:"onWorkflowExecutionRequest",value:function(e,r){var t=this.workflowRequestCallbackMap.get(e.workflowId);if(!t){if(this.egress){this.egress(e,function(u){u?r(new X({messageId:e.messageId,error:u.message})):r()});return}throw new Error("Cannot execute unknown workflow "+e.workflowId)}var a,s;t(e).then(function(u){s=u}).catch(function(u){a=new X({messageId:e.messageId,error:u.stack})}).then(function(){r(a,s)})}},{key:"sendMessageAsync",value:function(e){var r=this;return new Promise(function(t,a){r.sessionManager.sendMessage(e,function(s,u){s?a(s.error?new Error(s.error):s):t(u)})})}}]),n}();var TS=function(o){var e=new Ws(void 0,function(r,t,a){if(a&&!a.enableComplexLocalWorkflows)return o&&o.networkMode===Pe.LocalWorkflowsOnly?new sa:void 0;var s=new Sr,u=new nd(new Rs(function(){return new Es},r,s,function(l,f){u.sendMessage(l,f)}),s,function(){return e.createSession({docSessionId:r.docSessionId+"-Server",serviceUrl:t})});return u},function(r){return r.localWorkflowManager||(r.workflowRuntimeFactory=function(t){var a=function(){return{}};return new Gv(new xS(t,r.egress),new Map,new Map,a)}),new Ms(r)});return e};var nr;(function(n){n.InitMessageAlreadyReceived="InitMessageAlreadyReceived",n.UnknownBridgeId="UnknownBridgeId",n.UnknownDocSessionId="UnknownDocSessionId",n.InitNotStarted="InitNotStarted"})(nr||(nr={}));var IS=function(o){return new Error("Runtime"+o)},rd=function(o){return new Error("Session"+o)},bS=function(){function n(){(0,_S.default)(this,n),this.optionsByBridgeId=new Map,this.runtimesByBridgeId=new Map,this.sessionsByBridgeIdAndDocSessionId=new Map}return(0,AS.default)(n,[{key:"initBridge",value:function(e){if(this.optionsByBridgeId.has(e.bridgeId))throw new Error("Bridge "+e.bridgeId+" already exists");this.optionsByBridgeId.set(e.bridgeId,e)}},{key:"closeBridge",value:function(e){if(!this.optionsByBridgeId.delete(e))throw new Error("Bridge "+e+" does not exist");this.runtimesByBridgeId.delete(e),this.sessionsByBridgeIdAndDocSessionId.delete(e)}},{key:"ingress",value:function(e,r,t){var a=this,s;try{typeof t=="string"?s=JSON.parse(t):s=on.deserialize(t)}catch(u){this.egressResponse(e,void 0,new X({error:"FailedBridgeMessageParse: "+(u==null?void 0:u.message)}),r);return}Wi.typeGuard(s)?this.onRuntimeInitMessage(e,r,s):this.afterRuntimeInit(e,function(u){if(u){a.egressResponse(e,s.messageId,new X({error:u.message}),r);return}dt.typeGuard(s)?a.onSessionInitMessage(e,r,s):r&&a.onSessionIngress(e,r,s)})}},{key:"afterRuntimeInit",value:function(e,r){var t=this.runtimesByBridgeId.get(e);if(!t){r(IS(nr.UnknownBridgeId));return}if(!t.runtimeInitPromise){r(IS(nr.InitNotStarted));return}if(t.runtimeInitialized){r(void 0,t.runtime);return}var a;t.runtimeInitPromise.catch(function(s){a=s}).then(function(){r(a,t.runtime)})}},{key:"afterSessionInit",value:function(e,r,t){var a=this.sessionsByBridgeIdAndDocSessionId.get(e);if(!a){t(rd(nr.UnknownBridgeId));return}var s=a.get(r);if(!s){t(rd(nr.UnknownDocSessionId));return}if(!s.sessionInitPromise){t(rd(nr.InitNotStarted));return}if(s.sessionInitialized){t(void 0,s.session);return}var u;s.sessionInitPromise.catch(function(l){u=l}).then(function(){t(u,s.session)})}},{key:"onRuntimeInitMessage",value:function(e,r,t){var a=this,s=this.runtimesByBridgeId.get(e);if(s){this.egressResponse(e,t.messageId,new X({error:"Runtime"+nr.InitMessageAlreadyReceived}),r);return}s={runtimeInitialized:!1},this.runtimesByBridgeId.set(e,s),s.runtime=TS(t.runtimeInitOptions),s.runtimeInitPromise=s.runtime.init("https://augloop-int.officeppe.com",{appName:"Testing",appPlatform:"Client"},{requestAuthToken:function(){return Promise.reject()},sendTelemetryEvent:function(l,f,c,d,h,p,k,S){a.egress(e,JSON.stringify(new Bi({tenant:l,event:f,dataJson:JSON.stringify(c),contract:d,contractDataJson:JSON.stringify(h),critical:p,dataCategories:k,diagnosticLevel:S})),r)},isFeatureEnabled:function(l,f){return t.runtimeInitOptions.featureEnabled.indexOf(l)!==-1?Promise.resolve(!0):Promise.resolve(!1)},areLicenseFeaturesEnabled:function(){return Promise.resolve(!1)}},{telemetryAggregationIntervalSec:t.telemetryAggregationIntervalSec}).then(function(){s.runtimeInitialized=!0;var u=a.optionsByBridgeId.get(e);return u&&u.onRuntimeInit&&u.onRuntimeInit(s.runtime,{bridgeId:e,bridgeMessage:t}),new Be({})}).catch(function(u){return a.runtimesByBridgeId.delete(e),new X({error:u==null?void 0:u.message})}).then(function(u){a.egressResponse(e,t.messageId,u,r)})}},{key:"onSessionInitMessage",value:function(e,r,t){var a=this,s;if(!r||((s=t.clientMetadata)===null||s===void 0?void 0:s.docSessionId)!==r){this.egressResponse(e,t.messageId,new X({error:"InvalidDocSessionId"}),r);return}this.afterRuntimeInit(e,function(u,l){if(u){a.egressResponse(e,t.messageId,new X({error:u.message}),r);return}var f=a.sessionsByBridgeIdAndDocSessionId.get(e);f||(f=new Map,a.sessionsByBridgeIdAndDocSessionId.set(e,f));var c=f.get(r);if(c){a.egressResponse(e,t.messageId,new X({error:"Session"+nr.InitMessageAlreadyReceived}),r);return}c={sessionInitialized:!1},f.set(r,c),c.sessionInitPromise=l.createSession({docSessionId:r,extensionConfigs:t.extensionConfigs,serviceUrl:t.serviceUrl,enableComplexLocalWorkflows:!0,egress:function(h,p){dr.typeGuard(h)?a.egressResponse(e,t.messageId,new dr(h),r):a.egress(e,JSON.stringify(h),r),p(void 0)}}).then(function(d){c.session=d,c.sessionInitialized=!0;var h=a.optionsByBridgeId.get(e);h&&h.onSessionInit&&h.onSessionInit(c.session,{bridgeId:e,docSessionId:r,bridgeMessage:t})}).catch(function(d){f.delete(r),a.egressResponse(e,t.messageId,new X({error:d==null?void 0:d.message}),r)})})}},{key:"onSessionIngress",value:function(e,r,t){var a=this;this.afterSessionInit(e,r,function(s,u){if(s){a.egressResponse(e,t.messageId,new X({error:s.message}),r);return}u.sendMessageToSession(t,function(l,f){(l||f)&&a.egressResponse(e,t.messageId,l||f,r)})})}},{key:"egressResponse",value:function(e,r,t,a){r!==void 0&&(t.messageId=r),this.egress(e,JSON.stringify(t),a)}},{key:"egress",value:function(e,r,t){var a=this.optionsByBridgeId.get(e);a&&a.egress(r,t)}}]),n}();g();var Gs=w(mn());g();var qo=function(o){return{primary:o.tile.metadata.docSessionId,secondary:o.tile.metadata.tileId}},MS=function(o){var e=JSON.parse(o.content.toString()).slides[0],r=JSON.stringify(e.mk);return{primary:o.docId,secondary:r}};g();var HA=3,zA=10,ES=function(o){var e=new Map,r=!1,t=new Map;if(o&&Array.isArray(o.values)){var a=0;for(var s of o.values)if(s&&Array.isArray(s.acronyms)){a+=s.acronyms.length;var u=function(h){if(h.annotationId!==void 0&&h.annotationId.indexOf("=")>=0){var p=h.annotationId.substring(0,h.annotationId.indexOf("=")),k=e.get(p);e.set(p,k===void 0?1:k+1);var S;if(Array.isArray(s.annotations)){var C=s.annotations,T=C.filter(function(E){return E.annotationId===h.annotationId});T.length===1&&T[0]&&T[0].tileInfo&&T[0].tileInfo.tileId&&(S=T[0].tileInfo.tileId)}if(!t.has(p)){var x={paragraphId:S,acronym:p,expansions:[],sourceTransactionId:s.transactionId};t.set(p,x)}var A=t.get(p).expansions;if(A.every(function(E){return E.name!==h.name})){var b={name:h.name,description:h.description,sourceType:h.sourceType,sourceEmail:h.sourceEmail,sourceFile:h.sourceFile,sourceAdmin:h.sourceAdmin,score:h.score,instrumentationId:h.instrumentationId,sourceTransactionIds:[s.transactionId]};A.push(b)}}};for(var l of s.acronyms)u(l);(a>=zA||e.size>=HA)&&(r=!0)}}var f=[];t.forEach(function(d,h){f.push(d)});var c={acronymsThresholdHit:r,paragraphAcronyms:t.size===0?[]:f};return c};g();g();var RS=function(o){return o?o===o.toUpperCase():!1},NS=function(o,e){if(!o)return o;for(var r=0,t=o.length-1;e.indexOf(o[r])!==-1&&r<t;)r++;for(;e.indexOf(o[t])!==-1&&t>=r;)t--;return o.substring(r,t+1)};var VA=/(\b[0-9A-Z][A-Z/\.]*([a-z/]){0,3}[A-Z0-9/\.]*[-– §#\s&\+]?[A-Z0-9/\.]*[-– §#\s&\+]?[A-Z0-9/\.]*([a-z/]){0,50}[A-Z0-9\./]*([a-z/]){0,50}[\.]?s?([\+]|([\.])|\b))/,QA=/(\b(([A-Z]([a-z/]){0,50})|([0-9])*)[\.]?s?([\+]|([\.])|\b))/,jA=20,JA=function(o){if(!o)return!1;o=NS(o,[" ","\xA0","."]);var e=VA.exec(o),r=e&&e.length>0?e[0].trim():"",t=QA.exec(o),a=t&&t.length>0?t[0].trim():"";return r===o&&r.length>1&&r.length<=jA&&a!==o},KA=function(o){if(!o)return[];var e=o.trim().split(/[\s,?!'"]/g);return e.length>1&&RS(o)?[]:e.filter(function(r){return r&&JA(r)})},DS=function(o,e,r){if(!o||!o.tile||!o.tile.metadata||o.type===Fn.TextTileEventType.Delete)return null;var t=o.tile.elements;if(!Array.isArray(t)||t.length===0)return null;var a=KA(t.map(function(l){return l.text}).join(" "));if(!a.length)return null;if(e&&e.lookupTable&&e.lookupTable.acronymsMap&&r){var s=e.lookupTable,u=s.acronymsMap;if(a.every(function(l){return!$A(l,u)}))return null}return{documentId:o.tile.metadata.docId,documentSessionId:o.tile.metadata.docSessionId,tiles:[o.tile]}},$A=function(o,e){return e[o]!==void 0};g();var BS=w(mn());g();var XA=function(o){return Array.isArray(o)?o.reverse().reduce(function(e,r){return e*2+(r?1:0)},0):0},fa=function(o,e,r){for(var t=[],a=0;a<e;a++)t.push(o.IsFeatureEnabled(r+(""+a),"None").then(function(s){return s}).catch(function(){return!1}));return Promise.all(t).then(function(s){return XA(s)})};g();var qs=function(o){return o.type===Fn.TextTileEventType.Delete||o.tile.elements===void 0||o.tile.elements===null||o.tile.elements.length===0||o.tile.elements[0].text===void 0||o.tile.elements[0].text===null||o.tile.elements[0].text.length===0?null:o},YA=function(o){var e={};for(var r of Object.keys(o))if(r==="type"){var t=o[r].toString();t==="shape"?e[r]=Ln.DrawingElementType.shape:t==="groupShape"?e[r]=Ln.DrawingElementType.groupShape:t==="graphicFrame"?e[r]=Ln.DrawingElementType.graphicFrame:t==="connector"?e[r]=Ln.DrawingElementType.connector:t==="picture"?e[r]=Ln.DrawingElementType.picture:t==="ink"&&(e[r]=Ln.DrawingElementType.ink)}else e[r]=o[r];return e},ZA=function(o){var e=[];return o.forEach(function(r){var t={};for(var a of Object.keys(r))a==="mk"?t[a]=YA(r[a]):t[a]=r[a];e.push(t)}),e},eb=function(o){for(var e=o,r=0;r<e.length;r++)for(var t of Object.keys(o[r]))t==="drawingElems"&&(e[r][t]=ZA(e[r][t]));return e},tb=function(o){var e={},r=JSON.parse(o.toString());for(var t of Object.keys(r))t==="slides"&&(e[t]=eb(r[t]));return e},WS=function(o){var e={};for(var r of Object.keys(o))r==="content"?e[r]=tb(o[r]):e[r]=o[r];return e},od=function(o,e){if(e===null)throw new Error(o+" must be defined and non null")};g();var ca=function(){return[{Provider:On.ADAL,ResourceId:"https://nleditor.osi.office.net/NlEditor",AuthorityUrl:"https://login.microsoftonline.com/common/oauth2/authorize"}]};var nb="Acronyms.Request",rb="Acronyms.Response",ob="Acronyms.BatchRequest",ib="Acronyms.BatchResponse",ab=function(o){try{return o.tiles[0].elements[0].text.length}catch(e){throw new Error("invalid estimateSize input "+e)}},sb=function(o){return od("request",o),o.documentId},ub=function(o){return od("acronymsBatchResponse",o),o.responses},lb=function(o){var e={requests:o};return{input:e,demultiplex:ub}},PS=function(){var n=(0,BS.default)(function*(o,e){var r=yield fa(o,7,"Microsoft.Office.Augloop.AcronymsBatchingInterval"),t=yield fa(o,7,"Microsoft.Office.Augloop.AcronymsBatchingSizeInKB"),a=r===0?1:r,s=t===0?20:t;return{name:"AcronymsLambdaRemoteBatched",source:Q.BatchedRemote,inputSchema:nb,outputSchema:rb,remoteInputSchema:ob,remoteOutputSchema:ib,authTickets:e?ca():void 0,batchOptions:{delayMs:a*1e3,maxInputSize:s*1024,estimateSize:ab,groupingKeyExtractor:sb,multiplex:lb}}});return function(e,r){return n.apply(this,arguments)}}();var LS=898989898,id="Tiling.TextTileEvent",OS="Acronyms.Request",FS="Acronyms.Response",fb="Acronyms.CountReduceOutput",ad=function(){var n=(0,Gs.default)(function*(o,e){var r=yield e.IsFeatureEnabled("Microsoft.Office.Augloop.ShouldAcronymsUseLookupTable","None"),t={name:"AcronymsLambdaBefore",source:Q.Custom,inputSchema:id,outputSchema:OS,func:function(k,S,C,T){var x=DS(k,C,r);T(x)}},a=yield e.IsFeatureEnabled("Microsoft.Office.AugLoop.RemoteLambdaAuthTickets","Production"),s=yield e.IsFeatureEnabled("Microsoft.Office.AugLoop.AcronymsLocalLambda","None"),u=yield cb(e,a,s),l=yield e.IsFeatureEnabled("Microsoft.Office.AugLoop.AcronymsWordBatchedWorkflow","None");if(l){var f=yield PS(e,a),c=[],d={name:"AcronymsLocalLambda",inputSchema:id,outputSchema:id,source:Q.Local};return s&&c.push(d),c.push(t),c.push(f),o.registerMultipleLambdasWorkflow("AcronymsWorkflow",c,u)}else{var h={name:"AcronymsLambdaRemote",source:Q.Remote,inputSchema:OS,outputSchema:FS,authTickets:a?ca():void 0};return o.registerSimpleRemoteWorkflow("AcronymsWorkflow",t,h,null,u)}});return function(e,r){return n.apply(this,arguments)}}(),cb=function(){var n=(0,Gs.default)(function*(o,e,r){var t=yield db(o,e),a=yield fa(o,7,"Microsoft.Office.Augloop.AcronymsThrottlingInterval");return{canProduceNullResult:!0,shouldSendResultsToHost:!0,enabledByDefault:!1,throttleSettings:{shouldBeThrottled:!0,throttlingInterval:a*1e3},licenseFeatures:[LS],lookupTableLambda:t,triggerOnRefresh:r}});return function(e,r,t){return n.apply(this,arguments)}}(),db=function(){var n=(0,Gs.default)(function*(o,e){var r=yield o.IsFeatureEnabled("Microsoft.Office.Augloop.AcronymsLookupTable","None");if(r)return{name:"AcronymsLambdaLookup",source:Q.Remote,inputSchema:"Acronyms.LookupRequest",outputSchema:"Acronyms.LookupResponse",authTickets:e?ca():void 0}});return function(e,r){return n.apply(this,arguments)}}(),sd=function(o){var e={name:"AcronymsReduceLambda",source:Q.Custom,inputSchema:FS,outputSchema:fb,func:function(a,s,u,l){l(ES(a))}},r={canProduceNullResult:!1,shouldSendResultsToHost:!0,enabledByDefault:!1,throttleSettings:{shouldBeThrottled:!1},licenseFeatures:[LS]};return o.registerReduceWorkflow("AcronymsReduceWorkflow",e,qo,10,r)};g();var pb="Tiling.TextTileEvent",qS="SavePrompt.Request",GS="SavePrompt.Response",hb="SavePrompt.ReduceCountSignal",gb=300,mb=function(o){if(!o||!o.tile||!o.tile.metadata)return null;var e=o.tile.elements;return!Array.isArray(e)||e.length===0?null:{documentId:o.tile.metadata.docId,documentSessionId:o.tile.metadata.docSessionId,tiles:[o.tile]}};function vb(n){return n=n.replace(/(^\s*)|(\s*$)/gi,""),n===""?0:n.split(/\r\n|\r|\n/).length}function yb(n){return n=n.replace(/(^\s*)|(\s*$)/gi,""),n=n.replace(/[ ]{2,}/gi," "),n=n.replace(/\n /gi,`
`),n=n.replace(/\r /gi,"\r"),n=n.replace(/\r\n /gi,`\r
`),n=n.replace(/\r\n|\r|\n/gi," "),n.split(" ").filter(function(o){return o!==""}).length}var kb=function(o){if(o===null)throw new Error("savepromptRequest must be defined and non null");var e=o.tiles;if(!(!e||e.length<1)){if(e.length>1)throw new Error("There are more than 1 tiles in input. Expecting max 1 tile");var r="",t=`
`;for(var a of e[0].elements)a.text&&(r+=r?t+a.text:a.text);var s=vb(r),u=yb(r),l=r.length;return{rowCount:s,wordCount:u,charCount:l,documentId:o.documentId}}},ud=function(o){var e={name:"SavePromptLambdaBefore",source:Q.Custom,inputSchema:pb,outputSchema:qS,func:function(s,u,l,f){var c=mb(s);f(c)}},r={name:"SavePromptLambdaNew",source:Q.Custom,inputSchema:qS,outputSchema:GS,func:function(s,u,l,f){var c=kb(s);f(c)}},t={canProduceNullResult:!1,shouldSendResultsToHost:!0,enabledByDefault:!1,throttleSettings:{shouldBeThrottled:!0,throttlingInterval:7e3},licenseFeatures:[]};return o.registerSimpleRemoteWorkflow("SavePromptWorkflow",e,r,null,t)},wb=function(o){var e=!1,r=0,t=0,a=0;if(o&&Array.isArray(o.values)){for(var s of o.values)s&&(r+=s.rowCount,t+=s.wordCount,a+=s.charCount);e=a>=gb}var u={thresholdHit:e,rowCount:r,wordCount:t,charCount:a};return u},ld=function(o){var e={name:"SavePromptReduceLambda",source:Q.Custom,inputSchema:GS,outputSchema:hb,func:function(a,s,u,l){l(wb(a))}},r={canProduceNullResult:!1,shouldSendResultsToHost:!0,enabledByDefault:!1,throttleSettings:{shouldBeThrottled:!1},licenseFeatures:[]};return o.registerReduceWorkflow("SavePromptReduceWorkflow",e,qo,10,r)};g();var zS=w(W()),VS=w(B());g();var Bt=function(n){return n[n.dev=0]="dev",n[n.int=1]="int",n[n.test=2]="test",n[n.dogfood=3]="dogfood",n[n.prod=4]="prod",n[n.gcc=5]="gcc",n[n.dod=6]="dod",n[n.gccHigh=7]="gccHigh",n}({}),US=function(o){return o?o.indexOf("augloop.office.com")>=0?Bt.prod:o.indexOf("augloop-gcc.office.com")>=0?Bt.gcc:o.indexOf("augloop.gov.online.office365.us")>=0?Bt.gccHigh:o.indexOf("augloop.dod.online.office365.us")>=0?Bt.dod:o.indexOf("localhost:20080")>=0?Bt.dev:o.indexOf("augloop-dogfood.officeppe.com")>=0?Bt.dogfood:o.indexOf("augloop-int.officeppe.com")>=0?Bt.int:-1:-1};g();var ee={documents:new Map,officeUILanguage:"",serviceUrl:"",docSessionIdToDocIdMap:new Map,docIdToDocSessionIdMap:new Map,classificationResponse:"Classification.Response",classificationBatchedResponse:"Classification.BatchResponse",classificationReduce:"Classification.Reduce",classificationReduceResponse:"Labelling.Response",labellingEditorUIResponse:"Labelling.EditorUIResponse",autoClpLicenseFeatures:[76080228,31135922],defaultBatchIntervalSeconds:3,defaultBatchSizeKB:20,defaultThrottlingIntervalSeconds:3,maxReduceDelayUntilIdleSeconds:5};var Sb=function(o,e){var r=null,t=ee.documents.get(o);t.getCurrentCritiques()?r=t.getCurrentCritiques():r=new Set,r.add(e),t.setCurrentCritiques(r)},Us=function(o){var e=ee.documents.get(o);return e.setLabellingRequestSequence(e.getLabellingRequestSequence()+1),e.getLabellingRequestSequence()},da=function(o){var e={docSessionID:o,recommendedLabel:{responsiblePolicy:{},sensitivityLabel:{},locale:ee.officeUILanguage,critiques:[],deleteCritiques:[]},automaticApplyLabel:{responsiblePolicy:{},sensitivityLabel:{},locale:ee.officeUILanguage,critiques:[],deleteCritiques:[]}};return e},HS=function(o,e,r){var t=ee.documents.get(r);if(t.getPreviousCacheSensitiveItems())t.getPreviousCacheSensitiveItems().set(e,o);else{var a=new Map;a.set(e,o),t.setPreviousCacheSensitiveItems(a)}},QS=function(o){var e=new Map;o.values.forEach(function(a){a&&Array.isArray(a.sensitiveItems)&&a.sensitiveItems.forEach(function(s){s.id!==void 0&&s.uniqueCount!==void 0&&s.matches!==void 0&&(e.has(s.id)?e.set(s.id,e.get(s.id)+s.uniqueCount+s.matches.length):e.set(s.id,s.uniqueCount+s.matches.length))})});var r=ee.documents.get(o.id),t=r.getPreviousCacheSensitiveItems().size!==e.size;return t?(r.getPreviousCacheSensitiveItems().clear(),e.forEach(function(a,s){HS(a,s,o.id)}),t):(r.getPreviousCacheSensitiveItems().forEach(function(a,s){a!==e.get(s)&&(t=!0)}),t&&(r.getPreviousCacheSensitiveItems().clear(),e.forEach(function(a,s){HS(a,s,o.id)}),t))},Cb=function(o){var e=ee.documents.get(o.docSessionID);e.getCurrentCritiques()&&e.getCurrentCritiques().clear(),e.setPreviousEditorUIResponse(o)},xb=function(o){var e=[],r=ee.documents.get(o),t=r.getPreviousEditorUIResponse(),a=r.getCurrentCritiques();return t!=null&&t.recommendedLabel.critiques.forEach(function(s){a.has(s.inputTileMetadata.classificationCritiqueID)||e.push(s.inputTileMetadata.classificationCritiqueID)}),e},Tb=function(o,e,r){var t={};return t.categoryID=e.id,t.categoryTitle=e.name,t.explanationTitle=e.name,t.explanationDescription=e.description+" "+e.publisherName,t.inputTileMetadata=o.inputTileMetadata,t.length=o.length,t.offset=o.offset,t.text=o.idMatch,t.context="",t.scope=e.scope,Sb(r,t.inputTileMetadata.classificationCritiqueID),t},Ib=function(o,e){var r=[];return o.forEach(function(t){t.matches.forEach(function(a){var s=Tb(a,t,e);s!==null&&r.push(s)})}),r},jS=function(o){var e=da(o.documentMetadata.docSessionID);return o.recommended.sensitivityLabel!==void 0&&o.recommended.sensitivityLabel!==null&&(e.recommendedLabel.responsiblePolicy=o.recommended.responsiblePolicy,e.recommendedLabel.sensitivityLabel=o.recommended.sensitivityLabel),e.recommendedLabel.critiques=Ib(o.recommended.sensitiveItems,o.documentMetadata.docSessionID),e.recommendedLabel.deleteCritiques=xb(o.documentMetadata.docSessionID),o.automatic.sensitivityLabel!==void 0&&(e.automaticApplyLabel.responsiblePolicy=o.automatic.responsiblePolicy,e.automaticApplyLabel.sensitivityLabel=o.automatic.sensitivityLabel),Cb(e),e},JS=function(o){if(typeof o=="string"){var e=o;return ee.docIdToDocSessionIdMap.has(o)&&(e=ee.docIdToDocSessionIdMap.get(o)),{primary:e}}o=o;var r=o.tile.metadata.docSessionId,t=o.tile.metadata.docId;return ee.docSessionIdToDocIdMap.set(r,t),ee.docIdToDocSessionIdMap.set(t,r),qo(o)},Hs=function(o){var e=0;for(var r of o.values){var t=r;t&&t.sensitiveItems&&t.sensitiveItems.length>=0&&(e+=t.sensitiveItems.length)}return e},KS=function(o){var e=qs(o);return e&&e.tile.elements[0].text.length<=4&&e.tile.elements[0].text.search(/^([\s\x00-\x1F\x7F]*)$/)===0&&(e=null),e},zs=function(){function n(o){(0,zS.default)(this,n),this.previousEditorUIResponse=null,this.currentCritiques=null,this.labellingRequestSequence=o,this.previousCacheSensitiveItems=new Map}return(0,VS.default)(n,[{key:"setPreviousEditorUIResponse",value:function(e){this.previousEditorUIResponse=e}},{key:"setCurrentCritiques",value:function(e){this.currentCritiques=e}},{key:"setLabellingRequestSequence",value:function(e){this.labellingRequestSequence=e}},{key:"setPreviousCacheSensitiveItems",value:function(e){this.previousCacheSensitiveItems=e}},{key:"getPreviousEditorUIResponse",value:function(){return this.previousEditorUIResponse}},{key:"getCurrentCritiques",value:function(){return this.currentCritiques}},{key:"getLabellingRequestSequence",value:function(){return this.labellingRequestSequence}},{key:"getPreviousCacheSensitiveItems",value:function(){return this.previousCacheSensitiveItems}}]),n}();var pa=function(){var o=[];switch(US(ee.serviceUrl)){case Bt.dev:case Bt.int:case Bt.dogfood:case Bt.prod:o.push({Provider:On.ADAL,ResourceId:"https://graph.microsoft.com",AuthorityUrl:"https://login.microsoftonline.com/common/oauth2/authorize"});break;case Bt.gcc:o.push({Provider:On.ADAL,ResourceId:"https://graph.microsoft.com",AuthorityUrl:"https://login.windows.net/common/oauth2/authorize"});break;case Bt.gccHigh:o.push({Provider:On.ADAL,ResourceId:"https://graph.microsoft.us",AuthorityUrl:"https://login.microsoftonline.us/common/oauth2/authorize"});break;case Bt.dod:o.push({Provider:On.ADAL,ResourceId:"https://dod-graph.microsoft.us",AuthorityUrl:"https://login.microsoftonline.us/common/oauth2/authorize"});break;default:break}return o},Vs=function(o){o.authTickets=pa()},$S=function(o){return o==="Win32"},Qs=function(){return new Promise(function(o,e){o(ee.defaultThrottlingIntervalSeconds)})},js=function(){return new Promise(function(o,e){o(ee.defaultBatchSizeKB)})},Js=function(){return new Promise(function(o,e){o(ee.defaultThrottlingIntervalSeconds)})};g();var rC=w(Ye()),oC=w(mn());g();g();var Go={name:"ClassificationReduceLambda",source:Q.Remote,inputSchema:ee.classificationReduce,outputSchema:ee.classificationReduceResponse,canRunInPrivateMode:!0},Ks={name:"ClassificationReduceLambdaUpdatePreviousResponse",source:Q.Custom,inputSchema:ee.classificationReduceResponse,outputSchema:ee.labellingEditorUIResponse,func:function(o,e,r,t){o.requestSequence===ee.documents.get(o.documentMetadata.docSessionID).getLabellingRequestSequence()?t(jS(o)):t(null)}};var fd="Tiling.TextTileEvent",_b="Tiling.BatchTextTileEvent",YS=function(o,e){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,t=arguments.length>3&&arguments[3]!==void 0?arguments[3]:0,a={name:"ClassificationReduceLambdaBefore",source:Q.Custom,inputSchema:ee.classificationResponse,outputSchema:ee.classificationReduce,func:function(l,f,c,d,h){if(ee.documents.has(l.id)||ee.documents.set(l.id,new zs(0)),Hs(l)===0){var p=da(l.id);h(p,ee.labellingEditorUIResponse)}else{var k=l.values.filter(function(C){return C!==null}),S={id:l.id,classficationResponses:k,suppressSensitiveItems:[],officeUILanguage:ee.officeUILanguage,requestSequence:Us(l.id)};d(S)}}},s={canProduceNullResult:!0,shouldSendResultsToHost:!0,enabledByDefault:!0,licenseFeatures:ee.autoClpLicenseFeatures,triggerOnRefresh:r,deferReduceUntilIdle:t>0,deferReduceUntilIdleMaxDelayMs:t*1e3,docIdExtractor:function(l){return l?ee.docSessionIdToDocIdMap.get(l.id):void 0}};return e&&Vs(Go),o.registerMultipleLambdasReduceWorkflow("ClassificationReduceWordWorkflow",[a,Go,Ks],JS,null,s)},Ab=function(){return function(o){var e=[void 0,void 0],r=!1,t={sensitiveItems:[]};for(var a of o.responses)for(var s of a.sensitiveItems)s.scope===ai.SensitiveTypeScope.FullDocument&&(r=!0,t.sensitiveItems.push(s));return r?["Classification.Response",t]:e}},bb=function(){return function(o){var e=[];for(var r of o.responses){var t=[];for(var a of r.sensitiveItems)a.scope===ai.SensitiveTypeScope.PartialDocument&&t.push(a);e.push({sensitiveItems:t})}return e}},XS=function(o,e){return o>0?o:e},ZS=function(o,e,r,t){var a=[],s={name:"ClassificationLambdaBefore",source:Q.Custom,inputSchema:fd,outputSchema:fd,func:function(c,d,h,p){var k=KS(c);p(k)}};a.push(s),e=XS(e,ee.defaultBatchIntervalSeconds),r=XS(r,ee.defaultBatchSizeKB);var u={name:"ClassificationLambdaRemoteBatched",source:Q.BatchedRemote,inputSchema:fd,outputSchema:ee.classificationResponse,remoteInputSchema:_b,remoteOutputSchema:ee.classificationBatchedResponse,authTickets:t?pa():void 0,batchOptions:{delayMs:e*1e3,maxInputSize:r*1024,estimateSize:function(c){return c.tile.elements[0].text.length},groupingKeyExtractor:function(c){var d;return(d=c.tile.metadata.docSessionId)!=null?d:c.tile.metadata.docId},summaryExtractor:Ab(),multiplex:function(c){var d={textTileEvents:c,refreshEnabled:!0};return{input:d,demultiplex:bb()}}}};a.push(u);var l={canProduceNullResult:!0,shouldSendResultsToHost:!1,enabledByDefault:!0,triggerOnRefresh:!0,throttleSettings:{shouldBeThrottled:!0,throttlingInterval:(e+1)*1e3},licenseFeatures:ee.autoClpLicenseFeatures,useCanaryTextTile:!0,docIdExtractor:function(c){return c&&c.tile&&c.tile.metadata?c.tile.metadata.docId:void 0}};return o.registerMultipleLambdasWorkflow("ClassificationWordBatchedWorkflow",a,l)};g();var Mb="ClpSlideTile",eC="Ppt.SlideTile",tC=function(o,e,r){var t={name:"ClassificationLambdaPptBefore",source:Q.Custom,inputSchema:Mb,outputSchema:eC,func:function(u,l,f,c){c(WS(u))}},a={name:"ClassificationLambdaRemote",source:Q.Remote,inputSchema:eC,outputSchema:ee.classificationResponse,authTickets:r?pa():void 0};return e.then(function(s){var u={canProduceNullResult:!0,shouldSendResultsToHost:!1,enabledByDefault:!0,throttleSettings:{shouldBeThrottled:!0,throttlingInterval:s*1e3},licenseFeatures:ee.autoClpLicenseFeatures,docIdExtractor:function(f){return f?f.docId:void 0}};return o.registerSimpleRemoteWorkflow("ClassificationPptWorkflow",t,a,null,u)})},Eb={name:"ClassificationReduceLambdaBefore",source:Q.Custom,inputSchema:ee.classificationResponse,outputSchema:ee.classificationReduce,func:function(o,e,r,t,a){if(ee.documents.has(o.id)||ee.documents.set(o.id,new zs(0)),Hs(o)===0){var s=da(o.id),u=ee.documents.get(o.id);u.getPreviousCacheSensitiveItems()&&u.getPreviousCacheSensitiveItems().clear(),a(s,ee.labellingEditorUIResponse)}else if(!QS(o))t(null);else{var l=o.values.filter(function(c){return c!==null}),f={id:o.id,classficationResponses:l,suppressSensitiveItems:[],officeUILanguage:ee.officeUILanguage,requestSequence:Us(o.id)};t(f)}}},nC=function(o,e){var r={canProduceNullResult:!0,shouldSendResultsToHost:!0,enabledByDefault:!0,licenseFeatures:ee.autoClpLicenseFeatures,docIdExtractor:function(a){return a?a.id:void 0}};return e&&Vs(Go),o.registerMultipleLambdasReduceWorkflow("ClassificationReducePptWorkflow",[Eb,Go,Ks],MS,null,r)};function $s(n,o,e,r,t,a,s){return cd.apply(this,arguments)}function cd(){return cd=(0,oC.default)(function*(n,o,e,r,t,a,s){ee.officeUILanguage=o.uiLanguage,ee.serviceUrl=e;var u=$S(o.appPlatform),l=o.privateMode!==!1;if((o.appName==="Word"||o.appName==="Outlook")&&(u||o.appPlatform==="Mac")){var f=yield s.IsFeatureEnabled("Microsoft.Office.Security.CLP.FG.AutoCLPV2Transition","Production");if(f)return;var c=yield u||s.IsFeatureEnabled("Microsoft.Office.AugLoop.RemoteLambdaAuthTickets","Production");if(!l){var d=yield Promise.all([t,a]),h=(0,rC.default)(d,2),p=h[0],k=h[1];yield Promise.all([ZS(n,p,k,c),YS(n,c,!0,ee.maxReduceDelayUntilIdleSeconds)])}}if(o.appName==="PowerPoint"&&(u||o.appPlatform==="Mac")){var S=yield s.IsFeatureEnabled("Microsoft.Office.Security.CLP.FG.AutoCLPV2Transition","None");if(S)return;var C=yield u||s.IsFeatureEnabled("Microsoft.Office.AugLoop.RemoteLambdaAuthTickets","Production");l||(yield Promise.all([tC(n,r,C),nC(n,C)]))}}),cd.apply(this,arguments)}g();var Rb="CommandPredict",iC="CommandPredictRequest",Nb="AUXv3Response",Db=function(o){return o||null},aC=function(o){var e={name:"AUXv3PPTLambdaBefore",source:Q.Custom,inputSchema:Rb,outputSchema:iC,func:function(a,s,u,l){var f=Db(a);l(f)}},r={name:"AUXv3PPTLambdaRemote",source:Q.Remote,inputSchema:iC,outputSchema:Nb};return o.registerSimpleRemoteWorkflow("AUXv3PPTWorkflow",e,r,null)};g();var Wb="TopCommandsPerUser",sC="TopCommandsPerUserRequest",Bb="TopCommandsPerUserResponse",Pb=function(o){return o||null},uC=function(o){var e={name:"TopCommandsPerUserPPTLambdaBefore",source:Q.Custom,inputSchema:Wb,outputSchema:sC,func:function(a,s,u,l){var f=Pb(a);l(f)}},r={name:"TopCommandsPerUserPPTLambdaRemote",source:Q.Remote,inputSchema:sC,outputSchema:Bb};return o.registerSimpleRemoteWorkflow("TopCommandsPerUserPPTWorkflow",e,r,null)};g();g();g();var Xs="SlideTile";var lC="TextAnalysis.TextAnalysisRequest",Ob="TextAnalysis.TextAnalysisResponse",Lb=function(o){var e={shapeId:o.mk.id,isPh:!0,texts:[]};return o.textTile&&(e.texts=o.textTile.elements.map(function(r){return{text:r.text,bullet:"-"}})),e},Fb=function(o){return{slideId:o.mk.sId,runNlxAnalysis:!0,shapeInputMetaData:[]}},qb=function(o){if(o.slides.length===0)return null;var e=o.slides[0],r=Fb(e),t={presentationInputMetaData:{slideInputMetaData:[r]},textInputData:{title:"Title",textBoxes:[]}};for(var a of e.drawingElems){var s=Lb(a);s&&(r.shapeInputMetaData.push({shapeId:a.mk.id,runCeousAnalysis:!0,runSmartArtAnalysis:!0}),t.textInputData.textBoxes.push(s))}return t},fC=function(o){var e={name:"ReplaceObjectLambdaBefore",source:Q.Custom,inputSchema:Xs,outputSchema:lC,func:function(a,s,u,l){var f=a,c=JSON.parse(f.content),d=qb(c);l(d)}},r={name:"ReplaceObjectLambdaRemote",source:Q.Remote,inputSchema:lC,outputSchema:Ob};return o.registerSimpleRemoteWorkflow("ReplaceObjectWorkflow",e,r,null)};g();var cC="Proofing.ProofingRequest",Gb="Proofing.ProofingResponse",Ub="827D1907-1E10-4F04-987A-B13FEC819C3C",Hb="818BCDBE-64CE-46E8-A3D7-75A1EA8365A8",zb=function(o,e){if(e.slides.length===0)return null;var r=[];o.appMetadata&&o.appMetadata.overriddenCritiqueTypeOptions&&(r=o.appMetadata.overriddenCritiqueTypeOptions),r.push({id:Hb,languageId:"en-US",value:"0"});var t={documentId:o.docId,languageUxId:o.appMetadata?o.appMetadata.languageUxId:"en-US",descriptors:{isCompliant:o.appMetadata?o.appMetadata.descriptor.isCompliant:!0,licenseType:o.appMetadata?o.appMetadata.descriptor.licenseType:2},tiles:[],requestOrderInSession:o.reqOrd,runOnProfileId:Ub,overriddenCritiqueTypeOptions:r},a=e.slides[0];if(a.drawingElems)for(var s of a.drawingElems){var u=s.textTile;u.metadata={tileId:s.id,revisionId:"revision",tileType:1};for(var l=0,f=u.elements;l<f.length;l++){var c=f[l];c.languageId||(c.languageId="en-US"),c.textUnit=4}t.tiles.push(u)}return t},dC=function(o){var e={name:"ProofingLambdaBefore",source:Q.Custom,inputSchema:Xs,outputSchema:cC,func:function(s,u,l,f){var c=s,d=JSON.parse(c.content),h=zb(c,d);f(h)}},r={name:"ProofingLambdaRemote",source:Q.Remote,inputSchema:cC,outputSchema:Gb},t={canProduceNullResult:!1,shouldSendResultsToHost:!0,enabledByDefault:!0};return o.registerSimpleRemoteWorkflow("ProofingWorkflow",e,r,null,t)};function dd(n){return fC(n).then(function(){return dC(n)})}g();var Vb="Tiling.TextTileEvent",pC="SharingSuggestion.Request",pd="SharingSuggestion.Response",hC={},gC=function(o,e){var r={name:"SharingSuggestionLambdaBefore",source:Q.Custom,inputSchema:Vb,outputSchema:pC,func:function(f,c,d,h){var p={Provider:Ad.ADAL,ResourceId:"https://substrate.office.com",AuthorityUrl:"https://login.microsoftonline.com/common/oauth2/authorize",Target:"https://substrate.office.com",Policy:"MBI_SSL"};hC[f.tile.metadata.docId]?h(null):e.RequestAuthToken({Tickets:[p]}).then(function(k){h({tiles:[f.tile],tokens:[{token:k.Token,ticket:p}]})}).catch(function(){h(null)})}},t={name:"SharingSuggestionLambdaRemote",source:Q.Remote,inputSchema:pC,outputSchema:pd},a={name:"SharingSuggestionLambdaAfter",source:Q.Custom,inputSchema:pd,outputSchema:pd,func:function(f,c,d,h){hC[f.docId]=!f.retry,f.identities.length>0&&f.identities[0].suggestions.length>0?(delete f.retry,delete f.docId,h(f)):h(null)}},s=10,u={canProduceNullResult:!1,shouldSendResultsToHost:!0,enabledByDefault:!1,throttleSettings:{shouldBeThrottled:!0,throttlingInterval:1e4},licenseFeatures:[]};return o.registerSimpleRemoteWorkflow("SharingSuggestionWorkflow",r,t,a,u)};g();var Uo=w(hd()),bC=w(xC());g();var je=w(TC()),IC=w(W()),_C=w(B()),AC=function(){function n(){(0,IC.default)(this,n)}return(0,_C.default)(n,[{key:"log",value:function(e,r,t,a){(0,je.default)(e),(0,je.default)(r),(0,je.default)(t),(0,je.default)(a)}},{key:"info",value:function(e,r,t){(0,je.default)(e),(0,je.default)(r),(0,je.default)(t)}},{key:"warn",value:function(e,r,t){(0,je.default)(e),(0,je.default)(r),(0,je.default)(t)}},{key:"error",value:function(e,r,t){(0,je.default)(e),(0,je.default)(r),(0,je.default)(t)}},{key:"debug",value:function(e,r,t){(0,je.default)(e),(0,je.default)(r),(0,je.default)(t)}},{key:"logEvent",value:function(e,r,t,a,s,u){(0,je.default)(e),(0,je.default)(r),(0,je.default)(t),(0,je.default)(a),(0,je.default)(s),(0,je.default)(u)}}]),n}();var MC="Skills.Signal",pM="Skills.Intent",EC="Skills.ProviderResult",hM="Skills.RankedResult",vd,RC=function(o){var e={name:"IntentClassifierLambdaRemote",source:Q.Remote,inputSchema:MC,outputSchema:pM};return o.registerSimpleRemoteWorkflow("IntentClassifierWorkflow",null,e,null)},NC=function(o){var e={name:"ProviderResultLambdaRemote",source:Q.Remote,inputSchema:MC,outputSchema:EC};return o.registerSimpleRemoteWorkflow("ProviderResultWorkflow",null,e,null)},gM=function(o){var e={},r=[];for(var t of o.values)if(t){var a=t;try{var s={id:a.id,surfaceType:a.surfaceType,providerId:a.providerId,resultStatus:Uo.ProviderResultStatus[a.resultStatus],statusCode:a.statusCode,error:a.error?{errorType:Uo.ProviderErrorType[a.error.errorType],detail:a.error.detail}:null,additionalInfo:a.additionalInfo?JSON.parse(a.additionalInfo):null,entityGroups:a.entityGroups.map(function(l){return{groupTypeId:l.groupTypeId,providerId:l.providerId,data:l.data?JSON.parse(l.data):null,rank:l.rank}})},u={providerId:s.providerId,resultStatus:s.resultStatus,statusCode:s.statusCode,error:s.error,additionalInfo:s.additionalInfo,entityGroups:s.entityGroups,id:a.id,surfaceType:a.surfaceType};s.resultStatus===Uo.ProviderResultStatus.Success&&s.entityGroups?r=r.concat(s.entityGroups):s.resultStatus===Uo.ProviderResultStatus.NoResult&&s.entityGroups&&(u.entityGroups=void 0),e[s.providerId]=u}catch(l){e[a.providerId]=void 0}}return{transactionId:null,providerStatuses:e,rankedEntityGroups:r}},mM=function(){return{transactionId:null,interactionId:null}},vM=function(){if(!vd){var o={shouldQueryMatchQfDocumentTitle:!0},e=new AC;vd=new bC.SmartLookupRanker(e,o)}return vd},DC=function(o){var e={name:"InterProviderRanker",source:Q.Custom,inputSchema:EC,outputSchema:hM,func:function(a,s,u,l){var f=gM(a),c=vM();c.rank(mM(),f),l(f)}},r=function(a){var s={primary:a.id,secondary:null};return s};return o.registerReduceWorkflow("InterProviderRankerWorkflow",e,r)};g();var yM=function(o){if(!o)return null;var e={bar:o.baz,baz:o.bar};return e},WC=function(o){var e={name:"BazBarLambda",source:Q.Custom,inputSchema:"Microsoft.AugLoop.BazBar",outputSchema:"Microsoft.AugLoop.BazBar",func:function(u,l,f,c){var d=yM(u);c(d)}},r={name:"HealthCheckRemoteLambda",source:Q.Remote,inputSchema:"HealthCheckRequest",outputSchema:"HealthCheckResponse"},t={name:"BazBarNativeLambda",source:Q.Local,inputSchema:"BazBarNativeRequest",outputSchema:"BazBarNativeResponse"},a={name:"BazBarMissingNativeLambda",source:Q.Local,inputSchema:"BazBarMissingNativeRequest",outputSchema:"BazBarNativeResponse"};return Promise.all([o.registerSimpleLocalWorkflow("BazBarWorkflow",e),o.registerSimpleLocalWorkflow("BazBarNativeWorkflow",t),o.registerSimpleLocalWorkflow("BazBarMissingNativeWorkflow",a),o.registerSimpleRemoteWorkflow("HealthCheckWorkflow",null,r,null)]).then(function(){})};var _t=w(PC()),XC=w(LC());g();var FC="Tiling.TextTileEvent",kM="LangDetect.Request",wM="LangDetect.Response",SM=function(o){var e={name:"LangDetectLambdaBefore",source:Q.Custom,inputSchema:FC,outputSchema:FC,func:function(a,s,u,l){var f=qs(a);if(!f)l(null);else{var c={context:f.tile.elements.map(function(d){return d.text}).join(" ")};l(c)}}},r={name:"LangDetectLambdaRemote",source:Q.Remote,inputSchema:kM,outputSchema:wM};return o.registerSimpleRemoteWorkflow("LangDetectWorkflow",e,r,null,{canProduceNullResult:!0,shouldSendResultsToHost:!0,enabledByDefault:!0})};function qC(n){return SM(n)}g();var GC=w(mn());function CM(n,o,e,r){return yd.apply(this,arguments)}function yd(){return yd=(0,GC.default)(function*(n,o,e,r){var t;try{var a=yield o.getAll(),s=new Set;for(var u of a){var l=u.content.split(" ");for(var f of l)s.add(f)}var c=new no({count:s.size});r.setAnnotations(n,no.getTypeName(),[c])}catch(d){t=d}finally{r.done(t)}}),yd.apply(this,arguments)}function UC(){return ls.create("UniqueWordsCount").setCollectionScopeType(Mt.getTypeName()).setInputTypes([Je.getTypeName()]).setOutputTypes([no.getTypeName()]).setLambda(CM)}g();var jC=w(W()),JC=w(B());g();var En;(function(n){n.Table="Table",n.List="List",n.Footer="Footer",n.Header="Header",n.Paragraph="Paragraph",n.Multiselect="Multiselect"})(En||(En={}));var ou;(function(n){n.ContentType="ContentType"})(ou||(ou={}));g();var kd=w(W()),wd=w(B());var ma=function(){function n(o){(0,kd.default)(this,n),m.assign(n,this,o)}return(0,wd.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_FeatureExtraction_FeatureExtractionSignal"}},{key:"getBaseTypes",value:function(){return["AugLoop_Signals_Signal"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();ma.H_={T_:ma.getTypeName(),B_:ma.getBaseTypes()};var fo=function(){function n(o){(0,kd.default)(this,n),m.assign(n,this,o)}return(0,wd.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_FeatureExtraction_FeatureExtractionAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}]),n}();fo.H_={T_:fo.getTypeName(),B_:fo.getBaseTypes()};g();var HC=w(Ie()),zC=w(W()),VC=w(B());g();var iu;(function(n){n.HeaderFooter="headerfooters"})(iu||(iu={}));var va;(function(n){n.Footer="Footer",n.Normal="Normal"})(va||(va={}));var QC=function(){function n(o){(0,zC.default)(this,n),this.context=o}return(0,VC.default)(n,[{key:"getContentType",value:function(e,r){var t,a,s=new Set;if(!e||!r||!e.selectedRanges||!Array.isArray(e.selectedRanges))return s;for(var u of e.selectedRanges)if(u){var l=r.getItemBodyByReference(u.tileReference);if(l){if(l.isInsideTable&&s.add(En.Table),l.listType!==Ka.NoList&&s.add(En.List),u.tileReference.referencedPath.indexOf(iu.HeaderFooter)>-1&&(!((a=(t=l.formattedRanges)===null||t===void 0?void 0:t[0])===null||a===void 0)&&a.styleName&&l.formattedRanges[0].styleName===va.Footer?s.add(En.Footer):s.add(En.Header)),s.size===0&&s.add(En.Paragraph),l.formattedRanges)for(var f of l.formattedRanges)f!=null&&f.styleName&&f.styleName!==va.Normal&&s.add(f.styleName);u.range.length>l.content.length&&s.add(En.Multiselect)}}return e.selectedRanges.length>1&&s.add(En.Multiselect),s}},{key:"extractContentType",value:function(){var e,r,t,a=new D({operationName:"Extracting content-type",success:!0}).start();try{var s=(r=(e=this.context)===null||e===void 0?void 0:e.triggerSignals)===null||r===void 0?void 0:r[0];if(!(s!=null&&s.currentSelection)||!(!((t=this.context)===null||t===void 0)&&t.model))return"";var u=this.getContentType(s.currentSelection,this.context.model);return v.info(512242182,y.WorkflowDefault,a.stop()),(0,HC.default)(u.values()).join(",")}catch(f){a.success=!1;var l={error:f,message:f.message,stack:f.stack};a.resultDescription=JSON.stringify(l),v.error(512242181,y.WorkflowDefault,a.stop())}return""}}]),n}();var xM=function(){function n(){(0,jC.default)(this,n)}return(0,JC.default)(n,[{key:"execute",value:function(e,r,t,a){var s=new D({operationName:"Extracting Features",success:!0}).start();try{var u=new fo({extractedFeatures:[]}),l=new QC(t),f=l.extractContentType();u.extractedFeatures.push({key:ou.ContentType,value:f}),v.info(512238366,y.WorkflowDefault,s.stop()),a.setAnnotations(e,fo.getTypeName(),[u]),a.done()}catch(d){s.success=!1;var c={error:d,message:d.message,stack:d.stack};s.resultDescription=JSON.stringify(c),v.error(512238365,y.WorkflowDefault,s.stop()),a.done(d)}}},{key:"dispose",value:function(){}}]),n}(),KC=ls.create("FeatureExtraction").setBypassModel().setCollectionScopeType(Mt.getTypeName()).setTriggerSignals([ma.getTypeName()]).setInputTypes([Je.getTypeName()]).setOutputTypes([fo.getTypeName()]).setLambdaType(xM);var TM=function(){var o=new _t.TelemetryLogger;o.setTenantTokens({Office:{AugLoop:{ariaTenantToken:"3de4087d4de34817b1c376e3d1e6e293-983c4292-5ba9-485a-ab10-9797863c788b-6770",nexusTenantToken:1780,Client:{}}}}),o.addSink((0,XC.createOTelSink)());var e=function(t,a){var s=t.charAt(0).toUpperCase()+t.slice(1);if(typeof a=="string")return{name:s,dataType:_t.DataFieldType.String,value:a};if(typeof a=="boolean")return{name:s,dataType:_t.DataFieldType.Boolean,value:a};if(typeof a=="number")return{name:s,dataType:_t.DataFieldType.Double,value:a};if(typeof a=="object"&&a.isInteger)return{name:s,dataType:_t.DataFieldType.Int64,value:a.value}};return function(r,t,a,s,u,l){var f={eventName:t.replace(/_/g,".")};f.eventFlags={samplingPolicy:_t.SamplingPolicy.Measure,dataCategories:_t.DataCategories.ProductServiceUsage|_t.DataCategories.ProductServicePerformance,diagnosticLevel:_t.DiagnosticLevel.NecessaryServiceDataEvent},s==="Office.System.Activity"&&(f.eventContract={name:s,dataFields:_t.Contracts.Office.System.Activity.getFields({duration:u.Duration,count:u.Count,aggMode:u.AggMode,cV:u.CV,success:u.Success,result:u.Result?{code:u.Result.Code||0,type:u.Result.Type,tag:u.Result.Tag}:void 0})}),f.dataFields=Object.keys(a).filter(function(c){return a[c]!==void 0}).map(function(c){return e(c,a[c])}),o.sendTelemetryEvent(f)}},YC=function(o){var e,r,t=null,a=new Map,s=new Map,u=function(_,M,N,R){o.OnResult({InputSchema:_,InputJson:JSON.stringify(M),OutputSchema:N,OutputJson:JSON.stringify(R)})},l=function(_){return o.RequestAuthToken(_)},f=function(_,M){return o.IsFeatureEnabled(_,M)},c=function(_){return o.AreLicenseFeaturesEnabled(_)},d=function(_,M,N,R){var P={InputSchema:_,InputJson:JSON.stringify(M),CorrelationVector:""};return o.ExecuteLocalLambda(P,N,"").then(function(O){return O?JSON.parse(O):void 0})},h={onResult:u,onAnnotationResult:null,requestAuthToken:l,sendTelemetryEvent:TM(),isFeatureEnabled:f,executeLocalLambda:d,areLicenseFeaturesEnabled:c};v.addLogger({level:ze.info,log:function(_){if(_.eventName==="Log"){var M,N,R;o.SendDiagnosticTrace((M=_.tagId)!=null?M:0,(N=_.traceLevel)!=null?N:Dn.Info,(R=_.message)!=null?R:"")}}});var p=function(){return t!==null||(t=Promise.all([o.IsFeatureEnabled("Microsoft.Office.AugLoop.EnableBatchOptions","Production"),o.IsFeatureEnabled("Microsoft.Office.AugLoop.EnableAugLoopPhase3","Dogfood"),o.IsFeatureEnabled("Microsoft.Office.AugLoop.EnablePhase3Service","None")]).then(function(_){var M=(0,$C.default)(_,3),N=M[0],R=M[1],P=M[2];return Bs.init(e,r,h,{networkMode:R&&P?Pe.LocalWorkflowsOnly:void 0,telemetryAggregationIntervalSec:30,batchOptions:N?{delayMs:1e3,maxInputSize:1048576}:void 0}).then(function(){return Le.init(e,r,h)}).then(function(){if(r.appName==="PowerPoint")return Promise.all([dd(Le),RC(Le),$s(Le,r,e,Js(),Qs(),js(),o),aC(Le),uC(Le)]).then(function(){});if(r.appName==="Word")return Promise.all([ad(Le,o),sd(Le),ud(Le),ld(Le),NC(Le),DC(Le),$s(Le,r,e,Js(),Qs(),js(),o),gC(Le,o)]).then(function(){});if(r.appName==="Outlook")return Promise.all([$s(Le,r,e,Js(),Qs(),js(),o)]).then(function(){});if(r.appName==="OneNote")return qC(Le);if(r.appName==="Testing")return Promise.all([WC(Le),dd(Le),ad(Le,o),sd(Le),ud(Le),ld(Le)]).then(function(){})})})),t};o.OnSubmit.subscribe(function(I){var _="RekaPing";if(I.InputSchema===_){o.OnResult({InputSchema:_,InputJson:I.InputJson,OutputSchema:_,OutputJson:I.InputJson});return}p().then(function(){Le.submit(I.InputSchema,JSON.parse(I.InputJson),I.CorrelationVector)})}),o.OnSetServiceUrl.subscribe(function(I){e=I}),o.OnSetHostMetadata.subscribe(function(I){var _=[];for(var M of I.DisabledServiceGroups)_.push({officeServiceGroup:M.OfficeServiceGroup,controllerServiceGroup:M.ControllerServiceGroup});r={appName:I.AppName,appPlatform:I.AppPlatform,appVersion:I.AppVersion,uiLanguage:I.UILanguage,releaseAudienceGroup:I.ReleaseAudienceGroup,releaseChannel:I.ReleaseChannel,releaseFork:I.ReleaseFork,sessionId:I.SessionId,flights:I.Flights,privateMode:I.PrivateMode,disabledServiceGroups:_}});var k=function(_){v.error(593892183,y.CoreDefault,"Session not found for "+_+" event")},S=function(_){v.warn(0,y.CoreDefault,"Annotation token not found for "+_+" event")},C=function(_,M){v.error(0,y.CoreDefault,"Bad input for "+_+": "+M)},T=function(_,M){v.error(593892186,y.CoreDefault,new D({operationName:"InteropPromiseRejected",success:!1,resourceId:_,resultDescription:M}))},x=function(_){if(_){if(typeof _=="string")return _;if(typeof _.message=="string")return _.message}return"Unknown error"};o.OnCreateSession.subscribe(function(I){var _=I.docSessionId,M=I.flights,N=I.serviceUrl;if(a.has(_)){o.OnCreateSessionResult({errMessage:"docSessionId already exists",docSessionId:_});return}var R=p().then(function(){var P=[];try{for(var O of I.extensionConfigs||[])P.push(JSON.parse(O))}catch(ce){throw C("OnCreateSession",x(ce)),new Error("Bad extension configs")}var z="*",J={docSessionId:_,onSessionConnect:function(ae,re,V,me){v.debug(0,y.CoreDefault,"In AL Session onSessionConnect");var te={bridgeId:z,docSessionId:_,message:new bi({isSeedingRequired:ae,sessionUrl:re,origin:V,authToken:me})};o.OnSDXBridgeMessageResult({bridgeMessage:JSON.stringify(new pt(te))})},onSessionDisconnect:function(ae){v.debug(0,y.CoreDefault,"In AL Session onSessionDisconnect");var re={bridgeId:z,docSessionId:_,message:new Mi({error:ae})};o.OnSDXBridgeMessageResult({bridgeMessage:JSON.stringify(new pt(re))})},onSessionReconnect:function(){v.debug(0,y.CoreDefault,"In AL Session onSessionReconnect");var ae={bridgeId:z,docSessionId:_,message:new Ei};o.OnSDXBridgeMessageResult({bridgeMessage:JSON.stringify(new pt(ae))})},onSessionClose:function(ae){v.debug(0,y.CoreDefault,"In AL Session onSessionClose");var re={bridgeId:z,docSessionId:_,message:ae};o.OnSDXBridgeMessageResult({bridgeMessage:JSON.stringify(new pt(re))})},extensionConfigs:P,flights:M,serviceUrl:N};return Bs.createSession(J)}).then(function(P){return o.OnCreateSessionResult({docSessionId:_}),P}).catch(function(P){a.delete(_);var O=x(P);throw T("OnCreateSession",O),o.OnCreateSessionResult({errMessage:O,docSessionId:_}),new Error(O)});a.set(_,R)}),o.OnActivateAnnotation.subscribe(function(I){var _=I.annotationType,M=I.token,N=I.config,R=I.docSessionId,P=a.get(R);if(!P){k("OnActivateAnnotation");return}var O;P.then(function(z){var J=N?JSON.parse(N):void 0,ce=function(re){o.OnAnnotationResult({operation:JSON.stringify(re),token:M,docSessionId:R})};return z.activateAnnotation(_,{config:J,callback:ce})}).then(function(z){z&&z.token&&s.set(M,z.token)}).catch(function(z){O=x(z)}).then(function(){o.OnActivateAnnotationResult({errMessage:O,token:M,docSessionId:R})}).catch(function(z){T("OnActivateAnnotation",x(z))})}),o.OnReleaseAnnotation.subscribe(function(I){var _=I.token,M=I.docSessionId,N=s.get(_);if(!N){S("OnReleaseAnnotation");return}var R=a.get(M);if(!R){k("OnReleaseAnnotation");return}var P;R.then(function(O){return O.releaseAnnotation(N)}).catch(function(O){P=x(O)}).then(function(O){O&&s.delete(_),o.OnReleaseAnnotationResult({errMessage:P,token:_,result:O})}).catch(function(O){T("OnReleaseAnnotation",x(O))})}),o.OnSubmitOperations.subscribe(function(I){var _=I.operations,M=I.cv,N=I.docSessionId,R=a.get(N);if(!R){k("OnSubmitOperations");return}R.then(function(P){P.submitOperations(_.map(function(O){return JSON.parse(O)}),M)}).catch(function(P){T("OnSubmitOperations",x(P))})}),o.OnSubmitSeedOperations.subscribe(function(I){var _=I.operations,M=I.cv,N=I.docSessionId,R=a.get(N);if(!R){k("OnSubmitSeedOperations");return}R.then(function(P){P.submitSeedOperations(_.map(function(O){return JSON.parse(O)}),M)}).catch(function(P){T("OnSubmitSeedOperations",x(P))})}),o.OnSubmitSeedGroupOperations.subscribe(function(I){var _=I.operations,M=I.groupComplete,N=I.cv,R=I.docSessionId,P=a.get(R);if(!P){k("OnSubmitSeedGroupOperations");return}P.then(function(O){O.submitSeedGroupOperations(_.map(function(z){return JSON.parse(z)}),M,N)}).catch(function(O){T("OnSubmitSeedGroupOperations",x(O))})}),o.OnSubmitCustomMessage.subscribe(function(I){var _=I.message,M=I.messageId,N=I.docSessionId,R=a.get(N);if(!R){k("OnSubmitCustomMessage");return}var P,O;R.then(function(z){return z.submitCustomMessage(JSON.parse(_))}).then(function(z){O=z}).catch(function(z){P=x(z)}).then(function(){o.OnSubmitCustomMessageResult({errMessage:P,response:JSON.stringify(O),messageId:M,docSessionId:N})}).catch(function(z){T("OnSubmitCustomMessage",x(z))})}),o.OnForceReconnect.subscribe(function(I){var _=I.docSessionId,M=a.get(_);if(!M){k("OnForceReconnect");return}var N=[];try{for(var R of I.extensionConfigs||[])N.push(JSON.parse(R))}catch(O){C("OnForceReconnect",x(O));return}var P;M.then(function(O){return O.forceReconnect()}).catch(function(O){P=x(O)}).then(function(){o.OnForceReconnectResult({errMessage:P,docSessionId:_})}).catch(function(O){T("OnForceReconnect",x(O))})}),o.OnClose.subscribe(function(I){var _=I.docSessionId,M=a.get(_);if(!M){k("OnClose");return}M.then(function(N){N.close(),a.delete(_)}).catch(function(N){T("OnClose",x(N))})}),o.OnSetSessionCloseCallback.subscribe(function(I){var _=I.docSessionId,M=a.get(_);if(!M){k("OnSetSessionCloseCallback");return}M.then(function(N){N.setSessionCloseCallback(function(R){o.OnSessionCloseResult({docSessionId:_,sessionCloseMessage:R?JSON.stringify(R):void 0})})}).catch(function(N){T("OnSetSessionCloseCallback",x(N))})}),o.OnSetConnectCallback.subscribe(function(I){var _=I.docSessionId,M=a.get(_);if(!M){k("OnSetConnectCallback");return}M.then(function(N){N.setConnectCallback(function(R,P,O,z){o.OnConnectResult({docSessionId:_,isSeedingRequired:R,sessionUrl:P,origin:O,authToken:z})})}).catch(function(N){T("OnSetConnectCallback",x(N))})}),o.OnSetDisconnectCallback.subscribe(function(I){var _=I.docSessionId,M=a.get(_);if(!M){k("OnSetDisconnectCallback");return}M.then(function(N){N.setDisconnectCallback(function(R){o.OnDisconnectResult({error:R,docSessionId:_})})}).catch(function(N){T("OnSetDisconnectCallback",x(N))})});var A,b=new Set,E=function(_){b.has(_)||(b.add(_),A.initBridge({bridgeId:_,egress:function(N,R){var P=typeof N=="string",O={bridgeId:_,docSessionId:R,bridgeMessage:P?N:void 0,binaryMessage:P?void 0:Array.from(N)};o.OnIngressAugLoopBridgeMessage(O)},onSessionInit:function(N){N.registerLocalWorkflow(UC()),N.registerLocalWorkflow(KC)}}))};o.OnInitAugLoopBridgeManager.subscribe(function(I){A||(A=new bS)}),o.OnEgressAugLoopBridgeMessage.subscribe(function(I){if(!A)throw new Error("Called OnEgressAugLoopBridgeMessage before OnInitAugLoopBridgeManager");var _=I.bridgeId,M=I.docSessionId,N=I.bridgeMessage,R=I.binaryMessage;E(_);var P=typeof N=="string";A.ingress(_,M,P?N:new Uint8Array(R))}),o.OnSDXBridgeMessageFromNative.subscribe(function(I){var _=JSON.parse(I.bridgeMessage),M=_.bridgeId,N=_.docSessionId,R=_.message,P=m.getTypeNameFor(R);o.SendDiagnosticTrace(0,Dn.Info,"TS Received Brige Message of type = "+P);var O=a.get(N);if(!O){k("OnSDXBridgeMessageFromNative");var z=JSON.stringify(new pt({bridgeId:M,docSessionId:N,response:new X({messageId:R.messageId,error:"Session not found"})}));o.OnSDXBridgeMessageResult({bridgeMessage:z});return}O.then(function(J){if(nn.typeGuard(R)){var ce=R.annotationType,ae=R.config;o.SendDiagnosticTrace(0,Dn.Info,"TS Activate Annotation of type = "+ce+" token = "+R.token),J.activateAnnotation(ce,{config:ae,callback:function(ke){var He={bridgeId:M,docSessionId:N,message:new wt({annotationType:ce,ops:[ke]})};o.OnSDXBridgeMessageResult({bridgeMessage:JSON.stringify(new pt(He))})}}).then(function(te){o.SendDiagnosticTrace(0,Dn.Info,"TS Annotation Activation Response Recieved with token = "+te.token);var ke={bridgeId:M,docSessionId:N,response:new Fr({messageId:R.messageId,token:te.token})},He=JSON.stringify(new pt(ke)),rt={bridgeMessage:He};o.OnSDXBridgeMessageResult(rt)}).catch(function(te){var ke=JSON.stringify(new pt({bridgeId:M,docSessionId:N,response:new X({messageId:R.messageId,error:x(te)})}));o.OnSDXBridgeMessageResult({bridgeMessage:ke})})}else if(Ue.typeGuard(R)){var re=R.ops;for(var V of re)J.submitOperation(V)}else if(Gr.typeGuard(R))o.SendDiagnosticTrace(0,Dn.Info,"TS Releasing Annotation Activation token = "+R.token),J.releaseAnnotation(R.token).then(function(te){o.SendDiagnosticTrace(0,Dn.Info,"TS Sending Annotation Release Response token = "+R.token);var ke=JSON.stringify(new pt({bridgeId:M,docSessionId:N,response:new Ur({messageId:R.messageId,lastRelease:te})}));o.OnSDXBridgeMessageResult({bridgeMessage:ke})});else if(Ri.typeGuard(R))J.submitCustomMessage(R.customMessage).then(function(te){te.messageId=R.messageId,o.SendDiagnosticTrace(0,Dn.Info,"Responded to "+P),o.OnSDXBridgeMessageResult({bridgeMessage:JSON.stringify(new pt({bridgeId:M,docSessionId:N,response:te}))})}).catch(function(te){o.SendDiagnosticTrace(0,Dn.Info,te.message),o.OnSDXBridgeMessageResult({bridgeMessage:JSON.stringify(new pt({bridgeId:M,docSessionId:N,response:new X({messageId:R.messageId,error:te.message})}))})});else{var me=JSON.stringify(new pt({bridgeId:M,docSessionId:N,response:new X({messageId:R.messageId,error:"Unknown message type to handle"})}));o.OnSDXBridgeMessageResult({bridgeMessage:me})}}).catch(function(J){T("OnReceiveBridgeMessageFromNative",x(J));var ce=JSON.stringify(new pt({bridgeId:M,docSessionId:N,response:new X({messageId:R.messageId,error:x(J)})}));o.OnSDXBridgeMessageResult({bridgeMessage:ce})})})};(0,ZC.initReka)();YC(bd.NativeService);})();
//# sourceMappingURL=index.win32.bundle.map
